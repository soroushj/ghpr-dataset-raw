{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "## Summary\r\nThe deprecation of SBR will result in a fundamental change about how vttablet works. The most significant one is that vttablet does not need to compute which rows will be affected by a DML. Dropping this requirement allows us to rethink the implementation of its various features. Some of these changes will not be fully backward compatible. Here are the details:\r\n\r\n## Pass-through DMLs\r\nMost DMLs can be just passed through.\r\n\r\nThere is, however, one valuable feature that we want to preserve: the ability to limit the number of rows a DML affects. In SBR mode, this was achieved as a side-effect of the fact that we had to run a \u201csubquery\u201d to identify all affected rows, which allowed us to count them and return an error if they exceeded the limit. We lose this ability in pass-through mode.\r\n\r\nInstead of continuing to issue the subquery, the new proposal is to add a LIMIT clause to the DML itself. Then, if \u201cRowsAffected\u201d was greater than the limit, we return an error. The one downside of this implementation is that such a failure will leave the DML partially executed. This means that vttablet will have to force a rollback of the transaction. In most use cases, the application is expected to rollback the transaction on such an error. Therefore, this sounds like a reasonable trade-off for the level of simplicity achieved. There is also the added benefit of avoiding the extra roundtrip for the subquery.\r\n\r\nThis change has a subtle interaction with the \u201cfound rows\u201d flag, which reports affected rows differently. This just means that users of this flag may have to set their limits differently.\r\n\r\nThe explicit pass-through mode flag `queryserver-config-passthrough-dmls` will continue to behave as is. In the new context, its meaning will change to: \u201cdo not limit affected rows\u201d.\r\n\r\nWe believe that inserts of a large number of rows are usually intentional. Therefore, limits will only be applied to updates and deletes.\r\n\r\n## Autocommits\r\nWith most DMLs being pass-through, we can now resurrect autocommit behavior in vttablet. This means that a transactionless DML can be treated as autocommit. In the case where a limit has to be enforced, vttablet can open a transaction, and then rollback if the limit is exceeded.\r\n\r\n## Sequences\r\nSequences will continue their existing behavior: normal statements will continue to be sent to mysql. If a `select next\u2026` is received, the sequence specific functionality will be triggered.\r\n\r\n## Messages\r\nMessages are undergoing a significant overhaul as seen in #5913. Tracking of row changes has been changed to use VStreamer, which allows for any DML to be executed on those tables. Inserts remain an exception because columns like `time_created` and `time_scheduled` have to be populated by vttablet in order to maintain backward compatibility.\r\n\r\n## Plan IDs\r\nMost plan ids were specific to SBR. After the refactor, the total number of plans will be greatly reduced, and we\u2019ll likely generate a new set of ids.\r\n\r\n## Schema\r\nThese changes greatly reduce our dependence on the schema. We only need to know the following info from a table:\r\n* Field info\r\n* PK columns\r\n* Table comments\r\n\r\nVTTablet also gathered table statistics from `information schema`. However, we don\u2019t think anyone is using them. So, it may be better to stop reporting them. If anyone still needs them, please speak up now.\r\n",
  "closed_at": "2020-03-20T17:44:59Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/11834506?v=4",
    "events_url": "https://api.github.com/users/harshit-gangal/events{/privacy}",
    "followers_url": "https://api.github.com/users/harshit-gangal/followers",
    "following_url": "https://api.github.com/users/harshit-gangal/following{/other_user}",
    "gists_url": "https://api.github.com/users/harshit-gangal/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/harshit-gangal",
    "id": 11834506,
    "login": "harshit-gangal",
    "node_id": "MDQ6VXNlcjExODM0NTA2",
    "organizations_url": "https://api.github.com/users/harshit-gangal/orgs",
    "received_events_url": "https://api.github.com/users/harshit-gangal/received_events",
    "repos_url": "https://api.github.com/users/harshit-gangal/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/harshit-gangal/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/harshit-gangal/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/harshit-gangal"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/vitessio/vitess/issues/5920/comments",
  "created_at": "2020-03-14T04:55:13Z",
  "events_url": "https://api.github.com/repos/vitessio/vitess/issues/5920/events",
  "html_url": "https://github.com/vitessio/vitess/issues/5920",
  "id": 581038039,
  "labels": [],
  "labels_url": "https://api.github.com/repos/vitessio/vitess/issues/5920/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1ODEwMzgwMzk=",
  "number": 5920,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/vitessio/vitess",
  "state": "closed",
  "title": "RFC: RBR vttablet -> Breaking changes",
  "updated_at": "2020-03-20T17:44:59Z",
  "url": "https://api.github.com/repos/vitessio/vitess/issues/5920",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/589370?v=4",
    "events_url": "https://api.github.com/users/sougou/events{/privacy}",
    "followers_url": "https://api.github.com/users/sougou/followers",
    "following_url": "https://api.github.com/users/sougou/following{/other_user}",
    "gists_url": "https://api.github.com/users/sougou/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/sougou",
    "id": 589370,
    "login": "sougou",
    "node_id": "MDQ6VXNlcjU4OTM3MA==",
    "organizations_url": "https://api.github.com/users/sougou/orgs",
    "received_events_url": "https://api.github.com/users/sougou/received_events",
    "repos_url": "https://api.github.com/users/sougou/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/sougou/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sougou/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/sougou"
  }
}