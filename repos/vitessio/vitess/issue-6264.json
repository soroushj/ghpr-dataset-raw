{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "#### Overview of the Issue\r\n\r\nrogue `BEGIN` is executed if query fails  in mysql. In that way, many basic queries from various connections can be wrapped into transaction even if they are not in transaction.\r\n\r\n#### Reproduction Steps\r\n\r\n1. Using `local` ecommerce  example with added additional parameters to `scripts/vttablet-up.sh`\r\n\r\n```\r\n -enable-autocommit=true \\\r\n -queryserver-config-passthrough-dmls=true \\\r\n```\r\n\r\n2. Enabling general log in mysql master\r\n\r\n```\r\nmysql -S /home/centos/my-vitess-example/vtdataroot/vt_0000000100/mysql.sock vt_commerce -e 'SET GLOBAL general_log=1;'\r\n```\r\n\r\n3. In separate terminal, tail general log (name might be different)\r\n\r\n```\r\ntail -f  /home/centos/my-vitess-example/vtdataroot/vt_0000000100/data/default*.log\r\n```\r\n\r\n4. Execute sql through vtgate socket\r\n\r\n```\r\n# delete previous data\r\nmysql -S /tmp/mysql.sock '@master' -e \"DELETE FROM product;\"\r\n\r\n# connect to mysql\r\nmysql -S /tmp/mysql.sock '@master' \r\n\r\nset autocommit=1; \r\n\r\ninsert into product(sku, description, price) values ('123', 'reproduce', 1);\r\n# this will fail\r\ninsert into product(sku, description, price) values ('123', 'reproduce', 2);\r\n# these 3 will appear in transaction\r\nselect * from product where sku = '123' limit 1;\r\ninsert into product(sku, description, price) values ('124', 'reproduce', 4);\r\nselect * from product where sku = '124' limit 1;\r\n\r\n# rollback after exit will happen\r\nexit\r\n```\r\n\r\nGeneral log will show this\r\n```\r\n2020-06-03T16:08:26.652969Z\t  296 Query\tdelete from product\r\n2020-06-03T16:08:26.669048Z\t  322 Query\tshow tables\r\n2020-06-03T16:08:26.670658Z\t   43 Query\tselect @@version_comment from dual limit 1\r\n2020-06-03T16:08:26.673840Z\t  299 Query\tinsert into product(sku, description, price) values ('123', 'reproduce', 1)\r\n2020-06-03T16:08:26.679471Z\t  300 Query\tinsert into product(sku, description, price) values ('123', 'reproduce', 2)\r\n2020-06-03T16:08:26.681544Z\t  323 Query\tbegin\r\n2020-06-03T16:08:26.681810Z\t  323 Query\tselect * from product where sku = '123' limit 1\r\n2020-06-03T16:08:26.683403Z\t  323 Query\tinsert into product(sku, description, price) values ('124', 'reproduce', 4)\r\n2020-06-03T16:08:26.685063Z\t  323 Query\tselect * from product where sku = '124' limit 1\r\n2020-06-03T16:08:26.687432Z\t  323 Query\trollback\r\n```\r\n\r\n#### Info\r\n\r\nhttps://github.com/planetscale/vitess-releases/releases/tag/25db221\r\n```\r\nvtgate -version\r\nVersion: 25db221 (Git branch 'master') built on Thu May 14 20:39:15 UTC 2020 by planetscale@ip-172-31-17-134 using go1.13.4 linux/amd64\r\n\r\nvttablet -version\r\nVersion: 25db221 (Git branch 'master') built on Thu May 14 20:39:15 UTC 2020 by planetscale@ip-172-31-17-134 using go1.13.4 linux/amd64\r\n\r\nmysql --version\r\nmysql  Ver 14.14 Distrib 5.7.30, for Linux (x86_64) using  EditLine wrapper\r\n\r\ncat /etc/centos-release\r\nCentOS Linux release 7.7.1908 (Core)\r\n```",
  "closed_at": "2020-06-10T20:51:37Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/388311?v=4",
    "events_url": "https://api.github.com/users/deepthi/events{/privacy}",
    "followers_url": "https://api.github.com/users/deepthi/followers",
    "following_url": "https://api.github.com/users/deepthi/following{/other_user}",
    "gists_url": "https://api.github.com/users/deepthi/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/deepthi",
    "id": 388311,
    "login": "deepthi",
    "node_id": "MDQ6VXNlcjM4ODMxMQ==",
    "organizations_url": "https://api.github.com/users/deepthi/orgs",
    "received_events_url": "https://api.github.com/users/deepthi/received_events",
    "repos_url": "https://api.github.com/users/deepthi/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/deepthi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/deepthi/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/deepthi"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/vitessio/vitess/issues/6264/comments",
  "created_at": "2020-06-03T16:16:45Z",
  "events_url": "https://api.github.com/repos/vitessio/vitess/issues/6264/events",
  "html_url": "https://github.com/vitessio/vitess/issues/6264",
  "id": 630136031,
  "labels": [],
  "labels_url": "https://api.github.com/repos/vitessio/vitess/issues/6264/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-07-29T13:14:02Z",
    "closed_issues": 235,
    "created_at": "2020-05-28T15:27:29Z",
    "creator": {
      "avatar_url": "https://avatars2.githubusercontent.com/u/57982?v=4",
      "events_url": "https://api.github.com/users/morgo/events{/privacy}",
      "followers_url": "https://api.github.com/users/morgo/followers",
      "following_url": "https://api.github.com/users/morgo/following{/other_user}",
      "gists_url": "https://api.github.com/users/morgo/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/morgo",
      "id": 57982,
      "login": "morgo",
      "node_id": "MDQ6VXNlcjU3OTgy",
      "organizations_url": "https://api.github.com/users/morgo/orgs",
      "received_events_url": "https://api.github.com/users/morgo/received_events",
      "repos_url": "https://api.github.com/users/morgo/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/morgo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morgo/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/morgo"
    },
    "description": "7.0 Release GA",
    "due_on": "2020-07-28T07:00:00Z",
    "html_url": "https://github.com/vitessio/vitess/milestone/8",
    "id": 5474182,
    "labels_url": "https://api.github.com/repos/vitessio/vitess/milestones/8/labels",
    "node_id": "MDk6TWlsZXN0b25lNTQ3NDE4Mg==",
    "number": 8,
    "open_issues": 1,
    "state": "closed",
    "title": "v7.0",
    "updated_at": "2020-10-06T19:53:21Z",
    "url": "https://api.github.com/repos/vitessio/vitess/milestones/8"
  },
  "node_id": "MDU6SXNzdWU2MzAxMzYwMzE=",
  "number": 6264,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/vitessio/vitess",
  "state": "closed",
  "title": "Queries are wrapped into transactions even if autocommit=1 is set",
  "updated_at": "2020-06-15T19:07:21Z",
  "url": "https://api.github.com/repos/vitessio/vitess/issues/6264",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/228085?v=4",
    "events_url": "https://api.github.com/users/DeathBorn/events{/privacy}",
    "followers_url": "https://api.github.com/users/DeathBorn/followers",
    "following_url": "https://api.github.com/users/DeathBorn/following{/other_user}",
    "gists_url": "https://api.github.com/users/DeathBorn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/DeathBorn",
    "id": 228085,
    "login": "DeathBorn",
    "node_id": "MDQ6VXNlcjIyODA4NQ==",
    "organizations_url": "https://api.github.com/users/DeathBorn/orgs",
    "received_events_url": "https://api.github.com/users/DeathBorn/received_events",
    "repos_url": "https://api.github.com/users/DeathBorn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/DeathBorn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/DeathBorn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/DeathBorn"
  }
}