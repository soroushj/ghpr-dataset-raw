{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "#### Overview of the Issue\r\n\r\nWhen cell-local topo is unavailable, we have observed that a vttablet that is sent SIGTERM will hang indefinitely and never shut down gracefully. This can happen, for example, when the entire Vitess cluster is being decommissioned so we have intentionally shut down etcd.\r\n\r\nThis could be worked around by tearing down vttablets before etcd, or by sending SIGKILL to vttablets, but it would make sense if vttablet could independently guarantee that it will always eventually shut down on its own after receiving SIGTERM. For example, we could add a timeout to the execution of `servenv.Close()`, or just add a timeout to the particular step of clearing out the hostname from the tablet record:\r\n\r\nhttps://github.com/vitessio/vitess/blob/ad4e47a2dbcdf545823fa5a7fae10aa766489f24/go/vt/vttablet/tabletmanager/action_agent.go#L773\r\n\r\n#### Reproduction Steps\r\n\r\n1. Deploy a Vitess cluster.\r\n2. Shut down cell-local topo (e.g. etcd).\r\n3. Send SIGTERM to a vttablet process.\r\n4. Wait for vttablet process to terminate on its own.\r\n\r\n#### Binary version\r\n\r\ncommit 123dab2a\r\n\r\n#### Operating system and Environment details\r\n\r\nKubernetes v1.14.9 (EKS)\r\n\r\n#### Log Fragments\r\n\r\n```\r\nI0225 20:06:38.243033       1 healthcheck.go:337] Tablet in state MASTER, not entering lameduck\r\nW0225 20:06:44.354824       1 clientconn.go:1191] grpc: addrConn.createTransport failed to connect to {pstest-sharded1582661034970-etcd-f6f5d636-client:2379 0  <nil>}. Err :connection error: desc = \"transport: Error while dialing dial tcp: lookup pstest-sharded1582661034970-etcd-f6f5d636-client on 172.20.0.10:53: no such host\". Reconnecting...\r\nW0225 20:06:44.354823       1 clientconn.go:1191] grpc: addrConn.createTransport failed to connect to {pstest-sharded1582661034970-etcd-f6f5d636-client:2379 0  <nil>}. Err :connection error: desc = \"transport: Error while dialing dial tcp: lookup pstest-sharded1582661034970-etcd-f6f5d636-client on 172.20.0.10:53: no such host\". Reconnecting...\r\nW0225 20:06:44.399310       1 clientconn.go:1191] grpc: addrConn.createTransport failed to connect to {pstest-sharded1582661034970-etcd-f6f5d636-client:2379 0  <nil>}. Err :connection error: desc = \"transport: Error while dialing dial tcp: lookup pstest-sharded1582661034970-etcd-f6f5d636-client on 172.20.0.10:53: no such host\". Reconnecting...\r\n[...]\r\n```\r\n\r\nThe reconnect attempts continue indefinitely until vttablet is force-killed (SIGKILL).",
  "closed_at": "2020-02-27T23:06:33Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/388311?v=4",
    "events_url": "https://api.github.com/users/deepthi/events{/privacy}",
    "followers_url": "https://api.github.com/users/deepthi/followers",
    "following_url": "https://api.github.com/users/deepthi/following{/other_user}",
    "gists_url": "https://api.github.com/users/deepthi/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/deepthi",
    "id": 388311,
    "login": "deepthi",
    "node_id": "MDQ6VXNlcjM4ODMxMQ==",
    "organizations_url": "https://api.github.com/users/deepthi/orgs",
    "received_events_url": "https://api.github.com/users/deepthi/received_events",
    "repos_url": "https://api.github.com/users/deepthi/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/deepthi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/deepthi/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/deepthi"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/vitessio/vitess/issues/5859/comments",
  "created_at": "2020-02-25T21:01:56Z",
  "events_url": "https://api.github.com/repos/vitessio/vitess/issues/5859/events",
  "html_url": "https://github.com/vitessio/vitess/issues/5859",
  "id": 570830320,
  "labels": [],
  "labels_url": "https://api.github.com/repos/vitessio/vitess/issues/5859/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1NzA4MzAzMjA=",
  "number": 5859,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/vitessio/vitess",
  "state": "closed",
  "title": "vttablet hangs at shutdown if topo is unavailable",
  "updated_at": "2020-02-27T23:06:33Z",
  "url": "https://api.github.com/repos/vitessio/vitess/issues/5859",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6733629?v=4",
    "events_url": "https://api.github.com/users/enisoc/events{/privacy}",
    "followers_url": "https://api.github.com/users/enisoc/followers",
    "following_url": "https://api.github.com/users/enisoc/following{/other_user}",
    "gists_url": "https://api.github.com/users/enisoc/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/enisoc",
    "id": 6733629,
    "login": "enisoc",
    "node_id": "MDQ6VXNlcjY3MzM2Mjk=",
    "organizations_url": "https://api.github.com/users/enisoc/orgs",
    "received_events_url": "https://api.github.com/users/enisoc/received_events",
    "repos_url": "https://api.github.com/users/enisoc/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/enisoc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/enisoc/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/enisoc"
  }
}