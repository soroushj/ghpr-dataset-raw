{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "COLLABORATOR",
  "body": "#### Overview of the Issue\r\n\r\nWe tried to upgrade our vttablets from [this commit](https://github.com/vitessio/vitess/commit/3818c0b21eb36d08cccfd249feda5bd75f74745e) to [this commit](https://github.com/vitessio/vitess/commit/fac849822e8fead6f35aae5aeefeeed44e0c3ec6) and found that we could no longer insert 4 byte unicode characters into tables that previously supported them. We have been setting the `-db-config-*-charset` flags on tablets to be `utf8mb4` and still are, but looking at the character sets in a mysql session connected through vtgates shows them defaulted to `utf8`:\r\n\r\n```\r\nmysql> SHOW SESSION VARIABLES LIKE 'character\\_set\\_%';');\r\n+--------------------------+---------+\r\n| Variable_name            | Value   |\r\n+--------------------------+---------+\r\n| character_set_client     | utf8    |\r\n| character_set_connection | utf8    |\r\n| character_set_database   | utf8mb4 |\r\n| character_set_filesystem | binary  |\r\n| character_set_results    | utf8    |\r\n| character_set_server     | utf8mb4 |\r\n| character_set_system     | utf8    |\r\n+--------------------------+---------+\r\n```\r\n\r\n#### Reproduction Steps\r\n\r\nI was able to reproduce this using the default vagrant setup from a clean repo with the [following modifications](https://github.com/tinyspeck/vitess/compare/master...tinyspeck:brirams_reproduce_charset_regression) where we:\r\n- update `default-fast.cnf` to set client `default-character-set` and mysqld `character_set_server` and `collation_server` to `utf8mb4`\r\n- update default character set on the examples `messages` table\r\n- update `vttablet-up.sh` to set `-db-config-*-charset` to `utf8mb4`\r\n\r\nFrom `master`:\r\n- cherry pick settings change from https://github.com/tinyspeck/vitess/compare/master...tinyspeck:brirams_reproduce_charset_regression:\r\n\r\n```\r\n$ git cherry-pick brirams_reproduce_charset_regression\r\n```\r\n\r\n- setup and ssh into vagrant:\r\n\r\n```\r\n$ vagrant up && vagrant ssh`\r\n```\r\n\r\n- build and start test environment:\r\n\r\n```\r\n$ make build; ./vagrant-scripts/vitess/start.sh ; sleep 45; mysql --default-character-set='utf8mb4' -umysql_user -pmysql_password -h vitess -P 15306\r\n\r\nmysql> SHOW SESSION VARIABLES LIKE 'character\\_set\\_%';');\r\n+--------------------------+---------+\r\n| Variable_name            | Value   |\r\n+--------------------------+---------+\r\n| character_set_client     | utf8    |\r\n| character_set_connection | utf8    |\r\n| character_set_database   | utf8mb4 |\r\n| character_set_filesystem | binary  |\r\n| character_set_results    | utf8    |\r\n| character_set_server     | utf8mb4 |\r\n| character_set_system     | utf8    |\r\n+--------------------------+---------+\r\n\r\nmysql> insert into messages(page,time_created_ns,message) values(5,2,'http://linkmoji.co/\ud83d\uddfc \ud83d\udeb4\ud83d\ude0d');\r\nERROR 1366 (HY000): vtgate: http://vitess:15001/: execInsertSharded: target: test_keyspace.-.master, used tablet: test-100 (vitess): vttablet: rpc error: code = InvalidArgument desc = Incorrect string value: '\\xF0\\x9F\\x97\\xBC \\xF0...' for column 'message' at row 1 (errno 1366) (sqlstate HY000) (CallerID: userData1): Sql: \"insert into messages(page, time_created_ns, message) values (:_page0, :vtg2, :vtg3) /* vtgate:: keyspace_id:70bb023c810ca87a */\", BindVars: {#maxLimit: \"type:INT64 value:\\\"10001\\\" \"_page0: \"type:INT64 value:\r\n```\r\n\r\nFrom our previously working build, this _should_ be:\r\n\r\n```\r\nmysql> SHOW SESSION VARIABLES LIKE 'character\\_set\\_%';\r\n+--------------------------+---------+\r\n| Variable_name            | Value   |\r\n+--------------------------+---------+\r\n| character_set_client     | utf8mb4 |\r\n| character_set_connection | utf8mb4 |\r\n| character_set_database   | utf8mb4 |\r\n| character_set_filesystem | binary  |\r\n| character_set_results    | utf8mb4 |\r\n| character_set_server     | utf8mb4 |\r\n| character_set_system     | utf8    |\r\n+--------------------------+---------+\r\n7 rows in set (0.01 sec)\r\n\r\nmysql> insert into messages(page,time_created_ns,message) values(5,2,'http://linkmoji.co/\ud83d\uddfc \ud83d\udeb4\ud83d\ude0d');\r\nQuery OK, 1 row affected (0.00 sec)\r\n```\r\n\r\n#### Binary version\r\n- built from current HEAD at the time of this writing: `ce908267c994cc49fa92b96acf21364d9cce8bee`\r\n\r\n\r\n#### Operating system and Environment details\r\n\r\n- vagrant setup provided on master\r\n\r\n#### Notes\r\n\r\nI've been trying to find the offending commit but that's been unsuccessful so far given the number of merges that have taken place since the last working version. What's interesting is that [this commit](https://github.com/vitessio/vitess/commit/1ab972b2298b6e3cb5a583b47175add66fad1390) is broken and [the commit immediately following it](https://github.com/vitessio/vitess/commit/cf1e37d4c694eeff6e6078420e201e45b3d80813) works but then breaks again on [next one](https://github.com/vitessio/vitess/commit/f0a9bc71a0e9e96d602ebc9b4888bf12827bab63). Diffing across branches, it's hard to pinpoint what exactly could have caused the breakage but hoping something jumps out at someone looking at this.",
  "closed_at": "2019-05-23T02:23:58Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/24160?v=4",
    "events_url": "https://api.github.com/users/rafael/events{/privacy}",
    "followers_url": "https://api.github.com/users/rafael/followers",
    "following_url": "https://api.github.com/users/rafael/following{/other_user}",
    "gists_url": "https://api.github.com/users/rafael/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rafael",
    "id": 24160,
    "login": "rafael",
    "node_id": "MDQ6VXNlcjI0MTYw",
    "organizations_url": "https://api.github.com/users/rafael/orgs",
    "received_events_url": "https://api.github.com/users/rafael/received_events",
    "repos_url": "https://api.github.com/users/rafael/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rafael/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rafael/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rafael"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/vitessio/vitess/issues/4870/comments",
  "created_at": "2019-05-22T22:48:02Z",
  "events_url": "https://api.github.com/repos/vitessio/vitess/issues/4870/events",
  "html_url": "https://github.com/vitessio/vitess/issues/4870",
  "id": 447375364,
  "labels": [],
  "labels_url": "https://api.github.com/repos/vitessio/vitess/issues/4870/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NDczNzUzNjQ=",
  "number": 4870,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/vitessio/vitess",
  "state": "closed",
  "title": "utf8mb4 setting no longer honored by \"-db-config-*-charset\"",
  "updated_at": "2019-05-23T18:55:18Z",
  "url": "https://api.github.com/repos/vitessio/vitess/issues/4870",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1807482?v=4",
    "events_url": "https://api.github.com/users/brirams/events{/privacy}",
    "followers_url": "https://api.github.com/users/brirams/followers",
    "following_url": "https://api.github.com/users/brirams/following{/other_user}",
    "gists_url": "https://api.github.com/users/brirams/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brirams",
    "id": 1807482,
    "login": "brirams",
    "node_id": "MDQ6VXNlcjE4MDc0ODI=",
    "organizations_url": "https://api.github.com/users/brirams/orgs",
    "received_events_url": "https://api.github.com/users/brirams/received_events",
    "repos_url": "https://api.github.com/users/brirams/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brirams/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brirams/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brirams"
  }
}