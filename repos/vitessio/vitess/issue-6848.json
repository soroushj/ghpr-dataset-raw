{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "#### Overview of the Issue\r\n\r\nA backup run with builtinbackupengine had its mysqld_shutdown hook hang indefinitely, causing the tablet to get stuck in a backup/non-serving state.\r\n\r\nThere are two main issues:\r\n1. The parent context of `ExecuteBackup` is being passed through to `params.MysqldShutdown`. This usually has a very large timeout (since backups can take a while), but if mysqld_shutdown gets wedged, we find out several hours later instead of on a much tighter deadline.\r\n2. Hooks do not take a context to their Execute method, which means we cannot leverage `exec.CommandContext` to prevent system commands from running indefinitely.\r\n\r\n#### Reproduction Steps\r\n\r\n0. ??? somehow get mysqld into a state where it will stuck in \"deactivating\" if vttablet tries to stop it\r\n1. Start a backup\r\n2. Observe after several hours the tablet type is still \"backup\", tablet logs will show errors attempting to dialing the mysql socket, and, most notably, [this line](https://github.com/vitessio/vitess/blob/870ef4df2694c4ea6b4ec0ad9912ccb8e4f082ba/go/vt/mysqlctl/mysqld.go#L562) will not be in the logs.\r\n\r\n#### Binary version\r\nExample:\r\n\r\n```sh\r\namason@workspace:~$ vttablet --version\r\nVersion: b8901b9 (Git branch 'HEAD') built on  Thu Oct  1 22:34:33 UTC 2020 by amason@workspace using go1.12.14 linux/amd64\r\n```\r\n\r\n#### Log Fragments\r\n\r\nI grabbed pprof gorounites, grepped for \"backup\" and found this, which clearly shows the problem is in the wedged mysqld_shutdown os call:\r\n\r\n```\r\n1 @ 0x4bcfe5 0x4e1638 0x4d9a19 0x854ac1 0x854ab0 0x853fec 0xe70820 0xf33d22 0xf26fc0 0xf212f8 0x111ca6c 0x1137f84 0x1108839 0x9f7ad4 0xdf265f 0xe675da 0xdf265f 0xdf2849 0x9d98a2 0x9db7cf 0x9e8c4f 0x45cf81\r\n#\t0x4bcfe4\tsyscall.Syscall6+0x4\t\t\t\t\t\t\t\t\t/usr/local/go/src/syscall/asm_linux_amd64.s:44\r\n#\t0x4e1637\tos.(*Process).blockUntilWaitable+0x97\t\t\t\t\t\t\t/usr/local/go/src/os/wait_waitid.go:31\r\n#\t0x4d9a18\tos.(*Process).wait+0x38\t\t\t\t\t\t\t\t\t/usr/local/go/src/os/exec_unix.go:22\r\n#\t0x854ac0\tos.(*Process).Wait+0x60\t\t\t\t\t\t\t\t\t/usr/local/go/src/os/exec.go:125\r\n#\t0x854aaf\tos/exec.(*Cmd).Wait+0x4f\t\t\t\t\t\t\t\t/usr/local/go/src/os/exec/exec.go:474\r\n#\t0x853feb\tos/exec.(*Cmd).Run+0x5b\t\t\t\t\t\t\t\t\t/usr/local/go/src/os/exec/exec.go:318\r\n#\t0xe7081f\tvitess.io/vitess/go/vt/hook.(*Hook).Execute+0x16f\t\t\t\t\t/vt/src/vitess.io/vitess/go/vt/hook/hook.go:146\r\n#\t0xf33d21\tvitess.io/vitess/go/vt/mysqlctl.(*Mysqld).Shutdown+0x491\t\t\t\t/vt/src/vitess.io/vitess/go/vt/mysqlctl/mysqld.go:514\r\n#\t0xf26fbf\tvitess.io/vitess/go/vt/mysqlctl.(*BuiltinBackupEngine).ExecuteBackup+0x4ff\t\t/vt/src/vitess.io/vitess/go/vt/mysqlctl/builtinbackupengine.go:185\r\n#\t0xf212f7\tvitess.io/vitess/go/vt/mysqlctl.Backup+0x727\t\t\t\t\t\t/vt/src/vitess.io/vitess/go/vt/mysqlctl/backup.go:112\r\n#\t0x111ca6b\tvitess.io/vitess/go/vt/vttablet/tabletmanager.(*TabletManager).Backup+0x53b\t\t/vt/src/vitess.io/vitess/go/vt/vttablet/tabletmanager/rpc_backup.go:108\r\n#\t0x1137f83\tvitess.io/vitess/go/vt/vttablet/grpctmserver.(*server).Backup+0x203\t\t\t/vt/src/vitess.io/vitess/go/vt/vttablet/grpctmserver/server.go:451\r\n#\t0x1108838\tvitess.io/vitess/go/vt/proto/tabletmanagerservice._TabletManager_Backup_Handler+0x108\t/vt/src/vitess.io/vitess/go/vt/proto/tabletmanagerservice/tabletmanagerservice.pb.go:1739\r\n#\t0x9f7ad3\tgithub.com/opentracing-contrib/go-grpc.OpenTracingStreamServerInterceptor.func1+0x363\t/go/pkg/mod/github.com/opentracing-contrib/go-grpc@v0.0.0-20180928155321-4b5a12d3ff02/server.go:114\r\n#\t0xdf265e\tgithub.com/grpc-ecosystem/go-grpc-middleware.ChainStreamServer.func1.1.1+0x5e\t\t/go/pkg/mod/github.com/grpc-ecosystem/go-grpc-middleware@v1.1.0/chain.go:49\r\n#\t0xe675d9\tvitess.io/vitess/go/vt/servenv.authenticatingStreamInterceptor+0xe9\t\t\t/vt/src/vitess.io/vitess/go/vt/servenv/grpc_server.go:260\r\n#\t0xdf265e\tgithub.com/grpc-ecosystem/go-grpc-middleware.ChainStreamServer.func1.1.1+0x5e\t\t/go/pkg/mod/github.com/grpc-ecosystem/go-grpc-middleware@v1.1.0/chain.go:49\r\n#\t0xdf2848\tgithub.com/grpc-ecosystem/go-grpc-middleware.ChainStreamServer.func1+0xf8\t\t/go/pkg/mod/github.com/grpc-ecosystem/go-grpc-middleware@v1.1.0/chain.go:58\r\n#\t0x9d98a1\tgoogle.golang.org/grpc.(*Server).processStreamingRPC+0x461\t\t\t\t/go/pkg/mod/google.golang.org/grpc@v1.24.0/server.go:1206\r\n#\t0x9db7ce\tgoogle.golang.org/grpc.(*Server).handleStream+0xd3e\t\t\t\t\t/go/pkg/mod/google.golang.org/grpc@v1.24.0/server.go:1279\r\n#\t0x9e8c4e\tgoogle.golang.org/grpc.(*Server).serveStreams.func1.1+0x9e\t\t\t\t/go/pkg/mod/google.golang.org/grpc@v1.24.0/server.go:710\r\n```\r\n",
  "closed_at": "2020-10-22T00:18:59Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/388311?v=4",
    "events_url": "https://api.github.com/users/deepthi/events{/privacy}",
    "followers_url": "https://api.github.com/users/deepthi/followers",
    "following_url": "https://api.github.com/users/deepthi/following{/other_user}",
    "gists_url": "https://api.github.com/users/deepthi/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/deepthi",
    "id": 388311,
    "login": "deepthi",
    "node_id": "MDQ6VXNlcjM4ODMxMQ==",
    "organizations_url": "https://api.github.com/users/deepthi/orgs",
    "received_events_url": "https://api.github.com/users/deepthi/received_events",
    "repos_url": "https://api.github.com/users/deepthi/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/deepthi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/deepthi/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/deepthi"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/vitessio/vitess/issues/6848/comments",
  "created_at": "2020-10-10T14:54:32Z",
  "events_url": "https://api.github.com/repos/vitessio/vitess/issues/6848/events",
  "html_url": "https://github.com/vitessio/vitess/issues/6848",
  "id": 718636623,
  "labels": [],
  "labels_url": "https://api.github.com/repos/vitessio/vitess/issues/6848/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU3MTg2MzY2MjM=",
  "number": 6848,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/vitessio/vitess",
  "state": "closed",
  "title": "Wedged mysqld shutdown delays error handling in builtinbackup.ExecuteBackup",
  "updated_at": "2020-10-22T00:18:59Z",
  "url": "https://api.github.com/repos/vitessio/vitess/issues/6848",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/4276638?v=4",
    "events_url": "https://api.github.com/users/ajm188/events{/privacy}",
    "followers_url": "https://api.github.com/users/ajm188/followers",
    "following_url": "https://api.github.com/users/ajm188/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajm188/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ajm188",
    "id": 4276638,
    "login": "ajm188",
    "node_id": "MDQ6VXNlcjQyNzY2Mzg=",
    "organizations_url": "https://api.github.com/users/ajm188/orgs",
    "received_events_url": "https://api.github.com/users/ajm188/received_events",
    "repos_url": "https://api.github.com/users/ajm188/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ajm188/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajm188/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ajm188"
  }
}