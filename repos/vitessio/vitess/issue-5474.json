{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "On slower hosts, especially where /tmp is on a real filesystem as opposed to faster tmpfs, the following can happen:\r\n\r\n```\r\n$ time /vt/bin/vtexplain -schema-file schema.sql -vschema-file vschema.json -replication-mode \"ROW\" -output-mode text -sql \"SELECT * from xxx where yyy = 5;\" -shards 2 \r\n----------------------------------------------------------------------\r\nSELECT * from xxx where yyy = 5\r\n\r\n1 ks1/-80: select * from xxx where yyy = 5 limit 10001\r\n\r\n----------------------------------------------------------------------\r\nE1127 02:01:05.085814   23037 conn.go:724] Error reading packet from client 4 (@): read unix /tmp/fakesqldb097001394/fakesqldb.sock->@: use of closed network connection\r\nio.ReadFull(header size) failed\r\n```\r\n\r\nThere are some other error variations like:\r\n\r\n```\r\nE1127 01:29:18.801368   21746 conn.go:722] Error reading packet from client 4 (@): read unix /tmp/fakesqldb792609684/fakesqldb.sock->@: use of closed network connection\r\n```\r\n\r\nThe errors are somewhat non-deterministic, since the host might just be fast enough for these not to be seen during every invocation.\r\n\r\nHosts where /tmp is a real filesystem (on spinning disk) and not tmpfs as in most Linux distros are particularly susceptible (e.g. the default config of Ubuntu 16.04 on a GCP GCE VM).  /tmp is significant, because this is where vtexplain stores it's unix socket files for communication between the fakesqldb instances it starts and the (many) child processes it launches during execution.\r\n\r\nThe cause is a race during the shutdown of the fakesqldb tabletserver instances.  If we insert a check to wait until the instances are properly shutdown (with a timeout, just in case), it will work as expected.  PR to follow.",
  "closed_at": "2019-11-27T03:13:24Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/3308504?v=4",
    "events_url": "https://api.github.com/users/demmer/events{/privacy}",
    "followers_url": "https://api.github.com/users/demmer/followers",
    "following_url": "https://api.github.com/users/demmer/following{/other_user}",
    "gists_url": "https://api.github.com/users/demmer/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/demmer",
    "id": 3308504,
    "login": "demmer",
    "node_id": "MDQ6VXNlcjMzMDg1MDQ=",
    "organizations_url": "https://api.github.com/users/demmer/orgs",
    "received_events_url": "https://api.github.com/users/demmer/received_events",
    "repos_url": "https://api.github.com/users/demmer/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/demmer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/demmer/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/demmer"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/vitessio/vitess/issues/5474/comments",
  "created_at": "2019-11-27T02:11:32Z",
  "events_url": "https://api.github.com/repos/vitessio/vitess/issues/5474/events",
  "html_url": "https://github.com/vitessio/vitess/issues/5474",
  "id": 529071967,
  "labels": [],
  "labels_url": "https://api.github.com/repos/vitessio/vitess/issues/5474/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MjkwNzE5Njc=",
  "number": 5474,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/vitessio/vitess",
  "state": "closed",
  "title": "vtexplain race condition causes failures on slow machines",
  "updated_at": "2019-11-27T03:13:24Z",
  "url": "https://api.github.com/repos/vitessio/vitess/issues/5474",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/772642?v=4",
    "events_url": "https://api.github.com/users/aquarapid/events{/privacy}",
    "followers_url": "https://api.github.com/users/aquarapid/followers",
    "following_url": "https://api.github.com/users/aquarapid/following{/other_user}",
    "gists_url": "https://api.github.com/users/aquarapid/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/aquarapid",
    "id": 772642,
    "login": "aquarapid",
    "node_id": "MDQ6VXNlcjc3MjY0Mg==",
    "organizations_url": "https://api.github.com/users/aquarapid/orgs",
    "received_events_url": "https://api.github.com/users/aquarapid/received_events",
    "repos_url": "https://api.github.com/users/aquarapid/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/aquarapid/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aquarapid/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/aquarapid"
  }
}