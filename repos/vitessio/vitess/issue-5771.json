{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/11834506?v=4",
    "events_url": "https://api.github.com/users/harshit-gangal/events{/privacy}",
    "followers_url": "https://api.github.com/users/harshit-gangal/followers",
    "following_url": "https://api.github.com/users/harshit-gangal/following{/other_user}",
    "gists_url": "https://api.github.com/users/harshit-gangal/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/harshit-gangal",
    "id": 11834506,
    "login": "harshit-gangal",
    "node_id": "MDQ6VXNlcjExODM0NTA2",
    "organizations_url": "https://api.github.com/users/harshit-gangal/orgs",
    "received_events_url": "https://api.github.com/users/harshit-gangal/received_events",
    "repos_url": "https://api.github.com/users/harshit-gangal/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/harshit-gangal/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/harshit-gangal/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/harshit-gangal"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/11834506?v=4",
      "events_url": "https://api.github.com/users/harshit-gangal/events{/privacy}",
      "followers_url": "https://api.github.com/users/harshit-gangal/followers",
      "following_url": "https://api.github.com/users/harshit-gangal/following{/other_user}",
      "gists_url": "https://api.github.com/users/harshit-gangal/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/harshit-gangal",
      "id": 11834506,
      "login": "harshit-gangal",
      "node_id": "MDQ6VXNlcjExODM0NTA2",
      "organizations_url": "https://api.github.com/users/harshit-gangal/orgs",
      "received_events_url": "https://api.github.com/users/harshit-gangal/received_events",
      "repos_url": "https://api.github.com/users/harshit-gangal/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/harshit-gangal/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/harshit-gangal/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/harshit-gangal"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "Scenario:\r\n\r\nSchema & vSchema:\r\n```\r\n$ cat schema.sql \r\ncreate table foo(c1 bigint not null, c2 bigint, PRIMARY KEY (c1)) engine=innodb;\r\n\r\n$ cat vschema.json \r\n{\r\n    \"ks1\": {\r\n        \"sharded\": true,\r\n        \"vindexes\": {\r\n            \"hash\": {\r\n                \"type\": \"hash\"\r\n            }\r\n        },\r\n        \"tables\": {\r\n            \"foo\": {\r\n                \"columnVindexes\": [\r\n                    {\r\n                        \"column\": \"c1\",\r\n                        \"name\": \"hash\"\r\n                    }\r\n                ]\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nAs expected, a single PK-targeting delete will target a single shard:\r\n```\r\n$ vtexplain -schema-file schema.sql -vschema-file vschema.json -shards 4 -sql 'delete from foo where c1 = 1;'\r\n----------------------------------------------------------------------\r\ndelete from foo where c1 = 1\r\n\r\n1 ks1/-40: begin\r\n1 ks1/-40: delete from foo where c1 in (1) /* vtgate:: keyspace_id:166b40b44aba4bd6 */\r\n1 ks1/-40: commit\r\n\r\n----------------------------------------------------------------------\r\n```\r\n\r\nHowever, specifying multiple PKs will result in a full scatter across *ALL* shards, not just the shards containing the PKs:\r\n```\r\n$ vtexplain -schema-file schema.sql -vschema-file vschema.json -shards 4 -sql 'delete from foo where c1 in (1, 3);'\r\n----------------------------------------------------------------------\r\ndelete from foo where c1 in (1, 3)\r\n\r\n1 ks1/-40: begin\r\n1 ks1/-40: delete from foo where c1 in (1, 3)/* vtgate:: filtered_replication_unfriendly */\r\n1 ks1/40-80: begin\r\n1 ks1/40-80: delete from foo where c1 in (1, 3)/* vtgate:: filtered_replication_unfriendly */\r\n1 ks1/80-c0: begin\r\n1 ks1/80-c0: delete from foo where c1 in (1, 3)/* vtgate:: filtered_replication_unfriendly */\r\n1 ks1/c0-: begin\r\n1 ks1/c0-: delete from foo where c1 in (1, 3)/* vtgate:: filtered_replication_unfriendly */\r\n2 ks1/c0-: commit\r\n3 ks1/-40: commit\r\n4 ks1/80-c0: commit\r\n5 ks1/40-80: commit\r\n\r\n----------------------------------------------------------------------\r\n```\r\n\r\nSimilar thing happens for UPDATE statements.\r\n\r\nSingle PK update targets single shard:\r\n\r\n```\r\n$ vtexplain -schema-file schema.sql -vschema-file vschema.json -shards 4 -sql 'update foo set c2 = 0 where c1 = 1;'\r\n----------------------------------------------------------------------\r\nupdate foo set c2 = 0 where c1 = 1\r\n\r\n1 ks1/-40: begin\r\n1 ks1/-40: update foo set c2 = 0 where c1 in (1) /* vtgate:: keyspace_id:166b40b44aba4bd6 */\r\n1 ks1/-40: commit\r\n\r\n----------------------------------------------------------------------\r\n```\r\n\r\nWhile multiple PK-indexed update does a full scatter, even though it does not need to:\r\n\r\n```\r\n$ vtexplain -schema-file schema.sql -vschema-file vschema.json -shards 4 -sql 'update foo set c2 = 0 where c1 in (1, 3);'\r\n----------------------------------------------------------------------\r\nupdate foo set c2 = 0 where c1 in (1, 3)\r\n\r\n1 ks1/-40: begin\r\n1 ks1/-40: update foo set c2 = 0 where c1 in (1, 3)/* vtgate:: filtered_replication_unfriendly */\r\n1 ks1/40-80: begin\r\n1 ks1/40-80: update foo set c2 = 0 where c1 in (1, 3)/* vtgate:: filtered_replication_unfriendly */\r\n1 ks1/80-c0: begin\r\n1 ks1/80-c0: update foo set c2 = 0 where c1 in (1, 3)/* vtgate:: filtered_replication_unfriendly */\r\n1 ks1/c0-: begin\r\n1 ks1/c0-: update foo set c2 = 0 where c1 in (1, 3)/* vtgate:: filtered_replication_unfriendly */\r\n2 ks1/80-c0: commit\r\n3 ks1/40-80: commit\r\n4 ks1/c0-: commit\r\n5 ks1/-40: commit\r\n\r\n----------------------------------------------------------------------\r\n```",
  "closed_at": "2020-04-27T12:03:10Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/402248?v=4",
    "events_url": "https://api.github.com/users/systay/events{/privacy}",
    "followers_url": "https://api.github.com/users/systay/followers",
    "following_url": "https://api.github.com/users/systay/following{/other_user}",
    "gists_url": "https://api.github.com/users/systay/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/systay",
    "id": 402248,
    "login": "systay",
    "node_id": "MDQ6VXNlcjQwMjI0OA==",
    "organizations_url": "https://api.github.com/users/systay/orgs",
    "received_events_url": "https://api.github.com/users/systay/received_events",
    "repos_url": "https://api.github.com/users/systay/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/systay/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/systay/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/systay"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/vitessio/vitess/issues/5771/comments",
  "created_at": "2020-01-27T20:04:17Z",
  "events_url": "https://api.github.com/repos/vitessio/vitess/issues/5771/events",
  "html_url": "https://github.com/vitessio/vitess/issues/5771",
  "id": 555801656,
  "labels": [
    {
      "color": "254387",
      "default": false,
      "description": "Logical improvement (somewhere between a bug and feature)",
      "id": 1638232724,
      "name": "Type: Enhancement",
      "node_id": "MDU6TGFiZWwxNjM4MjMyNzI0",
      "url": "https://api.github.com/repos/vitessio/vitess/labels/Type:%20Enhancement"
    }
  ],
  "labels_url": "https://api.github.com/repos/vitessio/vitess/issues/5771/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1NTU4MDE2NTY=",
  "number": 5771,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/vitessio/vitess",
  "state": "closed",
  "title": "Do not do a full scatter for DELETE or UPDATE statements with multiple PKs.",
  "updated_at": "2020-04-27T12:03:10Z",
  "url": "https://api.github.com/repos/vitessio/vitess/issues/5771",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/772642?v=4",
    "events_url": "https://api.github.com/users/aquarapid/events{/privacy}",
    "followers_url": "https://api.github.com/users/aquarapid/followers",
    "following_url": "https://api.github.com/users/aquarapid/following{/other_user}",
    "gists_url": "https://api.github.com/users/aquarapid/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/aquarapid",
    "id": 772642,
    "login": "aquarapid",
    "node_id": "MDQ6VXNlcjc3MjY0Mg==",
    "organizations_url": "https://api.github.com/users/aquarapid/orgs",
    "received_events_url": "https://api.github.com/users/aquarapid/received_events",
    "repos_url": "https://api.github.com/users/aquarapid/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/aquarapid/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aquarapid/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/aquarapid"
  }
}