{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "COLLABORATOR",
  "body": "We've had this lingering issue for a long time where vtgates \"loose\" a tablet. We've made some discoveries lately and think we have a hunch of where the issue is.\r\n\r\n![Screen Shot 2019-09-26 at 3 15 38 PM](https://user-images.githubusercontent.com/11489/65659999-b2121800-e070-11e9-8062-6755e2741d76.png)\r\n\r\nThere should be a tablet `uswest2-0000011101` in this shard but it's missing. No matter how long we wait it will never return. If we restart the tablet it does return.\r\n\r\nIf we look in the log when there is this issue we find the following log entry in the vtgate:\r\n```\r\nadding duplicate tablet uswest2-0000011101 for uswest2: alias:<cell:\"uswest2\" uid:11101 > hostname:\"10.136.93.210\" port_map:<key:\"grpc\" value:16002 > port_map:<key:\"vt\" value:15002 > keyspace:\"arnhem_customer\" shard:\"-20\" key_range:<end:\" \" > type:SPARE db_name_override:\"vt_arnhem_customer_lo_20\" mysql_hostname:\"REDACTED\" mysql_port:3306\r\n```\r\n\r\nTracing that down to the following code go/vt/discovery/healthcheck.go:736:\r\n```\r\n\tif _, ok := hc.addrToHealth[key]; ok {\r\n\t\thc.mu.Unlock()\r\n\t\tlog.Warningf(\"adding duplicate tablet %v for %v: %+v\", name, tablet.Alias.Cell, tablet)\r\n\t\treturn\r\n\t}\r\n```\r\n\r\nAnother piece of the puzzle is that this usually happens when there's been a restart. Either due to a restart of the cluster (for a redeploy) or because of a node crash or something similar.\r\n\r\nI think the issue here is that when the tablets restart the tablet pod is allocated by Kubernetes to a node that previously ran a different tablet. That is, the node:port combo (which constitutes the `key` above) is re-used for different tablets!\r\n\r\nI think the solution is just not to do this check. The new tablet simply overwrites the old but I'm not sure what the implications would be. Maybe the solution is just to crash and have Kubernetes restart the vtgate pod and then it will not have seen the old tablet on that node and all will be good?\r\n\r\nIt doesn't seem like we should be the only ones encountering this issue with running Vitess on Kubernetes...",
  "closed_at": "2019-09-27T17:29:23Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/589370?v=4",
    "events_url": "https://api.github.com/users/sougou/events{/privacy}",
    "followers_url": "https://api.github.com/users/sougou/followers",
    "following_url": "https://api.github.com/users/sougou/following{/other_user}",
    "gists_url": "https://api.github.com/users/sougou/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/sougou",
    "id": 589370,
    "login": "sougou",
    "node_id": "MDQ6VXNlcjU4OTM3MA==",
    "organizations_url": "https://api.github.com/users/sougou/orgs",
    "received_events_url": "https://api.github.com/users/sougou/received_events",
    "repos_url": "https://api.github.com/users/sougou/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/sougou/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sougou/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/sougou"
  },
  "comments": 9,
  "comments_url": "https://api.github.com/repos/vitessio/vitess/issues/5229/comments",
  "created_at": "2019-09-26T05:25:45Z",
  "events_url": "https://api.github.com/repos/vitessio/vitess/issues/5229/events",
  "html_url": "https://github.com/vitessio/vitess/issues/5229",
  "id": 498666042,
  "labels": [],
  "labels_url": "https://api.github.com/repos/vitessio/vitess/issues/5229/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0OTg2NjYwNDI=",
  "number": 5229,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/vitessio/vitess",
  "state": "closed",
  "title": "vtgate intermittently loses a tablet",
  "updated_at": "2019-09-27T17:29:23Z",
  "url": "https://api.github.com/repos/vitessio/vitess/issues/5229",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/11489?v=4",
    "events_url": "https://api.github.com/users/tirsen/events{/privacy}",
    "followers_url": "https://api.github.com/users/tirsen/followers",
    "following_url": "https://api.github.com/users/tirsen/following{/other_user}",
    "gists_url": "https://api.github.com/users/tirsen/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/tirsen",
    "id": 11489,
    "login": "tirsen",
    "node_id": "MDQ6VXNlcjExNDg5",
    "organizations_url": "https://api.github.com/users/tirsen/orgs",
    "received_events_url": "https://api.github.com/users/tirsen/received_events",
    "repos_url": "https://api.github.com/users/tirsen/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/tirsen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tirsen/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/tirsen"
  }
}