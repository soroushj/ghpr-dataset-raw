{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "COLLABORATOR",
  "body": "## The Problem\r\n\r\nWith the changes introduced to the `_vt.local_metadata` table between https://github.com/vitessio/vitess/pull/4727 and https://github.com/vitessio/vitess/pull/4830, we are unable to go back and forth between versions of vttablet without putting the\r\n`_vt.local_metadata` in an inconsistent state.\r\n\r\nWe were trying to move from [this release](https://github.com/tinyspeck/vitess/releases/tag/slack-vitess-2019-04-02.r0), which doesn't have any of the aforementioned changes, to one that [does contain\r\nthem](https://github.com/tinyspeck/vitess/releases/tag/slack-vitess-2019.04.25r1).  When we did that, the state our tablet `_vt.local_metadata` records were something like this:\r\n\r\n```mysql\r\nmysql> select * from _vt.local_metadata;\r\n+---------------+-----------------------+---------------+\r\n| name          | value                 | db_name       |\r\n+---------------+-----------------------+---------------+\r\n| Alias         | alias_1               | vt_keyspace   |\r\n| ClusterAlias  | keyspace  .-          | vt_keyspace   |\r\n| DataCenter    | datacenter_1          | vt_keyspace   |\r\n| PromotionRule | neutral               | vt_keyspace   |\r\n+---------------+-----------------------+---------------+\r\n4 rows in set (0.00 sec)\r\n```\r\n\r\nwith a schema like:\r\n\r\n```\r\nCREATE TABLE `local_metadata` (\r\n  `name` varchar(255) NOT NULL,\r\n  `value` varchar(255) NOT NULL,\r\n  `db_name` varbinary(255) NOT NULL DEFAULT '',\r\n  PRIMARY KEY (`name`,`db_name`)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4\r\n```\r\n\r\nAfter we found a [separate regression with tablet configuration](https://github.com/vitessio/vitess/issues/4870), we had to roll this build back, resulting in this same table now looking like this:\r\n\r\n```mysql\r\n+---------------+-----------------------+---------------+\r\n| name          | value                 | db_name       |\r\n+---------------+-----------------------+---------------+\r\n| Alias         | alias_1               | vt_keyspace   |\r\n| Alias         | alias_1               |               |\r\n| ClusterAlias  | keyspace.-            | vt_keyspace   |\r\n| ClusterAlias  | keyspace.-            |               |\r\n| DataCenter    | datacenter_1          | vt_keyspace   |\r\n| DataCenter    | datacenter_1          |               |\r\n| PromotionRule | neutral               | vt_keyspace   |\r\n| PromotionRule | neutral               |               |\r\n+---------------+-----------------------+---------------+\r\n9 rows in set (0.00 sec)\r\n```\r\n\r\nNote that the old build now inserted entries into this table without `db_name` specified, since it doesn't know about that column, and fell back onto the default value provided in the schema.\r\n\r\nWe patched up the tablet configuration regression on our end and tried to roll forward but tablets would not start due to the following error:\r\n\r\n```\r\nF0523 15:16:27.442595    6541 vttablet.go:130] NewActionAgent() failed: Duplicate entry 'Alias-vt_keyspace for key 'PRIMARY' (errno 1062) (sqlstate 23000) during query: UPDATE _vt.local_metadata SET db_name='vt_keyspace' WHERE db_name=''\r\nfailed to -init_populate_metadata\r\nagent.InitTablet failed\r\n```\r\n\r\nIt turns out that the [unconditional updates](https://github.com/vitessio/vitess/blob/f41656fe71fbc42f8fa087e7a5bc28d817c5a8ea/go/vt/mysqlctl/metadata_tables.go#L99) to the rows in this table causes a primary key violation that the tablet is unable to recover from.\r\n\r\n## Proposed Workaround\r\n\r\nSince this is preventing us from upgrading our tablets to the latest version, we intend on doing the following to get this table back into the correct state:\r\n\r\n- going into each master of the affected keyspace shards and dropping the `_vt.local_metadata` table\r\n- waiting for the table deletion to propagate to replicas\r\n- restarting tablets in each shard, taking care to do a reparent of the current master\r\n\r\nThis seems like the safest way to get this table in a consistent state without manually modifying\r\nits data and potentially messing up the replication stream. Since we use orchestrator, the only\r\nconcern is that its view of the affected shards would be inconsistent while we do the rolling\r\nrestart of the tablets. However, it seems like that inconsistency would be short lived and only\r\naffect the orc gui and not availability.\r\n",
  "closed_at": "2019-09-11T01:54:13Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/589370?v=4",
    "events_url": "https://api.github.com/users/sougou/events{/privacy}",
    "followers_url": "https://api.github.com/users/sougou/followers",
    "following_url": "https://api.github.com/users/sougou/following{/other_user}",
    "gists_url": "https://api.github.com/users/sougou/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/sougou",
    "id": 589370,
    "login": "sougou",
    "node_id": "MDQ6VXNlcjU4OTM3MA==",
    "organizations_url": "https://api.github.com/users/sougou/orgs",
    "received_events_url": "https://api.github.com/users/sougou/received_events",
    "repos_url": "https://api.github.com/users/sougou/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/sougou/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sougou/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/sougou"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/vitessio/vitess/issues/4888/comments",
  "created_at": "2019-05-29T00:04:02Z",
  "events_url": "https://api.github.com/repos/vitessio/vitess/issues/4888/events",
  "html_url": "https://github.com/vitessio/vitess/issues/4888",
  "id": 449528514,
  "labels": [],
  "labels_url": "https://api.github.com/repos/vitessio/vitess/issues/4888/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NDk1Mjg1MTQ=",
  "number": 4888,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/vitessio/vitess",
  "state": "closed",
  "title": "local_metadata table left in inconsistent state between commits",
  "updated_at": "2019-09-11T01:54:13Z",
  "url": "https://api.github.com/repos/vitessio/vitess/issues/4888",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1807482?v=4",
    "events_url": "https://api.github.com/users/brirams/events{/privacy}",
    "followers_url": "https://api.github.com/users/brirams/followers",
    "following_url": "https://api.github.com/users/brirams/following{/other_user}",
    "gists_url": "https://api.github.com/users/brirams/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brirams",
    "id": 1807482,
    "login": "brirams",
    "node_id": "MDQ6VXNlcjE4MDc0ODI=",
    "organizations_url": "https://api.github.com/users/brirams/orgs",
    "received_events_url": "https://api.github.com/users/brirams/received_events",
    "repos_url": "https://api.github.com/users/brirams/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brirams/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brirams/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brirams"
  }
}