{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "Sometimes (every few weeks) during a log rotation of the file it's tailing fluentd will stop updating its .pos file. Even a day later when the log file rotates again it does not update the pos file.\r\nEven though the pos file is not being updated the file is being consumed and the output is being produced.\r\nThe contents of the pos file are a few lines into the new log file and the inode number of the new log file.\r\n\r\nThe double detected rotation/following tail did not happen on previous days, however I have seen it on another server and it didn't appear to cause a problem that time.\r\n\r\nA restart of the service ```service td-agent restart``` fixes the problem, but it reads the log from the start, which is less than ideal.\r\n\r\nVersion: td-agent 2.3.3 x64\r\nOS: Redhat 6.8\r\n\r\n/var/log/td-agent/td-agent.log.1\r\n```\r\n2016-12-20 03:08:03 +0000 [info]: detected rotation of /logs/application.log; waiting 5 seconds\r\n2016-12-20 03:08:03 +0000 [info]: following tail of /logs/application.log\r\n2016-12-20 03:08:03 +0000 [info]: detected rotation of /logs/application.log; waiting 5 seconds\r\n2016-12-20 03:08:03 +0000 [info]: following tail of /logs/application.log\r\n2016-12-20 03:11:37 +0000 [info]: force flushing buffered events\r\n```\r\n/var/log/td-agent/td-agent.log.2.gz\r\n```\r\n2016-12-19 03:27:03 +0000 [info]: detected rotation of /logs/application.log; waiting 5 seconds\r\n2016-12-19 03:27:03 +0000 [info]: following tail of /logs/application.log\r\n2016-12-19 03:32:12 +0000 [info]: force flushing buffered events\r\n```\r\n\r\n/var/log/td-agent/application.log.pos:\r\n```/logs/application.log    000000000000f16d    00000000000a419e```\r\n\r\nThe pos file last updated on log rotation\r\n```\r\nll /var/log/td-agent/application.log.pos\r\n-rw-r--r--. 1 td-agent td-agent   80 Dec 20 03:08 application.log.pos\r\n```\r\n\r\n```\r\n$ stat /logs/application.log \r\n  File: `/logs/application.log'\r\n  Size: 2188501633\tBlocks: 4274432    IO Block: 4096   regular file\r\nDevice: fd00h/64768d\tInode: 672158      Links: 1\r\n```\r\n\r\nstrace of the fluentd process\r\n```\r\n[pid 15119] inotify_add_watch(14, \"/logs/application.log\", IN_MODIFY|IN_ATTRIB|IN_MOVED_FROM|IN_MOVED_TO|IN_CREATE|IN_DELETE|IN_DELETE_SELF|IN_MOVE_SELF|IN_DONT_FOLLOW|IN_MASK_ADD) = 102215122\r\n[pid 15119] statfs(\"/logs/application.log\", {f_type=\"EXT2_SUPER_MAGIC\", f_bsize=4096, f_blocks=5845471, f_bfree=4475644, f_bavail=4177046, f_files=1493280, f_ffree=1288943, f_fsid={-615535995, 789078184}, f_namelen=255, f_frsize=4096}) = 0\r\n[pid 15119] lstat(\"/logs/application.log\", {st_mode=S_IFREG|0644, st_size=2100168079, ...}) = 0\r\n[pid 15119] stat(\"/logs/application.log\", {st_mode=S_IFREG|0644, st_size=2100168079, ...}) = 0\r\n[pid 15119] read(25, \"[20/Dec/2016:09:31:59.667731 +00\"..., 2048) = 252\r\n[pid 15119] read(25, \"\", 2048)          = 0\r\n[pid 15119] lseek(25, 0, SEEK_CUR)      = 2100168079\r\n[pid 15119] clock_gettime(CLOCK_MONOTONIC, {4149597, 999687012}) = 0\r\n[pid 15119] epoll_wait(13, {{EPOLLIN, {u32=14, u64=4294967310}}}, 64, 123) = 1\r\n[pid 15119] clock_gettime(CLOCK_MONOTONIC, {4149597, 999728739}) = 0\r\n[pid 15119] read(14, \"\\321\\255\\27\\6\\0\\200\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\", 287) = 16\r\n[pid 15119] clock_gettime(CLOCK_MONOTONIC, {4149597, 999767484}) = 0\r\n[pid 15119] epoll_wait(13, {{EPOLLIN, {u32=14, u64=4294967310}}}, 64, 123) = 1\r\n[pid 15119] clock_gettime(CLOCK_MONOTONIC, {4149598, 19991561}) = 0\r\n[pid 15119] read(14, \"\\322\\255\\27\\6\\2\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\", 287) = 16\r\n[pid 15119] lstat(\"/logs/application.log\", {st_mode=S_IFREG|0644, st_size=2100168990, ...}) = 0\r\n[pid 15119] inotify_rm_watch(14, 102215122) = 0\r\n```\r\n\r\n\r\nConfig:\r\n```\r\n<source>\r\n  @type tail\r\n  format none\r\n  path /logs/application.log\r\n  pos_file /var/log/td-agent/application.log.pos\r\n  tag system.event\r\n</source>\r\n\r\n<filter system.event>\r\n  @type parser\r\n  format /\\[SYSEVT\\] (?<data>.+)/\r\n  key_name message\r\n  suppress_parse_error_log \r\n</filter>\r\n\r\n<filter system.event>\r\n  @type parser\r\n  format json\r\n  key_name data\r\n</filter>\r\n\r\n\r\n\r\n<match system.event>\r\n  @type kafka_buffered\r\n  brokers kafka:9092\r\n  disable_retry_limit true\r\n  flush_interval 1s\r\n  compression_codec gzip\r\n  exclude_partition_key true\r\n</match>```\r\n\r\n",
  "closed_at": "2017-06-22T02:00:41Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/16928?v=4",
    "events_url": "https://api.github.com/users/repeatedly/events{/privacy}",
    "followers_url": "https://api.github.com/users/repeatedly/followers",
    "following_url": "https://api.github.com/users/repeatedly/following{/other_user}",
    "gists_url": "https://api.github.com/users/repeatedly/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/repeatedly",
    "id": 16928,
    "login": "repeatedly",
    "node_id": "MDQ6VXNlcjE2OTI4",
    "organizations_url": "https://api.github.com/users/repeatedly/orgs",
    "received_events_url": "https://api.github.com/users/repeatedly/received_events",
    "repos_url": "https://api.github.com/users/repeatedly/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/repeatedly/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/repeatedly/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/repeatedly"
  },
  "comments": 23,
  "comments_url": "https://api.github.com/repos/fluent/fluentd/issues/1383/comments",
  "created_at": "2016-12-20T12:27:03Z",
  "events_url": "https://api.github.com/repos/fluent/fluentd/issues/1383/events",
  "html_url": "https://github.com/fluent/fluentd/issues/1383",
  "id": 196660445,
  "labels": [
    {
      "color": "e11d21",
      "default": true,
      "description": null,
      "id": 94152935,
      "name": "bug",
      "node_id": "MDU6TGFiZWw5NDE1MjkzNQ==",
      "url": "https://api.github.com/repos/fluent/fluentd/labels/bug"
    },
    {
      "color": "006b75",
      "default": false,
      "description": null,
      "id": 54137294,
      "name": "v0.12",
      "node_id": "MDU6TGFiZWw1NDEzNzI5NA==",
      "url": "https://api.github.com/repos/fluent/fluentd/labels/v0.12"
    },
    {
      "color": "009800",
      "default": false,
      "description": null,
      "id": 146493149,
      "name": "v0.14",
      "node_id": "MDU6TGFiZWwxNDY0OTMxNDk=",
      "url": "https://api.github.com/repos/fluent/fluentd/labels/v0.14"
    }
  ],
  "labels_url": "https://api.github.com/repos/fluent/fluentd/issues/1383/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxOTY2NjA0NDU=",
  "number": 1383,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/fluent/fluentd",
  "state": "closed",
  "title": "in_tail pos file stops updating after log rotate",
  "updated_at": "2017-06-22T02:00:41Z",
  "url": "https://api.github.com/repos/fluent/fluentd/issues/1383",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1813336?v=4",
    "events_url": "https://api.github.com/users/tboothman/events{/privacy}",
    "followers_url": "https://api.github.com/users/tboothman/followers",
    "following_url": "https://api.github.com/users/tboothman/following{/other_user}",
    "gists_url": "https://api.github.com/users/tboothman/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/tboothman",
    "id": 1813336,
    "login": "tboothman",
    "node_id": "MDQ6VXNlcjE4MTMzMzY=",
    "organizations_url": "https://api.github.com/users/tboothman/orgs",
    "received_events_url": "https://api.github.com/users/tboothman/received_events",
    "repos_url": "https://api.github.com/users/tboothman/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/tboothman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tboothman/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/tboothman"
  }
}