{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Describe the bug**\r\n\r\nIn version 1.9.3 there was introduced some change which results with the exception:\r\n\r\n```\r\nfluentd_1  | 2020-08-20 16:13:03 +0000 [debug]: #0 Created new chunk chunk_id=\"5ad51651732b92b385132e043b147b60\" metadata=#<struct Fluent::Plugin::Buffer::Metadata timekey=nil, tag=\"kubernetes.*\", variables=nil, seq=0>\r\nfluentd_1  | 2020-08-20 16:13:04 +0000 [debug]: #0 taking back chunk for errors. chunk=\"5ad51642ca363a0850a5ce90cdc75429\"\r\nfluentd_1  | 2020-08-20 16:13:04 +0000 [warn]: #0 failed to flush the buffer. retry_time=0 next_retry_seconds=2020-08-20 16:13:05 +0000 chunk=\"5ad51642ca363a0850a5ce90cdc75429\" error_class=IOError error=\"closed stream\"\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/event.rb:325:in `readpartial'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/event.rb:325:in `each'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/event.rb:325:in `block in each'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/buffer/chunk.rb:213:in `block in open'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/buffer/file_chunk.rb:171:in `open'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/buffer/chunk.rb:205:in `open'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/event.rb:324:in `each'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluent-plugin-sumologic_output-1.7.1/lib/fluent/plugin/out_sumologic.rb:301:in `write'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/output.rb:1133:in `try_flush'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/output.rb:1439:in `flush_thread_run'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/output.rb:461:in `block (2 levels) in start'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin_helper/thread.rb:78:in `block in thread_create'\r\n```\r\n\r\nHere is link to the breaking PR: https://github.com/fluent/fluentd/commit/c5288bc2\r\n\r\nBased on my short investigation I can see that the `Tempfile` in `binmode` for some reason is closed before it should be.\r\nAccording to Ruby documentation:\r\n\r\n```\r\nIf a block is given, then a Tempfile object will be constructed, and the block is run with said object as argument. The Tempfile object will be automatically closed after the block terminates. The call returns the value of the block.\r\n```\r\n\r\nThere is no issue without binmode (locally modified code). Current solution is to use `1.9.2` or `compress text`.\r\n\r\n**To Reproduce**\r\n\r\nDockerfile:\r\n```\r\nFROM fluent/fluentd:v1.11.2-debian-1.0\r\n\r\nUSER root\r\n\r\nRUN gem install fluent-plugin-sumologic_output -v 1.7.1\r\nUSER fluent\r\n```\r\n\r\nfluentd.conf:\r\n```\r\n<source>\r\n  @type dummy\r\n  dummy {\"log\": \"\"}\r\n  tag kubernetes.*\r\n  rate 20000\r\n</source>\r\n<match kubernetes.**>\r\n  @type sumologic\r\n  endpoint \"http://http:3001\"\r\n  <buffer>\r\n    @type file\r\n    path /fluentd/buffer\r\n    compress gzip\r\n    flush_interval \"5s\"\r\n  </buffer>\r\n</match>\r\n<system>\r\n  log_level debug\r\n</system>\r\n```\r\n\r\ndocker-compose.yaml\r\n```\r\nversion: '3'\r\nservices:\r\n    fluentd:\r\n        build: .\r\n        volumes:\r\n            - ./fluentd.conf:/fluentd/etc/fluent.conf\r\n    http:\r\n        image: jmalloc/echo-server\r\n        environment:\r\n            PORT: 3001\r\n```\r\n\r\n**Expected behavior**\r\n\r\nNo exception\r\n\r\n**Your Environment**\r\n\r\n- no need as docker-compose provided\r\n\r\n**Your Configuration**\r\n\r\n```\r\n<source>\r\n  @type dummy\r\n  dummy {\"log\": \"\"}\r\n  tag kubernetes.*\r\n  rate 20000\r\n</source>\r\n<match kubernetes.**>\r\n  @type sumologic\r\n  endpoint \"http://http:3001\"\r\n  <buffer>\r\n    @type file\r\n    path /fluentd/buffer\r\n    compress gzip\r\n    flush_interval \"5s\"\r\n  </buffer>\r\n</match>\r\n<system>\r\n  log_level debug\r\n</system>\r\n```\r\n\r\n**Your Error Log**\r\n\r\n```\r\n\u279c  fluent docker-compose up\r\nStarting fluent_fluentd_1 ... done\r\nStarting fluent_http_1    ... done\r\nAttaching to fluent_fluentd_1, fluent_http_1\r\nhttp_1     | Echo server listening on port 3001.\r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [info]: parsing config file is succeeded path=\"/fluentd/etc/fluent.conf\"\r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [info]: gem 'fluent-plugin-sumologic_output' version '1.7.1'\r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [info]: gem 'fluentd' version '1.11.2'\r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [debug]: Custom fields: \r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [debug]: Custom dimensions: \r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [warn]: both of Plugin @id and path for <storage> are not specified. Using on-memory store.\r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [warn]: both of Plugin @id and path for <storage> are not specified. Using on-memory store.\r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [debug]: No fluent logger for internal event\r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [info]: using configuration file: <ROOT>\r\nfluentd_1  |   <source>\r\nfluentd_1  |     @type dummy\r\nfluentd_1  |     dummy {\"log\":\"\"}\r\nfluentd_1  |     tag \"kubernetes.*\"\r\nfluentd_1  |     rate 20000\r\nfluentd_1  |   </source>\r\nfluentd_1  |   <match kubernetes.**>\r\nfluentd_1  |     @type sumologic\r\nfluentd_1  |     endpoint xxxxxx\r\nfluentd_1  |     sumo_client \"fluentd-output\"\r\nfluentd_1  |     <buffer>\r\nfluentd_1  |       @type \"file\"\r\nfluentd_1  |       path \"/fluentd/buffer\"\r\nfluentd_1  |       compress gzip\r\nfluentd_1  |       flush_interval 5s\r\nfluentd_1  |     </buffer>\r\nfluentd_1  |   </match>\r\nfluentd_1  |   <system>\r\nfluentd_1  |     log_level debug\r\nfluentd_1  |   </system>\r\nfluentd_1  | </ROOT>\r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [info]: starting fluentd-1.11.2 pid=6 ruby=\"2.6.6\"\r\nfluentd_1  | 2020-08-20 16:13:01 +0000 [info]: spawn command to main:  cmdline=[\"/usr/local/bin/ruby\", \"-Eascii-8bit:ascii-8bit\", \"/usr/local/bundle/bin/fluentd\", \"-c\", \"/fluentd/etc/fluent.conf\", \"-p\", \"/fluentd/plugins\", \"--under-supervisor\"]\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [info]: adding match pattern=\"kubernetes.**\" type=\"sumologic\"\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [debug]: #0 Custom fields: \r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [debug]: #0 Custom dimensions: \r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [info]: adding source type=\"dummy\"\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [warn]: #0 both of Plugin @id and path for <storage> are not specified. Using on-memory store.\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [warn]: #0 both of Plugin @id and path for <storage> are not specified. Using on-memory store.\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [debug]: #0 No fluent logger for internal event\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [info]: #0 starting fluentd worker pid=16 ppid=6 worker=0\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [debug]: #0 restoring buffer file: path = /fluentd/buffer/buffer.b5ad5164796799b10ea4b5ecff7d98538.log\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [debug]: #0 restoring buffer file: path = /fluentd/buffer/buffer.q5ad51642ca363a0850a5ce90cdc75429.log\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [debug]: #0 buffer started instance=69845180126480 stage_size=651046 queue_size=941127\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [info]: #0 fluentd worker is now running worker=0\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [debug]: #0 flush_thread actually running\r\nfluentd_1  | 2020-08-20 16:13:02 +0000 [debug]: #0 enqueue_thread actually running\r\nfluentd_1  | 2020-08-20 16:13:03 +0000 [debug]: #0 Created new chunk chunk_id=\"5ad51651732b92b385132e043b147b60\" metadata=#<struct Fluent::Plugin::Buffer::Metadata timekey=nil, tag=\"kubernetes.*\", variables=nil, seq=0>\r\nfluentd_1  | 2020-08-20 16:13:04 +0000 [debug]: #0 taking back chunk for errors. chunk=\"5ad51642ca363a0850a5ce90cdc75429\"\r\nfluentd_1  | 2020-08-20 16:13:04 +0000 [warn]: #0 failed to flush the buffer. retry_time=0 next_retry_seconds=2020-08-20 16:13:05 +0000 chunk=\"5ad51642ca363a0850a5ce90cdc75429\" error_class=IOError error=\"closed stream\"\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/event.rb:325:in `readpartial'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/event.rb:325:in `each'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/event.rb:325:in `block in each'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/buffer/chunk.rb:213:in `block in open'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/buffer/file_chunk.rb:171:in `open'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/buffer/chunk.rb:205:in `open'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/event.rb:324:in `each'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluent-plugin-sumologic_output-1.7.1/lib/fluent/plugin/out_sumologic.rb:301:in `write'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/output.rb:1133:in `try_flush'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/output.rb:1439:in `flush_thread_run'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin/output.rb:461:in `block (2 levels) in start'\r\nfluentd_1  |   2020-08-20 16:13:04 +0000 [warn]: #0 /usr/local/bundle/gems/fluentd-1.11.2/lib/fluent/plugin_helper/thread.rb:78:in `block in thread_create'\r\nhttp_1     | 172.26.0.3:53046 | POST /\r\nfluentd_1  | 2020-08-20 16:13:07 +0000 [warn]: #0 retry succeeded. chunk_id=\"5ad51642ca363a0850a5ce90cdc75429\"\r\nfluentd_1  | 2020-08-20 16:13:08 +0000 [debug]: #0 Created new chunk chunk_id=\"5ad51656380282515fe2351bf5df6621\" metadata=#<struct Fluent::Plugin::Buffer::Metadata timekey=nil, tag=\"kubernetes.*\", variables=nil, seq=0>\r\nfluentd_1  | 2020-08-20 16:13:09 +0000 [debug]: #0 taking back chunk for errors. chunk=\"5ad5164796799b10ea4b5ecff7d98538\"\r\nfluentd_1  | 2020-08-20 16:13:09 +0000 [warn]: #0 failed to flush the buffer. retry_time=0 next_retry_seconds=2020-08-20 16:13:10 +0000 chunk=\"5ad5164796799b10ea4b5ecff7d98538\" error_class=IOError error=\"closed stream\"\r\nfluentd_1  |   2020-08-20 16:13:09 +0000 [warn]: #0 suppressed same stacktrace\r\n```\r\n\r\n**Additional context**\r\nN/A\r\n",
  "closed_at": "2020-09-29T05:31:27Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/16928?v=4",
    "events_url": "https://api.github.com/users/repeatedly/events{/privacy}",
    "followers_url": "https://api.github.com/users/repeatedly/followers",
    "following_url": "https://api.github.com/users/repeatedly/following{/other_user}",
    "gists_url": "https://api.github.com/users/repeatedly/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/repeatedly",
    "id": 16928,
    "login": "repeatedly",
    "node_id": "MDQ6VXNlcjE2OTI4",
    "organizations_url": "https://api.github.com/users/repeatedly/orgs",
    "received_events_url": "https://api.github.com/users/repeatedly/received_events",
    "repos_url": "https://api.github.com/users/repeatedly/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/repeatedly/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/repeatedly/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/repeatedly"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/fluent/fluentd/issues/3110/comments",
  "created_at": "2020-08-20T16:48:22Z",
  "events_url": "https://api.github.com/repos/fluent/fluentd/issues/3110/events",
  "html_url": "https://github.com/fluent/fluentd/issues/3110",
  "id": 682902353,
  "labels": [],
  "labels_url": "https://api.github.com/repos/fluent/fluentd/issues/3110/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2ODI5MDIzNTM=",
  "number": 3110,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/fluent/fluentd",
  "state": "closed",
  "title": "IOError error=\"closed stream\" using buffer and gzip compression",
  "updated_at": "2020-09-29T05:31:27Z",
  "url": "https://api.github.com/repos/fluent/fluentd/issues/3110",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/58699848?v=4",
    "events_url": "https://api.github.com/users/sumo-drosiek/events{/privacy}",
    "followers_url": "https://api.github.com/users/sumo-drosiek/followers",
    "following_url": "https://api.github.com/users/sumo-drosiek/following{/other_user}",
    "gists_url": "https://api.github.com/users/sumo-drosiek/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/sumo-drosiek",
    "id": 58699848,
    "login": "sumo-drosiek",
    "node_id": "MDQ6VXNlcjU4Njk5ODQ4",
    "organizations_url": "https://api.github.com/users/sumo-drosiek/orgs",
    "received_events_url": "https://api.github.com/users/sumo-drosiek/received_events",
    "repos_url": "https://api.github.com/users/sumo-drosiek/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/sumo-drosiek/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sumo-drosiek/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/sumo-drosiek"
  }
}