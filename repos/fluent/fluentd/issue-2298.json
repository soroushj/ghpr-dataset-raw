{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "Currently I'm using syslog to send log to fluentd, my configuration is below:\r\n- td-agent v3.3.0\r\n- Amazon Linux 2\r\n- My config file is\r\n\r\n```\r\n<source>\r\n  @type syslog\r\n  port 25140\r\n  bind 0.0.0.0\r\n  protocol_type tcp\r\n  frame_type octet_count\r\n  tag app1\r\n  <parse>\r\n    message_format rfc5424\r\n  </parse>\r\n</source>\r\n\r\n<match app1.**>\r\n  @type file\r\n  @id output_file\r\n  path /var/log/td-agent/app1\r\n</match>\r\n```\r\n\r\nfluentd works well but sometimes in td-agent.log I saw the error like this\r\n\r\n```\r\n2019-02-17 18:05:00 +0000 [warn]: #0 failed to parse message data=\"<190>1 2019-02-17T18:05:00.02336\"\r\n2019-02-17 18:05:01 +0000 [error]: #0 unexpected error on reading data host=\"x.x.x.x\" port=24241 error_class=ArgumentError error=\"invalid value for Integer(): \\\"2+00:00 \\\"\"\r\n```\r\n\r\nAfter tweaking around I figured out that fluentd doesn't check message length when read from buffer, as you could see in this line:\r\n\r\nhttps://github.com/fluent/fluentd/blob/e0ac111800a5c9e5a0e1bbc4c765615094daeb54/lib/fluent/plugin/in_syslog.rb#L171\r\n\r\nDue to the nature of TCP, fluentd might get only first halt of an message then try to parse the octet count on the second half\r\n\r\nMy propose is that we need to implement a check then if message length is smaller than octet count then do not process it and get new data from socket\r\n\r\n```\r\n--- in_syslog.rb        2019-02-17 16:50:40.071929637 +0000\r\n+++ /opt/td-agent/embedded/lib/ruby/gems/2.4.0/gems/fluentd-1.3.3/lib/fluent/plugin/in_syslog.rb        2019-02-17 18:17:54.548634558 +0000\r\n@@ -169,6 +169,10 @@\r\n               num = Integer(buffer[pos..idx])\r\n               pos = idx + num\r\n               msg = buffer[idx + 1...pos]\r\n+              if msg.size < num - 1\r\n+                pos = pos - num - num.to_s.size\r\n+                break\r\n+              end\r\n               message_handler(msg, conn)\r\n             end\r\n           else\r\n```\r\n\r\nI could make a PR if you think this is good enough.\r\n\r\nCheers.",
  "closed_at": "2019-03-06T01:48:03Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/16928?v=4",
    "events_url": "https://api.github.com/users/repeatedly/events{/privacy}",
    "followers_url": "https://api.github.com/users/repeatedly/followers",
    "following_url": "https://api.github.com/users/repeatedly/following{/other_user}",
    "gists_url": "https://api.github.com/users/repeatedly/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/repeatedly",
    "id": 16928,
    "login": "repeatedly",
    "node_id": "MDQ6VXNlcjE2OTI4",
    "organizations_url": "https://api.github.com/users/repeatedly/orgs",
    "received_events_url": "https://api.github.com/users/repeatedly/received_events",
    "repos_url": "https://api.github.com/users/repeatedly/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/repeatedly/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/repeatedly/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/repeatedly"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/fluent/fluentd/issues/2298/comments",
  "created_at": "2019-02-17T18:20:57Z",
  "events_url": "https://api.github.com/repos/fluent/fluentd/issues/2298/events",
  "html_url": "https://github.com/fluent/fluentd/issues/2298",
  "id": 411217611,
  "labels": [],
  "labels_url": "https://api.github.com/repos/fluent/fluentd/issues/2298/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MTEyMTc2MTE=",
  "number": 2298,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/fluent/fluentd",
  "state": "closed",
  "title": "in_syslog with tcp doesn't check message length when read from buffer",
  "updated_at": "2019-04-09T08:45:16Z",
  "url": "https://api.github.com/repos/fluent/fluentd/issues/2298",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/8980280?v=4",
    "events_url": "https://api.github.com/users/alexnguyen91/events{/privacy}",
    "followers_url": "https://api.github.com/users/alexnguyen91/followers",
    "following_url": "https://api.github.com/users/alexnguyen91/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexnguyen91/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alexnguyen91",
    "id": 8980280,
    "login": "alexnguyen91",
    "node_id": "MDQ6VXNlcjg5ODAyODA=",
    "organizations_url": "https://api.github.com/users/alexnguyen91/orgs",
    "received_events_url": "https://api.github.com/users/alexnguyen91/received_events",
    "repos_url": "https://api.github.com/users/alexnguyen91/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alexnguyen91/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexnguyen91/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alexnguyen91"
  }
}