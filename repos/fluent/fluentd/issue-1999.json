{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "From time to time fluentd randomly crashes with a \"undefined method `+' for nil:NilClass\" for us.\r\n\r\nWe use\r\n\r\n```\r\nfluentd 1.2.0\r\nruby 2.3.3p222 (2016-11-21) [x86_64-linux-gnu]\r\nsplunk plugin https://github.com/brycied00d/fluent-plugin-splunk-http-eventcollector/commit/d8691830a5592db473bd870fc5b8b0d13fbf3dbc (latest master)\r\n```\r\n\r\nwith the following config\r\n```\r\n<match splunk_event.**>\r\n  @id out_splunk\r\n  @type splunk-http-eventcollector\r\n  server \"#{ENV[\"SPLUNK_HOST\"]}\"\r\n  token \"#{ENV[\"SPLUNK_TOKEN\"]}\"\r\n  index \"#{ENV[\"SPLUNK_ENVIRONMENT\"]}\"\r\n  source ${tag_parts[1]}\r\n  sourcetype ${tag_parts[2]}\r\n  all_items true\r\n  batch_size_limit 26214400 # Write up 25mb batches\r\n  <buffer>\r\n    @type file\r\n    path /var/log/fluentd-buffers/forward.buffer\r\n    flush_interval 1s\r\n    flush_thread_count 8\r\n    overflow_action block\r\n    chunk_limit_size 20mb\r\n  </buffer>\r\n</match>\r\n```\r\n\r\nand the full logs are:\r\n\r\n```\r\n2018-05-21 02:55:50 +0000 [error]: [out_splunk] error on output thread error_class=NoMethodError error=\"undefined method `+' for nil:NilClass\"\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/buffer.rb:478:in `block in takeback_chunk'\r\n  2018-05-21 02:55:50 +0000 [error]: /usr/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/buffer.rb:473:in `takeback_chunk'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/output.rb:1144:in `rescue in try_flush'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/output.rb:1079:in `try_flush'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/output.rb:1378:in `flush_thread_run'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/output.rb:440:in `block (2 levels) in start'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin_helper/thread.rb:78:in `block in thread_create'\r\n2018-05-21 02:55:50 +0000 [warn]: [out_splunk] thread exited by unexpected error plugin=Fluent::SplunkHTTPEventcollectorOutput title=:flush_thread_5 error_class=NoMethodError error=\"undefined method `+' for nil:NilClass\"\r\n2018-05-21 02:55:50 +0000 [error]: unexpected error error_class=NoMethodError error=\"undefined method `+' for nil:NilClass\"\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/buffer.rb:478:in `block in takeback_chunk'\r\n  2018-05-21 02:55:50 +0000 [error]: /usr/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/buffer.rb:473:in `takeback_chunk'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/output.rb:1144:in `rescue in try_flush'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/output.rb:1079:in `try_flush'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/output.rb:1378:in `flush_thread_run'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin/output.rb:440:in `block (2 levels) in start'\r\n  2018-05-21 02:55:50 +0000 [error]: /opt/fluentd/vendor/bundle/ruby/2.3.0/gems/fluentd-1.2.0/lib/fluent/plugin_helper/thread.rb:78:in `block in thread_create'\r\n2018-05-21 02:55:50 +0000 [error]: unexpected error error_class=NoMethodError error=\"undefined method `+' for nil:NilClass\"\r\n```\r\n\r\nThe issue looks similar to https://github.com/fluent/fluentd/issues/1187, but the splunk plugin is still using the 0.12 interface if I'm not mistaken.\r\n\r\nHappy to provide any additional information, but I'm not really sure how to debug this further.",
  "closed_at": "2018-06-12T22:00:59Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/16928?v=4",
    "events_url": "https://api.github.com/users/repeatedly/events{/privacy}",
    "followers_url": "https://api.github.com/users/repeatedly/followers",
    "following_url": "https://api.github.com/users/repeatedly/following{/other_user}",
    "gists_url": "https://api.github.com/users/repeatedly/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/repeatedly",
    "id": 16928,
    "login": "repeatedly",
    "node_id": "MDQ6VXNlcjE2OTI4",
    "organizations_url": "https://api.github.com/users/repeatedly/orgs",
    "received_events_url": "https://api.github.com/users/repeatedly/received_events",
    "repos_url": "https://api.github.com/users/repeatedly/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/repeatedly/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/repeatedly/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/repeatedly"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/fluent/fluentd/issues/1999/comments",
  "created_at": "2018-05-21T16:17:34Z",
  "events_url": "https://api.github.com/repos/fluent/fluentd/issues/1999/events",
  "html_url": "https://github.com/fluent/fluentd/issues/1999",
  "id": 324975356,
  "labels": [],
  "labels_url": "https://api.github.com/repos/fluent/fluentd/issues/1999/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMjQ5NzUzNTY=",
  "number": 1999,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/fluent/fluentd",
  "state": "closed",
  "title": "Buffer: undefined method `+' for nil:NilClass",
  "updated_at": "2018-06-12T22:00:59Z",
  "url": "https://api.github.com/repos/fluent/fluentd/issues/1999",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/864578?v=4",
    "events_url": "https://api.github.com/users/johanneswuerbach/events{/privacy}",
    "followers_url": "https://api.github.com/users/johanneswuerbach/followers",
    "following_url": "https://api.github.com/users/johanneswuerbach/following{/other_user}",
    "gists_url": "https://api.github.com/users/johanneswuerbach/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/johanneswuerbach",
    "id": 864578,
    "login": "johanneswuerbach",
    "node_id": "MDQ6VXNlcjg2NDU3OA==",
    "organizations_url": "https://api.github.com/users/johanneswuerbach/orgs",
    "received_events_url": "https://api.github.com/users/johanneswuerbach/received_events",
    "repos_url": "https://api.github.com/users/johanneswuerbach/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/johanneswuerbach/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/johanneswuerbach/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/johanneswuerbach"
  }
}