{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "Check [CONTRIBUTING guideline](https://github.com/fluent/fluentd/blob/master/CONTRIBUTING.md) first and here is the list to help us investigate the problem.\r\n\r\n**Describe the bug**\r\n\r\nFluentd 1.10.0 cannot launch when ruby command is placed in a directory which contains spaces.\r\n\r\n-e.g.) `C:\\Program Files (x86)\\td-agent\\bin\\ruby`\r\n\r\n**To Reproduce**\r\n\r\n* Download a MSI installer which is built by [td-agent-builder](https://github.com/clear-code/td-agent-builder/)\r\n  * https://github.com/clear-code/td-agent-builder/actions/runs/63706658\r\n* Run td-agent-3.6.0-x64.msi in the zip package\r\n* Install it into `C:\\Program Files (x86)` or `C:\\foo bar` or something which contains one or more spaces.\r\n* Run `td-agent` from Td-agent Command Prompt\r\n\r\n**Expected behavior**\r\n\r\nFluentd can launch from a directory which constains spaces.\r\n\r\n**Your Environment**\r\n\r\n- fluentd 1.10.0\r\n- Windows 10\r\n\r\n**Your Configuration**\r\n\r\n* https://github.com/clear-code/td-agent-builder/blob/master/td-agent/templates/etc/td-agent/td-agent.conf\r\n  * Same with https://github.com/treasure-data/omnibus-td-agent/blob/master/templates/etc/td-agent/td-agent.conf\r\n\r\n**Your Error Log**\r\n\r\n```\r\n2020-03-26 23:13:19 +0900 [info]: parsing config file is succeeded path=\"C:\\\\Program Files (x86)\\\\td-agent\\\\bin\\\\\\\\..\\\\etc\\\\td-agent\\\\td-agent.conf\"\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-elasticsearch' version '4.0.3'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-kafka' version '0.12.3'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-parser-winevt_xml' version '0.2.1'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-prometheus' version '1.7.3'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-prometheus_pushgateway' version '0.0.1'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-record-modifier' version '2.1.0'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-rewrite-tag-filter' version '2.2.0'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-s3' version '1.3.0'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-td' version '1.1.0'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-td-monitoring' version '0.2.4'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-webhdfs' version '1.2.4'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluent-plugin-windows-eventlog' version '0.5.0'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluentd' version '1.10.0'\r\n2020-03-26 23:13:19 +0900 [info]: gem 'fluentd' version '1.9.2'\r\n2020-03-26 23:13:20 +0900 [warn]: [output_td] Use different plugin for secondary. Check the plugin works with primary like secondary_file primary=\"Fluent::Plugin::TreasureDataLogOutput\" secondary=\"Fluent::Plugin::FileOutput\"\r\n2020-03-26 23:13:20 +0900 [info]: using configuration file: <ROOT>\r\n  <match td.*.*>\r\n    @type tdlog\r\n    @id output_td\r\n    apikey xxxxxx\r\n    auto_create_table\r\n    <buffer>\r\n      @type \"file\"\r\n      path \"/var/log/td-agent/buffer/td\"\r\n    </buffer>\r\n    <secondary>\r\n      @type \"file\"\r\n      path \"/var/log/td-agent/failed_records\"\r\n      <buffer time>\r\n        path /var/log/td-agent/failed_records\r\n      </buffer>\r\n    </secondary>\r\n  </match>\r\n  <match debug.**>\r\n    @type stdout\r\n    @id output_stdout\r\n  </match>\r\n  <source>\r\n    @type forward\r\n    @id input_forward\r\n  </source>\r\n  <source>\r\n    @type http\r\n    @id input_http\r\n    port 8888\r\n  </source>\r\n  <source>\r\n    @type debug_agent\r\n    @id input_debug_agent\r\n    bind \"127.0.0.1\"\r\n    port 24230\r\n  </source>\r\n</ROOT>\r\n2020-03-26 23:13:20 +0900 [info]: starting fluentd-1.10.0 pid=16228 ruby=\"2.4.9\"\r\nC:/Program Files (x86)/td-agent/lib/ruby/2.4.0/open3.rb:199:in `spawn': No such file or directory - C:/Program Files (x86)/td-agent/bin/ruby.exe -Eascii-8bit:ascii-8bit -h (Errno::ENOENT)\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/2.4.0/open3.rb:199:in `popen_run'\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/2.4.0/open3.rb:95:in `popen3'\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/2.4.0/open3.rb:258:in `capture3'\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/gems/2.4.0/gems/fluentd-1.10.0-x64-mingw32/lib/fluent/supervisor.rb:901:in `build_spawn_command'\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/gems/2.4.0/gems/fluentd-1.10.0-x64-mingw32/lib/fluent/supervisor.rb:672:in `supervise'\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/gems/2.4.0/gems/fluentd-1.10.0-x64-mingw32/lib/fluent/supervisor.rb:558:in `run_supervisor'\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/gems/2.4.0/gems/fluentd-1.10.0-x64-mingw32/lib/fluent/command/fluentd.rb:330:in `<top (required)>'\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/2.4.0/rubygems/core_ext/kernel_require.rb:55:in `require'\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/2.4.0/rubygems/core_ext/kernel_require.rb:55:in `require'\r\n        from C:/Program Files (x86)/td-agent/lib/ruby/gems/2.4.0/gems/fluentd-1.10.0-x64-mingw32/bin/fluentd:8:in `<top (required)>'\r\n        from C:/Program Files (x86)/td-agent/bin/fluentd:23:in `load'\r\n        from C:/Program Files (x86)/td-agent/bin/fluentd:23:in `<main>'\r\n```\r\n\r\n**Additional context**\r\n\r\nI'm now developing a new build system for td-agent. In this work I've allowed to install td-agent into any folder by this commit :https://github.com/clear-code/td-agent-builder/commit/c3dfc08f380750c9460059ab3a056b36e861f879\r\nWhen I tested installing it into `C:\\Program Files\\` or somewhere which contains spaces, I got this error.\r\n\r\nFollowing quick hack fixes the issue for me:\r\n\r\n```diff\r\ndiff --git a/lib/fluent/supervisor.rb b/lib/fluent/supervisor.rb\r\nindex b02b5f62..0bbbea9b 100644\r\n--- a/lib/fluent/supervisor.rb\r\n+++ b/lib/fluent/supervisor.rb\r\n@@ -897,7 +897,7 @@ module Fluent\r\n\r\n       # Adding `-h` so that it can avoid ruby's command blocking\r\n       # e.g. `ruby -Eascii-8bit:ascii-8bit` will block. but `ruby -Eascii-8bit:ascii-8bit -h` won't.\r\n-      cmd = fluentd_spawn_cmd.join(' ')\r\n+      cmd = fluentd_spawn_cmd.collect{ |arg| \"\\\"#{arg}\\\"\" }.join(' ')\r\n       _, e, s = Open3.capture3(\"#{cmd} -h\")\r\n       if s.exitstatus != 0\r\n         $log.error('Invalid option is passed to RUBYOPT', command: cmd, error: e)\r\n```\r\n",
  "closed_at": "2020-04-10T02:46:01Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/16928?v=4",
    "events_url": "https://api.github.com/users/repeatedly/events{/privacy}",
    "followers_url": "https://api.github.com/users/repeatedly/followers",
    "following_url": "https://api.github.com/users/repeatedly/following{/other_user}",
    "gists_url": "https://api.github.com/users/repeatedly/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/repeatedly",
    "id": 16928,
    "login": "repeatedly",
    "node_id": "MDQ6VXNlcjE2OTI4",
    "organizations_url": "https://api.github.com/users/repeatedly/orgs",
    "received_events_url": "https://api.github.com/users/repeatedly/received_events",
    "repos_url": "https://api.github.com/users/repeatedly/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/repeatedly/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/repeatedly/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/repeatedly"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/fluent/fluentd/issues/2915/comments",
  "created_at": "2020-03-27T01:02:31Z",
  "events_url": "https://api.github.com/repos/fluent/fluentd/issues/2915/events",
  "html_url": "https://github.com/fluent/fluentd/issues/2915",
  "id": 588816897,
  "labels": [],
  "labels_url": "https://api.github.com/repos/fluent/fluentd/issues/2915/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1ODg4MTY4OTc=",
  "number": 2915,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/fluent/fluentd",
  "state": "closed",
  "title": "Fluentd 1.10.0 cannot launch when ruby command is placed in a directory which constains spaces",
  "updated_at": "2020-04-10T02:46:01Z",
  "url": "https://api.github.com/repos/fluent/fluentd/issues/2915",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/135104?v=4",
    "events_url": "https://api.github.com/users/ashie/events{/privacy}",
    "followers_url": "https://api.github.com/users/ashie/followers",
    "following_url": "https://api.github.com/users/ashie/following{/other_user}",
    "gists_url": "https://api.github.com/users/ashie/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ashie",
    "id": 135104,
    "login": "ashie",
    "node_id": "MDQ6VXNlcjEzNTEwNA==",
    "organizations_url": "https://api.github.com/users/ashie/orgs",
    "received_events_url": "https://api.github.com/users/ashie/received_events",
    "repos_url": "https://api.github.com/users/ashie/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ashie/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ashie/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ashie"
  }
}