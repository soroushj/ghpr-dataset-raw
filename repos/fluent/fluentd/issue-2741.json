{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Describe the bug**\r\nWe run multiple apps in Docker and use td-agent to collect logs.\r\nSometimes an app produces log which blocks buffer flushing and no logs are flushed until td-agent is restarted.\r\n\r\n**To Reproduce**\r\nNot sure - an app sends some weird log message.\r\n\r\n**Expected behavior**\r\nIt's ok if the message cannot be flushed. The best would be to skip it and continue flushing the buffer.\r\n\r\n**Your Environment**\r\n`td-agent 1.7.4`\r\n\r\n```\r\nNAME=\"CentOS Linux\"\r\nVERSION=\"7 (Core)\"\r\nID=\"centos\"\r\nID_LIKE=\"rhel fedora\"\r\nVERSION_ID=\"7\"\r\nPRETTY_NAME=\"CentOS Linux 7 (Core)\"\r\nANSI_COLOR=\"0;31\"\r\nCPE_NAME=\"cpe:/o:centos:centos:7\"\r\nHOME_URL=\"https://www.centos.org/\"\r\nBUG_REPORT_URL=\"https://bugs.centos.org/\"\r\n\r\nCENTOS_MANTISBT_PROJECT=\"CentOS-7\"\r\nCENTOS_MANTISBT_PROJECT_VERSION=\"7\"\r\nREDHAT_SUPPORT_PRODUCT=\"centos\"\r\nREDHAT_SUPPORT_PRODUCT_VERSION=\"7\"\r\n```\r\n\r\nKernel `3.10.0-1062.4.3.el7.x86_64`\r\n\r\n**Your Configuration**\r\n\r\n```\r\n<source>\r\n  @type forward\r\n  port 24224\r\n  bind 127.0.0.1\r\n\r\n  @label @docker\r\n</source>\r\n\r\n<label @docker>\r\n  <filter docker.a docker.b>\r\n    @type grep\r\n    <exclude>\r\n      key log\r\n      pattern /./\r\n    </exclude>\r\n  </filter>\r\n\r\n  <filter docker.*>\r\n    @type throttle\r\n    group_key app_id\r\n    group_bucket_period_s   60\r\n    group_bucket_limit    6000\r\n    group_reset_rate_s     -1\r\n    group_warning_delay_s 60\r\n  </filter>\r\n  \r\n  <filter docker.*>\r\n    @type record_transformer\r\n    remove_keys app_id,container_name\r\n  </filter>\r\n  \r\n  <match docker.*>\r\n    @type mongo_replset\r\n    remove_tag_prefix docker.\r\n    num_retries 500\r\n    \r\n    nodes a,b\r\n    replica_set rs0\r\n    \r\n    user logs\r\n    password xxx\r\n    \r\n    database logs\r\n    collection ${tag}\r\n    capped\r\n    capped_size 2m\r\n\r\n    <buffer tag>\r\n      chunk_limit_size 2MB\r\n      total_limit_size 1GB\r\n      flush_mode interval\r\n      flush_interval 2s\r\n      retry_max_interval 60s\r\n      overflow_action drop_oldest_chunk\r\n    </buffer>\r\n  </match>\r\n  <match **>\r\n    @type mongo_replset\r\n    remove_tag_prefix docker.\r\n    num_retries 500\r\n    \r\n    nodes a,b\r\n    replica_set rs0\r\n    \r\n    user logs\r\n    password xxx\r\n    \r\n    database logs\r\n    collection ${tag}\r\n    capped\r\n    capped_size 2m\r\n\r\n    <buffer tag>\r\n      chunk_limit_size 2MB\r\n      total_limit_size 1GB\r\n      flush_mode interval\r\n      flush_interval 2s\r\n      retry_max_interval 60s\r\n      overflow_action drop_oldest_chunk\r\n    </buffer>\r\n  </match>\r\n</label>\r\n```\r\n\r\n**Your Error Log**\r\n\r\nThe error message is the following (log is redacted due to length)\r\n\r\n```\r\n[warn]: #0 failed to flush the buffer. retry_time=1099 next_retry_seconds=2019-12-17 19:00:32 +0100 chunk=\"599dad3237f37154fa06d035975603c8\" error_class=EncodingError error=\"log message starts here.....and ends \\xE7\\x8A is not valid UTF-8: truncated multi-byte sequence\"\r\n```\r\nThere's plenty of escaped chars in the middle as well.\r\n\r\n**Additional context**\r\n\r\nI'm willing to provide more information required for debugging.\r\n",
  "closed_at": "2020-01-31T03:51:37Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/16928?v=4",
    "events_url": "https://api.github.com/users/repeatedly/events{/privacy}",
    "followers_url": "https://api.github.com/users/repeatedly/followers",
    "following_url": "https://api.github.com/users/repeatedly/following{/other_user}",
    "gists_url": "https://api.github.com/users/repeatedly/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/repeatedly",
    "id": 16928,
    "login": "repeatedly",
    "node_id": "MDQ6VXNlcjE2OTI4",
    "organizations_url": "https://api.github.com/users/repeatedly/orgs",
    "received_events_url": "https://api.github.com/users/repeatedly/received_events",
    "repos_url": "https://api.github.com/users/repeatedly/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/repeatedly/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/repeatedly/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/repeatedly"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/fluent/fluentd/issues/2741/comments",
  "created_at": "2019-12-17T19:17:21Z",
  "events_url": "https://api.github.com/repos/fluent/fluentd/issues/2741/events",
  "html_url": "https://github.com/fluent/fluentd/issues/2741",
  "id": 539259894,
  "labels": [],
  "labels_url": "https://api.github.com/repos/fluent/fluentd/issues/2741/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MzkyNTk4OTQ=",
  "number": 2741,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/fluent/fluentd",
  "state": "closed",
  "title": "Buffer flushing blocked by EncodingError - not valid UTF-8",
  "updated_at": "2020-01-31T03:51:37Z",
  "url": "https://api.github.com/repos/fluent/fluentd/issues/2741",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/8225242?v=4",
    "events_url": "https://api.github.com/users/ceecko/events{/privacy}",
    "followers_url": "https://api.github.com/users/ceecko/followers",
    "following_url": "https://api.github.com/users/ceecko/following{/other_user}",
    "gists_url": "https://api.github.com/users/ceecko/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ceecko",
    "id": 8225242,
    "login": "ceecko",
    "node_id": "MDQ6VXNlcjgyMjUyNDI=",
    "organizations_url": "https://api.github.com/users/ceecko/orgs",
    "received_events_url": "https://api.github.com/users/ceecko/received_events",
    "repos_url": "https://api.github.com/users/ceecko/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ceecko/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ceecko/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ceecko"
  }
}