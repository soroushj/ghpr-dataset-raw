{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "### Expected Behavior\r\n\r\nFluentd syslog collector can collect RFC 5424 formatted syslog messages from both the Rsyslog Windows Agent, and Rsyslog Linux Agent, with or without fractional seconds, per RFC 5424, RFC 3339, and ISO 8601.\r\n\r\n### Actual Behavior\r\n\r\nRsyslog Linux Agent timestamp (with microseconds) is accepted, but the Rsyslog Windows Agent timestamp (without microseconds) causes errors.\r\n\r\n### Error Log\r\n\r\n```\r\n2018-02-17 23:20:23 +0000 [error]: #0 invalid input data=\"<134>1 2018-02-17T15:20:23-07:00 vagrant-2008R2 EvntSLog - - - Provider \\\"FileSystem\\\" is Started. Details: ProviderName=FileSystem NewProviderState=Started SequenceNumber=4 HostName=ConsoleHost HostVersion=2.0 HostId=06dbbd91-401c-47e7-b5d5-39658de1ae24 EngineVersion= RunspaceId= PipelineId= CommandName= CommandType= ScriptName= CommandPath= CommandLine=\" error_class=Fluent::TimeParser::TimeParseError error=\"invalid time format: value = 1 2018-02-17T15:20:23-07:00 vagrant-2008R2, error_class = ArgumentError, error = string doesn't match\"\r\n```\r\n\r\n### Environment\r\n\r\n- RHEL 7.2, fluentd syslog collector, td-agent 1.0.2\r\n- RHEL 7.2, rsyslog forwarder 8.24.0\r\n- Windows 2008 R2 SP1, rsyslog forwarder 4.3.0.255\r\n\r\n### Configuration\r\n\r\n**td-agent**\r\n```\r\n<source>\r\n  @type syslog\r\n  port 5140\r\n  bind 0.0.0.0\r\n  protocol_type tcp\r\n  tag  rsyslog\r\n  <parse>\r\n    message_format rfc5424\r\n  </parse>\r\n</source>\r\n```\r\n\r\n**Rsyslog Linux Agent**\r\n```\r\n*.* @@127.0.0.1:5141;RSYSLOG_SyslogProtocol23Format\r\n```\r\n\r\n**Rsyslog Windows Agent**\r\n```\r\n$szCustomSyslogHeader <%syslogprifac%>%syslogver% %timereported:::date-rfc3339% %source% %syslogappname% %syslogprocid% %syslogmsgid% %syslogstructdata% \r\n```\r\n\r\n### Details\r\n\r\nThe Rsyslog Windows Agent, when configured to send RFC 5424, does not include fractional seconds / microseconds in the timestamp. I found a fluentd git commit which defines the default filter, and only supports fractional seconds:\r\n\r\nhttps://github.com/cosmo0920/fluentd/blob/866b2caf0891b805fca54efff6c28e10cd617f35/lib/fluent/plugin/parser_syslog.rb#L36\r\n\r\nThe RFC 5424, RFC 3339, and ISO 8601 say that fractional seconds are optional. It also mentions that the \"T\" and \"Z\" separators may be upper or lower case. Here's some examples of valid timestamps:\r\n\r\n```\r\n### simple form\r\n2018-01-02T01:01:01Z\r\n2018-01-02T01:01:01-01:00\r\n2018-01-02T01:01:01+01:00\r\n\r\n### mixed case T, Z\r\n2018-01-02T01:01:01z\r\n2018-01-02t01:01:01Z\r\n2018-01-02t01:01:01z\r\n2018-01-02t01:01:01-01:00\r\n2018-01-02t01:01:01+01:00\r\n\r\n### fractional seconds\r\n2018-01-02T01:01:01.1Z\r\n2018-01-02T01:01:01.1-01:00\r\n2018-01-02T01:01:01.1+01:00\r\n\r\n2018-01-02T01:01:01.01Z\r\n2018-01-02T01:01:01.01-01:00\r\n2018-01-02T01:01:01.01+01:00\r\n\r\n2018-01-02T01:01:01.001Z\r\n2018-01-02T01:01:01.001-01:00\r\n2018-01-02T01:01:01.001+01:00\r\n\r\n2018-01-02T01:01:01.0001Z\r\n2018-01-02T01:01:01.0001-01:00\r\n2018-01-02T01:01:01.0001+01:00\r\n\r\n2018-01-02T01:01:01.00001Z\r\n2018-01-02T01:01:01.00001-01:00\r\n2018-01-02T01:01:01.00001+01:00\r\n\r\n2018-01-02T01:01:01.00001Z\r\n2018-01-02T01:01:01.00001-01:00\r\n2018-01-02T01:01:01.00001+01:00\r\n```\r\n\r\nI've created a temporary fix, by configuring fluentd / td-agent to not look for fractional seconds, and to make the Rsyslog Linux Agent not send fractional seconds. A better long-term solution would be for the fluentd in_syslog collector to support the wider range of timestamps. Thoughts?\r\n\r\n### Work-around\r\n\r\n**fluentd / td-agent config**\r\n```\r\n# https://docs.fluentd.org/articles/in_syslog\r\n<source>\r\n  @type syslog\r\n  port 5140\r\n  bind 0.0.0.0\r\n  protocol_type tcp\r\n  tag  rsyslog\r\n  <parse>\r\n    message_format rfc5424\r\n    # set this format to be compatible with Rsyslog Windows Agent\r\n    # https://docs.fluentd.org/v1.0/articles/parser_syslog#time_format\r\n    time_format \"%Y-%m-%dT%H:%M:%S%z\"\r\n  </parse>\r\n</source>\r\n```\r\n\r\n**Rsyslog Linux 8.24.0 Agent config**\r\n```\r\n# rsyslog linux agent remove timestamp microseconds / fractional seconds\r\n$template TimeStampFix,\"<%pri%>1 %timestamp:::date-year%-%timestamp:::date-month%-%timestamp:::date-day%T%timestamp:::date-hour%:%timestamp:::date-minute%:%timestamp:::date-second%%timestamp:::date-tzoffsdirection%%timestamp:::date-tzoffshour%:%timestamp:::date-tzoffsmin% %hostname% %app-name% %procid% %msgid% %structured-data% %msg%\\n\"\r\n\r\n*.* @@127.0.0.1:5140;TimeStampFix\r\n```\r\n\r\n**Rsyslog Linux 5.8.10 Agent config**\r\n```\r\n# fix to include PID for local logger\r\n$SystemLogUsePIDFromSystem on\r\n\r\n# rsyslog linux agent remove timestamp microseconds / fractional seconds\r\n$template TimeStampFix,\"<%pri%>1 %timegenerated:1:10:date-rfc3339%T%timegenerated:12:19:date-rfc3339%+00:00 %hostname% %app-name% %procid% %msgid% %structured-data% %msg%\\n\"\r\n\r\n*.* @@127.0.0.1:5140;TimeStampFix\r\n```\r\n",
  "closed_at": "2018-12-21T03:53:16Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/16928?v=4",
    "events_url": "https://api.github.com/users/repeatedly/events{/privacy}",
    "followers_url": "https://api.github.com/users/repeatedly/followers",
    "following_url": "https://api.github.com/users/repeatedly/following{/other_user}",
    "gists_url": "https://api.github.com/users/repeatedly/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/repeatedly",
    "id": 16928,
    "login": "repeatedly",
    "node_id": "MDQ6VXNlcjE2OTI4",
    "organizations_url": "https://api.github.com/users/repeatedly/orgs",
    "received_events_url": "https://api.github.com/users/repeatedly/received_events",
    "repos_url": "https://api.github.com/users/repeatedly/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/repeatedly/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/repeatedly/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/repeatedly"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/fluent/fluentd/issues/1862/comments",
  "created_at": "2018-02-19T18:05:51Z",
  "events_url": "https://api.github.com/repos/fluent/fluentd/issues/1862/events",
  "html_url": "https://github.com/fluent/fluentd/issues/1862",
  "id": 298362113,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 92597736,
      "name": "feature request",
      "node_id": "MDU6TGFiZWw5MjU5NzczNg==",
      "url": "https://api.github.com/repos/fluent/fluentd/labels/feature%20request"
    },
    {
      "color": "fbca04",
      "default": false,
      "description": null,
      "id": 109954234,
      "name": "v1",
      "node_id": "MDU6TGFiZWwxMDk5NTQyMzQ=",
      "url": "https://api.github.com/repos/fluent/fluentd/labels/v1"
    }
  ],
  "labels_url": "https://api.github.com/repos/fluent/fluentd/issues/1862/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyOTgzNjIxMTM=",
  "number": 1862,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/fluent/fluentd",
  "state": "closed",
  "title": "Robust RFC 5424, RFC 3339, ISO 8601, timestamp formatting",
  "updated_at": "2018-12-21T03:53:16Z",
  "url": "https://api.github.com/repos/fluent/fluentd/issues/1862",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/625310?v=4",
    "events_url": "https://api.github.com/users/apolloclark/events{/privacy}",
    "followers_url": "https://api.github.com/users/apolloclark/followers",
    "following_url": "https://api.github.com/users/apolloclark/following{/other_user}",
    "gists_url": "https://api.github.com/users/apolloclark/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/apolloclark",
    "id": 625310,
    "login": "apolloclark",
    "node_id": "MDQ6VXNlcjYyNTMxMA==",
    "organizations_url": "https://api.github.com/users/apolloclark/orgs",
    "received_events_url": "https://api.github.com/users/apolloclark/received_events",
    "repos_url": "https://api.github.com/users/apolloclark/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/apolloclark/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/apolloclark/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/apolloclark"
  }
}