{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "Check [CONTRIBUTING guideline](https://github.com/fluent/fluentd/blob/master/CONTRIBUTING.md) first and here is the list to help us investigate the problem.\r\n\r\n**Describe the bug**\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\nI received a log message like below\r\n```\r\n2020-07-14 01:24:15 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted\r\n event stream: 574180bytes\r\n```\r\nBut I set to  chunk_limit_size is 8M and chunk_full_threshold is 0.8.\r\n8M*0.8 = 6.4M\r\nchunk has free space more than 1.6M but log message say 574K. \r\n\r\nI checked the chunk and realized that there are many records.\r\n\r\nThe message received was a bit unfriendly.\r\n\r\n**To Reproduce**\r\n<!-- Steps to reproduce the behavior: -->\r\n1. set large `chunk_limit_size`\r\n2. set small `chunk_limit_records`\r\n1. start fluentd\r\n1. push large number of minimum records\r\n1. show warn message\r\n\r\n\r\n**Expected behavior**\r\n<!-- A clear and concise description of what you expected to happen. -->\r\n```\r\n2020-07-14 01:24:15 +0000 [warn]: #0 [rawlog2elasticsearch] chunk size limit exceeds for an emitted\r\n event stream: 1400records\r\n```\r\n**Your Environment**\r\n\r\n- Fluentd or td-agent version: `fluentd --version` or `td-agent --version`\r\n```\r\n$ td-agent --version\r\ntd-agent 1.11.1\r\n```\r\n- Operating system: `cat /etc/os-release`\r\n```\r\n$ cat /etc/os-release\r\nNAME=\"Amazon Linux\"\r\nVERSION=\"2\"\r\nID=\"amzn\"\r\nID_LIKE=\"centos rhel fedora\"\r\nVERSION_ID=\"2\"\r\nPRETTY_NAME=\"Amazon Linux 2\"\r\nANSI_COLOR=\"0;33\"\r\nCPE_NAME=\"cpe:2.3:o:amazon:amazon_linux:2\"\r\nHOME_URL=\"https://amazonlinux.com/\"\r\n```\r\n- Kernel version: `uname -r`\r\n```\r\n$ uname -r\r\n4.14.177-139.254.amzn2.x86_64\r\n```\r\n\r\n\r\nIf you hit the problem with older fluentd version, try latest version first.\r\n\r\n**Your Configuration**\r\n\r\n```\r\n  <source>\r\n    @type forward\r\n    @id input_forward\r\n    port 24224\r\n    bind \"0.0.0.0\"\r\n  </source>\r\n  <filter **.es>\r\n    @type prometheus\r\n    <metric>\r\n      name fluentd_input_status_num_records_total\r\n      type counter\r\n      desc The total number of incoming records\r\n      <labels>\r\n        tag ${tag}\r\n        hostname ${hostname}\r\n      </labels>\r\n    </metric>\r\n  </filter>\r\n  <match *.*.es>\r\n    @type elasticsearch\r\n    @id rawlog2elasticsearch\r\n    hosts \"xxxx\"\r\n    log_es_400_reason true\r\n    reconnect_on_error true\r\n    reload_on_failure true\r\n    reload_connections false\r\n    logstash_format true\r\n    logstash_prefix \"raw-${tag[1]}-${tag[0]}\"\r\n    <buffer tag>\r\n      @type \"file\"\r\n      path \"/data/buffers/raw\"\r\n      chunk_limit_size 8M\r\n      total_limit_size 1G\r\n      chunk_limit_records 1000\r\n      chunk_full_threshold 0.8\r\n      flush_mode interval\r\n      flush_interval 60s\r\n      flush_thread_count 1\r\n      retry_forever true\r\n      retry_type periodic\r\n      retry_wait 30\r\n    </buffer>\r\n  </match>\r\n\r\n```\r\n\r\n**Your Error Log**\r\n\r\n```\r\n2020-07-13 04:59:59 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 474709bytes\r\n2020-07-13 05:00:24 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 553495bytes\r\n2020-07-13 05:04:19 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 603165bytes\r\n2020-07-13 05:04:24 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 551115bytes\r\n2020-07-13 05:06:24 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 581636bytes\r\n2020-07-13 05:07:19 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 562004bytes\r\n2020-07-13 05:07:24 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 572290bytes\r\n2020-07-13 05:11:10 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 627635bytes\r\n2020-07-13 05:12:15 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 460620bytes\r\n2020-07-13 05:13:20 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 485934bytes\r\n2020-07-13 05:14:15 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 464083bytes\r\n2020-07-13 05:16:20 +0000 [warn]: #0 [rawlog2elasticsearch] chunk bytes limit exceeds for an emitted event stream: 466951bytes\r\n```\r\n\r\n**Additional context**\r\n\r\n<!-- Add any other context about the problem here. -->\r\n",
  "closed_at": "2020-07-22T04:57:00Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/16928?v=4",
    "events_url": "https://api.github.com/users/repeatedly/events{/privacy}",
    "followers_url": "https://api.github.com/users/repeatedly/followers",
    "following_url": "https://api.github.com/users/repeatedly/following{/other_user}",
    "gists_url": "https://api.github.com/users/repeatedly/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/repeatedly",
    "id": 16928,
    "login": "repeatedly",
    "node_id": "MDQ6VXNlcjE2OTI4",
    "organizations_url": "https://api.github.com/users/repeatedly/orgs",
    "received_events_url": "https://api.github.com/users/repeatedly/received_events",
    "repos_url": "https://api.github.com/users/repeatedly/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/repeatedly/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/repeatedly/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/repeatedly"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/fluent/fluentd/issues/3072/comments",
  "created_at": "2020-07-14T02:17:17Z",
  "events_url": "https://api.github.com/repos/fluent/fluentd/issues/3072/events",
  "html_url": "https://github.com/fluent/fluentd/issues/3072",
  "id": 656271566,
  "labels": [],
  "labels_url": "https://api.github.com/repos/fluent/fluentd/issues/3072/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2NTYyNzE1NjY=",
  "number": 3072,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/fluent/fluentd",
  "state": "closed",
  "title": "warn message should include right status",
  "updated_at": "2020-07-22T04:57:00Z",
  "url": "https://api.github.com/repos/fluent/fluentd/issues/3072",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/13479783?v=4",
    "events_url": "https://api.github.com/users/paihu/events{/privacy}",
    "followers_url": "https://api.github.com/users/paihu/followers",
    "following_url": "https://api.github.com/users/paihu/following{/other_user}",
    "gists_url": "https://api.github.com/users/paihu/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/paihu",
    "id": 13479783,
    "login": "paihu",
    "node_id": "MDQ6VXNlcjEzNDc5Nzgz",
    "organizations_url": "https://api.github.com/users/paihu/orgs",
    "received_events_url": "https://api.github.com/users/paihu/received_events",
    "repos_url": "https://api.github.com/users/paihu/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/paihu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paihu/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/paihu"
  }
}