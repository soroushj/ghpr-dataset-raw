{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/5616899?v=4",
    "events_url": "https://api.github.com/users/ganmacs/events{/privacy}",
    "followers_url": "https://api.github.com/users/ganmacs/followers",
    "following_url": "https://api.github.com/users/ganmacs/following{/other_user}",
    "gists_url": "https://api.github.com/users/ganmacs/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ganmacs",
    "id": 5616899,
    "login": "ganmacs",
    "node_id": "MDQ6VXNlcjU2MTY4OTk=",
    "organizations_url": "https://api.github.com/users/ganmacs/orgs",
    "received_events_url": "https://api.github.com/users/ganmacs/received_events",
    "repos_url": "https://api.github.com/users/ganmacs/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ganmacs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ganmacs/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ganmacs"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/5616899?v=4",
      "events_url": "https://api.github.com/users/ganmacs/events{/privacy}",
      "followers_url": "https://api.github.com/users/ganmacs/followers",
      "following_url": "https://api.github.com/users/ganmacs/following{/other_user}",
      "gists_url": "https://api.github.com/users/ganmacs/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/ganmacs",
      "id": 5616899,
      "login": "ganmacs",
      "node_id": "MDQ6VXNlcjU2MTY4OTk=",
      "organizations_url": "https://api.github.com/users/ganmacs/orgs",
      "received_events_url": "https://api.github.com/users/ganmacs/received_events",
      "repos_url": "https://api.github.com/users/ganmacs/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/ganmacs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ganmacs/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/ganmacs"
    }
  ],
  "author_association": "NONE",
  "body": "**Describe the bug**\r\nwhen using the in_tail position file compaction via `pos_file_compaction_interval`  the position files become corrupted\r\n\r\n**To Reproduce**\r\nReproduced on a kubernetes cluster running compaction every 24 seconds and several pods in crashloop backoff so there was stuff to compact.\r\n\r\n**Expected behavior**\r\nno corruption\r\n\r\n**Your Environment**\r\n\r\n    Fluentd or td-agent version: 1.9.2 td-agent 3.6.0\r\n    Kernel version: uname -r\r\n\r\n**Your Configuration**\r\nstandard in_tail configuration with `pos_file_compaction_interval 24`\r\n\r\n\r\n**Your Error Log**\r\nThe corrupted position file looks like this, note the `ffffffffffffffff` part with the missing space\r\n\r\n```\r\n/var/log/containers/container-1c15005e5e6978f4652c9bcce679f416654fb6d9e304a0d5d3b476b3c4bfd734.log\t0000000000031a96\t00000000008f589b\r\nffffffffffffffff448/var/log/containers/container-3f06aac20b6a5b1eadee53f4a891fcfbc3f9c365fcf649c6a457b063bbb73671.log\t0000000000016215\t00000000008f58ca\r\n/var/log/containers/container-319527df0aaf8a2c698c775340981126709f67e05e29566ab7689d72001a7b43.log\t00000000000330ed\t00000000008f5879\r\n```\r\n\r\nthere are actually lots of null bytes added in the problematic spot\r\n\r\n```\r\n\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00ffffffffffffffff448/var/log/containers/container-3f06aac20b6a5b1eadee53f4a891fcfbc3f9c365fcf649c6a457b063bbb73671.log\\t0000000000016215\\t00000000008f58ca\\n\r\n```\r\n\r\n\r\nThe problem is likely caused by a race condition in `try_compact` during the `fetch_compacted_entries` call\r\nhttps://github.com/fluent/fluentd/blob/master/lib/fluent/plugin/in_tail/position_file.rb#L90\r\n\r\nthat call is performed outside of the lock but it reads the file, this means it can read file currently being modified by another thread and the writes of the position file are not atomic on the filesystem level.\r\n\r\nthis could either to move the fetch into the mutex lock or make the position file writes atomic via `rename\u00b4",
  "closed_at": "2020-04-02T08:39:49Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/5616899?v=4",
    "events_url": "https://api.github.com/users/ganmacs/events{/privacy}",
    "followers_url": "https://api.github.com/users/ganmacs/followers",
    "following_url": "https://api.github.com/users/ganmacs/following{/other_user}",
    "gists_url": "https://api.github.com/users/ganmacs/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ganmacs",
    "id": 5616899,
    "login": "ganmacs",
    "node_id": "MDQ6VXNlcjU2MTY4OTk=",
    "organizations_url": "https://api.github.com/users/ganmacs/orgs",
    "received_events_url": "https://api.github.com/users/ganmacs/received_events",
    "repos_url": "https://api.github.com/users/ganmacs/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ganmacs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ganmacs/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ganmacs"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/fluent/fluentd/issues/2918/comments",
  "created_at": "2020-03-27T11:15:15Z",
  "events_url": "https://api.github.com/repos/fluent/fluentd/issues/2918/events",
  "html_url": "https://github.com/fluent/fluentd/issues/2918",
  "id": 589060812,
  "labels": [],
  "labels_url": "https://api.github.com/repos/fluent/fluentd/issues/2918/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1ODkwNjA4MTI=",
  "number": 2918,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/fluent/fluentd",
  "state": "closed",
  "title": "in_tail pos_file_compaction_interval corrupts position files",
  "updated_at": "2020-04-02T08:39:49Z",
  "url": "https://api.github.com/repos/fluent/fluentd/issues/2918",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/542663?v=4",
    "events_url": "https://api.github.com/users/juliantaylor/events{/privacy}",
    "followers_url": "https://api.github.com/users/juliantaylor/followers",
    "following_url": "https://api.github.com/users/juliantaylor/following{/other_user}",
    "gists_url": "https://api.github.com/users/juliantaylor/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/juliantaylor",
    "id": 542663,
    "login": "juliantaylor",
    "node_id": "MDQ6VXNlcjU0MjY2Mw==",
    "organizations_url": "https://api.github.com/users/juliantaylor/orgs",
    "received_events_url": "https://api.github.com/users/juliantaylor/received_events",
    "repos_url": "https://api.github.com/users/juliantaylor/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/juliantaylor/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/juliantaylor/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/juliantaylor"
  }
}