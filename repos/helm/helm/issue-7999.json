{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- If you need help or think you have found a bug, please help us with your issue by entering the following information (otherwise you can delete this text): -->\r\n\r\nOutput of `helm version`:\r\nversion.BuildInfo{Version:\"v3.1.2\", GitCommit:\"d878d4d45863e42fd5cff6743294a11d28a9abce\", GitTreeState:\"clean\", GoVersion:\"go1.13.8\"}\r\n\r\nOutput of `kubectl version`:\r\nClient Version: version.Info{Major:\"1\", Minor:\"18\", GitVersion:\"v1.18.2\", GitCommit:\"52c56ce7a8272c798dbc29846288d7cd9fbae032\", GitTreeState:\"clean\", BuildDate:\"2020-04-16T23:35:15Z\", GoVersion:\"go1.14.2\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"15\", GitVersion:\"v1.15.5\", GitCommit:\"20c265fef0741dd71a66480e35bd69f18351daea\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T19:07:57Z\", GoVersion:\"go1.12.10\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n\r\nCloud Provider/Platform (AKS, GKE, Minikube etc.): \r\n\r\n\r\n\r\n**Situation**\r\npart of deployment yaml\r\n```yaml\r\n      hostAliases:\r\n      - hostnames:\r\n        - cpc0101.mongodb\r\n        ip: 10.153.44.147\r\n      - hostnames:\r\n        - cpc0102.mongodb\r\n        ip: 10.153.52.224\r\n      - hostnames:\r\n        - cpc0103.mongodb\r\n        ip: 10.153.53.139\r\n      - hostnames:\r\n        - cpc0201.mongodb\r\n        ip: 10.153.52.63\r\n      - hostnames:\r\n        - cpc0202.mongodb\r\n        ip: 10.153.58.52\r\n      - hostnames:\r\n        - cpc0203.mongodb\r\n        ip: 10.153.60.75\r\n      - hostnames:\r\n        - cpc0301.mongodb\r\n        ip: 10.144.122.209\r\n      - hostnames:\r\n        - cpc0302.mongodb\r\n        ip: 10.144.125.225\r\n      - hostnames:\r\n        - cpc0303.mongodb\r\n        ip: 10.144.126.191\r\n      - hostnames:\r\n        - cpcrank0101.mongodb\r\n        ip: 10.153.52.61\r\n      - hostnames:\r\n        - cpcrank0102.mongodb\r\n        ip: 10.142.69.176\r\n      - hostnames:\r\n        - cpcrank0103.mongodb\r\n        ip: 10.153.52.62\r\n      - hostnames:\r\n        - cpcrank0201.mongodb\r\n        ip: 10.144.97.235\r\n      - hostnames:\r\n        - cpcrank0202.mongodb\r\n        ip: 10.142.32.128\r\n      - hostnames:\r\n        - cpcrank0203.mongodb\r\n        ip: 10.134.107.236\r\n      - hostnames:\r\n        - cpcrank0301.mongodb\r\n        ip: 10.144.126.213\r\n      - hostnames:\r\n        - cpcrank0302.mongodb\r\n        ip: 10.144.127.168\r\n      - hostnames:\r\n        - cpcrank0303.mongodb\r\n        ip: 10.152.99.208\r\n      - hostnames:\r\n        - dev.kafka.broker1\r\n        ip: 10.134.55.168\r\n      - hostnames:\r\n        - dev.kafka.broker2\r\n        ip: 10.134.73.192\r\n      - hostnames:\r\n        - dev.kafka.broker3\r\n        ip: 10.134.73.196\r\n      - hostnames:\r\n        - download.ceph.com\r\n        ip: 158.69.68.124\r\n      - hostnames:\r\n        - galaxywirelesslog01.mongodb\r\n        ip: 10.144.122.209\r\n      - hostnames:\r\n        - galaxywirelesslog02.mongodb\r\n        ip: 10.144.125.225\r\n      - hostnames:\r\n        - galaxywirelesslog03.mongodb\r\n        ip: 10.144.126.191\r\n      - hostnames:\r\n        - hourreport0101.mongodb\r\n        ip: 10.144.126.213\r\n      - hostnames:\r\n        - hourreport0102.mongodb\r\n        ip: 10.144.127.168\r\n      - hostnames:\r\n        - hourreport0103.mongodb\r\n        ip: 10.152.99.208\r\n      - hostnames:\r\n        - hourreport0201.mongodb\r\n        ip: 10.144.14.227\r\n      - hostnames:\r\n        - hourreport0202.mongodb\r\n        ip: 10.152.100.136\r\n      - hostnames:\r\n        - hourreport0203.mongodb\r\n        ip: 10.152.105.194\r\n      - hostnames:\r\n        - hourreport0301.mongodb\r\n        ip: 10.134.97.208\r\n      - hostnames:\r\n        - hourreport0302.mongodb\r\n        ip: 10.134.110.147\r\n      - hostnames:\r\n        - hourreport0303.mongodb\r\n        ip: 10.142.79.219\r\n      - hostnames:\r\n        - idea0101.mongodb\r\n        ip: 10.153.44.147\r\n      - hostnames:\r\n        - idea0102.mongodb\r\n        ip: 10.153.52.224\r\n      - hostnames:\r\n        - idea0103.mongodb\r\n        ip: 10.153.53.139\r\n      - hostnames:\r\n        - idea0201.mongodb\r\n        ip: 10.153.52.63\r\n      - hostnames:\r\n        - idea0202.mongodb\r\n        ip: 10.153.58.52\r\n      - hostnames:\r\n        - idea0203.mongodb\r\n        ip: 10.153.60.75\r\n      - hostnames:\r\n        - idea0301.mongodb\r\n        ip: 10.144.122.209\r\n      - hostnames:\r\n        - idea0302.mongodb\r\n        ip: 10.144.125.225\r\n      - hostnames:\r\n        - idea0303.mongodb\r\n        ip: 10.144.126.191\r\n      - hostnames:\r\n        - kafka.broker1\r\n        ip: 10.142.115.37\r\n      - hostnames:\r\n        - kafka.broker2\r\n        ip: 10.142.112.29\r\n      - hostnames:\r\n        - kafka.broker3\r\n        ip: 10.152.58.89\r\n      - hostnames:\r\n        - kuaitoureport01.mongodb\r\n        ip: 10.153.52.191\r\n      - hostnames:\r\n        - kuaitoureport02.mongodb\r\n        ip: 10.153.54.239\r\n      - hostnames:\r\n        - kuaitoureport03.mongodb\r\n        ip: 10.153.61.232\r\n      - hostnames:\r\n        - noclickcpc0101.mongodb\r\n        ip: 10.153.44.147\r\n      - hostnames:\r\n        - noclickcpc0102.mongodb\r\n        ip: 10.153.52.224\r\n      - hostnames:\r\n        - noclickcpc0103.mongodb\r\n        ip: 10.153.53.139\r\n      - hostnames:\r\n        - noclickcpc0201.mongodb\r\n        ip: 10.153.52.63\r\n      - hostnames:\r\n        - noclickcpc0202.mongodb\r\n        ip: 10.153.58.52\r\n      - hostnames:\r\n        - noclickcpc0203.mongodb\r\n        ip: 10.153.60.75\r\n      - hostnames:\r\n        - noclickcpc0301.mongodb\r\n        ip: 10.144.122.209\r\n      - hostnames:\r\n        - noclickcpc0302.mongodb\r\n        ip: 10.144.125.225\r\n      - hostnames:\r\n        - noclickcpc0303.mongodb\r\n        ip: 10.144.126.191\r\n      - hostnames:\r\n        - qa.bizlog0101.mongodb\r\n        ip: 10.134.97.208\r\n      - hostnames:\r\n        - qa.bizlog0102.mongodb\r\n        ip: 10.142.79.219\r\n      - hostnames:\r\n        - qa.bizlog0103.mongodb\r\n        ip: 10.134.110.147\r\n      - hostnames:\r\n        - qa.bizlog0201.mongodb\r\n        ip: 10.134.97.208\r\n      - hostnames:\r\n        - qa.bizlog0202.mongodb\r\n        ip: 10.142.79.219\r\n      - hostnames:\r\n        - qa.bizlog0203.mongodb\r\n        ip: 10.134.110.147\r\n      - hostnames:\r\n        - qa.bizlog0301.mongodb\r\n        ip: 10.144.14.227\r\n      - hostnames:\r\n        - qa.bizlog0302.mongodb\r\n        ip: 10.152.100.136\r\n      - hostnames:\r\n        - qa.bizlog0303.mongodb\r\n        ip: 10.152.105.194\r\n      - hostnames:\r\n        - qa.bizlog0401.mongodb\r\n        ip: 10.144.14.227\r\n      - hostnames:\r\n        - qa.bizlog0402.mongodb\r\n        ip: 10.152.100.136\r\n      - hostnames:\r\n        - qa.bizlog0403.mongodb\r\n        ip: 10.152.105.194\r\n      - hostnames:\r\n        - qa.bizlog0501.mongodb\r\n        ip: 10.144.14.227\r\n      - hostnames:\r\n        - qa.bizlog0502.mongodb\r\n        ip: 10.152.100.136\r\n      - hostnames:\r\n        - qa.bizlog0503.mongodb\r\n        ip: 10.152.105.194\r\n      - hostnames:\r\n        - qa.bizlog0601.mongodb\r\n        ip: 10.144.14.227\r\n      - hostnames:\r\n        - qa.bizlog0602.mongodb\r\n        ip: 10.152.100.136\r\n      - hostnames:\r\n        - qa.bizlog0603.mongodb\r\n        ip: 10.152.105.194\r\n      - hostnames:\r\n        - qa.iflow01.mongodb\r\n        ip: 10.134.109.215\r\n      - hostnames:\r\n        - qa.iflow02.mongodb\r\n        ip: 10.134.110.238\r\n      - hostnames:\r\n        - qa.iflow03.mongodb\r\n        ip: 10.134.115.189\r\n      - hostnames:\r\n        - qa.memcache1.dubhe\r\n        ip: 10.153.57.225\r\n      - hostnames:\r\n        - qa.memcache2.dubhe\r\n        ip: 10.153.57.229\r\n      - hostnames:\r\n        - qa.memcache3.dubhe\r\n        ip: 10.153.60.164\r\n      - hostnames:\r\n        - qa.scxbigquery.mysql\r\n        ip: 10.152.70.220\r\n      - hostnames:\r\n        - querykey0101.mongodb\r\n        ip: 10.153.52.61\r\n      - hostnames:\r\n        - querykey0102.mongodb\r\n        ip: 10.153.52.62\r\n      - hostnames:\r\n        - querykey0103.mongodb\r\n        ip: 10.153.52.63\r\n      - hostnames:\r\n        - querykey0201.mongodb\r\n        ip: 10.144.97.235\r\n      - hostnames:\r\n        - querykey0202.mongodb\r\n        ip: 10.142.32.128\r\n      - hostnames:\r\n        - querykey0203.mongodb\r\n        ip: 10.134.107.236\r\n      - hostnames:\r\n        - querykey0301.mongodb\r\n        ip: 10.144.126.213\r\n      - hostnames:\r\n        - querykey0302.mongodb\r\n        ip: 10.144.127.168\r\n      - hostnames:\r\n        - querykey0303.mongodb\r\n        ip: 10.152.99.208\r\n      - hostnames:\r\n        - regionreport0101.mongodb\r\n        ip: 10.144.126.213\r\n      - hostnames:\r\n        - regionreport0102.mongodb\r\n        ip: 10.144.127.168\r\n      - hostnames:\r\n        - regionreport0103.mongodb\r\n        ip: 10.152.99.208\r\n      - hostnames:\r\n        - regionreport0201.mongodb\r\n        ip: 10.144.14.227\r\n      - hostnames:\r\n        - regionreport0202.mongodb\r\n        ip: 10.152.100.136\r\n      - hostnames:\r\n        - regionreport0203.mongodb\r\n        ip: 10.152.105.194\r\n      - hostnames:\r\n        - regionreport0301.mongodb\r\n        ip: 10.134.97.208\r\n      - hostnames:\r\n        - regionreport0302.mongodb\r\n        ip: 10.134.110.147\r\n      - hostnames:\r\n        - regionreport0303.mongodb\r\n        ip: 10.142.79.219\r\n      - hostnames:\r\n        - xuridailyspend01.mongodb\r\n        ip: 10.144.103.130\r\n      - hostnames:\r\n        - xuridailyspend02.mongodb\r\n        ip: 10.144.99.237\r\n      - hostnames:\r\n        - xuridailyspend03.mongodb\r\n        ip: 10.144.119.212\r\n      - hostnames:\r\n        - xuriopt01.mongodb\r\n        ip: 10.148.35.161\r\n      - hostnames:\r\n        - xuriopt02.mongodb\r\n        ip: 10.148.38.193\r\n      - hostnames:\r\n        - xuriopt03.mongodb\r\n        ip: 10.148.33.147\r\n      - hostnames:\r\n        - xurispend01.mongodb\r\n        ip: 10.144.103.130\r\n      - hostnames:\r\n        - xurispend02.mongodb\r\n        ip: 10.144.99.237\r\n      - hostnames:\r\n        - xurispend03.mongodb\r\n        ip: 10.144.119.212\r\n```\r\n\r\nthere are duplicated ips in `hostAliases`, and use `helper.Replace(target.Namespace, target.Name, true, target.Object)` to deploy, everything goes well.\r\n\r\nwhen switching to helm, use `helm upgrade` with the default values, error is returned `failed to create patch: The order in patch list: ...`\r\n\r\n```\r\n~/.kube \u00bb helm history janus-fe --kubeconfig ./pre -n bizqa                                                                apple@liuming216448\r\nREVISION\tUPDATED                 \tSTATUS    \tCHART                  \tAPP VERSION\tDESCRIPTION\r\n1       \tTue Apr 21 21:31:22 2020\tsuperseded\tthanos-deployment-1.0.0\t1.16.0     \tInstall complete\r\n2       \tSun Apr 26 15:57:09 2020\tfailed    \tthanos-deployment-1.0.0\t1.16.0     \tUpgrade \"janus-fe\" failed: failed to create patch: The order in patch list:\r\n        \t                        \t          \t                       \t           \t[map[hostnames:[cpc0101.mongodb] ip:10.153.44.147] map[hostnames:[noclickcpc0101.mongodb] ip:10.153.44.147] map[hostnames:[idea0201.mongodb] ip:10.153.52.63] map[hostnames:[cpc0201.mongodb] ip:10.153.52.63] map[hostnames:[querykey0103.mongodb] ip:10.153.52.63] map[hostnames:[noclickcpc0201.mongodb] ip:10.153.52.63] map[hostnames:[noclickcpc0202.mongodb] ip:10.153.58.52] map[hostnames:[idea0202.mongodb] ip:10.153.58.52] map[hostnames:[noclickcpc0203.mongodb] ip:10.153.60.75] map[hostnames:[cpc0203.mongodb] ip:10.153.60.75] map[hostnames:[idea0203.mongodb] ip:10.153.60.75] map[hostnames:[cpc0301.mongodb] ip:10.144.122.209] map[hostnames:[idea0301.mongodb] ip:10.144.122.209] map[hostnames:[galaxywirelesslog02.mongodb] ip:10.144.125.225] map[hostnames:[cpc0302.mongodb] ip:10.144.125.225] map[hostnames:[galaxywirelesslog03.mongodb] ip:10.144.126.191] map[hostnames:[cpc0303.mongodb] ip:10.144.126.191] map[hostnames:[cpcrank0103.mongodb] ip:10.153.52.62] map[hostnames:[querykey0102.mongodb] ip:10.153.52.62] map[hostnames:[cpcrank0201.mongodb] ip:10.144.97.235] map[hostnames:[querykey0201.mongodb] ip:10.144.97.235] map[hostnames:[querykey0301.mongodb] ip:10.144.126.213] map[hostnames:[hourreport0101.mongodb] ip:10.144.126.213] map[hostnames:[regionreport0101.mongodb] ip:10.144.126.213] map[hostnames:[querykey0302.mongodb] ip:10.144.127.168] map[hostnames:[regionreport0102.mongodb] ip:10.144.127.168] map[hostnames:[querykey0303.mongodb] ip:10.152.99.208] map[hostnames:[regionreport0103.mongodb] ip:10.152.99.208] map[hostnames:[hourreport0103.mongodb] ip:10.152.99.208] map[hostnames:[cpcrank0303.mongodb] ip:10.152.99.208] map[hostnames:[qa.bizlog0401.mongodb] ip:10.144.14.227] map[hostnames:[regionreport0201.mongodb] ip:10.144.14.227] map[hostnames:[qa.bizlog0601.mongodb] ip:10.144.14.227] map[hostnames:[hourreport0201.mongodb] ip:10.144.14.227] map[hostnames:[regionreport0202.mongodb] ip:10.152.100.136] map[hostnames:[hourreport0202.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0302.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0602.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0402.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0502.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0303.mongodb] ip:10.152.105.194] map[hostnames:[regionreport0203.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0603.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0503.mongodb] ip:10.152.105.194] map[hostnames:[hourreport0203.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0403.mongodb] ip:10.152.105.194] map[hostnames:[regionreport0301.mongodb] ip:10.134.97.208] map[hostnames:[qa.bizlog0201.mongodb] ip:10.134.97.208] map[hostnames:[hourreport0301.mongodb] ip:10.134.97.208] map[hostnames:[qa.bizlog0203.mongodb] ip:10.134.110.147] map[hostnames:[regionreport0302.mongodb] ip:10.134.110.147] map[hostnames:[regionreport0303.mongodb] ip:10.142.79.219] map[hostnames:[qa.bizlog0102.mongodb] ip:10.142.79.219] map[hostnames:[hourreport0303.mongodb] ip:10.142.79.219] map[hostnames:[xurispend01.mongodb] ip:10.144.103.130] map[hostnames:[xuridailyspend01.mongodb] ip:10.144.103.130] map[hostnames:[xuridailyspend02.mon...\r\n3       \tSun Apr 26 15:58:39 2020\tfailed    \tthanos-deployment-1.0.0\t1.16.0     \tUpgrade \"janus-fe\" failed: failed to create patch: The order in patch list:\r\n        \t                        \t          \t                       \t           \t[map[hostnames:[cpc0101.mongodb] ip:10.153.44.147] map[hostnames:[noclickcpc0101.mongodb] ip:10.153.44.147] map[hostnames:[idea0201.mongodb] ip:10.153.52.63] map[hostnames:[cpc0201.mongodb] ip:10.153.52.63] map[hostnames:[querykey0103.mongodb] ip:10.153.52.63] map[hostnames:[noclickcpc0201.mongodb] ip:10.153.52.63] map[hostnames:[noclickcpc0202.mongodb] ip:10.153.58.52] map[hostnames:[idea0202.mongodb] ip:10.153.58.52] map[hostnames:[noclickcpc0203.mongodb] ip:10.153.60.75] map[hostnames:[cpc0203.mongodb] ip:10.153.60.75] map[hostnames:[idea0203.mongodb] ip:10.153.60.75] map[hostnames:[cpc0301.mongodb] ip:10.144.122.209] map[hostnames:[idea0301.mongodb] ip:10.144.122.209] map[hostnames:[galaxywirelesslog02.mongodb] ip:10.144.125.225] map[hostnames:[cpc0302.mongodb] ip:10.144.125.225] map[hostnames:[galaxywirelesslog03.mongodb] ip:10.144.126.191] map[hostnames:[cpc0303.mongodb] ip:10.144.126.191] map[hostnames:[cpcrank0103.mongodb] ip:10.153.52.62] map[hostnames:[querykey0102.mongodb] ip:10.153.52.62] map[hostnames:[cpcrank0201.mongodb] ip:10.144.97.235] map[hostnames:[querykey0201.mongodb] ip:10.144.97.235] map[hostnames:[querykey0301.mongodb] ip:10.144.126.213] map[hostnames:[hourreport0101.mongodb] ip:10.144.126.213] map[hostnames:[regionreport0101.mongodb] ip:10.144.126.213] map[hostnames:[querykey0302.mongodb] ip:10.144.127.168] map[hostnames:[regionreport0102.mongodb] ip:10.144.127.168] map[hostnames:[querykey0303.mongodb] ip:10.152.99.208] map[hostnames:[regionreport0103.mongodb] ip:10.152.99.208] map[hostnames:[hourreport0103.mongodb] ip:10.152.99.208] map[hostnames:[cpcrank0303.mongodb] ip:10.152.99.208] map[hostnames:[qa.bizlog0401.mongodb] ip:10.144.14.227] map[hostnames:[regionreport0201.mongodb] ip:10.144.14.227] map[hostnames:[qa.bizlog0601.mongodb] ip:10.144.14.227] map[hostnames:[hourreport0201.mongodb] ip:10.144.14.227] map[hostnames:[regionreport0202.mongodb] ip:10.152.100.136] map[hostnames:[hourreport0202.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0302.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0602.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0402.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0502.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0303.mongodb] ip:10.152.105.194] map[hostnames:[regionreport0203.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0603.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0503.mongodb] ip:10.152.105.194] map[hostnames:[hourreport0203.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0403.mongodb] ip:10.152.105.194] map[hostnames:[regionreport0301.mongodb] ip:10.134.97.208] map[hostnames:[qa.bizlog0201.mongodb] ip:10.134.97.208] map[hostnames:[hourreport0301.mongodb] ip:10.134.97.208] map[hostnames:[qa.bizlog0203.mongodb] ip:10.134.110.147] map[hostnames:[regionreport0302.mongodb] ip:10.134.110.147] map[hostnames:[regionreport0303.mongodb] ip:10.142.79.219] map[hostnames:[qa.bizlog0102.mongodb] ip:10.142.79.219] map[hostnames:[hourreport0303.mongodb] ip:10.142.79.219] map[hostnames:[xurispend01.mongodb] ip:10.144.103.130] map[hostnames:[xuridailyspend01.mongodb] ip:10.144.103.130] map[hostnames:[xuridailyspend02.mon...\r\n4       \tSun Apr 26 16:33:17 2020\tfailed    \tthanos-deployment-1.0.0\t1.16.0     \tUpgrade \"janus-fe\" failed: failed to create patch: The order in patch list:\r\n        \t                        \t          \t                       \t           \t[map[hostnames:[cpc0101.mongodb] ip:10.153.44.147] map[hostnames:[noclickcpc0101.mongodb] ip:10.153.44.147] map[hostnames:[idea0201.mongodb] ip:10.153.52.63] map[hostnames:[cpc0201.mongodb] ip:10.153.52.63] map[hostnames:[querykey0103.mongodb] ip:10.153.52.63] map[hostnames:[noclickcpc0201.mongodb] ip:10.153.52.63] map[hostnames:[noclickcpc0202.mongodb] ip:10.153.58.52] map[hostnames:[idea0202.mongodb] ip:10.153.58.52] map[hostnames:[noclickcpc0203.mongodb] ip:10.153.60.75] map[hostnames:[cpc0203.mongodb] ip:10.153.60.75] map[hostnames:[idea0203.mongodb] ip:10.153.60.75] map[hostnames:[cpc0301.mongodb] ip:10.144.122.209] map[hostnames:[idea0301.mongodb] ip:10.144.122.209] map[hostnames:[galaxywirelesslog02.mongodb] ip:10.144.125.225] map[hostnames:[cpc0302.mongodb] ip:10.144.125.225] map[hostnames:[galaxywirelesslog03.mongodb] ip:10.144.126.191] map[hostnames:[cpc0303.mongodb] ip:10.144.126.191] map[hostnames:[cpcrank0103.mongodb] ip:10.153.52.62] map[hostnames:[querykey0102.mongodb] ip:10.153.52.62] map[hostnames:[cpcrank0201.mongodb] ip:10.144.97.235] map[hostnames:[querykey0201.mongodb] ip:10.144.97.235] map[hostnames:[querykey0301.mongodb] ip:10.144.126.213] map[hostnames:[hourreport0101.mongodb] ip:10.144.126.213] map[hostnames:[regionreport0101.mongodb] ip:10.144.126.213] map[hostnames:[querykey0302.mongodb] ip:10.144.127.168] map[hostnames:[regionreport0102.mongodb] ip:10.144.127.168] map[hostnames:[querykey0303.mongodb] ip:10.152.99.208] map[hostnames:[regionreport0103.mongodb] ip:10.152.99.208] map[hostnames:[hourreport0103.mongodb] ip:10.152.99.208] map[hostnames:[cpcrank0303.mongodb] ip:10.152.99.208] map[hostnames:[qa.bizlog0401.mongodb] ip:10.144.14.227] map[hostnames:[regionreport0201.mongodb] ip:10.144.14.227] map[hostnames:[qa.bizlog0601.mongodb] ip:10.144.14.227] map[hostnames:[hourreport0201.mongodb] ip:10.144.14.227] map[hostnames:[regionreport0202.mongodb] ip:10.152.100.136] map[hostnames:[hourreport0202.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0302.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0602.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0402.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0502.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0303.mongodb] ip:10.152.105.194] map[hostnames:[regionreport0203.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0603.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0503.mongodb] ip:10.152.105.194] map[hostnames:[hourreport0203.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0403.mongodb] ip:10.152.105.194] map[hostnames:[regionreport0301.mongodb] ip:10.134.97.208] map[hostnames:[qa.bizlog0201.mongodb] ip:10.134.97.208] map[hostnames:[hourreport0301.mongodb] ip:10.134.97.208] map[hostnames:[qa.bizlog0203.mongodb] ip:10.134.110.147] map[hostnames:[regionreport0302.mongodb] ip:10.134.110.147] map[hostnames:[regionreport0303.mongodb] ip:10.142.79.219] map[hostnames:[qa.bizlog0102.mongodb] ip:10.142.79.219] map[hostnames:[hourreport0303.mongodb] ip:10.142.79.219] map[hostnames:[xurispend01.mongodb] ip:10.144.103.130] map[hostnames:[xuridailyspend01.mongodb] ip:10.144.103.130] map[hostnames:[xuridailyspend02.mon...\r\n5       \tSun Apr 26 17:00:43 2020\tfailed    \tthanos-deployment-1.0.0\t1.16.0     \tUpgrade \"janus-fe\" failed: failed to create patch: The order in patch list:\r\n        \t                        \t          \t                       \t           \t[map[hostnames:[cpc0101.mongodb] ip:10.153.44.147] map[hostnames:[noclickcpc0101.mongodb] ip:10.153.44.147] map[hostnames:[idea0201.mongodb] ip:10.153.52.63] map[hostnames:[cpc0201.mongodb] ip:10.153.52.63] map[hostnames:[querykey0103.mongodb] ip:10.153.52.63] map[hostnames:[noclickcpc0201.mongodb] ip:10.153.52.63] map[hostnames:[noclickcpc0202.mongodb] ip:10.153.58.52] map[hostnames:[idea0202.mongodb] ip:10.153.58.52] map[hostnames:[noclickcpc0203.mongodb] ip:10.153.60.75] map[hostnames:[cpc0203.mongodb] ip:10.153.60.75] map[hostnames:[idea0203.mongodb] ip:10.153.60.75] map[hostnames:[cpc0301.mongodb] ip:10.144.122.209] map[hostnames:[idea0301.mongodb] ip:10.144.122.209] map[hostnames:[galaxywirelesslog02.mongodb] ip:10.144.125.225] map[hostnames:[cpc0302.mongodb] ip:10.144.125.225] map[hostnames:[galaxywirelesslog03.mongodb] ip:10.144.126.191] map[hostnames:[cpc0303.mongodb] ip:10.144.126.191] map[hostnames:[cpcrank0103.mongodb] ip:10.153.52.62] map[hostnames:[querykey0102.mongodb] ip:10.153.52.62] map[hostnames:[cpcrank0201.mongodb] ip:10.144.97.235] map[hostnames:[querykey0201.mongodb] ip:10.144.97.235] map[hostnames:[querykey0301.mongodb] ip:10.144.126.213] map[hostnames:[hourreport0101.mongodb] ip:10.144.126.213] map[hostnames:[regionreport0101.mongodb] ip:10.144.126.213] map[hostnames:[querykey0302.mongodb] ip:10.144.127.168] map[hostnames:[regionreport0102.mongodb] ip:10.144.127.168] map[hostnames:[querykey0303.mongodb] ip:10.152.99.208] map[hostnames:[regionreport0103.mongodb] ip:10.152.99.208] map[hostnames:[hourreport0103.mongodb] ip:10.152.99.208] map[hostnames:[cpcrank0303.mongodb] ip:10.152.99.208] map[hostnames:[qa.bizlog0401.mongodb] ip:10.144.14.227] map[hostnames:[regionreport0201.mongodb] ip:10.144.14.227] map[hostnames:[qa.bizlog0601.mongodb] ip:10.144.14.227] map[hostnames:[hourreport0201.mongodb] ip:10.144.14.227] map[hostnames:[regionreport0202.mongodb] ip:10.152.100.136] map[hostnames:[hourreport0202.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0302.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0602.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0402.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0502.mongodb] ip:10.152.100.136] map[hostnames:[qa.bizlog0303.mongodb] ip:10.152.105.194] map[hostnames:[regionreport0203.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0603.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0503.mongodb] ip:10.152.105.194] map[hostnames:[hourreport0203.mongodb] ip:10.152.105.194] map[hostnames:[qa.bizlog0403.mongodb] ip:10.152.105.194] map[hostnames:[regionreport0301.mongodb] ip:10.134.97.208] map[hostnames:[qa.bizlog0201.mongodb] ip:10.134.97.208] map[hostnames:[hourreport0301.mongodb] ip:10.134.97.208] map[hostnames:[qa.bizlog0203.mongodb] ip:10.134.110.147] map[hostnames:[regionreport0302.mongodb] ip:10.134.110.147] map[hostnames:[regionreport0303.mongodb] ip:10.142.79.219] map[hostnames:[qa.bizlog0102.mongodb] ip:10.142.79.219] map[hostnames:[hourreport0303.mongodb] ip:10.142.79.219] map[hostnames:[xurispend01.mongodb] ip:10.144.103.130] map[hostnames:[xuridailyspend01.mongodb] ip:10.144.103.130] map[hostnames:[xuridailyspend02.mon...\r\n```\r\n\r\n**Dive into source code**\r\n\r\nIt seems to use patch method `helper.Patch` to perform upgrade,  and the above error is returned.\r\n\r\nwhen given `--force`, it seems to try to use `helper.Replace`, but was blocked by \r\n```\r\npatch, patchType, err := createPatch(target, currentObj)\r\n```\r\nwhere the error is returned.\r\n\r\n[https://github.com/helm/helm/blob/master/pkg/kube/client.go](https://github.com/helm/helm/blob/master/pkg/kube/client.go)\r\n```go\r\nfunc updateResource(c *Client, target *resource.Info, currentObj runtime.Object, force bool) error {\r\n\tvar (\r\n\t\tobj    runtime.Object\r\n\t\thelper = resource.NewHelper(target.Client, target.Mapping)\r\n\t\tkind   = target.Mapping.GroupVersionKind.Kind\r\n\t)\r\n\r\n\tpatch, patchType, err := createPatch(target, currentObj)\r\n\tif err != nil {\r\n\t\treturn errors.Wrap(err, \"failed to create patch\")\r\n\t}\r\n\r\n\tif patch == nil || string(patch) == \"{}\" {\r\n\t\tc.Log(\"Looks like there are no changes for %s %q\", target.Mapping.GroupVersionKind.Kind, target.Name)\r\n\t\t// This needs to happen to make sure that tiller has the latest info from the API\r\n\t\t// Otherwise there will be no labels and other functions that use labels will panic\r\n\t\tif err := target.Get(); err != nil {\r\n\t\t\treturn errors.Wrap(err, \"failed to refresh resource information\")\r\n\t\t}\r\n\t\treturn nil\r\n\t}\r\n\r\n\t// if --force is applied, attempt to replace the existing resource with the new object.\r\n\tif force {\r\n\t\tobj, err = helper.Replace(target.Namespace, target.Name, true, target.Object)\r\n\t\tif err != nil {\r\n\t\t\treturn errors.Wrap(err, \"failed to replace object\")\r\n\t\t}\r\n\t\tc.Log(\"Replaced %q with kind %s for kind %s\\n\", target.Name, currentObj.GetObjectKind().GroupVersionKind().Kind, kind)\r\n\t} else {\r\n\t\t// send patch to server\r\n\t\tobj, err = helper.Patch(target.Namespace, target.Name, patchType, patch, nil)\r\n\t\tif err != nil {\r\n\t\t\treturn errors.Wrapf(err, \"cannot patch %q with kind %s\", target.Name, kind)\r\n\t\t}\r\n\t}\r\n\r\n\ttarget.Refresh(obj, true)\r\n\treturn nil\r\n}\r\n```\r\n\r\n**Solution**\r\n\r\nSo, I think that the source code could be refactor to the following one, maybe\r\n\r\n```go\r\nfunc updateResource(c *Client, target *resource.Info, currentObj runtime.Object, force bool) error {\r\n\tvar (\r\n\t\tobj    runtime.Object\r\n\t\thelper = resource.NewHelper(target.Client, target.Mapping)\r\n\t\tkind   = target.Mapping.GroupVersionKind.Kind\r\n\t)\r\n\r\n\t// if --force is applied, attempt to replace the existing resource with the new object.\r\n\tif force {\r\n\t\tvar err error\r\n\t\tobj, err = helper.Replace(target.Namespace, target.Name, true, target.Object)\r\n\t\tif err != nil {\r\n\t\t\treturn errors.Wrap(err, \"failed to replace object\")\r\n\t\t}\r\n\t\tc.Log(\"Replaced %q with kind %s for kind %s\\n\", target.Name, currentObj.GetObjectKind().GroupVersionKind().Kind, kind)\r\n\t} else {\r\n\t\tpatch, patchType, err := createPatch(target, currentObj)\r\n\t\tif err != nil {\r\n\t\t\treturn errors.Wrap(err, \"failed to create patch\")\r\n\t\t}\r\n\r\n\t\tif patch == nil || string(patch) == \"{}\" {\r\n\t\t\tc.Log(\"Looks like there are no changes for %s %q\", target.Mapping.GroupVersionKind.Kind, target.Name)\r\n\t\t\t// This needs to happen to make sure that tiller has the latest info from the API\r\n\t\t\t// Otherwise there will be no labels and other functions that use labels will panic\r\n\t\t\tif err := target.Get(); err != nil {\r\n\t\t\t\treturn errors.Wrap(err, \"failed to refresh resource information\")\r\n\t\t\t}\r\n\t\t\treturn nil\r\n\t\t}\r\n\t\t// send patch to server\r\n\t\tobj, err = helper.Patch(target.Namespace, target.Name, patchType, patch, nil)\r\n\t\tif err != nil {\r\n\t\t\treturn errors.Wrapf(err, \"cannot patch %q with kind %s\", target.Name, kind)\r\n\t\t}\r\n\t}\r\n\r\n\ttarget.Refresh(obj, true)\r\n\treturn nil\r\n}\r\n```\r\n\r\n**Result**\r\nthe error was eliminated\uff0cand everything goes well.\r\n\r\n\r\n",
  "closed_at": "2020-05-13T21:53:37Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/89193?v=4",
    "events_url": "https://api.github.com/users/technosophos/events{/privacy}",
    "followers_url": "https://api.github.com/users/technosophos/followers",
    "following_url": "https://api.github.com/users/technosophos/following{/other_user}",
    "gists_url": "https://api.github.com/users/technosophos/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/technosophos",
    "id": 89193,
    "login": "technosophos",
    "node_id": "MDQ6VXNlcjg5MTkz",
    "organizations_url": "https://api.github.com/users/technosophos/orgs",
    "received_events_url": "https://api.github.com/users/technosophos/received_events",
    "repos_url": "https://api.github.com/users/technosophos/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/technosophos/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/technosophos/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/technosophos"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/helm/helm/issues/7999/comments",
  "created_at": "2020-04-27T00:47:24Z",
  "events_url": "https://api.github.com/repos/helm/helm/issues/7999/events",
  "html_url": "https://github.com/helm/helm/issues/7999",
  "id": 607158343,
  "labels": [
    {
      "color": "e11d21",
      "default": true,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 778135666,
      "name": "bug",
      "node_id": "MDU6TGFiZWw3NzgxMzU2NjY=",
      "url": "https://api.github.com/repos/helm/helm/labels/bug"
    },
    {
      "color": "e8a28d",
      "default": false,
      "description": "",
      "id": 1014087494,
      "name": "unconfirmed",
      "node_id": "MDU6TGFiZWwxMDE0MDg3NDk0",
      "url": "https://api.github.com/repos/helm/helm/labels/unconfirmed"
    }
  ],
  "labels_url": "https://api.github.com/repos/helm/helm/issues/7999/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MDcxNTgzNDM=",
  "number": 7999,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/helm/helm",
  "state": "closed",
  "title": "\"failed to create patch: The order in patch list\" when helm upgrade using --force",
  "updated_at": "2020-05-13T21:53:37Z",
  "url": "https://api.github.com/repos/helm/helm/issues/7999",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/11614773?v=4",
    "events_url": "https://api.github.com/users/liuming-dev/events{/privacy}",
    "followers_url": "https://api.github.com/users/liuming-dev/followers",
    "following_url": "https://api.github.com/users/liuming-dev/following{/other_user}",
    "gists_url": "https://api.github.com/users/liuming-dev/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/liuming-dev",
    "id": 11614773,
    "login": "liuming-dev",
    "node_id": "MDQ6VXNlcjExNjE0Nzcz",
    "organizations_url": "https://api.github.com/users/liuming-dev/orgs",
    "received_events_url": "https://api.github.com/users/liuming-dev/received_events",
    "repos_url": "https://api.github.com/users/liuming-dev/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/liuming-dev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/liuming-dev/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/liuming-dev"
  }
}