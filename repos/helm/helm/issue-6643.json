{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "When tiller starts and tries to synchronize status running in the cluster and the expected status from coming from flux, tiller panics due to concurrent map writing.\r\n\r\nThis is is the stack trace\r\n\r\n```fatal error: concurrent map writes\r\n\r\ngoroutine 319 [running]:\r\nruntime.throw(0x18f2f0d, 0x15)\r\n\t/usr/local/go/src/runtime/panic.go:774 +0x72 fp=0xc000e11e00 sp=0xc000e11dd0 pc=0x42f302\r\nruntime.mapassign_faststr(0x16a3d40, 0xc0007b4270, 0xc000fd35d4, 0xc, 0x2a182a0)\r\n\t/usr/local/go/src/runtime/map_faststr.go:211 +0x417 fp=0xc000e11e68 sp=0xc000e11e00 pc=0x413427\r\nk8s.io/helm/pkg/kube.(*Client).Get.func1(0xc000fe38f0, 0x4373f6, 0x199fb28)\r\n\t/go/src/k8s.io/helm/pkg/kube/client.go:246 +0x79e fp=0xc000e11f88 sp=0xc000e11e68 pc=0x143ba0e\r\nk8s.io/helm/pkg/kube.batchPerform.func1(0xc0006c5c80, 0xc000ef9dd0, 0xc000eeffa0, 0xc000fe38f0)\r\n\t/go/src/k8s.io/helm/pkg/kube/client.go:643 +0x30 fp=0xc000e11fc0 sp=0xc000e11f88 pc=0x143cc00\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:1357 +0x1 fp=0xc000e11fc8 sp=0xc000e11fc0 pc=0x45ec51\r\ncreated by k8s.io/helm/pkg/kube.batchPerform\r\n\t/go/src/k8s.io/helm/pkg/kube/client.go:642 +0xb8\r\n``` \r\n\r\nThis problem is caused by:\r\nhttps://github.com/helm/helm/blob/17027a1271345be6de4dfdc1fb3a943e8a3bb20a/pkg/kube/client.go#L220-L258\r\n\r\n`perform` function runs the workload in go routines. Line 245 of `client.go` file tries to read and after write into a map that is shared across all goroutines and causes the panic.\r\nhttps://github.com/helm/helm/blob/17027a1271345be6de4dfdc1fb3a943e8a3bb20a/pkg/kube/client.go#L615-L630\r\n\r\nSolution: share a lock in `ResourceActorFunc\r\n\r\nTiller version: canary\r\n\r\n\r\nOutput of `kubectl version`: \r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v1.16.1\", GitCommit:\"d647ddbd755faf07169599a625faf302ffc34458\", GitTreeState:\"clean\", BuildDate:\"2019-10-02T23:49:20Z\", GoVersion:\"go1.12.9\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"14+\", GitVersion:\"v1.14.6-eks-5047ed\", GitCommit:\"5047edce664593832e9b889e447ac75ab104f527\", GitTreeState:\"clean\", BuildDate:\"2019-08-21T22:32:40Z\", GoVersion:\"go1.12.9\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n\r\nCloud Provider/Platform (AKS, GKE, Minikube etc.): \r\nAWS\r\n\r\n",
  "closed_at": "2019-10-15T17:46:48Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1360539?v=4",
    "events_url": "https://api.github.com/users/bacongobbler/events{/privacy}",
    "followers_url": "https://api.github.com/users/bacongobbler/followers",
    "following_url": "https://api.github.com/users/bacongobbler/following{/other_user}",
    "gists_url": "https://api.github.com/users/bacongobbler/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/bacongobbler",
    "id": 1360539,
    "login": "bacongobbler",
    "node_id": "MDQ6VXNlcjEzNjA1Mzk=",
    "organizations_url": "https://api.github.com/users/bacongobbler/orgs",
    "received_events_url": "https://api.github.com/users/bacongobbler/received_events",
    "repos_url": "https://api.github.com/users/bacongobbler/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/bacongobbler/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bacongobbler/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/bacongobbler"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/helm/helm/issues/6643/comments",
  "created_at": "2019-10-11T10:01:49Z",
  "events_url": "https://api.github.com/repos/helm/helm/issues/6643/events",
  "html_url": "https://github.com/helm/helm/issues/6643",
  "id": 505758418,
  "labels": [
    {
      "color": "e11d21",
      "default": true,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 778135666,
      "name": "bug",
      "node_id": "MDU6TGFiZWw3NzgxMzU2NjY=",
      "url": "https://api.github.com/repos/helm/helm/labels/bug"
    },
    {
      "color": "8c49d8",
      "default": false,
      "description": "Issues and Pull Requests related to the major version v2",
      "id": 1580151847,
      "name": "v2.x",
      "node_id": "MDU6TGFiZWwxNTgwMTUxODQ3",
      "url": "https://api.github.com/repos/helm/helm/labels/v2.x"
    }
  ],
  "labels_url": "https://api.github.com/repos/helm/helm/issues/6643/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MDU3NTg0MTg=",
  "number": 6643,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/helm/helm",
  "state": "closed",
  "title": "Concurrent map writes causes a panic once app starts.",
  "updated_at": "2019-10-15T17:46:48Z",
  "url": "https://api.github.com/repos/helm/helm/issues/6643",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/3629062?v=4",
    "events_url": "https://api.github.com/users/tigrato/events{/privacy}",
    "followers_url": "https://api.github.com/users/tigrato/followers",
    "following_url": "https://api.github.com/users/tigrato/following{/other_user}",
    "gists_url": "https://api.github.com/users/tigrato/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/tigrato",
    "id": 3629062,
    "login": "tigrato",
    "node_id": "MDQ6VXNlcjM2MjkwNjI=",
    "organizations_url": "https://api.github.com/users/tigrato/orgs",
    "received_events_url": "https://api.github.com/users/tigrato/received_events",
    "repos_url": "https://api.github.com/users/tigrato/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/tigrato/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tigrato/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/tigrato"
  }
}