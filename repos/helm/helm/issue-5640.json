{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "Validation on BuildUnstructured was introduced in the https://github.com/helm/helm/pull/5576.\r\n\r\nFirstly, this is very important fix, thanks @mortent .\r\n\r\nBut we have encountered problems with compatibility trying to run `helm upgrade` on already installed release in the `DEPLOYED` state.\r\n\r\nThe error was:\r\n\r\n```\r\n$ helm get RELEASE\r\n...\r\nError: getting release status failed: error validating \"\": error validating data: ValidationError(CronJob.spec): unknown field \"activeDeadlineSeconds\" in io.k8s.api.batch.v1beta1.CronJobSpec\r\n```\r\n\r\nThe error occured because there is indeed an error in the chart template: `CronJob` does not have `activeDeadlineSeconds` field, but it was defined in the manifest. The **important thing** is that it is impossible to fix the issue simply by fixing error in the chart template and redeploying, because `helm upgrade` still fails after fix: validation error occurs when fetching release manifests from storage.\r\n\r\n# How to reproduce\r\n\r\n```\r\n$ git clone https://github.com/distorhead/ex-helm-validation-incompatibility.git\r\n$ cd ex-helm-validation-incompatibility\r\n```\r\n\r\nInstalling chart first time with helm `2.13.1`. There is an error in chart: unknown `helloWorld: 1234` field defined for the `CronJob`. But helm 2.13.1 install release successfully:\r\n\r\n```\r\n$ git checkout bad\r\n$ helm version\r\nClient: &version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"}\r\nServer: &version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"}\r\n$ helm install . --name example --namespace example\r\nNAME:   example\r\nLAST DEPLOYED: Wed Apr 24 19:16:09 2019\r\nNAMESPACE: example\r\nSTATUS: DEPLOYED\r\n\r\nRESOURCES:\r\n==> v1beta1/CronJob\r\nNAME      SCHEDULE    SUSPEND  ACTIVE  LAST SCHEDULE  AGE\r\ncleaning  32 1 * * *  False    0       <none>         0s\r\n\r\n$ helm get example\r\n...\r\n# Source: ex-helm-validation-incompatibility/templates/01-cronjob.yaml\r\napiVersion: batch/v1beta1\r\nkind: CronJob\r\nmetadata:\r\n  name: cleaning\r\nspec:\r\n...\r\n  helloWorld: 1234\r\n...\r\n```\r\n\r\nBad resource manifest has been recorded into release revision.\r\n\r\nThen let's try to upgrade release using new helm version (master):\r\n\r\n```\r\n$ HELM_HOST=localhost:44134 ~/go/src/k8s.io/helm/bin/helm upgrade example .\r\nUPGRADE FAILED\r\nError: error validating \"\": error validating data: ValidationError(CronJob.spec): unknown field \"helloWorld\" in io.k8s.api.batch.v1beta1.CronJobSpec\r\nError: UPGRADE FAILED: error validating \"\": error validating data: ValidationError(CronJob.spec): unknown field \"helloWorld\" in io.k8s.api.batch.v1beta1.CronJobSpec\r\n```\r\n\r\nDelete unknown field and retry:\r\n\r\n```\r\n$ git checkout good\r\n$ git diff bad\r\ndiff --git a/templates/01-cronjob.yaml b/templates/01-cronjob.yaml\r\nindex efd8d4d..7f91a65 100644\r\n--- a/templates/01-cronjob.yaml\r\n+++ b/templates/01-cronjob.yaml\r\n@@ -6,7 +6,6 @@ spec:\r\n   schedule: \"32 1 * * *\"\r\n   successfulJobsHistoryLimit: 3\r\n   failedJobsHistoryLimit: 1\r\n-  helloWorld: 1234\r\n   concurrencyPolicy: Forbid\r\n   jobTemplate:\r\n     spec:\r\n$ HELM_HOST=localhost:44134 ~/go/src/k8s.io/helm/bin/helm upgrade example .\r\nUPGRADE FAILED\r\nError: failed decoding reader into objects: error validating \"\": error validating data: ValidationError(CronJob.spec): unknown field \"helloWorld\" in io.k8s.api.batch.v1beta1.CronJobSpec\r\nError: UPGRADE FAILED: failed decoding reader into objects: error validating \"\": error validating data: ValidationError(CronJob.spec): unknown field \"helloWorld\" in io.k8s.api.batch.v1beta1.CronJobSpec\r\n```\r\n\r\nStill got same error.\r\n\r\nThe only known way to fix the problem is to downgrade tiller, fix manifest, upgrade release, then upgrade tiller.\r\n\r\nSeems that validation should not be applied to manifests fetched from release storage.",
  "closed_at": "2019-05-16T19:25:35Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1360539?v=4",
    "events_url": "https://api.github.com/users/bacongobbler/events{/privacy}",
    "followers_url": "https://api.github.com/users/bacongobbler/followers",
    "following_url": "https://api.github.com/users/bacongobbler/following{/other_user}",
    "gists_url": "https://api.github.com/users/bacongobbler/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/bacongobbler",
    "id": 1360539,
    "login": "bacongobbler",
    "node_id": "MDQ6VXNlcjEzNjA1Mzk=",
    "organizations_url": "https://api.github.com/users/bacongobbler/orgs",
    "received_events_url": "https://api.github.com/users/bacongobbler/received_events",
    "repos_url": "https://api.github.com/users/bacongobbler/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/bacongobbler/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bacongobbler/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/bacongobbler"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/helm/helm/issues/5640/comments",
  "created_at": "2019-04-24T16:35:32Z",
  "events_url": "https://api.github.com/repos/helm/helm/issues/5640/events",
  "html_url": "https://github.com/helm/helm/issues/5640",
  "id": 436796799,
  "labels": [
    {
      "color": "e11d21",
      "default": true,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 778135666,
      "name": "bug",
      "node_id": "MDU6TGFiZWw3NzgxMzU2NjY=",
      "url": "https://api.github.com/repos/helm/helm/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/helm/helm/issues/5640/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MzY3OTY3OTk=",
  "number": 5640,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/helm/helm",
  "state": "closed",
  "title": "Broken compatibility because of mandatory validation on BuildUnstructured",
  "updated_at": "2019-05-16T19:25:35Z",
  "url": "https://api.github.com/repos/helm/helm/issues/5640",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1161992?v=4",
    "events_url": "https://api.github.com/users/distorhead/events{/privacy}",
    "followers_url": "https://api.github.com/users/distorhead/followers",
    "following_url": "https://api.github.com/users/distorhead/following{/other_user}",
    "gists_url": "https://api.github.com/users/distorhead/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/distorhead",
    "id": 1161992,
    "login": "distorhead",
    "node_id": "MDQ6VXNlcjExNjE5OTI=",
    "organizations_url": "https://api.github.com/users/distorhead/orgs",
    "received_events_url": "https://api.github.com/users/distorhead/received_events",
    "repos_url": "https://api.github.com/users/distorhead/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/distorhead/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/distorhead/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/distorhead"
  }
}