{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "The node that is running Tiller causes the Kubelet to leak memory. Depending on how frequently Tiller is polled by the Helm client, influences how much memory is leaked.\r\n\r\nThis has been verified on 3 different clusters running Kubernetes 1.6.8. Talking to other users, we have identified this problem also existing with 1.5.x, 1.7.x and 1.8.x clusters.\r\n\r\nOn a cluster where Helm commands were being issued 20 times per minute (over 100 releases), in a period of a day we caused the Kubelet to consume over 70GB of memory.\r\n```\r\nPID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND\r\n13268 root      20   0 78.295g 4.521g  48336 S  24.6 30.3  12:53.83 kubelet\r\n```\r\n\r\nFurther investigation identified an extremely large number of `socat` processes running on the node (over 1000). Here is a sample of the process list.\r\n```\r\nroot     27500  0.0  0.0  21740  2976 ?        S    07:52   0:00 /usr/bin/socat - TCP4:localhost:44134\r\nroot     27501  0.0  0.0  21740  3004 ?        S    07:52   0:00 /usr/bin/socat - TCP4:localhost:44134\r\nroot     27502  0.0  0.0  21740  3004 ?        S    07:52   0:00 /usr/bin/socat - TCP4:localhost:44134\r\nroot     27503  0.0  0.0  21740  2920 ?        S    07:52   0:00 /usr/bin/socat - TCP4:localhost:44134\r\nroot     27504  0.0  0.0  21740  2812 ?        S    07:52   0:00 /usr/bin/socat - TCP4:localhost:44134\r\nroot     27505  0.0  0.0  21740  2976 ?        S    07:52   0:00 /usr/bin/socat - TCP4:localhost:44134\r\n```\r\n\r\nI reached out to @justinsb who verified this on a 1.8.x cluster on a fresh installation of Helm.\r\n\r\nJustin found the likely cause of the problem being the following block of code (and comment explaining the edge case).\r\nhttps://github.com/kubernetes/kubernetes/blame/master/pkg/kubelet/dockershim/docker_streaming.go#L191-L192\r\n```\r\n// If we use Stdin, command.Run() won't return until the goroutine that's copying\r\n// from stream finishes. Unfortunately, if you have a client like telnet connected\r\n// via port forwarding, as long as the user's telnet client is connected to the user's\r\n// local listener that port forwarding sets up, the telnet session never exits. This\r\n// means that even if socat has finished running, command.Run() won't ever return\r\n// (because the client still has the connection and stream open).\r\n//\r\n// The work around is to use StdinPipe(), as Wait() (called by Run()) closes the pipe\r\n// when the command (socat) exits.\r\n```\r\n\r\nThis code was added from the following PR:\r\nhttps://github.com/kubernetes/kubernetes/pull/12283\r\n\r\nWhich was designed to fix:\r\nhttps://github.com/kubernetes/kubernetes/issues/8766\r\n\r\nFurther discussion about this issue:\r\nhttps://groups.google.com/forum/#!topic/grpc-io/69k_6HKVai0\r\n\r\nIt seems likely there are 2 issues.\r\n1. Tiller is keeping its connections open.\r\n2. Kubelet is not handling bad actors who don't close their connection.\r\n\r\n`kubectl logs` and `kubectl exec` use this capability but are clearly closing the connection which is why we do not see this problem for every cluster. Only large scale Helm users would likely causing enough queries to make this a noticeable problem.\r\n",
  "closed_at": "2019-02-06T16:17:10Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1360539?v=4",
    "events_url": "https://api.github.com/users/bacongobbler/events{/privacy}",
    "followers_url": "https://api.github.com/users/bacongobbler/followers",
    "following_url": "https://api.github.com/users/bacongobbler/following{/other_user}",
    "gists_url": "https://api.github.com/users/bacongobbler/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/bacongobbler",
    "id": 1360539,
    "login": "bacongobbler",
    "node_id": "MDQ6VXNlcjEzNjA1Mzk=",
    "organizations_url": "https://api.github.com/users/bacongobbler/orgs",
    "received_events_url": "https://api.github.com/users/bacongobbler/received_events",
    "repos_url": "https://api.github.com/users/bacongobbler/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/bacongobbler/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bacongobbler/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/bacongobbler"
  },
  "comments": 40,
  "comments_url": "https://api.github.com/repos/helm/helm/issues/3121/comments",
  "created_at": "2017-11-09T23:10:21Z",
  "events_url": "https://api.github.com/repos/helm/helm/issues/3121/events",
  "html_url": "https://github.com/helm/helm/issues/3121",
  "id": 272760991,
  "labels": [
    {
      "color": "e11d21",
      "default": true,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 778135666,
      "name": "bug",
      "node_id": "MDU6TGFiZWw3NzgxMzU2NjY=",
      "url": "https://api.github.com/repos/helm/helm/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/helm/helm/issues/3121/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyNzI3NjA5OTE=",
  "number": 3121,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/helm/helm",
  "state": "closed",
  "title": "Tiller causing Kubelet to leak memory",
  "updated_at": "2019-02-06T16:17:10Z",
  "url": "https://api.github.com/repos/helm/helm/issues/3121",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/215265?v=4",
    "events_url": "https://api.github.com/users/mikelorant/events{/privacy}",
    "followers_url": "https://api.github.com/users/mikelorant/followers",
    "following_url": "https://api.github.com/users/mikelorant/following{/other_user}",
    "gists_url": "https://api.github.com/users/mikelorant/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mikelorant",
    "id": 215265,
    "login": "mikelorant",
    "node_id": "MDQ6VXNlcjIxNTI2NQ==",
    "organizations_url": "https://api.github.com/users/mikelorant/orgs",
    "received_events_url": "https://api.github.com/users/mikelorant/received_events",
    "repos_url": "https://api.github.com/users/mikelorant/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mikelorant/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mikelorant/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mikelorant"
  }
}