{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/2390463?v=4",
    "events_url": "https://api.github.com/users/reasonerjt/events{/privacy}",
    "followers_url": "https://api.github.com/users/reasonerjt/followers",
    "following_url": "https://api.github.com/users/reasonerjt/following{/other_user}",
    "gists_url": "https://api.github.com/users/reasonerjt/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/reasonerjt",
    "id": 2390463,
    "login": "reasonerjt",
    "node_id": "MDQ6VXNlcjIzOTA0NjM=",
    "organizations_url": "https://api.github.com/users/reasonerjt/orgs",
    "received_events_url": "https://api.github.com/users/reasonerjt/received_events",
    "repos_url": "https://api.github.com/users/reasonerjt/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/reasonerjt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/reasonerjt/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/reasonerjt"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/2390463?v=4",
      "events_url": "https://api.github.com/users/reasonerjt/events{/privacy}",
      "followers_url": "https://api.github.com/users/reasonerjt/followers",
      "following_url": "https://api.github.com/users/reasonerjt/following{/other_user}",
      "gists_url": "https://api.github.com/users/reasonerjt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/reasonerjt",
      "id": 2390463,
      "login": "reasonerjt",
      "node_id": "MDQ6VXNlcjIzOTA0NjM=",
      "organizations_url": "https://api.github.com/users/reasonerjt/orgs",
      "received_events_url": "https://api.github.com/users/reasonerjt/received_events",
      "repos_url": "https://api.github.com/users/reasonerjt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/reasonerjt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/reasonerjt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/reasonerjt"
    }
  ],
  "author_association": "NONE",
  "body": "**Expected behavior and actual behavior:**\r\nContainerd coudn't pull private image from harbor 1.9.3\uff0cit's return 403 forbidden error, but pull public image is fine.\r\nThis bug will appear in harbor versions >= 1.9.2 and >= 1.8.5\r\n\r\n**Steps to reproduce the problem:**\r\nharbor 1.9.3\r\n```\r\n[root@localhost ~]# ctr --debug image pull -u username:password reg.mydomain.com/test/test:latest\r\nDEBU[0000] fetching                                      image=\"reg.mydomain.com/test/test:latest\"\r\nDEBU[0000] resolving                                    \r\nDEBU[0000] do request                                    request.headers=map[Accept:[application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, *]] request.method=HEAD url=\"https://reg.mydomain.com/v2/test/test/manifests/latest\"\r\nDEBU[0002] fetch response received                       response.headers=map[Connection:[keep-alive] Content-Length:[152] Content-Type:[application/json; charset=utf-8] Date:[Wed, 18 Dec 2019 08:34:25 GMT] Docker-Distribution-Api-Version:[registry/2.0] Server:[nginx] Set-Cookie:[sid=083bf0a0c2d660953d150aa1aa602a83; Path=/; HttpOnly _xsrf=NVdwdjFBWmVUb29sNGJHZ1VEUzE4bGRuNE9rTW56bUE=|1576658065807866874|fdf659978f4dd1c15cfa54f5d1ddf8848f69d628; Expires=Wed, 18 Dec 2019 09:34:25 UTC; Max-Age=3600; Path=/] Www-Authenticate:[Bearer realm=\"https://reg.mydomain.com/service/token\",service=\"harbor-registry\",scope=\"repository:test/test:pull\"]] status=\"401 Unauthorized\" url=\"https://reg.mydomain.com/v2/test/test/manifests/latest\"\r\nDEBU[0002] Unauthorized                                  header=\"Bearer realm=\"https://reg.mydomain.com/service/token\",service=\"harbor-registry\",scope=\"repository:test/test:pull\"\"\r\nDEBU[0002] token request failed                          body=\"\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\r\n    <title>beego application error</title>\r\n    <style>\r\n        html, body, body * {padding: 0; margin: 0;}\r\n        #header {background:#ffd; border-bottom:solid 2px #A31515; padding: 20px 10px;}\r\n        #header h2{ }\r\n        #footer {border-top:solid 1px #aaa; padding: 5px 10px; font-size: 12px; color:green;}\r\n        #content {padding: 5px;}\r\n        #content .stack b{ font-size: 13px; color: red;}\r\n        #content .stack pre{padding-left: 10px;}\r\n        table {}\r\n        td.t {text-align: right; padding-right: 5px; color: #888;}\r\n    </style>\r\n    <script type=\"text/javascript\">\r\n    </script>\r\n</head>\r\n<body>\r\n    <div id=\"header\">\r\n        <h2>Harbor:&#39;_xsrf&#39; argument missing from POST</h2>\r\n    </div>\r\n    <div id=\"content\">\r\n        <table>\r\n            <tr>\r\n                <td class=\"t\">Request Method: </td><td>POST</td>\r\n            </tr>\r\n            <tr>\r\n                <td class=\"t\">Request URL: </td><td>/service/token</td>\r\n            </tr>\r\n            <tr>\r\n                <td class=\"t\">RemoteAddr: </td><td>121.237.7.19</td>\r\n            </tr>\r\n        </table>\r\n        <div class=\"stack\">\r\n            <b>Stack</b>\r\n            <pre>/usr/local/go/src/runtime/panic.go:522\r\n/harbor/src/vendor/github.com/astaxie/beego/context/context.go:80\r\n/harbor/src/vendor/github.com/astaxie/beego/context/context.go:164\r\n/harbor/src/vendor/github.com/astaxie/beego/controller.go:649\r\n/harbor/src/vendor/github.com/astaxie/beego/router.go:788\r\n/usr/local/go/src/net/http/server.go:2774\r\n/usr/local/go/src/net/http/server.go:1878\r\n/usr/local/go/src/runtime/asm_amd64.s:1337\r\n</pre>\r\n        </div>\r\n    </div>\r\n    <div id=\"footer\">\r\n        <p>beego 1.9.0 (beego framework)</p>\r\n        <p>golang version: go1.12.12</p>\r\n    </div>\r\n</body>\r\n</html>\r\n\" status=\"403 Forbidden\"\r\nctr: failed to resolve reference \"reg.mydomain.com/test/test:latest\": failed to fetch oauth token: unexpected status: 403 Forbidden\r\n```\r\n\r\nharbor 1.9.1\r\n```\r\n[root@localhost ~]# ctr --debug image pull -u username:password reg.mydomain.com/test/test:latest\r\nDEBU[0000] fetching                                      image=\"reg.mydomain.com/test/test:latest\"\r\nDEBU[0000] resolving                                    \r\nDEBU[0000] do request                                    request.headers=map[Accept:[application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, *]] request.method=HEAD url=\"https://reg.mydomain.com/v2/test/test/manifests/latest\"\r\nDEBU[0003] fetch response received                       response.headers=map[Connection:[keep-alive] Content-Length:[152] Content-Type:[application/json; charset=utf-8] Date:[Wed, 18 Dec 2019 08:25:07 GMT] Docker-Distribution-Api-Version:[registry/2.0] Server:[nginx] Set-Cookie:[sid=f30ae6784828bd9df24771d747832dde; Path=/; HttpOnly] Www-Authenticate:[Bearer realm=\"https://reg.mydomain.com/service/token\",service=\"harbor-registry\",scope=\"repository:test/test:pull\"]] status=\"401 Unauthorized\" url=\"https://reg.mydomain.com/v2/test/test/manifests/latest\"\r\nDEBU[0003] Unauthorized                                  header=\"Bearer realm=\"https://reg.mydomain.com/service/token\",service=\"harbor-registry\",scope=\"repository:test/test:pull\"\"\r\nDEBU[0006] do request                                    request.headers=map[Accept:[application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, *] User-Agent:[containerd/1.2.10]] request.method=HEAD url=\"https://reg.mydomain.com/v2/test/test/manifests/latest\"\r\nDEBU[0006] fetch response received                       response.headers=map[Connection:[keep-alive] Content-Length:[527] Content-Security-Policy:[frame-ancestors 'none'] Content-Type:[application/vnd.docker.distribution.manifest.v2+json] Date:[Wed, 18 Dec 2019 08:25:10 GMT] Docker-Content-Digest:[sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d] Docker-Distribution-Api-Version:[registry/2.0] Etag:[\"sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d\"] Server:[nginx] Set-Cookie:[sid=c5cd4225a3e1af5ad36ba65ab996e1fd; Path=/; HttpOnly] Strict-Transport-Security:[max-age=31536000; includeSubdomains; preload] X-Frame-Options:[DENY]] status=\"200 OK\" url=\"https://reg.mydomain.com/v2/test/test/manifests/latest\"\r\nDEBU[0006] resolved                                      desc.digest=sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d\r\nDEBU[0006] fetch                                         digest=sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d mediatype=\"application/vnd.docker.distribution.manifest.v2+json\" size=527\r\nDEBU[0006] do request                                    base=\"https://reg.mydomain.com/v2/test/test\" digest=sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d mediatype=\"application/vnd.docker.distribution.manifest.v2+json\" request.headers=map[Accept:[application/vnd.docker.distribution.manifest.v2+json, *]] request.method=GET size=527 url=\"https://reg.mydomain.com/v2/test/test/manifests/sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d\"\r\nDEBU[0006] fetch response received                       base=\"https://reg.mydomain.com/v2/test/test\" digest=sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d mediatype=\"application/vnd.docker.distribution.manifest.v2+json\" response.headers=map[Connection:[keep-alive] Content-Length:[527] Content-Security-Policy:[frame-ancestors 'none'] Content-Type:[application/vnd.docker.distribution.manifest.v2+json] Date:[Wed, 18 Dec 2019 08:25:10 GMT] Docker-Content-Digest:[sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d] Docker-Distribution-Api-Version:[registry/2.0] Etag:[\"sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d\"] Server:[nginx] Set-Cookie:[sid=b5b32f3e08d6de9572bfba267828daf9; Path=/; HttpOnly] Strict-Transport-Security:[max-age=31536000; includeSubdomains; preload] X-Frame-Options:[DENY]] size=527 status=\"200 OK\" url=\"https://reg.mydomain.com/v2/test/test/manifests/sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d\"\r\nDEBU[0006] fetch                                         digest=sha256:7675586df687972b960134ddaf042c570c895bf1fbdf9fc0ce0bf09c1e1c2811 mediatype=\"application/vnd.docker.image.rootfs.diff.tar.gzip\" size=323414\r\nDEBU[0006] fetch                                         digest=sha256:da86e6ba6ca197bf6bc5e9d900febd906b133eaa4750e6bed647b0fbe50ed43e mediatype=\"application/vnd.docker.container.image.v1+json\" size=1609\r\nDEBU[0006] do request                                    base=\"https://reg.mydomain.com/v2/test/test\" digest=sha256:da86e6ba6ca197bf6bc5e9d900febd906b133eaa4750e6bed647b0fbe50ed43e mediatype=\"application/vnd.docker.container.image.v1+json\" request.headers=map[Accept:[application/vnd.docker.container.image.v1+json, *]] request.method=GET size=1609 url=\"https://reg.mydomain.com/v2/test/test/blobs/sha256:da86e6ba6ca197bf6bc5e9d900febd906b133eaa4750e6bed647b0fbe50ed43e\"\r\nDEBU[0006] do request                                    base=\"https://reg.mydomain.com/v2/test/test\" digest=sha256:7675586df687972b960134ddaf042c570c895bf1fbdf9fc0ce0bf09c1e1c2811 mediatype=\"application/vnd.docker.image.rootfs.diff.tar.gzip\" request.headers=map[Accept:[application/vnd.docker.image.rootfs.diff.tar.gzip, *]] request.method=GET size=323414 url=\"https://reg.mydomain.com/v2/test/test/blobs/sha256:7675586df687972b960134ddaf042c570c895bf1fbdf9fc0ce0bf09c1e1c2811\"\r\nDEBU[0006] fetch response received                       base=\"https://reg.mydomain.com/v2/test/test\" digest=sha256:da86e6ba6ca197bf6bc5e9d900febd906b133eaa4750e6bed647b0fbe50ed43e mediatype=\"application/vnd.docker.container.image.v1+json\" response.headers=map[Accept-Ranges:[bytes] Cache-Control:[max-age=31536000] Connection:[keep-alive] Content-Length:[1609] Content-Security-Policy:[frame-ancestors 'none'] Content-Type:[application/octet-stream] Date:[Wed, 18 Dec 2019 08:25:10 GMT] Docker-Content-Digest:[sha256:da86e6ba6ca197bf6bc5e9d900febd906b133eaa4750e6bed647b0fbe50ed43e] Docker-Distribution-Api-Version:[registry/2.0] Etag:[\"sha256:da86e6ba6ca197bf6bc5e9d900febd906b133eaa4750e6bed647b0fbe50ed43e\"] Server:[nginx] Set-Cookie:[sid=dd49c1d6fe958c388e407c8f162cc209; Path=/; HttpOnly] Strict-Transport-Security:[max-age=31536000; includeSubdomains; preload] X-Frame-Options:[DENY]] size=1609 status=\"200 OK\" url=\"https://reg.mydomain.com/v2/test/test/blobs/sha256:da86e6ba6ca197bf6bc5e9d900febd906b133eaa4750e6bed647b0fbe50ed43e\"\r\nDEBU[0006] fetch response received                       base=\"https://reg.mydomain.com/v2/test/test\" digest=sha256:7675586df687972b960134ddaf042c570c895bf1fbdf9fc0ce0bf09c1e1c2811 mediatype=\"application/vnd.docker.image.rootfs.diff.tar.gzip\" response.headers=map[Accept-Ranges:[bytes] Cache-Control:[max-age=31536000] Connection:[keep-alive] Content-Length:[323414] Content-Security-Policy:[frame-ancestors 'none'] Content-Type:[application/octet-stream] Date:[Wed, 18 Dec 2019 08:25:10 GMT] Docker-Content-Digest:[sha256:7675586df687972b960134ddaf042c570c895bf1fbdf9fc0ce0bf09c1e1c2811] Docker-Distribution-Api-Version:[registry/2.0] Etag:[\"sha256:7675586df687972b960134ddaf042c570c895bf1fbdf9fc0ce0bf09c1e1c2811\"] Server:[nginx] Set-Cookie:[sid=ae89e0d71a3eca5483ea807c4c183590; Path=/; HttpOnly] Strict-Transport-Security:[max-age=31536000; includeSubdomains; preload] X-Frame-Options:[DENY]] size=323414 status=\"200 OK\" url=\"https://reg.mydomain.com/v2/test/test/blobs/sha256:7675586df687972b960134ddaf042c570c895bf1fbdf9fc0ce0bf09c1e1c2811\"\r\nDEBU[0015] unpacking                                     image=\"reg.mydomain.com/test/test:latest\"\r\nunpacking linux/amd64 sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d...\r\ndone\r\n```\r\n**Versions:**\r\n- harbor version: [1.9.3] [1.8.6]\r\n- containerd  version: [1.2.10]\r\n\r\n",
  "closed_at": "2019-12-27T08:10:26Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/5835782?v=4",
    "events_url": "https://api.github.com/users/ywk253100/events{/privacy}",
    "followers_url": "https://api.github.com/users/ywk253100/followers",
    "following_url": "https://api.github.com/users/ywk253100/following{/other_user}",
    "gists_url": "https://api.github.com/users/ywk253100/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ywk253100",
    "id": 5835782,
    "login": "ywk253100",
    "node_id": "MDQ6VXNlcjU4MzU3ODI=",
    "organizations_url": "https://api.github.com/users/ywk253100/orgs",
    "received_events_url": "https://api.github.com/users/ywk253100/received_events",
    "repos_url": "https://api.github.com/users/ywk253100/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ywk253100/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ywk253100/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ywk253100"
  },
  "comments": 10,
  "comments_url": "https://api.github.com/repos/goharbor/harbor/issues/10305/comments",
  "created_at": "2019-12-18T07:42:59Z",
  "events_url": "https://api.github.com/repos/goharbor/harbor/issues/10305/events",
  "html_url": "https://github.com/goharbor/harbor/issues/10305",
  "id": 539511759,
  "labels": [
    {
      "color": "ead248",
      "default": false,
      "description": "The issue happens when using containerd to interact with Harbor",
      "id": 1742588413,
      "name": "runtime/containerd",
      "node_id": "MDU6TGFiZWwxNzQyNTg4NDEz",
      "url": "https://api.github.com/repos/goharbor/harbor/labels/runtime/containerd"
    },
    {
      "color": "d93f0b",
      "default": false,
      "description": "",
      "id": 1727687225,
      "name": "target/1.10.1",
      "node_id": "MDU6TGFiZWwxNzI3Njg3MjI1",
      "url": "https://api.github.com/repos/goharbor/harbor/labels/target/1.10.1"
    },
    {
      "color": "d93f0b",
      "default": false,
      "description": "",
      "id": 1677807541,
      "name": "target/1.9.4",
      "node_id": "MDU6TGFiZWwxNjc3ODA3NTQx",
      "url": "https://api.github.com/repos/goharbor/harbor/labels/target/1.9.4"
    },
    {
      "color": "d93f0b",
      "default": false,
      "description": "",
      "id": 1551398970,
      "name": "target/2.0.0",
      "node_id": "MDU6TGFiZWwxNTUxMzk4OTcw",
      "url": "https://api.github.com/repos/goharbor/harbor/labels/target/2.0.0"
    }
  ],
  "labels_url": "https://api.github.com/repos/goharbor/harbor/issues/10305/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-02-10T19:48:17Z",
    "closed_issues": 12,
    "created_at": "2019-09-09T07:52:39Z",
    "creator": {
      "avatar_url": "https://avatars0.githubusercontent.com/u/2390463?v=4",
      "events_url": "https://api.github.com/users/reasonerjt/events{/privacy}",
      "followers_url": "https://api.github.com/users/reasonerjt/followers",
      "following_url": "https://api.github.com/users/reasonerjt/following{/other_user}",
      "gists_url": "https://api.github.com/users/reasonerjt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/reasonerjt",
      "id": 2390463,
      "login": "reasonerjt",
      "node_id": "MDQ6VXNlcjIzOTA0NjM=",
      "organizations_url": "https://api.github.com/users/reasonerjt/orgs",
      "received_events_url": "https://api.github.com/users/reasonerjt/received_events",
      "repos_url": "https://api.github.com/users/reasonerjt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/reasonerjt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/reasonerjt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/reasonerjt"
    },
    "description": "",
    "due_on": "2019-12-31T08:00:00Z",
    "html_url": "https://github.com/goharbor/harbor/milestone/77",
    "id": 4643244,
    "labels_url": "https://api.github.com/repos/goharbor/harbor/milestones/77/labels",
    "node_id": "MDk6TWlsZXN0b25lNDY0MzI0NA==",
    "number": 77,
    "open_issues": 0,
    "state": "closed",
    "title": "Sprint 76",
    "updated_at": "2020-02-10T19:48:17Z",
    "url": "https://api.github.com/repos/goharbor/harbor/milestones/77"
  },
  "node_id": "MDU6SXNzdWU1Mzk1MTE3NTk=",
  "number": 10305,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/goharbor/harbor",
  "state": "closed",
  "title": "Containerd coudn't pull private image from harbor 1.9.3",
  "updated_at": "2020-03-02T13:42:55Z",
  "url": "https://api.github.com/repos/goharbor/harbor/issues/10305",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/17597567?v=4",
    "events_url": "https://api.github.com/users/xpflying/events{/privacy}",
    "followers_url": "https://api.github.com/users/xpflying/followers",
    "following_url": "https://api.github.com/users/xpflying/following{/other_user}",
    "gists_url": "https://api.github.com/users/xpflying/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/xpflying",
    "id": 17597567,
    "login": "xpflying",
    "node_id": "MDQ6VXNlcjE3NTk3NTY3",
    "organizations_url": "https://api.github.com/users/xpflying/orgs",
    "received_events_url": "https://api.github.com/users/xpflying/received_events",
    "repos_url": "https://api.github.com/users/xpflying/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/xpflying/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/xpflying/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/xpflying"
  }
}