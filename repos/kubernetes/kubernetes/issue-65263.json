{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- This form is for bug reports and feature requests ONLY!\r\n\r\nIf you're looking for help check [Stack Overflow](https://stackoverflow.com/questions/tagged/kubernetes) and the [troubleshooting guide](https://kubernetes.io/docs/tasks/debug-application-cluster/troubleshooting/).\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/.\r\n-->\r\n\r\n**Is this a BUG REPORT or FEATURE REQUEST?**:\r\n\r\n\r\n/kind bug\r\n\r\n\r\n**What happened**:\r\nIn kube-proxy IPVS mode, for every round of sync, kube-proxy will clean legacy service, and unbind legacy address from kube-ipvs0.  \r\nBut if there is a multi-port service, e.g\r\n```\r\nNAME         CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE       SELECTOR\r\nnginx        10.103.82.170   <nodes>       443:30393/TCP,80:30515/TCP   31m       app=nginx\r\n\r\n```\r\nand we update this service to a single-port service, e.g\r\n```\r\nNAME         CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE       SELECTOR\r\nnginx        10.103.82.170   <nodes>       80:30515/TCP   6s        app=nginx\r\n\r\n```\r\n\r\nwe will see address `10.103.82.170` unbind from kube-ipvs0, because in function `cleanLegacyService`, we delete service `nginx:443:TCP` and unbind service ip `10.103.82.170` at the same time.  \r\nThis is unexpected!\r\n\r\n\r\n**What you expected to happen**:\r\n\r\nshould not unbind service address when update a multi-port service\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nTo effectively reproduce it, we need to set two kube-proxy flags as an appropriate number. e.g\r\n```\r\n--ipvs-min-sync-period=2m\r\n--ipvs-sync-period=5m\r\n```\r\nbecause kube-proxy could resync very quickly (30s by default),  service address could bind in the next round of sync\r\n\r\n1. create a service with multi-port\r\n```\r\nNAME         CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE       SELECTOR\r\nnginx        10.103.82.170   <nodes>       443:30393/TCP,80:30515/TCP   31m       app=nginx\r\n\r\n```\r\n2. check ipvs and ip addr status\r\n```\r\n$ ipvsadm -ln | grep 10.103.82.170\r\nTCP  10.103.82.170:80 rr\r\nTCP  10.103.82.170:443 rr\r\n\r\n$ ip addr show kube-ipvs0 | grep 10.103.82.170\r\n    inet 10.103.82.170/32 brd 10.103.82.170 scope global kube-ipvs0\r\n\r\n```\r\n3. update service to single-port\r\n```\r\nNAME         CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE       SELECTOR\r\nnginx        10.103.82.170   <nodes>       80:30515/TCP   6s        app=nginx\r\n```\r\n\r\n4. check ipvs and ip addr status, will see service `nginx:443:TCP` deleted from ipvs, but address `10.103.82.170` also unbound\r\n```\r\n$ ipvsadm -ln | grep 10.103.82.170\r\nTCP  10.103.82.170:80 rr\r\n\r\n$ ip addr show kube-ipvs0 | grep 10.103.82.170\r\n```\r\n\r\n**Anything else we need to know?**:\r\n\r\nThe point of the issue is: if a service has two ports, ipvs will think there are two services. But they share the same clusterIP.  \r\nSo, we could not directly unbind clusterIP after clean legacy ipvs service.  \r\nA fix solution is like `cleanLegacyService`, we use an `activeBindAddrs` map and a `currentBindAddr` map. And unbind address which is in `currentBindAddr` map but not active\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): newest\r\n- Cloud provider or hardware configuration:\r\n- OS (e.g. from /etc/os-release): Ubuntu 16.04.3\r\n- Kernel (e.g. `uname -a`): 4.4.0-62-generic\r\n- Install tools:\r\n- Others:\r\n\r\n/sig network\r\n/area kube-proxy\r\n",
  "closed_at": "2018-07-06T12:54:40Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/65263/comments",
  "created_at": "2018-06-20T09:05:25Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/65263/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/65263",
  "id": 333986975,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 128716589,
      "name": "area/kube-proxy",
      "node_id": "MDU6TGFiZWwxMjg3MTY1ODk=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/kube-proxy"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Network.",
      "id": 116712108,
      "name": "sig/network",
      "node_id": "MDU6TGFiZWwxMTY3MTIxMDg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/network"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/65263/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMzM5ODY5NzU=",
  "number": 65263,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kube-proxy IPVS: wrongly unbind addr when update a multi-port service",
  "updated_at": "2018-07-06T12:54:40Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/65263",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/27760600?v=4",
    "events_url": "https://api.github.com/users/xujieasd/events{/privacy}",
    "followers_url": "https://api.github.com/users/xujieasd/followers",
    "following_url": "https://api.github.com/users/xujieasd/following{/other_user}",
    "gists_url": "https://api.github.com/users/xujieasd/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/xujieasd",
    "id": 27760600,
    "login": "xujieasd",
    "node_id": "MDQ6VXNlcjI3NzYwNjAw",
    "organizations_url": "https://api.github.com/users/xujieasd/orgs",
    "received_events_url": "https://api.github.com/users/xujieasd/received_events",
    "repos_url": "https://api.github.com/users/xujieasd/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/xujieasd/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/xujieasd/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/xujieasd"
  }
}