{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Thanks for filing an issue! Before hitting the button, please answer these questions.-->\n\n**Is this a request for help?** (If yes, you should use our troubleshooting guide and community support channels, see http://kubernetes.io/docs/troubleshooting/.): No\n\n**What keywords did you search in Kubernetes issues before filing this one?** (If you have found any duplicates, you should instead reply there.): panic thirdpartyresourcedata\n\n---\n\n**Is this a BUG REPORT or FEATURE REQUEST?** (choose one): BUG REPORT\n\n<!--\nIf this is a BUG REPORT, please:\n  - Fill in as much of the template below as you can.  If you leave out\n    information, we can't help you as well.\n\nIf this is a FEATURE REQUEST, please:\n  - Describe *in detail* the feature/behavior/change you'd like to see.\n\nIn both cases, be ready for followup questions, and please respond in a timely\nmanner.  If we can't reproduce a bug or think a feature already exists, we\nmight close your issue.  If we're wrong, PLEASE feel free to reopen it and\nexplain why.\n-->\n\n**Kubernetes version** (use `kubectl version`):\n\n```\nClient Version: version.Info{Major:\"1\", Minor:\"4\", GitVersion:\"v1.4.0\", GitCommit:\"a16c0a7f71a6f93c7e0f222d961f4675cd97a46b\", GitTreeState:\"clean\", BuildDate:\"2016-09-26T18:16:57Z\", GoVersion:\"go1.6.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\nServer Version: version.Info{Major:\"1\", Minor:\"4\", GitVersion:\"v1.4.0+coreos.0\", GitCommit:\"278a1f7034bdba61cba443722647da1a8204a6fc\", GitTreeState:\"clean\", BuildDate:\"2016-09-26T20:48:37Z\", GoVersion:\"go1.6.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n```\n\nAlso present in current master\n\n**What happened**:\nAs part of attempt to support third party resources in kubernetes/helm#1295, I've found that the default client attempts a weird patch behaviour:\n\n```\nPATCH /apis/stable.k8s.psg.io/v1/namespaces/hello-world/certificates/hello-world HTTP/1.1\nHost: localhost:8080\nUser-Agent: tiller/v1.4.1 (linux/amd64) kubernetes/$Format\nContent-Length: 388\nAccept: application/json, */*\nContent-Type: application/strategic-merge-patch+json\nAccept-Encoding: gzip\n\n{\"data\":\"eyJhcGlWZXJzaW9uIjoic3RhYmxlLms4cy5wc2cuaW8vdjEiLCJraW5kIjoiQ2VydGlmaWNhdGUiLCJtZXRhZGF0YSI6eyJuYW1lIjoiaGVsbG8td29ybGQifSwic3BlYyI6eyJkb21haW4iOiJoZWxsby13b3JsZC5rOHMuZXUtd2VzdC0xLmF3cy5zaGQuZGV2Lmxhc3RtaWxlLmNvbSIsImVtYWlsIjoibStoZWxsby13b3JsZEBvY2Fkby5jb20iLCJwcm92aWRlciI6InJvdXRlNTMifX0=\",\"kind\":\"ThirdPartyResourceData\",\"metadata\":{\"labels\":null},\"spec\":null,\"status\":null}\n```\n\nThis causes kube-apiserver to panic:\n\n```\nI1010 16:04:50.014030       1 handlers.go:162] GET /apis/stable.k8s.psg.io/v1/namespaces/hello-world/certificates/hello-world: (1.486244ms) 200 [[tiller/v1.4.1 (linux/amd64) kubernetes/$Format] 127.0.0.1:53188]\nE1010 16:04:50.033872       1 runtime.go:64] Observed a panic: \"invalid memory address or nil pointer dereference\" (runtime error: invalid memory address or nil pointer dereference)\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/util/runtime/runtime.go:70\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/util/runtime/runtime.go:63\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/util/runtime/runtime.go:49\n/usr/local/go/src/runtime/asm_amd64.s:472\n/usr/local/go/src/runtime/panic.go:443\n/usr/local/go/src/runtime/panic.go:62\n/usr/local/go/src/runtime/sigpanic_unix.go:24\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/registry/thirdpartyresourcedata/codec.go:421\n<autogenerated>:5\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/runtime/codec.go:60\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/apiserver/resthandler.go:573\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/api/rest/update.go:177\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/registry/generic/registry/store.go:355\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/storage/etcd/etcd_helper.go:462\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/registry/generic/registry/store.go:431\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/apiserver/resthandler.go:645\n/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/apiserver/resthandler.go:953\n/usr/local/go/src/runtime/asm_amd64.s:1998\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\n    panic: runtime error: invalid memory address or nil pointer dereference\n[signal 0xb code=0x1 addr=0x0 pc=0x15e2192]\n\ngoroutine 1212 [running]:\npanic(0x4475c00, 0xc820016070)\n    /usr/local/go/src/runtime/panic.go:481 +0x3e6\nk8s.io/kubernetes/pkg/util/runtime.HandleCrash(0xc8223d3ef8, 0x1, 0x1)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/util/runtime/runtime.go:56 +0x153\npanic(0x4475c00, 0xc820016070)\n    /usr/local/go/src/runtime/panic.go:443 +0x4e9\nk8s.io/kubernetes/pkg/registry/thirdpartyresourcedata.(*thirdPartyResourceDataDecoder).Decode(0xc821509740, 0xc821735880, 0x223, 0x35c, 0x0, 0x7fbdf5c06130, 0xc822bdc480, 0x0, 0x0, 0x10739d9, ...)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/registry/thirdpartyresourcedata/codec.go:421 +0x1dc2\nk8s.io/kubernetes/pkg/runtime.(*codec).Decode(0xc821509760, 0xc821735880, 0x223, 0x35c, 0x0, 0x7fbdf5c06130, 0xc822bdc480, 0x0, 0x0, 0xc8226a2900, ...)\n    <autogenerated>:5 +0xca\nk8s.io/kubernetes/pkg/runtime.DecodeInto(0x7fbdf5bc4f88, 0xc821509760, 0xc821735880, 0x223, 0x35c, 0x7fbdf5c06130, 0xc822bdc480, 0x0, 0x0)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/runtime/codec.go:60 +0x98\nk8s.io/kubernetes/pkg/apiserver.patchResource.func1(0x7fbdf5c46f90, 0xc822ba05d0, 0x0, 0x0, 0x7fbdf5c06130, 0xc822ed5680, 0x0, 0x0, 0x0, 0x0)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/apiserver/resthandler.go:573 +0x11f7\nk8s.io/kubernetes/pkg/api/rest.(*defaultUpdatedObjectInfo).UpdatedObject(0xc822ba6240, 0x7fbdf5c46f90, 0xc822ba05d0, 0x7fbdf5c06130, 0xc822ed5680, 0x0, 0x0, 0x0, 0x0)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/api/rest/update.go:177 +0x1aa\nk8s.io/kubernetes/pkg/registry/generic/registry.(*Store).Update.func1(0x7fbdf5c06130, 0xc822ed5680, 0x0, 0x57846d, 0x0, 0x0, 0x0, 0x0, 0x0)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/registry/generic/registry/store.go:355 +0x10d\nk8s.io/kubernetes/pkg/storage/etcd.(*etcdHelper).GuaranteedUpdate(0xc8201cd700, 0x7fbdf5c46f50, 0xc822ba05d0, 0xc822ba2ae0, 0x57, 0x7fbdf5c06130, 0xc822ed5560, 0x1, 0xc820028af8, 0xc822bcc000, ...)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/storage/etcd/etcd_helper.go:462 +0x49e\nk8s.io/kubernetes/pkg/registry/generic/registry.(*Store).Update(0xc82018b5e0, 0x7fbdf5c46f90, 0xc822ba05d0, 0xc822ba2645, 0xb, 0x7fbdf5bd9b70, 0xc822ba6240, 0x0, 0x0, 0x40a100, ...)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/registry/generic/registry/store.go:431 +0x401\nk8s.io/kubernetes/pkg/apiserver.patchResource.func3(0x0, 0x0, 0x0, 0x0)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/apiserver/resthandler.go:645 +0xda\nk8s.io/kubernetes/pkg/apiserver.finishRequest.func1(0xc822ba2900, 0xc822ea88c0, 0xc822ba28a0, 0xc822ba2840)\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/apiserver/resthandler.go:953 +0xd9\ncreated by k8s.io/kubernetes/pkg/apiserver.finishRequest\n    /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/pkg/apiserver/resthandler.go:958 +0xf1\nm@hotcpc17686:/export/home/m/go/src/k8s.io/kubernetes$\n\n```\n\n**What you expected to happen**:\nNo panic. I suspect this behaviour shouldn't work anyway, but it should return an error rather than letting a user crash the apiserver at-will.\n\n**How to reproduce it** (as minimally and precisely as possible):\n- Use a third party resource such as the Certificate one from https://github.com/PalmStoneGames/kube-cert-manager\n- Create a resource\n- Patch it with something like the following: \n\n```\n{\"data\":\"eyJhcGlWZXJzaW9uIjoic3RhYmxlLms4cy5wc2cuaW8vdjEiLCJraW5kIjoiQ2VydGlmaWNhdGUiLCJtZXRhZGF0YSI6eyJuYW1lIjoiaGVsbG8td29ybGQifSwic3BlYyI6eyJkb21haW4iOiJoZWxsby13b3JsZC5rOHMuZXUtd2VzdC0xLmF3cy5zaGQuZGV2Lmxhc3RtaWxlLmNvbSIsImVtYWlsIjoibStoZWxsby13b3JsZEBvY2Fkby5jb20iLCJwcm92aWRlciI6InJvdXRlNTMifX0=\"\n,\"kind\":\"ThirdPartyResourceData\"}\n```\n\n**Anything else do we need to know**:\nPR to follow with a test case, no fix yet\n",
  "closed_at": "2016-10-10T23:20:37Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/34459/comments",
  "created_at": "2016-10-10T17:21:14Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/34459/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/34459",
  "id": 182069099,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 136601536,
      "name": "area/apiserver",
      "node_id": "MDU6TGFiZWwxMzY2MDE1MzY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/apiserver"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/34459/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxODIwNjkwOTk=",
  "number": 34459,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Panic in thirdpartyresourcedata/codec.go",
  "updated_at": "2016-10-10T23:20:37Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/34459",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1478103?v=4",
    "events_url": "https://api.github.com/users/mikebryant/events{/privacy}",
    "followers_url": "https://api.github.com/users/mikebryant/followers",
    "following_url": "https://api.github.com/users/mikebryant/following{/other_user}",
    "gists_url": "https://api.github.com/users/mikebryant/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mikebryant",
    "id": 1478103,
    "login": "mikebryant",
    "node_id": "MDQ6VXNlcjE0NzgxMDM=",
    "organizations_url": "https://api.github.com/users/mikebryant/orgs",
    "received_events_url": "https://api.github.com/users/mikebryant/received_events",
    "repos_url": "https://api.github.com/users/mikebryant/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mikebryant/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mikebryant/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mikebryant"
  }
}