{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "Some mount propagation magic in Kubernetes on Ubuntu 16.04 on GCE duplicates every mount.\r\n\r\n```\r\n/dev/sdb on /var/lib/kubelet/plugins/kubernetes.io/gce-pd/mounts/jsafrane-e2e-dynamic-pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n/dev/sdb on /var/lib/kubelet/plugins/kubernetes.io/gce-pd/mounts/jsafrane-e2e-dynamic-pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n```\r\n\r\n**Steps to reproduce**:\r\nOn recent master. install Kubernetes on GCE on Ubuntu:\r\n\r\n```\r\nKUBE_GCE_NODE_IMAGE=ubuntu-gke-1604-xenial-v20170816-1 KUBE_GCE_NODE_PROJECT=ubuntu-os-gke-cloud KUBE_NODE_OS_DISTRIBUTION=ubuntu NUM_NODES=1 cluster/kube-up.sh\r\n```\r\n\r\nRun a pod with a GCE PD volume:\r\n```shell\r\n$ kubectl create -f - <<EOF\r\nkind: PersistentVolumeClaim\r\napiVersion: v1\r\nmetadata:\r\n  name: myclaim\r\nspec:\r\n  accessModes:\r\n    - ReadWriteOnce\r\n  resources:\r\n    requests:\r\n      storage: 3500Mi\r\nEOF\r\n\r\n$ kubectl create -f - <<EOF\r\napiVersion: v1\r\nkind: Pod\r\nmetadata:\r\n  name: testpod\r\n  labels:\r\n    name: test\r\nspec:\r\n  restartPolicy: Never\r\n  containers:\r\n    - image: gcr.io/google_containers/busybox\r\n      command:\r\n        - \"/bin/sh\"\r\n        - \"-c\"\r\n        - \"while true; do date; sleep 1; done\"\r\n      name: busybox\r\n      volumeMounts:\r\n        - name: vol\r\n          mountPath: /mnt/test\r\n  volumes:\r\n      - name: vol\r\n        persistentVolumeClaim:\r\n          claimName: myclaim\r\nEOF\r\n```\r\n\r\nThe volume looks like it's mounted twice in `mount` output on the node:\r\n```\r\n$ mount\r\n/dev/sdb on /var/lib/kubelet/plugins/kubernetes.io/gce-pd/mounts/jsafrane-e2e-dynamic-pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n/dev/sdb on /var/lib/kubelet/plugins/kubernetes.io/gce-pd/mounts/jsafrane-e2e-dynamic-pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n/dev/sdb on /home/kubernetes/containerized_mounter/rootfs/var/lib/kubelet/plugins/kubernetes.io/gce-pd/mounts/jsafrane-e2e-dynamic-pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n/dev/sdb on /home/kubernetes/containerized_mounter/rootfs/var/lib/kubelet/plugins/kubernetes.io/gce-pd/mounts/jsafrane-e2e-dynamic-pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n/dev/sdb on /var/lib/kubelet/pods/72af9e0a-d6ab-11e7-ae65-42010a800002/volumes/kubernetes.io~gce-pd/pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n/dev/sdb on /var/lib/kubelet/pods/72af9e0a-d6ab-11e7-ae65-42010a800002/volumes/kubernetes.io~gce-pd/pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n/dev/sdb on /home/kubernetes/containerized_mounter/rootfs/var/lib/kubelet/pods/72af9e0a-d6ab-11e7-ae65-42010a800002/volumes/kubernetes.io~gce-pd/pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n/dev/sdb on /home/kubernetes/containerized_mounter/rootfs/var/lib/kubelet/pods/72af9e0a-d6ab-11e7-ae65-42010a800002/volumes/kubernetes.io~gce-pd/pvc-6a52f546-d6ab-11e7-ae65-42010a800002 type ext4 (rw,relatime,data=ordered)\r\n```\r\n\r\nDeleting this pod will unmount everything correctly in GCE PD case, however it won't unmount Ceph RBD:\r\n\r\n```\r\nOperation for \"\\\"kubernetes.io/rbd/[10.64.0.17]:foo\\\"\" failed. \r\nrbd: more than 1 reference counts at /var/lib/kubelet/plugins/kubernetes.io/rbd/rbd/rbd-image-foo\r\n```\r\n\r\nThere seems to be some bind-mount && rshared propagation magic happening in Google's helper mounter container that makes a mount appear twice. Note that MountPropagation and MountContainers are disabled in this cluster, so it can't be the culprit.\r\n\r\nI can probably fix reference counting in RBD, however this doubling of mounts looks very ugly and may have other consequences than just failed RBD teardown.\r\n\r\n/kind bug\r\n/sig storage\r\n@kubernetes/sig-storage-bugs \r\n",
  "closed_at": "2018-05-13T19:20:50Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 8,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/56704/comments",
  "created_at": "2017-12-01T15:41:31Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/56704/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/56704",
  "id": 278505672,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "604460",
      "default": false,
      "description": "Denotes an issue or PR that has aged beyond stale and will be auto-closed.",
      "id": 778118402,
      "name": "lifecycle/rotten",
      "node_id": "MDU6TGFiZWw3NzgxMTg0MDI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/lifecycle/rotten"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Storage.",
      "id": 169428334,
      "name": "sig/storage",
      "node_id": "MDU6TGFiZWwxNjk0MjgzMzQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/storage"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/56704/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyNzg1MDU2NzI=",
  "number": 56704,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Double mounts on cluster created by kube-up.sh on Ubuntu",
  "updated_at": "2018-05-23T08:40:34Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/56704",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1745006?v=4",
    "events_url": "https://api.github.com/users/jsafrane/events{/privacy}",
    "followers_url": "https://api.github.com/users/jsafrane/followers",
    "following_url": "https://api.github.com/users/jsafrane/following{/other_user}",
    "gists_url": "https://api.github.com/users/jsafrane/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jsafrane",
    "id": 1745006,
    "login": "jsafrane",
    "node_id": "MDQ6VXNlcjE3NDUwMDY=",
    "organizations_url": "https://api.github.com/users/jsafrane/orgs",
    "received_events_url": "https://api.github.com/users/jsafrane/received_events",
    "repos_url": "https://api.github.com/users/jsafrane/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jsafrane/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jsafrane/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jsafrane"
  }
}