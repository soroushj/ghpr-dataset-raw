{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\nWhen using kubectl, authentication fails with the below error\r\n`E0331 10:18:17.205561   46266 azure.go:154] Failed to acquire a token: refreshing the expired token: refreshing token: adal: Refresh request failed. Status Code = '400'. Response body: {\"error\":\"invalid_resource\",\"error_description\":\"AADSTS500011: The resource principal named spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:**spn** was not found in the tenant named **tenant ID**. This can happen if the application has not been installed by the administrator of the tenant or consented to by any user in the tenant. You might have sent your authentication request to the wrong tenant.\\r\\nTrace ID: **trace ID**\\r\\nCorrelation ID: **correlation ID**\\r\\nTimestamp: 2020-03-30 23:18:17Z\",\"error_codes\":[500011],\"timestamp\":\"2020-03-30 23:18:17Z\",\"trace_id\":\"**trace ID**\",\"correlation_id\":\"**correlation ID**\",\"error_uri\":\"https://login.microsoftonline.com/error?code=500011\"}`\r\n\r\nFor some reason kubectl is adding a lot of `spn:`s to the start of the SPN - this can be observed in ~/.kube/config:\r\n```users:\r\n- name: azure-active-directory\r\n  user:\r\n    auth-provider:\r\n      config:\r\n        apiserver-id: spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:spn:**SPN**\r\n```\r\n\r\n**What you expected to happen**:\r\nAuthentication works as in previous versions of Kubectl\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nCreate a cluster using Azure AD authentication. Authenticate from a client and wait until the token expires. Use Kubectl and have it automatically refresh the token; it will fail due to the extra 'spn:' entries.\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n- Cloud provider or hardware configuration: on-premise\r\n- OS (e.g: `cat /etc/os-release`): macOS 10.14.6\r\n- Kernel (e.g. `uname -a`): Darwin Hostname 18.7.0 Darwin Kernel Version 18.7.0: Mon Feb 10 21:08:45 PST 2020; root:xnu-4903.278.28~1/RELEASE_X86_64 x86_64\r\n- Install tools: N/A\r\n- Network plugin and version (if this is a network-related bug): N/A\r\n- Others:\r\n",
  "closed_at": "2020-04-02T02:26:39Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 14,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/89672/comments",
  "created_at": "2020-03-30T23:23:37Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/89672/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/89672",
  "id": 590665847,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Issues or PRs related to azure provider",
      "id": 852130786,
      "name": "area/provider/azure",
      "node_id": "MDU6TGFiZWw4NTIxMzA3ODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/provider/azure"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a regression from a prior release.",
      "id": 1967276560,
      "name": "kind/regression",
      "node_id": "MDU6TGFiZWwxOTY3Mjc2NTYw",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/regression"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Auth.",
      "id": 357119284,
      "name": "sig/auth",
      "node_id": "MDU6TGFiZWwzNTcxMTkyODQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/auth"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG CLI.",
      "id": 450823910,
      "name": "sig/cli",
      "node_id": "MDU6TGFiZWw0NTA4MjM5MTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cli"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/89672/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": null,
    "closed_issues": 1767,
    "created_at": "2019-01-31T15:17:22Z",
    "creator": {
      "avatar_url": "https://avatars0.githubusercontent.com/u/980082?v=4",
      "events_url": "https://api.github.com/users/liggitt/events{/privacy}",
      "followers_url": "https://api.github.com/users/liggitt/followers",
      "following_url": "https://api.github.com/users/liggitt/following{/other_user}",
      "gists_url": "https://api.github.com/users/liggitt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/liggitt",
      "id": 980082,
      "login": "liggitt",
      "node_id": "MDQ6VXNlcjk4MDA4Mg==",
      "organizations_url": "https://api.github.com/users/liggitt/orgs",
      "received_events_url": "https://api.github.com/users/liggitt/received_events",
      "repos_url": "https://api.github.com/users/liggitt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/liggitt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/liggitt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/liggitt"
    },
    "description": null,
    "due_on": null,
    "html_url": "https://github.com/kubernetes/kubernetes/milestone/44",
    "id": 4018465,
    "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/44/labels",
    "node_id": "MDk6TWlsZXN0b25lNDAxODQ2NQ==",
    "number": 44,
    "open_issues": 21,
    "state": "open",
    "title": "v1.18",
    "updated_at": "2020-10-27T18:36:18Z",
    "url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/44"
  },
  "node_id": "MDU6SXNzdWU1OTA2NjU4NDc=",
  "number": 89672,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Kubectl - Azure AD authentication adds excessive 'spn:' to SPN",
  "updated_at": "2020-10-26T12:35:34Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/89672",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/159321?v=4",
    "events_url": "https://api.github.com/users/alastairpat/events{/privacy}",
    "followers_url": "https://api.github.com/users/alastairpat/followers",
    "following_url": "https://api.github.com/users/alastairpat/following{/other_user}",
    "gists_url": "https://api.github.com/users/alastairpat/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alastairpat",
    "id": 159321,
    "login": "alastairpat",
    "node_id": "MDQ6VXNlcjE1OTMyMQ==",
    "organizations_url": "https://api.github.com/users/alastairpat/orgs",
    "received_events_url": "https://api.github.com/users/alastairpat/received_events",
    "repos_url": "https://api.github.com/users/alastairpat/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alastairpat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alastairpat/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alastairpat"
  }
}