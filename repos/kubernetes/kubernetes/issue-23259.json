{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/7062400?v=4",
    "events_url": "https://api.github.com/users/rootfs/events{/privacy}",
    "followers_url": "https://api.github.com/users/rootfs/followers",
    "following_url": "https://api.github.com/users/rootfs/following{/other_user}",
    "gists_url": "https://api.github.com/users/rootfs/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rootfs",
    "id": 7062400,
    "login": "rootfs",
    "node_id": "MDQ6VXNlcjcwNjI0MDA=",
    "organizations_url": "https://api.github.com/users/rootfs/orgs",
    "received_events_url": "https://api.github.com/users/rootfs/received_events",
    "repos_url": "https://api.github.com/users/rootfs/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rootfs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rootfs/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rootfs"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/7062400?v=4",
      "events_url": "https://api.github.com/users/rootfs/events{/privacy}",
      "followers_url": "https://api.github.com/users/rootfs/followers",
      "following_url": "https://api.github.com/users/rootfs/following{/other_user}",
      "gists_url": "https://api.github.com/users/rootfs/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rootfs",
      "id": 7062400,
      "login": "rootfs",
      "node_id": "MDQ6VXNlcjcwNjI0MDA=",
      "organizations_url": "https://api.github.com/users/rootfs/orgs",
      "received_events_url": "https://api.github.com/users/rootfs/received_events",
      "repos_url": "https://api.github.com/users/rootfs/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rootfs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rootfs/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rootfs"
    }
  ],
  "author_association": "NONE",
  "body": "With this I want to track and share thoughts about introducing the ability to provide support to attach a vhd as a volume on MS Azure. \n\nWith the recent kubernetes v1.2.0 the ability to use Azure File System as a volume was introduced. I recently gave it a try on a cluster running on CoreOS and with some workaround (see https://github.com/coreos/bugs/issues/571 and https://github.com/coreos/bugs/issues/358) it seems to work. However Azure File Service has a lot of limitations (see https://msdn.microsoft.com/en-us/library/azure/dn744326.aspx ) that prevent to use it in many use cases.\n### Intro\n\nIn Azure we can attach a persistence disk to a vm. This is more or less equal to what happens when you attach a Persistence Disk on GCE to vm or what happens when you attach an EBS volume to a ec2 instance on AWS. When you attach a vhd to a vm a new device is created in /dev and then you can perform operations like format and mount; attaching and detaching a vhd does not require to perform a reboot. Persistence disks in Azure are VHDs. You can create them, attach and do other operations via REST API. VHDs are saved as `page blobs` in an Azure Storage Account, inside a blob container (see https://azure.microsoft.com/en-us/documentation/articles/storage-introduction/ ). In Azure you can attach a vhd to a single vm. So using a vhd as volume would work like attaching to a pod a gcePersistentDisk or  awsElasticBlockStore and it would have more or less the same limitations, including:\n- the nodes on which pods are running must be Azure VMs\n- those VMs need to be in the same location as the VHDs\n- using a vhd on a pod controlled by a ReplicationController will fail unless the replica count is 0 or 1\n- you can bind a volume backed by a vhd to a single pod, both in reading and writing\n\nThese limitations are due to the fact that, as reported before, you can attach a vhd to a single vm. VHDs are mounted on a vm filesystem, and the volume associated to this filesystem must be bound to a pod running on the same vm. Hypothetically pods running in the same node could share the same volume both in reading and writing, but this is a complicated and not so useful scenario.\n### Work to do\n\nAdd in `kubernetes/pkg/volume/azure_vhd/` the following:\n- `kubernetes/pkg/volume/azure_vhd/azure_vhd.go`\n- `kubernetes/pkg/volume/azure_vhd/azure_vhd_test.go`\n- `kubernetes/pkg/volume/azure_vhd/azure_util.go`\n- `kubernetes/pkg/volume/azure_vhd/doc.go`\n\nYou can see code in `kubernetes/pkg/volume/`, specially `kubernetes/pkg/volume/aws_ebs/` and `kubernetes/pkg/volume/gce_pd/` since the idea is the same.\nBasically the code must call Azure api to attach the vhd to the node where the pod is scheduled, mount the filesystem on that vm and share the volume with the running container. Cloud provider logic is detached from volume code, files are in `kubernetes/pkg/cloudprovider/providers/`, so stuff in  `kubernetes/pkg/cloudprovider/providers/azure` must be added and then used from files listed above. The idea is that credentials to call Azure API must be provided to masters in the cluster. This can be achieved by creating a `service principal` (see https://azure.microsoft.com/en-us/documentation/articles/resource-group-authenticate-service-principal/) and let it access resources in the subscription where the kube cluster resides. Azure SDK for go is here https://github.com/Azure/azure-sdk-for-go . The package to use is `arm/compute`. Use [`func (VirtualMachinesClient) CreateOrUpdate`](https://godoc.org/github.com/Azure/azure-sdk-for-go/arm/compute#VirtualMachinesClient.CreateOrUpdate) to update the vm passing appropriate params `VirtualMachine -> VirtualMachineProperties  -> StorageProfile -> DataDisk -> VirtualHardDisk` .\n\nAn example pod would be like:\n\n```\napiVersion: v1\nkind: Pod\nmetadata:\n  name: test-vhd\nspec:\n  containers:\n  - image: gcr.io/google_containers/test-webserver\n    name: test-container\n    volumeMounts:\n    - mountPath: /test-vhd\n      name: test-volume\n  volumes:\n  - name: test-volume\n    # This Azure VHD must already exist.\n    azureVhd:\n      vhdUrl: https://myblobst.blob.core.windows.net/pdisks/c1.vhd\n      fsType: ext4\n```\n\nPlease comment and share your thoughts.\nFeel free to point out if I'm missing something or if I'm wrong.\n\nCiao,\nCarlo\n",
  "closed_at": "2016-08-24T09:49:55Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/23259/comments",
  "created_at": "2016-03-20T17:30:48Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/23259/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/23259",
  "id": 142184093,
  "labels": [],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/23259/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxNDIxODQwOTM=",
  "number": 23259,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Provide support to attach a vhd as volume on Microsoft Azure",
  "updated_at": "2016-08-24T09:49:55Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/23259",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/2183293?v=4",
    "events_url": "https://api.github.com/users/colrack/events{/privacy}",
    "followers_url": "https://api.github.com/users/colrack/followers",
    "following_url": "https://api.github.com/users/colrack/following{/other_user}",
    "gists_url": "https://api.github.com/users/colrack/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/colrack",
    "id": 2183293,
    "login": "colrack",
    "node_id": "MDQ6VXNlcjIxODMyOTM=",
    "organizations_url": "https://api.github.com/users/colrack/orgs",
    "received_events_url": "https://api.github.com/users/colrack/received_events",
    "repos_url": "https://api.github.com/users/colrack/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/colrack/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/colrack/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/colrack"
  }
}