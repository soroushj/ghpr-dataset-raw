{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "---\r\nAWS has a rate limit of 1 ECR auth token per second per account. For kubernetes cluster with many nodes and using ECR as its primary registry its not unlikely for the kubelet to get throttled. \r\n```\r\naws_credentials.go:199] while requesting ECR authorization token ThrottlingException: Rate exceeded\r\n```\r\nAfter digging through some of the code in the [aws_credentials.go](https://github.com/kubernetes/kubernetes/blob/master/pkg/credentialprovider/aws/aws_credentials.go)  (and please correct me if I'm wrong) it seems like the kubelet does not implement any retry logic for getting the ECR token which leaves that worker node completely useless until the expiration time for the token (11 hours and 55 minutes). The only way to trigger another fetch is to restart the kublet. The kubelet should either block until the token is acquired OR execute some retry loop in a separate goroutine. \r\n\r\n\r\n**Kubernetes version** (use `kubectl version`):\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"4\", GitVersion:\"v1.4.4\", GitCommit:\"3b417cc4ccd1b8f38ff9ec96bb50a81ca0ea9d56\", GitTreeState:\"clean\", BuildDate:\"2016-10-21T02:48:38Z\", GoVersion:\"go1.7.1\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"4\", GitVersion:\"v1.4.4\", GitCommit:\"3b417cc4ccd1b8f38ff9ec96bb50a81ca0ea9d56\", GitTreeState:\"clean\", BuildDate:\"2016-10-21T02:42:39Z\", GoVersion:\"go1.6.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n\r\n**Environment**:\r\n- **Cloud provider or hardware configuration**: AWS\r\n- **OS** (e.g. from /etc/os-release): \r\n```\r\nNAME=CoreOS\r\nID=coreos\r\nVERSION=1185.2.0\r\nVERSION_ID=1185.2.0\r\nBUILD_ID=2016-10-20-2326\r\nPRETTY_NAME=\"CoreOS 1185.2.0 (MoreOS)\"\r\nANSI_COLOR=\"1;32\"\r\nHOME_URL=\"https://coreos.com/\"\r\nBUG_REPORT_URL=\"https://github.com/coreos/bugs/issues\"\r\n```\r\n- **Kernel** (e.g. `uname -a`):\r\n```\r\nLinux 4.7.3-coreos-r2 #1 SMP Thu Oct 20 23:18:54 UTC 2016 x86_64 Intel(R) Xeon(R) CPU E5-2680 v2 @ 2.80GHz GenuineIntel GNU/Linux\r\n```",
  "closed_at": "2019-03-22T14:06:21Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 13,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37962/comments",
  "created_at": "2016-12-02T17:45:02Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37962/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/37962",
  "id": 193176190,
  "labels": [],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37962/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxOTMxNzYxOTA=",
  "number": 37962,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Kubelet doesn't retry if failed to get ECR auth token",
  "updated_at": "2019-03-22T14:06:21Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37962",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/12699319?v=4",
    "events_url": "https://api.github.com/users/andrewsykim/events{/privacy}",
    "followers_url": "https://api.github.com/users/andrewsykim/followers",
    "following_url": "https://api.github.com/users/andrewsykim/following{/other_user}",
    "gists_url": "https://api.github.com/users/andrewsykim/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/andrewsykim",
    "id": 12699319,
    "login": "andrewsykim",
    "node_id": "MDQ6VXNlcjEyNjk5MzE5",
    "organizations_url": "https://api.github.com/users/andrewsykim/orgs",
    "received_events_url": "https://api.github.com/users/andrewsykim/received_events",
    "repos_url": "https://api.github.com/users/andrewsykim/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/andrewsykim/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/andrewsykim/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/andrewsykim"
  }
}