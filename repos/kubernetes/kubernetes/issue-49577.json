{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**Is this a BUG REPORT or FEATURE REQUEST?**:\r\n\r\n/kind bug\r\n\r\n@kubernetes/sig-azure\r\n@kubernetes/sig-network\r\n\r\n**What happened**: \r\n\r\nI've created a Kubernetes CLuster on Azure using acs-engine.\r\n\r\nIn order to be able to communicate within a private network (Azure Vnet) between k8s resources and other Azure resources I have used a custom VNet configuration which allows to specify the Azure VNet resource you want k8s to be deployed into (which was already existing and had already some resources).\r\n\r\nWhen I tried to create an **internal** load balancer service (see following yaml) Kubernetes tells me it fails to get the subnet he wants to use for the Azure internal load balancer resource (it's the same subnet that is used by k8s masters nodes, so it does exist).\r\n\r\n```kind: Service\r\napiVersion: v1\r\nmetadata:\r\n  name: prometheus-internal-load-balancer\r\n  annotations:\r\n    service.beta.kubernetes.io/azure-load-balancer-internal: \"true\"\r\nspec:\r\n  selector:\r\n    app: prometheus\r\n    component: server\r\n  ports:\r\n    - protocol: TCP\r\n      port: 80\r\n      targetPort: 9090\r\n  type: LoadBalancer\r\n```\r\n\r\n**What you expected to happen**: Azure **internal** load balancer resource created\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n```\r\nsylvain@wsrabot:~/helm$ kubectl create -f service-internal-load-balancer.yml --context=k8s3-euw-dev --namespace=monitoring\r\nservice \"prometheus-internal-load-balancer\" created\r\n\r\nsylvain@wsrabot:~/helm$ kubectl describe service --context=k8s3-euw-dev --namespace=monitoring prometheus-internal-load-balancer\r\nName:                   prometheus-internal-load-balancer\r\nNamespace:              monitoring\r\nLabels:                 <none>\r\nAnnotations:            service.beta.kubernetes.io/azure-load-balancer-internal=true\r\nSelector:               app=prometheus,component=server\r\nType:                   LoadBalancer\r\nIP:                     10.0.200.138\r\nPort:                   <unset> 80/TCP\r\nNodePort:               <unset> 32552/TCP\r\nEndpoints:              10.100.242.24:9090\r\nSession Affinity:       None\r\nEvents:\r\n  FirstSeen     LastSeen        Count   From                    SubObjectPath   Type            Reason                          Message\r\n  ---------     --------        -----   ----                    -------------   --------        ------                          -------\r\n  8m            2m              7       service-controller                      Normal          CreatingLoadBalancer            Creating load balancer\r\n  8m            2m              7       service-controller                      Warning         CreatingLoadBalancerFailed      Error creating load balancer (will retry): Failed to create load balancer for service monitoring/prometheus-internal-load-balancer: ensure(monitoring/prometheus-internal-load-balancer): lb(k8s3-euw-dev-internal) - failed to get subnet: Network-EUW-dev-VNet/k8s3-master-EUW-dev-subnet\r\n```\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): 1.6.6\r\n- Cloud provider or hardware configuration: Azure\r\n- OS (e.g. from /etc/os-release): 16.04.2 LTS (Xenial Xerus)\r\n- Kernel (e.g. `uname -a`): Linux k8s-master-83339970-0 4.4.0-83-generic #106-Ubuntu SMP Mon Jun 26 17:54:43 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n",
  "closed_at": "2017-08-10T08:41:15Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 11,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/49577/comments",
  "created_at": "2017-07-25T17:05:33Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/49577/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/49577",
  "id": 245469947,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Network.",
      "id": 116712108,
      "name": "sig/network",
      "node_id": "MDU6TGFiZWwxMTY3MTIxMDg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/network"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/49577/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyNDU0Njk5NDc=",
  "number": 49577,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "K8s Service fails to create Azure internal load balancer",
  "updated_at": "2017-10-20T09:34:59Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/49577",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/153052?v=4",
    "events_url": "https://api.github.com/users/sylr/events{/privacy}",
    "followers_url": "https://api.github.com/users/sylr/followers",
    "following_url": "https://api.github.com/users/sylr/following{/other_user}",
    "gists_url": "https://api.github.com/users/sylr/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/sylr",
    "id": 153052,
    "login": "sylr",
    "node_id": "MDQ6VXNlcjE1MzA1Mg==",
    "organizations_url": "https://api.github.com/users/sylr/orgs",
    "received_events_url": "https://api.github.com/users/sylr/received_events",
    "repos_url": "https://api.github.com/users/sylr/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/sylr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sylr/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/sylr"
  }
}