{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**What happened**:\r\n\r\nWhen updating a deeply nested CRD in a local k8s cluster with `kubectl apply`,\r\nthe command finishes after more than 5 minutes.\r\nThe CRD has a field like [`corev1.PodSpec`](https://godoc.org/k8s.io/api/core/v1#PodSpec).\r\n\r\nI did a brief experiment for how the nesting depth of manifests affects computation time,\r\nand found that JSON patch creation with `kubectl apply` has exponential time complexity for the depth.\r\n\r\n**What you expected to happen**:\r\n\r\nFinish updating deeply nested CRDs with `kubectl apply` in some seconds, at most 5s.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nPlease execute `kubectl apply -f https://gist.githubusercontent.com/tapih/f339a2d558cf49b0cd6320b7b2f1821b/raw/2fa11c4935f1976059c6517caef647115e1dcbda/crd.yaml` twice.\r\nThe second one will take too long to finish.\r\n\r\n\r\nThis is the detail of my experiment.\r\n\r\n1. Create a `Foo` CRD project of which API version is `apiextensions.k8s.io/v1` with [kubebuilder](https://book.kubebuilder.io/quick-start.html).\r\n2. Change the type definition of the CRD to have deeply nested slices.\r\n\r\n```go\r\ntype FooSpec struct {\r\n\t// +optional\r\n\tT1 []T1 `json:\"t1,omitempty\"`\r\n}\r\n\r\ntype T9 struct {\r\n\t// +optional\r\n\tT8 []T8 `json:\"t8,omitempty\"`\r\n}\r\n\r\ntype T8 struct {\r\n\t// +optional\r\n\tT7 []T7 `json:\"t7,omitempty\"`\r\n}\r\n\r\ntype T7 struct {\r\n\t// +optional\r\n\tT6 []T6 `json:\"t6,omitempty\"`\r\n}\r\n\r\n:\r\n\r\ntype T1 struct {\r\n\t// +optional\r\n\tField string `json:\"field\"`\r\n}\r\n```\r\n\r\n3. Run `make manifests` and create the CRD manifest.\r\n4. Create a CRD object with `kubectl apply -f ./config/crd/bases/your.domain.name_foo.yaml`.\r\n5. Update the CRD object with `kubectl apply -f ./config/crd/bases/your.domain.name_foo.yaml`.\r\n6. Repeat this with incrementing the nesting depth of `FooSpec` like T1, T2, T3...T8.\r\n\r\n\r\nThe wall-clock time to finish the second `kubectl apply -f ./config/crd/bases/your.domain.name_foo.yaml` was as follow:\r\n\r\n```\r\n...\r\nT4 => 0.1s\r\nT5 => 1.2s\r\nT6 => 8.7s\r\nT7 => 68s\r\nT8 => 544s\r\n```\r\n\r\n**Anything else we need to know?**:\r\n\r\nhttps://github.com/evanphx/json-patch/pull/87 has already resolved this issue.\r\nHowever, [kubernetes/kubernetes/go.mod](https://github.com/kubernetes/kubernetes/blob/413bc1a1d238efb7c4ba9e3aac2c381c93295aec/go.mod#L239) at master `HEAD` does not take this fix.\r\n\r\nhttps://github.com/kubernetes/kubectl/issues/698 is about the same problem.\r\nHowever, it was closed without fixing this problem.\r\n\r\n**Environment**:\r\n- Kubernetes version:  \r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"18\", GitVersion:\"v1.18.2\", GitCommit:\"52c56ce7a8272c798dbc29846288d7cd9fbae032\", GitTreeState:\"clean\", BuildDate:\"2020-04-16T11:56:40Z\", GoVersion:\"go1.13.9\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"17\", GitVersion:\"v1.17.2\", GitCommit:\"59603c6e503c87169aea6106f57b9f242f64df89\", GitTreeState:\"clean\", BuildDate:\"2020-02-07T01:05:17Z\", GoVersion:\"go1.13.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n- Hardware: VM on Hyper-V\r\n- OS: Ubuntu 18.04\r\n- Kernel: 4.15.0-66-generic\r\n- Install tools: kind v0.8.1\r\n",
  "closed_at": null,
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/980082?v=4",
    "events_url": "https://api.github.com/users/liggitt/events{/privacy}",
    "followers_url": "https://api.github.com/users/liggitt/followers",
    "following_url": "https://api.github.com/users/liggitt/following{/other_user}",
    "gists_url": "https://api.github.com/users/liggitt/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/liggitt",
    "id": 980082,
    "login": "liggitt",
    "node_id": "MDQ6VXNlcjk4MDA4Mg==",
    "organizations_url": "https://api.github.com/users/liggitt/orgs",
    "received_events_url": "https://api.github.com/users/liggitt/received_events",
    "repos_url": "https://api.github.com/users/liggitt/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/liggitt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/liggitt/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/liggitt"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/91615/comments",
  "created_at": "2020-06-01T04:06:34Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/91615/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/91615",
  "id": 628136605,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG CLI.",
      "id": 450823910,
      "name": "sig/cli",
      "node_id": "MDU6TGFiZWw0NTA4MjM5MTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cli"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/91615/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MjgxMzY2MDU=",
  "number": 91615,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "open",
  "title": "JSON patch with kubectl has exponential time complexity for nesting depth of manifest",
  "updated_at": "2020-08-08T16:15:28Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/91615",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/5456898?v=4",
    "events_url": "https://api.github.com/users/tapih/events{/privacy}",
    "followers_url": "https://api.github.com/users/tapih/followers",
    "following_url": "https://api.github.com/users/tapih/following{/other_user}",
    "gists_url": "https://api.github.com/users/tapih/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/tapih",
    "id": 5456898,
    "login": "tapih",
    "node_id": "MDQ6VXNlcjU0NTY4OTg=",
    "organizations_url": "https://api.github.com/users/tapih/orgs",
    "received_events_url": "https://api.github.com/users/tapih/received_events",
    "repos_url": "https://api.github.com/users/tapih/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/tapih/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tapih/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/tapih"
  }
}