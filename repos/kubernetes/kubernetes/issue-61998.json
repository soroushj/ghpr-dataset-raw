{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- This form is for bug reports and feature requests ONLY! \r\n\r\nIf you're looking for help check [Stack Overflow](https://stackoverflow.com/questions/tagged/kubernetes) and the [troubleshooting guide](https://kubernetes.io/docs/tasks/debug-application-cluster/troubleshooting/).\r\n-->\r\n\r\n**Is this a BUG REPORT or FEATURE REQUEST?**:\r\n\r\n/kind bug\r\n\r\n**What happened**:\r\n\r\nStatefulsets are sometimes continually rolling pods and I don't know why\r\nstatefulset created: \r\nstatefulset.yml:\r\nhttps://gist.github.com/ryanmcnamara/9e81c2bd2c6ac22fe8c12bc2a68a8aad\r\nstorageclass referenced:\r\nhttps://gist.github.com/ryanmcnamara/cdf8ade20d3a853d5ed2d80b60ead79f\r\nkubectl describe statefulset statefulset-test: \r\nhttps://gist.github.com/ryanmcnamara/e2bf74a8d7a4f0cbaa19f98ca57b4348\r\n\r\nAs you can see from the above describe, the pod in the statefulset has been restarted a lot of times. Observing the created pod, \r\n1) The pod comes up ready \r\n2) immediately transitions to terminating \r\n3) Is terminated\r\n4) A new pod is created\r\n5) Go back to (1) (repeats forever)\r\n\r\nDespite no updates to the statefulset spec ocurring.\r\n\r\nMaking a change to the statefulset template (for example a trivial change adding a nonsense annotation) stops the rolling and fixes the issue\r\n\r\nWhen this statefulset was created, there was a mutating webhook enabled. After the observed pod rolling. I disabled this by making its configuration invalid and making it non required, and the rolling persisted.\r\n\r\nThe status of the statefulset: `kubectl get statefulset statefulset-test -o yaml`:\r\nhttps://gist.github.com/ryanmcnamara/1cbd58c4e9b7843f9443ee4010d41ffb\r\n\r\nYou can see that there is a discrepency between currentRevision and updateRevision.\r\n  currentRevision: statefulset-test-8696d5779b\r\n  updateRevision: statefulset-test-8696d5778f\r\nA short while later the status is changed to contain\r\n  currentRevision: statefulset-test-d8b584c9f\r\n  updateRevision: statefulset-test-d8b584c9b\r\nThis change happened at Sun Apr  1 19:48:48 2018\r\nPresumably after the rollout of statefulset-test-8696d5778f is complete.\r\n\r\nHere are all the controllerrevisions from above:\r\nkubectl get controllerrevision statefulset-test-8696d5779b -o yaml\r\nhttps://gist.github.com/ryanmcnamara/ee54d1d5941cfde857a5589a8347c9a5\r\nkubectl get controllerrevision statefulset-test-8696d5778f -o yaml:\r\nhttps://gist.github.com/ryanmcnamara/4bf24bafa00c8e2434ae5d4287ed728a\r\nkubectl get controllerrevision statefulset-test-d8b584c9b -o yaml:\r\nhttps://gist.github.com/ryanmcnamara/4b49a0504653ba2d92585fb4015897c2\r\n\r\nThe differences between the above controllerrevisions are insignificant (the hash, the creation timestamp, the name, the resource version, the uid, the self link)\r\n\r\nInterestingly all these controllerrevisions were created very close together in time shortly after I created the statefulset\r\nThe current controllerrevisions are\r\n```\r\n[rmcnamara@ip-10-0-112-31 ~]$ kubectl get controllerrevisions\r\nNAME                          CONTROLLER                     REVISION   AGE\r\nstatefulset-test-8696d57789   StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-8696d5778b   StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-8696d5778f   StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-8696d5779b   StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-cf9d4cdf6    StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-cf9d4cdfc    StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-cf9d4cdfd    StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-cf9d4cf44    StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-cf9d4cf45    StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-d8b584c9b    StatefulSet/statefulset-test   1          13h\r\nstatefulset-test-d8b584c9f    StatefulSet/statefulset-test   1          13h\r\n```\r\nAfter watching the state change for a while, it actually seems like the statefulset is just cycling through the updateRevision being one of the above 10 controllerrevisions\r\n\r\nLeaders during this time\r\n```\r\n[rmcnamara@ip-10-0-112-31 ~]$ kubectl get endpoints kube-controller-manager -n kube-system -o yaml | grep alpha\r\n    control-plane.alpha.kubernetes.io/leader: '{\"holderIdentity\":\"ip-10-0-100-151\",\"leaseDurationSeconds\":15,\"acquireTime\":\"2018-04-01T05:50:03Z\",\"renewTime\":\"2018-04-01T20:13:58Z\",\"leaderTransitions\":7}'\r\n[rmcnamara@ip-10-0-112-31 ~]$ kubectl get endpoints kube-scheduler -n kube-system -o yaml | grep alpha\r\n    control-plane.alpha.kubernetes.io/leader: '{\"holderIdentity\":\"ip-10-0-100-151\",\"leaseDurationSeconds\":15,\"acquireTime\":\"2018-04-01T05:50:01Z\",\"renewTime\":\"2018-04-01T20:14:06Z\",\"leaderTransitions\":8}'\r\n```\r\n\r\nFrom kube-controller-manager logs during this time, here is one excerpt:\r\n```\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.344768    1565 stateful_set.go:455] Syncing StatefulSet default/statefulset-test with 1 pods\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.344653    1565 disruption.go:403] No PodDisruptionBudgets found for pod statefulset-test-0, PodDisruptionBudget controller will avoid syncing.\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.344861    1565 disruption.go:343] No matching pdb for pod \"statefulset-test-0\"\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.346127    1565 stateful_set_control.go:502] StatefulSet default/statefulset-test terminating Pod statefulset-test-0 for update\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.353804    1565 disruption.go:340] updatePod called on pod \"statefulset-test-0\"\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.353766    1565 stateful_set.go:226] Pod statefulset-test-0 updated, objectMeta {Name:statefulset-test-0 GenerateName:statefulset-test- Namespace:default SelfLink:/api/v1/namespaces/default/pods/statefulset-test-0 UID:aa09a5de-35e5-11e8-93f3-0e0de0418f44 ResourceVersion:957880 Generation:0 CreationTimestamp:2018-04-01 19:48:35 +0000 UTC DeletionTimestamp:<nil> DeletionGracePeriodSeconds:<nil> Labels:map[controller-revision-hash:statefulset-test-cf9d4cdfd deployment-test: statefulset.kubernetes.io/pod-name:statefulset-test-0] Annotations:map[] OwnerReferences:[{APIVersion:apps/v1beta1 Kind:StatefulSet Name:statefulset-test UID:fc4a62e6-3579-11e8-93f3-0e0de0418f44 Controller:0xc423c291f6 BlockOwnerDeletion:0xc423c291f7}] Initializers:nil Finalizers:[] ClusterName:} -> {Name:statefulset-test-0 GenerateName:statefulset-test- Namespace:default SelfLink:/api/v1/namespaces/default/pods/statefulset-test-0 UID:aa09a5de-35e5-11e8-93f3-0e0de0418f44 ResourceVersion:957882 Generation:0 CreationTimestamp:2018-04-01 19:48:35 +0000 UTC DeletionTimestamp:2018-04-01 19:49:16 +0000 UTC DeletionGracePeriodSeconds:0xc42233dde0 Labels:map[controller-revision-hash:statefulset-test-cf9d4cdfd deployment-test: statefulset.kubernetes.io/pod-name:statefulset-test-0] Annotations:map[] OwnerReferences:[{APIVersion:apps/v1beta1 Kind:StatefulSet Name:statefulset-test UID:fc4a62e6-3579-11e8-93f3-0e0de0418f44 Controller:0xc42233dde8 BlockOwnerDeletion:0xc42233dde9}] Initializers:nil Finalizers:[] ClusterName:}.\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.353829    1565 disruption.go:403] No PodDisruptionBudgets found for pod statefulset-test-0, PodDisruptionBudget controller will avoid syncing.\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.353854    1565 disruption.go:343] No matching pdb for pod \"statefulset-test-0\"\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.354030    1565 event.go:218] Event(v1.ObjectReference{Kind:\"StatefulSet\", Namespace:\"default\", Name:\"statefulset-test\", UID:\"fc4a62e6-3579-11e8-93f3-0e0de0418f44\", APIVersion:\"apps\", ResourceVersion:\"957843\", FieldPath:\"\"}): type: 'Normal' reason: 'SuccessfulDelete' delete Pod statefulset-test-0 in StatefulSet statefulset-test successful\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.354836    1565 attach_detach_controller.go:493] processVolumesInUse for node \"ip-10-0-107-133.ec2.internal\"\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.354883    1565 actual_state_of_world.go:350] SetVolumeMountedByNode volume kubernetes.io/aws-ebs/aws://us-east-1a/vol-0d5396c605c0a817f to the node \"ip-10-0-107-133.ec2.internal\" mounted true\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.354900    1565 actual_state_of_world.go:350] SetVolumeMountedByNode volume kubernetes.io/aws-ebs/aws://us-east-1a/vol-079810a7d16ba3e53 to the node \"ip-10-0-107-133.ec2.internal\" mounted true\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.355413    1565 stateful_set.go:417] Finished syncing statefulset \"default/statefulset-test\" (10.728123ms)\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: E0401 19:48:46.355436    1565 stateful_set.go:399] Error syncing StatefulSet default/statefulset-test, requeuing: StatefulSet.apps \"statefulset-test\" is invalid: status.currentReplicas: Invalid value: -1: must be greater than or equal to 0\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.355514    1565 stateful_set.go:455] Syncing StatefulSet default/statefulset-test with 1 pods\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.356747    1565 stateful_set_control.go:351] StatefulSet default/statefulset-test has 1 unhealthy Pods starting with statefulset-test-0\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.356765    1565 stateful_set_control.go:412] StatefulSet default/statefulset-test is waiting for Pod statefulset-test-0 to Terminate\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.362906    1565 stateful_set_control.go:99] StatefulSet default/statefulset-test pod status replicas=1 ready=1 current=0 updated=0\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.362917    1565 stateful_set_control.go:107] StatefulSet default/statefulset-test revisions current=statefulset-test-d8b584c9f update=statefulset-test-8696d5778b\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.362925    1565 stateful_set.go:460] Successfully synced StatefulSet default/statefulset-test successful\r\nApr 01 19:48:46 ip-10-0-100-151 kube-controller-manager[1565]: I0401 19:48:46.362930    1565 stateful_set.go:417] Finished syncing statefulset \"default/statefulset-test\" (7.47279ms)\r\n```\r\n\r\nThe error sync in there is suspicous, and as you can see the controllerrevisions are changing in the logs\r\n\r\nI have the full logs from a 5 minute window on either side of the above if necessary.\r\n\r\nThe reason I'm inclined to think this is a kubernetes bug is that any update to the statefulset template fixes the problem.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nNot really sure. Worth just trying to create the above statefulset (requires creating the \r\nI tried deleting and recreating the above statefulset and it didn't happen, so something flaky is going on\r\n\r\n**Anything else we need to know?**:\r\nkubernetes 1.9.3 (client and server)\r\ncloud provider: aws",
  "closed_at": "2018-12-19T08:51:30Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 8,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/61998/comments",
  "created_at": "2018-04-02T01:09:00Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/61998/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/61998",
  "id": 310369597,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Apps.",
      "id": 404091735,
      "name": "sig/apps",
      "node_id": "MDU6TGFiZWw0MDQwOTE3MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/apps"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/61998/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMTAzNjk1OTc=",
  "number": 61998,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Statefulset pods sometimes continually rolling",
  "updated_at": "2019-07-18T01:44:12Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/61998",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/3452559?v=4",
    "events_url": "https://api.github.com/users/ryanmcnamara/events{/privacy}",
    "followers_url": "https://api.github.com/users/ryanmcnamara/followers",
    "following_url": "https://api.github.com/users/ryanmcnamara/following{/other_user}",
    "gists_url": "https://api.github.com/users/ryanmcnamara/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ryanmcnamara",
    "id": 3452559,
    "login": "ryanmcnamara",
    "node_id": "MDQ6VXNlcjM0NTI1NTk=",
    "organizations_url": "https://api.github.com/users/ryanmcnamara/orgs",
    "received_events_url": "https://api.github.com/users/ryanmcnamara/received_events",
    "repos_url": "https://api.github.com/users/ryanmcnamara/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ryanmcnamara/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ryanmcnamara/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ryanmcnamara"
  }
}