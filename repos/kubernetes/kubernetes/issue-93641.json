{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/947971?v=4",
    "events_url": "https://api.github.com/users/cheftako/events{/privacy}",
    "followers_url": "https://api.github.com/users/cheftako/followers",
    "following_url": "https://api.github.com/users/cheftako/following{/other_user}",
    "gists_url": "https://api.github.com/users/cheftako/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/cheftako",
    "id": 947971,
    "login": "cheftako",
    "node_id": "MDQ6VXNlcjk0Nzk3MQ==",
    "organizations_url": "https://api.github.com/users/cheftako/orgs",
    "received_events_url": "https://api.github.com/users/cheftako/received_events",
    "repos_url": "https://api.github.com/users/cheftako/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/cheftako/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cheftako/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/cheftako"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/947971?v=4",
      "events_url": "https://api.github.com/users/cheftako/events{/privacy}",
      "followers_url": "https://api.github.com/users/cheftako/followers",
      "following_url": "https://api.github.com/users/cheftako/following{/other_user}",
      "gists_url": "https://api.github.com/users/cheftako/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/cheftako",
      "id": 947971,
      "login": "cheftako",
      "node_id": "MDQ6VXNlcjk0Nzk3MQ==",
      "organizations_url": "https://api.github.com/users/cheftako/orgs",
      "received_events_url": "https://api.github.com/users/cheftako/received_events",
      "repos_url": "https://api.github.com/users/cheftako/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/cheftako/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cheftako/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/cheftako"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\n\r\nWhen use client-go to build the client, we implement the event handler for some k8s resourses. Sometime it will panic (maybe cause by the unexpected nil pointer bug), the process will not crash after panic.\r\n\r\n**What you expected to happen**:\r\n\r\nWhen we use event handler with informer in client-go, sometime it will panic in handler, we expect the process will crash.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nI run process which just panic simpliy in an event handler , use `gcore [pid]` to produce the coredump, and use `dlv core` to check the call stack. \r\n\r\nThe sample code I run is:\r\n\r\n```\r\ntype controller struct {\r\n\tclientSet *kubernetes.Clientset\r\n\r\n\tclaimStore cache.Store\r\n\tclaimCtrl  cache.Controller\r\n}\r\n\r\nconst (\r\n\tDefaultResyncPeriod = 15 * time.Second\r\n)\r\n\r\nfunc main() {\r\n\tvar kubeconfig string\r\n\tvar master string\r\n\r\n\tflag.StringVar(&kubeconfig, \"kubeconfig\", \"\", \"absolute path to the kubeconfig file\")\r\n\tflag.StringVar(&master, \"master\", \"\", \"master url\")\r\n\tflag.Parse()\r\n\r\n\t// creates the connection\r\n\tconfig, err := clientcmd.BuildConfigFromFlags(master, kubeconfig)\r\n\tif err != nil {\r\n\t\tklog.Fatal(err)\r\n\t}\r\n\r\n\t// creates the clientset\r\n\tclientSet, err := kubernetes.NewForConfig(config)\r\n\tif err != nil {\r\n\t\tklog.Fatal(err)\r\n\t}\r\n\r\n\tpvCtrl := NewController(clientSet)\r\n\r\n\tpvCtrl.Loop(wait.NeverStop)\r\n}\r\n\r\nfunc NewController(clientSet *kubernetes.Clientset) controller {\r\n\t// List and watch the PersistentVolumeClaims\r\n\tlw := &cache.ListWatch{\r\n\t\tListFunc: func(options metav1.ListOptions) (runtime.Object, error) {\r\n\t\t\treturn clientSet.CoreV1().PersistentVolumeClaims(corev1.NamespaceAll).List(options)\r\n\t\t},\r\n\t\tWatchFunc: func(options metav1.ListOptions) (watch.Interface, error) {\r\n\t\t\treturn clientSet.CoreV1().PersistentVolumeClaims(corev1.NamespaceAll).Watch(options)\r\n\t\t},\r\n\t}\r\n\r\n\tc := controller{\r\n\t\tclientSet:  clientSet,\r\n\t}\r\n\r\n\tclaimHandler := cache.ResourceEventHandlerFuncs{\r\n\t\tAddFunc:    c.addPVCFunc,\r\n\t\tDeleteFunc: c.deletePVCFunc,\r\n\t}\r\n\r\n\tc.claimStore, c.claimCtrl = cache.NewInformer(lw, &corev1.PersistentVolumeClaim{}, DefaultResyncPeriod,\r\n\t\tclaimHandler)\r\n\r\n\treturn c\r\n}\r\n\r\nfunc (c *controller) Loop(stopCh <-chan struct{}) {\r\n\tgo c.claimCtrl.Run(stopCh)\r\n\r\n\t<-stopCh\r\n}\r\n\r\nfunc (c *controller) deletePVCFunc(obj interface{}) {\r\n\t_, ok := obj.(*corev1.PersistentVolumeClaim)\r\n\tif !ok {\r\n\t\tklog.Errorf(\"Expected PersistentVolumeClaim but deletePVCFunc received %+v\", obj)\r\n\t\treturn\r\n\t}\r\n\r\n}\r\n\r\nfunc (c *controller) addPVCFunc(obj interface{}) {\r\n\t_, ok := obj.(*corev1.PersistentVolumeClaim)\r\n\tif !ok {\r\n\t\tklog.Errorf(\"Expected PersistentVolumeClaim but addPVCFunc received %+v\", obj)\r\n\t\treturn\r\n\t}\r\n\r\n\tpanic(\"Just panic!\")\r\n}\r\n```\r\n\r\nThe call stack of paniced goroutine:\r\n\r\n```\r\n(dlv) gr 8 bt\r\n 0  0x0000000000435570 in runtime.gopark\r\n    at C:/Go/src/runtime/proc.go:305\r\n 1  0x00000000004456b0 in runtime.goparkunlock\r\n    at C:/Go/src/runtime/proc.go:310\r\n 2  0x00000000004456b0 in runtime.semacquire1\r\n    at C:/Go/src/runtime/sema.go:144\r\n 3  0x0000000000445302 in sync.runtime_Semacquire\r\n    at C:/Go/src/runtime/sema.go:56\r\n 4  0x000000000047c2a4 in sync.(*WaitGroup).Wait\r\n    at C:/Go/src/sync/waitgroup.go:130\r\n 5  0x0000000001082c5d in k8s.io/apimachinery/pkg/util/wait.(*Group).Wait\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/apimachinery@v0.17.6/pkg/util/wait/wait.go:47\r\n 6  0x000000000046039b in runtime.call32\r\n    at C:/Go/src/runtime/asm_amd64.s:1\r\n 7  0x0000000000432298 in runtime.reflectcallSave\r\n    at C:/Go/src/runtime/panic.go:879\r\n 8  0x0000000000432159 in runtime.runOpenDeferFrame\r\n    at C:/Go/src/runtime/panic.go:853\r\n 9  0x000000000043249d in runtime.gopanic\r\n    at C:/Go/src/runtime/panic.go:967\r\n10  0x00000000007aa305 in k8s.io/apimachinery/pkg/util/runtime.HandleCrash\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/apimachinery@v0.17.6/pkg/util/runtime/runtime.go:55\r\n11  0x000000000046039b in runtime.call32\r\n    at C:/Go/src/runtime/asm_amd64.s:1\r\n12  0x0000000000432298 in runtime.reflectcallSave\r\n    at C:/Go/src/runtime/panic.go:879\r\n13  0x0000000000432159 in runtime.runOpenDeferFrame\r\n    at C:/Go/src/runtime/panic.go:853\r\n14  0x000000000043249d in runtime.gopanic\r\n    at C:/Go/src/runtime/panic.go:967\r\n15  0x00000000010d72be in main.(*controller).addPVCFunc\r\n    at C:/Users/86182/gopath/src/github.com/weaveworks/panicDump/main.go:103\r\n16  0x00000000010d764e in main.(*controller).addPVCFunc-fm\r\n    at C:/Users/86182/gopath/src/github.com/weaveworks/panicDump/main.go:96\r\n17  0x000000000109919a in k8s.io/client-go/tools/cache.(*ResourceEventHandlerFuncs).OnAdd\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/client-go@v0.17.6/tools/cache/controller.go:198\r\n18  0x00000000010964da in k8s.io/client-go/tools/cache.newInformer.func1\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/client-go@v0.17.6/tools/cache/controller.go:370\r\n19  0x000000000108e765 in k8s.io/client-go/tools/cache.(*DeltaFIFO).Pop\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/client-go@v0.17.6/tools/cache/delta_fifo.go:422\r\n20  0x000000000108bf20 in k8s.io/client-go/tools/cache.(*controller).processLoop\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/client-go@v0.17.6/tools/cache/controller.go:153\r\n21  0x000000000109904a in k8s.io/client-go/tools/cache.(*controller).processLoop-fm\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/client-go@v0.17.6/tools/cache/controller.go:151\r\n22  0x00000000010832ff in k8s.io/apimachinery/pkg/util/wait.JitterUntil.func1\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/apimachinery@v0.17.6/pkg/util/wait/wait.go:152\r\n23  0x0000000001082f58 in k8s.io/apimachinery/pkg/util/wait.JitterUntil\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/apimachinery@v0.17.6/pkg/util/wait/wait.go:153\r\n24  0x000000000108bca1 in k8s.io/apimachinery/pkg/util/wait.Until\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/apimachinery@v0.17.6/pkg/util/wait/wait.go:88\r\n25  0x000000000108bca1 in k8s.io/client-go/tools/cache.(*controller).Run\r\n    at C:/Users/86182/gopath/pkg/mod/k8s.io/client-go@v0.17.6/tools/cache/controller.go:125\r\n26  0x0000000000461f71 in runtime.goexit\r\n    at C:/Go/src/runtime/asm_amd64.s:1373\r\n```\r\n\r\nWe can see the panic was called at frame 16 , and was catched by `k8s.io/apimachinery/pkg/util/runtime.HandleCrash` at 10. It  printed the call stack in `HandleCrash` and panic again. The defer func was call at  frame 8, it's `k8s.io/apimachinery/pkg/util/wait.(*Group).Wait` (at 5). Panic was blocked at here. Finally, this goroutine was scheduled to `gopark` , would not exit or crash the whole process.\r\n\r\nThe go code in `tools/cache/controller.go` is :\r\n\r\n```\r\nfunc (c *controller) Run(stopCh <-chan struct{}) {\r\n\tdefer utilruntime.HandleCrash()\r\n\tgo func() {\r\n\t\t<-stopCh\r\n\t\tc.config.Queue.Close()\r\n\t}()\r\n\tr := NewReflector(\r\n\t\tc.config.ListerWatcher,\r\n\t\tc.config.ObjectType,\r\n\t\tc.config.Queue,\r\n\t\tc.config.FullResyncPeriod,\r\n\t)\r\n\tr.ShouldResync = c.config.ShouldResync\r\n\tr.clock = c.clock\r\n\tif c.config.WatchErrorHandler != nil {\r\n\t\tr.watchErrorHandler = c.config.WatchErrorHandler\r\n\t}\r\n\r\n\tc.reflectorMutex.Lock()\r\n\tc.reflector = r\r\n\tc.reflectorMutex.Unlock()\r\n\r\n\tvar wg wait.Group\r\n\tdefer wg.Wait()                                 // <-- 2. this defer func will be called at this line and the panic will be blocked forever\r\n\r\n\twg.StartWithChannel(stopCh, r.Run)\r\n\r\n\twait.Until(c.processLoop, time.Second, stopCh)  // <-- 1. panic in c.processLoop\r\n}\r\n```\r\n\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v1.16.6\", GitCommit:\"72c30166b2105cd7d3350f2c28a219e6abcd79eb\", GitTreeState:\"clean\", BuildDate:\"2020-01-18T23:31:31Z\", GoVersion:\"go1.13.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v1.16.6\", GitCommit:\"72c30166b2105cd7d3350f2c28a219e6abcd79eb\", GitTreeState:\"clean\", BuildDate:\"2020-01-18T23:23:21Z\", GoVersion:\"go1.13.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nUse 'kc' as shortcut of kubectl and 'kd' for 'kubectl describe'\r\n```\r\n- OS (e.g: `cat /etc/os-release`):\r\n```\r\nNAME=\"CentOS Linux\"\r\nVERSION=\"7 (Core)\"\r\nID=\"centos\"\r\nID_LIKE=\"rhel fedora\"\r\nVERSION_ID=\"7\"\r\nPRETTY_NAME=\"CentOS Linux 7 (Core)\"\r\nANSI_COLOR=\"0;31\"\r\nCPE_NAME=\"cpe:/o:centos:centos:7\"\r\nHOME_URL=\"https://www.centos.org/\"\r\nBUG_REPORT_URL=\"https://bugs.centos.org/\"\r\n\r\nCENTOS_MANTISBT_PROJECT=\"CentOS-7\"\r\nCENTOS_MANTISBT_PROJECT_VERSION=\"7\"\r\nREDHAT_SUPPORT_PRODUCT=\"centos\"\r\nREDHAT_SUPPORT_PRODUCT_VERSION=\"7\"\r\n```\r\n- Kernel (e.g. `uname -a`):\r\n```\r\n$ uname -a\r\nLinux m1.ha.env.lab.io 3.10.0-1062.12.1.el7.x86_64 #1 SMP Tue Feb 4 23:02:59 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n",
  "closed_at": "2020-09-02T01:43:14Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93641/comments",
  "created_at": "2020-08-03T08:27:58Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93641/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/93641",
  "id": 671898928,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93641/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2NzE4OTg5Mjg=",
  "number": 93641,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Panic in event handler will be blocked by defer func but it should propagate up",
  "updated_at": "2020-09-02T01:43:14Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93641",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/25979763?v=4",
    "events_url": "https://api.github.com/users/gobomb/events{/privacy}",
    "followers_url": "https://api.github.com/users/gobomb/followers",
    "following_url": "https://api.github.com/users/gobomb/following{/other_user}",
    "gists_url": "https://api.github.com/users/gobomb/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/gobomb",
    "id": 25979763,
    "login": "gobomb",
    "node_id": "MDQ6VXNlcjI1OTc5NzYz",
    "organizations_url": "https://api.github.com/users/gobomb/orgs",
    "received_events_url": "https://api.github.com/users/gobomb/received_events",
    "repos_url": "https://api.github.com/users/gobomb/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/gobomb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gobomb/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/gobomb"
  }
}