{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\nkubelet doesn't start up on a cgroup2 host without hugetlb controller\r\n\r\n```\r\nkubelet.go:1293] Failed to start ContainerManager failed to initialize top level QOS containers: fa\r\niled to update top level BestEffort QOS cgroup : failed to set resources for cgroup [kubepods besteffort]: failed to write \"4611686018427387904\" to \"/sys/fs/cgroup/kubepods/beste\r\nffort/hugetlb.1GB.max\": open /sys/fs/cgroup/kubepods/besteffort/hugetlb.1GB.max: permission denied\r\n```\r\n\r\n**What you expected to happen**:\r\n\r\nShould work without hugetlb controller\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n* Boot Ubuntu 20.04 host with `systemd.unified_cgroup_hierarchy=1`. \r\n* Make sure cgroup v2 controllers are enabled but hugetlb is not:\r\n```console\r\n$ cat /sys/fs/cgroup/cgroup.controllers`\r\ncpuset cpu io memory pids rdma\r\n```\r\n* Install Moby from its master branch (Docker 20.0X). Binaries are available at https://github.com/AkihiroSuda/moby-snapshot\r\n* Install kind from its master branch (kubernetes-sigs/kind@aa1758fefe4384a60f875ba7c8acb86df15c6413)\r\n* Run `kind build node-image` with kubernetes/kubernetes@896da2253c77d15fc551843e515039c6e9c86c99\r\n* Run `kind create cluster --image kindest/node:latest`\r\n* Run `docker exec -it kind-control-plane journalctl -f`\r\n\r\n**Environment**\r\n\r\n```console\r\n$ docker info\r\nClient:\r\n Context:    default\r\n Debug Mode: false\r\n Plugins:\r\n  buildx: Build with BuildKit (Docker Inc., v0.4.1)\r\n\r\nServer:\r\n Containers: 3\r\n  Running: 1\r\n  Paused: 0\r\n  Stopped: 2\r\n Images: 14\r\n Server Version: dev\r\n Storage Driver: overlay2\r\n  Backing Filesystem: extfs\r\n  Supports d_type: true\r\n  Native Overlay Diff: true\r\n Logging Driver: json-file\r\n Cgroup Driver: systemd\r\n Cgroup Version: 2\r\n Plugins:\r\n  Volume: local\r\n  Network: bridge host ipvlan macvlan null overlay\r\n  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog\r\n Swarm: inactive\r\n Runtimes: runc crun\r\n Default Runtime: runc\r\n Init Binary: docker-init\r\n containerd version: 334f567e0130b2734a3a5439f2bb644d14aa66e4\r\n runc version: 545ebdd14ac3ac35249d6bb3c2e22c930b596584\r\n init version: fec3683\r\n Security Options:\r\n  apparmor\r\n  seccomp\r\n   Profile: default\r\n  cgroupns\r\n Kernel Version: 5.4.0-40-generic\r\n Operating System: Ubuntu 20.04 LTS\r\n OSType: linux\r\n Architecture: x86_64\r\n CPUs: 2\r\n Total Memory: 7.748GiB\r\n Name: suda-ws01\r\n ID: E2YB:EGZO:6BNW:EPHS:4WFQ:EIDV:ZZ6D:QBZK:6673:CIOR:DLZ6:SI3D\r\n Docker Root Dir: /var/lib/docker\r\n Debug Mode: true\r\n  File Descriptors: 32\r\n  Goroutines: 46\r\n  System Time: 2020-07-09T20:27:53.066436005+09:00\r\n  EventsListeners: 0\r\n Username: akihirosuda\r\n Registry: https://index.docker.io/v1/\r\n Labels:\r\n Experimental: true\r\n Insecure Registries:\r\n  127.0.0.0/8\r\n Live Restore Enabled: false\r\n\r\nWARNING: No kernel memory limit support\r\nWARNING: No kernel memory TCP limit support\r\nWARNING: No oom kill disable support\r\nWARNING: Support for cgroup v2 is experimental\r\n```\r\n\r\n```console\r\n$ docker version\r\nClient:\r\n Version:           20.03.0-dev\r\n API version:       1.41\r\n Go version:        go1.13.12\r\n Git commit:        66ea6250a\r\n Built:             Thu Jul  9 11:10:47 2020\r\n OS/Arch:           linux/amd64\r\n Context:           default\r\n Experimental:      true\r\n\r\nServer:\r\n Engine:\r\n  Version:          dev\r\n  API version:      1.41 (minimum version 1.12)\r\n  Go version:       go1.13.12\r\n  Git commit:       a90137825c\r\n  Built:            Thu Jul  9 11:09:14 2020\r\n  OS/Arch:          linux/amd64\r\n  Experimental:     true\r\n containerd:\r\n  Version:          v1.4.0-beta.1-85-g334f567e\r\n  GitCommit:        334f567e0130b2734a3a5439f2bb644d14aa66e4\r\n runc:\r\n  Version:          1.0.0-rc91+dev\r\n  GitCommit:        545ebdd14ac3ac35249d6bb3c2e22c930b596584\r\n docker-init:\r\n  Version:          0.18.0\r\n  GitCommit:        fec3683\r\n```",
  "closed_at": "2020-07-14T03:21:21Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 13,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/92933/comments",
  "created_at": "2020-07-09T11:30:46Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/92933/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/92933",
  "id": 653987905,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 116719829,
      "name": "area/kubelet",
      "node_id": "MDU6TGFiZWwxMTY3MTk4Mjk=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/kubelet"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Node.",
      "id": 173493665,
      "name": "sig/node",
      "node_id": "MDU6TGFiZWwxNzM0OTM2NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/node"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/92933/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2NTM5ODc5MDU=",
  "number": 92933,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "[cgroup2] kubelet doesn't start up on a host without hugetlb controller",
  "updated_at": "2020-07-14T03:21:21Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/92933",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/9248427?v=4",
    "events_url": "https://api.github.com/users/AkihiroSuda/events{/privacy}",
    "followers_url": "https://api.github.com/users/AkihiroSuda/followers",
    "following_url": "https://api.github.com/users/AkihiroSuda/following{/other_user}",
    "gists_url": "https://api.github.com/users/AkihiroSuda/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/AkihiroSuda",
    "id": 9248427,
    "login": "AkihiroSuda",
    "node_id": "MDQ6VXNlcjkyNDg0Mjc=",
    "organizations_url": "https://api.github.com/users/AkihiroSuda/orgs",
    "received_events_url": "https://api.github.com/users/AkihiroSuda/received_events",
    "repos_url": "https://api.github.com/users/AkihiroSuda/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/AkihiroSuda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AkihiroSuda/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/AkihiroSuda"
  }
}