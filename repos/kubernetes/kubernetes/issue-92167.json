{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/676637?v=4",
    "events_url": "https://api.github.com/users/feiskyer/events{/privacy}",
    "followers_url": "https://api.github.com/users/feiskyer/followers",
    "following_url": "https://api.github.com/users/feiskyer/following{/other_user}",
    "gists_url": "https://api.github.com/users/feiskyer/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/feiskyer",
    "id": 676637,
    "login": "feiskyer",
    "node_id": "MDQ6VXNlcjY3NjYzNw==",
    "organizations_url": "https://api.github.com/users/feiskyer/orgs",
    "received_events_url": "https://api.github.com/users/feiskyer/received_events",
    "repos_url": "https://api.github.com/users/feiskyer/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/feiskyer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/feiskyer/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/feiskyer"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/676637?v=4",
      "events_url": "https://api.github.com/users/feiskyer/events{/privacy}",
      "followers_url": "https://api.github.com/users/feiskyer/followers",
      "following_url": "https://api.github.com/users/feiskyer/following{/other_user}",
      "gists_url": "https://api.github.com/users/feiskyer/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/feiskyer",
      "id": 676637,
      "login": "feiskyer",
      "node_id": "MDQ6VXNlcjY3NjYzNw==",
      "organizations_url": "https://api.github.com/users/feiskyer/orgs",
      "received_events_url": "https://api.github.com/users/feiskyer/received_events",
      "repos_url": "https://api.github.com/users/feiskyer/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/feiskyer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/feiskyer/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/feiskyer"
    },
    {
      "avatar_url": "https://avatars1.githubusercontent.com/u/4178417?v=4",
      "events_url": "https://api.github.com/users/andyzhangx/events{/privacy}",
      "followers_url": "https://api.github.com/users/andyzhangx/followers",
      "following_url": "https://api.github.com/users/andyzhangx/following{/other_user}",
      "gists_url": "https://api.github.com/users/andyzhangx/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/andyzhangx",
      "id": 4178417,
      "login": "andyzhangx",
      "node_id": "MDQ6VXNlcjQxNzg0MTc=",
      "organizations_url": "https://api.github.com/users/andyzhangx/orgs",
      "received_events_url": "https://api.github.com/users/andyzhangx/received_events",
      "repos_url": "https://api.github.com/users/andyzhangx/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/andyzhangx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/andyzhangx/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/andyzhangx"
    }
  ],
  "author_association": "MEMBER",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\nOverview\r\n========\r\n\r\nA persistent volume claim / storage class configured in a certain way can cause all the Kube API servers on an ARO cluster to crashloop.\r\n\r\nWe\u2019ve seen this issue on a production cluster (ICM 192488792).  In development we have proven one vector by which the cluster could have got into this state but it doesn\u2019t seem that likely.  We wonder if there are other vectors.\r\n\r\nWe don\u2019t currently have a good way to rescue a cluster that gets into this state because our service accesses are predicated on API server availability.\r\n\r\nRequest\r\n=======\r\n\r\nWe would like help:\r\n\r\n1. to agree and expedite an appropriate fix in order to protect all other production clusters.\r\n2. with suggestions on how we might fix the broken production cluster.\r\n\r\nCauses\r\n======\r\n\r\n1. In certain cases upon PV create, the persistentvolume admission controller attempts to retrieve the managed disk object via the Azure API, but in ARO the relevant client object is a nil pointer.  The pointer is dereferenced and the kube API server panics.\r\n\r\n2. The PVC controller repeatedly attempts to create the PV object, which DoSes the kube API server.\r\n\r\n3. The client object in (1) is nil because of ARO\u2019s cloud provider authentication architecture, which differs from that of OCP.  More information below.\r\n\r\nTechnical detail\r\n================\r\n\r\nFor a panic stack trace and reproducer, see\r\n\r\n* Creation of an Azure Disk persistent volume is attempted\r\n* The persistentvolume admission controller runs, (l\r\n*persistentVolumeLabel) Admit(), in\r\nvendor/k8s.io/kubernetes/plugin/pkg/admission/storage/persistentvolume/label/admission.go:104\r\n* In our possible reproducer, the admission controller does not return early in (l *persistentVolumeLabel) findVolumeLabels(), admission.go:182 because the zone labels are not set.\r\n* A cloud provider is (incorrectly) instantiated via:\r\n   - getAzurePVLabeler(), admission.go:354\r\n   - cloudprovider.GetCloudProvider(), admission.go:333\r\n   - NewCloud(),\r\nvendor/k8s.io/kubernetes/staging/src/k8s.io/legacy-cloud-providers/azure/azure.go:262\r\n   - (az *Cloud) InitializeCloudFromConfig, azure.go:283\r\n* We see the following loglines:\r\n   - Azure cloud provider is starting without credentials\r\n   - Azure cloudprovider using try backoff: retries=%d, exponent=%f, duration=%d, jitter=%f\r\n* We believe that an early return occurs at azure.go:444, before c.DisksClient is initialised, because servicePrincipalToken is nil\r\n* Later, a nil pointer dereference of c.DisksClient occurs in (c *Cloud) GetAzureDiskLabels,\r\nvendor/k8s.io/kubernetes/staging/src/k8s.io/legacy-cloud-providers/azure/azure_managedDiskController.go:301\r\n\r\nOCP 4.3 cloud provider authentication architecture ==================================================\r\n\r\n* The installer lays down an Azure managed identity (MSI) resource, grants it Contributor access to cluster resource group and to any pre-existing virtual network (VNET).\r\n* In the context of the Kube API server, the persistentvolume admission controller uses MSI to authenticate to Azure for its API calls.\r\n\r\nARO 4.3 cloud provider authentication architecture ==================================================\r\n\r\n* ARO can\u2019t follow OCP 4.3\u2019s architecture because of the following chicken-and-egg problem:\r\n   - As an Azure service, ARO is not permitted to add role assignments to the customer\u2019s pre-existing virtual network - the customer must explicitly do this.\r\n   - No cluster managed identity can exist before the customer runs `az aro create` (by definition), so there is nothing for the customer to grant the role assignment to.\r\n* As a result, ARO does not use a managed identity at all, and instead uses a user-created cluster service principal.\r\n* ARO carries a patch to the installer which creates a kube-config/azure-cloud-provider Secret during cluster install.  The controller manager merges the cloud config with this Secret at start-up time (see `InitializeCloudFromSecret()`), however this code path does not run in the API server.  In ARO, any calls to the Azure API from the API server are probably broken.\r\n* Prior to GA, ARO wrote the cloud config secret raw into the cloud config.  Reverting to this behaviour would work around this issue, but is clearly suboptimal.\r\n\r\n\r\n\r\n**What you expected to happen**:\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): 1.16.2\r\n- Cloud provider or hardware configuration:\r\n- OS (e.g: `cat /etc/os-release`):\r\n- Kernel (e.g. `uname -a`):\r\n- Install tools:\r\n- Network plugin and version (if this is a network-related bug):\r\n- Others:\r\n\r\n/kind bug\r\n/assign @feiskyer \r\n/priority important-soon\r\n/sig cloud-provider\r\n/area provider/azure",
  "closed_at": "2020-06-18T13:02:33Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/92167/comments",
  "created_at": "2020-06-16T06:12:51Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/92167/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/92167",
  "id": 639398861,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Issues or PRs related to azure provider",
      "id": 852130786,
      "name": "area/provider/azure",
      "node_id": "MDU6TGFiZWw4NTIxMzA3ODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/provider/azure"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Cloud Provider.",
      "id": 958178286,
      "name": "sig/cloud-provider",
      "node_id": "MDU6TGFiZWw5NTgxNzgyODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cloud-provider"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/92167/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MzkzOTg4NjE=",
  "number": 92167,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "GetLabelsForVolume panic issue for azure disk PV",
  "updated_at": "2020-06-18T13:02:33Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/92167",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/4178417?v=4",
    "events_url": "https://api.github.com/users/andyzhangx/events{/privacy}",
    "followers_url": "https://api.github.com/users/andyzhangx/followers",
    "following_url": "https://api.github.com/users/andyzhangx/following{/other_user}",
    "gists_url": "https://api.github.com/users/andyzhangx/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/andyzhangx",
    "id": 4178417,
    "login": "andyzhangx",
    "node_id": "MDQ6VXNlcjQxNzg0MTc=",
    "organizations_url": "https://api.github.com/users/andyzhangx/orgs",
    "received_events_url": "https://api.github.com/users/andyzhangx/received_events",
    "repos_url": "https://api.github.com/users/andyzhangx/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/andyzhangx/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/andyzhangx/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/andyzhangx"
  }
}