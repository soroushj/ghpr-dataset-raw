{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "The `TopologyManager` is currently only guaranteed to work if a _single_ container in the pod spec requires aligned resources.\r\n\r\nThe reason for this is the following:\r\n\r\n* The admit handler for the `TopologyManager` loops through all containers, calling out to the `CPUManager` and `devicemanager` to generate hints for each of them individually, rather than on the entire pod as a whole.\r\n\r\n* Generating hints relies on looking at the current resource request and considering the current allocation state to figure out what the appropriate set of hints to send back should be.\r\n\r\n* However, the admit handler in the `TopologyManager` is called strictly before the `CPUManager` and `devicemanager` have the opportunity to do any device allocation.\r\n\r\n* This results in unreliable hint generation for all but the first container, since subsequent containers have no idea what the allocation state will be once that first container is allocated some resources.\r\n\r\nThis can be solved in one of two ways:\r\n\r\n1. Change the pod admit handler for the `TopologyManager` to loop through each container, first calling out to the `CPUManager` and `devicemanager` to generate hints and then immediately calling out to perform device allocation in the same iteration of the loop.\r\n\r\n1. Change the `TopologyManager` to do hint generation at the pod level rather than the container level. It is unclear if this is desirable, however, since each container should be able to have its resources aligned separately, and not forced to a single alignment for all resources across the entire pod.\r\n\r\nOption (1) seems like the better option, but it will require significant updates to both the `CPUManager` and the `devicemanager`. The `CPUManager` will need to be updated to support CPU allocation at pod admit time (currently it is done at container start time). The `devicemanager` will need to be updated to allocate devices on a container-by-container basis. Currently, it loops through the resource list for all containers at once and allocates devices to them accordingly.\r\n\r\nAs we iterate on a solution to this, we should update the existing KEPs for the [CPUManager](https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/cpu-manager.md) and [TopologyManager](https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/0035-20190130-topology-manager.md) with the proposed changes.\r\n\r\nTracking PRs:\r\n~~https://github.com/kubernetes/kubernetes/pull/84196 Refactor parts of CPUManager~~\r\n~~https://github.com/kubernetes/kubernetes/pull/84462 Update CPUManager state information~~\r\n~~https://github.com/kubernetes/kubernetes/pull/84300 Update logic in `CPUManager` `reconcileState()`~~\r\nTBD Refactor devicemanager Allocate / UpdatePluginResources logic\r\nTBD Move CPU allocation to pod admit time instead of container start time\r\nTBD Update the `devicemanager` to allocate devices on a container-by-container basis\r\nTBD Move TopologyHint generation and final resource allocation into the same synchronous loop\r\n",
  "closed_at": "2020-03-05T04:12:38Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83476/comments",
  "created_at": "2019-10-03T20:41:47Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83476/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/83476",
  "id": 502286981,
  "labels": [
    {
      "color": "c7def8",
      "default": false,
      "description": "Categorizes issue or PR as related to a new feature.",
      "id": 267761362,
      "name": "kind/feature",
      "node_id": "MDU6TGFiZWwyNjc3NjEzNjI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/feature"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Node.",
      "id": 173493665,
      "name": "sig/node",
      "node_id": "MDU6TGFiZWwxNzM0OTM2NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/node"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83476/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MDIyODY5ODE=",
  "number": 83476,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "TopologyManager: Guarantee Aligned resources for Multiple Containers",
  "updated_at": "2020-03-05T04:12:38Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83476",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/96419?v=4",
    "events_url": "https://api.github.com/users/klueska/events{/privacy}",
    "followers_url": "https://api.github.com/users/klueska/followers",
    "following_url": "https://api.github.com/users/klueska/following{/other_user}",
    "gists_url": "https://api.github.com/users/klueska/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/klueska",
    "id": 96419,
    "login": "klueska",
    "node_id": "MDQ6VXNlcjk2NDE5",
    "organizations_url": "https://api.github.com/users/klueska/orgs",
    "received_events_url": "https://api.github.com/users/klueska/received_events",
    "repos_url": "https://api.github.com/users/klueska/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/klueska/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/klueska/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/klueska"
  }
}