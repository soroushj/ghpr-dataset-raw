{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "**What happened**:\r\n\r\nUsing a `scale` command such as:\r\n```\r\nkubectl scale -n kube-system machinedeployment marko-1-pool1 --replicas=2\r\n```\r\n\r\nfails with the following error:\r\n\r\n```\r\nThe machinedeployments \"marko-1-pool1\" is invalid: metadata.resourceVersion: Invalid value: 0x0: must be specified for an update\r\n```\r\n\r\nThis bug happens on each run and started occurring as of `kubectl` v1.15.0. With `kubectl` v1.14 or older, I don't have such problem, i.e. it works flawlessly.\r\n\r\n\r\n**What you expected to happen**:\r\n\r\nThe `kubectl scale` command succeeds:\r\n\r\n```\r\nmachinedeployment.cluster.k8s.io/marko-1-pool1 scaled\r\n```\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nCreate a CRD that has the scale subresource and try to scale a CR using `kubectl`. Example of such CRD can be found [here](https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#scale-subresource).\r\n\r\n**Anything else we need to know?**:\r\n\r\nRegarding the `kubectl` bug, it seems that it started appearing as of #75210. Before the PR, we always fetched the resource and it worked because it had the resource version, while now we are only fetching it in case preconditions are provided (preconditions are not provided by default/when using `kubectl`).\r\n\r\nHere is the `-v8` output of a `kubectl scale` command:\r\n```\r\nI0724 13:21:30.988579    9001 loader.go:359] Config loaded from file:  /home/marko/Projects/src/github.com/kubermatic/kubeone/examples/terraform/aws/marko-1-kubeconfig\r\nI0724 13:21:30.998409    9001 round_trippers.go:416] GET https://<redacted>:6443/apis/cluster.k8s.io/v1alpha1/namespaces/kube-system/machinedeployments/marko-1-pool1\r\nI0724 13:21:30.998427    9001 round_trippers.go:423] Request Headers:\r\nI0724 13:21:30.998436    9001 round_trippers.go:426]     Accept: application/json\r\nI0724 13:21:30.998445    9001 round_trippers.go:426]     User-Agent: kubectl/v1.15.1 (linux/amd64) kubernetes/4485c6f\r\nI0724 13:21:31.156732    9001 round_trippers.go:441] Response Status: 200 OK in 158 milliseconds\r\nI0724 13:21:31.156763    9001 round_trippers.go:444] Response Headers:\r\nI0724 13:21:31.156780    9001 round_trippers.go:447]     Date: Wed, 24 Jul 2019 11:21:31 GMT\r\nI0724 13:21:31.156807    9001 round_trippers.go:447]     Content-Type: application/json\r\nI0724 13:21:31.156823    9001 round_trippers.go:447]     Content-Length: 2281\r\nI0724 13:21:31.156893    9001 request.go:947] Response Body: {\"apiVersion\":\"cluster.k8s.io/v1alpha1\",\"kind\":\"MachineDeployment\",\"metadata\":{\"annotations\":{\"machinedeployment.clusters.k8s.io/revision\":\"1\"},\"creationTimestamp\":\"2019-07-24T10:06:54Z\",\"generation\":3,\"name\":\"marko-1-pool1\",\"namespace\":\"kube-system\",\"resourceVersion\":\"6229\",\"selfLink\":\"/apis/cluster.k8s.io/v1alpha1/namespaces/kube-system/machinedeployments/marko-1-pool1\",\"uid\":\"93ec8c7c-c4b0-459c-9a22-f1aab1d25214\"},\"spec\":{\"minReadySeconds\":0,\"progressDeadlineSeconds\":600,\"replicas\":3,\"revisionHistoryLimit\":1,\"selector\":{\"matchLabels\":{\"workerset\":\"marko-1-pool1\"}},\"strategy\":{\"rollingUpdate\":{\"maxSurge\":1,\"maxUnavailable\":0},\"type\":\"RollingUpdate\"},\"template\":{\"metadata\":{\"creationTimestamp\":null,\"labels\":{\"workerset\":\"marko-1-pool1\"},\"namespace\":\"kube-system\"},\"spec\":{\"metadata\":{\"creationTimestamp\":null,\"labels\":{\"workerset\":\"marko-1-pool1\"}},\"providerSpec\":{ <redacted> [truncated 1257 chars]\r\nI0724 13:21:31.163767    9001 request.go:947] Request Body: {\"kind\":\"Scale\",\"apiVersion\":\"autoscaling/v1\",\"metadata\":{\"name\":\"marko-1-pool1\",\"namespace\":\"kube-system\",\"creationTimestamp\":null},\"spec\":{\"replicas\":2},\"status\":{\"replicas\":0}}\r\nI0724 13:21:31.163841    9001 round_trippers.go:416] PUT https://marko-1-api-lb-06aba60d7183279e.elb.eu-west-3.amazonaws.com:6443/apis/cluster.k8s.io/v1alpha1/namespaces/kube-system/machinedeployments/marko-1-pool1/scale\r\nI0724 13:21:31.163853    9001 round_trippers.go:423] Request Headers:\r\nI0724 13:21:31.163862    9001 round_trippers.go:426]     Accept: application/json, */*\r\nI0724 13:21:31.163871    9001 round_trippers.go:426]     User-Agent: kubectl/v1.15.1 (linux/amd64) kubernetes/4485c6f\r\nI0724 13:21:31.207621    9001 round_trippers.go:441] Response Status: 422 Unprocessable Entity in 43 milliseconds\r\nI0724 13:21:31.207653    9001 round_trippers.go:444] Response Headers:\r\nI0724 13:21:31.207672    9001 round_trippers.go:447]     Content-Type: application/json\r\nI0724 13:21:31.207687    9001 round_trippers.go:447]     Content-Length: 482\r\nI0724 13:21:31.207702    9001 round_trippers.go:447]     Date: Wed, 24 Jul 2019 11:21:31 GMT\r\nI0724 13:21:31.207789    9001 request.go:947] Response Body: {\"kind\":\"Status\",\"apiVersion\":\"v1\",\"metadata\":{},\"status\":\"Failure\",\"message\":\"machinedeployments.cluster.k8s.io \\\"marko-1-pool1\\\" is invalid: metadata.resourceVersion: Invalid value: 0x0: must be specified for an update\",\"reason\":\"Invalid\",\"details\":{\"name\":\"marko-1-pool1\",\"group\":\"cluster.k8s.io\",\"kind\":\"machinedeployments\",\"causes\":[{\"reason\":\"FieldValueInvalid\",\"message\":\"Invalid value: 0x0: must be specified for an update\",\"field\":\"metadata.resourceVersion\"}]},\"code\":422}\r\nF0724 13:21:31.208216    9001 helpers.go:114] The machinedeployments \"marko-1-pool1\" is invalid: metadata.resourceVersion: Invalid value: 0x0: must be specified for an update\r\n```\r\n\r\nIf I manually craft the request that has the resource version (or use the `--resource-version` flag), it works.\r\n\r\n```\r\n{\"kind\":\"Scale\",\"apiVersion\":\"autoscaling/v1\",\"metadata\":{\"name\":\"marko-1-pool1\",\"namespace\":\"kube-system\",\"creationTimestamp\":null,\"resourceVersion\":\"6229\"},\"spec\":{\"replicas\":3},\"status\":{\"replicas\":0}}\r\n```\r\n\r\nIs it as expected that the `autoscaling/v1` Scale resource requires the resource version in order for update to succeed? Shouldn't it always pick the latest resource version in case it isn't provided?\r\n\r\nOn that note, I also noticed that if you want to update a CR by crafting the request manually and using `curl`, you also need to specify the resource version or you will get the same error. I'm not sure if this is expected and related, but I'm writing it down as it might be related. As far as I know, this is not required for some native resources at all, but I'm not sure is this the case for CRDs.\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"15\", GitVersion:\"v1.15.1\", GitCommit:\"4485c6f18cee9a5d3c3b4e523bd27972b1b53892\", GitTreeState:\"clean\", BuildDate:\"2019-07-18T09:18:22Z\", GoVersion:\"go1.12.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"15\", GitVersion:\"v1.15.1\", GitCommit:\"4485c6f18cee9a5d3c3b4e523bd27972b1b53892\", GitTreeState:\"clean\", BuildDate:\"2019-07-18T09:09:21Z\", GoVersion:\"go1.12.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```",
  "closed_at": "2019-11-14T07:13:35Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 12,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80515/comments",
  "created_at": "2019-07-24T11:39:26Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80515/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/80515",
  "id": 472234454,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80515/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": null,
    "closed_issues": 1674,
    "created_at": "2019-01-21T20:12:05Z",
    "creator": {
      "avatar_url": "https://avatars0.githubusercontent.com/u/980082?v=4",
      "events_url": "https://api.github.com/users/liggitt/events{/privacy}",
      "followers_url": "https://api.github.com/users/liggitt/followers",
      "following_url": "https://api.github.com/users/liggitt/following{/other_user}",
      "gists_url": "https://api.github.com/users/liggitt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/liggitt",
      "id": 980082,
      "login": "liggitt",
      "node_id": "MDQ6VXNlcjk4MDA4Mg==",
      "organizations_url": "https://api.github.com/users/liggitt/orgs",
      "received_events_url": "https://api.github.com/users/liggitt/received_events",
      "repos_url": "https://api.github.com/users/liggitt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/liggitt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/liggitt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/liggitt"
    },
    "description": null,
    "due_on": null,
    "html_url": "https://github.com/kubernetes/kubernetes/milestone/43",
    "id": 3990944,
    "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/43/labels",
    "node_id": "MDk6TWlsZXN0b25lMzk5MDk0NA==",
    "number": 43,
    "open_issues": 17,
    "state": "open",
    "title": "v1.17",
    "updated_at": "2020-10-27T18:45:51Z",
    "url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/43"
  },
  "node_id": "MDU6SXNzdWU0NzIyMzQ0NTQ=",
  "number": 80515,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kubectl scale fails to scale a CustomResource if resourceVersion is not provided",
  "updated_at": "2019-11-14T07:13:35Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80515",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/18719127?v=4",
    "events_url": "https://api.github.com/users/xmudrii/events{/privacy}",
    "followers_url": "https://api.github.com/users/xmudrii/followers",
    "following_url": "https://api.github.com/users/xmudrii/following{/other_user}",
    "gists_url": "https://api.github.com/users/xmudrii/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/xmudrii",
    "id": 18719127,
    "login": "xmudrii",
    "node_id": "MDQ6VXNlcjE4NzE5MTI3",
    "organizations_url": "https://api.github.com/users/xmudrii/orgs",
    "received_events_url": "https://api.github.com/users/xmudrii/received_events",
    "repos_url": "https://api.github.com/users/xmudrii/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/xmudrii/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/xmudrii/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/xmudrii"
  }
}