{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**What happened**:\r\nAn aks-engine cluster with a user assigned managed service cluster identity fails to authenticate to azure container registries in private clouds when the proper (acrpull) azure role assignments are in place and when there are no image pull secrets.\r\n\r\n**What you expected to happen**:\r\nThe cluster should be able to authenticate and pull from an ACR hosted in the same azure cloud without needing additional pull secrets when the cluster identity has the proper acrpull azure role assignment, no matter which azure cloud it is operating in.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nAssume you have a private azure cloud where every url ends with \"my.cloud\". That would mean the ACR suffix would be `.azurecr.my.cloud`. Let's pretend you have an ACR at `test.azurecr.my.cloud` and you try to deploy a pod in your cluster referencing the image `test.azurecr.my.cloud/helloworld:latest`. This will fail to pull when you have no image pull secrets.\r\n\r\n**Anything else we need to know?**:\r\nThe problem stems from the following lines where expected ACR suffix domains are hardcoded:\r\nhttps://github.com/kubernetes/kubernetes/blob/master/pkg/credentialprovider/azure/azure_credentials.go#L49-L50\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): 1.16.9\r\n- Cloud provider or hardware configuration: Azure private\r\n- OS: ubuntu 16.0.4\r\n- Network plugin and version: Azure CNI\r\n",
  "closed_at": "2020-04-25T03:43:30Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/90412/comments",
  "created_at": "2020-04-23T19:07:28Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/90412/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/90412",
  "id": 605788818,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Issues or PRs related to azure provider",
      "id": 852130786,
      "name": "area/provider/azure",
      "node_id": "MDU6TGFiZWw4NTIxMzA3ODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/provider/azure"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Cloud Provider.",
      "id": 958178286,
      "name": "sig/cloud-provider",
      "node_id": "MDU6TGFiZWw5NTgxNzgyODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cloud-provider"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/90412/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MDU3ODg4MTg=",
  "number": 90412,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Azure credential provider does not authenticate to ACR in all clouds",
  "updated_at": "2020-04-25T03:43:30Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/90412",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/18634904?v=4",
    "events_url": "https://api.github.com/users/DavidParks8/events{/privacy}",
    "followers_url": "https://api.github.com/users/DavidParks8/followers",
    "following_url": "https://api.github.com/users/DavidParks8/following{/other_user}",
    "gists_url": "https://api.github.com/users/DavidParks8/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/DavidParks8",
    "id": 18634904,
    "login": "DavidParks8",
    "node_id": "MDQ6VXNlcjE4NjM0OTA0",
    "organizations_url": "https://api.github.com/users/DavidParks8/orgs",
    "received_events_url": "https://api.github.com/users/DavidParks8/received_events",
    "repos_url": "https://api.github.com/users/DavidParks8/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/DavidParks8/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/DavidParks8/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/DavidParks8"
  }
}