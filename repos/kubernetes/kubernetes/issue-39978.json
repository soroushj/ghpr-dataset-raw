{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**Is this a request for help?**: No\r\n\r\n\r\n**What keywords did you search in Kubernetes issues before filing this one?**: openstack cinder volume instanceid nodename\r\n\r\n---\r\n\r\n**Is this a BUG REPORT or FEATURE REQUEST?** (choose one): BUG REPORT\r\n\r\n<!--\r\nIf this is a BUG REPORT, please:\r\n  - Fill in as much of the template below as you can.  If you leave out\r\n    information, we can't help you as well.\r\n\r\nIf this is a FEATURE REQUEST, please:\r\n  - Describe *in detail* the feature/behavior/change you'd like to see.\r\n\r\nIn both cases, be ready for followup questions, and please respond in a timely\r\nmanner.  If we can't reproduce a bug or think a feature already exists, we\r\nmight close your issue.  If we're wrong, PLEASE feel free to reopen it and\r\nexplain why.\r\n-->\r\n\r\n**Kubernetes version** (use `kubectl version`): v1.5.1\r\n\r\n**Environment**:\r\n- **Cloud provider or hardware configuration**: Openstack Liberty\r\n- **OS** (e.g. from /etc/os-release): Red Hat Enterprise Linux Server 7.2 (Maipo)\r\n- **Kernel** (e.g. `uname -a`): 3.10.0-327.36.2.el7.x86_64 #1 SMP\r\n\r\n**What happened**: The Cinder volume was not remounted to other node after POD was rescheduled.\r\n\r\n\r\n**What you expected to happen**: Cinder volume is detached from previous node mounted on a new one.\r\n\r\n\r\n**How to reproduce it** (as minimally and precisely as possible):\r\n\r\n1. Create a PVC using Cinder;\r\n2. Create a POD under replication controller with one replica using that PVC;\r\n3. Wait for POD to be scheduled and started;\r\n4. Cordon the node where POD is running;\r\n5. Delete the POD;\r\n6. POD is rescheduled to another node, but volume is not attached - it keeps attaching and detaching it to the new node;\r\n\r\n**Anything else do we need to know**:\r\n\r\nLogs showing that attachment succeeds, but when attacher performs rechecking during reconciliation cycle, it incorrectly decides that volume is not attached any longer:\r\n\r\n```\r\nI0113 23:45:20.854316       7 reconciler.go:202] Started AttachVolume for volume \"kubernetes.io/cinder/7c0ef8d0-fa65-41b5-b634-098305579935\" to node \"ak8s-worker-1\"\r\nI0113 23:45:22.116749       7 openstack_volumes.go:126] 7c0ef8d0-fa65-41b5-b634-098305579935 kubernetes-dynamic-pvc-6635944c-d431-11e6-a6be-fa163e24f3a8 [map[server_id:b6e0e07c-d64b-45bc-b09d-f8784fa4fbf7 attachment_id:fc236602-3f75-4a6e-beb7-12eeed453cca host_name:<nil> volume_id:7c0ef8d0-fa65-41b5-b634-098305579935 device:/dev/vde id:7c0ef8d0-fa65-41b5-b634-098305579935]]\r\nI0113 23:45:22.116793       7 attacher.go:92] Attach operation is successful. volume \"7c0ef8d0-fa65-41b5-b634-098305579935\" is already attached to instance \"b6e0e07c-d64b-45bc-b09d-f8784fa4fbf7\".\r\nI0113 23:45:22.603837       7 openstack_volumes.go:126] 7c0ef8d0-fa65-41b5-b634-098305579935 kubernetes-dynamic-pvc-6635944c-d431-11e6-a6be-fa163e24f3a8 [map[attachment_id:fc236602-3f75-4a6e-beb7-12eeed453cca host_name:<nil> volume_id:7c0ef8d0-fa65-41b5-b634-098305579935 device:/dev/vde id:7c0ef8d0-fa65-41b5-b634-098305579935 server_id:b6e0e07c-d64b-45bc-b09d-f8784fa4fbf7]]\r\nI0113 23:45:22.603879       7 operation_generator.go:217] AttachVolume.Attach succeeded for volume \"kubernetes.io/cinder/7c0ef8d0-fa65-41b5-b634-098305579935\" (spec.Name: \"pvc-6635944c-d431-11e6-a6be-fa163e24f3a8\") from node \"ak8s-worker-1\".\r\nI0113 23:45:22.603967       7 actual_state_of_world.go:447] Report volume \"kubernetes.io/cinder/7c0ef8d0-fa65-41b5-b634-098305579935\" as attached to node \"ak8s-worker-1\"\r\nI0113 23:45:22.682490       7 node_status_updater.go:136] Updating status for node \"ak8s-worker-1\" succeeded. patchBytes: \"{}\" VolumesAttached: [{kubernetes.io/cinder/7c0ef8d0-fa65-41b5-b634-098305579935 /dev/vde}]\r\nI0113 23:45:23.078355       7 actual_state_of_world.go:343] SetVolumeMountedByNode volume kubernetes.io/cinder/7c0ef8d0-fa65-41b5-b634-098305579935 to the node \"ak8s-worker-1\" mounted true\r\nI0113 23:45:23.767648       7 openstack_volumes.go:126] 7c0ef8d0-fa65-41b5-b634-098305579935 kubernetes-dynamic-pvc-6635944c-d431-11e6-a6be-fa163e24f3a8 [map[host_name:<nil> volume_id:7c0ef8d0-fa65-41b5-b634-098305579935 device:/dev/vde id:7c0ef8d0-fa65-41b5-b634-098305579935 server_id:b6e0e07c-d64b-45bc-b09d-f8784fa4fbf7 attachment_id:fc236602-3f75-4a6e-beb7-12eeed453cca]]\r\nI0113 23:45:23.767768       7 attacher.go:140] VolumesAreAttached: check volume \"7c0ef8d0-fa65-41b5-b634-098305579935\" (specName: \"pvc-6635944c-d431-11e6-a6be-fa163e24f3a8\") is no longer attached\r\nI0113 23:45:23.768069       7 operation_generator.go:162] VerifyVolumesAreAttached determined volume \"kubernetes.io/cinder/7c0ef8d0-fa65-41b5-b634-098305579935\" (spec.Name: \"pvc-6635944c-d431-11e6-a6be-fa163e24f3a8\") is no longer attached to node \"ak8s-worker-1\", therefore it was marked as detached.\r\nI0113 23:45:23.787455       7 reconciler.go:202] Started AttachVolume for volume \"kubernetes.io/cinder/7c0ef8d0-fa65-41b5-b634-098305579935\" to node \"ak8s-worker-1\"\r\n\r\n```\r\n\r\nLater analysis showed that Cinder attacher uses [NodeName, instead of instanceID](https://github.com/kubernetes/kubernetes/blob/6a4d5cd7cc58e28c20ca133dab7b0e9e56192fe3/pkg/volume/cinder/attacher.go#L127), compare e.g. with [Attach operation](https://github.com/kubernetes/kubernetes/blob/6a4d5cd7cc58e28c20ca133dab7b0e9e56192fe3/pkg/volume/cinder/attacher.go#L75-L82) and [DisksAreAttached]( https://github.com/kubernetes/kubernetes/blob/6a4d5cd7cc58e28c20ca133dab7b0e9e56192fe3/pkg/cloudprovider/providers/openstack/openstack_volumes.go#L258)",
  "closed_at": "2017-02-10T15:53:58Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/39978/comments",
  "created_at": "2017-01-16T23:21:17Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/39978/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/39978",
  "id": 201139553,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Issues or PRs related to openstack provider",
      "id": 239914558,
      "name": "area/provider/openstack",
      "node_id": "MDU6TGFiZWwyMzk5MTQ1NTg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/provider/openstack"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Storage.",
      "id": 169428334,
      "name": "sig/storage",
      "node_id": "MDU6TGFiZWwxNjk0MjgzMzQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/storage"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/39978/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyMDExMzk1NTM=",
  "number": 39978,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Cinder volumes attacher uses NodeName instead of instanceID",
  "updated_at": "2017-02-10T15:53:58Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/39978",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1183043?v=4",
    "events_url": "https://api.github.com/users/DukeXar/events{/privacy}",
    "followers_url": "https://api.github.com/users/DukeXar/followers",
    "following_url": "https://api.github.com/users/DukeXar/following{/other_user}",
    "gists_url": "https://api.github.com/users/DukeXar/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/DukeXar",
    "id": 1183043,
    "login": "DukeXar",
    "node_id": "MDQ6VXNlcjExODMwNDM=",
    "organizations_url": "https://api.github.com/users/DukeXar/orgs",
    "received_events_url": "https://api.github.com/users/DukeXar/received_events",
    "repos_url": "https://api.github.com/users/DukeXar/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/DukeXar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/DukeXar/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/DukeXar"
  }
}