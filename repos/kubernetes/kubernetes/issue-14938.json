{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "I'm seeing a bug where the network plugin fails to configure networking, and yet the containers for this pod are still deployed (without networking configured).\n\nIt looks like the following is occurring:\n1) Kubelet attempts to create infra container in `SyncPod`\n2) Network plugin fails, returns error code.\n3) Kubelet detects error and skips pod creation but does not tear down the infra container\n4) On the next `SyncPod` call, the kubelet detects that the infra container is running and deploys the other containers in the pod.\n\nThe fix here is for the kubelet to clean up the infra container in `SyncPod` when it receives the error from the network plugin and before it returns.\n\nHere are some logs illustrating the steps I described above:\n\n```\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: I1001 14:24:07.079239   11828 exec.go:137] SetUpPod 'exec' network plugin output: , exit status 1\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: E1001 14:24:07.079680   11828 manager.go:1735] Failed to create pod infra container: exit status 1; Skipping pod \"busybox_default\"\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: I1001 14:24:07.079928   11828 kubelet.go:2529] Generating status for \"busybox_default\"\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: I1001 14:24:07.088250   11828 manager.go:309] Container inspect result: {ID:8ff588a7a7559041d43ed570b800304d29284573b3c8b257154380608c11d8c7 Created:20\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: I1001 14:24:07.259391   11828 exec.go:149] Status 'exec' network plugin output: {\"ip\": \"192.168.1.3\", \"kind\": \"PodNetworkStatus\", \"apiVersion\": \"v1beta\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: , <nil>\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: I1001 14:24:07.261488   11828 kubelet.go:2462] pod waiting > 0, pending\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: E1001 14:24:07.261722   11828 pod_workers.go:112] Error syncing pod bd529a96-6882-11e5-9b85-0800273209ca, skipping: exit status 1\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: I1001 14:24:07.262183   11828 server.go:660] Event(api.ObjectReference{Kind:\"Pod\", Namespace:\"default\", Name:\"busybox\", UID:\"bd529a96-6882-11e5-9b85-08\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: I1001 14:24:07.270336   11828 status_manager.go:199] Status for pod \"busybox_default\" updated successfully\nOct 01 14:24:07 cd4-node-1 kubelet[11828]: I1001 14:24:07.272000   11828 config.go:257] Setting pods for source api\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.642037   11828 kubelet.go:1924] SyncLoop (periodic sync)\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.642682   11828 kubelet.go:1888] SyncLoop (housekeeping)\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.649633   11828 docker.go:368] Docker Container: /calico-node is not managed by kubelet.\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.649772   11828 kubelet.go:2529] Generating status for \"busybox_default\"\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.664808   11828 docker.go:368] Docker Container: /calico-node is not managed by kubelet.\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.666875   11828 manager.go:309] Container inspect result: {ID:8ff588a7a7559041d43ed570b800304d29284573b3c8b257154380608c11d8c7 Created:20\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.760358   11828 docker.go:368] Docker Container: /calico-node is not managed by kubelet.\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.851098   11828 exec.go:149] Status 'exec' network plugin output: {\"ip\": \"192.168.1.3\", \"kind\": \"PodNetworkStatus\", \"apiVersion\": \"v1beta\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: , <nil>\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.852981   11828 kubelet.go:2462] pod waiting > 0, pending\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.853209   11828 manager.go:1558] Syncing Pod &{TypeMeta:{Kind: APIVersion:} ObjectMeta:{Name:busybox GenerateName: Namespace:default Self\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.853849   11828 manager.go:1569] Found pod infra container for \"busybox_default\"\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.855037   11828 manager.go:1582] Pod infra container looks good, keep it \"busybox_default\"\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.855247   11828 manager.go:1597] Container {Name:busybox Image:busybox Command:[sleep 3600] Args:[] WorkingDir: Ports:[] Env:[] Resources\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.855454   11828 manager.go:1688] Got container changes for pod \"busybox_default\": {StartInfraContainer:false InfraContainerId:8ff588a7a75\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.855648   11828 manager.go:1760] Creating container &{Name:busybox Image:busybox Command:[sleep 3600] Args:[] WorkingDir: Ports:[] Env:[]\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.856956   11828 manager.go:681] Container default/busybox/busybox: setting entrypoint \"[sleep 3600]\" and command \"[]\"\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.858634   11828 server.go:660] Event(api.ObjectReference{Kind:\"Pod\", Namespace:\"default\", Name:\"busybox\", UID:\"bd529a96-6882-11e5-9b85-08\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.878622   11828 docker.go:368] Docker Container: /calico-node is not managed by kubelet.\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.882184   11828 server.go:660] Event(api.ObjectReference{Kind:\"Pod\", Namespace:\"default\", Name:\"busybox\", UID:\"bd529a96-6882-11e5-9b85-08\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.910220   11828 factory.go:78] Using factory \"docker\" for container \"/system.slice/docker-430aeb280aa8beeeefaf8304b6ee89fcdaae05235aec53d\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.910465   11828 server.go:660] Event(api.ObjectReference{Kind:\"Pod\", Namespace:\"default\", Name:\"busybox\", UID:\"bd529a96-6882-11e5-9b85-08\nOct 01 14:24:13 cd4-node-1 kubelet[11828]: I1001 14:24:13.915664   11828 kubelet.go:2529] Generating status for \"busybox_default\"\n```\n",
  "closed_at": "2015-10-12T18:48:02Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/7740897?v=4",
    "events_url": "https://api.github.com/users/dchen1107/events{/privacy}",
    "followers_url": "https://api.github.com/users/dchen1107/followers",
    "following_url": "https://api.github.com/users/dchen1107/following{/other_user}",
    "gists_url": "https://api.github.com/users/dchen1107/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/dchen1107",
    "id": 7740897,
    "login": "dchen1107",
    "node_id": "MDQ6VXNlcjc3NDA4OTc=",
    "organizations_url": "https://api.github.com/users/dchen1107/orgs",
    "received_events_url": "https://api.github.com/users/dchen1107/received_events",
    "repos_url": "https://api.github.com/users/dchen1107/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/dchen1107/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dchen1107/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/dchen1107"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/14938/comments",
  "created_at": "2015-10-01T21:44:55Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/14938/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/14938",
  "id": 109391535,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Node.",
      "id": 173493665,
      "name": "sig/node",
      "node_id": "MDU6TGFiZWwxNzM0OTM2NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/node"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/14938/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxMDkzOTE1MzU=",
  "number": 14938,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Pod still created if network plugin returns error",
  "updated_at": "2015-10-12T18:48:02Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/14938",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1944093?v=4",
    "events_url": "https://api.github.com/users/caseydavenport/events{/privacy}",
    "followers_url": "https://api.github.com/users/caseydavenport/followers",
    "following_url": "https://api.github.com/users/caseydavenport/following{/other_user}",
    "gists_url": "https://api.github.com/users/caseydavenport/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/caseydavenport",
    "id": 1944093,
    "login": "caseydavenport",
    "node_id": "MDQ6VXNlcjE5NDQwOTM=",
    "organizations_url": "https://api.github.com/users/caseydavenport/orgs",
    "received_events_url": "https://api.github.com/users/caseydavenport/received_events",
    "repos_url": "https://api.github.com/users/caseydavenport/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/caseydavenport/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/caseydavenport/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/caseydavenport"
  }
}