{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "#33538 has the pull request for the proposal.\n# Flex Volume API Proposal\n## Abstract\n\nThe goal of this proposal is to extend and enhance the existing flex volume storage plugin model (#13840). It bridges the gap with existing in-tree plugins and defines a stable api.\n## Background:\n\nExisting flex volume plugin enables administrators/vendors to create out-of-tree volume plugins, i.e., plugins which do not reside in Kubernetes project. But, it has the following gaps.\n- It lacks support for the latest enhancements to in-tree plugins like dynamic provisioning and centralized attach-detach controller\n- It does not define a stable driver api for administrators/vendors to work.\n- The current flex volume plugin deployment model is not suitable for environments like GCE & CoreOS, where access to the root file system is restricted. And in other environments the overall user experience is poor, as it requires manual installation of the plugin on every node and restart of kubelets & controller manager. This issue is covered in detail in another PR.\n### Goals:\n\nThe goals of this proposal are \n- Define new stable driver API.\n- Add support for dynamic provisioning and centralized attach-detach controller and\n- The biggest advantage of flex volume is it\u2019s simplicity. It is just an adapter around the internal api. We will keep it simple in the new design and try to follow the same adapter pattern.\n### Non Goals:\n- This proposal does not the address the poor installation model of existing model. It is covered in another PR.\n- This proposal uses the existing \u2018exec\u2019 plugin model. A rest callout model will be covered in another PR.\n## Terminology:\n\n**Plugin**: refers to flex volume plugin.\n**Plugin Driver api**: API calls defined by flex volume plugin.\n**Plugin Driver**: Out-of-tree driver/plugin which implements plugin driver api.\n**In-tree plugin**: Plugins which are included in Kubernetes project/source tree.\n## API:\n\nExisting flex volume plugin driver api are in alpha phase and are subject to change between kubernetes versions. This section proposes stable api for plugin driver writers to work with.\n### Proposal 1:\n\nExpose the existing in-tree plugin API as driver API. For more details on existing in-tree plugin API please refer to https://github.com/kubernetes/kubernetes/blob/master/pkg/volume/volume.go\n###### Pros:\n- In-tree plugins are already using these API.\n- Simple and clean interface.\n###### Cons:\n- No standard request & response API objects.\n- No versioning support.\n- Does not follow REST model.\n- Many call outs. For full support, a plugin has to implement 17 APIs.\n\nThis was discussed in the storage-sig face to face and in lieu the following is proposed.\n### Proposal 2:\n\nProposes fewer APIs with stable request & response API objects.\n###### Pros:\n- Has standard request & response API objects.\n- Supports versioning.\n- Follows REST model.\n- Fewer calls.\n- Simple and clean interface.\n###### Cons:\n- New API objects.\n#### APIs\n#### Probe Plugin:\n\nThis call probes the plugin for it\u2019s capabilities and supported options. Supported options are used to validate and reject pod spec. This is executed from both the Controller-manager and Kubelet.\n###### New API Types:\n\n``` go\ntype FlexVolumeDriverCapabilities struct {\n    ReadWrite api.PersistentVolumeAccessMode\n    DynamicProvisioning bool\n    Attachment bool        // Do we need separate capability for remote & local attachments support? Some drivers like ISCSI do not support attachment from remote node (controller manager).\n    SELinux bool\n    OwnershipManagement bool\n    Metrics bool\n}\n\ntype FlexVolumeDriverSpec struct {\n    Name string     // name of the driver. Ex: ganesh-nfs\n    Driver string   // Actual driver path. Ex: ganesha/nfs\n}\ntype FlexVolumeDriver struct {\n    unversioned.TypeMeta\n    v1.ObjectMeta\n    Spec FlexVolumeDriverSpec\n    Capabilities FlexVolumeDriverCapabilities\n    SupportedOptions []string // Driver options supported.\n}\n```\n###### Request:\n\n```\nnil\n```\n###### Response:\n\nOn success:\n\n```\nFlexVolumeDriver\n```\n\nOn failure:\n\n```\nnon-zero exit code & errors.StatusError\n```\n###### Call out:\n\n```\n<driver executable> probe\n```\n#### Provision/Create a volume:\n\nThis call creates a volume. It is executed from Controller-manager.\n###### New API Types:\n\n``` go\nType FlexVolumeStatus string\n\ntype FlexVolume struct {\n    unversioned.TypeMeta\n    v1.ObjectMeta\n    Spec api.FlexVolumeSource\n    Status FlexVolumeStatus\n}\n```\n###### Request:\n\n```\nFlexVolume\n```\n###### Response:\n\nOn success:\n\n```\napi.FlexVolume\n```\n\nOn failure:\n\n```\nnon-zero exit code & errors.StatusError\n```\n###### Call out:\n\n```\n<driver executable> create <json encoded api.FlexVolume>\n```\n#### Delete a volume:\n\nThis call deletes a volume. It is executed from Controller-manager.\n###### Request:\n\n```\nFlexVolume\n```\n###### Response:\n\nOn success:\n\n```\n0 exit code\n```\n\nOn failure:\n\n```\nnon-zero exit code & errors.StatusError\n```\n###### Call out:\n\n```\n<driver executable> delete <json encoded api.FlexVolume>\n```\n#### Attach a volume:\n\nThis call attaches a volume to a remote host or local host. It can be executed from Controller-manager/Kubelet depending on whether Controller-attach-detach is enabled or not.. This is only valid for drivers which support attach & detach.\n\nThe following additional options are passed to the plugin as part of options map in FlexVolumeSource.\n\n```\n\u201ckubernetes.io/host\u201d=\u201d<host-name>\u201d\n\u201ckubernetes.io/mountpath\u201d=\u201d<mount path>\u201d\n```\n###### New API Types:\n\n``` go\ntype FlexVolumeAttachment struct {\n    unversioned.TypeMeta\n    v1.ObjectMeta\n    Host string\n    Device string\n    MountPath string\n}\n```\n###### Request:\n\n```\nFlexVolume\n```\n###### Response:\n\nOn success:\n\n```\nFlexVolumeAttachment\n```\n\nOn failure:\n\n```\nnon-zero exit code & errors.StatusError\n```\n###### Call out:\n\n```\n<driver executable> attach <json encoded FlexVolume>\n```\n###### Call out sync: (Wait for attach):\n\n```\n<driver executable> attach <json encoded FlexVolume> sync\n```\n#### Detach a volume:\n\nThis call detaches a volume to a remote host or local host. It can be executed from Controller-manager/Kubelet depending on whether Controller-attach-detach is enabled or not.. This call only valid for drivers which support attach & detach.\n\nThe following additional options are passed to the plugin as part of options map in FlexVolumeSource.\n\n```\n\u201ckubernetes.io/host\u201d=\u201d<host-name>\u201d\n```\n###### Request:\n\n```\nFlexVolumeAttachment\n```\n###### Response:\n\nOn success:\n\n```\n0 exit code\n```\n\nOn failure:\n\n```\nnon-zero exit code & errors.StatusError\n```\n###### Call out:\n\n```\n<driver executable> detach <json encoded FlexVolumeAttachment>\n```\n###### Call out sync: (Wait for detach)\n\n```\n<driver executable> detach <json encoded FlexVolumeAttachment> sync\n```\n#### Mount a volume:\n\nThis call mounts a volume on the node. It is executed from Kubelet. This is only valid for plugins which do not support attach/detach to a node. Example: NFS/CIFS. For volumes which support attach/detach, this will use the default logic to bind mount.\n\nThe following additional options are passed to the plugin as part of options map in FlexVolumeSource.\n\n```\n\u201ckubernetes.io/mountpath\u201d=\u201d<mount path>\u201d\n```\n###### New API Types:\n\n```\ntype FlexVolumeMount struct {\n    unversioned.TypeMeta\n    v1.ObjectMeta\n    MountPath string\n}\n```\n###### Request:\n\n```\nFlexVolume\n```\n###### Response:\n\nOn success:\n\n```\nFlexVolumeMount\n```\n\nOn failure:\n\n```\nnon-zero exit code & errors.StatusError\n```\n###### Call out:\n\n```\n<driver executable> mount <json encoded FlexVolume>\n```\n#### Unmount a volume:\n\nThis call unmounts a volume on the node. It is executed from Kubelet. This is only valid for plugins which do not support attach/detach to a node. Example: NFS/CIFS.\n###### Request:\n\n```\nFlexVolumeMount\n```\n###### Response:\n\nOn success:\n\n```\n0 exit code\n```\n\nOn failure:\n\n```\nnon-zero exit code & errors.StatusError\n```\n###### Call out:\n\n```\n<driver executable> unmount <json encoded FlexVolumeMount>\n```\n#### Metrics call\n\nThis call gets the metrics of a volume. It is executed from Kubelet.\n###### New API Types:\n\n```\ntype FlexVolumeMetrics struct {\n    unversioned.TypeMeta\n    v1.ObjectMeta\n    Capacity *resource.Quantity\n    Used *resource.Quantity\n    Available *resource.Quantity\n}\n```\n###### Request:\n\n```\nstring\n```\n###### Response:\n\nOn success:\n\n```\nFlexVolumeMetrics\n```\n\nOn failure:\n\n```\nnon-zero exit code & errors.StatusError\n```\n###### Call out:\n\n```\n<driver executable> metrics <json encoded FlexVolumeMount>\n```\n## Dynamic Provisioning support:\n\nThe new driver probe function has support to query the capabilities and if the driver has of \u2018dynamic provisioning\u2019 capability, Flex volume plugin will support dynamic provisioning by implementing the \u2018Provisioner\u2019 and \u2018Deleter\u2019 interfaces.\n## Attach detach support:\n\nThe new driver probe function has support to query the capabilities and if the driver has of \u2018attachment\u2019 capability, Flex volume plugin will support dynamic provisioning by implementing the \u2018Provisioner\u2019 and \u2018Deleter\u2019 interfaces.\nPR by @MikaelCluseau (#26926) would be leveraged for this change.\n",
  "closed_at": "2017-04-24T22:58:46Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/9920367?v=4",
    "events_url": "https://api.github.com/users/chakri-nelluri/events{/privacy}",
    "followers_url": "https://api.github.com/users/chakri-nelluri/followers",
    "following_url": "https://api.github.com/users/chakri-nelluri/following{/other_user}",
    "gists_url": "https://api.github.com/users/chakri-nelluri/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/chakri-nelluri",
    "id": 9920367,
    "login": "chakri-nelluri",
    "node_id": "MDQ6VXNlcjk5MjAzNjc=",
    "organizations_url": "https://api.github.com/users/chakri-nelluri/orgs",
    "received_events_url": "https://api.github.com/users/chakri-nelluri/received_events",
    "repos_url": "https://api.github.com/users/chakri-nelluri/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/chakri-nelluri/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chakri-nelluri/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/chakri-nelluri"
  },
  "comments": 42,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/32543/comments",
  "created_at": "2016-09-13T01:34:24Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/32543/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/32543",
  "id": 176526402,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 116719829,
      "name": "area/kubelet",
      "node_id": "MDU6TGFiZWwxMTY3MTk4Mjk=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/kubelet"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/32543/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxNzY1MjY0MDI=",
  "number": 32543,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "New Flex volume API proposal",
  "updated_at": "2017-04-24T22:58:46Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/32543",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/9920367?v=4",
    "events_url": "https://api.github.com/users/chakri-nelluri/events{/privacy}",
    "followers_url": "https://api.github.com/users/chakri-nelluri/followers",
    "following_url": "https://api.github.com/users/chakri-nelluri/following{/other_user}",
    "gists_url": "https://api.github.com/users/chakri-nelluri/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/chakri-nelluri",
    "id": 9920367,
    "login": "chakri-nelluri",
    "node_id": "MDQ6VXNlcjk5MjAzNjc=",
    "organizations_url": "https://api.github.com/users/chakri-nelluri/orgs",
    "received_events_url": "https://api.github.com/users/chakri-nelluri/received_events",
    "repos_url": "https://api.github.com/users/chakri-nelluri/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/chakri-nelluri/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chakri-nelluri/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/chakri-nelluri"
  }
}