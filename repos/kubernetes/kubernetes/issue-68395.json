{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "<!-- This form is for bug reports and feature requests ONLY!\r\n\r\nIf you're looking for help check [Stack Overflow](https://stackoverflow.com/questions/tagged/kubernetes) and the [troubleshooting guide](https://kubernetes.io/docs/tasks/debug-application-cluster/troubleshooting/).\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/.\r\n-->\r\n\r\n**Is this a BUG REPORT or FEATURE REQUEST?**:\r\n\r\n> Uncomment only one, leave it on its own line:\r\n>\r\n/kind bug\r\n> /kind feature\r\n\r\n\r\n**What happened**:\r\nI made an extension apiserver based on the sample.  My extension apiserver adds an admission plugin, as does the sample.  But if that admission plugin is enabled from the command line then validation fails.\r\n\r\nThere are two problems.  For the first, note that https://github.com/kubernetes/kubernetes/blob/5c8ef7eb3b737f869d1b04a5b3837d4400b561a7/staging/src/k8s.io/sample-apiserver/pkg/cmd/server/start.go#L70 invokes validation before https://github.com/kubernetes/kubernetes/blob/5c8ef7eb3b737f869d1b04a5b3837d4400b561a7/staging/src/k8s.io/sample-apiserver/pkg/cmd/server/start.go#L73 --- which is where the additional admission plugin gets added (see how https://github.com/kubernetes/kubernetes/blob/5c8ef7eb3b737f869d1b04a5b3837d4400b561a7/staging/src/k8s.io/sample-apiserver/pkg/cmd/server/start.go#L128 leads to https://github.com/kubernetes/kubernetes/blob/5c8ef7eb3b737f869d1b04a5b3837d4400b561a7/staging/src/k8s.io/sample-apiserver/pkg/cmd/server/start.go#L98 which is what gets to https://github.com/kubernetes/kubernetes/blob/5c8ef7eb3b737f869d1b04a5b3837d4400b561a7/staging/src/k8s.io/sample-apiserver/pkg/admission/plugin/banflunder/admission.go#L35).\r\n\r\nI fixed that inversion by promoting some code from `Config()` to `Complete()` in my extension server.  That exposed the other problem, which comes from https://github.com/kubernetes/kubernetes/blob/5c8ef7eb3b737f869d1b04a5b3837d4400b561a7/staging/src/k8s.io/apiserver/pkg/server/options/admission.go#L196 .  The sample apiserver does not add its admission plugin to `RecommendedPluginOrder`, so this check trips.\r\n\r\n**What you expected to happen**:\r\nI expected to be able to use my admission plugin.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n- Cloud provider or hardware configuration:\r\n- OS (e.g. from /etc/os-release):\r\n- Kernel (e.g. `uname -a`):\r\n- Install tools:\r\n- Others:\r\n",
  "closed_at": "2018-10-03T20:01:45Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 10,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/68395/comments",
  "created_at": "2018-09-07T05:27:15Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/68395/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/68395",
  "id": 357924460,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/68395/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzNTc5MjQ0NjA=",
  "number": 68395,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Sample apiserver does not allow actual use of its admission plugin",
  "updated_at": "2018-10-03T20:01:45Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/68395",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/14296719?v=4",
    "events_url": "https://api.github.com/users/MikeSpreitzer/events{/privacy}",
    "followers_url": "https://api.github.com/users/MikeSpreitzer/followers",
    "following_url": "https://api.github.com/users/MikeSpreitzer/following{/other_user}",
    "gists_url": "https://api.github.com/users/MikeSpreitzer/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/MikeSpreitzer",
    "id": 14296719,
    "login": "MikeSpreitzer",
    "node_id": "MDQ6VXNlcjE0Mjk2NzE5",
    "organizations_url": "https://api.github.com/users/MikeSpreitzer/orgs",
    "received_events_url": "https://api.github.com/users/MikeSpreitzer/received_events",
    "repos_url": "https://api.github.com/users/MikeSpreitzer/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/MikeSpreitzer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MikeSpreitzer/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/MikeSpreitzer"
  }
}