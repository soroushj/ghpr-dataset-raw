{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Thanks for filing an issue! Before hitting the button, please answer these questions.-->\r\n\r\n**Kubernetes version** (use `kubectl version`):\r\nUpgrading from 1.2.0 (working) to 1.3.9 (broken)\r\n\r\n**Environment**:\r\n- **Cloud provider or hardware configuration**: Bare metal Dell R420's\r\n- **OS** (e.g. from /etc/os-release): CentOS 6 with a 3.10 kernel.\r\n- **Kernel** (e.g. `uname -a`):  3.10.0-327.18.2.el7.x86_64\r\n- **Install tools**: \r\n- **Others**:\r\niptables --version\r\niptables v1.4.7\r\n\r\n**What happened**:\r\nWe upgraded from 1.2.0 to 1.3.9 and noticed that our service load balancer (based on haproxy) cpu utilization started going through the roof over the course of 3 days, mostly system time.  It is now impacting all nodes with the 1.3.9 version of kubelet installed.\r\n\r\nWe've tracked down a likely culprit which is this version of kube seems to be continuously appending iptables rules at a rate of about 4 a second.  Here's a dump from iptables-save:\r\n$ sudo iptables-save | wc -l\r\n67951\r\n\r\nThese tend to be the form of the duplicated rules:\r\n```\r\n-A KUBE-FIREWALL -m comment --comment \"kubernetes firewall for dropping marked packets\" -m mark --mark 0x8000/0x8000 -j DROP\r\n<repeated>\r\n-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000\r\n<repeated>\r\n-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000\r\n<repeated>\r\n-A KUBE-POSTROUTING -m comment --comment \"kubernetes service traffic requiring SNAT\" -m mark --mark 0x4000/0x4000 -j MASQUERADE\r\n<repeated>\r\n```\r\n\r\nThe commits and issues I've found related to this are:\r\nhttps://github.com/kubernetes/kubernetes/issues/2623\r\nhttps://github.com/kubernetes/kubernetes/pull/30486\r\n\r\n**What you expected to happen**:\r\nIt to stay at < 30% cpu utilization and a reasonable number of iptables rules.\r\n\r\n**How to reproduce it** (as minimally and precisely as possible):\r\nSetup centos6 with our kernel, run 1.3.9 \r\n\r\n**Anything else do we need to know**:\r\n\r\nHere is the iptables output soon after starting the system.  You can see it is already starting to accumulate rules:\r\n```\r\n$ sudo iptables-save\r\n# Generated by iptables-save v1.4.7 on Wed Nov 23 16:35:34 2016\r\n*filter\r\n:INPUT ACCEPT [2753:1417441]\r\n:FORWARD ACCEPT [107:7101]\r\n:OUTPUT ACCEPT [1993:8997998]\r\n:DOCKER - [0:0]\r\n:DOCKER-ISOLATION - [0:0]\r\n:KUBE-FIREWALL - [0:0]\r\n-A INPUT -j KUBE-FIREWALL\r\n-A FORWARD -j DOCKER-ISOLATION\r\n-A FORWARD -o docker0 -j DOCKER\r\n-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\r\n-A FORWARD -i docker0 ! -o docker0 -j ACCEPT\r\n-A FORWARD -i docker0 -o docker0 -j ACCEPT\r\n-A OUTPUT -j KUBE-FIREWALL\r\n-A DOCKER-ISOLATION -j RETURN\r\n-A KUBE-FIREWALL -m comment --comment \"kubernetes firewall for dropping marked packets\" -m mark --mark 0x8000/0x8000 -j DROP\r\n-A KUBE-FIREWALL -m comment --comment \"kubernetes firewall for dropping marked packets\" -m mark --mark 0x8000/0x8000 -j DROP\r\nCOMMIT\r\n# Completed on Wed Nov 23 16:35:34 2016\r\n# Generated by iptables-save v1.4.7 on Wed Nov 23 16:35:34 2016\r\n*nat\r\n:PREROUTING ACCEPT [462:40180]\r\n:INPUT ACCEPT [136:16306]\r\n:OUTPUT ACCEPT [1007:65897]\r\n:POSTROUTING ACCEPT [1109:72017]\r\n:DOCKER - [0:0]\r\n:KUBE-MARK-DROP - [0:0]\r\n:KUBE-MARK-MASQ - [0:0]\r\n:KUBE-POSTROUTING - [0:0]\r\n-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER\r\n-A PREROUTING ! -s 127.0.0.1/32 -p tcp -m tcp --dport 10250 -m addrtype --dst-type LOCAL -j REDIRECT --to-ports 11250\r\n-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER\r\n-A POSTROUTING -m comment --comment \"kubernetes postrouting rules\" -j KUBE-POSTROUTING\r\n-A POSTROUTING -s 10.20.19.128/25 ! -o docker0 -j MASQUERADE\r\n-A DOCKER -i docker0 -j RETURN\r\n-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000\r\n-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000\r\n-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000\r\n-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000\r\n-A KUBE-POSTROUTING -m comment --comment \"kubernetes service traffic requiring SNAT\" -m mark --mark 0x4000/0x4000 -j MASQUERADE\r\n-A KUBE-POSTROUTING -m comment --comment \"kubernetes service traffic requiring SNAT\" -m mark --mark 0x4000/0x4000 -j MASQUERADE\r\nCOMMIT\r\n# Completed on Wed Nov 23 16:35:34 2016\r\n```\r\n\r\n@thockin @freehan ",
  "closed_at": "2016-12-07T01:41:31Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 9,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37416/comments",
  "created_at": "2016-11-24T00:49:51Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37416/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/37416",
  "id": 191410560,
  "labels": [],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37416/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxOTE0MTA1NjA=",
  "number": 37416,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kubelet 1.3.9 inserting duplicate iptables rules on centos6 (iptables v1.4.7)",
  "updated_at": "2016-12-07T01:41:31Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37416",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/3486668?v=4",
    "events_url": "https://api.github.com/users/huggsboson/events{/privacy}",
    "followers_url": "https://api.github.com/users/huggsboson/followers",
    "following_url": "https://api.github.com/users/huggsboson/following{/other_user}",
    "gists_url": "https://api.github.com/users/huggsboson/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/huggsboson",
    "id": 3486668,
    "login": "huggsboson",
    "node_id": "MDQ6VXNlcjM0ODY2Njg=",
    "organizations_url": "https://api.github.com/users/huggsboson/orgs",
    "received_events_url": "https://api.github.com/users/huggsboson/received_events",
    "repos_url": "https://api.github.com/users/huggsboson/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/huggsboson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/huggsboson/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/huggsboson"
  }
}