{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\n\r\nWhen the HPA scales up beyond the capacity of the cluster, many unscheduled pods are created.  When load is removed, the usage ratio drops and the HPA tries to scale down.  The unscheduled pods do not produce metrics, so the HPA fills in the 100% usage and re-evaluates the usage ratio.  Because of the many fake 100% metrics, the new usage ratio is above the target value and the direction of scale is reversed.  In this case, the HPA decides not to make any change to the current scale.\r\n\r\nhttps://github.com/kubernetes/kubernetes/blob/9162d932cff0f57580640ba049574f72bfd96d4b/pkg/controller/podautoscaler/replica_calculator.go#L104-L110\r\n\r\nhttps://github.com/kubernetes/kubernetes/blob/9162d932cff0f57580640ba049574f72bfd96d4b/pkg/controller/podautoscaler/replica_calculator.go#L131-L135\r\n\r\n**What you expected to happen**:\r\n\r\nI would expect the HPA to not get stuck when load is removed.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n1. Deploy https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/ and put it under load in a cluster without cluster autoscaling.\r\n2. Edit the Deployment to increase the CPU request beyond the capability of the cluster (e.g. 500m).  This should produce many Pending pods.\r\n3. Remove load.  The Pending pods will keep the HPA scaled indefinitely.\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n\r\nClient Version: version.Info{Major:\"1\", Minor:\"14\", GitVersion:\"v1.14.3\", GitCommit:\"5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0\", GitTreeState:\"clean\", BuildDate:\"2019-06-06T01:44:30Z\", GoVersion:\"go1.12.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}                                                                                                                                                                                     \r\nServer Version: version.Info{Major:\"1\", Minor:\"12+\", GitVersion:\"v1.12.9-gke.3\", GitCommit:\"01866bfa8b9692c6504622311d5b5015f16bfd18\", GitTreeState:\"clean\", BuildDate:\"2019-06-06T21:30:53Z\", GoVersion:\"go1.10.8b4\", Compiler:\"gc\", Platform:\"linux/amd64\"}                                                                                                                                                                            \r\n\r\n- Cloud provider or hardware configuration:\r\n- OS (e.g: `cat /etc/os-release`):\r\n- Kernel (e.g. `uname -a`):\r\n- Install tools:\r\n- Network plugin and version (if this is a network-related bug):\r\n- Others:\r\n",
  "closed_at": "2019-07-10T18:34:30Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/79158/comments",
  "created_at": "2019-06-19T08:13:47Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/79158/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/79158",
  "id": 457868972,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Autoscaling.",
      "id": 238245616,
      "name": "sig/autoscaling",
      "node_id": "MDU6TGFiZWwyMzgyNDU2MTY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/autoscaling"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/79158/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NTc4Njg5NzI=",
  "number": 79158,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Unscheduled Pods cause HPA to get stuck",
  "updated_at": "2019-07-10T18:34:30Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/79158",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1103629?v=4",
    "events_url": "https://api.github.com/users/josephburnett/events{/privacy}",
    "followers_url": "https://api.github.com/users/josephburnett/followers",
    "following_url": "https://api.github.com/users/josephburnett/following{/other_user}",
    "gists_url": "https://api.github.com/users/josephburnett/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/josephburnett",
    "id": 1103629,
    "login": "josephburnett",
    "node_id": "MDQ6VXNlcjExMDM2Mjk=",
    "organizations_url": "https://api.github.com/users/josephburnett/orgs",
    "received_events_url": "https://api.github.com/users/josephburnett/received_events",
    "repos_url": "https://api.github.com/users/josephburnett/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/josephburnett/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/josephburnett/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/josephburnett"
  }
}