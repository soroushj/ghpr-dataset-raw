{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Is this a BUG REPORT or FEATURE REQUEST?**:\r\n /kind bug\r\n\r\n**What happened**:\r\nFix #59286 doesn't remove the stale udp conntrack session when an external ip is involved. The stale session lingers and continues to misdirect traffic to endpoints that are removed and it prevents sessions to new endpoints from being created.\r\n\r\n**What you expected to happen**:\r\nFix #59286 removes stale udp conntrack sessions by cluster ip as its solution but if using external ip (ex. vip) the stale udp conntrack session can't be matched by cluster ip so it doesn't get removed. In this scenario, the stale session's fields contain the external ip, endpoint ip and port but not cluster ip.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nWith all inbound traffic routed through a vip, the following sflow-app has its traffic forwarded from an external ip 10.0.22.190 to its endpoint 10.32.0.83:6343:\r\n\r\nNAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                       AGE\r\nsflow-app                ClusterIP   10.105.23.70     10.0.22.190   6343/UDP                      6d\r\n\r\nNAME                      ENDPOINTS                                          AGE\r\nsflow-app                10.32.0.83:6343                                    6d\r\n\r\nThe conntrack session for the above service looks like this (notice the cluster ip of 10.105.23.70 is not part of the session):\r\nudp      17 29 src=10.0.22.3 dst=10.0.22.190 sport=50401 dport=6343 [UNREPLIED] src=10.32.0.83 dst=10.32.0.1 sport=6343 dport=50401 mark=0 use=1\r\n\r\nWhen the pod/endpoint is removed or it gets a new ip address, the conntrack session doesn't get removed by external ip or endpoints so it just lingers.\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\nClient Version: version.Info{Major:\"1\", Minor:\"10\", GitVersion:\"v1.10.3\", GitCommit:\"2bba0127d85d5a46ab4b778548be28623b32d0b0\", GitTreeState:\"clean\", BuildDate:\"2018-05-21T09:17:39Z\", GoVersion:\"go1.9.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n\r\n- OS (e.g. from /etc/os-release):\r\nNAME=\"Ubuntu\"\r\nVERSION=\"18.04 LTS (Bionic Beaver)\"\r\n\r\n- Kernel (e.g. `uname -a`):\r\nLinux firescope1 4.15.0-22-generic #24-Ubuntu SMP Wed May 16 12:15:17 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n/sig network",
  "closed_at": "2019-02-20T02:38:18Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 7,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/65228/comments",
  "created_at": "2018-06-19T16:38:39Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/65228/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/65228",
  "id": 333751126,
  "labels": [
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Network.",
      "id": 116712108,
      "name": "sig/network",
      "node_id": "MDU6TGFiZWwxMTY3MTIxMDg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/network"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/65228/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMzM3NTExMjY=",
  "number": 65228,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Delete stale UDP conntrack entries with external ip usage",
  "updated_at": "2019-02-20T02:38:18Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/65228",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/25066886?v=4",
    "events_url": "https://api.github.com/users/hiep-huynh/events{/privacy}",
    "followers_url": "https://api.github.com/users/hiep-huynh/followers",
    "following_url": "https://api.github.com/users/hiep-huynh/following{/other_user}",
    "gists_url": "https://api.github.com/users/hiep-huynh/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/hiep-huynh",
    "id": 25066886,
    "login": "hiep-huynh",
    "node_id": "MDQ6VXNlcjI1MDY2ODg2",
    "organizations_url": "https://api.github.com/users/hiep-huynh/orgs",
    "received_events_url": "https://api.github.com/users/hiep-huynh/received_events",
    "repos_url": "https://api.github.com/users/hiep-huynh/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/hiep-huynh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hiep-huynh/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/hiep-huynh"
  }
}