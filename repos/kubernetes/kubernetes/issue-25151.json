{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "When attempting to fetch a resource version that is too old, the behavior of watch (for both HTTP and web sockets) changed when watch cache was enabled.  The watch cache returns a 410 - without the watch cache, we return 200 and then write an \"error\" entry to the watch stream.  This broke a client that dependent on the watch behavior, and moreover is inconsistent with other errors we set in the registry.  Also, for watch over web sockets, most javascript clients will be unable to get at a 410 error from the connection, because browsers don't get access to the data.\n\nWe should restore the watch cache behavior to be consistent with the previous behavior as this is a regression in API semantics.\n\nResource without watch cache, watching too old:\n\n```\n$ curl ... \"https:///oapi/v1/namespaces/clayton-dev/builds?watch=1&resourceVersion=1\"\n> GET /oapi/v1/namespaces/clayton-dev/builds?watch=1&resourceVersion=1 HTTP/1.1\n> Accept: application/json, */*\n> User-Agent: oc/v1.3.0 (darwin/amd64) kubernetes/2787678\n> \n< HTTP/1.1 200 OK\n< Cache-Control: no-store\n< Transfer-Encoding: chunked\n< Date: Wed, 04 May 2016 18:10:26 GMT\n< Content-Type: text/plain; charset=utf-8\n< Transfer-Encoding: chunked\n< \n{\"type\":\"ERROR\",\"object\":{\"kind\":\"Status\",\"apiVersion\":\"v1\",\"metadata\":{},\"status\":\"Failure\",\"message\":\"401: The event in requested index is outdated and cleared (the requested history has been cleared [4046756/2]) [4047755]\",\"reason\":\"Expired\",\"code\":410}}\n```\n\nResource with watch cache, watching too old:\n\n```\n$ curl ... \"https:///apis/extensions/v1beta1/namespaces/clayton-dev/horizontalpodautoscalers?watch=1&resourceVersion=1\"\n> GET /apis/extensions/v1beta1/namespaces/clayton-dev/horizontalpodautoscalers?watch=1&resourceVersion=1 HTTP/1.1\n> Accept: application/json, */*\n> User-Agent: oc/v1.3.0 (darwin/amd64) kubernetes/2787678\n> \n< HTTP/1.1 410 Gone\n< Cache-Control: no-store\n< Content-Type: application/json\n< Date: Wed, 04 May 2016 18:08:25 GMT\n< Content-Length: 146\n< \n{\"kind\":\"Status\",\"apiVersion\":\"v1\",\"metadata\":{},\"status\":\"Failure\",\"message\":\"too old resource version: 1 (4034675)\",\"reason\":\"Gone\",\"code\":410}\n```\n",
  "closed_at": "2016-05-11T01:15:15Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 13,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/25151/comments",
  "created_at": "2016-05-04T18:18:49Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/25151/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/25151",
  "id": 153080519,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Indicates an issue on api area.",
      "id": 125063986,
      "name": "area/api",
      "node_id": "MDU6TGFiZWwxMjUwNjM5ODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/api"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/25151/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxNTMwODA1MTk=",
  "number": 25151,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Watch cache regression: changes behavior of \"resource version too old\" error",
  "updated_at": "2020-03-11T16:23:21Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/25151",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1163175?v=4",
    "events_url": "https://api.github.com/users/smarterclayton/events{/privacy}",
    "followers_url": "https://api.github.com/users/smarterclayton/followers",
    "following_url": "https://api.github.com/users/smarterclayton/following{/other_user}",
    "gists_url": "https://api.github.com/users/smarterclayton/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/smarterclayton",
    "id": 1163175,
    "login": "smarterclayton",
    "node_id": "MDQ6VXNlcjExNjMxNzU=",
    "organizations_url": "https://api.github.com/users/smarterclayton/orgs",
    "received_events_url": "https://api.github.com/users/smarterclayton/received_events",
    "repos_url": "https://api.github.com/users/smarterclayton/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/smarterclayton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/smarterclayton/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/smarterclayton"
  }
}