{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1745006?v=4",
    "events_url": "https://api.github.com/users/jsafrane/events{/privacy}",
    "followers_url": "https://api.github.com/users/jsafrane/followers",
    "following_url": "https://api.github.com/users/jsafrane/following{/other_user}",
    "gists_url": "https://api.github.com/users/jsafrane/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jsafrane",
    "id": 1745006,
    "login": "jsafrane",
    "node_id": "MDQ6VXNlcjE3NDUwMDY=",
    "organizations_url": "https://api.github.com/users/jsafrane/orgs",
    "received_events_url": "https://api.github.com/users/jsafrane/received_events",
    "repos_url": "https://api.github.com/users/jsafrane/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jsafrane/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jsafrane/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jsafrane"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/1745006?v=4",
      "events_url": "https://api.github.com/users/jsafrane/events{/privacy}",
      "followers_url": "https://api.github.com/users/jsafrane/followers",
      "following_url": "https://api.github.com/users/jsafrane/following{/other_user}",
      "gists_url": "https://api.github.com/users/jsafrane/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jsafrane",
      "id": 1745006,
      "login": "jsafrane",
      "node_id": "MDQ6VXNlcjE3NDUwMDY=",
      "organizations_url": "https://api.github.com/users/jsafrane/orgs",
      "received_events_url": "https://api.github.com/users/jsafrane/received_events",
      "repos_url": "https://api.github.com/users/jsafrane/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jsafrane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jsafrane/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jsafrane"
    }
  ],
  "author_association": "MEMBER",
  "body": "Reconstructed block volume leaves global symlink and does not un-map the device.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n1. I have iSCSI block PV used in a pod. This is found in /var/lib/kubelet:\r\n    ```\r\n    /var/lib/kubelet/plugins/kubernetes.io/iscsi/volumeDevices/iface-default/127.0.0.1:3260-iqn.2003-01.io.k8s:jsafrane-lun-0\r\n    /var/lib/kubelet/plugins/kubernetes.io/iscsi/volumeDevices/iface-default/127.0.0.1:3260-iqn.2003-01.io.k8s:jsafrane-lun-0/iscsi.json\r\n    /var/lib/kubelet/plugins/kubernetes.io/iscsi/volumeDevices/iface-default/127.0.0.1:3260-iqn.2003-01.io.k8s:jsafrane-lun-0/2e8310c1-a75d-44f1-9639-694ec1c4ab8d\r\n\r\n    /var/lib/kubelet/pods/2e8310c1-a75d-44f1-9639-694ec1c4ab8d/volumeDevices/kubernetes.io~iscsi\r\n    /var/lib/kubelet/pods/2e8310c1-a75d-44f1-9639-694ec1c4ab8d/volumeDevices/kubernetes.io~iscsi/iscsi-block-pv\r\n    ```\r\n\r\n2. Stop kubelet, force-delete the pod, start new kubelet\r\n\r\n3. After the reconstruction, this is found in /var/lib/kubelet:\r\n    ```\r\n    /var/lib/kubelet/plugins/kubernetes.io/iscsi/volumeDevices/iface-default/127.0.0.1:3260-iqn.2003-01.io.k8s:jsafrane-lun-0\r\n    /var/lib/kubelet/plugins/kubernetes.io/iscsi/volumeDevices/iface-default/127.0.0.1:3260-iqn.2003-01.io.k8s:jsafrane-lun-0/iscsi.json\r\n    /var/lib/kubelet/plugins/kubernetes.io/iscsi/volumeDevices/iface-default/127.0.0.1:3260-iqn.2003-01.io.k8s:jsafrane-lun-0/2e8310c1-a75d-44f1-9639-694ec1c4ab8d\r\n    ```\r\n    And my iSCSI device is still available on the node (i.e. `TearDownDevice` was not called).\r\n\r\n**What you expected to happen**:\r\nGlobal symlinks deleted + iSCSI volume detached from the node.\r\n\r\n**Anything else we need to know?**:\r\n\r\nDigging in kubelet logs, this is reconstruction of the block volume:\r\n\r\n```\r\nI1003 11:58:15.800962   15460 operation_executor.go:901] Starting operationExecutor.ReconstructVolume\r\nI1003 11:58:15.802013   15460 volume_path_handler.go:203] FindGlobalMapPathFromPod: path /var/lib/kubelet/plugins/kubernetes.io/iscsi/volumeDevices/iface-default/127.0.0.1:3260-iqn.2003-01.io.k8s:jsafrane-lun-0/2e8310c1-a75d-44f1-9639-694ec1c4ab8d, mapPath /var/lib/kubelet/pods/2e8310c1-a75d-44f1-9639-694ec1c4ab8d/volumeDevices/kubernetes.io~iscsi/iscsi-block-pv\r\nI1003 11:58:15.802168   15460 volume_path_handler.go:227] CompareSymlinks: devGloBal /dev/sdd, devPod /dev/sdd\r\nI1003 11:58:15.802293   15460 volume_path_handler.go:213] FindGlobalMapPathFromPod: globalMapPathUUID /var/lib/kubelet/plugins/kubernetes.io/iscsi/volumeDevices/iface-default/127.0.0.1:3260-iqn.2003-01.io.k8s:jsafrane-lun-0/2e8310c1-a75d-44f1-9639-694ec1c4ab8d\r\nI1003 11:58:15.802392   15460 iscsi.go:268] globalMapPathUUID: /var/lib/kubelet/plugins/kubernetes.io/iscsi/volumeDevices/iface-default/127.0.0.1:3260-iqn.2003-01.io.k8s:jsafrane-lun-0/2e8310c1-a75d-44f1-9639-694ec1c4ab8d, err: <nil>\r\nI1003 11:58:15.802538   15460 iscsi.go:663] ConstructBlockVolumeSpec: TargetPortal: 127.0.0.1:3260, IQN: iqn.2003-01.io.k8s:jsafrane, Lun: 0, ISCSIInterface: default\r\nI1003 11:58:15.802620   15460 volume_host.go:308] using default mounter/exec for kubernetes.io/iscsi\r\nI1003 11:58:15.802658   15460 volume_host.go:308] using default mounter/exec for kubernetes.io/iscsi\r\nW1003 11:58:15.802836   15460 reconciler.go:393] Could not construct volume information, cleanup the mounts. (pod.UID 2e8310c1-a75d-44f1-9639-694ec1c4ab8d, volume.SpecName iscsi-block-pv): volume: \"kubernetes.io/iscsi/127.0.0.1:3260:iqn.2003-01.io.k8s:jsafrane:0\" is not mounted\r\nI1003 11:58:15.803015   15460 reconciler.go:428] Reconciler sync states: could not find information (PID: 2e8310c1-a75d-44f1-9639-694ec1c4ab8d) (Volume SpecName: iscsi-block-pv) in desired state, clean up the mount points\r\nI1003 11:58:15.804038   15460 volume_host.go:308] using default mounter/exec for kubernetes.io/iscsi\r\nI1003 11:58:15.804068   15460 volume_host.go:308] using default mounter/exec for kubernetes.io/iscsi\r\nI1003 11:58:15.804648   15460 subpath_linux.go:215] Cleaning up subpath mounts for /var/lib/kubelet/pods/2e8310c1-a75d-44f1-9639-694ec1c4ab8d/volume-subpaths/iscsi-block-pv\r\nW1003 11:58:15.804911   15460 mount_helper_common.go:33] Warning: Unmount skipped because path does not exist: /var/lib/kubelet/pods/2e8310c1-a75d-44f1-9639-694ec1c4ab8d/volumes/kubernetes.io~iscsi/iscsi-block-pv\r\nI1003 11:58:15.804989   15460 operation_generator.go:853] UnmountVolume.TearDown succeeded for volume \"iscsi-block-pv\" (OuterVolumeSpecName: \"\") pod \"2e8310c1-a75d-44f1-9639-694ec1c4ab8d\" (UID: \"2e8310c1-a75d-44f1-9639-694ec1c4ab8d\"). InnerVolumeSpecName \"iscsi-block-pv\". PluginName \"kubernetes.io/iscsi\", VolumeGidValue \"\"\r\nE1003 11:58:15.805161   15460 operation_generator.go:868] UnmountVolume.MarkVolumeAsUnmounted failed for volume \"\" (UniqueName: \"iscsi-block-pv\") pod \"2e8310c1-a75d-44f1-9639-694ec1c4ab8d\" (UID: \"2e8310c1-a75d-44f1-9639-694ec1c4ab8d\") : no volume with the name \"iscsi-block-pv\" exists in the list of attached volumes\r\n```\r\n\r\nInteresting part is `volume: \"kubernetes.io/iscsi/127.0.0.1:3260:iqn.2003-01.io.k8s:jsafrane:0\" is not mounted`, everything goes bad from there.\r\n\r\nReason for the error is that kubelet checks if `/var/lib/kubelet/pods/2e8310c1-a75d-44f1-9639-694ec1c4ab8d/volumeDevices/kubernetes.io~iscsi/` is symlink, while it should check `/var/lib/kubelet/pods/2e8310c1-a75d-44f1-9639-694ec1c4ab8d/volumeDevices/kubernetes.io~iscsi/iscsi-block-pv` instead.\r\n \r\nKubelet then just calls generic `cleanupMounts`, without putting the volume to ASW.\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): today's master, 820b796c66744a8fcab1eebbf29ae223a65614d6\r\n",
  "closed_at": "2019-10-08T10:45:19Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83445/comments",
  "created_at": "2019-10-03T12:16:44Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83445/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/83445",
  "id": 502029719,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Storage.",
      "id": 169428334,
      "name": "sig/storage",
      "node_id": "MDU6TGFiZWwxNjk0MjgzMzQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/storage"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83445/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MDIwMjk3MTk=",
  "number": 83445,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Block volume reconstruction does not delete global symlink",
  "updated_at": "2019-10-08T10:45:19Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83445",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1745006?v=4",
    "events_url": "https://api.github.com/users/jsafrane/events{/privacy}",
    "followers_url": "https://api.github.com/users/jsafrane/followers",
    "following_url": "https://api.github.com/users/jsafrane/following{/other_user}",
    "gists_url": "https://api.github.com/users/jsafrane/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jsafrane",
    "id": 1745006,
    "login": "jsafrane",
    "node_id": "MDQ6VXNlcjE3NDUwMDY=",
    "organizations_url": "https://api.github.com/users/jsafrane/orgs",
    "received_events_url": "https://api.github.com/users/jsafrane/received_events",
    "repos_url": "https://api.github.com/users/jsafrane/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jsafrane/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jsafrane/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jsafrane"
  }
}