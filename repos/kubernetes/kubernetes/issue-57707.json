{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "\r\n**Is this a BUG REPORT or FEATURE REQUEST?**:\r\n/kind bug\r\n\r\n**What happened**:\r\nWhen kube-apiserver's livenessProbe suggests that pod is unhealthy, kubelet tries to kill its container with 30 seconds grace period.\r\nThe container is killed ungracefully with SIGKILL when grace period passes. This happens each time.\r\n\r\n```\r\nDec 29 13:07:05 kubelet[1579]: kuberuntime_container.go:561] Killing container \"docker://763de1ad420fc26c5fd4997bac7cc44f5c540a123778fc18b636eb24fbc83d5a\" with 30 second grace period\r\nDec 29 13:07:36 audit: EXECVE argc=5 a0=\"docker-runc\" a1=\"kill\" a2=\"--all\" a3=\"763de1ad420fc26c5fd4997bac7cc44f5c540a123778fc18b636eb24fbc83d5a\" a4=\"SIGKILL\"\r\nDec 29 13:07:36 kubelet[1579]: kubelet.go:1917] SyncLoop (PLEG): \"kube-apiserver-gke-05f87b26119bc247ce64-b9bf-08d2-vm_kube-system(1073a53f8bbfcf5f46fe7e4b66f4663f)\", event: &pleg.PodLifecycleEvent{ID:\"1073a53f8bbfcf5f46fe7e4b66f4663f\", Type:\"ContainerDied\", Data:\"763de1ad420fc26c5fd4997bac7cc44f5c540a123778fc18b636eb24fbc83d5a\"}\r\n```\r\n\r\n**What you expected to happen**:\r\n\r\nI expected that SIGTERM will be passed to kube-apiserver which will try to gracefully stop before 30 seconds pass (at least in some cases).\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n- Inject kube-apiserver failure (e.g. `iptables -I INPUT -i lo -p tcp --dport 8080 -j REJECT`)\r\n- Watch kubelet logs for container's death\r\n- You will see that container is killed after 30 seconds each time\r\n\r\n**Anything else we need to know?**:\r\nI believe the problem is that in kube-apiserver.manifest uses '/bin/sh -c CMD' as a PID1 process which doesn't pass SIGTERM signals to child process.  See https://pracucci.com/graceful-shutdown-of-kubernetes-pods.html#a-common-pitfall-while-handling-the-sigterm\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): v1.7.11\r\n",
  "closed_at": "2018-01-03T10:25:42Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/57707/comments",
  "created_at": "2017-12-29T13:30:30Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/57707/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/57707",
  "id": 285093617,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Cluster Lifecycle.",
      "id": 173494222,
      "name": "sig/cluster-lifecycle",
      "node_id": "MDU6TGFiZWwxNzM0OTQyMjI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cluster-lifecycle"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Node.",
      "id": 173493665,
      "name": "sig/node",
      "node_id": "MDU6TGFiZWwxNzM0OTM2NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/node"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/57707/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyODUwOTM2MTc=",
  "number": 57707,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kube-apiserver is never killed gracefully",
  "updated_at": "2018-01-03T10:25:42Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/57707",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/2559168?v=4",
    "events_url": "https://api.github.com/users/mborsz/events{/privacy}",
    "followers_url": "https://api.github.com/users/mborsz/followers",
    "following_url": "https://api.github.com/users/mborsz/following{/other_user}",
    "gists_url": "https://api.github.com/users/mborsz/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mborsz",
    "id": 2559168,
    "login": "mborsz",
    "node_id": "MDQ6VXNlcjI1NTkxNjg=",
    "organizations_url": "https://api.github.com/users/mborsz/orgs",
    "received_events_url": "https://api.github.com/users/mborsz/received_events",
    "repos_url": "https://api.github.com/users/mborsz/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mborsz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mborsz/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mborsz"
  }
}