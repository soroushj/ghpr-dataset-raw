{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "Recently we were thinking about running all addons in deployments instead of replication controllers. The main motivation is to support rolling update. A few previous discussion in #32018. As mentioned before, migrating addons from RC to Deployment would affect multiple pieces of work and it is no well explicated yet. So I think it is worth to have a discussion here.\r\n\r\nAssumptions:\r\n- All addons will run in deployments in 1.5 release.\r\n\r\nThings need to be satisfied: (updated)\r\n- Support rolling update for addons in addon-manager.\r\n- Support upgrade from addons run in RCs to addons run in Deployments. (1.4 -> 1.5 upgrade).\r\n- Support downgrade from addons run in Deployments to addons run in RCs. (1.5 -> 1.4 downgrade).\r\n- Maintain the replicas number of addons while upgrading / rebooting / downgrading.\r\n- Do not affect the behavior of auto-scaling and manually-scaling.\r\n- Well announce the change of update behavior for addon manager.\r\n\r\n---\r\n\r\nPlan we have currently:\r\n- Finish the WIP #33075 for `kubectl apply --prune` (more detail about this command in proposal #29551). \r\n- Replace the main logic of addon-manager with a while loop of `kubectl apply --prune`.\r\n- Change addons from RC to Deployment without explicitly describing this transition.\r\n\r\nNew addon-manager logic:\r\n- `kubectl apply` intuitively supports deployment's rolling update.\r\n- `kubectl apply --prune -f` supports creating / updating / purging resource from configuration file.\r\n- Use label `kubernetes.io/cluster-service` to distinguish resources under addon-manager's control.\r\n- Periodically apply the configuration files.\r\n\r\nOld addon-manager logic:\r\n- Periodically poll resources from apiserver and get to know all the resources with label `kubernetes.io/cluster-service`.\r\n- Periodically scan through all configuration files and get to know all the addon resources we should have.\r\n- Comparing resources from apiserver and resources from configuration and figure out resources needed create/delete/update based on the basename, suffix and kind(example: `kube-dns`, `-v19` and `ReplicationController`).\r\n\r\nUpgrade process in plan (1.4 -> 1.5):\r\n- After the master is upgraded to 1.5, all the addon objects created by the 1.4 cluster should still work as expected.\r\n- New version addon-manager is started and picks up the new configuration files of addons with Deployments instead of RCs.\r\n- `kubectl apply --prune -l kubernetes.io/cluster-service -f /etc/kubernetes/addons` would properly purge the old RCs and create new Deployments.\r\n\r\nDowngrade process in plan (1.5 -> 1.4):\r\n- After the master is downgraded to 1.4, all the addon objects created by the 1.5 cluster should still work as expected.\r\n- Old version addon-manager is started. It begins to poll from apiserver and scans though the configuration files of addons with RCs instead of Deployments.\r\n- Because resource kinds changed, old addon-manager will classify this as RC resources added and Deployment resources deleted. It will first delete the Deployments and the underlying pods, and create the RCs and pods again after.\r\n\r\n---\r\n\r\nAbove is the preliminary thoughts for this work. Please comment if there is any mistake or oversight. Thanks!\r\n\r\n@mikedanese @thockin @bprashanth @roberthbailey \r\n",
  "closed_at": "2016-11-10T10:36:38Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 21,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/33698/comments",
  "created_at": "2016-09-28T22:17:16Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/33698/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/33698",
  "id": 179905739,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 126701924,
      "name": "area/app-lifecycle",
      "node_id": "MDU6TGFiZWwxMjY3MDE5MjQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/app-lifecycle"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Cluster Lifecycle.",
      "id": 173494222,
      "name": "sig/cluster-lifecycle",
      "node_id": "MDU6TGFiZWwxNzM0OTQyMjI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cluster-lifecycle"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/33698/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-08-26T17:22:47Z",
    "closed_issues": 1412,
    "created_at": "2016-08-16T21:47:28Z",
    "creator": {
      "avatar_url": "https://avatars0.githubusercontent.com/u/647318?v=4",
      "events_url": "https://api.github.com/users/lavalamp/events{/privacy}",
      "followers_url": "https://api.github.com/users/lavalamp/followers",
      "following_url": "https://api.github.com/users/lavalamp/following{/other_user}",
      "gists_url": "https://api.github.com/users/lavalamp/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/lavalamp",
      "id": 647318,
      "login": "lavalamp",
      "node_id": "MDQ6VXNlcjY0NzMxOA==",
      "organizations_url": "https://api.github.com/users/lavalamp/orgs",
      "received_events_url": "https://api.github.com/users/lavalamp/received_events",
      "repos_url": "https://api.github.com/users/lavalamp/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/lavalamp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lavalamp/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/lavalamp"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/kubernetes/kubernetes/milestone/23",
    "id": 1945978,
    "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/23/labels",
    "node_id": "MDk6TWlsZXN0b25lMTk0NTk3OA==",
    "number": 23,
    "open_issues": 0,
    "state": "closed",
    "title": "v1.5",
    "updated_at": "2019-08-26T17:22:47Z",
    "url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/23"
  },
  "node_id": "MDU6SXNzdWUxNzk5MDU3Mzk=",
  "number": 33698,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Migrating addons from RCs to Deployments.",
  "updated_at": "2016-11-10T10:36:38Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/33698",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/8681801?v=4",
    "events_url": "https://api.github.com/users/MrHohn/events{/privacy}",
    "followers_url": "https://api.github.com/users/MrHohn/followers",
    "following_url": "https://api.github.com/users/MrHohn/following{/other_user}",
    "gists_url": "https://api.github.com/users/MrHohn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/MrHohn",
    "id": 8681801,
    "login": "MrHohn",
    "node_id": "MDQ6VXNlcjg2ODE4MDE=",
    "organizations_url": "https://api.github.com/users/MrHohn/orgs",
    "received_events_url": "https://api.github.com/users/MrHohn/received_events",
    "repos_url": "https://api.github.com/users/MrHohn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/MrHohn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MrHohn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/MrHohn"
  }
}