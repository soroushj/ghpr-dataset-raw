{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/12699319?v=4",
    "events_url": "https://api.github.com/users/andrewsykim/events{/privacy}",
    "followers_url": "https://api.github.com/users/andrewsykim/followers",
    "following_url": "https://api.github.com/users/andrewsykim/following{/other_user}",
    "gists_url": "https://api.github.com/users/andrewsykim/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/andrewsykim",
    "id": 12699319,
    "login": "andrewsykim",
    "node_id": "MDQ6VXNlcjEyNjk5MzE5",
    "organizations_url": "https://api.github.com/users/andrewsykim/orgs",
    "received_events_url": "https://api.github.com/users/andrewsykim/received_events",
    "repos_url": "https://api.github.com/users/andrewsykim/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/andrewsykim/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/andrewsykim/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/andrewsykim"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/12699319?v=4",
      "events_url": "https://api.github.com/users/andrewsykim/events{/privacy}",
      "followers_url": "https://api.github.com/users/andrewsykim/followers",
      "following_url": "https://api.github.com/users/andrewsykim/following{/other_user}",
      "gists_url": "https://api.github.com/users/andrewsykim/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/andrewsykim",
      "id": 12699319,
      "login": "andrewsykim",
      "node_id": "MDQ6VXNlcjEyNjk5MzE5",
      "organizations_url": "https://api.github.com/users/andrewsykim/orgs",
      "received_events_url": "https://api.github.com/users/andrewsykim/received_events",
      "repos_url": "https://api.github.com/users/andrewsykim/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/andrewsykim/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/andrewsykim/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/andrewsykim"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\n\r\nWhen creating a cluster with a fairly large number of nodes (~50), some nodes take up to 30 minutes after being added to the kubernetes node list to be fully initialized. I am using the openstack external cloud provider. Each call of the AddCloudNode method (in `kubernetes/pkg/controller/cloud/node_controller.go`) takes around 2-4 seconds, though this occasionally spikes up to ~10 seconds.\r\n\r\nI also see that in the openstack-cloud-controller-manager logs, nodes are being initialized multiple times.\r\n```\r\n$ cat 01.txt | grep \"Successfully initialized node resize-test-01-3k5bnt2gfikc-minion-33 with cloud provider\" | wc -l\r\n178\r\n```\r\nThis is particularly prominent for the nodes that enter the node list the latest.\r\n![output](https://user-images.githubusercontent.com/11710676/54189291-c6663d00-44b1-11e9-9043-f313cd7ffed4.png)\r\n\r\nThe cloud provider receives an Update event from each node every 10 seconds, but they are supposed to be ignored after the node has been initialized. The problem is that when the event rate (50 per 10 seconds ~ 5 per second) is higher than the processing rate (0.5 per second at best), there must be a queue of events that gets blocked up. The first nodes to be registered in kubernetes start filling up this queue with Update events, which is why it takes 30 minutes for the nodes which are added last to get their first Add event processed.\r\n\r\nThe reason that the Update events are not ignored is that the Update event checks the taints on the node object that is provided by the event, which I assume is a snapshot of the node state from the time when the event was triggered.\r\nhttps://github.com/kubernetes/kubernetes/blob/44e369b000fa9c194b5fda142a9d3f62172f27f6/pkg/controller/cloud/node_controller.go#L200-L214\r\n\r\nTherefore any Update events that are triggered before the node has its initial Add event processed are treated again as Add events, taking up even more processing time.\r\n\r\nI tried modifying UpdateCloudNode to get and check the current state of the node, and when running the openstack-cloud-controller-manager with that change all nodes are successfully initialized within 5-20 seconds of first appearing in the node list.\r\n```go\r\nfunc (cnc *CloudNodeController) UpdateCloudNode(_, newObj interface{}) {\r\n    node := newObj.(*v1.Node)\r\n    curNode, err := cnc.kubeClient.CoreV1().Nodes().Get(node.Name, metav1.GetOptions{})\r\n    if err != nil {\r\n        return\r\n    }   \r\n    cloudTaint := getCloudTaint(curNode.Spec.Taints)\r\n    if cloudTaint == nil {\r\n        glog.V(2).Infof(\"This node %s is registered without the cloud taint. Will not process.\", node.Name)\r\n        return\r\n    }   \r\n    cnc.AddCloudNode(newObj)\r\n}\r\n```\r\n\r\n**What you expected to happen**:\r\n\r\nEach node should only be initialized once, and should be initialized very quickly after appearing in the kubernetes node list.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nUse a cloud where the AddCloudNode method takes at least a few seconds and create a cluster with a large amount of nodes, or just add a time.Sleep for a few seconds to AddCloudNode.\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n```\r\n$ kubectl version\r\nClient Version: version.Info{Major:\"1\", Minor:\"13\", GitVersion:\"v1.13.3\", GitCommit:\"721bfa751924da8d1680787490c54b9179b1fed0\", GitTreeState:\"clean\", BuildDate:\"2019-02-01T20:08:12Z\", GoVersion:\"go1.11.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"13\", GitVersion:\"v1.13.3\", GitCommit:\"721bfa751924da8d1680787490c54b9179b1fed0\", GitTreeState:\"clean\", BuildDate:\"2019-02-01T20:00:57Z\", GoVersion:\"go1.11.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n- Cloud provider or hardware configuration:\r\nOpenstack\r\n- OS (e.g: `cat /etc/os-release`):\r\n- Kernel (e.g. `uname -a`):\r\n- Install tools:\r\n- Others:\r\n",
  "closed_at": "2019-05-14T18:21:20Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 29,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/75285/comments",
  "created_at": "2019-03-12T10:08:06Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/75285/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/75285",
  "id": 419899916,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 154660912,
      "name": "area/cloudprovider",
      "node_id": "MDU6TGFiZWwxNTQ2NjA5MTI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/cloudprovider"
    },
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 136601472,
      "name": "area/controller-manager",
      "node_id": "MDU6TGFiZWwxMzY2MDE0NzI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/controller-manager"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Cloud Provider.",
      "id": 958178286,
      "name": "sig/cloud-provider",
      "node_id": "MDU6TGFiZWw5NTgxNzgyODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cloud-provider"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Scalability.",
      "id": 125010198,
      "name": "sig/scalability",
      "node_id": "MDU6TGFiZWwxMjUwMTAxOTg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/scalability"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/75285/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MTk4OTk5MTY=",
  "number": 75285,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Cloud controller manager is initializing nodes multiple times, slow to finish initializing all nodes",
  "updated_at": "2019-05-14T18:21:20Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/75285",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/11710676?v=4",
    "events_url": "https://api.github.com/users/tghartland/events{/privacy}",
    "followers_url": "https://api.github.com/users/tghartland/followers",
    "following_url": "https://api.github.com/users/tghartland/following{/other_user}",
    "gists_url": "https://api.github.com/users/tghartland/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/tghartland",
    "id": 11710676,
    "login": "tghartland",
    "node_id": "MDQ6VXNlcjExNzEwNjc2",
    "organizations_url": "https://api.github.com/users/tghartland/orgs",
    "received_events_url": "https://api.github.com/users/tghartland/received_events",
    "repos_url": "https://api.github.com/users/tghartland/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/tghartland/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tghartland/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/tghartland"
  }
}