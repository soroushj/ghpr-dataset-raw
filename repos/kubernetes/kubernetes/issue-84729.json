{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "When using the resourcelock of the endpoints type, panic may be triggered if the update of the election record(e.g. tryAcquireOrRenew) fails.\r\n```\r\nfunc (el *EndpointsLock) Update(ler LeaderElectionRecord) error {\r\n\tif el.e == nil {\r\n\t\treturn errors.New(\"endpoint not initialized, call get or create first\")\r\n\t}\r\n\trecordBytes, err := json.Marshal(ler)\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\tel.e.Annotations[LeaderElectionRecordAnnotationKey] = string(recordBytes)\r\n\tel.e, err = el.Client.Endpoints(el.EndpointsMeta.Namespace).Update(el.e)\r\n\treturn err\r\n}\r\n```\r\n\r\nIf the `el.Client.Endpoints(el.EndpointsMeta.Namespace).Update(el.e)` call fails, it will return an empty   `&v1.Endpoints{}`. \r\nThe next time you call this method (e.g. release) will panic\uff1a\r\n```\r\nE1025 14:23:11.797180     528 event.go:259] Could not construct reference to: '&v1.Endpoints{TypeMeta:v1.TypeMeta{Kind:\"\", APIVersion:\"\"}, ObjectMeta:v1.ObjectMeta{Name:\"\", GenerateName:\"\", Namespace:\"\", SelfLink:\"\", UID:\"\", ResourceVersion:\"\", Generation:0, CreationTimestamp:v1.Time{Time:time.Time{wall:0x0, ext:0, loc:(*time.Location)(nil)}}, DeletionTimestamp:(*v1.Time)(nil), DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string(nil), Annotations:map[string]string(nil), OwnerReferences:[]v1.OwnerReference(nil), Initializers:(*v1.Initializers)(nil), Finalizers:[]string(nil), ClusterName:\"\"}, Subsets:[]v1.EndpointSubset(nil)}' due to: 'selfLink was empty, can't make reference'. Will not report event: 'Normal' 'LeaderElection' '11.168.116.130:8000 stopped leading'\r\ntime=\"2019-10-25T14:23:11+08:00\" level=info msg=\"no longer leader, config: &{EndpointsMeta:{Name:cni-service GenerateName: Namespace:kube-system SelfLink: UID: ResourceVersion: Generation:0 CreationTimestamp:0001-01-01 00:00:00 +0000 UTC DeletionTimestamp:<nil> DeletionGracePeriodSeconds:<nil> Labels:map[] Annotations:map[] OwnerReferences:[] Initializers:nil Finalizers:[] ClusterName:} Client:0xc420413930 LockConfig:{Identity:11.168.116.130:8000 EventRecorder:0xc4201c1540} e:0xc420bf5320}\"\r\npanic: assignment to entry in nil map\r\n\r\ngoroutine 83 [running]:\r\nxx.com/xx/xx/vendor/k8s.io/client-go/tools/leaderelection/resourcelock.(*EndpointsLock).Update(0xc42010eea0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n  /home/admin/107_20190819200832752_99814907_code/gopath/src/xx.com/xx/xx/vendor/k8s.io/client-go/tools/leaderelection/resourcelock/endpointslock.go:84 +0x137\r\nxx.com/xx/xx/vendor/k8s.io/client-go/tools/leaderelection.(*LeaderElector).release(0xc42010f0e0,0xb2d05e00)\r\n  /home/admin/107_20190819200832752_99814907_code/gopath/src/xx.com/xx/xx/vendor/k8s.io/client-go/tools/leaderelection/leaderelection.go:281 +0xb1\r\nxx.com/xx/xx/vendor/k8s.io/client-go/tools/leaderelection.(*LeaderElector).renew(0xc42010f0e0, 0x153c800, 0xc4200154c0)\r\n  /home/admin/107_20190819200832752_99814907_code/gopath/src/xx.com/xx/xx/vendor/k8s.io/client-go/tools/leaderelection/leaderelection.go:269 +0x115\r\nxx.com/xx/xx/vendor/k8s.io/client-go/tools/leaderelection.(*LeaderElector).Run(0xc42010f0e0, 0x153c800, 0xc420015440)\r\n  /home/admin/107_20190819200832752_99814907_code/gopath/src/xx.com/xx/xx/vendor/k8s.io/client-go/tools/leaderelection/leaderelection.go:183 +0x110\r\nmain.main.func1(0xc42010f0e0)\r\n  /home/admin/107_20190819200832752_99814907_code/gopath/src/xx.com/xx/xx/main.go:77 +0x3b\r\ncreated by main.main\r\n  /home/admin/107_20190819200832752_99814907_code/gopath/src/xx.com/xx/xx/main.go:73 +0x791\r\n```\r\n\r\n",
  "closed_at": "2019-11-14T16:02:27Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1787169?v=4",
    "events_url": "https://api.github.com/users/mikedanese/events{/privacy}",
    "followers_url": "https://api.github.com/users/mikedanese/followers",
    "following_url": "https://api.github.com/users/mikedanese/following{/other_user}",
    "gists_url": "https://api.github.com/users/mikedanese/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mikedanese",
    "id": 1787169,
    "login": "mikedanese",
    "node_id": "MDQ6VXNlcjE3ODcxNjk=",
    "organizations_url": "https://api.github.com/users/mikedanese/orgs",
    "received_events_url": "https://api.github.com/users/mikedanese/received_events",
    "repos_url": "https://api.github.com/users/mikedanese/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mikedanese/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mikedanese/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mikedanese"
  },
  "comments": 16,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/84729/comments",
  "created_at": "2019-11-04T04:11:01Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/84729/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/84729",
  "id": 517242528,
  "labels": [
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/84729/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MTcyNDI1Mjg=",
  "number": 84729,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "resourcelock *EndpointsLock.Update may trigger panic",
  "updated_at": "2020-03-21T00:56:39Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/84729",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/7133683?v=4",
    "events_url": "https://api.github.com/users/lujinda/events{/privacy}",
    "followers_url": "https://api.github.com/users/lujinda/followers",
    "following_url": "https://api.github.com/users/lujinda/following{/other_user}",
    "gists_url": "https://api.github.com/users/lujinda/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lujinda",
    "id": 7133683,
    "login": "lujinda",
    "node_id": "MDQ6VXNlcjcxMzM2ODM=",
    "organizations_url": "https://api.github.com/users/lujinda/orgs",
    "received_events_url": "https://api.github.com/users/lujinda/received_events",
    "repos_url": "https://api.github.com/users/lujinda/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lujinda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lujinda/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lujinda"
  }
}