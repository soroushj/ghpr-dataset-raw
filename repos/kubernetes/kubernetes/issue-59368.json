{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!-- This form is for bug reports and feature requests ONLY! \r\n\r\nIf you're looking for help check [Stack Overflow](https://stackoverflow.com/questions/tagged/kubernetes) and the [troubleshooting guide](https://kubernetes.io/docs/tasks/debug-application-cluster/troubleshooting/).\r\n-->\r\n\r\n**Is this a BUG REPORT or FEATURE REQUEST?**: BUG REPORT\r\n\r\n> Uncomment only one, leave it on its own line: \r\n>\r\n/kind bug\r\n> /kind feature\r\n\r\n\r\n**What happened**:\r\nWhen deleting/recreating pods backing a UDP service, traffic from external senders stops flowing.\r\n\r\n**What you expected to happen**:\r\nTraffic would continue to flow to new pods.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nBased on reading of similar issues and commit messages it seems like this would be most noticable on high-volume UDP applications, statsd and syslog are good examples.\r\n\r\n1. Create a deployment and service for a UDP app. In my test case, this would be the `atlassianlabs/gostatsd:5.2.0` container.\r\n2. On an external node, create a small test script utilizing a statsd library such as pystatsd. The most important part is that the sender uses the same source-port for every packet sent. Ex:\r\n```\r\nimport time\r\nimport pystatsd\r\n\r\nstats = pystatsd.Client('104.197.127.53', 8125)\r\nwhile True:\r\n    stats.increment('joe-testing-delete-me-timing.testing')\r\n    time.sleep(0.2)\r\n```\r\n3. Run the sender. Install tcpdump into the pod and watch for incoming packets, example from the test case: `tcpdump -A -s0 port 8125 | grep joe-testing`\r\n4. Delete the pod\r\n5. Run tcpdump in the newly created pod. Observe that no new matching packets are flowing.\r\n6. Clear existing conntrack rules on all nodes in the cluster. You should see traffic start flowing to the pod again. example command for clearing conntrack rules on the nodes: `docker run --net=host --privileged --rm claesjonsson/conntrack -D -p udp --orig-port-dst 8125`\r\n\r\n\r\n**Anything else we need to know?**:\r\nI have tested this only on GKE-managed clusters that utilize google forwarding-rules for external LBs, but I believe the issue may be present on any platform where iptables mode for kube-proxy is used. Tested and verified on 1.8.6-gke.0 and 1.7.11-gke.1. Also tested with both Google Container-optimized OS and the Ubuntu-based node images.\r\n\r\nI have only test this on GKE \r\n\r\nIt appears this was a known issue and should have been cleared up by: https://github.com/kubernetes/kubernetes/pull/22573/files \r\n\r\nFrom my reading of iptables/proxier.go, it seems as if the `deleteEndpointConnections()` func should exec() `conntrack` to clear up UDP entries on service endpoint change, but the only place I see that func called is from syncProxyRules(). That func looks complex and possibly like it is only run occasionally and not on service/endpoint changes.\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"8\", GitVersion:\"v1.8.6\", GitCommit:\"6260bb08c46c31eea6cb538b34a9ceb3e406689c\", GitTreeState:\"clean\", BuildDate:\"2017-12-21T06:34:11Z\", GoVersion:\"go1.8.3\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"8+\", GitVersion:\"v1.8.6-gke.0\", GitCommit:\"ee9a97661f14ee0b1ca31d6edd30480c89347c79\", GitTreeState:\"clean\", BuildDate:\"2018-01-05T03:36:42Z\", GoVersion:\"go1.8.3b4\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n(Also tested on 1.7.11-gke.1)\r\n- Cloud provider or hardware configuration:\r\nGKE-managed clusters, google cloud.\r\n- OS (e.g. from /etc/os-release):\r\ntried both:\r\n```\r\nNAME=\"Ubuntu\"\r\nVERSION=\"16.04.3 LTS (Xenial Xerus)\"\r\nID=ubuntu\r\nID_LIKE=debian\r\nPRETTY_NAME=\"Ubuntu 16.04.3 LTS\"\r\nVERSION_ID=\"16.04\"\r\nHOME_URL=\"http://www.ubuntu.com/\"\r\nSUPPORT_URL=\"http://help.ubuntu.com/\"\r\nBUG_REPORT_URL=\"http://bugs.launchpad.net/ubuntu/\"\r\nVERSION_CODENAME=xenial\r\nUBUNTU_CODENAME=xenial\r\n```\r\nand\r\n```\r\nBUILD_ID=10032.71.0\r\nNAME=\"Container-Optimized OS\"\r\nKERNEL_COMMIT_ID=c4c6234ae4f384ce00819c41b48ca8f6f1fa3ba8\r\nGOOGLE_CRASH_ID=Lakitu\r\nVERSION_ID=63\r\nBUG_REPORT_URL=https://crbug.com/new\r\nPRETTY_NAME=\"Container-Optimized OS from Google\"\r\nVERSION=63\r\nGOOGLE_METRICS_PRODUCT_ID=26\r\nHOME_URL=\"https://cloud.google.com/compute/docs/containers/vm-image/\"\r\nID=cos\r\n```\r\n- Kernel (e.g. `uname -a`):\r\n```\r\nLinux gke-cluster-01-kube17-04b-6782975f-4xwn 4.4.86+ #1 SMP Thu Dec 7 20:11:11 PST 2017 x86_64 Intel(R) Xeon(R) CPU @ 2.60GHz GenuineIntel GNU/Linux\r\n```\r\n\r\nand\r\n\r\n```\r\nLinux gke-udp-ubuntu-test-default-pool-cf65ad93-bpnb 4.4.0-1027-gke #27-Ubuntu SMP Thu Aug 10 13:13:08 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n- Install tools:\r\n- Others:\r\n",
  "closed_at": "2018-12-07T23:01:43Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 16,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59368/comments",
  "created_at": "2018-02-05T20:56:01Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59368/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/59368",
  "id": 294539201,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Network.",
      "id": 116712108,
      "name": "sig/network",
      "node_id": "MDU6TGFiZWwxMTY3MTIxMDg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/network"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59368/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyOTQ1MzkyMDE=",
  "number": 59368,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kube-proxy/iptables, UDP conntrack data not removed on endpoint changes",
  "updated_at": "2020-10-11T12:13:02Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59368",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/377603?v=4",
    "events_url": "https://api.github.com/users/joemiller/events{/privacy}",
    "followers_url": "https://api.github.com/users/joemiller/followers",
    "following_url": "https://api.github.com/users/joemiller/following{/other_user}",
    "gists_url": "https://api.github.com/users/joemiller/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/joemiller",
    "id": 377603,
    "login": "joemiller",
    "node_id": "MDQ6VXNlcjM3NzYwMw==",
    "organizations_url": "https://api.github.com/users/joemiller/orgs",
    "received_events_url": "https://api.github.com/users/joemiller/received_events",
    "repos_url": "https://api.github.com/users/joemiller/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/joemiller/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/joemiller/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/joemiller"
  }
}