{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n**What happened**:\r\n\r\nWith the exec credentials plugin configured in my kubeconf, *and* a stale/expired token present in the same file issuing e.g. `kubectl get pod` triggers the authentication flow as handled by the plugin - once the flow is returned to kubectl (by printing the ExecCredential object) the new token is stored to the kubeconfig *but* not immediately used to resolve the `kubectl get pod` request, leading to:\r\n\r\n`error: You must be logged in to the server (Unauthorized)`\r\n\r\nImmediately issuing `kubectl get pod` again works as kubectl now seem to use the credentials (token) stored following the first request.\r\n\r\n**What you expected to happen**:\r\n\r\nThat kubectl would read the new token as fetched by the exec credential plugin and use it already for the first command issued. \r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n1. Configure the kubernetes API server with the OIDC authenticator enabled.\r\n2. Configure kubectl to use an exec credential plugin printing the token received out of band.\r\n3. Verify that the token was indeed written to the kubeconf file.\r\n4. See that the first kubectl command failed.\r\n5. See that the next identical command succeeds.\r\n\r\n**Anything else we need to know?**:\r\n\r\nThis works as expected when there is *no* token previously stored in the kubeconf - the behavior is only triggered when there is a token stored but it expired, or for whatever other reason not accepted by the API server.\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): 1.14, also tried with 1.17\r\n- Cloud provider or hardware configuration:\r\n- OS (e.g: `cat /etc/os-release`): Mac OS for kubectl client\r\n- Kernel (e.g. `uname -a`):\r\n- Install tools:\r\n- Network plugin and version (if this is a network-related bug):\r\n- Others:\r\n",
  "closed_at": "2020-07-09T16:07:02Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 10,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/87369/comments",
  "created_at": "2020-01-19T13:44:59Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/87369/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/87369",
  "id": 551924331,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Auth.",
      "id": 357119284,
      "name": "sig/auth",
      "node_id": "MDU6TGFiZWwzNTcxMTkyODQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/auth"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG CLI.",
      "id": 450823910,
      "name": "sig/cli",
      "node_id": "MDU6TGFiZWw0NTA4MjM5MTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cli"
    },
    {
      "color": "d455d0",
      "default": false,
      "description": "Indicates an issue needs more information in order to work on it.",
      "id": 862108635,
      "name": "triage/needs-information",
      "node_id": "MDU6TGFiZWw4NjIxMDg2MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/triage/needs-information"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/87369/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1NTE5MjQzMzE=",
  "number": 87369,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kubecetl client-go exec credentials plugin should use new valid token as soon as stored rather than old expired",
  "updated_at": "2020-07-09T16:07:02Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/87369",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/510711?v=4",
    "events_url": "https://api.github.com/users/anderseknert/events{/privacy}",
    "followers_url": "https://api.github.com/users/anderseknert/followers",
    "following_url": "https://api.github.com/users/anderseknert/following{/other_user}",
    "gists_url": "https://api.github.com/users/anderseknert/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/anderseknert",
    "id": 510711,
    "login": "anderseknert",
    "node_id": "MDQ6VXNlcjUxMDcxMQ==",
    "organizations_url": "https://api.github.com/users/anderseknert/orgs",
    "received_events_url": "https://api.github.com/users/anderseknert/received_events",
    "repos_url": "https://api.github.com/users/anderseknert/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/anderseknert/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/anderseknert/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/anderseknert"
  }
}