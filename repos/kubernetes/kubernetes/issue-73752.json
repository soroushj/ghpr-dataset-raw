{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/980082?v=4",
    "events_url": "https://api.github.com/users/liggitt/events{/privacy}",
    "followers_url": "https://api.github.com/users/liggitt/followers",
    "following_url": "https://api.github.com/users/liggitt/following{/other_user}",
    "gists_url": "https://api.github.com/users/liggitt/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/liggitt",
    "id": 980082,
    "login": "liggitt",
    "node_id": "MDQ6VXNlcjk4MDA4Mg==",
    "organizations_url": "https://api.github.com/users/liggitt/orgs",
    "received_events_url": "https://api.github.com/users/liggitt/received_events",
    "repos_url": "https://api.github.com/users/liggitt/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/liggitt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/liggitt/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/liggitt"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/980082?v=4",
      "events_url": "https://api.github.com/users/liggitt/events{/privacy}",
      "followers_url": "https://api.github.com/users/liggitt/followers",
      "following_url": "https://api.github.com/users/liggitt/following{/other_user}",
      "gists_url": "https://api.github.com/users/liggitt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/liggitt",
      "id": 980082,
      "login": "liggitt",
      "node_id": "MDQ6VXNlcjk4MDA4Mg==",
      "organizations_url": "https://api.github.com/users/liggitt/orgs",
      "received_events_url": "https://api.github.com/users/liggitt/received_events",
      "repos_url": "https://api.github.com/users/liggitt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/liggitt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/liggitt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/liggitt"
    },
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/1613024?v=4",
      "events_url": "https://api.github.com/users/mbohlool/events{/privacy}",
      "followers_url": "https://api.github.com/users/mbohlool/followers",
      "following_url": "https://api.github.com/users/mbohlool/following{/other_user}",
      "gists_url": "https://api.github.com/users/mbohlool/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mbohlool",
      "id": 1613024,
      "login": "mbohlool",
      "node_id": "MDQ6VXNlcjE2MTMwMjQ=",
      "organizations_url": "https://api.github.com/users/mbohlool/orgs",
      "received_events_url": "https://api.github.com/users/mbohlool/received_events",
      "repos_url": "https://api.github.com/users/mbohlool/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mbohlool/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mbohlool/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mbohlool"
    }
  ],
  "author_association": "NONE",
  "body": "**What happened**:\r\n\r\nHere is a brief explanation of my environment (I'll explain how to reproduce it in the relevant section below):\r\n\r\nI'm on the latest stable 1.13, which is 1.13.2. I'm using `microk8s` to be able to test this on multiple versions.\r\n\r\nI have both a ValidationWebHookConfiguration and mutatingWebHookConfiguration defined.\r\n\r\nValidatingWebhookConfiguration:\r\n```\r\napiVersion: admissionregistration.k8s.io/v1beta1\r\nkind: ValidatingWebhookConfiguration\r\nmetadata:\r\n  name: application-validation-webhook-configuration\r\nwebhooks:\r\n- clientConfig:\r\n    caBundle: YXBpVmVyc2lvbjogYWRtaXNzaW9ucmVnaXN0cmF0aW9uLms4cy5pby92MWJldGExCmtpbmQ6IE11dGF0aW5nV2ViaG9va0NvbmZpZ3VyYXRpb24KbWV0YWRhdGE6CiAgbmFtZTogYXBwbGljYXRpb24tbXV0YXRpb24td2ViaG9vay1jb25maWd1cmF0aW9uCndlYmhvb2tzOgotIGNsaWVudENvbmZpZzoKICAgIGNhQnVuZGxlOiBhCiAgICBzZXJ2aWNlOiBudWxsCiAgICB1cmw6IGh0dHBzOi8vMTI3LjAuMC4xOjg0NDMvdjEvbXV0YXRlLWFwcGxpY2F0aW9ucwogIGZhaWx1cmVQb2xpY3k6IElnbm9yZQogIG5hbWU6IGFwcGxpY2F0aW9uCiAgcnVsZXM6CiAgLSBhcGlHcm91cHM6CiAgICAtICcqJwogICAgYXBpVmVyc2lvbnM6CiAgICAtICcqJwogICAgb3BlcmF0aW9uczoKICAgIC0gQ1JFQVRFCiAgICAtIFVQREFURQogICAgcmVzb3VyY2VzOgogICAgLSBhcHBsaWNhdGlvbnMK\r\n    service: null\r\n    url: https://127.0.0.1:8443/v1/validate-applications\r\n  name: applications.shipper.booking.com\r\n  failurePolicy: Ignore\r\n  rules:\r\n  - apiGroups:\r\n    - '*'\r\n    apiVersions:\r\n    - '*'\r\n    operations:\r\n    - CREATE\r\n    - UPDATE\r\n    resources:\r\n    - applications\r\n\r\n```\r\n\r\nMutatingWebhookConfiguration:\r\n\r\n```\r\napiVersion: admissionregistration.k8s.io/v1beta1\r\nkind: MutatingWebhookConfiguration\r\nmetadata:\r\n  name: application-mutation-webhook-configuration\r\nwebhooks:\r\n- clientConfig:\r\n    caBundle: YXBpVmVyc2lvbjogYWRtaXNzaW9ucmVnaXN0cmF0aW9uLms4cy5pby92MWJldGExCmtpbmQ6IE11dGF0aW5nV2ViaG9va0NvbmZpZ3VyYXRpb24KbWV0YWRhdGE6CiAgbmFtZTogYXBwbGljYXRpb24tbXV0YXRpb24td2ViaG9vay1jb25maWd1cmF0aW9uCndlYmhvb2tzOgotIGNsaWVudENvbmZpZzoKICAgIGNhQnVuZGxlOiBhCiAgICBzZXJ2aWNlOiBudWxsCiAgICB1cmw6IGh0dHBzOi8vMTI3LjAuMC4xOjg0NDMvdjEvbXV0YXRlLWFwcGxpY2F0aW9ucwogIGZhaWx1cmVQb2xpY3k6IElnbm9yZQogIG5hbWU6IGFwcGxpY2F0aW9uCiAgcnVsZXM6CiAgLSBhcGlHcm91cHM6CiAgICAtICcqJwogICAgYXBpVmVyc2lvbnM6CiAgICAtICcqJwogICAgb3BlcmF0aW9uczoKICAgIC0gQ1JFQVRFCiAgICAtIFVQREFURQogICAgcmVzb3VyY2VzOgogICAgLSBhcHBsaWNhdGlvbnMK\r\n\r\n    service: null\r\n    url: https://127.0.0.1:8443/v1/mutate-applications\r\n  failurePolicy: Ignore\r\n  name: applications.shipper.booking.com\r\n  rules:\r\n  - apiGroups:\r\n    - '*'\r\n    apiVersions:\r\n    - '*'\r\n    operations:\r\n    - CREATE\r\n    - UPDATE\r\n    resources:\r\n    - applications\r\n```\r\n\r\nI also have a CRD, which defines multiple versions. `v1` is the older version which we were using before Kubernetes supported versioning. Now that Kubernetes allows us to define multiple versions, we want to move to `v1alpha1`. That's why you will see the object being _served_ as `v1`, but not _stored_ as `v1`:\r\n\r\n```\r\napiVersion: apiextensions.k8s.io/v1beta1\r\nkind: CustomResourceDefinition\r\nmetadata:\r\n  name: applications.shipper.booking.com\r\nspec:\r\n  additionalPrinterColumns:\r\n  - JSONPath: .metadata.creationTimestamp\r\n    description: |-\r\n      CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC.\r\n\r\n      Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata\r\n    name: Age\r\n    type: date\r\n  conversion:\r\n    strategy: None\r\n  group: shipper.booking.com\r\n  names:\r\n    categories:\r\n    - all\r\n    - shipper\r\n    kind: Application\r\n    listKind: ApplicationList\r\n    plural: applications\r\n    shortNames:\r\n    - app\r\n    singular: application\r\n  scope: Namespaced\r\n  validation:\r\n    openAPIV3Schema:\r\n      properties:\r\n        spec:\r\n          properties:\r\n            template:\r\n              properties:\r\n                clusterRequirements:\r\n                  properties:\r\n                    capabilities:\r\n                      items:\r\n                        type: string\r\n                      type: array\r\n                    regions:\r\n                      items:\r\n                        type: object\r\n                      type: array\r\n                  required:\r\n                  - regions\r\n                  type: object\r\n                strategy:\r\n                  properties:\r\n                    steps:\r\n                      items:\r\n                        properties:\r\n                          capacity:\r\n                            properties:\r\n                              contender:\r\n                                maximum: 100\r\n                                minimum: 0\r\n                                type: integer\r\n                              incumbent:\r\n                                maximum: 100\r\n                                minimum: 0\r\n                                type: integer\r\n                            required:\r\n                            - incumbent\r\n                            - contender\r\n                            type: object\r\n                          name:\r\n                            type: string\r\n                          traffic:\r\n                            properties:\r\n                              contender:\r\n                                minimum: 0\r\n                                type: integer\r\n                              incumbent:\r\n                                minimum: 0\r\n                                type: integer\r\n                            required:\r\n                            - incumbent\r\n                            - contender\r\n                            type: object\r\n                        required:\r\n                        - name\r\n                        - traffic\r\n                        - capacity\r\n                        type: object\r\n                      type: array\r\n                  required:\r\n                  - steps\r\n                  type: object\r\n                values:\r\n                  type: object\r\n              required:\r\n              - clusterRequirements\r\n              - strategy\r\n              - values\r\n              type: object\r\n          required:\r\n          - template\r\n          type: object\r\n  version: v1alpha1\r\n  versions:\r\n  - name: v1alpha1\r\n    served: true\r\n    storage: true\r\n  - name: v1\r\n    served: true\r\n    storage: false\r\n```\r\n\r\nNow, if you create an Application like this:\r\n\r\n```\r\n  apiVersion: shipper.booking.com/v1alpha1\r\n  kind: Application\r\n  metadata:\r\n    name: super-server\r\n  spec:\r\n    revisionHistoryLimit: 3\r\n    template:\r\n      chart:\r\n        name: nginx\r\n        repoUrl: https://storage.googleapis.com/shipper-demo\r\n        version: 0.0.1\r\n      clusterRequirements:\r\n        regions:\r\n        - name: local\r\n      strategy:\r\n        steps:\r\n        - capacity:\r\n            contender: 1\r\n            incumbent: 100\r\n          name: staging\r\n          traffic:\r\n            contender: 0\r\n            incumbent: 100\r\n        - capacity:\r\n            contender: 100\r\n            incumbent: 0\r\n          name: full on\r\n          traffic:\r\n            contender: 100\r\n            incumbent: 0\r\n      values:\r\n        replicaCount: 3\r\n```\r\n\r\nNow, if you restart the server and try to edit this application with `kubectl edit app super-server` (noting that the file you're editing has the version as `v1` and not `v1alpha1`), you will get an error like this:\r\n\r\n```\r\nInternal error occurred: no kind \"Application\" is registered for version \"shipper.booking.com/v1\" in scheme \"k8s.io/apiextensions-apiserver/pkg/apiserver/apiserver.go:52\"\r\n```\r\n\r\nNow, if you do the same edit, but change the version to `v1alpha1` by hand, all subsequent patches to this object will work without a problem, until the next restart.\r\n\r\nThe restart is very important: this problem is 100% reproducable after a restart. We have observed it happening in production as well, but the way to reproduce it without waiting for it to happen is to restart `kube-apiserver` and edit the application with `kubectl edit app super-server`.\r\n\r\nHere is what we've found through our testing:\r\n\r\n1. As I said before, this happens 100% after a restart.\r\n2. Changing the version to `v1alpha1` by hand while editing causes `kubectl` to send a patch to the `v1alpha1` endpoint instead of the `v1` endpoint, and from then on there won't be any problems interacting with this object.\r\n3. Step number 2 works per object only. In other words, if you do step 2 for `app1` and not `app2`, `app1` will not have a problem but `app2` will have problems.\r\n4. If you add `namespaceSelectors` to the ValidatingWebhookConfiguration and MutatingWebhookConfiguration so that they don't apply to your Application objects anymore, it will solve the problem for all the objects in this cluster. This issue will not occur again for an indeterminable amount of time if you remove the `namespaceSelectors`. In other words, if you remove the `namespaceSelectors`, we've observed that the issue will happen, but within weeks or days.\r\n\r\nNote that step 4 will fix the issue for *all* Applications, while step 2 will fix it for *only one* Application object.\r\n\r\n**What you expected to happen**:\r\n\r\nSending a patch request to the `v1` endpoint should convert the object to `v1alpha1` and store it as `v1alpha1` instead of throwing an error about the version not defined. Also, having a ValidatingWebhookConfiguration and MutatingWebhookConfiguration shouldn't cause this to happen.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n1. Use microk8s to get the latest Kubernetes version.\r\n2. Download the attached tarball and untar it with `tar -xzf v1alpha1.tar.gz`\r\n3. `cd` into the directory, and set up your environment by running the following commands:\r\n    \r\n    ```\r\n    $ kubectl apply -f v.yaml\r\n    $ kubectl apply -f m.yaml\r\n    $ kubectl apply -f app-crd.yaml\r\n    ```\r\n    \r\n4. Run the script called `test-kubernetes-application-bug.sh` which will reproduce the problem for you. Basically, you can also create an Application object with whatever version you like, restart the server, and edit it with `kubectl` to add a label.\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): 1.13.2\r\n- Cloud provider or hardware configuration:\r\n- OS (e.g. from /etc/os-release): CentOS 7\r\n- Kernel (e.g. `uname -a`): 3.10.0-862.14.4.el7.x86_64\r\n- Install tools: microk8s\r\n[v1alpha1.tar.gz](https://github.com/kubernetes/kubernetes/files/2832903/v1alpha1.tar.gz)\r\n",
  "closed_at": "2019-02-19T15:21:54Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 7,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/73752/comments",
  "created_at": "2019-02-05T16:20:50Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/73752/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/73752",
  "id": 406862550,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 486445796,
      "name": "area/admission-control",
      "node_id": "MDU6TGFiZWw0ODY0NDU3OTY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/admission-control"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/73752/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MDY4NjI1NTA=",
  "number": 73752,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Operations on custom resources with multiple versions fails when validating and mutating web hooks are configured on it",
  "updated_at": "2019-02-19T15:21:54Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/73752",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/352539?v=4",
    "events_url": "https://api.github.com/users/parhamdoustdar/events{/privacy}",
    "followers_url": "https://api.github.com/users/parhamdoustdar/followers",
    "following_url": "https://api.github.com/users/parhamdoustdar/following{/other_user}",
    "gists_url": "https://api.github.com/users/parhamdoustdar/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/parhamdoustdar",
    "id": 352539,
    "login": "parhamdoustdar",
    "node_id": "MDQ6VXNlcjM1MjUzOQ==",
    "organizations_url": "https://api.github.com/users/parhamdoustdar/orgs",
    "received_events_url": "https://api.github.com/users/parhamdoustdar/received_events",
    "repos_url": "https://api.github.com/users/parhamdoustdar/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/parhamdoustdar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/parhamdoustdar/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/parhamdoustdar"
  }
}