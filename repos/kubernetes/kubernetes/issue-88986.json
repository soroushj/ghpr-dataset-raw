{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/7182341?v=4",
    "events_url": "https://api.github.com/users/rikatz/events{/privacy}",
    "followers_url": "https://api.github.com/users/rikatz/followers",
    "following_url": "https://api.github.com/users/rikatz/following{/other_user}",
    "gists_url": "https://api.github.com/users/rikatz/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rikatz",
    "id": 7182341,
    "login": "rikatz",
    "node_id": "MDQ6VXNlcjcxODIzNDE=",
    "organizations_url": "https://api.github.com/users/rikatz/orgs",
    "received_events_url": "https://api.github.com/users/rikatz/received_events",
    "repos_url": "https://api.github.com/users/rikatz/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rikatz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rikatz/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rikatz"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/6450081?v=4",
      "events_url": "https://api.github.com/users/aojea/events{/privacy}",
      "followers_url": "https://api.github.com/users/aojea/followers",
      "following_url": "https://api.github.com/users/aojea/following{/other_user}",
      "gists_url": "https://api.github.com/users/aojea/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/aojea",
      "id": 6450081,
      "login": "aojea",
      "node_id": "MDQ6VXNlcjY0NTAwODE=",
      "organizations_url": "https://api.github.com/users/aojea/orgs",
      "received_events_url": "https://api.github.com/users/aojea/received_events",
      "repos_url": "https://api.github.com/users/aojea/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/aojea/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aojea/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/aojea"
    },
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/7182341?v=4",
      "events_url": "https://api.github.com/users/rikatz/events{/privacy}",
      "followers_url": "https://api.github.com/users/rikatz/followers",
      "following_url": "https://api.github.com/users/rikatz/following{/other_user}",
      "gists_url": "https://api.github.com/users/rikatz/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rikatz",
      "id": 7182341,
      "login": "rikatz",
      "node_id": "MDQ6VXNlcjcxODIzNDE=",
      "organizations_url": "https://api.github.com/users/rikatz/orgs",
      "received_events_url": "https://api.github.com/users/rikatz/received_events",
      "repos_url": "https://api.github.com/users/rikatz/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rikatz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rikatz/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rikatz"
    }
  ],
  "author_association": "NONE",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\nFrom a computer (ghana) outside my dev cluster (tonga, spain) I can access a micro service via its NodePort (in the following the service just responds with the string \"Im not well. Please restart me!\")\r\n![image](https://user-images.githubusercontent.com/48793689/76258380-ce260200-6229-11ea-9fd5-a876d20415e9.png)\r\n\r\n\r\nBut when I try to access the service either via its ClusterIP, or via its EXTERNAL-IP, I see a delay in routing the request to a pod on \"the other node\". \r\n\r\nI intially thought this might be a problem with MetalLB, however I've now taken MetalLB out of the loop completely, and see this problem when accessing the service via the ClusterIP. \r\n\r\n**Cluster IP curl - (10.96.11.2)**\r\n![image](https://user-images.githubusercontent.com/48793689/76563644-2f461380-647e-11ea-9881-344ce77d690f.png)\r\n\r\n **EXTERNAL-IP curl (192.168.1.241**)\r\nThough the following picture is with the NodePort (30123), I've also tried the PORT(8080)\r\n![image](https://user-images.githubusercontent.com/48793689/76258522-1e04c900-622a-11ea-9409-c3f88b0840c0.png)\r\n\r\n**The pictures show**\r\nFrom a node inside the cluster, I am able to curl to the service using either its ClusterIP:PORT or its EXTERNAL-IP:PORT, but when that curl request is routed to a pod in the cluster, _that is on the other node_, it takes **_63_** seconds for the request to arrive at the pod on that node\r\n\r\nThis delay (of 1 minute) is seen in the following picture.\r\n\r\n![image](https://user-images.githubusercontent.com/48793689/76452938-4ca8ae00-63a8-11ea-8243-2c6140f79ea2.png)\r\n\r\nIn the following I am running tcpdump on the traffic to the PODS IP (10.244.2.5). \r\n\r\nAs soon as I perform the curl I see several packets that flow to port (8080) \"webcache\" . Its not until 1 minute later that I see the message that triggers the request sent to the pod itself... then the pod responds.\r\n\r\n![image](https://user-images.githubusercontent.com/48793689/76454343-df4a4c80-63aa-11ea-9cd7-3bc85c9c2e93.png)\r\n\r\nIt seems that the first series of SYN packets dont get through.\r\n\r\n**Interesting Note**\r\nIts interesting to see that the SYN packets that lead up to the successful request have increasing time delays (in seconds): 1, 2, 4, 8, 16, 32. Then we see the SYN ACK from the kubia service.\r\n\r\nIt seems that the packet is being sent to the POD IP, however that packet is not routed to the container entrypoint.\r\n\r\n\r\nI've also posted [this delay problem](https://discuss.kubernetes.io/t/bare-metal-k8s-load-balancer-service-routing-delay/10035) on the k8s forum.\r\n\r\n**What you expected to happen**:\r\ncurl to EXTERNAL_IP:SERVICE_PORT (192.168.1.241:8080) \r\nor to \r\ncurl to CLUSTER_IP:SERVICE_PORT (10.96.11.2:8080) \r\n\r\nshould succeed, promptly (within just a few msec)\r\n\r\n**Update**\r\nBecause I've learned a bit and isolated a bit (since first writing this issue), please go to my last comment, and \"read up\". \r\n\r\nThe comments starting with the one that says \"Hmmm.. What i find is that I'm able to curl the pod port 8080 sometimes when i run the curl on the master, but not when I run it from outside the cluster.\" are most informative.\r\n\r\nI've captured my latest understanding in those comments. \r\n\r\n**In short, I'm seeing an unexpected 60 second delay in response to service queries that get Load Balanced to the other node. Further, I dont seem to be able to hit the EXTERNAL-IP from outside the cluster (those requests never seem to make it to the pod, though they do make it to the cluster nodes).**\r\n\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nOn a bare metal cluster, create and deploy a service such as the one below:\r\n![image](https://user-images.githubusercontent.com/48793689/76312627-d291ff80-62a9-11ea-9066-00ad58830a34.png)\r\n\r\nI deployed the micro service using a replicaset.\r\n\r\n![image](https://user-images.githubusercontent.com/48793689/76314414-218d6400-62ad-11ea-98c1-1693af54ee4b.png)\r\n\r\nExpose the service via a LoadBalancer.\r\n\r\n![image](https://user-images.githubusercontent.com/48793689/76315322-da07d780-62ae-11ea-81c7-79a4899616a3.png)\r\n\r\n\r\nThe following service description illustrates the pod EndPoints for the 2 pod replicas\r\n![image](https://user-images.githubusercontent.com/48793689/76319620-de83be80-62b5-11ea-8b49-7f1cf98a5dc8.png)\r\n\r\nIn the following we see that kube-proxy has properly bound to the NodePort on my k8s nodes\r\n![image](https://user-images.githubusercontent.com/48793689/76316299-bcd40880-62b0-11ea-8fc5-82ff8cfee05e.png)\r\n\r\n\r\nInstall [MetalLB](https://metallb.universe.tf/concepts/layer2/).\r\n\r\nI used \r\n`kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.8.3/manifests/metallb.yaml`\r\n\r\nwith layer 2 configuration as depicted [here](https://metallb.universe.tf/configuration/).\r\n\r\n![image](https://user-images.githubusercontent.com/48793689/76315451-13404780-62af-11ea-995e-bec4a0a8499d.png)\r\n\r\n\r\nOn a box outside the cluster add a logical network and assign an IP on that network\r\n\r\nOn ghana (my test client box outside the cluster) I used the following (em1 is a physical interface that can connect to the k8s cluster):\r\n`ifconfig em1:0 192.168.1.243 255.255.255.0`\r\n\r\nI also tried 192.168.1.239 (outside the range owned by MetalLB - based on the configuration above)\r\n\r\nThe following would also work.\r\n`ip addr add 192.168.1.243/24 dev em1 label em1:0`\r\n\r\nNow its possible to use that logical network to curl 192.168.1.241 (the EXTERNAL-IP assigned by MetalLB) at port 30123 (the NodePort that kube-proxy binds to associated with the LoadBalancer service.\r\n\r\ntcpdump on any of the k8s nodes can verify that the curl request arrives at port 30123 (the port kube-proxy has bound) on the k8s node. \r\n\r\ntcpdump can also be used to verify that kube-proxy does not respond (with SYN-ACK) to the SYN bit found with curls  \"synchronize\" request. \r\n\r\n\r\n**Anything else we need to know?**:\r\n\r\nIn the following we see my EXTERNAL-IP is 192.168.1.241\r\n![image](https://user-images.githubusercontent.com/48793689/76258118-59eb5e80-6229-11ea-817d-60d098babdb2.png)\r\n\r\nThe MetalLB load balancer is responding properly to arp. \r\n\r\nA ping or curl (from my test node ghana) to 192.168.1.241 results in an arp table entry that uses the proper physical interface (em1). \r\n\r\nIn the following tcpdump on k8s worker spain we see both the ARP request/reply, and the curl request (with SYN set), yet no SYN-ACK in reply\r\n\r\n![image](https://user-images.githubusercontent.com/48793689/76258763-93709980-622a-11ea-9fb5-32d7d5d7520f.png)\r\n\r\n\r\nNotice the arp table (on ghana) before and after my curl to the EXTERNAL-IP, \r\n\r\n![image](https://user-images.githubusercontent.com/48793689/76314873-f8210800-62ad-11ea-826d-4db828d57bb4.png)\r\n\r\n\r\n\r\n\r\nMy cluster nodes and their IP addresses can be seen below\r\n![image](https://user-images.githubusercontent.com/48793689/76313290-0c173a80-62ab-11ea-8a06-64d378010451.png)\r\n\r\n**I've placed additional contextual detail in the first comment below.**\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n1.17\r\n![image](https://user-images.githubusercontent.com/48793689/76318942-d414f500-62b4-11ea-925a-f1b22e195d1c.png)\r\n\r\n- Cloud provider or hardware configuration:\r\nBare Metal\r\n- OS (e.g: `cat /etc/os-release`):\r\nCentos 7\r\n- Kernel (e.g. `uname -a`):\r\n![image](https://user-images.githubusercontent.com/48793689/76318724-85fff180-62b4-11ea-9aa7-1646fa08e206.png)\r\n\r\n- Install tools:\r\n- Network plugin and version (if this is a network-related bug):\r\nFlannel\r\n- Others:\r\n\r\n/sig network\r\n/sig architecture",
  "closed_at": "2020-06-16T07:50:04Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 110,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/88986/comments",
  "created_at": "2020-03-09T21:19:51Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/88986/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/88986",
  "id": 578197782,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Network.",
      "id": 116712108,
      "name": "sig/network",
      "node_id": "MDU6TGFiZWwxMTY3MTIxMDg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/network"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/88986/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1NzgxOTc3ODI=",
  "number": 88986,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Bare Metal K8S 63 Second Service Routing Delay - when accessing service via ClusterIP, or ExternalIP",
  "updated_at": "2020-08-20T14:36:03Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/88986",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/48793689?v=4",
    "events_url": "https://api.github.com/users/davesargrad/events{/privacy}",
    "followers_url": "https://api.github.com/users/davesargrad/followers",
    "following_url": "https://api.github.com/users/davesargrad/following{/other_user}",
    "gists_url": "https://api.github.com/users/davesargrad/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/davesargrad",
    "id": 48793689,
    "login": "davesargrad",
    "node_id": "MDQ6VXNlcjQ4NzkzNjg5",
    "organizations_url": "https://api.github.com/users/davesargrad/orgs",
    "received_events_url": "https://api.github.com/users/davesargrad/received_events",
    "repos_url": "https://api.github.com/users/davesargrad/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/davesargrad/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/davesargrad/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/davesargrad"
  }
}