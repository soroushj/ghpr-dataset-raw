{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/14296719?v=4",
    "events_url": "https://api.github.com/users/MikeSpreitzer/events{/privacy}",
    "followers_url": "https://api.github.com/users/MikeSpreitzer/followers",
    "following_url": "https://api.github.com/users/MikeSpreitzer/following{/other_user}",
    "gists_url": "https://api.github.com/users/MikeSpreitzer/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/MikeSpreitzer",
    "id": 14296719,
    "login": "MikeSpreitzer",
    "node_id": "MDQ6VXNlcjE0Mjk2NzE5",
    "organizations_url": "https://api.github.com/users/MikeSpreitzer/orgs",
    "received_events_url": "https://api.github.com/users/MikeSpreitzer/received_events",
    "repos_url": "https://api.github.com/users/MikeSpreitzer/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/MikeSpreitzer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MikeSpreitzer/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/MikeSpreitzer"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/14296719?v=4",
      "events_url": "https://api.github.com/users/MikeSpreitzer/events{/privacy}",
      "followers_url": "https://api.github.com/users/MikeSpreitzer/followers",
      "following_url": "https://api.github.com/users/MikeSpreitzer/following{/other_user}",
      "gists_url": "https://api.github.com/users/MikeSpreitzer/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/MikeSpreitzer",
      "id": 14296719,
      "login": "MikeSpreitzer",
      "node_id": "MDQ6VXNlcjE0Mjk2NzE5",
      "organizations_url": "https://api.github.com/users/MikeSpreitzer/orgs",
      "received_events_url": "https://api.github.com/users/MikeSpreitzer/received_events",
      "repos_url": "https://api.github.com/users/MikeSpreitzer/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/MikeSpreitzer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MikeSpreitzer/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/MikeSpreitzer"
    }
  ],
  "author_association": "NONE",
  "body": "**What happened**:\r\nIn out archutecture we have some kinda external (out-of-cluster) Ingress Controller, based on HAProxy + self-written scripts for Kubernetes service discovery (2 instances). ~60 Kubernetes services exposed via NodePort on 8 Kubernetes nodes. Each node runs kube-proxy in iptables mode.\r\n\r\nEverything worked fine. But after cluster got more load (HTTP requests per second / concurrent connections), we are experiencing slow connects to services exposed via NodePort because of TCP retransmits.\r\n\r\nFor now have 4k RPS / 80k concurrent peak. TCP retransmits starts at ~1k RPS / 30k concurrent.\r\n\r\nBut most strange thing in this situation - retransmit count not same for haproxy/kube-node pair.\r\nFor example, haproxy1 have retransmits from kube-nodes 1,2,3 and 8, but haproxy2 have almost zero retransmits from that nodes. Instead haproxy2 have retransmits from kube-nodes 4,5,6 and 7. As you can see, it is like mirrored.\r\n\r\nSee attachments for clarification. HAProxy configured with 100ms connect timeout, so it redispatches connection on timeout.\r\n![haproxy1](https://user-images.githubusercontent.com/1713091/56274906-7ec27900-6121-11e9-848f-60cf3eb6e81a.png)\r\n![haproxy2](https://user-images.githubusercontent.com/1713091/56274907-7ec27900-6121-11e9-8b12-9d05e81cbca9.png)\r\n\r\n**What you expected to happen**:\r\nNo TCP retransmits, fast connects.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nCommit 50-60 deployments + NodePort-exposed services on few nodes. Load with 1k+ RPS, 30k+ concurrent cons. Observe slow connects (1s, 3s, 6s...)\r\n\r\n**Anything else we need to know?**:\r\nIntercluster communication via flannel w/o cni in hostgw mode.\r\n\r\nTried different sysctls on nodes and haproxies. Tried ipvs mode and got much more TCP retransmits.\r\nAlso tried with iptables 1.6.2 with latest flanneld to fix NAT bugs according to this article: https://tech.xing.com/a-reason-for-unexplained-connection-timeouts-on-kubernetes-docker-abd041cf7e02\r\n\r\nFor test installed on kube-nodes out-of-cluster reverse-proxy to pass traffic from outside to kubernetes services and pods - no problems. Also no problems with HostPort-exposed services.\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n`Client Version: version.Info{Major:\"1\", Minor:\"11\", GitVersion:\"v1.11.6\", GitCommit:\"b1d75deca493a24a2f87eb1efde1a569e52fc8d9\", GitTreeState:\"clean\", BuildDate:\"2018-12-16T04:39:52Z\", GoVersion:\"go1.10.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"11\", GitVersion:\"v1.11.6\", GitCommit:\"b1d75deca493a24a2f87eb1efde1a569e52fc8d9\", GitTreeState:\"clean\", BuildDate:\"2018-12-16T04:30:10Z\", GoVersion:\"go1.10.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}`\r\n- Cloud provider or hardware configuration:\r\nMasters: 5 x kvm VMs 16.04.6 LTS (Xenial Xerus) / 4.15.0-45-generic.\r\nNodes: Baremetall Supermicro Intel(R) Xeon(R) CPU E5-2695 / 128 Gb RAM\r\n- OS (e.g: `cat /etc/os-release`):\r\nProd nodes: `16.04.6 LTS (Xenial Xerus)`\r\nTest node: `Debian GNU/Linux 9 (stretch)`\r\n- Kernel (e.g. `uname -a`):\r\nProd nodes: `Linux hw-kube-n1.alaps.kz.prod.bash.kz 4.15.0-45-generic #48~16.04.1-Ubuntu SMP Tue Jan 29 18:03:48 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux`\r\nTest node: `Linux hw-kube-n8.--- 4.9.0-8-amd64 #1 SMP Debian 4.9.144-3.1 (2019-02-19) x86_64 GNU/Linux`\r\n- Install tools:\r\nMix of hard way / ansible.\r\n- Others:\r\nDon't know if it is kube-proxy / iptables problem or maybe I'm just missing some sysctls / kernel params.",
  "closed_at": "2019-09-03T21:34:59Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 52,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/76699/comments",
  "created_at": "2019-04-17T09:06:44Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/76699/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/76699",
  "id": 434172270,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Network.",
      "id": 116712108,
      "name": "sig/network",
      "node_id": "MDU6TGFiZWwxMTY3MTIxMDg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/network"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/76699/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": null,
    "closed_issues": 1361,
    "created_at": "2019-01-31T15:17:37Z",
    "creator": {
      "avatar_url": "https://avatars0.githubusercontent.com/u/980082?v=4",
      "events_url": "https://api.github.com/users/liggitt/events{/privacy}",
      "followers_url": "https://api.github.com/users/liggitt/followers",
      "following_url": "https://api.github.com/users/liggitt/following{/other_user}",
      "gists_url": "https://api.github.com/users/liggitt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/liggitt",
      "id": 980082,
      "login": "liggitt",
      "node_id": "MDQ6VXNlcjk4MDA4Mg==",
      "organizations_url": "https://api.github.com/users/liggitt/orgs",
      "received_events_url": "https://api.github.com/users/liggitt/received_events",
      "repos_url": "https://api.github.com/users/liggitt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/liggitt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/liggitt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/liggitt"
    },
    "description": null,
    "due_on": null,
    "html_url": "https://github.com/kubernetes/kubernetes/milestone/45",
    "id": 4018466,
    "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/45/labels",
    "node_id": "MDk6TWlsZXN0b25lNDAxODQ2Ng==",
    "number": 45,
    "open_issues": 0,
    "state": "open",
    "title": "v1.16",
    "updated_at": "2020-10-25T01:09:02Z",
    "url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/45"
  },
  "node_id": "MDU6SXNzdWU0MzQxNzIyNzA=",
  "number": 76699,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Slow connect (TCP retransmits) via NodePort",
  "updated_at": "2020-05-29T15:14:03Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/76699",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1713091?v=4",
    "events_url": "https://api.github.com/users/zigmund/events{/privacy}",
    "followers_url": "https://api.github.com/users/zigmund/followers",
    "following_url": "https://api.github.com/users/zigmund/following{/other_user}",
    "gists_url": "https://api.github.com/users/zigmund/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/zigmund",
    "id": 1713091,
    "login": "zigmund",
    "node_id": "MDQ6VXNlcjE3MTMwOTE=",
    "organizations_url": "https://api.github.com/users/zigmund/orgs",
    "received_events_url": "https://api.github.com/users/zigmund/received_events",
    "repos_url": "https://api.github.com/users/zigmund/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/zigmund/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zigmund/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/zigmund"
  }
}