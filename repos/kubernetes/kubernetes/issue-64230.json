{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "/kind bug\r\n\r\n**What happened**:\r\n\r\nWhen you create a new Service of type LoadBalancer in a Kubernetes (v1.9) cluster hosted on AWS with nodes spread across subnets in 3 AvailabilityZones, the new ELB that Kube creates is only enabled for 2 AZs. This happens even though all three subnets have the correct cluster tags, and the same list of tags other than the Name tag.\r\n\r\nI've determined that, unfortunately, the order of tags matters. If a subnet has the KubernetesCluster tag, and this tag appears in the tag list before the kubernetes.io/cluster/X tag, then only this KubernetesCluster tag will be used to decide if this subnet is a candidate for use by the cluster. For subnets that are shared between multiple clusters, and which still have old legacy tags on them in addition to newer type of tag, this means the subnet can only be used by the cluster that matches the KubernetesCluster tag. However, if a newer kubernetes.io/cluster/X tag, where X matches the cluster name, appears first in the list, then that tag is used to determine subnet candidacy. \r\n\r\n\r\n**What you expected to happen**:\r\n\r\nFor a Kubernetes (v1.9) cluster named \"X\", with nodes spread across subnets in 3 AvailabilityZones, when you create a new Service of type LoadBalancer, the new ELB that Kube creates is enabled for all 3 AZs if there is a subnet in each of those 3 AZs that contains a tag with key \"kubernetes.io/cluster/X\" and value \"shared\". Ordering of keys should not matter so long as one of the tag keys is \"kubernetes.io/cluster/X\".\r\n\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nCreate 3 (public) subnets in 3 different AZs in an AWS VPC with the following tags:\r\n\r\nKey                                                   | Value\r\n--------------------------------- | ------\r\nkubernetes.io/cluster/a.k8s.local  | shared\r\nkubernetes.io/cluster/b.k8s.local  | shared\r\nkubernetes.io/role/elb                    | 1\r\nKubernetesCluster                          | a.k8s.local\r\n\r\nHowever, in one of the 3 subnets above, ensure that KubernetesCluster tag appears first in the tag list, instead of last.\r\n\r\nSpin up a new Kube cluster named \"b.k8s.local\" (via Kops or other means) that uses the above 3 public subnets.\r\n\r\nCreate a Service of type LoadBalancer in Kube cluster b.k8s.local and notice that the resulting ELB created in AWS is only associated with 2 of the 3 subnets, and that the one which is absent is the one that had the KubernetesCluster tag appearing in the tag list before the kubernetes.io/cluster/b.k8s.local  tag.\r\n\r\n\r\n**Anything else we need to know?**:\r\n\r\nThis happens because the hasClusterTag function in cloudprovider/providers/aws/tags.go checks to see if a tag in the list has legacy key value before checking for the newer key value.\r\n\r\nI believe that If a subnet has any tags with key matching \"kubernetes.io/cluster/*\" then these tags should take precedence over the \"KubernetesCluster\" tag. I will make a pull request to enable this behavior.\r\n\r\nIf the intention is that  KubernetesCluster tag should take precedence, then this is still a bug, because this tag will currently only take precedence if it appears before a matching \"kubernetes.io/cluster/*\" tag in the tag list.\r\n\r\n\r\n**Environment**:\r\n- Kubernetes version: 1.9\r\n- Cloud provider or hardware configuration: AWS",
  "closed_at": "2018-05-25T16:01:01Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/64230/comments",
  "created_at": "2018-05-23T20:46:50Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/64230/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/64230",
  "id": 325867232,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/64230/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMjU4NjcyMzI=",
  "number": 64230,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "AWS subnet will not be used for new ELB if legacy KubernetesCluster tag appears before new kubernetes.io/cluster tag",
  "updated_at": "2018-05-25T16:01:01Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/64230",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/3289285?v=4",
    "events_url": "https://api.github.com/users/twilfong/events{/privacy}",
    "followers_url": "https://api.github.com/users/twilfong/followers",
    "following_url": "https://api.github.com/users/twilfong/following{/other_user}",
    "gists_url": "https://api.github.com/users/twilfong/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/twilfong",
    "id": 3289285,
    "login": "twilfong",
    "node_id": "MDQ6VXNlcjMyODkyODU=",
    "organizations_url": "https://api.github.com/users/twilfong/orgs",
    "received_events_url": "https://api.github.com/users/twilfong/received_events",
    "repos_url": "https://api.github.com/users/twilfong/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/twilfong/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/twilfong/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/twilfong"
  }
}