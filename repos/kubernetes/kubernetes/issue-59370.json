{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "**Is this a BUG REPORT or FEATURE REQUEST?**:\r\n/kind feature\r\n/sig node\r\n/area hw-accelerators\r\n/cc @vishh @jiayingz @vikaschoudhary16 \r\n\r\n**What happened**:\r\nAt the moment device plugin Allocate call is called once for each container at Pod admition time.\r\nAs we introduce the Initialize call, this behavior is no longer needed.\r\nThis behavior also leads to weird API semantics and makes it really hard for the device plugin to track what device is Allocated and what device isn't (related: [Deallocate](https://github.com/kubernetes/kubernetes/issues/59110), [Partial allocation failures](https://github.com/kubernetes/kubernetes/issues/56307)).\r\n\r\n**What you expected to happen**:\r\nWe could change the lifecycle of this call to a single call at Pod admition time that would gather all the needed runtime setup requirements.\r\n\r\nIt is also a good foundation for integrating the [NUMA manager](https://github.com/kubernetes/community/pull/1680) with the device plugin API as well as passing [additional information to the device plugin](https://github.com/kubernetes/kubernetes/issues/59109) depending on what agreement we arrive at.\r\n\r\nIn general it makes the lifecycle model cleaner as we have one call at pod admission (`PodAdmit`?) and one call before each container start (`InitializeContainer`?).\r\n\r\nIt will also pave the way for a better sharing API as the device plugin will have a better view of what is being shared at the pod level (eg: NICs) rather than try to guess what device gets shared at the container level (though this might not apply for all devices, e.g: GPUs).\r\n\r\nThe gRPC API might look like the following:\r\n```protobuf\r\n// AdmitPodRequest is a call issued by the kubelet during pod admission\r\n// TODO this message should be used by the CPU manager\r\n// TODO the first two fields might be a good answer for  issue #59109\r\nmessage AdmitPodRequest {\r\n        // Name of the pod\r\n        string podname = 1;\r\n\r\n        // Annotations on the pod\r\n        map<string, string> annotations = 2;\r\n\r\n        // list of InitContainers with the assigned devices\r\n        repeated Container init_containers = 3;\r\n\r\n        // list of Containers with the assigned devices\r\n        repeated Container containers = 4;\r\n}\r\n\r\nmessage AdmitPodResponse {\r\n        // map<containerName, containerRuntimeSpec>\r\n        map<string, RuntimeSpec> specs = 1;\r\n}\r\n\r\nmessage Container {\r\n        // The name of the Container\r\n        string name = 1;\r\n        // The device assigned to that container\r\n        repeated string devices = 2;\r\n}\r\n\r\nmessage RuntimeSpec {\r\n        // List of environment variable to be set in the container to access one of more devices.\r\n\tmap<string, string> envs = 1;\r\n\t// Mounts for the container.\r\n\trepeated Mount mounts = 2;\r\n\t// Devices for the container.\r\n\trepeated DeviceSpec devices = 3;\r\n}\r\n```\r\n",
  "closed_at": "2018-02-25T05:19:33Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 11,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59370/comments",
  "created_at": "2018-02-05T21:24:30Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59370/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/59370",
  "id": 294547192,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 644163893,
      "name": "area/hw-accelerators",
      "node_id": "MDU6TGFiZWw2NDQxNjM4OTM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/hw-accelerators"
    },
    {
      "color": "c7def8",
      "default": false,
      "description": "Categorizes issue or PR as related to a new feature.",
      "id": 267761362,
      "name": "kind/feature",
      "node_id": "MDU6TGFiZWwyNjc3NjEzNjI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/feature"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Node.",
      "id": 173493665,
      "name": "sig/node",
      "node_id": "MDU6TGFiZWwxNzM0OTM2NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/node"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59370/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyOTQ1NDcxOTI=",
  "number": 59370,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "[DevicePlugin] Change the multiple Allocate call to a single Pod Admit call",
  "updated_at": "2018-02-25T05:19:33Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59370",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/2519571?v=4",
    "events_url": "https://api.github.com/users/RenaudWasTaken/events{/privacy}",
    "followers_url": "https://api.github.com/users/RenaudWasTaken/followers",
    "following_url": "https://api.github.com/users/RenaudWasTaken/following{/other_user}",
    "gists_url": "https://api.github.com/users/RenaudWasTaken/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/RenaudWasTaken",
    "id": 2519571,
    "login": "RenaudWasTaken",
    "node_id": "MDQ6VXNlcjI1MTk1NzE=",
    "organizations_url": "https://api.github.com/users/RenaudWasTaken/orgs",
    "received_events_url": "https://api.github.com/users/RenaudWasTaken/received_events",
    "repos_url": "https://api.github.com/users/RenaudWasTaken/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/RenaudWasTaken/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/RenaudWasTaken/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/RenaudWasTaken"
  }
}