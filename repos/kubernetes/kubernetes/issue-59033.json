{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "/kind bug\r\n\r\n**What happened**:\r\n1. A server pod exposes UDP host port.\r\n2. A client sends packets to the server pod thru the host port. This creates a conntrack entry.\r\n3. The server pod's IP changs due to whatever reason, such as pod gets recreated.\r\n4. Due to the nature of UDP and conntrack, new request from the same client to the host port will keep hitting the stale conntrack entry.\r\n5. Client observes traffic black hole.\r\n\r\n**What you expected to happen**:\r\nAfter recreation of the server pod (with the same host port), UDP packets reach the new server pod.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n```yaml\r\napiVersion: extensions/v1beta1\r\nkind: DaemonSet\r\nmetadata:\r\n  name: test-udp-server\r\n  namespace: default\r\nspec:\r\n  updateStrategy:\r\n    type: RollingUpdate\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: test-udp-server\r\n      name: test-udp-server\r\n    spec:\r\n      hostNetwork: true\r\n      containers:\r\n      - image: SEE_DOCKERFILE\r\n        name: test-udp-server\r\n        ports:\r\n          - name: udp\r\n            containerPort: 8125\r\n            hostPort: 8125\r\n            protocol: UDP\r\n        env:\r\n        - name: HOST\r\n          valueFrom:\r\n            fieldRef:\r\n              fieldPath: spec.nodeName\r\n        - name: REVISION\r\n          value: \"R1\"\r\n        command:\r\n        - \"bash\"\r\n        - \"-c\"\r\n        - |\r\n          set -x\r\n          socat - UDP4-RECVFROM:8125,fork\r\n        livenessProbe:\r\n          exec:\r\n            command:\r\n            - \"bash\"\r\n            - \"-c\"\r\n            - |\r\n              echo \"Liveness probe: $(date)\" | socat - UDP4-DATAGRAM:$(hostname -i):8125\r\n          initialDelaySeconds: 60\r\n          periodSeconds: 60\r\n```\r\n\r\n```yaml\r\napiVersion: extensions/v1beta1\r\nkind: Deployment\r\nmetadata:\r\n  name: test-udp-client\r\n  namespace: default\r\nspec:\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: test-udp-client\r\n    spec:\r\n      containers:\r\n      - image: SEE_DOCKERFILE\r\n        name: test-udp-client\r\n        env:\r\n        - name: HOST\r\n          valueFrom:\r\n            fieldRef:\r\n              fieldPath: spec.nodeName\r\n        command:\r\n        - \"bash\"\r\n        - \"-c\"\r\n        - |\r\n          set -x\r\n          socat - UDP4-DATAGRAM:$HOST:8125 < <(while true ; do echo \"From $(hostname): $(date)\"; sleep 1 ; done)\r\n```\r\n\r\n```\r\nFROM debian:stretch\r\n\r\nRUN apt-get -y update\r\nRUN apt-get -y --no-upgrade install socat tcpdump\r\n```\r\n\r\n1. Create the above daemonset and deployment.\r\n2. kubectl attach to the daemon pod on the same node as the client, see output\r\n3. change revision in daemonset, kubectl apply it.\r\n4. kubectl attach again, see no output.\r\n\r\n**Environment**: GKE 1.8.x\r\n\r\n\r\n",
  "closed_at": "2019-05-07T07:43:44Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 14,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59033/comments",
  "created_at": "2018-01-30T09:24:17Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59033/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/59033",
  "id": 292708020,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "604460",
      "default": false,
      "description": "Denotes an issue or PR that has aged beyond stale and will be auto-closed.",
      "id": 778118402,
      "name": "lifecycle/rotten",
      "node_id": "MDU6TGFiZWw3NzgxMTg0MDI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/lifecycle/rotten"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Network.",
      "id": 116712108,
      "name": "sig/network",
      "node_id": "MDU6TGFiZWwxMTY3MTIxMDg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/network"
    },
    {
      "color": "d455d0",
      "default": false,
      "description": "Indicates an issue that can not or will not be resolved.",
      "id": 862108765,
      "name": "triage/unresolved",
      "node_id": "MDU6TGFiZWw4NjIxMDg3NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/triage/unresolved"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59033/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyOTI3MDgwMjA=",
  "number": 59033,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "conntrack table for UDP to vanished pod not flushed",
  "updated_at": "2019-05-07T07:43:45Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/59033",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/94641?v=4",
    "events_url": "https://api.github.com/users/thkoch2001/events{/privacy}",
    "followers_url": "https://api.github.com/users/thkoch2001/followers",
    "following_url": "https://api.github.com/users/thkoch2001/following{/other_user}",
    "gists_url": "https://api.github.com/users/thkoch2001/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/thkoch2001",
    "id": 94641,
    "login": "thkoch2001",
    "node_id": "MDQ6VXNlcjk0NjQx",
    "organizations_url": "https://api.github.com/users/thkoch2001/orgs",
    "received_events_url": "https://api.github.com/users/thkoch2001/received_events",
    "repos_url": "https://api.github.com/users/thkoch2001/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/thkoch2001/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thkoch2001/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/thkoch2001"
  }
}