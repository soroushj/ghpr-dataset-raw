{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "I have been deploying master-branch kubernetes on Windows using flannel/host-gateway networking, with one master, one linux worker, and three windows worker. Recently, kube-proxy stopped running correctly. It exits with an error about not finding the HNS Network. I have confirmed that the HNS network exists on the host with the correct name (cbr0), and have identified the last commit where kube-proxy works.\r\n\r\n**What happened**:\r\nStarting with the commit merging [this PR](https://github.com/kubernetes/kubernetes/pull/70896), kube-proxy outputs the following error message:\r\n```\r\nI0222 21:08:21.264089    6576 flags.go:33] FLAG: --alsologtostderr=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --bind-address=\"0.0.0.0\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --cleanup=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --cleanup-iptables=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --cleanup-ipvs=\"true\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --cluster-cidr=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --config=\"/var/vcap/jobs/kube-proxy-windows/config/config.yml\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --config-sync-period=\"15m0s\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --conntrack-max=\"0\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --conntrack-max-per-core=\"32768\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --conntrack-min=\"131072\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --conntrack-tcp-timeout-close-wait=\"1h0m0s\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --conntrack-tcp-timeout-established=\"24h0m0s\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --enable-dsr=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --feature-gates=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --healthz-bind-address=\"0.0.0.0:10256\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --healthz-port=\"10256\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --help=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --hostname-override=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --iptables-masquerade-bit=\"14\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --iptables-min-sync-period=\"0s\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --iptables-sync-period=\"30s\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --ipvs-exclude-cidrs=\"[]\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --ipvs-min-sync-period=\"0s\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --ipvs-scheduler=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --ipvs-sync-period=\"30s\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --kube-api-burst=\"10\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --kube-api-content-type=\"application/vnd.kubernetes.protobuf\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --kube-api-qps=\"5\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --kubeconfig=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --log-backtrace-at=\":0\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --log-dir=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --log-file=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --log-flush-frequency=\"5s\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --logtostderr=\"true\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --masquerade-all=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --master=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --metrics-bind-address=\"127.0.0.1:10249\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --metrics-port=\"10249\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --network-name=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --nodeport-addresses=\"[]\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --oom-score-adj=\"-999\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --profiling=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --proxy-mode=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --proxy-port-range=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --resource-container=\"/kube-proxy\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --skip-headers=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --source-vip=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --stderrthreshold=\"2\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --udp-timeout=\"250ms\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --v=\"5\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --version=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --vmodule=\"\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --windows-service=\"false\"\r\nI0222 21:08:21.303135    6576 flags.go:33] FLAG: --write-config-to=\"\"\r\nI0222 21:08:21.304146    6576 feature_gate.go:226] feature gates: &{map[]}\r\nI0222 21:08:21.323134    6576 server_windows.go:102] Using Kernelspace Proxier.\r\nI0222 21:08:21.340304    6576 proxier.go:522] network-name flag not set. Checking environment variable\r\nE0222 21:08:21.341313    6576 hnsV2.go:36] Network Id  not found\r\nE0222 21:08:21.341313    6576 proxier.go:531] Unable to find Hns Network specified by cbr0. Please check environment variable KUBE_NETWORK or network-name flag\r\nF0222 21:08:21.341313    6576 server.go:468] unable to create proxier: Network Id  not found\r\n```\r\n\r\nThis is confusing because `Get-HNSNetwork` does show `cbr0`:\r\n```\r\nPS C:\\Users\\Administrator> Get-HnsNetwork\r\nActivityId             : 8197AF39-D29B-4E39-AB09-FDD4D72CBA6B\r\nAdditionalParams       :\r\nCurrentEndpointCount   : 1\r\nExtensions             : {@{Id=E7C3B2F0-F3C5-48DF-AF2B-10FED6D72E7A; IsEnabled=False; Name=Microsoft Windows Filtering\r\n                         Platform}, @{Id=E9B59CFA-2BE1-4B21-828F-B6FBDBDDC017; IsEnabled=True; Name=Microsoft Azure\r\n                         VFP Switch Extension}, @{Id=EA24CD6C-D17A-4348-9190-09F0D5BE83DD; IsEnabled=True;\r\n                         Name=Microsoft NDIS Capture}}\r\nHealth                 : @{LastErrorCode=0; LastUpdateTime=131953393498275344}\r\nID                     : 4D6C548A-BC49-49E6-B65A-519F91A56BE5\r\nIPv6                   : False\r\nLayeredOn              : 0622A746-AAB3-419A-8AD9-61AF87042371\r\nMacPools               : {@{EndMacAddress=00-15-5D-B0-DF-FF; StartMacAddress=00-15-5D-B0-D0-00}}\r\nManagementIP           : 10.74.41.151\r\nMaxConcurrentEndpoints : 1\r\nName                   : cbr0\r\nPolicies               : {}\r\nResources              : @{AdditionalParams=; AllocationOrder=0; Health=; ID=8197AF39-D29B-4E39-AB09-FDD4D72CBA6B;\r\n                         PortOperationTime=0; State=1; SwitchOperationTime=0; VfpOperationTime=0;\r\n                         parentId=E3BD9CD2-1522-4596-9FB5-082E0DCC214A}\r\nState                  : 1\r\nSubnets                : {@{AdditionalParams=; AddressPrefix=10.200.83.0/24; GatewayAddress=10.200.83.1; Health=;\r\n                         ID=6622E2D9-E679-43DB-A49D-04A8997FFC45; ObjectType=5; Policies=System.Object[]; State=0}}\r\nTotalEndpoints         : 2\r\nType                   : L2Bridge\r\nVersion                : 38654705665\r\n```\r\n(nat network removed from above output)\r\n\r\n**What you expected to happen**:\r\nkube-proxy to work in host-gateway mode.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nBuild kubernetes at or after [this commit](https://github.com/kubernetes/kubernetes/commit/c06ca11b5dc637fe3df3fb2b50a1980e1237654c).\r\nStart flanneld, kubelet, and kube-proxy on a windows 2019 vm. See kube-proxy fail despite flanneld having created the `cbr0` network.\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): kube-proxy breaks on commit c06ca11b5dc637fe3df3fb2b50a1980e1237654c and later; works on 23a085062c9dc531ec601210c69d65e25e43e6aa\r\n- Cloud provider or hardware configuration: vsphere\r\n- OS (e.g: `cat /etc/os-release`): windows server 2019, with up-to-date patches\r\n- Kernel (e.g. `uname -a`): windows nodes are `10.0.17763.316`, linux master/worker are `4.15.0-43-generic`\r\n- Install tools: deployed using [CFCR](https://github.com/cloudfoundry-incubator/kubo-release) \r\n\r\n\r\n/sig windows\r\ncc @ksubrmnn",
  "closed_at": "2019-02-23T03:19:38Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/74435/comments",
  "created_at": "2019-02-22T21:10:59Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/74435/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/74435",
  "id": 413580627,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Windows.",
      "id": 422106010,
      "name": "sig/windows",
      "node_id": "MDU6TGFiZWw0MjIxMDYwMTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/windows"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/74435/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MTM1ODA2Mjc=",
  "number": 74435,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kube-proxy on windows failing after recent networking change",
  "updated_at": "2019-02-23T03:19:38Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/74435",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1205394?v=4",
    "events_url": "https://api.github.com/users/astrieanna/events{/privacy}",
    "followers_url": "https://api.github.com/users/astrieanna/followers",
    "following_url": "https://api.github.com/users/astrieanna/following{/other_user}",
    "gists_url": "https://api.github.com/users/astrieanna/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/astrieanna",
    "id": 1205394,
    "login": "astrieanna",
    "node_id": "MDQ6VXNlcjEyMDUzOTQ=",
    "organizations_url": "https://api.github.com/users/astrieanna/orgs",
    "received_events_url": "https://api.github.com/users/astrieanna/received_events",
    "repos_url": "https://api.github.com/users/astrieanna/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/astrieanna/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/astrieanna/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/astrieanna"
  }
}