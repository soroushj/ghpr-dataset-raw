{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\nFor each NLB created, K8s creates an ingress rule on the node group's security group for each port exposed for each CIDR attached to the VPC to allow health checks to succeed.\r\n\r\nAWS limits the number of rules per security group to 60 by default. This quota is adjustable but multiplied by the quota for security groups per network interface cannot exceed 1000.\r\nhttps://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html#vpc-limits-security-groups\r\n\r\nI have a VPC with 16 CIDR blocks attached to it and a quota for rules per security group set to 80. Each NLB created adds 18 new rules (16 for Health Check, 1 for Client, and 1 for MTU) to the node group's security groups. This high number of unnecessary rules created makes it impossible to create more than 4 NLBs per node group (if each one has a single port exposed).\r\n\r\n**What you expected to happen**:\r\nFor the health check to succeed, the NLB must be able to ping the node port for the service on the cluster's node group. So the node group's security group just needs an inbound rule for each ENI of the NLB, making the number of rules necessary on the cluster's node group directly proportional to the number of AZs the NLB is configured.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n- Create a VPC on AWS with 8 CIDRs attached to it;\r\n- Create a K8s Cluster;\r\n- Create a Network Load Balancer with 6 ports exposed;\r\n- If the default quota of rules per security group has not been changed, the NLB creation will fail with RulesPerSecurityGroupLimitExceeded.\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"18\", GitVersion:\"v1.18.4\", GitCommit:\"c96aede7b5205121079932896c4ad89bb93260af\", GitTreeState:\"clean\", BuildDate:\"2020-06-18T02:59:13Z\", GoVersion:\"go1.14.3\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"16+\", GitVersion:\"v1.16.8-eks-fd1ea7\", GitCommit:\"fd1ea7c64d0e3ccbf04b124431c659f65330562a\", GitTreeState:\"clean\", BuildDate:\"2020-05-28T19:06:00Z\", GoVersion:\"go1.13.8\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n- Cloud provider or hardware configuration:\r\n- OS (e.g: `cat /etc/os-release`):\r\n```\r\nNAME=\"Amazon Linux\"\r\nVERSION=\"2\"\r\nID=\"amzn\"\r\nID_LIKE=\"centos rhel fedora\"\r\nVERSION_ID=\"2\"\r\nPRETTY_NAME=\"Amazon Linux 2\"\r\nANSI_COLOR=\"0;33\"\r\nCPE_NAME=\"cpe:2.3:o:amazon:amazon_linux:2\"\r\nHOME_URL=\"https://amazonlinux.com/\"\r\n```\r\n- Kernel (e.g. `uname -a`):\r\n```\r\nLinux ip-10-8-8-4.ec2.internal 4.14.186-146.268.amzn2.x86_64 #1 SMP Tue Jul 14 18:16:52 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n- Install tools:\r\n- Network plugin and version (if this is a network-related bug):\r\n- Others:",
  "closed_at": "2020-08-31T03:32:24Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93514/comments",
  "created_at": "2020-07-28T23:19:49Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93514/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/93514",
  "id": 667441243,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Issues or PRs related to aws provider",
      "id": 852130657,
      "name": "area/provider/aws",
      "node_id": "MDU6TGFiZWw4NTIxMzA2NTc=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/provider/aws"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Cloud Provider.",
      "id": 958178286,
      "name": "sig/cloud-provider",
      "node_id": "MDU6TGFiZWw5NTgxNzgyODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cloud-provider"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93514/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2Njc0NDEyNDM=",
  "number": 93514,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "K8s creates too many Security Groups for NLB Health Check",
  "updated_at": "2020-08-31T03:32:24Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93514",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/7753096?v=4",
    "events_url": "https://api.github.com/users/t0rr3sp3dr0/events{/privacy}",
    "followers_url": "https://api.github.com/users/t0rr3sp3dr0/followers",
    "following_url": "https://api.github.com/users/t0rr3sp3dr0/following{/other_user}",
    "gists_url": "https://api.github.com/users/t0rr3sp3dr0/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/t0rr3sp3dr0",
    "id": 7753096,
    "login": "t0rr3sp3dr0",
    "node_id": "MDQ6VXNlcjc3NTMwOTY=",
    "organizations_url": "https://api.github.com/users/t0rr3sp3dr0/orgs",
    "received_events_url": "https://api.github.com/users/t0rr3sp3dr0/received_events",
    "repos_url": "https://api.github.com/users/t0rr3sp3dr0/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/t0rr3sp3dr0/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/t0rr3sp3dr0/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/t0rr3sp3dr0"
  }
}