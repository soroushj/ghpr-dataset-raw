{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/30171?v=4",
    "events_url": "https://api.github.com/users/dougm/events{/privacy}",
    "followers_url": "https://api.github.com/users/dougm/followers",
    "following_url": "https://api.github.com/users/dougm/following{/other_user}",
    "gists_url": "https://api.github.com/users/dougm/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/dougm",
    "id": 30171,
    "login": "dougm",
    "node_id": "MDQ6VXNlcjMwMTcx",
    "organizations_url": "https://api.github.com/users/dougm/orgs",
    "received_events_url": "https://api.github.com/users/dougm/received_events",
    "repos_url": "https://api.github.com/users/dougm/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/dougm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dougm/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/dougm"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/30171?v=4",
      "events_url": "https://api.github.com/users/dougm/events{/privacy}",
      "followers_url": "https://api.github.com/users/dougm/followers",
      "following_url": "https://api.github.com/users/dougm/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougm/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/dougm",
      "id": 30171,
      "login": "dougm",
      "node_id": "MDQ6VXNlcjMwMTcx",
      "organizations_url": "https://api.github.com/users/dougm/orgs",
      "received_events_url": "https://api.github.com/users/dougm/received_events",
      "repos_url": "https://api.github.com/users/dougm/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/dougm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougm/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/dougm"
    }
  ],
  "author_association": "NONE",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\n\r\nThe vSphere cloud provider is unable to fetch the node failure domain labels when using VCP with SAML auth because of an authentication failure.  For context, the SAML token auth is described here - https://vmware.github.io/vsphere-storage-for-kubernetes/documentation/saml-token-authentication.html.  SAML auth support for the zones api was introduced in this PR - https://github.com/kubernetes/kubernetes/pull/75515, which was cherry-picked to 1.14.1 here - https://github.com/kubernetes/kubernetes/pull/75742\r\n\r\nI've tested the credentials I'm using with govc to ensure that I'm able to get a token:\r\n```\r\n$token = govc session.login -l -u vcdo -cert keys\\public.crt -key keys\\private.key -issue -debug\r\n```\r\nThe credentials also work fine when using VCP without the node labels feature. \r\n\r\nRelevant kubelet logs: \r\n```\r\nI0502 14:31:45.856013    5908 generic.go:189] GenericPLEG: Relisting\r\nI0502 14:31:46.775592    5908 connection.go:142] SessionManager.LoginByToken with certificate\r\nI0502 14:31:46.858589    5908 generic.go:189] GenericPLEG: Relisting\r\nI0502 14:31:46.916706    5908 connection.go:209] New session ID for 'VSPHERE.LOCAL\\k8s-vcp-dolap' = 52109852-8b67-9901-c095-6f21d8210c03\r\nI0502 14:31:47.162687    5908 datacenter.go:99] VirtualMachine:vm-82 host is HostSystem:host-65\r\nI0502 14:31:47.833807    5908 config.go:100] Looking for [api], have seen map[api:{}]\r\nI0502 14:31:47.833807    5908 kubelet.go:1972] SyncLoop (housekeeping)\r\nI0502 14:31:47.859584    5908 generic.go:189] GenericPLEG: Relisting\r\nI0502 14:31:48.693024    5908 cni.go:182] Using CNI configuration file C:\\k\\cni\\config\\cni.conf\r\nI0502 14:31:48.853838    5908 kubelet.go:2167] Container runtime status: Runtime Conditions: RuntimeReady=true reason: message:, NetworkReady=true reason: message:\r\nI0502 14:31:48.860848    5908 generic.go:189] GenericPLEG: Relisting\r\nI0502 14:31:49.833687    5908 config.go:100] Looking for [api], have seen map[api:{}]\r\nI0502 14:31:49.833687    5908 kubelet.go:1972] SyncLoop (housekeeping)\r\nI0502 14:31:49.863597    5908 generic.go:189] GenericPLEG: Relisting\r\nE0502 14:31:49.992408    5908 vsphere.go:1538] Get zone for node ul-win-node-5k: POST https://vcdo.production.com:443/rest/com/vmware/cis/session: 401 Unauthorized\r\nE0502 14:31:49.992408    5908 kubelet_node_status.go:68] Unable to construct v1.Node object for kubelet: failed to get zone from cloud provider: POST https://vcdo.production.com:443/rest/com/vmware/cis/session: 401 Unauthorized\r\nI0502 14:31:50.194250    5908 kubelet_node_status.go:283] Setting node annotation to enable volume controller attach/detach\r\nI0502 14:31:50.453104    5908 datacenter.go:99] VirtualMachine:vm-82 host is HostSystem:host-65\r\n```\r\n\r\n**What you expected to happen**:\r\nVCP should add failure domain labels to the node object.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nSetup SAML auth for VCP with zone labeling enabled. \r\n\r\n**Anything else we need to know?**:\r\nThere was a previous issue that was raised (https://github.com/kubernetes/kubernetes/issues/75511) but that was before SAML auth support for zones was implemented.  \r\n\r\nThis could potentially be an issue with govc handling of SAML tokens since even with the Administrator role assigned to the user, I'm still unable to list tags.\r\n```\r\n> $ENV:GOVC_LOGIN_TOKEN = govc session.login -l -u vcdo -cert keys\\public.crt -key keys\\private.key -issue\r\n> govc tags.attached.ls -json -r /uunet\r\nC:\\Users\\rhockenbury\\Tools\\govc.exe: POST https://vcdo/rest/com/vmware/cis/session: 401 Unauthorized\r\n```\r\n\r\nThe role and keys were generated with the following:\r\n```\r\n $manageK8sVms= @(\"Resource.AssignVMToPool\",\"VirtualMachine.Config.AddExistingDisk\",\"VirtualMachine.Config.AddNewDisk\",\"VirtualMachine.Config.AddRemoveDevice\",\"VirtualMachine.Config.RemoveDisk\",\"VirtualMachine.Inventory.Create\",\"VirtualMachine.Inventory.Delete\",\"VirtualMachine.Config.Settings\",\"DataStore.AllocateSpace\",\"DataStore.FileManagement\",\"StorageProfile.View\",\"System.Read\",\"System.Anonymous\",\"System.view\")\r\nNew-ViRole -name \"manage-k8s-devops-lab\" -privilege (Get-ViPrivilege -id $manageK8sVms)\r\nset-ViRole -role \"manage-k8s-devops-lab\" -AddPrivilege (Get-VIPrivilege -id $manageK8sVms)\r\n\r\nopenssl req -newkey rsa:2048 -x509 -days 365 -nodes -keyout k8s-vcp-dolab.key -out k8s-vcp-dolab.crt -subj \"/C=US/ST=CA/L=SF/O=VMware/OU=CNA/CN=www.vmware.com\"\r\n\r\n/usr/lib/vmware-vmafd/bin/dir-cli service create --name k8s-vcp-dolap --cert k8s-vcp-dolab.crt \r\n```\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n1.14.1\r\n- Cloud provider or hardware configuration:\r\nvSphere\r\n- OS (e.g: `cat /etc/os-release`):\r\nLinux & Windows\r\n",
  "closed_at": "2019-05-29T07:52:50Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 17,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/77360/comments",
  "created_at": "2019-05-02T19:26:04Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/77360/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/77360",
  "id": 439749528,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Issues or PRs related to vmware provider",
      "id": 874113778,
      "name": "area/provider/vmware",
      "node_id": "MDU6TGFiZWw4NzQxMTM3Nzg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/provider/vmware"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/77360/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0Mzk3NDk1Mjg=",
  "number": 77360,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "SAML auth with vSphere and zones API not working",
  "updated_at": "2019-06-10T23:23:24Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/77360",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/4368090?v=4",
    "events_url": "https://api.github.com/users/rhockenbury/events{/privacy}",
    "followers_url": "https://api.github.com/users/rhockenbury/followers",
    "following_url": "https://api.github.com/users/rhockenbury/following{/other_user}",
    "gists_url": "https://api.github.com/users/rhockenbury/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rhockenbury",
    "id": 4368090,
    "login": "rhockenbury",
    "node_id": "MDQ6VXNlcjQzNjgwOTA=",
    "organizations_url": "https://api.github.com/users/rhockenbury/orgs",
    "received_events_url": "https://api.github.com/users/rhockenbury/received_events",
    "repos_url": "https://api.github.com/users/rhockenbury/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rhockenbury/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rhockenbury/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rhockenbury"
  }
}