{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "The test `Validate OOM score adjustments once the node is setup pod infra containers oom-score-adj should be -998 and best effort container's should be 1000` is failing in `kubelet-cri-serial-gce-e2e`.\r\n* https://k8s-gubernator.appspot.com/build/kubernetes-jenkins/logs/ci-kubernetes-node-kubelet-cri-serial/12\r\n* https://k8s-gubernator.appspot.com/build/kubernetes-jenkins/logs/ci-kubernetes-node-kubelet-cri-serial/10\r\n* https://k8s-gubernator.appspot.com/build/kubernetes-jenkins/logs/ci-kubernetes-node-kubelet-cri-serial/4\r\n\r\nThe reason is that the test expects that all pause containers (`pidof pause`) should have `oom_score_adj=-998`. However, in many tests, we are starting test containers with `pause`. Those pause containers have `oom_score_adj=1000`.\r\n\r\nIdeally, containers started in previous test should be cleaned up, so in serial suite it should not affect later test. However, it is not always true when CRI is enabled.\r\n\r\nFor example, in the oom message, we could see:\r\n```\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [ pid ]   uid  tgid total_vm      rss nr_ptes nr_pmds swapents oom_score_adj name\r\n\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [ 9190]     0  9190      257        1       4       2        0          1000 pause\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [16567]     0 16567      257        1       4       2        0          1000 pause\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [16588]     0 16588      257        1       4       2        0          -998 pause\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [23573]     0 23573      257        1       3       2        0          -998 pause\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24467]     0 24467   997933     9819     487       8        0          -999 docker\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24482]     0 24482   104791      897      28       5        0          -999 containerd\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24717]     0 24717    48267       85      16       5        0          -999 containerd-shim\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24733]     0 24733      257        1       4       2        0          -998 pause\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24768]     0 24768    48267       85      16       5        0          -999 containerd-shim\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24783]     0 24783    20771    19149      44       5        0          -998 stress\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24794]     0 24794    48267       84      16       5        0          -999 containerd-shim\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24811]     0 24811      257        1       4       2        0          -998 pause\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24843]     0 24843    48267       84      16       5        0          -999 containerd-shim\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24857]     0 24857   328358   324704     641       6        0           973 stress\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24868]     0 24868    48267       85      16       5        0          -999 containerd-shim\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24883]     0 24883      257        1       4       2        0          -998 pause\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24915]     0 24915    48267       84      16       5        0          -999 containerd-shim\r\nNov 26 03:36:19 tmp-node-e2e-36829672-gci-dev-56-8977-0-0 kernel: [24930]     0 24930   325187   323575     638       6        0          1000 stress\r\n```\r\n\r\nThere are 2 problems here:\r\n1. **Why are containers not properly cleaned up when CRI enabled?** I can't even find which test leaked pause container from the log, because there are many test using pause image, and some of them start a lot of containers, such as density test, restart test.\r\n2. **The oom score adj test should not rely on process name `pause`**. However, I can't find an alternative for now, because we don't report pause container status in our api, we don't even know the container id to inspect with docker or CRI.\r\n\r\n@yujuhong @vishh \r\n/cc @kubernetes/sig-node ",
  "closed_at": "2017-04-04T03:20:53Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37580/comments",
  "created_at": "2016-11-28T22:02:03Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37580/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/37580",
  "id": 192129179,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 116719829,
      "name": "area/kubelet",
      "node_id": "MDU6TGFiZWwxMTY3MTk4Mjk=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/kubelet"
    },
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 105152717,
      "name": "area/test",
      "node_id": "MDU6TGFiZWwxMDUxNTI3MTc=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/test"
    },
    {
      "color": "006b75",
      "default": true,
      "description": "Denotes an issue that needs help from a contributor. Must meet \"help wanted\" guidelines.",
      "id": 433686790,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw0MzM2ODY3OTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/help%20wanted"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Node.",
      "id": 173493665,
      "name": "sig/node",
      "node_id": "MDU6TGFiZWwxNzM0OTM2NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/node"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37580/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxOTIxMjkxNzk=",
  "number": 37580,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Improve the test: Validate OOM score adjustments once the node is setup pod infra containers oom-score-adj should be -998 and best effort container's should be 1000",
  "updated_at": "2017-04-04T03:20:53Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/37580",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/5821883?v=4",
    "events_url": "https://api.github.com/users/Random-Liu/events{/privacy}",
    "followers_url": "https://api.github.com/users/Random-Liu/followers",
    "following_url": "https://api.github.com/users/Random-Liu/following{/other_user}",
    "gists_url": "https://api.github.com/users/Random-Liu/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/Random-Liu",
    "id": 5821883,
    "login": "Random-Liu",
    "node_id": "MDQ6VXNlcjU4MjE4ODM=",
    "organizations_url": "https://api.github.com/users/Random-Liu/orgs",
    "received_events_url": "https://api.github.com/users/Random-Liu/received_events",
    "repos_url": "https://api.github.com/users/Random-Liu/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/Random-Liu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Random-Liu/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/Random-Liu"
  }
}