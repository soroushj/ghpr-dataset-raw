{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**Is this a BUG REPORT or FEATURE REQUEST?**:\r\n\r\n> Uncomment only one, leave it on its own line: \r\n>\r\n/kind bug\r\n> /kind feature\r\n\r\n\r\n**What happened**:\r\n\r\nWhen I update the kubelet on a node from 1.7.x to 1.8.0, pods on that node stop being able to connect to services whose pods happen to be on the same node. I use the Kubenet network plugin.\r\n\r\n**What you expected to happen**:\r\n\r\nPods should be able to connect to a service even if the services's pods are on the same node.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n1. Start a cluster\r\n2. Add the DNS addon\r\n3. Add another pod that runs on the same node as one of the DNS pods\r\n4. DNS resolution starts to fail when the service redirects the requests to the pod that is on the same node.\r\n\r\n**Anything else we need to know?**:\r\n\r\nI have some packet captures that I can show.\r\n\r\nKubelet: 1.7.5\r\nDNS pod: 10.2.4.76\r\nOrigin pod: 10.2.4.64\r\n```\r\nCapturing on 'any'\r\n  1 0.000000000    10.2.4.64 ? 10.3.0.10    TCP 76 32880 ? 53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=3087861067 TSecr=0 WS=128\r\n  2 0.000032200    10.2.4.64 ? 10.2.4.76    TCP 76 32880 ? 53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=3087861067 TSecr=0 WS=128\r\n  3 0.000000000    10.2.4.64 ? 10.2.4.76    TCP 76 [TCP Retransmission] 32880 ? 53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=3087861067 TSecr=0 WS=128\r\n  4 0.000040500    10.2.4.64 ? 10.2.4.76    TCP 76 [TCP Out-Of-Order] 32880 ? 53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=3087861067 TSecr=0 WS=128\r\n  5 0.000063600    10.2.4.76 ? 10.2.4.64    TCP 76 53 ? 32880 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1460 SACK_PERM=1 TSval=1635729023 TSecr=3087861067 WS=128\r\n  6 0.000074300    10.3.0.10 ? 10.2.4.64    TCP 76 53 ? 32880 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1460 SACK_PERM=1 TSval=1635729023 TSecr=3087861067 WS=128\r\n  7 0.000063600    10.2.4.76 ? 10.2.4.64    TCP 76 [TCP Out-Of-Order] 53 ? 32880 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1460 SACK_PERM=1 TSval=1635729023 TSecr=3087861067 WS=128\r\n  8 0.000087900    10.2.4.64 ? 10.3.0.10    TCP 68 32880 ? 53 [ACK] Seq=1 Ack=1 Win=29312 Len=0 TSval=3087861067 TSecr=1635729023\r\n  9 0.000096200    10.2.4.64 ? 10.2.4.76    TCP 68 32880 ? 53 [ACK] Seq=1 Ack=1 Win=29312 Len=0 TSval=3087861067 TSecr=1635729023\r\n 10 0.000087900    10.2.4.64 ? 10.2.4.76    TCP 68 [TCP Dup ACK 9#1] 32880 ? 53 [ACK] Seq=1 Ack=1 Win=29312 Len=0 TSval=3087861067 TSecr=1635729023\r\n 11 0.000099300    10.2.4.64 ? 10.2.4.76    TCP 68 [TCP Dup ACK 9#2] 32880 ? 53 [ACK] Seq=1 Ack=1 Win=29312 Len=0 TSval=3087861067 TSecr=1635729023\r\n```\r\n\r\nKubelet: 1.8.0\r\nDNS pod: 10.2.1.254\r\nOrigin pod: 10.2.1.234\r\n```\r\nCapturing on 'any'\r\n  1 0.000000000   10.2.1.234 ? 10.3.0.10    TCP 76 34542?53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=247976308 TSecr=0 WS=128\r\n  2 0.000000000   10.2.1.234 ? 10.3.0.10    TCP 76 [TCP Out-Of-Order] 34542?53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=247976308 TSecr=0 WS=128\r\n  3 0.000034900   10.2.1.234 ? 10.2.1.254   TCP 76 34542?53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=247976308 TSecr=0 WS=128\r\n  4 0.000037200   10.2.1.234 ? 10.2.1.254   TCP 76 [TCP Out-Of-Order] 34542?53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=247976308 TSecr=0 WS=128\r\n  5 0.000055300   10.2.1.254 ? 10.2.1.234   TCP 76 53?34542 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1460 SACK_PERM=1 TSval=464258761 TSecr=247976308 WS=128\r\n  6 0.000057501   10.2.1.254 ? 10.2.1.234   TCP 76 [TCP Out-Of-Order] 53?34542 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1460 SACK_PERM=1 TSval=464258761 TSecr=247976308 WS=128\r\n  7 0.000055300   10.2.1.254 ? 10.2.1.234   TCP 76 [TCP Out-Of-Order] 53?34542 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1460 SACK_PERM=1 TSval=464258761 TSecr=247976308 WS=128\r\n  8 1.033021085   10.2.1.234 ? 10.3.0.10    TCP 76 [TCP Retransmission] 34542?53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=247977341 TSecr=0 WS=128\r\n  9 1.033021085   10.2.1.234 ? 10.3.0.10    TCP 76 [TCP Retransmission] 34542?53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=247977341 TSecr=0 WS=128\r\n 10 1.033101586   10.2.1.234 ? 10.2.1.254   TCP 76 [TCP Spurious Retransmission] 34542?53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=247977341 TSecr=0 WS=128\r\n 11 1.033104086   10.2.1.234 ? 10.2.1.254   TCP 76 [TCP Spurious Retransmission] 34542?53 [SYN] Seq=0 Win=29200 Len=0 MSS=1460 SACK_PERM=1 TSval=247977341 TSecr=0 WS=128\r\n```\r\n\r\nWe can see that in the requests that fail the DNS IP is correctly DNATed to the DNS POD destination address but the response is not masqueraded, it still carries the DNS POD source (it should have an origin of 10.3.0.10).\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"8\", GitVersion:\"v1.8.0\", GitCommit:\"0b9efaeb34a2fc51ff8e4d34ad9bc6375459c4a4\", GitTreeState:\"clean\", BuildDate:\"2017-09-29T05:56:06Z\", GoVersion:\"go1.9\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"8\", GitVersion:\"v1.8.0+coreos.0\", GitCommit:\"a65654ef5b593ac19fbfaf33b1a1873c0320353b\", GitTreeState:\"clean\", BuildDate:\"2017-09-29T21:51:03Z\", GoVersion:\"go1.8.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n- Cloud provider or hardware configuration: Azure Standard_A4\r\n- OS (e.g. from /etc/os-release): \"Container Linux by CoreOS 1465.8.0 (Ladybug)\"\r\n- Kernel (e.g. `uname -a`): Linux node-1-vm 4.12.14-coreos #1 SMP Wed Sep 20 22:20:05 UTC 2017 x86_64 Intel(R) Xeon(R) CPU E5-2673 v3 @ 2.40GHz GenuineIntel GNU/Linux\r\n- Install tools: https://github.com/edevil/kubernetes-deployment\r\n\r\n",
  "closed_at": "2017-10-13T01:08:01Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/53396/comments",
  "created_at": "2017-10-03T17:23:42Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/53396/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/53396",
  "id": 262513506,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 128716589,
      "name": "area/kube-proxy",
      "node_id": "MDU6TGFiZWwxMjg3MTY1ODk=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/kube-proxy"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Highest priority. Must be actively worked on as someone's top priority right now.",
      "id": 114528068,
      "name": "priority/critical-urgent",
      "node_id": "MDU6TGFiZWwxMTQ1MjgwNjg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/critical-urgent"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Network.",
      "id": 116712108,
      "name": "sig/network",
      "node_id": "MDU6TGFiZWwxMTY3MTIxMDg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/network"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Node.",
      "id": 173493665,
      "name": "sig/node",
      "node_id": "MDU6TGFiZWwxNzM0OTM2NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/node"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Release.",
      "id": 614023989,
      "name": "sig/release",
      "node_id": "MDU6TGFiZWw2MTQwMjM5ODk=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/release"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/53396/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-08-26T17:23:28Z",
    "closed_issues": 1061,
    "created_at": "2017-05-26T17:18:43Z",
    "creator": {
      "avatar_url": "https://avatars0.githubusercontent.com/u/169553?v=4",
      "events_url": "https://api.github.com/users/timothysc/events{/privacy}",
      "followers_url": "https://api.github.com/users/timothysc/followers",
      "following_url": "https://api.github.com/users/timothysc/following{/other_user}",
      "gists_url": "https://api.github.com/users/timothysc/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/timothysc",
      "id": 169553,
      "login": "timothysc",
      "node_id": "MDQ6VXNlcjE2OTU1Mw==",
      "organizations_url": "https://api.github.com/users/timothysc/orgs",
      "received_events_url": "https://api.github.com/users/timothysc/received_events",
      "repos_url": "https://api.github.com/users/timothysc/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/timothysc/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/timothysc/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/timothysc"
    },
    "description": "",
    "due_on": "2017-09-27T07:00:00Z",
    "html_url": "https://github.com/kubernetes/kubernetes/milestone/36",
    "id": 2545392,
    "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/36/labels",
    "node_id": "MDk6TWlsZXN0b25lMjU0NTM5Mg==",
    "number": 36,
    "open_issues": 0,
    "state": "closed",
    "title": "v1.8",
    "updated_at": "2019-08-26T17:23:28Z",
    "url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/36"
  },
  "node_id": "MDU6SXNzdWUyNjI1MTM1MDY=",
  "number": 53396,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Kubelet v1.8.0 breaks pods talking to services on the same node",
  "updated_at": "2017-10-13T01:08:01Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/53396",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/12426?v=4",
    "events_url": "https://api.github.com/users/edevil/events{/privacy}",
    "followers_url": "https://api.github.com/users/edevil/followers",
    "following_url": "https://api.github.com/users/edevil/following{/other_user}",
    "gists_url": "https://api.github.com/users/edevil/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/edevil",
    "id": 12426,
    "login": "edevil",
    "node_id": "MDQ6VXNlcjEyNDI2",
    "organizations_url": "https://api.github.com/users/edevil/orgs",
    "received_events_url": "https://api.github.com/users/edevil/received_events",
    "repos_url": "https://api.github.com/users/edevil/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/edevil/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/edevil/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/edevil"
  }
}