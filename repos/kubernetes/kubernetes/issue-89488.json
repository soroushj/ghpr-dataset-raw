{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "After reading up on some corner cases with etcd client behavior (connections, streams, etc.) I came across the following option that has been introduced in etcd a while ago:\r\n\r\n```go\r\n// WithRequireLeader requires client requests to only succeed\r\n// when the cluster has a leader.\r\nfunc WithRequireLeader(ctx context.Context) context.Context {...}\r\n```\r\n[(Source)](https://github.com/etcd-io/etcd/blob/67da93f739e33ee9b34792fccba2d0c100264ea4/clientv3/ctx.go#L28)\r\n\r\nFrom the official etcd docs on client behavior:\r\n\r\n> Client-side keepalive ping still does not reason about network partitions. Streaming request may get stuck with a partitioned node. Advanced health checking service need to be implemented to understand the cluster membership (see etcd#8673 for more detail).\r\nSource: [clientv3-grpc1.23: Balancer Limitation](https://etcd.io/docs/v3.4.0/learning/design-client/)\r\n\r\nI do not see this option being used in the API server when `Watch()` is [established](https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/storage/etcd3/watcher.go#L218).\r\n\r\nIs there code in the API server that deals with these cases (etcd/API server node paritioned) and disconnects clients (REST, SDK) appropriately? Or are we at risk of having dangling (hanging) consumer-side client watches due to not using this option in the etcd client?\r\n\r\nRelated discussions:\r\n\r\n[clientv3: clarify \"WithRequireLeader\" for network partition](https://github.com/etcd-io/etcd/pull/9872)\r\n[Network-partition aware health service](https://github.com/etcd-io/etcd/issues/8673)\r\n\r\n/sig api-machinery\r\n\r\ncc/ @dims @jingyih @jpbetz @sttts ",
  "closed_at": "2020-04-08T16:09:45Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 20,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/89488/comments",
  "created_at": "2020-03-25T19:52:14Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/89488/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/89488",
  "id": 587950558,
  "labels": [
    {
      "color": "d455d0",
      "default": false,
      "description": "Categorizes issue or PR as a support question.",
      "id": 130318610,
      "name": "kind/support",
      "node_id": "MDU6TGFiZWwxMzAzMTg2MTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/support"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/89488/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1ODc5NTA1NTg=",
  "number": 89488,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Clarification on watch when server (or store) is partitioned",
  "updated_at": "2020-04-08T16:09:45Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/89488",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/15986659?v=4",
    "events_url": "https://api.github.com/users/embano1/events{/privacy}",
    "followers_url": "https://api.github.com/users/embano1/followers",
    "following_url": "https://api.github.com/users/embano1/following{/other_user}",
    "gists_url": "https://api.github.com/users/embano1/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/embano1",
    "id": 15986659,
    "login": "embano1",
    "node_id": "MDQ6VXNlcjE1OTg2NjU5",
    "organizations_url": "https://api.github.com/users/embano1/orgs",
    "received_events_url": "https://api.github.com/users/embano1/received_events",
    "repos_url": "https://api.github.com/users/embano1/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/embano1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/embano1/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/embano1"
  }
}