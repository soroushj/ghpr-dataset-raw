{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n**What happened**:\r\n\r\nWe were unable to drain pods on an unhealthy node that were stuck in pod initializing. The disruption budget has a `minAvailable` of 2. We had two healthy pods and a pod stuck in initializing thus it's unhealthy. A drain on the node with the unhealthy pod stuck in initializing was prevented. \r\n\r\n**What you expected to happen**:\r\n\r\nThe pods should have been evicted because they are in a not Ready state. \r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nUsing a PDB with `minAvailable` attempt to drain a node with a pod in a not Ready state. \r\n\r\n**Anything else we need to know?**:\r\n\r\nThe reason this is prevented is because the disruption controller determines the number of allowed disruptions by looking at [`currentHealthy - desiredHealthy`](https://github.com/kubernetes/kubernetes/blob/a07b027261383127494fc6d4e3ca2c544fb4a464/pkg/controller/disruption/disruption.go#L749-L752). When `minAvailable` is used your `desiredHealthy` count becomes that value, which in our case is 2. The `currentHealthy` count is 2 also because the 3rd pod is stuck in an initializing state on the bad node. This leaves the PDB with an allowed disruption of 0 and thus blocks the drain. \r\n\r\nThe eviction logic in the storage only allows pods in a terminal state to bypass the PDB. \r\n\r\nhttps://github.com/kubernetes/kubernetes/blob/master/pkg/registry/core/pod/storage/eviction.go#L124-L133\r\n\r\nIf they're not in a terminal state the eviction will only be allowed to occur if there are allowable disruptions available on the PDB.\r\n\r\nIt seems that the storage logic should allow draining pods that are not ready instead of just allowing terminal pods. \r\n\r\n/sig apps",
  "closed_at": "2020-10-21T09:24:20Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 29,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80389/comments",
  "created_at": "2019-07-20T15:41:09Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80389/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/80389",
  "id": 470687201,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Apps.",
      "id": 404091735,
      "name": "sig/apps",
      "node_id": "MDU6TGFiZWw0MDQwOTE3MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/apps"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80389/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NzA2ODcyMDE=",
  "number": 80389,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "PDBs using minUnavailable prevent draining unready pods ",
  "updated_at": "2020-10-21T09:24:20Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80389",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/3876739?v=4",
    "events_url": "https://api.github.com/users/jhorwit2/events{/privacy}",
    "followers_url": "https://api.github.com/users/jhorwit2/followers",
    "following_url": "https://api.github.com/users/jhorwit2/following{/other_user}",
    "gists_url": "https://api.github.com/users/jhorwit2/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jhorwit2",
    "id": 3876739,
    "login": "jhorwit2",
    "node_id": "MDQ6VXNlcjM4NzY3Mzk=",
    "organizations_url": "https://api.github.com/users/jhorwit2/orgs",
    "received_events_url": "https://api.github.com/users/jhorwit2/received_events",
    "repos_url": "https://api.github.com/users/jhorwit2/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jhorwit2/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jhorwit2/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jhorwit2"
  }
}