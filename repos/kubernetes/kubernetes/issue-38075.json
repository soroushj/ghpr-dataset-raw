{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!-- Thanks for filing an issue! Before hitting the button, please answer these questions.-->\r\n\r\n**Is this a request for help?** (If yes, you should use our troubleshooting guide and community support channels, see http://kubernetes.io/docs/troubleshooting/.):\r\n- No\r\n\r\n**What keywords did you search in Kubernetes issues before filing this one?** (If you have found any duplicates, you should instead reply there.):\r\n- kubectl \"does not allow access\" \r\n\r\n---\r\n\r\n**Is this a BUG REPORT or FEATURE REQUEST?** (choose one):\r\n- Bug report\r\n\r\n<!--\r\nIf this is a BUG REPORT, please:\r\n  - Fill in as much of the template below as you can.  If you leave out\r\n    information, we can't help you as well.\r\n\r\nIf this is a FEATURE REQUEST, please:\r\n  - Describe *in detail* the feature/behavior/change you'd like to see.\r\n\r\nIn both cases, be ready for followup questions, and please respond in a timely\r\nmanner.  If we can't reproduce a bug or think a feature already exists, we\r\nmight close your issue.  If we're wrong, PLEASE feel free to reopen it and\r\nexplain why.\r\n-->\r\n\r\n**Kubernetes version** (use `kubectl version`):\r\n ```\r\nClient Version: version.Info{Major:\"1\", Minor:\"4\", GitVersion:\"v1.4.6\", GitCommit:\"e569a27d02001e343cb68086bc06d47804f62af6\", GitTreeState:\"clean\", BuildDate:\"2016-11-12T05:22:15Z\", GoVersion:\"go1.7.1\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"4\", GitVersion:\"v1.4.5\", GitCommit:\"5a0a696437ad35c133c0c8493f7e9d22b0f9b81b\", GitTreeState:\"clean\", BuildDate:\"2016-10-29T01:32:42Z\", GoVersion:\"go1.6.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n\r\n**Environment**:\r\n- **Cloud provider or hardware configuration**:\r\n  - GCP GKE 1.4.5\r\n- **OS** (e.g. from /etc/os-release):\r\n  - Not sure, using gci\r\n- **Kernel** (e.g. `uname -a`):\r\n  - Not sure, using gci\r\n- **Install tools**:\r\n  - GKE web UI\r\n- **Others**:\r\n  - N/A\r\n\r\n\r\n**What happened**:\r\n- In juggling multiple gcloud accounts with GKE clusters I accidentally used `kubectl` with the wrong application default credentials and it cached bad creds in `~/.kube/config`\r\n- After pointing gcloud at the right application default credentials and re-running `kubectl`, it continued trying and failing to use the bad creds cached in `~/.kube/config`; at this point I was stuck and confused for a few hours\r\n- To repair, I had to manually edit `~/.kube/config` to remove `users[].user.auth-provider.config`, and then `kubectl` started working again (or else wait ~1h for the access token to expire and refresh itself)\r\n\r\n**What you expected to happen**:\r\n- After pointing gcloud at the right application default credentials `kubectl` should just work, or at least provide an error msg to the user that can help them figure out that they need to revoke the bad access token and how to do it\r\n\r\n**How to reproduce it** (as minimally and precisely as possible):\r\n\r\nGood scenario: just works\r\n```sh\r\n# Avoid calling kubectl with wrong application default credentials\r\ngcloud auth application-default login # -> Auth with user A\r\nkubectl --context cluster-A version   # Ok + caches good creds\r\ngcloud auth application-default login # -> Auth with user B\r\nkubectl --context cluster-B version   # Ok + caches good creds\r\n\r\n# Both now work\r\nkubectl --context cluster-A version   # Ok, using cached good creds\r\nkubectl --context cluster-B version   # Ok, using cached good creds\r\n```\r\n\r\nBad scenario: user makes one mistake and gets stuck\r\n```sh\r\n# Use kubectl with wrong ADC\r\ngcloud auth application-default login # -> Auth with user A\r\nkubectl --context cluster-A version   # Ok + caches good creds\r\nkubectl --context cluster-B version   # Oops + caches bad creds\r\ngcloud auth application-default login # -> Auth with user B\r\nkubectl --context cluster-B version   # Fails, stuck on bad creds cached in ~/.kube/config\r\nkubectl --context cluster-A version   # Still works, using cached good creds\r\n\r\n# User is now stuck and confused with no clear approach to resolve...\r\n\r\n# Tada!\r\nvim ~/.kube/config                    # Manually remove users[].user.auth-provider.config for cluster-B\r\nkubectl --context cluster-B version   # Ok + caches good creds\r\n\r\n# Both now work\r\nkubectl --context cluster-A version   # Ok, using cached good creds\r\nkubectl --context cluster-B version   # Ok, using cached good creds\r\n```\r\n",
  "closed_at": "2017-06-21T20:30:14Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 9,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/38075/comments",
  "created_at": "2016-12-05T01:15:04Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/38075/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/38075",
  "id": 193391650,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 138247961,
      "name": "area/kubectl",
      "node_id": "MDU6TGFiZWwxMzgyNDc5NjE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/kubectl"
    },
    {
      "color": "006b75",
      "default": true,
      "description": "Denotes an issue that needs help from a contributor. Must meet \"help wanted\" guidelines.",
      "id": 433686790,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw0MzM2ODY3OTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/help%20wanted"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG CLI.",
      "id": 450823910,
      "name": "sig/cli",
      "node_id": "MDU6TGFiZWw0NTA4MjM5MTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cli"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/38075/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxOTMzOTE2NTA=",
  "number": 38075,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kubectl: Bad creds get cached in ~/.kube/config, causing user confusion until expiry (or manual file edit)",
  "updated_at": "2020-07-02T20:24:48Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/38075",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/627486?v=4",
    "events_url": "https://api.github.com/users/jdanbrown/events{/privacy}",
    "followers_url": "https://api.github.com/users/jdanbrown/followers",
    "following_url": "https://api.github.com/users/jdanbrown/following{/other_user}",
    "gists_url": "https://api.github.com/users/jdanbrown/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jdanbrown",
    "id": 627486,
    "login": "jdanbrown",
    "node_id": "MDQ6VXNlcjYyNzQ4Ng==",
    "organizations_url": "https://api.github.com/users/jdanbrown/orgs",
    "received_events_url": "https://api.github.com/users/jdanbrown/received_events",
    "repos_url": "https://api.github.com/users/jdanbrown/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jdanbrown/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jdanbrown/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jdanbrown"
  }
}