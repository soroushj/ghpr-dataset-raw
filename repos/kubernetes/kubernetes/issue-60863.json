{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/8061296?v=4",
    "events_url": "https://api.github.com/users/ixdy/events{/privacy}",
    "followers_url": "https://api.github.com/users/ixdy/followers",
    "following_url": "https://api.github.com/users/ixdy/following{/other_user}",
    "gists_url": "https://api.github.com/users/ixdy/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ixdy",
    "id": 8061296,
    "login": "ixdy",
    "node_id": "MDQ6VXNlcjgwNjEyOTY=",
    "organizations_url": "https://api.github.com/users/ixdy/orgs",
    "received_events_url": "https://api.github.com/users/ixdy/received_events",
    "repos_url": "https://api.github.com/users/ixdy/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ixdy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ixdy/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ixdy"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/8061296?v=4",
      "events_url": "https://api.github.com/users/ixdy/events{/privacy}",
      "followers_url": "https://api.github.com/users/ixdy/followers",
      "following_url": "https://api.github.com/users/ixdy/following{/other_user}",
      "gists_url": "https://api.github.com/users/ixdy/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/ixdy",
      "id": 8061296,
      "login": "ixdy",
      "node_id": "MDQ6VXNlcjgwNjEyOTY=",
      "organizations_url": "https://api.github.com/users/ixdy/orgs",
      "received_events_url": "https://api.github.com/users/ixdy/received_events",
      "repos_url": "https://api.github.com/users/ixdy/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/ixdy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ixdy/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/ixdy"
    }
  ],
  "author_association": "MEMBER",
  "body": "I've been experimenting with producing a kubernetes src tarball from bazel that includes all generated code, such that an end user (like an OS distro) would be able to build kubernetes binaries using solely `go build`.\r\n\r\nThe kubernetes-src.tar.gz produced by the [build rule in build/release-tars](https://github.com/kubernetes/kubernetes/blob/f196b7c7523dbf0d6ed703a93af73f54e9d2e42c/build/release-tars/BUILD#L39-L52) almost already works, except that the staging directory symlinks under vendor/k8s.io are not handled correctly; some of the auxiliary files are included, but none of the go files.\r\n\r\nFor example:\r\n```console\r\n$ bazel build build/release-tars/kubernetes-src.tar.gz --define PACKAGE_SRC=true\r\nINFO: Analysed target //build/release-tars:kubernetes-src.tar.gz (2 packages loaded).\r\nINFO: Found 1 target...\r\nTarget //build/release-tars:kubernetes-src.tar.gz up-to-date:\r\n  bazel-bin/build/release-tars/kubernetes-src.tar.gz\r\nINFO: Elapsed time: 3.197s, Critical Path: 2.37s\r\nINFO: Build completed successfully, 3 total actions\r\n$ tar tzvf bazel-bin/build/release-tars/kubernetes-src.tar.gz | grep vendor/k8s.io/apimachinery\r\ndr-xr-xr-x 0/0               0 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/\r\ndr-xr-xr-x 0/0               0 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/.github/\r\n-r-xr-xr-x 0/0             150 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/.github/PULL_REQUEST_TEMPLATE.md\r\n-r-xr-xr-x 0/0             730 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/CONTRIBUTING.md\r\ndr-xr-xr-x 0/0               0 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/Godeps/\r\n-r-xr-xr-x 0/0            4873 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/Godeps/Godeps.json\r\n-r-xr-xr-x 0/0              27 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/Godeps/OWNERS\r\n-r-xr-xr-x 0/0             136 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/Godeps/Readme\r\n-r-xr-xr-x 0/0           11358 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/LICENSE\r\n-r-xr-xr-x 0/0             243 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/OWNERS\r\n-r-xr-xr-x 0/0            1251 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/README.md\r\n-r-xr-xr-x 0/0             148 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/code-of-conduct.md\r\ndr-xr-xr-x 0/0               0 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/pkg/\r\n-r-xr-xr-x 0/0              74 1969-12-31 16:00 kubernetes/vendor/k8s.io/apimachinery/pkg/OWNERS\r\n```\r\n(Directory permissions also seem to be incorrect, which seems to be a bug in our fast build_tar implementation. The bazel-bundled one does not have this bug.)\r\n\r\nI was able to fix this locally with a few basic changes:\r\n* Adding `BUILD` files to all of the `staging/src/k8s.io` repos at their root to prevent any of these auxiliary files from ending up in the tarball. I believe this is because these files are matching the `package-srcs` glob in `vendor/BUILD`, but the `all-srcs` list does not follow symlinks (and hence the go files are missing, since those directories have BUILD files already).\r\n* Explicitly adding a symlink attribute to the `kubernetes-src` `pkg_tar` rule with the staging symlinks:\r\n```python\r\nSTAGING_DIRS = [\r\n    \"api\",\r\n    \"apiextensions-apiserver\",\r\n    \"apimachinery\",\r\n    \"apiserver\",\r\n    \"client-go\",\r\n    \"code-generator\",\r\n    \"kube-aggregator\",\r\n    \"metrics\",\r\n    \"sample-apiserver\",\r\n    \"sample-controller\",\r\n]\r\n\r\npkg_tar(\r\n    name = \"kubernetes-src\",\r\n    srcs = select({\r\n        \":package_src\": [\"//:all-srcs\"],\r\n        \"//conditions:default\": [\"README-src.txt\"],\r\n    }), \r\n    extension = \"tar.gz\",\r\n    package_dir = \"kubernetes\",\r\n    strip_prefix = select({\r\n        \":package_src\": \"//\",\r\n        \"//conditions:default\": \".\",\r\n    }), \r\n    symlinks = {\"kubernetes/vendor/k8s.io/%s\" % dir: \"../../staging/src/k8s.io/%s\" % dir for dir in STAGING_DIRS},\r\n    tags = [\"no-cache\"],\r\n)\r\n```\r\n\r\nWhat I haven't figured out yet is how best to manage that list of staging directories. (Extend kazel? Not excited about that, though.)\r\n\r\nOne other change is that we need to declare an explicit dependency on generated source files, since they are not picked up by globs; for example, in `pkg/generated/openapi/BUILD`:\r\n```python\r\nfilegroup(\r\n    name = \"package-srcs\",\r\n    srcs = glob([\"**\"]) + [\":zz_generated.openapi\"],\r\n    tags = [\"automanaged\"],\r\n    visibility = [\"//visibility:private\"],\r\n)\r\n```\r\n\r\nThe good news is that with these changes I can extract kubernetes-src.tar.gz and `go build k8s.io/kubernetes/cmd/kube-apiserver` successfully.\r\n(You can't do that in k/k without first running `make generated_files` or using bazel.)\r\n\r\n/assign",
  "closed_at": "2019-03-06T05:42:01Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 11,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/60863/comments",
  "created_at": "2018-03-07T01:12:03Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/60863/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/60863",
  "id": 302928107,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 125299793,
      "name": "area/build-release",
      "node_id": "MDU6TGFiZWwxMjUyOTk3OTM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/build-release"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Release.",
      "id": 614023989,
      "name": "sig/release",
      "node_id": "MDU6TGFiZWw2MTQwMjM5ODk=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/release"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Testing.",
      "id": 483069764,
      "name": "sig/testing",
      "node_id": "MDU6TGFiZWw0ODMwNjk3NjQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/testing"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/60863/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMDI5MjgxMDc=",
  "number": 60863,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "staging repositories not handled properly in bazel-built kubernetes-src.tar.gz",
  "updated_at": "2019-03-06T05:42:01Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/60863",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/8061296?v=4",
    "events_url": "https://api.github.com/users/ixdy/events{/privacy}",
    "followers_url": "https://api.github.com/users/ixdy/followers",
    "following_url": "https://api.github.com/users/ixdy/following{/other_user}",
    "gists_url": "https://api.github.com/users/ixdy/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ixdy",
    "id": 8061296,
    "login": "ixdy",
    "node_id": "MDQ6VXNlcjgwNjEyOTY=",
    "organizations_url": "https://api.github.com/users/ixdy/orgs",
    "received_events_url": "https://api.github.com/users/ixdy/received_events",
    "repos_url": "https://api.github.com/users/ixdy/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ixdy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ixdy/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ixdy"
  }
}