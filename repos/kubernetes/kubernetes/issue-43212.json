{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!-- Thanks for filing an issue! Before hitting the button, please answer these questions.-->\r\n\r\n**Is this a request for help?** (If yes, you should use our troubleshooting guide and community support channels, see http://kubernetes.io/docs/troubleshooting/.):\r\nNo.\r\n\r\n**What keywords did you search in Kubernetes issues before filing this one?** (If you have found any duplicates, you should instead reply there.):\r\n\r\nCLOSE_WAIT\r\n\r\n---\r\n\r\n**Is this a BUG REPORT or FEATURE REQUEST?** (choose one):\r\n\r\nBUG REPORT\r\n\r\n<!--\r\nIf this is a BUG REPORT, please:\r\n  - Fill in as much of the template below as you can.  If you leave out\r\n    information, we can't help you as well.\r\n\r\nIf this is a FEATURE REQUEST, please:\r\n  - Describe *in detail* the feature/behavior/change you'd like to see.\r\n\r\nIn both cases, be ready for followup questions, and please respond in a timely\r\nmanner.  If we can't reproduce a bug or think a feature already exists, we\r\nmight close your issue.  If we're wrong, PLEASE feel free to reopen it and\r\nexplain why.\r\n-->\r\n\r\n**Kubernetes version** (use `kubectl version`):\r\n\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"5\", GitVersion:\"v1.5.4\", GitCommit:\"7243c69eb523aa4377bce883e7c0dd76b84709a1\", GitTreeState:\"clean\", BuildDate:\"2017-03-08T02:48:58Z\", GoVersion:\"go1.8\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"5\", GitVersion:\"v1.5.2\", GitCommit:\"08e099554f3c31f6e6f07b448ab3ed78d0520507\", GitTreeState:\"clean\", BuildDate:\"2017-01-12T04:52:34Z\", GoVersion:\"go1.7.4\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n\r\n**Environment**:\r\n- **Cloud provider or hardware configuration**: AWS\r\n- **OS** (e.g. from /etc/os-release): Debian GNU/Linux 8 (jessie)\r\n- **Kernel** (e.g. `uname -a`): Linux ip-172-31-64-14 4.4.41-k8s #1 SMP Mon Jan 9 15:34:39 UTC 2017 x86_64 GNU/Linux\r\n- **Install tools**: kops 1.5.3\r\n- **Others**:\r\n\r\n\r\n**What happened**:\r\n\r\nThe problem was triggered when an Service type=LoadBalancer was left without ready Pods. This triggers a wave of CLOSE_WAIT on the master node(s) that is reproducible.\r\n\r\n**What you expected to happen**:\r\n\r\nThere should not be any flooding of CLOSE_WAIT connections.\r\n\r\n**How to reproduce it** (as minimally and precisely as possible):\r\n\r\n- Start a cluster with Kops v1.5.3 (kubernetes v1.5.2) at AWS\r\n- Create a Service type=LoadBalancer (without attached Pods)\r\n\r\nThis should trigger the CLOSE_WAIT on the master.\r\n\r\nTake note that  because the kops v1.5.3 is using taints instead of SchedulingDisabled (https://github.com/kubernetes/kops/issues/639) the master nodes are also added under the ELB on AWS.\r\n\r\n**Anything else we need to know**:\r\n\r\n* As a workaround the master can be tagged as unscheduled. This will configure ELB to exclude the master and the CLOSE_WAITs will stop raising.\r\n\r\n```\r\nkubectl patch node MASTER_NAME -p \"{\\\"spec\\\":{\\\"unschedulable\\\":true}}\"\r\n```\r\n* If Pods are added to the LoadBalancer service, the CLOSE_WAITS will stop raising when ready.\r\n\r\n* The CLOSE_WAITs start raising on master when ELB is tagging the master node as \"InService\" not before that.\r\n\r\n* Once too many CLOSE_WAITs are generated the following error appears, and master is marked as `not_ready` and ssh is unresponsive. Logs were gathered from \"AWS > Instance Settings > Get System Log\"\r\n\r\n```\r\nTCP: out of memory\u2026 consider tuning tcp_mem\r\n```\r\n\r\n* Issue has been reproduced in a different cluster and AWS account.\r\n\r\nreported together with @mikim83\r\n",
  "closed_at": "2017-03-21T06:22:22Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/43212/comments",
  "created_at": "2017-03-16T11:00:52Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/43212/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/43212",
  "id": 214667457,
  "labels": [],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/43212/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyMTQ2Njc0NTc=",
  "number": 43212,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "CLOSE_WAIT connections on master node when ELBs point there",
  "updated_at": "2017-09-28T04:04:11Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/43212",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/367397?v=4",
    "events_url": "https://api.github.com/users/dkapanidis/events{/privacy}",
    "followers_url": "https://api.github.com/users/dkapanidis/followers",
    "following_url": "https://api.github.com/users/dkapanidis/following{/other_user}",
    "gists_url": "https://api.github.com/users/dkapanidis/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/dkapanidis",
    "id": 367397,
    "login": "dkapanidis",
    "node_id": "MDQ6VXNlcjM2NzM5Nw==",
    "organizations_url": "https://api.github.com/users/dkapanidis/orgs",
    "received_events_url": "https://api.github.com/users/dkapanidis/received_events",
    "repos_url": "https://api.github.com/users/dkapanidis/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/dkapanidis/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dkapanidis/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/dkapanidis"
  }
}