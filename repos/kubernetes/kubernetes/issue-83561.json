{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1103629?v=4",
    "events_url": "https://api.github.com/users/josephburnett/events{/privacy}",
    "followers_url": "https://api.github.com/users/josephburnett/followers",
    "following_url": "https://api.github.com/users/josephburnett/following{/other_user}",
    "gists_url": "https://api.github.com/users/josephburnett/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/josephburnett",
    "id": 1103629,
    "login": "josephburnett",
    "node_id": "MDQ6VXNlcjExMDM2Mjk=",
    "organizations_url": "https://api.github.com/users/josephburnett/orgs",
    "received_events_url": "https://api.github.com/users/josephburnett/received_events",
    "repos_url": "https://api.github.com/users/josephburnett/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/josephburnett/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/josephburnett/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/josephburnett"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/1103629?v=4",
      "events_url": "https://api.github.com/users/josephburnett/events{/privacy}",
      "followers_url": "https://api.github.com/users/josephburnett/followers",
      "following_url": "https://api.github.com/users/josephburnett/following{/other_user}",
      "gists_url": "https://api.github.com/users/josephburnett/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/josephburnett",
      "id": 1103629,
      "login": "josephburnett",
      "node_id": "MDQ6VXNlcjExMDM2Mjk=",
      "organizations_url": "https://api.github.com/users/josephburnett/orgs",
      "received_events_url": "https://api.github.com/users/josephburnett/received_events",
      "repos_url": "https://api.github.com/users/josephburnett/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/josephburnett/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/josephburnett/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/josephburnett"
    }
  ],
  "author_association": "NONE",
  "body": "**What would you like to be added**:\r\n\r\nAn option inside HPA to ignore \"Terminating\" pods (i.e. pods that have been elected for downscale but are for example waiting for the prestop hook to give permission to k8s to actually stop them) when computing resource usage.\r\n\r\n**Why is this needed**:\r\n\r\nLet's take an example.\r\n\r\nI have a service S processing some short to long queries (for this example, think 1min in general, but with some queries taking by nature up to 30 min). Each query uses about 5% of CPU. We configure 75% utilisation of the cluster (so an average of 15 queries running on each instance).\r\n_To make this example simpler lets assume that the service doing nothing takes 0% and that we start with only one instance of the service_\r\n\r\nWhen we start the 16th concurrent query, CPU of first instance will be 80% -> HPA will start a second one.\r\nIf we keep running 16-30 queries for some time, we will end up having 2 evenly loaded instances with 8-15 queries each. So far so good.\r\n\r\nBut if for some time we go down to 12 queries, both instances will be at 30% then a downscale will happen and one instance will be \"terminating\" (and thanks to the prestop hook, it will stay in that state until the last query ends, so up to 30 min based on our initial assumption of the duration of queries). And thanks to Murphy's law, the instance elected for termination was running 5 short queries that end quickly and one long that was started just before the downscale and that will last for 30 min. So for more than 25 minutes, that terminating instance will be using 5% CPU.\r\n\r\nLet's assume we go up again adding queries quickly one by one:\r\n- when reaching 16 queries then CPU will be 75% for first instance running 15 queries and 5% for terminating instance running 1 query. Average is 40%, so no upscaling\r\n- when reaching 21 queries then CPU will be 100% for first instance running 20 queries and 5% for terminating instance still running 1 query. Average is 52.5% so still not upscaling\r\n- adding more queries will be an issue (either queued / rejected or CPU throttled on first instance).\r\n\r\nIf there is some issue in query running on stopping instance and if it never stops, then HPA is totally blocked. Even if we have 100 queries in the system, we will keep one instance of the service saturated.\r\n\r\nSetting HPA target utilisation to 50% would solve this example. But think 3 instances, downscaling 2 and then you need it to be 33%. And so on. \r\n\r\nWe've been facing that use case a few times. After receiving alerts for CPU over limit, the solution was to change the HPA minimum to force it to upscale.",
  "closed_at": "2020-10-15T09:54:25Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 19,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83561/comments",
  "created_at": "2019-10-07T10:10:18Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83561/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/83561",
  "id": 503354835,
  "labels": [
    {
      "color": "c7def8",
      "default": false,
      "description": "Categorizes issue or PR as related to a new feature.",
      "id": 267761362,
      "name": "kind/feature",
      "node_id": "MDU6TGFiZWwyNjc3NjEzNjI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/feature"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Autoscaling.",
      "id": 238245616,
      "name": "sig/autoscaling",
      "node_id": "MDU6TGFiZWwyMzgyNDU2MTY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/autoscaling"
    },
    {
      "color": "8fc951",
      "default": false,
      "description": "Indicates an issue or PR is ready to be actively worked on.",
      "id": 2389856656,
      "name": "triage/accepted",
      "node_id": "MDU6TGFiZWwyMzg5ODU2NjU2",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/triage/accepted"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83561/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MDMzNTQ4MzU=",
  "number": 83561,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Horizontal Pod Autoscaler fooled by terminating pods",
  "updated_at": "2020-10-15T09:54:25Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83561",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/5136244?v=4",
    "events_url": "https://api.github.com/users/f-ld/events{/privacy}",
    "followers_url": "https://api.github.com/users/f-ld/followers",
    "following_url": "https://api.github.com/users/f-ld/following{/other_user}",
    "gists_url": "https://api.github.com/users/f-ld/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/f-ld",
    "id": 5136244,
    "login": "f-ld",
    "node_id": "MDQ6VXNlcjUxMzYyNDQ=",
    "organizations_url": "https://api.github.com/users/f-ld/orgs",
    "received_events_url": "https://api.github.com/users/f-ld/received_events",
    "repos_url": "https://api.github.com/users/f-ld/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/f-ld/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/f-ld/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/f-ld"
  }
}