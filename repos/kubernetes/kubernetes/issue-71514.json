{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/4953962?v=4",
    "events_url": "https://api.github.com/users/m1093782566/events{/privacy}",
    "followers_url": "https://api.github.com/users/m1093782566/followers",
    "following_url": "https://api.github.com/users/m1093782566/following{/other_user}",
    "gists_url": "https://api.github.com/users/m1093782566/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/m1093782566",
    "id": 4953962,
    "login": "m1093782566",
    "node_id": "MDQ6VXNlcjQ5NTM5NjI=",
    "organizations_url": "https://api.github.com/users/m1093782566/orgs",
    "received_events_url": "https://api.github.com/users/m1093782566/received_events",
    "repos_url": "https://api.github.com/users/m1093782566/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/m1093782566/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/m1093782566/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/m1093782566"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars1.githubusercontent.com/u/4953962?v=4",
      "events_url": "https://api.github.com/users/m1093782566/events{/privacy}",
      "followers_url": "https://api.github.com/users/m1093782566/followers",
      "following_url": "https://api.github.com/users/m1093782566/following{/other_user}",
      "gists_url": "https://api.github.com/users/m1093782566/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/m1093782566",
      "id": 4953962,
      "login": "m1093782566",
      "node_id": "MDQ6VXNlcjQ5NTM5NjI=",
      "organizations_url": "https://api.github.com/users/m1093782566/orgs",
      "received_events_url": "https://api.github.com/users/m1093782566/received_events",
      "repos_url": "https://api.github.com/users/m1093782566/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/m1093782566/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/m1093782566/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/m1093782566"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "**What happened**:\r\nOn pods with a lot of DNS traffic, many DNS queries to the DNS ClusterIP fail during a rolling update of the DNS pods (in our case, we use coredns).\r\n\r\n**What you expected to happen**:\r\nAlmost all DNS queries should succeed during a rolling update.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n* Create a coredns (this would probably be the same with kube-dns) service backed by 2 pods\r\n* Access this service by creating a lot of DNS queries, for example:\r\n```\r\nwhile true ; do dig +tries=1 -4 +short A <name> @<dns clusterIP> ; sleep 0.05 ; echo \"--\" ; done\r\n```\r\n* Wait for the IPVS connection table to contain a lot of DNS connections (a few minutes)\r\n* Delete a DNS pod\r\n\r\nA significant number of queries will timeout. After 5mn (depending in the IPVS timeout configuration) everything will work ok again.\r\n\r\n**Anything else we need to know?**:\r\nThis comes from the current logic in the graceful termination code:\r\n\r\nThe current logic is to delete a RS if the number of active connections is 0. This makes sense for TCP but for UDP the number of active connections is always 0. This is an issue for DNS queries because the RS will be deleted but the IPVS connection will remain until it expires (5mn by default) and if there are a lot of DNS queries, the port will be reused and queries blackholed.\r\n\r\nIn addition, `net.ipv4.vs.expire_nodest_conn=1` will not always work here because IPVS only removes connections when a packet is processed (in the case of DNS once the client receives an answer, no more packets are sent).\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): kube-proxy `v1.13.0-alpha.3`\r\n- OS (e.g. from /etc/os-release): `Ubuntu 18.04.1 LTS`\r\n- Kernel (e.g. `uname -a`): `Linux ip-10-128-212-113 4.15.0-1023-aws #23-Ubuntu SMP Mon Sep 24 16:31:06 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n/area ipvs\r\n/sig network\r\n/kind bug\r\n\r\n/assign @m1093782566 ",
  "closed_at": "2018-11-30T09:20:27Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 10,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/71514/comments",
  "created_at": "2018-11-28T17:18:08Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/71514/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/71514",
  "id": 385374089,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 755527763,
      "name": "area/ipvs",
      "node_id": "MDU6TGFiZWw3NTU1Mjc3NjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/ipvs"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Network.",
      "id": 116712108,
      "name": "sig/network",
      "node_id": "MDU6TGFiZWwxMTY3MTIxMDg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/network"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/71514/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzODUzNzQwODk=",
  "number": 71514,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "In IPVS mode, kube-proxy doesn't handle graceful termination of UDP flows",
  "updated_at": "2019-03-26T14:34:53Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/71514",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/5391707?v=4",
    "events_url": "https://api.github.com/users/lbernail/events{/privacy}",
    "followers_url": "https://api.github.com/users/lbernail/followers",
    "following_url": "https://api.github.com/users/lbernail/following{/other_user}",
    "gists_url": "https://api.github.com/users/lbernail/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lbernail",
    "id": 5391707,
    "login": "lbernail",
    "node_id": "MDQ6VXNlcjUzOTE3MDc=",
    "organizations_url": "https://api.github.com/users/lbernail/orgs",
    "received_events_url": "https://api.github.com/users/lbernail/received_events",
    "repos_url": "https://api.github.com/users/lbernail/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lbernail/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lbernail/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lbernail"
  }
}