{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6233452?v=4",
    "events_url": "https://api.github.com/users/derekwaynecarr/events{/privacy}",
    "followers_url": "https://api.github.com/users/derekwaynecarr/followers",
    "following_url": "https://api.github.com/users/derekwaynecarr/following{/other_user}",
    "gists_url": "https://api.github.com/users/derekwaynecarr/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/derekwaynecarr",
    "id": 6233452,
    "login": "derekwaynecarr",
    "node_id": "MDQ6VXNlcjYyMzM0NTI=",
    "organizations_url": "https://api.github.com/users/derekwaynecarr/orgs",
    "received_events_url": "https://api.github.com/users/derekwaynecarr/received_events",
    "repos_url": "https://api.github.com/users/derekwaynecarr/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/derekwaynecarr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/derekwaynecarr/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/derekwaynecarr"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6233452?v=4",
      "events_url": "https://api.github.com/users/derekwaynecarr/events{/privacy}",
      "followers_url": "https://api.github.com/users/derekwaynecarr/followers",
      "following_url": "https://api.github.com/users/derekwaynecarr/following{/other_user}",
      "gists_url": "https://api.github.com/users/derekwaynecarr/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/derekwaynecarr",
      "id": 6233452,
      "login": "derekwaynecarr",
      "node_id": "MDQ6VXNlcjYyMzM0NTI=",
      "organizations_url": "https://api.github.com/users/derekwaynecarr/orgs",
      "received_events_url": "https://api.github.com/users/derekwaynecarr/received_events",
      "repos_url": "https://api.github.com/users/derekwaynecarr/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/derekwaynecarr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/derekwaynecarr/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/derekwaynecarr"
    }
  ],
  "author_association": "MEMBER",
  "body": "<!-- Please only use this template for submitting enhancement requests -->\r\n\r\n**What would you like to be added**:\r\n/kind feature\r\n\r\n**Why is this needed**:\r\n\r\nThis issue is intended to start discussion for future enhancement of kubelet.\r\n\r\n## What is an issue?\r\n- At this point, Kubernetes supports only pod isolation of hugepages where aggregated hugepages each container requests in a pod are managed as pod's resource in total. (even Hugepages are specified as \u2018hugepages-<size>\u2019 field under container field of Pod spec.)\r\n- The problem will happen if one of containers in a pod consumes a hugepage resource larger than one requested before, which leads unexpected starvation of hugepages to the other containers in same pod. \r\n- As an concrete example, if a pod has two containers and each requests 4 1GB hugepages, then the current kubelet assigns 8 1GB hugepages to the pod in total. In this situation, it is possible that one container with faulty implementation for hugepage usage consume all hugepages. Then the other can not use the requested 4 hugepages.\r\n\r\n## Current implementation\r\n- At first, pod isolation of hugepages in kubelet is performed by adding all requested hugepage limits over containers in a pod (see below).\r\nhttps://github.com/kubernetes/kubernetes/blob/a78cd38532421bf336e66a02fbcd5f8f9431ac04/pkg/kubelet/cm/pod_container_manager_linux.go#L79 https://github.com/kubernetes/kubernetes/blob/a78cd38532421bf336e66a02fbcd5f8f9431ac04/pkg/kubelet/cm/pod_container_manager_linux.go#L87 https://github.com/kubernetes/kubernetes/blob/a78cd38532421bf336e66a02fbcd5f8f9431ac04/pkg/kubelet/cm/helpers_linux.go#L142-L149\r\nThen kubelet sets the aggregated hugepage limitation on pod's cgroup under hugetlb subsystem.\r\nhttps://github.com/kubernetes/kubernetes/blob/a78cd38532421bf336e66a02fbcd5f8f9431ac04/pkg/kubelet/cm/pod_container_manager_linux.go#L92\r\n- Current CRI implementation([LinuxContainerResources](https://github.com/kubernetes/cri-api/blob/247eeb1afecb07101bb58883f79b8b463864b035/pkg/apis/runtime/v1alpha2/api.pb.go#L2204)) does not support to update hugepage limit at all even though [OCI runtime specification](https://github.com/opencontainers/runtime-spec/blob/master/config-linux.md#huge-page-limits) specifies \u2018hugepageLimits\u2019 for Container.for container as below.\r\n>     \"hugepageLimits\": [\r\n>        {\r\n>            \"pageSize\": \"2MB\",\r\n>            \"limit\": 209715200\r\n>        },\r\n>        {\r\n>            \"pageSize\": \"64KB\",\r\n>            \"limit\": 1000000\r\n>        }\r\n>     ] \r\n\r\n## Conclusion\r\n- First, CRI implementation(LinuxContainerResources) should be enhanced to support \"hugepageLimits\".\r\n- Second, containerd and runc should support to set hugepage limitation on container's cgroup.\r\n\r\n## Related Issue and KEP\r\n- Issue: [Hardware topology awareness at node level (including NUMA)](https://github.com/kubernetes/kubernetes/issues/49964)\r\n- KEP: [Node Topology Manager](https://github.com/kubernetes/enhancements/blob/dcc8c7241513373b606198ab0405634af643c500/keps/sig-node/0035-20190130-topology-manager.md)\r\n- KEP: [HugePages support in Kubernetes](https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/20190129-hugepages.md)\r\n",
  "closed_at": "2020-01-29T15:32:15Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 13,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80716/comments",
  "created_at": "2019-07-29T14:24:37Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80716/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/80716",
  "id": 474081899,
  "labels": [
    {
      "color": "c7def8",
      "default": false,
      "description": "Categorizes issue or PR as related to a new feature.",
      "id": 267761362,
      "name": "kind/feature",
      "node_id": "MDU6TGFiZWwyNjc3NjEzNjI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/feature"
    },
    {
      "color": "604460",
      "default": false,
      "description": "Denotes an issue or PR that has aged beyond stale and will be auto-closed.",
      "id": 778118402,
      "name": "lifecycle/rotten",
      "node_id": "MDU6TGFiZWw3NzgxMTg0MDI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/lifecycle/rotten"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Node.",
      "id": 173493665,
      "name": "sig/node",
      "node_id": "MDU6TGFiZWwxNzM0OTM2NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/node"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80716/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NzQwODE4OTk=",
  "number": 80716,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Support Container Isolation of Hugepages",
  "updated_at": "2020-01-29T15:32:15Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/80716",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/32089474?v=4",
    "events_url": "https://api.github.com/users/bg-chun/events{/privacy}",
    "followers_url": "https://api.github.com/users/bg-chun/followers",
    "following_url": "https://api.github.com/users/bg-chun/following{/other_user}",
    "gists_url": "https://api.github.com/users/bg-chun/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/bg-chun",
    "id": 32089474,
    "login": "bg-chun",
    "node_id": "MDQ6VXNlcjMyMDg5NDc0",
    "organizations_url": "https://api.github.com/users/bg-chun/orgs",
    "received_events_url": "https://api.github.com/users/bg-chun/received_events",
    "repos_url": "https://api.github.com/users/bg-chun/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/bg-chun/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bg-chun/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/bg-chun"
  }
}