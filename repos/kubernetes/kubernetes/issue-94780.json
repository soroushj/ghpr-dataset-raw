{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/24213029?v=4",
    "events_url": "https://api.github.com/users/ejweber/events{/privacy}",
    "followers_url": "https://api.github.com/users/ejweber/followers",
    "following_url": "https://api.github.com/users/ejweber/following{/other_user}",
    "gists_url": "https://api.github.com/users/ejweber/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ejweber",
    "id": 24213029,
    "login": "ejweber",
    "node_id": "MDQ6VXNlcjI0MjEzMDI5",
    "organizations_url": "https://api.github.com/users/ejweber/orgs",
    "received_events_url": "https://api.github.com/users/ejweber/received_events",
    "repos_url": "https://api.github.com/users/ejweber/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ejweber/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ejweber/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ejweber"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/24213029?v=4",
      "events_url": "https://api.github.com/users/ejweber/events{/privacy}",
      "followers_url": "https://api.github.com/users/ejweber/followers",
      "following_url": "https://api.github.com/users/ejweber/following{/other_user}",
      "gists_url": "https://api.github.com/users/ejweber/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/ejweber",
      "id": 24213029,
      "login": "ejweber",
      "node_id": "MDQ6VXNlcjI0MjEzMDI5",
      "organizations_url": "https://api.github.com/users/ejweber/orgs",
      "received_events_url": "https://api.github.com/users/ejweber/received_events",
      "repos_url": "https://api.github.com/users/ejweber/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/ejweber/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ejweber/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/ejweber"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\n\r\nCertain stress tests we run involve a large number of fibre channel persistent volumes shared amount multiple Kubernetes worker nodes. During the stress tests, any given one of these volumes may be bound by a PVC and mounted to a node, released, and bound by a different PVC and mounted to a different node. Given enough cycles (and generally the number is not that large), failures start to occur.\r\n\r\nThe first symptom of a problem is a discrepancy between \"volumesAttached\" and \"volumesInUse\" for a node. Eventually, \"volumesInUse\" grows significantly larger than \"volumesAttached\", indicating that the attach/detach controller is forcefully detaching fibre channel volumes from a node even though the node's kubelet still believes those volumes are mounted. kubecontroller-manager logs like the following confirm that this is happening:\r\n\r\n`W0911 15:57:53.571479       1 reconciler.go:232] attacherDetacher.DetachVolume started for volume \"array-00-ext-016\" (UniqueName: \"kubernetes.io/fc/[3600a098000fa354200007a975f5a5802]\") on node \"node4\" This volume is not safe to detach, but maxWaitForUnmountDuration 6m0s expired, force detaching\r\n`\r\n\r\nKubelet logs shed some light on what is happening:\r\n\r\n`\r\nI0911 15:55:16.335846  213793 reconciler.go:294] operationExecutor.UnmountDevice started for volume \"array-00-xfs-050\" (UniqueName: \"kubernetes.io/fc/[3600a098000fa354200007abe5f5a5858]\") on node \"node4\"\r\n`\r\n\r\n`\r\nW0911 15:55:16.338520  213793 mount_helper_common.go:36] Warning: Unmount skipped because path does not exist: /var/lib/kubelet/plugins/kubernetes.io/fc/3600a098000fa354200007abe5f5a5858\r\n`\r\n\r\n`\r\nI0911 15:55:16.338547  213793 fc_util.go:294] fc: DetachDisk devicePath: , dstPath: ., devices: [.]\r\n`\r\n\r\n`\r\nE0911 15:55:16.338689  213793 nestedpendingoperations.go:267] Operation for \"\\\"kubernetes.io/fc/[3600a098000fa354200007abe5f5a5858]\\\"\" failed. No retries permitted until 2020-09-11 15:55:24.338654003 +0000 UTC m=+2146.705540934 (durationBeforeRetry 8s). Error: \"UnmountDevice failed for volume \\\"array-00-xfs-050\\\" (UniqueName: \\\"kubernetes.io/fc/[3600a098000fa354200007abe5f5a5858]\\\") on node \\\"node4\\\" : fc: failed to detach disk: \\nError: fc: detachFCDisk failed. device: . err: fc detach disk: invalid device name: .\"\r\n`\r\n\r\nThe kubelet's volume manager reconcile loop is repeatedly attempting to do an UnmountDevice on the fibre channel volume in question, but something in the code is broken. DetachFCDisk never receives the name of a device to detach. It throws and error, UnmountDevice fails, and the loop continues. \r\n\r\nAfter six minutes, the attach/detach controller gives up waiting for the kubelet to unmount the volume and allows it to be attached to a different node. The volume continues to appear in one node's \"volumesInUse\" list while it also appears in another node's \"volumesAttached\" and \"volumesInUse\" list.\r\n\r\n**What you expected to happen**:\r\n\r\nDetachFCDisk should receive a device name if a fibre channel volumes is being unmounted and needs to be detached. Otherwise, DetachFCDisk should not be called, and thus not throw an error that confuses the kubelet volume manager's reconcile loop.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nThis may be difficult to reproduce, as it only seems to occur in the circumstances described above (a large number of fibre channel volumes shared by many nodes undergoing high churn). However, we will propose a simple fix that we have tested in our environment. The fix appears to eliminate the issue.\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): 1.14.3\r\n- Cloud provider or hardware configuration: bare-metal Lenovo servers\r\n- OS (e.g: `cat /etc/os-release`): CentOS Linux release 7.7.1908\r\n- Kernel (e.g. `uname -a`): 3.10.0-1062.18.1.el7.x86_64\r\n- Install tools: kubeadm\r\n",
  "closed_at": "2020-09-23T01:34:23Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/94780/comments",
  "created_at": "2020-09-14T19:06:02Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/94780/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/94780",
  "id": 701352816,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Storage.",
      "id": 169428334,
      "name": "sig/storage",
      "node_id": "MDU6TGFiZWwxNjk0MjgzMzQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/storage"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/94780/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU3MDEzNTI4MTY=",
  "number": 94780,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "DetachFCDisk fails with \"invalid device name\"",
  "updated_at": "2020-09-23T01:34:23Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/94780",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/24213029?v=4",
    "events_url": "https://api.github.com/users/ejweber/events{/privacy}",
    "followers_url": "https://api.github.com/users/ejweber/followers",
    "following_url": "https://api.github.com/users/ejweber/following{/other_user}",
    "gists_url": "https://api.github.com/users/ejweber/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ejweber",
    "id": 24213029,
    "login": "ejweber",
    "node_id": "MDQ6VXNlcjI0MjEzMDI5",
    "organizations_url": "https://api.github.com/users/ejweber/orgs",
    "received_events_url": "https://api.github.com/users/ejweber/received_events",
    "repos_url": "https://api.github.com/users/ejweber/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ejweber/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ejweber/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ejweber"
  }
}