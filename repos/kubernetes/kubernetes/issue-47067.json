{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/100893?v=4",
    "events_url": "https://api.github.com/users/justinsb/events{/privacy}",
    "followers_url": "https://api.github.com/users/justinsb/followers",
    "following_url": "https://api.github.com/users/justinsb/following{/other_user}",
    "gists_url": "https://api.github.com/users/justinsb/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/justinsb",
    "id": 100893,
    "login": "justinsb",
    "node_id": "MDQ6VXNlcjEwMDg5Mw==",
    "organizations_url": "https://api.github.com/users/justinsb/orgs",
    "received_events_url": "https://api.github.com/users/justinsb/received_events",
    "repos_url": "https://api.github.com/users/justinsb/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/justinsb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/justinsb/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/justinsb"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/100893?v=4",
      "events_url": "https://api.github.com/users/justinsb/events{/privacy}",
      "followers_url": "https://api.github.com/users/justinsb/followers",
      "following_url": "https://api.github.com/users/justinsb/following{/other_user}",
      "gists_url": "https://api.github.com/users/justinsb/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/justinsb",
      "id": 100893,
      "login": "justinsb",
      "node_id": "MDQ6VXNlcjEwMDg5Mw==",
      "organizations_url": "https://api.github.com/users/justinsb/orgs",
      "received_events_url": "https://api.github.com/users/justinsb/received_events",
      "repos_url": "https://api.github.com/users/justinsb/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/justinsb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/justinsb/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/justinsb"
    }
  ],
  "author_association": "NONE",
  "body": "<!-- Thanks for filing an issue! Before hitting the button, please answer these questions.-->\r\n\r\n**Is this a request for help?**: NO\r\n\r\n\r\n**What keywords did you search in Kubernetes issues before filing this one?**:\r\n \r\nAWS, ELB\r\n\r\n---\r\n\r\n**Is this a BUG REPORT or FEATURE REQUEST?** (choose one): BUG REPORT\r\n\r\n<!--\r\nIf this is a BUG REPORT, please:\r\n  - Fill in as much of the template below as you can.  If you leave out\r\n    information, we can't help you as well.\r\n\r\nIf this is a FEATURE REQUEST, please:\r\n  - Describe *in detail* the feature/behavior/change you'd like to see.\r\n\r\nIn both cases, be ready for followup questions, and please respond in a timely\r\nmanner.  If we can't reproduce a bug or think a feature already exists, we\r\nmight close your issue.  If we're wrong, PLEASE feel free to reopen it and\r\nexplain why.\r\n-->\r\n\r\n**Kubernetes version** (use `kubectl version`): 1.4.8 (pretty sure problem exists in master)\r\n\r\n\r\n**Environment**:\r\n- **Cloud provider or hardware configuration**: AWS\r\n- **OS** (e.g. from /etc/os-release): CoreOS 1353.7.0\r\n- **Kernel** (e.g. `uname -a`): 4.9.24\r\n- **Install tools**: Custom AMI\r\n\r\n\r\n**What happened**:\r\nThe service controller deletes and re-adds the ELB listeners when it starts up (or becomes the master).\r\n\r\n**What you expected to happen**:\r\nIt should only modify the listeners if they have actually changed.\r\n\r\n**How to reproduce it** (as minimally and precisely as possible):\r\n- Create a service with type `LoadBalancer`\r\n- Restart controller-manager after ELB has been created\r\n- Search CloudTrail for events for the ELB, and verify there are DeleteLoadBalancerListeners and CreateLoadBalancerListeners events.\r\n\r\n**Anything else we need to know**:\r\n\r\nI believe this is caused by [this for loop](https://github.com/kubernetes/kubernetes/blob/cc568f6433f2d90b30ca8e1d51f3597d60affb11/pkg/cloudprovider/providers/aws/aws_loadbalancer.go#L192-L209) in the `ensureLoadBalancer` function which compares the desired listener properties to the actual listener properties.\r\n\r\nThe problem is that K8 uses lowercase strings [1](https://github.com/kubernetes/kubernetes/blob/cc568f6433f2d90b30ca8e1d51f3597d60affb11/pkg/cloudprovider/providers/aws/aws.go#L2554), [2](https://github.com/kubernetes/kubernetes/blob/cc568f6433f2d90b30ca8e1d51f3597d60affb11/pkg/cloudprovider/providers/aws/aws_test.go#L1149) for the protocols, but AWS returns uppercase protocols when describing the listeners (see the two example outputs below).\r\n\r\nI believe the simplest fix is to lowercase the protocols in the for loop when performing the comparison, which I can submit as a PR if others agree with that solution.\r\n\r\nFrom AWS CLI:\r\n```\r\n$ aws elb describe-load-balancers --load-balancer-names a4fafa3e6f24911e6aac506402a2bc46\r\n{\r\n    \"LoadBalancerDescriptions\": [\r\n         {\r\n             \"ListenerDescriptions\": [\r\n                {\r\n                    \"Listener\": {\r\n                        \"InstancePort\": 32706, \r\n                        \"LoadBalancerPort\": 80, \r\n                        \"Protocol\": \"TCP\", \r\n                        \"InstanceProtocol\": \"TCP\"\r\n                    }, \r\n                    \"PolicyNames\": []\r\n                }\r\n            ] \r\n        }\r\n    ]\r\n}\r\n```\r\n\r\nFrom Go `elb.DescribeLoadBalancers(request)`\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"log\"\r\n\r\n\t\"github.com/aws/aws-sdk-go/aws/session\"\r\n\t\"github.com/aws/aws-sdk-go/service/elb\"\r\n)\r\n\r\nfunc main() {\r\n\tname := \"a4fafa3e6f24911e6aac506402a2bc46\"\r\n\r\n\tsess := session.Must(session.NewSession())\r\n\tsvc := elb.New(sess)\r\n\r\n\trequest := &elb.DescribeLoadBalancersInput{}\r\n\trequest.LoadBalancerNames = []*string{&name}\r\n\r\n\tresponse, err := svc.DescribeLoadBalancers(request)\r\n\tif err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n\r\n\tfor _, loadBalancer := range response.LoadBalancerDescriptions {\r\n\t\tlog.Printf(\"ELB: %v\\n\", loadBalancer)\r\n\t\treturn\r\n\t}\r\n}\r\n```\r\n\r\noutputs\r\n```\r\n2017/06/06 11:11:49 ELB: {\r\n  AvailabilityZones: [\"us-west-2a\",\"us-west-2b\",\"us-west-2c\"],\r\n  CanonicalHostedZoneNameID: \"xxx\",\r\n  CreatedTime: 2017-03-24 03:35:49.48 +0000 UTC,\r\n  DNSName: \"internal-a4fafa3e6f24911e6aac506402a2bc46-2085661947.us-west-2.elb.amazonaws.com\",\r\n  HealthCheck: {\r\n    HealthyThreshold: 2,\r\n    Interval: 10,\r\n    Target: \"TCP:32706\",\r\n    Timeout: 5,\r\n    UnhealthyThreshold: 6\r\n  },\r\n  Instances: [{\r\n      InstanceId: \"i-xxx\"\r\n    },{\r\n      InstanceId: \"i-xxx\"\r\n    },{\r\n      InstanceId: \"i-xxx\"\r\n    }],\r\n  ListenerDescriptions: [{\r\n      Listener: {\r\n        InstancePort: 32706,\r\n        InstanceProtocol: \"TCP\",\r\n        LoadBalancerPort: 80,\r\n        Protocol: \"TCP\"\r\n      }\r\n    }],\r\n  LoadBalancerName: \"a4fafa3e6f24911e6aac506402a2bc46\",\r\n  Policies: {\r\n\r\n  },\r\n  Scheme: \"internal\",\r\n  SecurityGroups: [\"sg-xxx\"],\r\n  SourceSecurityGroup: {\r\n    GroupName: \"k8s-elb-a4fafa3e6f24911e6aac506402a2bc46\",\r\n    OwnerAlias: \"xxx\"\r\n  },\r\n  Subnets: [\"subnet-xxx\",\"subnet-xxx\",\"subnet-xxx\"],\r\n  VPCId: \"vpc-xxx\"\r\n}\r\n```",
  "closed_at": "2017-06-13T17:52:09Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 7,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/47067/comments",
  "created_at": "2017-06-06T18:19:13Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/47067/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/47067",
  "id": 233980202,
  "labels": [],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/47067/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-08-26T17:22:37Z",
    "closed_issues": 1514,
    "created_at": "2017-01-19T17:41:27Z",
    "creator": {
      "avatar_url": "https://avatars0.githubusercontent.com/u/7882754?v=4",
      "events_url": "https://api.github.com/users/pwittrock/events{/privacy}",
      "followers_url": "https://api.github.com/users/pwittrock/followers",
      "following_url": "https://api.github.com/users/pwittrock/following{/other_user}",
      "gists_url": "https://api.github.com/users/pwittrock/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/pwittrock",
      "id": 7882754,
      "login": "pwittrock",
      "node_id": "MDQ6VXNlcjc4ODI3NTQ=",
      "organizations_url": "https://api.github.com/users/pwittrock/orgs",
      "received_events_url": "https://api.github.com/users/pwittrock/received_events",
      "repos_url": "https://api.github.com/users/pwittrock/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/pwittrock/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pwittrock/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/pwittrock"
    },
    "description": "",
    "due_on": "2017-06-28T07:00:00Z",
    "html_url": "https://github.com/kubernetes/kubernetes/milestone/32",
    "id": 2264750,
    "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/32/labels",
    "node_id": "MDk6TWlsZXN0b25lMjI2NDc1MA==",
    "number": 32,
    "open_issues": 0,
    "state": "closed",
    "title": "v1.7",
    "updated_at": "2019-08-26T17:22:37Z",
    "url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/32"
  },
  "node_id": "MDU6SXNzdWUyMzM5ODAyMDI=",
  "number": 47067,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Service controller deletes and re-adds AWS ELB listeners when it starts up",
  "updated_at": "2017-06-13T17:52:09Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/47067",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/436140?v=4",
    "events_url": "https://api.github.com/users/marshallbrekka/events{/privacy}",
    "followers_url": "https://api.github.com/users/marshallbrekka/followers",
    "following_url": "https://api.github.com/users/marshallbrekka/following{/other_user}",
    "gists_url": "https://api.github.com/users/marshallbrekka/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/marshallbrekka",
    "id": 436140,
    "login": "marshallbrekka",
    "node_id": "MDQ6VXNlcjQzNjE0MA==",
    "organizations_url": "https://api.github.com/users/marshallbrekka/orgs",
    "received_events_url": "https://api.github.com/users/marshallbrekka/received_events",
    "repos_url": "https://api.github.com/users/marshallbrekka/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/marshallbrekka/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/marshallbrekka/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/marshallbrekka"
  }
}