{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "At least in 1.9, 1.10 and 1.11 release what I am seeing is - vsphere volumes are not getting detached at all when a node is shutdown.  Not even when corresponding pods that are using the volumes are deleted.\r\n\r\nThe reason they are not getting detached is because - when a node is shutdown, it is removed from api-server in vsphere. But the NodeInfo map that vspehre internally maintains needs the node object for successful detach. As a result all detach operations fail with:\r\n\r\n```\r\nug 24 11:52:10 vim-master.lan atomic-openshift-master-controllers[23519]: E0824 11:52:10.198057   23519 attacher.go:274] Error detaching volume \"[datastore1] kubevols/kubernetes-dynamic-pvc-0e972db5-a7b1-11e8-a954-00505694a8ab.vmdk\": No VM found\r\nAug 24 11:52:10 vim-master.lan atomic-openshift-master-controllers[23519]: E0824 11:52:10.198074   23519 nestedpendingoperations.go:267] Operation for \"\\\"kubernetes.io/vsphere-volume/[datastore1] kubevols/kubernetes-dynamic-pvc-0e972db5-a7b1-11e8-a954-00505694a8ab.vmdk\\\"\" failed. No \r\nretries permitted until 2018-08-24 11:52:14.198065767 -0400 EDT m=+3866.556348999 (durationBeforeRetry 4s). Error: \"DetachVolume.Detach failed for volume \\\"pvc-0e972db5-a7b1-11e8-a954-00505694a8ab\\\" (UniqueName: \\\"kubernetes.io/vsphere-volume/[datastore1] kubevols/kubernetes-dynamic-\r\npvc-0e972db5-a7b1-11e8-a954-00505694a8ab.vmdk\\\") on node \\\"vim-node.lan\\\" : No VM found\"\r\nAug 24 11:52:10 vim-master.lan atomic-openshift-master-controllers[23519]: E0824 11:52:10.598712   23519 vsphere.go:980] Failed to convert volPaths to devicePaths: map[vim-node.lan:[[datastore1] kubevols/kubernetes-dynamic-pvc-dcfcb0fa-a7ae-11e8-a954-00505694a8ab.vmdk [datastore1] ku\r\nbevols/kubernetes-dynamic-pvc-0e972db5-a7b1-11e8-a954-00505694a8ab.vmdk [datastore1] kubevols/kubernetes-dynamic-pvc-178318a1-a7b1-11e8-a954-00505694a8ab.vmdk] vim-master.lan:[[datastore1] kubevols/kubernetes-dynamic-pvc-0e972db5-a7b1-11e8-a954-00505694a8ab.vmdk [datastore1] kubevols\r\n/kubernetes-dynamic-pvc-156bdc5c-a7b1-11e8-a954-00505694a8ab.vmdk [datastore1] kubevols/kubernetes-dynamic-pvc-178318a1-a7b1-11e8-a954-00505694a8ab.vmdk [datastore1] kubevols/kubernetes-dynamic-pvc-19a4a77a-a7b1-11e8-a954-00505694a8ab.vmdk]]. err: No VM found\r\nAug 24 11:52:10 vim-master.lan atomic-openshift-master-controllers[23519]: E0824 11:52:10.598727   23519 attacher.go:130] Error checking if volumes are attached to nodes: map[vim-node.lan:[[datastore1] kubevols/kubernetes-dynamic-pvc-dcfcb0fa-a7ae-11e8-a954-00505694a8ab.vmdk [datasto\r\nre1] kubevols/kubernetes-dynamic-pvc-0e972db5-a7b1-11e8-a954-00505694a8ab.vmdk [datastore1] kubevols/kubernetes-dynamic-pvc-178318a1-a7b1-11e8-a954-00505694a8ab.vmdk] vim-master.lan:[[datastore1] kubevols/kubernetes-dynamic-pvc-0e972db5-a7b1-11e8-a954-00505694a8ab.vmdk [datastore1] k\r\nubevols/kubernetes-dynamic-pvc-156bdc5c-a7b1-11e8-a954-00505694a8ab.vmdk [datastore1] kubevols/kubernetes-dynamic-pvc-178318a1-a7b1-11e8-a954-00505694a8ab.vmdk [datastore1] kubevols/kubernetes-dynamic-pvc-19a4a77a-a7b1-11e8-a954-00505694a8ab.vmdk]]. err: No VM found\r\nAug 24 11:52:14 vim-master.lan atomic-openshift-master-controllers[23519]: W0824 11:52:14.205293   23519 reconciler.go:235] attacherDetacher.DetachVolume started for volume \"pvc-0e972db5-a7b1-11e8-a954-00505694a8ab\" (UniqueName: \"kubernetes.io/vsphere-volume/[datastore1] kubevols/kub\r\nernetes-dynamic-pvc-0e972db5-a7b1-11e8-a954-00505694a8ab.vmdk\") on node \"vim-node.lan\" This volume is not safe to detach, but maxWaitForUnmountDuration 6m0s expired, force detaching\r\nAug 24 11:52:14 vim-master.lan atomic-openshift-master-controllers[23519]: E0824 11:52:14.209454   23519 attacher.go:260] Error checking if volume (\"[datastore1] kubevols/kubernetes-dynamic-pvc-0e972db5-a7b1-11e8-a954-00505694a8ab.vmdk\") is already attached to current node (\"vim-node\r\n.lan\"). Will continue and try detach anyway. err=No VM found\r\n```\r\n/sig storage\r\n",
  "closed_at": "2018-11-10T16:24:31Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/278?v=4",
    "events_url": "https://api.github.com/users/gnufied/events{/privacy}",
    "followers_url": "https://api.github.com/users/gnufied/followers",
    "following_url": "https://api.github.com/users/gnufied/following{/other_user}",
    "gists_url": "https://api.github.com/users/gnufied/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/gnufied",
    "id": 278,
    "login": "gnufied",
    "node_id": "MDQ6VXNlcjI3OA==",
    "organizations_url": "https://api.github.com/users/gnufied/orgs",
    "received_events_url": "https://api.github.com/users/gnufied/received_events",
    "repos_url": "https://api.github.com/users/gnufied/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/gnufied/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gnufied/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/gnufied"
  },
  "comments": 19,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/67900/comments",
  "created_at": "2018-08-27T15:13:11Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/67900/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/67900",
  "id": 354360232,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Issues or PRs related to vmware provider",
      "id": 874113778,
      "name": "area/provider/vmware",
      "node_id": "MDU6TGFiZWw4NzQxMTM3Nzg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/provider/vmware"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Storage.",
      "id": 169428334,
      "name": "sig/storage",
      "node_id": "MDU6TGFiZWwxNjk0MjgzMzQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/storage"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/67900/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzNTQzNjAyMzI=",
  "number": 67900,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "vsphere cloudprovider does not attempt to detach volumes from shutdown nodes",
  "updated_at": "2018-11-10T16:24:31Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/67900",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/278?v=4",
    "events_url": "https://api.github.com/users/gnufied/events{/privacy}",
    "followers_url": "https://api.github.com/users/gnufied/followers",
    "following_url": "https://api.github.com/users/gnufied/following{/other_user}",
    "gists_url": "https://api.github.com/users/gnufied/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/gnufied",
    "id": 278,
    "login": "gnufied",
    "node_id": "MDQ6VXNlcjI3OA==",
    "organizations_url": "https://api.github.com/users/gnufied/orgs",
    "received_events_url": "https://api.github.com/users/gnufied/received_events",
    "repos_url": "https://api.github.com/users/gnufied/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/gnufied/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gnufied/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/gnufied"
  }
}