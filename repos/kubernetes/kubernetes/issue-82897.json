{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/40361897?v=4",
    "events_url": "https://api.github.com/users/ahg-g/events{/privacy}",
    "followers_url": "https://api.github.com/users/ahg-g/followers",
    "following_url": "https://api.github.com/users/ahg-g/following{/other_user}",
    "gists_url": "https://api.github.com/users/ahg-g/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ahg-g",
    "id": 40361897,
    "login": "ahg-g",
    "node_id": "MDQ6VXNlcjQwMzYxODk3",
    "organizations_url": "https://api.github.com/users/ahg-g/orgs",
    "received_events_url": "https://api.github.com/users/ahg-g/received_events",
    "repos_url": "https://api.github.com/users/ahg-g/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ahg-g/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ahg-g/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ahg-g"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/40361897?v=4",
      "events_url": "https://api.github.com/users/ahg-g/events{/privacy}",
      "followers_url": "https://api.github.com/users/ahg-g/followers",
      "following_url": "https://api.github.com/users/ahg-g/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahg-g/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/ahg-g",
      "id": 40361897,
      "login": "ahg-g",
      "node_id": "MDQ6VXNlcjQwMzYxODk3",
      "organizations_url": "https://api.github.com/users/ahg-g/orgs",
      "received_events_url": "https://api.github.com/users/ahg-g/received_events",
      "repos_url": "https://api.github.com/users/ahg-g/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/ahg-g/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahg-g/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/ahg-g"
    }
  ],
  "author_association": "MEMBER",
  "body": "**What would you like to be added**:\r\nAn interface that allows PreFilter plugins to update their state after PreFilter was called, similar to what we have for [predicates metadata (add/remove pods)](https://github.com/kubernetes/kubernetes/blob/master/pkg/scheduler/algorithm/predicates/metadata.go#L38-L41).\r\n\r\n**Why is this needed**:\r\nThis is needed to allow efficient preemption simulations: during preemption, we remove/add pods from each node before running the filter plugins again to evaluate whether removing/adding specific pods will allow the incoming pod to be scheduled on the node. \r\n\r\nRoughly, a scheduling cycle with preemption works as follows (function names in the pseudo code below are made up):\r\n\r\n- meta = ProduceMetadata(pod, nodes)\r\n- For each nodeInfo in nodes\r\n  - RunAllPredicates(pod, nodeInfo, meta)\r\n- If preemption\r\n  - for each nodeInfo in nodes   *// actual logic is in [selectVictimsOnNode](https://github.com/kubernetes/kubernetes/blob/master///pkg/scheduler/core/generic_scheduler.go#L1088:28)*\r\n       - nodeInfoCopy, victimPods = RemoveLowerPriorityPods(nodeInfo)\r\n       - metaCopy = meta\r\n       - **metaCopy.RemovePods(victimPods)**\r\n       - RunAllPredicates(pod, nodeInfoCopy, metadataCopy)\r\n\r\nA number of predicates that we plan to migrate produce metadata, the most important of which are pod affinity and even pod spreading. The current predicate metadata interface requires implementing APIs for [adding and removing pods](https://github.com/kubernetes/kubernetes/blob/master/pkg/scheduler/algorithm/predicates/metadata.go#L38-L41).\r\n\r\nIn the scheduling framework, PreFilters will be used to compute what we currently call [predicate metadata](https://github.com/kubernetes/kubernetes/blob/master/pkg/scheduler/algorithm/predicates/metadata.go) in the scheduler, but the preemption logic currently have no way to call the plugin again to modify that state, and so we have two options:\r\n\r\n**Option 1**: Call PreFilter again \r\n- pros: \r\n  - does not require changes to the framework\r\n- cons:\r\n  - harder to migrate current predicates because that is not how predicate metadata works\r\n  - performance regression\r\n  - change PreFilter semantics to indicate that it can be called multiple times on the same PluginContext and pod, making PreFilter trickier to implement.\r\n\r\n**Option 2**: Allow PreFilter plugins to implement APIs to make incremental updates to its pre-computed state.\r\n- pros: \r\n  - easier to migrate current predicates\r\n  - no performance regression\r\n  - no changes to PreFilter semantics, stays simple.\r\n- cons:\r\n  - need to add more logic to the framework core.\r\n\r\n\r\nI suggest we go with option 2. Specifically, add two optional APIs to PreFilter, namely ```AddPod``` and ```RemovePod```.  By optional I mean similar to what we did for NormalizeScore API in Score Plugins.\r\n\r\n/assign\r\n/sig scheduling",
  "closed_at": "2019-09-25T18:06:42Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 14,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/82897/comments",
  "created_at": "2019-09-19T19:54:23Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/82897/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/82897",
  "id": 495996361,
  "labels": [
    {
      "color": "c7def8",
      "default": false,
      "description": "Categorizes issue or PR as related to a new feature.",
      "id": 267761362,
      "name": "kind/feature",
      "node_id": "MDU6TGFiZWwyNjc3NjEzNjI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/feature"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Scheduling.",
      "id": 125550211,
      "name": "sig/scheduling",
      "node_id": "MDU6TGFiZWwxMjU1NTAyMTE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/scheduling"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/82897/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0OTU5OTYzNjE=",
  "number": 82897,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "A new API for updating prefilter calculations",
  "updated_at": "2019-09-25T18:06:42Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/82897",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/40361897?v=4",
    "events_url": "https://api.github.com/users/ahg-g/events{/privacy}",
    "followers_url": "https://api.github.com/users/ahg-g/followers",
    "following_url": "https://api.github.com/users/ahg-g/following{/other_user}",
    "gists_url": "https://api.github.com/users/ahg-g/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ahg-g",
    "id": 40361897,
    "login": "ahg-g",
    "node_id": "MDQ6VXNlcjQwMzYxODk3",
    "organizations_url": "https://api.github.com/users/ahg-g/orgs",
    "received_events_url": "https://api.github.com/users/ahg-g/received_events",
    "repos_url": "https://api.github.com/users/ahg-g/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ahg-g/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ahg-g/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ahg-g"
  }
}