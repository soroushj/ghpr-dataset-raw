{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "This issue was reported in the [Kubernetes Security Audit Report](https://github.com/kubernetes/community/blob/master/wg-security-audit/findings/Kubernetes%20Final%20Report.pdf)\r\n\r\n**Description**\r\nKubernetes can be configured to use iSCSI volumes. When using CHAP authentication, CHAP secrets are stored using the Secrets API, such as in this [example configuration](https://github.com/kubernetes/examples/blob/master/volumes/iscsi/chap-secret.yaml). When a pod is configured to use iSCSI and the AttachDisk method is called, this will call the code in Figure 1.\r\n\r\nkubernetes/pkg/volume/iscsi/iscsi_util.go:\r\n```\r\nvar (\r\n\tchapSt = []string{\r\n\t\t\"discovery.sendtargets.auth.username\",\r\n\t\t\"discovery.sendtargets.auth.password\",\r\n\t\t\"discovery.sendtargets.auth.username_in\",\r\n\t\t\"discovery.sendtargets.auth.password_in\"}\r\n\tchapSess = []string{\r\n\t\t\"node.session.auth.username\",\r\n\t\t\"node.session.auth.password\",\r\n\t\t\"node.session.auth.username_in\",\r\n\t\t\"node.session.auth.password_in\"}\r\n\tifaceTransportNameRe = regexp.MustCompile(`iface.transport_name = (.*)\\n`)\r\n\tifaceRe              = regexp.MustCompile(`.+/iface-([^/]+)/.+`)\r\n)\r\n\r\nfunc updateISCSIDiscoverydb(b iscsiDiskMounter, tp string) error {\r\n\tif !b.chapDiscovery {\r\n\t\treturn nil\r\n\t}\r\n\tout, err := b.exec.Run(\"iscsiadm\", \"-m\", \"discoverydb\", \"-t\", \"sendtargets\", \"-p\", tp, \"-I\", b.Iface, \"-o\", \"update\", \"-n\", \"discovery.sendtargets.auth.authmethod\", \"-v\", \"CHAP\")\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"iscsi: failed to update discoverydb with CHAP, output: %v\", string(out))\r\n\t}\r\n\r\n\tfor _, k := range chapSt {\r\n\t\tv := b.secret[k]\r\n\t\tif len(v) > 0 {\r\n\t\t\tout, err := b.exec.Run(\"iscsiadm\", \"-m\", \"discoverydb\", \"-t\", \"sendtargets\", \"-p\", tp, \"-I\", b.Iface, \"-o\", \"update\", \"-n\", k, \"-v\", v)\r\n\t\t\tif err != nil {\r\n\t\t\t\treturn fmt.Errorf(\"iscsi: failed to update discoverydb key %q with value %q error: %v\", k, v, string(out))\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn nil\r\n}\r\n\r\nfunc updateISCSINode(b iscsiDiskMounter, tp string) error {\r\n\tif !b.chapSession {\r\n\t\treturn nil\r\n\t}\r\n\r\n\tout, err := b.exec.Run(\"iscsiadm\", \"-m\", \"node\", \"-p\", tp, \"-T\", b.Iqn, \"-I\", b.Iface, \"-o\", \"update\", \"-n\", \"node.session.auth.authmethod\", \"-v\", \"CHAP\")\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"iscsi: failed to update node with CHAP, output: %v\", string(out))\r\n\t}\r\n\r\n\tfor _, k := range chapSess {\r\n\t\tv := b.secret[k]\r\n\t\tif len(v) > 0 {\r\n\t\t\tout, err := b.exec.Run(\"iscsiadm\", \"-m\", \"node\", \"-p\", tp, \"-T\", b.Iqn, \"-I\", b.Iface, \"-o\", \"update\", \"-n\", k, \"-v\", v)\r\n\t\t\tif err != nil {\r\n\t\t\t\treturn fmt.Errorf(\"iscsi: failed to update node session key %q with value %q error: %v\", k, v, string(out))\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn nil\r\n}\r\n\r\n```\r\nFigure 19.1: iSCSI secret handling\r\n\r\nThese two functions both iterate over a slice of strings that are keys that reference secrets in a map. These are then used to generate iscsiadm commands. As shown, if there are errors in executing these commands, errors are returned with both the key and secret values in the error string. These errors will eventually be logged using klog:\r\n```\r\niflastErr != nil{\r\n klog. Errorf ( \"iscsi: last error occurred during iscsi init:\\n %v \" , lastErr)\r\n}\r\n```\r\nSomeone with access to these logs would be able to view the sensitive secrets and could potentially gain access to iSCSI volumes.\r\n\r\n**Exploit Scenario**\r\nAlice runs a cluster, and wishes to use iSCSI for data storage. Eve has access sufficient to collect the logs, and uses this access to connect to iSCSI storage devices as a privileged user.\r\n\r\n**Recommendation**\r\nShort term, as in TOB-K8S-001: Bearer tokens revealed in logs, do not log sensitive credentials at any logging level, as they may accidentally leak into inappropriate environments, such as production.\r\n\r\nLong term, implement policies that enforce code review to ensure that sensitive data is not exposed in logs, or implement logging filters that check for sensitive data and remove it prior to reification within logs. In either case, ensure that sensitive data cannot be stored in logs.\r\n\r\n**Anything else we need to know?**:\r\n\r\nSee #81146 for current status of all issues created from these findings.\r\n\r\nThe vendor gave this issue an ID of ATR-K8S-003 and it was finding 22 of the report.\r\n\r\nThe vendor considers this issue Medium Severity.\r\n\r\nTo view the original finding, begin on page 61 of the [Kubernetes Security Review Report](https://github.com/kubernetes/community/blob/master/wg-security-audit/findings/Kubernetes%20Final%20Report.pdf)\r\n\r\n**Environment**:\r\n\r\n- Kubernetes version: 1.13.4",
  "closed_at": "2019-08-14T10:28:39Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/81130/comments",
  "created_at": "2019-08-08T02:04:09Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/81130/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/81130",
  "id": 478214086,
  "labels": [
    {
      "color": "d93f0b",
      "default": false,
      "description": null,
      "id": 116712923,
      "name": "area/security",
      "node_id": "MDU6TGFiZWwxMTY3MTI5MjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/security"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Must be staffed and worked on either currently, or very soon, ideally in time for the next release.",
      "id": 114528223,
      "name": "priority/important-soon",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyMjM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-soon"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Storage.",
      "id": 169428334,
      "name": "sig/storage",
      "node_id": "MDU6TGFiZWwxNjk0MjgzMzQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/storage"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to WG Security Audit.",
      "id": 1086787146,
      "name": "wg/security-audit",
      "node_id": "MDU6TGFiZWwxMDg2Nzg3MTQ2",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/wg/security-audit"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/81130/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NzgyMTQwODY=",
  "number": 81130,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "ATR-K8S-003: iSCSI volume storage cleartext secrets in logs",
  "updated_at": "2019-08-14T10:28:39Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/81130",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/419708?v=4",
    "events_url": "https://api.github.com/users/cji/events{/privacy}",
    "followers_url": "https://api.github.com/users/cji/followers",
    "following_url": "https://api.github.com/users/cji/following{/other_user}",
    "gists_url": "https://api.github.com/users/cji/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/cji",
    "id": 419708,
    "login": "cji",
    "node_id": "MDQ6VXNlcjQxOTcwOA==",
    "organizations_url": "https://api.github.com/users/cji/orgs",
    "received_events_url": "https://api.github.com/users/cji/received_events",
    "repos_url": "https://api.github.com/users/cji/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/cji/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cji/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/cji"
  }
}