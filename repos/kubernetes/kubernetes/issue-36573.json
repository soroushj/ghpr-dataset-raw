{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Is this a request for help?** No\r\n\r\n\r\n**What keywords did you search in Kubernetes issues before filing this one?** http proxy, http_proxy, https_proxy, AWS, kubeadm, kubectl, cloud-provider\r\n\r\n---\r\n\r\n**Is this a BUG REPORT or FEATURE REQUEST?** (choose one): BUG REPORT\r\n\r\n**Kubernetes version** (use `kubectl version`): v1.4.4\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"4\", GitVersion:\"v1.4.4\", GitCommit:\"3b417cc4ccd1b8f38ff9ec96bb50a81ca0ea9d56\", GitTreeState:\"clean\", BuildDate:\"2016-10-21T02:48:38Z\", GoVersion:\"go1.6.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"4\", GitVersion:\"v1.4.4\", GitCommit:\"3b417cc4ccd1b8f38ff9ec96bb50a81ca0ea9d56\", GitTreeState:\"clean\", BuildDate:\"2016-10-21T02:42:39Z\", GoVersion:\"go1.6.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n\r\nkubeadm version: version.Info{Major:\"1\", Minor:\"5+\", GitVersion:\"v1.5.0-alpha.2.421+a6bea3d79b8bba\", GitCommit:\"a6bea3d79b8bbaa5e8b57482c9fff9265d402708\", GitTreeState:\"clean\", BuildDate:\"2016-11-03T06:54:50Z\", GoVersion:\"go1.7.1\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n\r\n\r\n**Environment**:\r\n- **Cloud provider or hardware configuration**: kubeadm on EC2 instances on AWS\r\n- **OS** (e.g. from /etc/os-release): Ubuntu 16.04.1 LTS\r\n- **Kernel** (e.g. `uname -a`): Linux ip-10-0-133-99 4.4.0-45-generic #66-Ubuntu SMP Wed Oct 19 14:12:37 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\r\n- **Install tools**: kubeadm\r\n- **Others**: _http_proxy_, _https_proxy_ and _no_proxy_ set in /etc/environment, Docker config as well on startup scripts that run `kubeadm init`\r\n\r\n\r\n**What happened**:\r\n`kubeadm init --cloud-provider aws` won't complete and gets stuck on it's first deployment.  When one looks through the logs it shows that the pods are downloading fine but we are stuck due to the kube-controller-manager continually crashing as it can't contact AWS.  Elsewhere in kubernetes I see references to `http.ProxyFromEnvironment` and if the AWS cloud provider could use that it would be able to connect as well.  From the POD if I manually set http_proxy and https_proxy and no_proxy I am able to use the AWS CLI without any issues.\r\n\r\n```\r\nroot@ip-10-2-221-240:/home/ubuntu# kubectl logs kube-controller-manager-ip-10-2-221-240 --namespace=kube-system\r\nE1108 13:58:14.493903       1 event.go:258] Could not construct reference to: '&api.Endpoints{TypeMeta:unversioned.TypeMeta{Kind:\"\", APIVersion:\"\"}, ObjectMeta:api.ObjectMeta{Name:\"kube-controller-manager\", GenerateName:\"\", Namespace:\"kube-system\", SelfLink:\"\", UID:\"\", ResourceVersion:\"\", Generation:0, CreationTimestamp:unversioned.Time{Time:time.Time{sec:0, nsec:0, loc:(*time.Location)(nil)}}, DeletionTimestamp:(*unversioned.Time)(nil), DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string(nil), Annotations:map[string]string(nil), OwnerReferences:[]api.OwnerReference(nil), Finalizers:[]string(nil), ClusterName:\"\"}, Subsets:[]api.EndpointSubset(nil)}' due to: 'selfLink was empty, can't make reference'. Will not report event: 'Normal' '%v became leader' 'ip-10-2-221-240'\r\nI1108 13:58:14.494179       1 leaderelection.go:214] sucessfully acquired lease kube-system/kube-controller-manager\r\nI1108 13:58:14.499388       1 aws.go:745] Building AWS cloudprovider\r\nI1108 13:58:14.499484       1 aws.go:699] Zone not specified in configuration file; querying AWS metadata service\r\nI1108 13:58:14.499651       1 replication_controller.go:219] Starting RC Manager\r\nI1108 13:58:14.605138       1 endpoints_controller.go:326] Waiting for pods controller to sync, requeuing service default/kubernetes`\r\n\r\n[10:25]  \r\nI1108 15:24:09.602100       1 endpoints_controller.go:326] Waiting for pods controller to sync, requeuing service default/kubernetes\r\nI1108 15:24:09.602100       1 endpoints_controller.go:326] Waiting for pods controller to sync, requeuing service default/kubernetes\r\nI1108 15:24:09.602100       1 endpoints_controller.go:326] Waiting for pods controller to sync, requeuing service default/kubernetes\r\nI1108 15:24:09.602100       1 endpoints_controller.go:326] Waiting for pods controller to sync, requeuing service default/kubernetes\r\n....\r\nF1108 15:24:09.625221       1 controllermanager.go:227] Cloud provider could not be initialized: could not init cloud provider \"aws\": error finding instance i-052a60ad4cc805154: error listing AWS instances: RequestError: send request failed\r\ncaused by: Post https://ec2.us-west-1.amazonaws.com/: dial tcp 176.32.118.53:443: i/o timeout\r\n```\r\n\r\n**What you expected to happen**:\r\nI would expect `kubeadm init --cloud-provider aws` to successfully complete and use the environment proxies set up on the system so as not to depend on a default Internet Gateway being connected to the VPC just for AWS access.\r\n\r\n**How to reproduce it** (as minimally and precisely as possible):\r\n- Set up a public VPC with Squid set up as a proxy\r\n- Set up a private VPC peered to the public VPC\r\n- Set up a master node and run `kubeadm init --cloud-provider aws`\r\n- Set up a regular node and run `kubeadm join`\r\n\r\n`kubeadm` will never fully initialize.  If you remove the --cloud-provider aws` then it will complete and nodes will register.\r\n\r\n**Anything else do we need to know**:\r\n\r\n",
  "closed_at": "2016-11-22T17:42:26Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1787169?v=4",
    "events_url": "https://api.github.com/users/mikedanese/events{/privacy}",
    "followers_url": "https://api.github.com/users/mikedanese/followers",
    "following_url": "https://api.github.com/users/mikedanese/following{/other_user}",
    "gists_url": "https://api.github.com/users/mikedanese/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mikedanese",
    "id": 1787169,
    "login": "mikedanese",
    "node_id": "MDQ6VXNlcjE3ODcxNjk=",
    "organizations_url": "https://api.github.com/users/mikedanese/orgs",
    "received_events_url": "https://api.github.com/users/mikedanese/received_events",
    "repos_url": "https://api.github.com/users/mikedanese/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mikedanese/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mikedanese/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mikedanese"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/36573/comments",
  "created_at": "2016-11-10T11:57:22Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/36573/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/36573",
  "id": 188489788,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 451459590,
      "name": "area/kubeadm",
      "node_id": "MDU6TGFiZWw0NTE0NTk1OTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/kubeadm"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/36573/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxODg0ODk3ODg=",
  "number": 36573,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kube-controller-manager with AWS cloud provider crash loop if using http_proxy using \"kubeadm init --cloud-provider aws\"",
  "updated_at": "2016-11-22T17:42:26Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/36573",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/2229703?v=4",
    "events_url": "https://api.github.com/users/druidsbane/events{/privacy}",
    "followers_url": "https://api.github.com/users/druidsbane/followers",
    "following_url": "https://api.github.com/users/druidsbane/following{/other_user}",
    "gists_url": "https://api.github.com/users/druidsbane/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/druidsbane",
    "id": 2229703,
    "login": "druidsbane",
    "node_id": "MDQ6VXNlcjIyMjk3MDM=",
    "organizations_url": "https://api.github.com/users/druidsbane/orgs",
    "received_events_url": "https://api.github.com/users/druidsbane/received_events",
    "repos_url": "https://api.github.com/users/druidsbane/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/druidsbane/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/druidsbane/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/druidsbane"
  }
}