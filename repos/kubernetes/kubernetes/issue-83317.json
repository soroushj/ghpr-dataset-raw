{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\n\r\nMy k8s version is 1.15.\r\nI want my static pods which are not in \"kube-system\" won't be evicted when diskPressure.\r\nI found that after PR: https://github.com/kubernetes/kubernetes/pull/80491/files ,  static pods should not be evicted when diskPressure.\r\nI won't update to 1.16 temporarily.\r\nSo I cherry-picked this commit: c05d5060193221dd5ebcf031d2b2708af5d00c5f to my kubelet.\r\n\r\nBut when I did some tests, I found that this commit doesn't work when diskPressure.\r\nI think the reason is like info in this comment: https://github.com/kubernetes/kubernetes/issues/73572#issuecomment-470444663\r\n\r\n\r\n\r\ndetail:\r\n\r\nWhen diskPressure , the pod sent to `IsCriticalPod` is a mirrorPod.(`pkg/kubelet/eviction/eviction_manager.go#evictPod`).\r\n\r\nWhen a mirrorPod list-watched by kubelet, the `annotation[kubernetes.io/config.source]` is set to be the source that kubelet list-watch the pod from, which is `\"api\"`. (`pkg/kubelet/config/config.go#updatePodsFunc`)\r\n\r\nBecause the `annotation[kubernetes.io/config.source]` of  mirrorPod is `\"api\"`, the func `\"pkg/kubelet/types/pod_update.go#IsStaticPod\"` returns `false`. \r\nSo static pods will be evicted when diskPressure.\r\n\r\nI thought how to fix it.\r\nThe func `\"pkg/kubelet/types/pod_update.go#IsCriticalPod\"` deals with staticPod and mirrorPod in different scene. \r\nSo I changed my kubelet to add the verifying of mirrorPod after the verifying of staticPod.\r\njust like this(My original code is k8s1.15 cherry-pick c05d5060193221dd5ebcf031d2b2708af5d00c5f, so it looks strange.):\r\n```go\r\nfunc IsCriticalPod(pod *v1.Pod) bool {\r\n\tif IsStaticPod(pod) {\r\n\t\treturn true\r\n\t}\r\n\tif IsMirrorPod(pod) {\r\n\t\treturn true\r\n\t}\r\n\tif utilfeature.DefaultFeatureGate.Enabled(features.PodPriority) {\r\n\t\tif pod.Spec.Priority != nil && IsCriticalPodBasedOnPriority(*pod.Spec.Priority) {\r\n\t\t\treturn true\r\n\t\t}\r\n\t}\r\n\tif utilfeature.DefaultFeatureGate.Enabled(features.ExperimentalCriticalPodAnnotation) {\r\n\t\tif IsCritical(pod.Namespace, pod.Annotations) {\r\n\t\t\treturn true\r\n\t\t}\r\n\t}\r\n\treturn false\r\n}\r\n```\r\n\r\nAfter I changed my code to this, static pod didn't be evicted when diskPressure.\r\nSo I think this is the reason. And I think this is a Bug.\r\n\r\nMaybe I will set `pod.Spec.Priority` to my static pods to prevent eviction temporarily, and I also hope this bug will be fixed in a good way.\r\n\r\n**What you expected to happen**:\r\nStatic pods won't be evicted when diskPressure.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n1. Run a static pod on a node. The pod is not set `pod.Spec.Priority` or `pod.Spec.PriorityClassName`. \r\n2. Let the node under diskPressure (using `fallocate -l 104G file1`).\r\n\r\nThen the static pod will be evicted.\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): My kubelet is k8s1.15  cherry-pick c05d5060193221dd5ebcf031d2b2708af5d00c5f.\r\n- Cloud provider or hardware configuration:\r\n- OS (e.g: `cat /etc/os-release`):\r\n- Kernel (e.g. `uname -a`):\r\n- Install tools:\r\n- Network plugin and version (if this is a network-related bug):\r\n- Others:\r\n",
  "closed_at": "2019-10-08T05:15:42Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83317/comments",
  "created_at": "2019-09-30T11:05:59Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83317/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/83317",
  "id": 500205927,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Apps.",
      "id": 404091735,
      "name": "sig/apps",
      "node_id": "MDU6TGFiZWw0MDQwOTE3MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/apps"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Cluster Lifecycle.",
      "id": 173494222,
      "name": "sig/cluster-lifecycle",
      "node_id": "MDU6TGFiZWwxNzM0OTQyMjI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cluster-lifecycle"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Node.",
      "id": 173493665,
      "name": "sig/node",
      "node_id": "MDU6TGFiZWwxNzM0OTM2NjU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/node"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Usability.",
      "id": 1476695221,
      "name": "sig/usability",
      "node_id": "MDU6TGFiZWwxNDc2Njk1MjIx",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/usability"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83317/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MDAyMDU5Mjc=",
  "number": 83317,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Static pods be evicted when diskPressure. Commit c05d506 doesn't seem to work.",
  "updated_at": "2020-01-08T12:41:07Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/83317",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/15603988?v=4",
    "events_url": "https://api.github.com/users/KeepTheBeats/events{/privacy}",
    "followers_url": "https://api.github.com/users/KeepTheBeats/followers",
    "following_url": "https://api.github.com/users/KeepTheBeats/following{/other_user}",
    "gists_url": "https://api.github.com/users/KeepTheBeats/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/KeepTheBeats",
    "id": 15603988,
    "login": "KeepTheBeats",
    "node_id": "MDQ6VXNlcjE1NjAzOTg4",
    "organizations_url": "https://api.github.com/users/KeepTheBeats/orgs",
    "received_events_url": "https://api.github.com/users/KeepTheBeats/received_events",
    "repos_url": "https://api.github.com/users/KeepTheBeats/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/KeepTheBeats/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/KeepTheBeats/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/KeepTheBeats"
  }
}