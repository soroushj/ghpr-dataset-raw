{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/980082?v=4",
    "events_url": "https://api.github.com/users/liggitt/events{/privacy}",
    "followers_url": "https://api.github.com/users/liggitt/followers",
    "following_url": "https://api.github.com/users/liggitt/following{/other_user}",
    "gists_url": "https://api.github.com/users/liggitt/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/liggitt",
    "id": 980082,
    "login": "liggitt",
    "node_id": "MDQ6VXNlcjk4MDA4Mg==",
    "organizations_url": "https://api.github.com/users/liggitt/orgs",
    "received_events_url": "https://api.github.com/users/liggitt/received_events",
    "repos_url": "https://api.github.com/users/liggitt/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/liggitt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/liggitt/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/liggitt"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/980082?v=4",
      "events_url": "https://api.github.com/users/liggitt/events{/privacy}",
      "followers_url": "https://api.github.com/users/liggitt/followers",
      "following_url": "https://api.github.com/users/liggitt/following{/other_user}",
      "gists_url": "https://api.github.com/users/liggitt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/liggitt",
      "id": 980082,
      "login": "liggitt",
      "node_id": "MDQ6VXNlcjk4MDA4Mg==",
      "organizations_url": "https://api.github.com/users/liggitt/orgs",
      "received_events_url": "https://api.github.com/users/liggitt/received_events",
      "repos_url": "https://api.github.com/users/liggitt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/liggitt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/liggitt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/liggitt"
    },
    {
      "avatar_url": "https://avatars1.githubusercontent.com/u/2566352?v=4",
      "events_url": "https://api.github.com/users/answer1991/events{/privacy}",
      "followers_url": "https://api.github.com/users/answer1991/followers",
      "following_url": "https://api.github.com/users/answer1991/following{/other_user}",
      "gists_url": "https://api.github.com/users/answer1991/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/answer1991",
      "id": 2566352,
      "login": "answer1991",
      "node_id": "MDQ6VXNlcjI1NjYzNTI=",
      "organizations_url": "https://api.github.com/users/answer1991/orgs",
      "received_events_url": "https://api.github.com/users/answer1991/received_events",
      "repos_url": "https://api.github.com/users/answer1991/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/answer1991/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/answer1991/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/answer1991"
    },
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/2823529?v=4",
      "events_url": "https://api.github.com/users/caesarxuchao/events{/privacy}",
      "followers_url": "https://api.github.com/users/caesarxuchao/followers",
      "following_url": "https://api.github.com/users/caesarxuchao/following{/other_user}",
      "gists_url": "https://api.github.com/users/caesarxuchao/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/caesarxuchao",
      "id": 2823529,
      "login": "caesarxuchao",
      "node_id": "MDQ6VXNlcjI4MjM1Mjk=",
      "organizations_url": "https://api.github.com/users/caesarxuchao/orgs",
      "received_events_url": "https://api.github.com/users/caesarxuchao/received_events",
      "repos_url": "https://api.github.com/users/caesarxuchao/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/caesarxuchao/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/caesarxuchao/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/caesarxuchao"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "**What happened**:\r\n\r\nRecently we found that kube-apiserver will leak(or we can call it backlog) goruntine in large-scale scene with lots of 504 response code. \r\n\r\nRelated issue #78766 \r\n\r\n**What you expected to happen**:\r\n\r\nFix the goruntine leak issue. Make admission and calling webhooks context-aware. \r\n\r\nWe need provider a method to get the request context from [admission.Attributes](https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/interfaces.go#L29). With this method, admission can stop logical processing immediatelly and quit webhook calling if the context ends.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nWe found that there is no context-aware method to cancel the admission and calling the webhooks. As we know, the kube-apiserver handler is wrapper with [timeout filter](https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/server/filters/timeout.go) and put the logical process(in which apiserver admission and call webhooks) in another goruntine, then if the request timeout or the client close the request, the logical process goruntine will not quit until the admission and calling webhooks finished.\r\n\r\ngoruntine backlog examples:\r\n\r\n* call mutating webhook cost a long time\r\n\r\nThe webhook create context itself, and does not get the context from request. The context will never be cancled until the webhook server responses. And the timeout filter wrappered goruntine will not quit until the webhook request finished. Think about in large-scale sence, the webhook server performance will influence the apiserver goruntine backlog.\r\n\r\nCode at [staging/src/k8s.io/apiserver/pkg/admission/plugin/webhook/generic/webhook.go#L21](https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/plugin/webhook/generic/webhook.go#L215)\r\n\r\n```go\r\nfunc (a *Webhook) Dispatch(attr admission.Attributes, o admission.ObjectInterfaces) error {\r\n\tif rules.IsWebhookConfigurationResource(attr) {\r\n\t\treturn nil\r\n\t}\r\n\tif !a.WaitForReady() {\r\n\t\treturn admission.NewForbidden(attr, fmt.Errorf(\"not yet ready to handle request\"))\r\n\t}\r\n\thooks := a.hookSource.Webhooks()\r\n\t// TODO: Figure out if adding one second timeout make sense here.\r\n\tctx := context.TODO()\r\n\r\n\treturn a.dispatcher.Dispatch(ctx, attr, o, hooks)\r\n}\r\n```\r\n\r\n\r\n* admission cost a long time:\r\n\r\nThink about if the clients create request with timeout 1s, and admission need to cost 2s or in worst case cost 10s because the informer can not be ready for a long time(apiserver itself has already been overloaded).\r\n\r\nThen think about in large-scale sence, if the clients re-try their requests immediately when timeout.\r\n\r\n```go\r\nfunc (i *myAdmission) Admit(a admission.Attributes) (err error) {\r\n\t// this method will cost 10s in worst case\r\n\tif !i.WaitForReady() {\r\n\t\treturn admission.NewForbidden(a, fmt.Errorf(\"not yet ready to handle request\"))\r\n\t}\r\n\t\r\n\t// my custom logical method also cost a long time\r\n\tmyLogic(a)\r\n}\r\n```\r\n\r\n**Anything else we need to know?**:\r\n\r\nNothing yet.\r\n\r\n**Environment**:\r\n\r\nThe lastest version of Kuberntes also has this issue.",
  "closed_at": "2019-08-21T19:42:33Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/78783/comments",
  "created_at": "2019-06-07T02:55:36Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/78783/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/78783",
  "id": 453317813,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 486445796,
      "name": "area/admission-control",
      "node_id": "MDU6TGFiZWw0ODY0NDU3OTY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/admission-control"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d3e2f0",
      "default": false,
      "description": "Indicates that an issue or PR should not be auto-closed due to staleness.",
      "id": 778118403,
      "name": "lifecycle/frozen",
      "node_id": "MDU6TGFiZWw3NzgxMTg0MDM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/lifecycle/frozen"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Important over the long term, but may not be staffed and/or may need multiple releases to complete.",
      "id": 496752236,
      "name": "priority/important-longterm",
      "node_id": "MDU6TGFiZWw0OTY3NTIyMzY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-longterm"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Scalability.",
      "id": 125010198,
      "name": "sig/scalability",
      "node_id": "MDU6TGFiZWwxMjUwMTAxOTg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/scalability"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/78783/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": null,
    "closed_issues": 1361,
    "created_at": "2019-01-31T15:17:37Z",
    "creator": {
      "avatar_url": "https://avatars0.githubusercontent.com/u/980082?v=4",
      "events_url": "https://api.github.com/users/liggitt/events{/privacy}",
      "followers_url": "https://api.github.com/users/liggitt/followers",
      "following_url": "https://api.github.com/users/liggitt/following{/other_user}",
      "gists_url": "https://api.github.com/users/liggitt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/liggitt",
      "id": 980082,
      "login": "liggitt",
      "node_id": "MDQ6VXNlcjk4MDA4Mg==",
      "organizations_url": "https://api.github.com/users/liggitt/orgs",
      "received_events_url": "https://api.github.com/users/liggitt/received_events",
      "repos_url": "https://api.github.com/users/liggitt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/liggitt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/liggitt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/liggitt"
    },
    "description": null,
    "due_on": null,
    "html_url": "https://github.com/kubernetes/kubernetes/milestone/45",
    "id": 4018466,
    "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/45/labels",
    "node_id": "MDk6TWlsZXN0b25lNDAxODQ2Ng==",
    "number": 45,
    "open_issues": 0,
    "state": "open",
    "title": "v1.16",
    "updated_at": "2020-10-25T01:09:02Z",
    "url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/45"
  },
  "node_id": "MDU6SXNzdWU0NTMzMTc4MTM=",
  "number": 78783,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kube-apiserver goruntine leak when admission or call webhooks",
  "updated_at": "2019-08-21T19:42:33Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/78783",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/2566352?v=4",
    "events_url": "https://api.github.com/users/answer1991/events{/privacy}",
    "followers_url": "https://api.github.com/users/answer1991/followers",
    "following_url": "https://api.github.com/users/answer1991/following{/other_user}",
    "gists_url": "https://api.github.com/users/answer1991/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/answer1991",
    "id": 2566352,
    "login": "answer1991",
    "node_id": "MDQ6VXNlcjI1NjYzNTI=",
    "organizations_url": "https://api.github.com/users/answer1991/orgs",
    "received_events_url": "https://api.github.com/users/answer1991/received_events",
    "repos_url": "https://api.github.com/users/answer1991/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/answer1991/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/answer1991/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/answer1991"
  }
}