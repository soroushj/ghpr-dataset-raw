{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "/kind bug\r\n\r\n**What happened**:\r\n\r\nSecrets have some export logic in their strategy, but does not appear to take effect on the command line when doing a kubectl get --export.\r\n\r\n**What you expected to happen**:\r\n\r\nSome kind of error given the condition in the secret strategy mentioned below. However it appears the secret strategy Export function may not be wired up. (as well as several other types)\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\n```\r\n$ kubeadm init\r\n$ kubectl get secret default-token-w5cs4 -o yaml --export\r\n```\r\n\r\nNo error is thrown, some generic metadata is stripped but the code is happy to export the object despite the fact that it violates the condition mentioned below.\r\n\r\n**Anything else we need to know?**:\r\n\r\nIn the generic registry Store we can see the main place where exports should be run:\r\n\r\nhttps://github.com/kubernetes/kubernetes/blob/10dc1aac61f8f2e9a9381a525289d8ae87ba0cc9/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L1227\r\n\r\nThis ExportStrategy is set in a handful of strategies, such as:\r\n\r\nhttps://github.com/kubernetes/kubernetes/blob/10dc1aac61f8f2e9a9381a525289d8ae87ba0cc9/pkg/registry/core/limitrange/storage/storage.go#L46\r\n\r\nIn addition to limitrange we find similar for node, podtemplate, and service strategies.\r\n\r\nHowever several other strategies have an Export function defined matching: Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error\r\n\r\n```\r\n(dgoodwin@wrx {master} ~/go/src/k8s.io/kubernetes) $ git grep Export | grep Context | grep Object | grep bool\r\npkg/registry/certificates/certificates/strategy.go:func (s csrStrategy) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\npkg/registry/core/limitrange/strategy.go:func (limitrangeStrategy) Export(genericapirequest.Context, runtime.Object, bool) error {\r\npkg/registry/core/node/strategy.go:func (ns nodeStrategy) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\npkg/registry/core/podtemplate/strategy.go:func (podTemplateStrategy) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\npkg/registry/core/secret/strategy.go:func (s strategy) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\npkg/registry/core/service/strategy.go:func (svcStrategy) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\npkg/registry/rbac/clusterrole/strategy.go:func (s strategy) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\npkg/registry/rbac/clusterrolebinding/strategy.go:func (s strategy) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\npkg/registry/rbac/role/strategy.go:func (s strategy) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\npkg/registry/rbac/rolebinding/strategy.go:func (s strategy) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\nstaging/src/k8s.io/apiserver/pkg/registry/generic/registry/store_test.go:func (t testPodExport) Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error {\r\nstaging/src/k8s.io/apiserver/pkg/registry/rest/export.go:       Export(ctx genericapirequest.Context, obj runtime.Object, exact bool) error\r\n```\r\n\r\nLooking specifically at the Secret strategy: https://github.com/kubernetes/kubernetes/blob/10dc1aac61f8f2e9a9381a525289d8ae87ba0cc9/pkg/registry/core/secret/strategy.go#L79\r\n\r\nIt appears that this Export method may not be wired up and thus is unused. In testing with kubectl on the API, it appears we cannot get the condition on line 90 in the link above to trigger even if trying to kubectl get --export secrets X where X is of type kubernetes.io/service-account-token, or is tied to a service account by UID.\r\n\r\nThis may imply that secret, clusterrole, clusterrolebinding, role, and rolebinding strategies all have an Export function defined that is not used.\r\n\r\nThe fix might just be as simple as setting ExportStrategy in places such as: https://github.com/kubernetes/kubernetes/blob/10dc1aac61f8f2e9a9381a525289d8ae87ba0cc9/pkg/registry/core/secret/storage/storage.go#L44\r\n\r\nIf so please let me know and I will try to pursue unit tests and a fix for each.\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): \r\n  ```\r\n  Client Version: version.Info{Major:\"1\", Minor:\"7\", GitVersion:\"v1.7.1\", GitCommit:\"1dc5c66f5dd61da08412a74221ecc79208c2165b\", GitTreeState:\"clean\", BuildDate:\"2017-07-14T02:00:46Z\", GoVersion:\"go1.8.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n  Server Version: version.Info{Major:\"1\", Minor:\"7\", GitVersion:\"v1.7.1\", GitCommit:\"1dc5c66f5dd61da08412a74221ecc79208c2165b\", GitTreeState:\"clean\", BuildDate:\"2017-07-14T01:48:01Z\", GoVersion:\"go1.8.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n  ```\r\n\r\n- OS (e.g. from /etc/os-release): CentOS 7\r\n- Kernel (e.g. `uname -a`): Linux centos1.aos.example.com 3.10.0-514.16.1.el7.x86_64 #1 SMP Wed Apr 12 15:04:24 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n- Install tools: kubeadm, oc\r\n\r\n",
  "closed_at": "2017-08-10T06:56:01Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 12,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/49042/comments",
  "created_at": "2017-07-17T18:41:44Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/49042/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/49042",
  "id": 243488141,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "fbca04",
      "default": false,
      "description": "Higher priority than priority/awaiting-more-evidence.",
      "id": 114528273,
      "name": "priority/backlog",
      "node_id": "MDU6TGFiZWwxMTQ1MjgyNzM=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/backlog"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG CLI.",
      "id": 450823910,
      "name": "sig/cli",
      "node_id": "MDU6TGFiZWw0NTA4MjM5MTA=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cli"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/49042/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyNDM0ODgxNDE=",
  "number": 49042,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Several API type strategies have Export func that may be unused",
  "updated_at": "2017-08-10T06:56:01Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/49042",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/51265?v=4",
    "events_url": "https://api.github.com/users/dgoodwin/events{/privacy}",
    "followers_url": "https://api.github.com/users/dgoodwin/followers",
    "following_url": "https://api.github.com/users/dgoodwin/following{/other_user}",
    "gists_url": "https://api.github.com/users/dgoodwin/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/dgoodwin",
    "id": 51265,
    "login": "dgoodwin",
    "node_id": "MDQ6VXNlcjUxMjY1",
    "organizations_url": "https://api.github.com/users/dgoodwin/orgs",
    "received_events_url": "https://api.github.com/users/dgoodwin/received_events",
    "repos_url": "https://api.github.com/users/dgoodwin/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/dgoodwin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dgoodwin/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/dgoodwin"
  }
}