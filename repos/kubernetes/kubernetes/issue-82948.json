{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/676637?v=4",
    "events_url": "https://api.github.com/users/feiskyer/events{/privacy}",
    "followers_url": "https://api.github.com/users/feiskyer/followers",
    "following_url": "https://api.github.com/users/feiskyer/following{/other_user}",
    "gists_url": "https://api.github.com/users/feiskyer/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/feiskyer",
    "id": 676637,
    "login": "feiskyer",
    "node_id": "MDQ6VXNlcjY3NjYzNw==",
    "organizations_url": "https://api.github.com/users/feiskyer/orgs",
    "received_events_url": "https://api.github.com/users/feiskyer/received_events",
    "repos_url": "https://api.github.com/users/feiskyer/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/feiskyer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/feiskyer/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/feiskyer"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/676637?v=4",
      "events_url": "https://api.github.com/users/feiskyer/events{/privacy}",
      "followers_url": "https://api.github.com/users/feiskyer/followers",
      "following_url": "https://api.github.com/users/feiskyer/following{/other_user}",
      "gists_url": "https://api.github.com/users/feiskyer/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/feiskyer",
      "id": 676637,
      "login": "feiskyer",
      "node_id": "MDQ6VXNlcjY3NjYzNw==",
      "organizations_url": "https://api.github.com/users/feiskyer/orgs",
      "received_events_url": "https://api.github.com/users/feiskyer/received_events",
      "repos_url": "https://api.github.com/users/feiskyer/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/feiskyer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/feiskyer/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/feiskyer"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\n\r\nOne of our production Azure clusters was experiencing severe rate limiting. `increase(cloudprovider_azure_api_request_errors[3m])` showed hundreds of errors per minute, specifically for the vmss_list call.\r\n\r\nThis particular cluster had ten worker scale sets. We noticed that two of these scale sets were scaled to zero (they were running an older VM image we had migrated off of). We determined that we could safely delete these scale sets and deleted both of them. Finally, we did a rolling restart of the controller manager.\r\n\r\nImmediately the rate limiting was fully relieved and no errors appeared in the metrics or cloud controller logs.\r\n\r\n**What you expected to happen**:\r\n\r\nvmss_list calls shouldn't be performed against empty scale sets, since the vmss_list call is subject to aggressive rate limiting. The `sku.capacity` property of the VM scale set should be checked first, and the vmss_list call should only be performed if the capacity is greater than zero.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n\r\nScale a worker scale set to zero and observe that vmss_list requests are still performed against it in the Azure API Activity Log and controller manager logs.\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`): 1.15.3\r\n- Cloud provider or hardware configuration: Azure (not AKS)\r\n- OS (e.g: `cat /etc/os-release`): CoreOS 2191.4.1\r\n- Kernel (e.g. `uname -a`): `Linux vmss-agent-worker0-11prodva7-baqwm00000W 4.19.66-coreos #1 SMP Mon Aug 26 21:06:50 -00 2019 x86_64 Intel(R) Xeon(R) CPU E5-2673 v3 @ 2.40GHz GenuineIntel GNU/Linux`\r\n- Install tools: custom internal tooling, broadly similar to AKS engine\r\n- Network plugin and version (if this is a network-related bug):\r\n- Others:\r\n\r\nCloud config:\r\n\r\n```\r\ncloud: AzurePublicCloud\r\ncloudProviderBackoff: true\r\ncloudProviderBackoffDuration: 5\r\ncloudProviderBackoffExponent: 1.5\r\ncloudProviderBackoffJitter: 1\r\ncloudProviderBackoffRetries: 6\r\ncloudProviderRateLimitBucket: 10\r\ncloudProviderRateLimitQPS: 3\r\ncloudProviderRatelimit: true\r\n```",
  "closed_at": "2019-09-29T03:11:39Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/82948/comments",
  "created_at": "2019-09-20T16:41:50Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/82948/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/82948",
  "id": 496447955,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Issues or PRs related to azure provider",
      "id": 852130786,
      "name": "area/provider/azure",
      "node_id": "MDU6TGFiZWw4NTIxMzA3ODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/provider/azure"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Highest priority. Must be actively worked on as someone's top priority right now.",
      "id": 114528068,
      "name": "priority/critical-urgent",
      "node_id": "MDU6TGFiZWwxMTQ1MjgwNjg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/critical-urgent"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Cloud Provider.",
      "id": 958178286,
      "name": "sig/cloud-provider",
      "node_id": "MDU6TGFiZWw5NTgxNzgyODY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/cloud-provider"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/82948/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0OTY0NDc5NTU=",
  "number": 82948,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Empty Azure VM scale sets consume vmss_list API needlessly",
  "updated_at": "2019-09-29T03:11:39Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/82948",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/4450708?v=4",
    "events_url": "https://api.github.com/users/dharmab/events{/privacy}",
    "followers_url": "https://api.github.com/users/dharmab/followers",
    "following_url": "https://api.github.com/users/dharmab/following{/other_user}",
    "gists_url": "https://api.github.com/users/dharmab/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/dharmab",
    "id": 4450708,
    "login": "dharmab",
    "node_id": "MDQ6VXNlcjQ0NTA3MDg=",
    "organizations_url": "https://api.github.com/users/dharmab/orgs",
    "received_events_url": "https://api.github.com/users/dharmab/received_events",
    "repos_url": "https://api.github.com/users/dharmab/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/dharmab/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dharmab/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/dharmab"
  }
}