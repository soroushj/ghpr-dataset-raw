{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via https://kubernetes.io/security/\r\n-->\r\n\r\n\r\n**What happened**:\r\nA volume never successfully attaches to a node. Note for the timeline that we run k-c-m with high availability. Also note that Palantir\u2019s clusters may see the issue more often than others because we replace both the nodes using the volumes and the nodes running kube-controller-manager automatically on a regular basis.\r\n\r\nTimeline:\r\n1. node A launches (ip-10-0-55-221.AZ.compute.internal)\r\n2. the old k-c-m leader L attaches volume 1 (pvc-3e3be98e-2c3c-4c72-bfa7-a6d0dcf7a192) to node A\r\n```\r\nattacherDetacher.AttachVolume started for volume \"pvc-3e3be98e-2c3c-4c72-bfa7-a6d0dcf7a192\" (UniqueName: \"kubernetes.io/aws-ebs/aws://AZ/vol-029ba1842f58a34c1\") from node \"ip-10-0-55-221.AZ.compute.internal\"\r\n```\r\n3. Note that L never logs that the attach was successful\r\n4. the new k-c-m leader M tries to attach volume 1 to node A (same message as above)\r\n5. until another node replaces A, M fails to attach volume 1\r\n```\r\nOperation for \"{volumeName:kubernetes.io/aws-ebs/aws://AZ/vol-029ba1842f58a34c1 podName: nodeName:}\" failed. No retries permitted until 2020-07-14 01:14:24.015067975 +0000 UTC m=+68508.845386339 (durationBeforeRetry 500ms). Error: \"AttachVolume.Attach failed for volume \\\"pvc-3e3be98e-2c3c-4c72-bfa7-a6d0dcf7a192\\\" (UniqueName: \\\"kubernetes.io/aws-ebs/aws://AZ/vol-029ba1842f58a34c1\\\") from node \\\"ip-10-0-55-221.AZ.compute.internal\\\" : volume is still being detached from the node\"\r\n```\r\n\r\nThe issue here is that L succeeded in attaching volume 1 to node A in AWS (confirmed via the console), but was stopped before A\u2019s node object in k8s was updated (specifically https://github.com/kubernetes/kubernetes/blob/release-1.17/pkg/controller/volume/attachdetach/reconciler/reconciler.go#L220). This causes M to try to attach the volume again, which continuously causes an error because the volume is already attached to node A. The error \u201cvolume is still being detached from the node\u201d was added in https://github.com/kubernetes/kubernetes/pull/83567 and violates the assumption made in https://github.com/kubernetes/kubernetes/blob/release-1.17/pkg/volume/awsebs/attacher.go#L82-L83 that if the volume is already attached we will succeed.\r\n\r\n**What you expected to happen**:\r\nI would expect k-c-m to succeed in attaching a volume when the volume is already attached correctly. \r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\n1. Have the kube-controller-manager pod sleep after attaching the volume but before updating the k8s node.\r\n2. Create pod that requires a volume be attached to a node\r\n3. Kill the k-c-m pod\r\n\r\n**Anything else we need to know?**:\r\nI was considering adding a conditional checking the volume status in the attach/detach controller to do the right thing depending on whether the volume is detaching/attaching or is already attached, but looking forward to hearing other people\u2019s ideas.\r\n\r\n**Environment**:\r\n- Kubernetes version (use kubectl version): 1.17.8\r\n- Cloud provider or hardware configuration: AWS\r\n- OS (e.g: cat /etc/os-release): Ubuntu 18.04.4 LTS (Bionic Beaver) - debian\r\n- Kernel (e.g. uname -a): Linux xxx 4.15.0-1077-aws #81-Ubuntu SMP Wed Jun 24 16:48:15 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n- Install tools: \r\n- Network plugin and version (if this is a network-related bug):\r\n- Others:\r\n",
  "closed_at": "2020-08-07T14:16:19Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/20407524?v=4",
    "events_url": "https://api.github.com/users/k8s-ci-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-ci-robot/followers",
    "following_url": "https://api.github.com/users/k8s-ci-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-ci-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-ci-robot",
    "id": 20407524,
    "login": "k8s-ci-robot",
    "node_id": "MDQ6VXNlcjIwNDA3NTI0",
    "organizations_url": "https://api.github.com/users/k8s-ci-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-ci-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-ci-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-ci-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-ci-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-ci-robot"
  },
  "comments": 12,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93090/comments",
  "created_at": "2020-07-15T03:31:42Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93090/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/93090",
  "id": 657033349,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Storage.",
      "id": 169428334,
      "name": "sig/storage",
      "node_id": "MDU6TGFiZWwxNjk0MjgzMzQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/storage"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93090/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2NTcwMzMzNDk=",
  "number": 93090,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Volume fails to attach when the k-c-m leader changes",
  "updated_at": "2020-08-12T02:36:00Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/93090",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/15708673?v=4",
    "events_url": "https://api.github.com/users/bryanhanner/events{/privacy}",
    "followers_url": "https://api.github.com/users/bryanhanner/followers",
    "following_url": "https://api.github.com/users/bryanhanner/following{/other_user}",
    "gists_url": "https://api.github.com/users/bryanhanner/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/bryanhanner",
    "id": 15708673,
    "login": "bryanhanner",
    "node_id": "MDQ6VXNlcjE1NzA4Njcz",
    "organizations_url": "https://api.github.com/users/bryanhanner/orgs",
    "received_events_url": "https://api.github.com/users/bryanhanner/received_events",
    "repos_url": "https://api.github.com/users/bryanhanner/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/bryanhanner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bryanhanner/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/bryanhanner"
  }
}