{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/4367440?v=4",
    "events_url": "https://api.github.com/users/ianchakeres/events{/privacy}",
    "followers_url": "https://api.github.com/users/ianchakeres/followers",
    "following_url": "https://api.github.com/users/ianchakeres/following{/other_user}",
    "gists_url": "https://api.github.com/users/ianchakeres/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ianchakeres",
    "id": 4367440,
    "login": "ianchakeres",
    "node_id": "MDQ6VXNlcjQzNjc0NDA=",
    "organizations_url": "https://api.github.com/users/ianchakeres/orgs",
    "received_events_url": "https://api.github.com/users/ianchakeres/received_events",
    "repos_url": "https://api.github.com/users/ianchakeres/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ianchakeres/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ianchakeres/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ianchakeres"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/4367440?v=4",
      "events_url": "https://api.github.com/users/ianchakeres/events{/privacy}",
      "followers_url": "https://api.github.com/users/ianchakeres/followers",
      "following_url": "https://api.github.com/users/ianchakeres/following{/other_user}",
      "gists_url": "https://api.github.com/users/ianchakeres/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/ianchakeres",
      "id": 4367440,
      "login": "ianchakeres",
      "node_id": "MDQ6VXNlcjQzNjc0NDA=",
      "organizations_url": "https://api.github.com/users/ianchakeres/orgs",
      "received_events_url": "https://api.github.com/users/ianchakeres/received_events",
      "repos_url": "https://api.github.com/users/ianchakeres/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/ianchakeres/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ianchakeres/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/ianchakeres"
    }
  ],
  "author_association": "NONE",
  "body": "## Objective\n\nAdd support for the recently emerged `rbd-nbd` feature-rich client to improve support for Ceph RBD in Kubernetes.\n## Background\n\nKubernetes already offers support for Ceph RBD based on the `krbd` kernel client. Unfortunately, due to obvious reasons, `krbd` can't use the `librbd` user-space space library that gets most of the development focus. This caused a feature gap when compared to VM-based environments.\n\nAt the moment `krbd` lacks exclusive locking infrastructure, image management facilities and multi-DC support (remote backups!). The detailed list can be obtained by comparing the definitions of `RBD_FEATURES_ALL` macro in [`librbd`](https://github.com/ceph/ceph/blob/master/src/include/rbd/features.h#L25) and [kernel](http://lxr.linux.no/#linux+v4.7.2/drivers/block/rbd.c#L121). While there are efforts on partially closing the gap (patches waiting for merge), `librbd` continuously gets new items like [consistency groups](http://tracker.ceph.com/projects/ceph/wiki/consistency_groups) or [fencing improvements](https://github.com/ceph/ceph/pull/9592).\n\nBeside the feature gap `krbd` exhibits additional drawback. Being entirely kernel space impacts fault-tolerance as any kernel panic affects a whole node -- not only a single Pod using RBD storage. According to the [`rbd-nbd` pull request](https://github.com/ceph/ceph/pull/6657) the reliability, especially on non-x86 platforms, was one of the driving factors behind the new client.\n\nThose issues can be addressed by employing `rbd-nbd` -- a thin adapter ([858 lines of code in Jewel](https://github.com/ceph/ceph/blob/v10.2.2/src/tools/rbd_nbd/rbd-nbd.cc#L858)) between NBD subsystem of Linux kernel and `librbd`.\n\nThe primary concern about `rbd-nbd` was performance. The authors claimed it's _comparable_ to krbd. Together with Intel we verified those claims. Tests on typical HW where Ceph is deployed (SSDs for journals, HDDs as main storage) showed `rbd-nbd` delivers 70-80% of `krbd` performance. Though, we don't consider the raw performance as a deciding factor. Even fastest RBD client wouldn't be a solution-of-choice for performance critical use cases like RDBMS hosting.\n## Proposal\n\nWe would like to propose incorporating support for `rbd-nbd`. The integration can be accomplished in multiple ways.\n1. Extending the current in-tree plugin for RBD to use `krbd` or `rbd-nbd` depending on a configuration parameter. This would assure the excellent commonality. On the other hand we see differences where this might become an issue.  \n   The _krbd_-based plugin employs the _advisory locking_ mechanism to provide fencing at the cost of HA -- in case of node crash a manual intervention is required. However, serving images marked to use _exclusive locking_ feature would result in employing the same underlying infrastructure twice. At the moment this isn\u2019t an issue because `krbd` simply doesn\u2019t support exclusive lock. However, when it finally gets it, RBD images created with Ceph\u2019s default capabilities set will be inaccessible in read-write mode. This was the reason why a [similar solution](https://lists.gnu.org/archive/html/qemu-devel/2016-04/msg02422.html) has been [refused](https://lists.gnu.org/archive/html/qemu-devel/2016-04/msg04131.html) in QEMU.  \n   Another problem we see are additional dependencies. After fencing capability is integrated directly in `krbd`, the dependency on user-space `/usr/bin/rbd` CLI utility can be removed. The helper is not required for mapping RBD images as the kernel interface may be used directly by the plugin.\n2. Dedicated in-tree plugin. Offers greatest flexibility in adopting new features (like dynamic provisioning of Persistent Volumes).\n3. Dedicated FlexVolume plugin. Simple but limited. Bringing support for e.g. dynamic provisioning would require extensive changes in FlexVolume\u2019s interfaces.\n\nAt the moment the option # 2 looks most promising. Though we stay entirely open for the discussion.\n## Future work\n### Performance\n\n`rbd-nbd` efficiency suffers from extra context switches and extensive memory copying between kernel and user-space boundaries. Although we can do nothing with the first factor, the second can be improved for large blocks transfers. Linux kernel has facilities for zero-copy page-aligned memory transfers between kernel and application via the combination of `splice` and `vmsplice` system calls.\n### Fencing\n\nActually Mirantis [is working](https://github.com/ceph/ceph/pull/9592) on bringing fencing to `librbd` on the top of exclusive lock infrastructure. This would allow to move from the flawed _advisory lock_ mechanism that is currently used by rbd storage plugin.\n### Dynamic provisioning\n\nCurrently RBD images must be created ahead by a cluster administrator. We see possibility to implement the dynamic provisioning for RBD in the future.\n",
  "closed_at": "2018-02-27T11:31:43Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 22,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/32266/comments",
  "created_at": "2016-09-08T09:05:25Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/32266/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/32266",
  "id": 175701803,
  "labels": [
    {
      "color": "c7def8",
      "default": false,
      "description": "Categorizes issue or PR as related to a new feature.",
      "id": 267761362,
      "name": "kind/feature",
      "node_id": "MDU6TGFiZWwyNjc3NjEzNjI=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/feature"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": "Important over the long term, but may not be staffed and/or may need multiple releases to complete.",
      "id": 496752236,
      "name": "priority/important-longterm",
      "node_id": "MDU6TGFiZWw0OTY3NTIyMzY=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/priority/important-longterm"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Storage.",
      "id": 169428334,
      "name": "sig/storage",
      "node_id": "MDU6TGFiZWwxNjk0MjgzMzQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/storage"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/32266/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-08-26T17:23:39Z",
    "closed_issues": 641,
    "created_at": "2017-07-24T18:50:54Z",
    "creator": {
      "avatar_url": "https://avatars1.githubusercontent.com/u/903617?v=4",
      "events_url": "https://api.github.com/users/mtaufen/events{/privacy}",
      "followers_url": "https://api.github.com/users/mtaufen/followers",
      "following_url": "https://api.github.com/users/mtaufen/following{/other_user}",
      "gists_url": "https://api.github.com/users/mtaufen/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mtaufen",
      "id": 903617,
      "login": "mtaufen",
      "node_id": "MDQ6VXNlcjkwMzYxNw==",
      "organizations_url": "https://api.github.com/users/mtaufen/orgs",
      "received_events_url": "https://api.github.com/users/mtaufen/received_events",
      "repos_url": "https://api.github.com/users/mtaufen/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mtaufen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mtaufen/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mtaufen"
    },
    "description": "",
    "due_on": "2018-03-26T07:00:00Z",
    "html_url": "https://github.com/kubernetes/kubernetes/milestone/37",
    "id": 2659046,
    "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/37/labels",
    "node_id": "MDk6TWlsZXN0b25lMjY1OTA0Ng==",
    "number": 37,
    "open_issues": 0,
    "state": "closed",
    "title": "v1.10",
    "updated_at": "2019-08-26T17:23:39Z",
    "url": "https://api.github.com/repos/kubernetes/kubernetes/milestones/37"
  },
  "node_id": "MDU6SXNzdWUxNzU3MDE4MDM=",
  "number": 32266,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Add support for accessing Ceph RBD with the rbd-nbd client",
  "updated_at": "2019-01-18T13:34:57Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/32266",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1891217?v=4",
    "events_url": "https://api.github.com/users/rzarzynski/events{/privacy}",
    "followers_url": "https://api.github.com/users/rzarzynski/followers",
    "following_url": "https://api.github.com/users/rzarzynski/following{/other_user}",
    "gists_url": "https://api.github.com/users/rzarzynski/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rzarzynski",
    "id": 1891217,
    "login": "rzarzynski",
    "node_id": "MDQ6VXNlcjE4OTEyMTc=",
    "organizations_url": "https://api.github.com/users/rzarzynski/orgs",
    "received_events_url": "https://api.github.com/users/rzarzynski/received_events",
    "repos_url": "https://api.github.com/users/rzarzynski/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rzarzynski/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rzarzynski/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rzarzynski"
  }
}