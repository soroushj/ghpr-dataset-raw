{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "If a namespaced resource is owned by a cluster scoped resource, and the namespaced dependent is processed **before** the cluster scoped owner has ever been observed by the garbage collector, the dependent will be erroneously deleted. The cause is a race condition in the GC's [virtual node handling](https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/garbagecollector/graph_builder.go#L377). Currently, virtual nodes always inherit the namespace of the dependent, which is an invalid assumption when:\r\n\r\n1. The owner is cluster scoped\r\n2. The owner is namespaced but in a different namespace than the dependent\r\n\r\nUnder these conditions, the dependent will be deleted because the GC has misidentified the location of the owner, causing the dependent reference to always be considered dangling.\r\n\r\nI've created some unit and integration tests in a branch which demonstrate the problems and will help serve as verification of the fix:\r\n\r\n* A [unit test](https://github.com/ironcladlou/kubernetes/blob/cluster-scoped-owner-gc-fix/pkg/controller/garbagecollector/garbagecollector_test.go#L675) which demonstrates some problematic cases and attempts to describe the important behaviors more specifically.\r\n* An [integration test](https://github.com/ironcladlou/kubernetes/blob/cluster-scoped-owner-gc-fix/test/integration/garbagecollector/garbage_collector_test.go#L433) which reproduces [this unit test](https://github.com/ironcladlou/kubernetes/blob/cluster-scoped-owner-gc-fix/pkg/controller/garbagecollector/garbagecollector_test.go#L736) (the problem reported in this issue). Requires `stress` to reproduce.\r\n\r\nThis was discovered by a test flake in OpenShift (https://github.com/openshift/origin/issues/17085). @caesarxuchao has [proposed some possible fixes](https://github.com/openshift/origin/issues/17085#issuecomment-340582560) to the cluster scoped owner bug.\r\n\r\n/kind bug\r\n@kubernetes/sig-api-machinery-bugs \r\n\r\n/cc @jim-minter \r\n",
  "closed_at": "2017-12-15T22:00:39Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 16,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/54940/comments",
  "created_at": "2017-11-01T13:58:11Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/54940/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/54940",
  "id": 270316891,
  "labels": [
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG API Machinery.",
      "id": 173493835,
      "name": "sig/api-machinery",
      "node_id": "MDU6TGFiZWwxNzM0OTM4MzU=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/api-machinery"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/54940/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyNzAzMTY4OTE=",
  "number": 54940,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "Namespaced dependent of cluster scoped resource is sometimes erroneously garbage collected",
  "updated_at": "2017-12-15T22:00:39Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/54940",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/298299?v=4",
    "events_url": "https://api.github.com/users/ironcladlou/events{/privacy}",
    "followers_url": "https://api.github.com/users/ironcladlou/followers",
    "following_url": "https://api.github.com/users/ironcladlou/following{/other_user}",
    "gists_url": "https://api.github.com/users/ironcladlou/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ironcladlou",
    "id": 298299,
    "login": "ironcladlou",
    "node_id": "MDQ6VXNlcjI5ODI5OQ==",
    "organizations_url": "https://api.github.com/users/ironcladlou/orgs",
    "received_events_url": "https://api.github.com/users/ironcladlou/received_events",
    "repos_url": "https://api.github.com/users/ironcladlou/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ironcladlou/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ironcladlou/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ironcladlou"
  }
}