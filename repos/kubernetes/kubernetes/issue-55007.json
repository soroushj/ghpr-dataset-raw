{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "/kind bug\r\n\r\n**What happened**:\r\nkubelet creates too many udev \"change\" events during Cinder volume attachment.\r\nIf volume attachement takes long, then udev event queue gets full, therefore\r\nudev does not answer requests from docker, and PLEG makes the k8s node unhealthy.\r\n\r\n**What you expected to happen**:\r\n  * kubelet should not run `udevadm trigger` so often.\r\n  * kubelet should run `udevadm settle --timeout=1 && udevadm trigger`\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nDeploy k8s on Openstack. Configure k8s cluster with --cloud_provider=openstack.\r\n  * Cordon all nodes except one.\r\n  * SSH into that node. Start `udevadm monitor` and let it run.\r\n  * Create StorateClass for Cinder volumes.\r\n  * Deploy StatefulSet with volumeClaimTemplate pointing to that StorageClass.\r\n  * Optionally, immediately detatch the newly-created cinder volume manually\r\n    through openstack CLI or web interface to simulate a slow cinder attachment.\r\n  * Look back to the `udevadm monitor` to find thousands of udev events.\r\n    In case of the \"show\" attachement, the \"change\" udev events will never stop.\r\n  * Also run `top` to find that systemd-udevd consumes 100% CPU.\r\n  * Also run `docker ps` to find that it hangs and never answers.\r\n\r\n**Anything else we need to know?**:\r\nAttachment of a new cinder volume includes execution of `udevadm trigger`\r\ncommand, see links (1-3) below. The `udevadm trigger` generates a \"change\"\r\nevent for every single device on the /sys/devices SysFS. This can be seen by\r\nrunning `udevadm monitor`.\r\n\r\nThe execution stack is as follows:\r\n  * Volume Attacher Interface (1) runs WaitForAttach(), which is implemented in (2).\r\n  * The Cinder's WaitForAttach() runs probeAttachedVolume() 2 times per second\r\n    (lines 243 and 247). The \"1 second\" retry timeout is defined by (3).\r\n  * The probeAttachedVolume() is defined in (4). It triggers SCSI rescan and\r\n    generates udev \"change\" event on all devices by running `udevadm trigger`.\r\n\r\nAs you see, both scsi rescan and full udev rescan are triggered 2 times per second.\r\n\r\nThe scsi bus rescan leads to considerable latency of runnig I/O operations.\r\n\r\nThe sysemd-udevd is unable to process so many \"change\" events. The udev queue\r\ngets full, leading to frozen `docker ps` operation that cAdvisor runs every 2 seconds.\r\nAfter 3 minutes, kubelet marks itself unhealthy (5) due to PLEG (6).\r\n\r\n\r\n(1) [Volume Attacher interface runs WaitForAttach()](https://github.com/kubernetes/kubernetes/blob/2723e06a251a4ec3ef241397217e73fa782b0b98/pkg/volume/volume.go#L176)\r\n(2) [Cinder Attacher implementation of WaitForAttach()](https://github.com/kubernetes/kubernetes/blob/2723e06a251a4ec3ef241397217e73fa782b0b98/pkg/volume/cinder/attacher.go#L224)\r\n(3) [1 second retry timeout](https://github.com/kubernetes/kubernetes/blob/2723e06a251a4ec3ef241397217e73fa782b0b98/pkg/volume/cinder/attacher.go#L237)\r\n(4) [probeAttachedVolume()](https://github.com/kubernetes/kubernetes/blob/fc8bfe2d8929e11a898c4557f9323c482b5e8842/pkg/volume/cinder/cinder_util.go#L222)\r\n(5) [PLEG healthcheck](https://github.com/kubernetes/kubernetes/blob/eb658d699ac074ef2a6f3808b13aacc6adfca786/pkg/kubelet/kubelet.go#L748)\r\n(6) [PLEG implementation](https://github.com/kubernetes/kubernetes/blob/d196a4abbbf3f1ca458908abd42267b521a6faff/pkg/kubelet/pleg/generic.go#L133)\r\n\r\n\r\n**Environment**:\r\n- Kubernetes version (use `kubectl version`):\r\n  ```\r\n  Client Version: version.Info{Major:\"1\", Minor:\"7\", GitVersion:\"v1.7.4\", GitCommit:\"793658f2d7ca7f064d2bdf606519f9fe1229c381\", GitTreeState:\"clean\", BuildDate:\"2017-08-17T08:48:23Z\", GoVersion:\"go1.8.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n  Server Version: version.Info{Major:\"1\", Minor:\"7\", GitVersion:\"v1.7.4\", GitCommit:\"793658f2d7ca7f064d2bdf606519f9fe1229c381\", GitTreeState:\"clean\", BuildDate:\"2017-08-17T08:30:51Z\", GoVersion:\"go1.8.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n  ```\r\n- Cloud provider or hardware configuration: VmWare-integrated Openstack (ViO)\r\n- OS (e.g. from /etc/os-release): PRETTY_NAME=\"CentOS Linux 7 (Core)\"\r\n- Kernel (e.g. `uname -a`): Linux os1pi013-kube-node02.novalocal 3.10.0-514.10.2.el7.x86_64 #1 SMP Fri Mar 3 00:04:05 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n- Install tools: saltstack scripts.\r\n- Others: docker-1.12.5-14.el7.centos\r\n",
  "closed_at": "2017-12-14T12:32:17Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/13653959?v=4",
    "events_url": "https://api.github.com/users/k8s-github-robot/events{/privacy}",
    "followers_url": "https://api.github.com/users/k8s-github-robot/followers",
    "following_url": "https://api.github.com/users/k8s-github-robot/following{/other_user}",
    "gists_url": "https://api.github.com/users/k8s-github-robot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/k8s-github-robot",
    "id": 13653959,
    "login": "k8s-github-robot",
    "node_id": "MDQ6VXNlcjEzNjUzOTU5",
    "organizations_url": "https://api.github.com/users/k8s-github-robot/orgs",
    "received_events_url": "https://api.github.com/users/k8s-github-robot/received_events",
    "repos_url": "https://api.github.com/users/k8s-github-robot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/k8s-github-robot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k8s-github-robot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/k8s-github-robot"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/55007/comments",
  "created_at": "2017-11-02T16:29:49Z",
  "events_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/55007/events",
  "html_url": "https://github.com/kubernetes/kubernetes/issues/55007",
  "id": 270720309,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Issues or PRs related to openstack provider",
      "id": 239914558,
      "name": "area/provider/openstack",
      "node_id": "MDU6TGFiZWwyMzk5MTQ1NTg=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/area/provider/openstack"
    },
    {
      "color": "e11d21",
      "default": false,
      "description": "Categorizes issue or PR as related to a bug.",
      "id": 105146071,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwxMDUxNDYwNzE=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/kind/bug"
    },
    {
      "color": "d2b48c",
      "default": false,
      "description": "Categorizes an issue or PR as relevant to SIG Storage.",
      "id": 169428334,
      "name": "sig/storage",
      "node_id": "MDU6TGFiZWwxNjk0MjgzMzQ=",
      "url": "https://api.github.com/repos/kubernetes/kubernetes/labels/sig/storage"
    }
  ],
  "labels_url": "https://api.github.com/repos/kubernetes/kubernetes/issues/55007/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyNzA3MjAzMDk=",
  "number": 55007,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/kubernetes/kubernetes",
  "state": "closed",
  "title": "kubelet starts too many `udevadm trigger`",
  "updated_at": "2017-12-14T12:32:17Z",
  "url": "https://api.github.com/repos/kubernetes/kubernetes/issues/55007",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/6826176?v=4",
    "events_url": "https://api.github.com/users/kabakaev/events{/privacy}",
    "followers_url": "https://api.github.com/users/kabakaev/followers",
    "following_url": "https://api.github.com/users/kabakaev/following{/other_user}",
    "gists_url": "https://api.github.com/users/kabakaev/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/kabakaev",
    "id": 6826176,
    "login": "kabakaev",
    "node_id": "MDQ6VXNlcjY4MjYxNzY=",
    "organizations_url": "https://api.github.com/users/kabakaev/orgs",
    "received_events_url": "https://api.github.com/users/kabakaev/received_events",
    "repos_url": "https://api.github.com/users/kabakaev/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/kabakaev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kabakaev/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/kabakaev"
  }
}