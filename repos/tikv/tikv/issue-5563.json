{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "## Bug Report\r\n\r\n### What version of TiKV are you using?\r\n3.0.1, 3.0.3\r\n\r\n### What operating system and CPU are you using?\r\nLinux.\r\n\r\n### Steps to reproduce\r\n1. Start PD and TiKV\r\n2. Write a client with go or rust,call `batch_commands` to send a request, and then close the connection (for go) or drop the client (for rust).\r\n3. tcpdump shows that\r\n  ```\r\n  17:19:59.193810 IP localhost.43474 > localhost.60003: Flags [S], seq 3116894430, win 43690, options [mss 65495,sackOK,TS val 4083567442 ecr 0,nop,wscale 7], length 0\r\n17:19:59.193835 IP localhost.60003 > localhost.43474: Flags [S.], seq 1484174627, ack 3116894431, win 43690, options [mss 65495,sackOK,TS val 4083567442 ecr 4083567442,nop,wscale 7], length 0\r\n  17:19:59.193847 IP localhost.43474 > localhost.60003: Flags [.], ack 1, win 342, options [nop,nop,TS val 4083567442 ecr 4083567442], length 0\r\n  17:19:59.194042 IP localhost.43474 > localhost.60003: Flags [P.], seq 1:391, ack 1, win 342, options [nop,nop,TS val 4083567442 ecr 4083567442], length 390\r\n  17:19:59.194050 IP localhost.60003 > localhost.43474: Flags [.], ack 391, win 350, options [nop,nop,TS val 4083567442 ecr 4083567442], length 0\r\n  17:19:59.194638 IP localhost.60003 > localhost.43474: Flags [P.], seq 1:70, ack 391, win 350, options [nop,nop,TS val 4083567443 ecr 4083567442], length 69\r\n  17:19:59.194651 IP localhost.43474 > localhost.60003: Flags [.], ack 70, win 342, options [nop,nop,TS val 4083567443 ecr 4083567443], length 0\r\n  17:19:59.194703 IP localhost.43474 > localhost.60003: Flags [P.], seq 391:417, ack 70, win 342, options [nop,nop,TS val 4083567443 ecr 4083567443], length 26\r\n17:19:59.194772 IP localhost.60003 > localhost.43474: Flags [P.], seq 70:109, ack 417, win 350, options [nop,nop,TS val 4083567443 ecr 4083567443], length 39\r\n17:19:59.234333 IP localhost.43474 > localhost.60003: Flags [.], ack 109, win 342, options [nop,nop,TS val 4083567483 ecr 4083567443], length 0\r\n17:20:02.197605 IP localhost.43474 > localhost.60003: Flags [F.], seq 417, ack 109, win 342, options [nop,nop,TS val 4083570446 ecr 4083567443], length 0\r\n17:20:02.197723 IP localhost.60003 > localhost.43474: Flags [P.], seq 109:219, ack 418, win 350, options [nop,nop,TS val 4083570446 ecr 4083570446], length 110\r\n17:20:02.197747 IP localhost.43474 > localhost.60003: Flags [R], seq 3116894848, win 0, length 0\r\n  ```\r\n4. lsof shows\r\n```\r\n$ sudo lsof -p 60874|grep -vE \"FIFO|a_inode|DIR|REG|CHR\"\r\nCOMMAND     PID   USER   FD      TYPE    DEVICE  SIZE/OFF      NODE NAME\r\ntikv-serv 60874 qupeng    7u     IPv4 259497323       0t0       TCP localhost:34422->localhost:60001 (ESTABLISHED)\r\ntikv-serv 60874 qupeng   77u     IPv4 259417052       0t0       TCP localhost:60003 (LISTEN)\r\ntikv-serv 60874 qupeng  131u     IPv4 259497324       0t0       TCP localhost:60003 (LISTEN)\r\ntikv-serv 60874 qupeng  212u     IPv4 259497325       0t0       TCP localhost:60003 (LISTEN)\r\ntikv-serv 60874 qupeng  233u     IPv4 259521582       0t0       TCP localhost:60013 (LISTEN)\r\ntikv-serv 60874 qupeng  234u     IPv4 259497326       0t0       TCP localhost:60003 (LISTEN)\r\ntikv-serv 60874 qupeng  410u     sock       0,7       0t0 259427948 protocol: TCP\r\ntikv-serv 60874 qupeng  413u     sock       0,7       0t0 259494646 protocol: TCP\r\ntikv-serv 60874 qupeng  416u     sock       0,7       0t0 259273887 protocol: TCP\r\ntikv-serv 60874 qupeng  419u     sock       0,7       0t0 259528650 protocol: TCP\r\ntikv-serv 60874 qupeng  422u     sock       0,7       0t0 259537857 protocol: TCP\r\ntikv-serv 60874 qupeng  423u     sock       0,7       0t0 259560575 protocol: TCP\r\n```\r\nIt proves that tikv server doesn't call `close` on the fd correctly.\r\n\r\n### What did you expect?\r\nTiKV should call `close` on sockets correctly.\r\n\r\n### What did happened?\r\nTiKV doesn't call `close` on sockets correctly.",
  "closed_at": "2019-09-30T02:38:39Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/29268173?v=4",
    "events_url": "https://api.github.com/users/sre-bot/events{/privacy}",
    "followers_url": "https://api.github.com/users/sre-bot/followers",
    "following_url": "https://api.github.com/users/sre-bot/following{/other_user}",
    "gists_url": "https://api.github.com/users/sre-bot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/sre-bot",
    "id": 29268173,
    "login": "sre-bot",
    "node_id": "MDQ6VXNlcjI5MjY4MTcz",
    "organizations_url": "https://api.github.com/users/sre-bot/orgs",
    "received_events_url": "https://api.github.com/users/sre-bot/received_events",
    "repos_url": "https://api.github.com/users/sre-bot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/sre-bot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sre-bot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/sre-bot"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/tikv/tikv/issues/5563/comments",
  "created_at": "2019-09-29T09:28:47Z",
  "events_url": "https://api.github.com/repos/tikv/tikv/issues/5563/events",
  "html_url": "https://github.com/tikv/tikv/issues/5563",
  "id": 499888716,
  "labels": [],
  "labels_url": "https://api.github.com/repos/tikv/tikv/issues/5563/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0OTk4ODg3MTY=",
  "number": 5563,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/tikv/tikv",
  "state": "closed",
  "title": "socket leak on server side",
  "updated_at": "2019-09-30T02:38:40Z",
  "url": "https://api.github.com/repos/tikv/tikv/issues/5563",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/8407317?v=4",
    "events_url": "https://api.github.com/users/hicqu/events{/privacy}",
    "followers_url": "https://api.github.com/users/hicqu/followers",
    "following_url": "https://api.github.com/users/hicqu/following{/other_user}",
    "gists_url": "https://api.github.com/users/hicqu/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/hicqu",
    "id": 8407317,
    "login": "hicqu",
    "node_id": "MDQ6VXNlcjg0MDczMTc=",
    "organizations_url": "https://api.github.com/users/hicqu/orgs",
    "received_events_url": "https://api.github.com/users/hicqu/received_events",
    "repos_url": "https://api.github.com/users/hicqu/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/hicqu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hicqu/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/hicqu"
  }
}