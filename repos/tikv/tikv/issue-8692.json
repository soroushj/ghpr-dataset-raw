{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "COLLABORATOR",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\n2020/09/18 master.\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nPoC\r\n\r\n```rust\r\n#[test]\r\nfn nested_block_on() {\r\n    futures::executor::block_on(async {\r\n        futures::executor::block_on(async { futures::future::ok::<(), ()>(()).await });\r\n    });\r\n}\r\n```\r\n\r\n### What did happened?\r\n\r\n```\r\n[2020-09-17T10:59:38.636Z] [2020/09/17 18:59:37.280 +08:00] [FATAL] [lib.rs:482] [\"cannot execute `LocalPool` executor from within another executor: EnterError\"] [backtrace=\"stack backtrace:\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at components/tikv_util/src/lib.rs:481\r\n   1: std::panicking::rust_panic_with_hook\r\n             at src/libstd/panicking.rs:524\r\n   2: rust_begin_unwind\r\n             at src/libstd/panicking.rs:431\r\n   3: core::panicking::panic_fmt\r\n             at src/libcore/panicking.rs:85\r\n   4: core::option::expect_none_failed\r\n             at src/libcore/option.rs:1269\r\n   5: pd_client::client::RpcClient::get_region_and_leader::{{closure}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/result.rs:963\r\n      pd_client::util::sync_request\r\n             at components/pd_client/src/util.rs:315\r\n      pd_client::client::RpcClient::get_region_and_leader\r\n             at components/pd_client/src/client.rs:152\r\n   6: tikv::server::lock_manager::deadlock::Detector<S,P>::get_leader_info\r\n             at components/pd_client/src/client.rs:317\r\n      tikv::server::lock_manager::deadlock::Detector<S,P>::refresh_leader_info\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/server/lock_manager/deadlock.rs:549\r\n      tikv::server::lock_manager::deadlock::Detector<S,P>::handle_detect\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/server/lock_manager/deadlock.rs:727\r\n   7: <tikv::server::lock_manager::deadlock::Detector<S,P> as tikv_util::worker::future::Runnable<tikv::server::lock_manager::deadlock::Task>>::run\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/server/lock_manager/deadlock.rs:832\r\n      tikv_util::worker::future::poll::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tikv_util/src/worker/future.rs:111\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n      <tokio::task::local::RunUntil<T> as core::future::future::Future>::poll::{{closure}}::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.22/src/task/local.rs:528\r\n      tokio::coop::with_budget::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.22/src/coop.rs:127\r\n      std::thread::local::LocalKey<T>::try_with\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/local.rs:263\r\n      std::thread::local::LocalKey<T>::with\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/local.rs:239\r\n      tokio::coop::with_budget\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.22/src/coop.rs:120\r\n      tokio::coop::budget\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.22/src/coop.rs:96\r\n      <tokio::task::local::RunUntil<T> as core::future::future::Future>::poll::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.22/src/task/local.rs:528\r\n      tokio::macros::scoped_tls::ScopedKey<T>::set\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.22/src/macros/scoped_tls.rs:63\r\n      tokio::task::local::LocalSet::with\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.22/src/task/local.rs:442\r\n      <tokio::task::local::RunUntil<T> as core::future::future::Future>::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.22/src/task/local.rs:518\r\n      tokio::task::local::LocalSet::run_until::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.22/src/task/local.rs:392\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n      futures_executor::local_pool::block_on::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/futures-executor-0.3.5/src/local_pool.rs:317\r\n      futures_executor::local_pool::run_executor::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/futures-executor-0.3.5/src/local_pool.rs:87\r\n      std::thread::local::LocalKey<T>::try_with\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/local.rs:263\r\n      std::thread::local::LocalKey<T>::with\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/local.rs:239\r\n      futures_executor::local_pool::run_executor\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/futures-executor-0.3.5/src/local_pool.rs:83\r\n      futures_executor::local_pool::block_on\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/futures-executor-0.3.5/src/local_pool.rs:317\r\n      tikv_util::worker::future::poll\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tikv_util/src/worker/future.rs:120\r\n      tikv_util::worker::future::Worker<T>::start::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tikv_util/src/worker/future.rs:152\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/sys_common/backtrace.rs:130\r\n   8: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/mod.rs:475\r\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panic.rs:318\r\n      std::panicking::try::do_call\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panicking.rs:342\r\n      std::panicking::try\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panicking.rs:319\r\n      std::panic::catch_unwind\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panic.rs:394\r\n      std::thread::Builder::spawn_unchecked::{{closure}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/mod.rs:474\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/ops/function.rs:233\r\n   9: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n      <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at src/libstd/sys/unix/thread.rs:87\r\n  10: start_thread\r\n  11: __clone\r\n\"] [location=/rust/registry/src/github.com-1ecc6299db9ec823/futures-executor-0.3.5/src/local_pool.rs:78] [thread_name=deadlock-detector]\r\n```\r\n",
  "closed_at": "2020-09-18T00:31:09Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/66930949?v=4",
    "events_url": "https://api.github.com/users/ti-srebot/events{/privacy}",
    "followers_url": "https://api.github.com/users/ti-srebot/followers",
    "following_url": "https://api.github.com/users/ti-srebot/following{/other_user}",
    "gists_url": "https://api.github.com/users/ti-srebot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ti-srebot",
    "id": 66930949,
    "login": "ti-srebot",
    "node_id": "MDQ6VXNlcjY2OTMwOTQ5",
    "organizations_url": "https://api.github.com/users/ti-srebot/orgs",
    "received_events_url": "https://api.github.com/users/ti-srebot/received_events",
    "repos_url": "https://api.github.com/users/ti-srebot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ti-srebot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ti-srebot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ti-srebot"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/tikv/tikv/issues/8692/comments",
  "created_at": "2020-09-17T16:12:14Z",
  "events_url": "https://api.github.com/repos/tikv/tikv/issues/8692/events",
  "html_url": "https://github.com/tikv/tikv/issues/8692",
  "id": 703726101,
  "labels": [
    {
      "color": "ededed",
      "default": false,
      "description": null,
      "id": 2265309659,
      "name": "severity/Major",
      "node_id": "MDU6TGFiZWwyMjY1MzA5NjU5",
      "url": "https://api.github.com/repos/tikv/tikv/labels/severity/Major"
    },
    {
      "color": "1d76db",
      "default": false,
      "description": "Type: Issue - Confirmed a bug",
      "id": 305526945,
      "name": "type/bug",
      "node_id": "MDU6TGFiZWwzMDU1MjY5NDU=",
      "url": "https://api.github.com/repos/tikv/tikv/labels/type/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/tikv/tikv/issues/8692/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU3MDM3MjYxMDE=",
  "number": 8692,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/tikv/tikv",
  "state": "closed",
  "title": "PD client panics on Deadlock's get_leader_info due to nested `block_on`",
  "updated_at": "2020-09-18T02:39:15Z",
  "url": "https://api.github.com/repos/tikv/tikv/issues/8692",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/2150711?v=4",
    "events_url": "https://api.github.com/users/overvenus/events{/privacy}",
    "followers_url": "https://api.github.com/users/overvenus/followers",
    "following_url": "https://api.github.com/users/overvenus/following{/other_user}",
    "gists_url": "https://api.github.com/users/overvenus/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/overvenus",
    "id": 2150711,
    "login": "overvenus",
    "node_id": "MDQ6VXNlcjIxNTA3MTE=",
    "organizations_url": "https://api.github.com/users/overvenus/orgs",
    "received_events_url": "https://api.github.com/users/overvenus/received_events",
    "repos_url": "https://api.github.com/users/overvenus/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/overvenus/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/overvenus/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/overvenus"
  }
}