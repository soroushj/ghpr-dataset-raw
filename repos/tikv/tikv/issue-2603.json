{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "1. What version of Rust are you using (`rustc --version`)?\r\n\r\n```\r\nrustc 1.24.0-nightly (edbd7d232 2017-12-20)\r\n```\r\n\r\n2. What operating system and processor architecture are you using?\r\n\r\nMac OS X 10.13.2 x86-64\r\n\r\n3. What did you do?\r\n\r\nAssuming `rustup` is installed and the latest `nightly` toolchain is installed.\r\n\r\n```bash\r\ngit clone git@github.com:pingcap/tikv.git\r\ncargo +nightly test\r\n```\r\n\r\n4. What did you expect to see?\r\n\r\nNo build failure.\r\n\r\n5. What did you see instead?\r\n\r\n```rust\r\n$ cargo +nightly build\r\n   Compiling rustc-serialize v0.3.19\r\n   Compiling tipb v0.0.1 (https://github.com/pingcap/tipb.git#4fed9b6c)\r\n   Compiling syn v0.11.11\r\n   Compiling idna v0.1.0\r\n   Compiling zstd-sys v1.4.1+zstd.1.3.2 (https://github.com/gyscos/zstd-rs.git#a3b05c8a)\r\n   Compiling sys-info v0.5.1\r\n   Compiling dbghelp-sys v0.2.0\r\n   Compiling kernel32-sys v0.2.2\r\n   Compiling ws2_32-sys v0.2.1\r\n   Compiling solicit v0.4.4\r\n   Compiling num-iter v0.1.32\r\n   Compiling unicase v1.4.0\r\nerror[E0642]: patterns aren't allowed in methods without bodies\r\n   --> /Users/hoverbear/.cargo/registry/src/github.com-1ecc6299db9ec823/rustc-serialize-0.3.19/src/serialize.rs:147:45\r\n    |\r\n147 |                                             &f_name: &str,\r\n    |                                             ^^^^^^^\r\n\r\n   Compiling grpcio-sys v0.1.2\r\n   Compiling librocksdb_sys v0.1.0 (https://github.com/pingcap/rust-rocksdb.git#20d39998)\r\n   Compiling snappy-sys v0.1.0 (https://github.com/busyjay/rust-snappy.git?branch=static-link#be021783)\r\n   Compiling backtrace-sys v0.1.15\r\n   Compiling lz4-sys v1.8.0 (https://github.com/busyjay/lz4-rs.git?branch=adjust-build#41509fea)\r\n   Compiling bzip2-sys v0.1.6 (https://github.com/alexcrichton/bzip2-rs.git#b82dee62)\r\n   Compiling aho-corasick v0.5.3\r\nerror: aborting due to previous error\r\n\r\nerror: Could not compile `rustc-serialize`.\r\nwarning: build failed, waiting for other jobs to finish...\r\nerror: build failed\r\n```\r\n\r\n## Diagnosis\r\n\r\nThis comes from a bug which was fixed in https://github.com/rust-lang-deprecated/rustc-serialize/pull/169, and released as [0.3.21](https://github.com/rust-lang-deprecated/rustc-serialize/releases/tag/0.3.21)\r\n\r\nTiKV includes a [`Cargo.lock`](https://github.com/pingcap/tikv/blob/master/Cargo.lock) which, as a binary, [is appropriate](http://doc.crates.io/faq.html#why-do-binaries-have-cargolock-in-version-control-but-not-libraries). One line in the `Cargo.lock` is this:\r\n\r\nhttps://github.com/pingcap/tikv/blob/8577330ae1ddb9483068d0fae79343b88000b70a/Cargo.lock#L310-L328\r\n\r\nThe offending line is this:\r\n\r\nhttps://github.com/pingcap/tikv/blob/8577330ae1ddb9483068d0fae79343b88000b70a/Cargo.lock#L321\r\n\r\nWe pull in this version of `hyper` via the `rust-prometheus` dependency:\r\n\r\nhttps://github.com/pingcap/tikv/blob/8577330ae1ddb9483068d0fae79343b88000b70a/Cargo.lock#L657-L671\r\n\r\n`rust-prometheus` does not depend on this particular version of `hyper`:\r\n\r\nhttps://github.com/pingcap/rust-prometheus/blob/f24ea12943e03da7412e2e2310e6d955e2004887/Cargo.toml#L48-L53\r\n\r\n## Resolution\r\n\r\nWe can solve this by either manually bumping the `rustc-serialize` version required via:\r\n\r\n```bash\r\ncargo update --package rustc-serialize\r\n```\r\n\r\nOr we can run `cargo update` and make a PR to update other dependencies.\r\n\r\nAccording to `semver` this should be fairly safe since we're locking our dependencies to compatible versions in the `Cargo.toml`. Unfortunately, due to a git based dependencies we have failures:\r\n\r\n<details>\r\n  <summary>Lots of `cargo +nightly test` output</summary>\r\n<pre><code>\r\n$ cargo +nightly test\r\n# ...\r\n   Compiling rocksdb v0.3.0 (https://github.com/pingcap/rust-rocksdb.git#51a5c0c8)\r\nerror[E0432]: unresolved import `tipb::select::SelectRequest`\r\n  --> src/coprocessor/endpoint.rs:20:38\r\n   |\r\n20 | use tipb::select::{self, DAGRequest, SelectRequest};\r\n   |                                      ^^^^^^^^^^^^^ no `SelectRequest` in `select`\r\n\r\nerror[E0432]: unresolved import `tipb::select::SelectRequest`\r\n  --> src/coprocessor/select/select.rs:16:36\r\n   |\r\n16 | use tipb::select::{Chunk, RowMeta, SelectRequest, SelectResponse};\r\n   |                                    ^^^^^^^^^^^^^ no `SelectRequest` in `select`\r\n\r\nerror[E0432]: unresolved import `tipb::select::SelectRequest`\r\n  --> src/coprocessor/endpoint.rs:20:38\r\n   |\r\n20 | use tipb::select::{self, DAGRequest, SelectRequest};\r\n   |                                      ^^^^^^^^^^^^^ no `SelectRequest` in `select`\r\n\r\nerror[E0432]: unresolved import `tipb::select::SelectRequest`\r\n   --> src/coprocessor/select/xeval/evaluator.rs:690:9\r\n    |\r\n690 |     use tipb::select::SelectRequest;\r\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^ no `SelectRequest` in `select`\r\n\r\nerror[E0432]: unresolved import `tipb::select::SelectRequest`\r\n  --> src/coprocessor/select/select.rs:16:36\r\n   |\r\n16 | use tipb::select::{Chunk, RowMeta, SelectRequest, SelectResponse};\r\n   |                                    ^^^^^^^^^^^^^ no `SelectRequest` in `select`\r\n\r\nwarning: unused import: `str`\r\n  --> src/coprocessor/dag/expr/compare.rs:14:11\r\n   |\r\n14 | use std::{str, i64};\r\n   |           ^^^\r\n   |\r\n   = note: #[warn(unused_imports)] on by default\r\n\r\nwarning: unused import: `str`\r\n  --> src/coprocessor/dag/expr/compare.rs:14:11\r\n   |\r\n14 | use std::{str, i64};\r\n   |           ^^^\r\n   |\r\n   = note: #[warn(unused_imports)] on by default\r\n\r\nerror[E0599]: no method named `set_recursion_limit` found for type `protobuf::CodedInputStream<'_>` in the current scope\r\n   --> src/coprocessor/endpoint.rs:318:20\r\n    |\r\n318 |                 is.set_recursion_limit(recursion_limit);\r\n    |                    ^^^^^^^^^^^^^^^^^^^\r\n\r\nerror[E0599]: no method named `set_recursion_limit` found for type `protobuf::CodedInputStream<'_>` in the current scope\r\n   --> src/coprocessor/endpoint.rs:329:20\r\n    |\r\n329 |                 is.set_recursion_limit(recursion_limit);\r\n    |                    ^^^^^^^^^^^^^^^^^^^\r\n\r\nerror[E0599]: no method named `set_recursion_limit` found for type `protobuf::CodedInputStream<'_>` in the current scope\r\n   --> src/coprocessor/endpoint.rs:345:20\r\n    |\r\n345 |                 is.set_recursion_limit(recursion_limit);\r\n    |                    ^^^^^^^^^^^^^^^^^^^\r\n\r\nerror: aborting due to 5 previous errors\r\n\r\nerror: Could not compile `tikv`.\r\nwarning: build failed, waiting for other jobs to finish...\r\nerror[E0599]: no method named `set_recursion_limit` found for type `protobuf::CodedInputStream<'_>` in the current scope\r\n   --> src/coprocessor/endpoint.rs:318:20\r\n    |\r\n318 |                 is.set_recursion_limit(recursion_limit);\r\n    |                    ^^^^^^^^^^^^^^^^^^^\r\n\r\nerror[E0599]: no method named `set_recursion_limit` found for type `protobuf::CodedInputStream<'_>` in the current scope\r\n   --> src/coprocessor/endpoint.rs:329:20\r\n    |\r\n329 |                 is.set_recursion_limit(recursion_limit);\r\n    |                    ^^^^^^^^^^^^^^^^^^^\r\n\r\nerror[E0599]: no method named `set_recursion_limit` found for type `protobuf::CodedInputStream<'_>` in the current scope\r\n   --> src/coprocessor/endpoint.rs:345:20\r\n    |\r\n345 |                 is.set_recursion_limit(recursion_limit);\r\n    |                    ^^^^^^^^^^^^^^^^^^^\r\n\r\nerror: aborting due to 6 previous errors\r\n\r\nerror: Could not compile `tikv`.\r\n\r\nTo learn more, run the command again with --verbose.\r\n</code></pre>\r\n</details>\r\n\r\n\r\n\r\nGiven that we're currently locking our `rustc` version in the Rust dockerfile:\r\n\r\nhttps://github.com/pingcap/tikv/blob/8577330ae1ddb9483068d0fae79343b88000b70a/docker/rust_dockerfile#L40-L42\r\n\r\nAs well as the `circle.yml`:\r\n\r\nhttps://github.com/pingcap/tikv/blob/8577330ae1ddb9483068d0fae79343b88000b70a/circle.yml#L11\r\n\r\nWe can even take this chance update them.\r\n\r\n## Acceptance Criteria\r\n\r\n`rustup update nightly && cargo +nightly test` builds, and all CI tests pass.",
  "closed_at": "2017-12-21T06:14:58Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/2150711?v=4",
    "events_url": "https://api.github.com/users/overvenus/events{/privacy}",
    "followers_url": "https://api.github.com/users/overvenus/followers",
    "following_url": "https://api.github.com/users/overvenus/following{/other_user}",
    "gists_url": "https://api.github.com/users/overvenus/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/overvenus",
    "id": 2150711,
    "login": "overvenus",
    "node_id": "MDQ6VXNlcjIxNTA3MTE=",
    "organizations_url": "https://api.github.com/users/overvenus/orgs",
    "received_events_url": "https://api.github.com/users/overvenus/received_events",
    "repos_url": "https://api.github.com/users/overvenus/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/overvenus/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/overvenus/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/overvenus"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/tikv/tikv/issues/2603/comments",
  "created_at": "2017-12-20T19:03:52Z",
  "events_url": "https://api.github.com/repos/tikv/tikv/issues/2603/events",
  "html_url": "https://github.com/tikv/tikv/issues/2603",
  "id": 283664245,
  "labels": [],
  "labels_url": "https://api.github.com/repos/tikv/tikv/issues/2603/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyODM2NjQyNDU=",
  "number": 2603,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/tikv/tikv",
  "state": "closed",
  "title": "Can't run tests or build on latest nightly",
  "updated_at": "2018-08-07T00:47:22Z",
  "url": "https://api.github.com/repos/tikv/tikv/issues/2603",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/130903?v=4",
    "events_url": "https://api.github.com/users/Hoverbear/events{/privacy}",
    "followers_url": "https://api.github.com/users/Hoverbear/followers",
    "following_url": "https://api.github.com/users/Hoverbear/following{/other_user}",
    "gists_url": "https://api.github.com/users/Hoverbear/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/Hoverbear",
    "id": 130903,
    "login": "Hoverbear",
    "node_id": "MDQ6VXNlcjEzMDkwMw==",
    "organizations_url": "https://api.github.com/users/Hoverbear/orgs",
    "received_events_url": "https://api.github.com/users/Hoverbear/received_events",
    "repos_url": "https://api.github.com/users/Hoverbear/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/Hoverbear/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Hoverbear/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/Hoverbear"
  }
}