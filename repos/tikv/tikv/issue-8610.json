{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nv4.0.3, v4.0.4, v4.0.5 and master.\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\nhttps://github.com/tikv/tikv/pull/7028 introduced a feature that the PD client reconnects to the PD cluster periodically in the PD client thread. However, if other threads call PD sync requests which hold a read lock and wait for the PD client thread completing the request, the deadlock occours because the PD client thread wants to acquire the write lock.\r\n\r\nSome threads' backtrace:\r\n\r\naddr-resolver\r\n```\r\nThread 49 (Thread 0x7f2f30dff700 (LWP 19448)):\r\n#0  futex_wait_cancelable (private=0, expected=0, futex_word=0x7f2f304020ec) at ../sysdeps/nptl/futex-internal.h:183\r\n#1  __pthread_cond_wait_common (abstime=0x0, clockid=0, mutex=0x7f2f30402090, cond=0x7f2f304020c0) at pthread_cond_wait.c:508\r\n#2  __pthread_cond_wait (cond=0x7f2f304020c0, mutex=0x7f2f30402090) at pthread_cond_wait.c:638\r\n#3  0x0000562317f28bb2 in futures::task_impl::std::ThreadNotify::park::hb9c6d2336011224b (self=0x7f2f30441010) at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/sys/unix/condvar.rs:69\r\n#4  0x000056231800dc04 in kvproto::protos::pdpb_grpc::PdClient::get_store_opt::h1d3ede4757ceaee5 (self=<optimized out>, req=<optimized out>, opt=...) at /rust/registry/src/github.com-1ecc6299db9ec823/futures-0.1.29/src/task_impl/std/mod.rs:237\r\n#5  0x000056231805f47e in _$LT$pd_client..client..RpcClient$u20$as$u20$pd_client..PdClient$GT$::get_store::h1116aaaf5646e934 (self=<optimized out>, store_id=<optimized out>) at components/pd_client/src/client.rs:268\r\n#6  0x0000562317d6992c in std::sys_common::backtrace::__rust_begin_short_backtrace::h911d4b4d33daad2e (f=...) at /home/jenkins/agent/workspace/tikv_ghpr_build_release/tikv/src/server/resolve.rs:76\r\n#7  0x0000562317d68cfc in core::ops::function::FnOnce::call_once$u7b$$u7b$vtable.shim$u7d$$u7d$::h8aa8753cfbf47b27 () at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/mod.rs:475\r\n#8  0x000056231849b03a in _$LT$alloc..boxed..Box$LT$F$GT$$u20$as$u20$core..ops..function..FnOnce$LT$A$GT$$GT$::call_once::h13d34828db364579 () at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n#9  _$LT$alloc..boxed..Box$LT$F$GT$$u20$as$u20$core..ops..function..FnOnce$LT$A$GT$$GT$::call_once::hd51b619e0f884abf () at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n#10 std::sys::unix::thread::Thread::new::thread_start::h02c6e34c2c73f344 () at src/libstd/sys/unix/thread.rs:87\r\n#11 0x00007f2f4ac03ea7 in start_thread (arg=<optimized out>) at pthread_create.c:477\r\n#12 0x00007f2f4ab08daf in clone () from /lib/x86_64-linux-gnu/libc.so.6\r\n```\r\n\r\npd-0\r\n```\r\nThread 46 (Thread 0x7f2f333fc700 (LWP 18989)):\r\n#0  futex_abstimed_wait (private=0, abstime=0x0, clockid=0, expected=2, futex_word=<optimized out>) at ../sysdeps/nptl/futex-internal.h:284\r\n#1  __pthread_rwlock_wrlock_full (abstime=0x0, clockid=0, rwlock=0x7f2f3b899580) at pthread_rwlock_common.c:830\r\n#2  __GI___pthread_rwlock_wrlock (rwlock=0x7f2f3b899580) at pthread_rwlock_wrlock.c:27\r\n#3  0x000056231804f5b6 in _$LT$std..sync..rwlock..RwLock$LT$T$GT$$u20$as$u20$tikv_util..HandyRwLock$LT$T$GT$$GT$::wl::h2609cd093c320029 (self=0x7f2f32c09010) at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/sys/unix/rwlock.rs:73\r\n#4  0x000056231804bee2 in _$LT$core..future..from_generator..GenFuture$LT$T$GT$$u20$as$u20$core..future..future..Future$GT$::poll::hc8b2c9fb4410b36c (self=..., cx=0x7f2f333db538) at components/pd_client/src/util.rs:191\r\n#5  0x000056231804ac2e in _$LT$futures_util..future..future..unit_error..UnitError$LT$Fut$GT$$u20$as$u20$core..future..future..Future$GT$::poll::hd9b722a5e3118f92 (self=..., cx=0x7f2f333db538) at components/pd_client/src/client.rs:84\r\n#6  0x000056231804a93f in _$LT$futures_util..compat..compat03as01..Compat$LT$Fut$GT$$u20$as$u20$futures..future..Future$GT$::poll::hf842b363148bae94 (self=0x7f2f4a43d0c0) at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/future.rs:119\r\n#7  0x0000562317f3ebe8 in grpcio::task::executor::poll::h72a0e0c492811446 (cq=<optimized out>, task=..., woken=<optimized out>) at /rust/registry/src/github.com-1ecc6299db9ec823/futures-0.1.29/src/future/mod.rs:113\r\n#8  0x0000562317f3d9e8 in std::sys_common::backtrace::__rust_begin_short_backtrace::h02fc2e0ce18af3bb (f=...) at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.5.3/src/task/executor.rs:136\r\n#9  0x0000562317f3b765 in core::ops::function::FnOnce::call_once$u7b$$u7b$vtable.shim$u7d$$u7d$::hd6ffd35e8771791c () at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/mod.rs:475\r\n#10 0x000056231849b03a in _$LT$alloc..boxed..Box$LT$F$GT$$u20$as$u20$core..ops..function..FnOnce$LT$A$GT$$GT$::call_once::h13d34828db364579 () at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n#11 _$LT$alloc..boxed..Box$LT$F$GT$$u20$as$u20$core..ops..function..FnOnce$LT$A$GT$$GT$::call_once::hd51b619e0f884abf () at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n#12 std::sys::unix::thread::Thread::new::thread_start::h02c6e34c2c73f344 () at src/libstd/sys/unix/thread.rs:87\r\n#13 0x00007f2f4ac03ea7 in start_thread (arg=<optimized out>) at pthread_create.c:477\r\n#14 0x00007f2f4ab08daf in clone () from /lib/x86_64-linux-gnu/libc.so.6\r\n```\r\n\r\n### What did happen?\r\nDeadlock between the PD client thread and other threads calling PD sync requests.",
  "closed_at": "2020-09-07T09:22:22Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/66930949?v=4",
    "events_url": "https://api.github.com/users/ti-srebot/events{/privacy}",
    "followers_url": "https://api.github.com/users/ti-srebot/followers",
    "following_url": "https://api.github.com/users/ti-srebot/following{/other_user}",
    "gists_url": "https://api.github.com/users/ti-srebot/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ti-srebot",
    "id": 66930949,
    "login": "ti-srebot",
    "node_id": "MDQ6VXNlcjY2OTMwOTQ5",
    "organizations_url": "https://api.github.com/users/ti-srebot/orgs",
    "received_events_url": "https://api.github.com/users/ti-srebot/received_events",
    "repos_url": "https://api.github.com/users/ti-srebot/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ti-srebot/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ti-srebot/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ti-srebot"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/tikv/tikv/issues/8610/comments",
  "created_at": "2020-09-07T07:33:41Z",
  "events_url": "https://api.github.com/repos/tikv/tikv/issues/8610/events",
  "html_url": "https://github.com/tikv/tikv/issues/8610",
  "id": 694809616,
  "labels": [
    {
      "color": "d1fad7",
      "default": false,
      "description": "Component: pd",
      "id": 1158875561,
      "name": "component/pd-client",
      "node_id": "MDU6TGFiZWwxMTU4ODc1NTYx",
      "url": "https://api.github.com/repos/tikv/tikv/labels/component/pd-client"
    },
    {
      "color": "ededed",
      "default": false,
      "description": null,
      "id": 2265335491,
      "name": "severity/Critical",
      "node_id": "MDU6TGFiZWwyMjY1MzM1NDkx",
      "url": "https://api.github.com/repos/tikv/tikv/labels/severity/Critical"
    },
    {
      "color": "1d76db",
      "default": false,
      "description": "Type: Issue - Confirmed a bug",
      "id": 305526945,
      "name": "type/bug",
      "node_id": "MDU6TGFiZWwzMDU1MjY5NDU=",
      "url": "https://api.github.com/repos/tikv/tikv/labels/type/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/tikv/tikv/issues/8610/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-09-09T08:44:51Z",
    "closed_issues": 23,
    "created_at": "2020-08-21T05:38:04Z",
    "creator": {
      "avatar_url": "https://avatars1.githubusercontent.com/u/13497871?v=4",
      "events_url": "https://api.github.com/users/Connor1996/events{/privacy}",
      "followers_url": "https://api.github.com/users/Connor1996/followers",
      "following_url": "https://api.github.com/users/Connor1996/following{/other_user}",
      "gists_url": "https://api.github.com/users/Connor1996/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/Connor1996",
      "id": 13497871,
      "login": "Connor1996",
      "node_id": "MDQ6VXNlcjEzNDk3ODcx",
      "organizations_url": "https://api.github.com/users/Connor1996/orgs",
      "received_events_url": "https://api.github.com/users/Connor1996/received_events",
      "repos_url": "https://api.github.com/users/Connor1996/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/Connor1996/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Connor1996/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/Connor1996"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/tikv/tikv/milestone/48",
    "id": 5795555,
    "labels_url": "https://api.github.com/repos/tikv/tikv/milestones/48/labels",
    "node_id": "MDk6TWlsZXN0b25lNTc5NTU1NQ==",
    "number": 48,
    "open_issues": 0,
    "state": "closed",
    "title": "v4.0.6",
    "updated_at": "2020-09-15T09:55:39Z",
    "url": "https://api.github.com/repos/tikv/tikv/milestones/48"
  },
  "node_id": "MDU6SXNzdWU2OTQ4MDk2MTY=",
  "number": 8610,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/tikv/tikv",
  "state": "closed",
  "title": "Deadlock between the PD client thread and other threads calling PD sync requests.",
  "updated_at": "2020-09-10T05:52:12Z",
  "url": "https://api.github.com/repos/tikv/tikv/issues/8610",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/14819777?v=4",
    "events_url": "https://api.github.com/users/youjiali1995/events{/privacy}",
    "followers_url": "https://api.github.com/users/youjiali1995/followers",
    "following_url": "https://api.github.com/users/youjiali1995/following{/other_user}",
    "gists_url": "https://api.github.com/users/youjiali1995/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/youjiali1995",
    "id": 14819777,
    "login": "youjiali1995",
    "node_id": "MDQ6VXNlcjE0ODE5Nzc3",
    "organizations_url": "https://api.github.com/users/youjiali1995/orgs",
    "received_events_url": "https://api.github.com/users/youjiali1995/received_events",
    "repos_url": "https://api.github.com/users/youjiali1995/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/youjiali1995/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/youjiali1995/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/youjiali1995"
  }
}