{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "This is a follow up to a previous issue: https://github.com/envoyproxy/envoy/issues/5622\r\nFirst of all, thanks for that fix. It did help for the case, when management server doesn't accept TCP connection.\r\n\r\nHovewer, the problem still exists when management server accepts the connection, but doesn't send any response.\r\nEnvoy will be in `PRE_INITIALIZING` state forever in that case.\r\n\r\nWe tried to set `timeout` parameter (https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/core/grpc_service.proto#core-grpcservice), but it changes nothing.\r\n\r\nThe problem can be easily reproduced by replacing the management server with `nc`:\r\n\r\n1. Run nc in listening mode `nc -l 50000`\r\n2. Run envoy with config presented at the end of the post. \r\n3. In envoy admin, you will see that envoy is in `PRE_INITIALIZING` state forever\r\n4. In nc output you will see, that envoy sent xDS request. \r\n\r\nThe real world scenario for this is a heavily loaded management server, that manages to accept TCP connection, but fails to deliver response in acceptable time. \r\n\r\nI think it would be nice to be able to configure Envoy in a way that it would be immune to any problem with management server. It should work with static-config-only in that case.\r\n\r\nTested on commit `f9107b2`\r\n\r\n```yaml\r\nnode:\r\n  id: \"node-1\"\r\n  cluster: \"nodes\"\r\nstatic_resources:\r\n  listeners:\r\n  - name: full_static_listener\r\n    address:\r\n      socket_address:\r\n        address: 0.0.0.0\r\n        port_value: 7000\r\n    filter_chains:\r\n    - filters:\r\n      - name: envoy.http_connection_manager\r\n        config:\r\n          stat_prefix: full_static_http\r\n          route_config:\r\n            name: full_static_routes\r\n            virtual_hosts:\r\n            - name: route\r\n              domains:\r\n              - \"*\"\r\n              routes:\r\n              - match:\r\n                  prefix: \"/\"\r\n                route:\r\n                  cluster: \"static_service\"\r\n          http_filters:\r\n          - name: envoy.router\r\n  clusters:\r\n  - name: static_service\r\n    type: STATIC\r\n    hosts:\r\n    - socket_address:\r\n        address: 127.0.0.1\r\n        port_value: 8080\r\n    connect_timeout: 1s\r\n  - name: xds\r\n    type: static\r\n    hosts:\r\n    - socket_address:\r\n        address: 192.168.65.2  # netcat listen on this address\r\n        port_value: 50000\r\n    connect_timeout: 1s\r\n    http2_protocol_options: {}\r\n\r\ndynamic_resources:\r\n  cds_config:\r\n    api_config_source:\r\n      api_type: GRPC\r\n      grpc_services:\r\n      - envoy_grpc:\r\n          cluster_name: xds\r\n        timeout: 1s\r\n\r\nadmin:\r\n  access_log_path: \"/dev/null\"\r\n  address:\r\n    socket_address:\r\n      address: 0.0.0.0\r\n      port_value: 6000\r\n```",
  "closed_at": "2019-03-15T04:50:57Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/10914751?v=4",
    "events_url": "https://api.github.com/users/htuch/events{/privacy}",
    "followers_url": "https://api.github.com/users/htuch/followers",
    "following_url": "https://api.github.com/users/htuch/following{/other_user}",
    "gists_url": "https://api.github.com/users/htuch/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/htuch",
    "id": 10914751,
    "login": "htuch",
    "node_id": "MDQ6VXNlcjEwOTE0NzUx",
    "organizations_url": "https://api.github.com/users/htuch/orgs",
    "received_events_url": "https://api.github.com/users/htuch/received_events",
    "repos_url": "https://api.github.com/users/htuch/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/htuch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/htuch/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/htuch"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5862/comments",
  "created_at": "2019-02-06T18:00:38Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5862/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/5862",
  "id": 407359676,
  "labels": [
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5862/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MDczNTk2NzY=",
  "number": 5862,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Envoy is stuck in PRE_INITIALIZING state when management server doesn't respond",
  "updated_at": "2019-03-15T04:50:57Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/5862",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/30294040?v=4",
    "events_url": "https://api.github.com/users/MarcinFalkowski/events{/privacy}",
    "followers_url": "https://api.github.com/users/MarcinFalkowski/followers",
    "following_url": "https://api.github.com/users/MarcinFalkowski/following{/other_user}",
    "gists_url": "https://api.github.com/users/MarcinFalkowski/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/MarcinFalkowski",
    "id": 30294040,
    "login": "MarcinFalkowski",
    "node_id": "MDQ6VXNlcjMwMjk0MDQw",
    "organizations_url": "https://api.github.com/users/MarcinFalkowski/orgs",
    "received_events_url": "https://api.github.com/users/MarcinFalkowski/received_events",
    "repos_url": "https://api.github.com/users/MarcinFalkowski/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/MarcinFalkowski/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MarcinFalkowski/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/MarcinFalkowski"
  }
}