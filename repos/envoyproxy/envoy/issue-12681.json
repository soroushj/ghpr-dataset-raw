{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "## The issue\r\nCurrently, when rejecting a request envoy logs only \"enforced denied\" with the code below:\r\n\r\n```\r\n  const auto engine =\r\n      config_->engine(callbacks_->route(), Filters::Common::RBAC::EnforcementMode::Enforced);\r\n  if (engine != nullptr) {\r\n    if (engine->handleAction(*callbacks_->connection(), headers, callbacks_->streamInfo(),\r\n                             nullptr)) {\r\n    // ...\r\n    } else {\r\n      ENVOY_LOG(debug, \"enforced denied\");\r\n    // ...\r\n    }\r\n  }\r\n```\r\n\r\nThere is no means for a proxy user (operator) to find out which rule exactly denied the request (esp. when many rules are affecting the proxy). Knowing which rule denied the request would make troubleshooting much easier.\r\n\r\nFixing this would help resolve the following issue https://github.com/istio/istio/issues/25618\r\n\r\n## The fix\r\nThe engine_impl `handleAction()` method already receives a pointer to a string where to update which policy was enforced:\r\n```\r\nbool RoleBasedAccessControlEngineImpl::checkPolicyMatch(//... , \r\n    std::string* effective_policy_id) const {\r\n    //....\r\n      if (effective_policy_id != nullptr) {\r\n        *effective_policy_id = policy.first;\r\n      }\r\n    //....\r\n}\r\n``` \r\n\r\nCurious, to why this isn't being used?",
  "closed_at": "2020-08-27T21:44:12Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1016047?v=4",
    "events_url": "https://api.github.com/users/lizan/events{/privacy}",
    "followers_url": "https://api.github.com/users/lizan/followers",
    "following_url": "https://api.github.com/users/lizan/following{/other_user}",
    "gists_url": "https://api.github.com/users/lizan/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lizan",
    "id": 1016047,
    "login": "lizan",
    "node_id": "MDQ6VXNlcjEwMTYwNDc=",
    "organizations_url": "https://api.github.com/users/lizan/orgs",
    "received_events_url": "https://api.github.com/users/lizan/received_events",
    "repos_url": "https://api.github.com/users/lizan/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lizan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lizan/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lizan"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12681/comments",
  "created_at": "2020-08-17T10:19:28Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12681/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/12681",
  "id": 680120785,
  "labels": [
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12681/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2ODAxMjA3ODU=",
  "number": 12681,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Log which Policy rejected a request",
  "updated_at": "2020-08-27T21:44:12Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/12681",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/9026451?v=4",
    "events_url": "https://api.github.com/users/rinormaloku/events{/privacy}",
    "followers_url": "https://api.github.com/users/rinormaloku/followers",
    "following_url": "https://api.github.com/users/rinormaloku/following{/other_user}",
    "gists_url": "https://api.github.com/users/rinormaloku/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rinormaloku",
    "id": 9026451,
    "login": "rinormaloku",
    "node_id": "MDQ6VXNlcjkwMjY0NTE=",
    "organizations_url": "https://api.github.com/users/rinormaloku/orgs",
    "received_events_url": "https://api.github.com/users/rinormaloku/received_events",
    "repos_url": "https://api.github.com/users/rinormaloku/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rinormaloku/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rinormaloku/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rinormaloku"
  }
}