{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/34292400?v=4",
    "events_url": "https://api.github.com/users/AndresGuedez/events{/privacy}",
    "followers_url": "https://api.github.com/users/AndresGuedez/followers",
    "following_url": "https://api.github.com/users/AndresGuedez/following{/other_user}",
    "gists_url": "https://api.github.com/users/AndresGuedez/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/AndresGuedez",
    "id": 34292400,
    "login": "AndresGuedez",
    "node_id": "MDQ6VXNlcjM0MjkyNDAw",
    "organizations_url": "https://api.github.com/users/AndresGuedez/orgs",
    "received_events_url": "https://api.github.com/users/AndresGuedez/received_events",
    "repos_url": "https://api.github.com/users/AndresGuedez/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/AndresGuedez/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AndresGuedez/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/AndresGuedez"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/34292400?v=4",
      "events_url": "https://api.github.com/users/AndresGuedez/events{/privacy}",
      "followers_url": "https://api.github.com/users/AndresGuedez/followers",
      "following_url": "https://api.github.com/users/AndresGuedez/following{/other_user}",
      "gists_url": "https://api.github.com/users/AndresGuedez/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/AndresGuedez",
      "id": 34292400,
      "login": "AndresGuedez",
      "node_id": "MDQ6VXNlcjM0MjkyNDAw",
      "organizations_url": "https://api.github.com/users/AndresGuedez/orgs",
      "received_events_url": "https://api.github.com/users/AndresGuedez/received_events",
      "repos_url": "https://api.github.com/users/AndresGuedez/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/AndresGuedez/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AndresGuedez/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/AndresGuedez"
    }
  ],
  "author_association": "MEMBER",
  "body": "*Description*:\r\nIn the case envoy is proxying large HTTP request, even upstream returns 413, the client of proxy is getting 503.\r\n\r\n*Repro steps*:\r\nA sample envoy config is [here](https://gist.github.com/lizan/14fdcdebc332088eb03501dcbffdf48f).\r\n\r\n```\r\n$ curl -v http://127.0.0.1:8080 --data @envoy.log\r\n> POST / HTTP/1.1\r\n> Host: 127.0.0.1:8080\r\n> User-Agent: curl/7.47.0\r\n> Accept: */*\r\n> Content-Length: 28576635\r\n> Content-Type: application/x-www-form-urlencoded\r\n> Expect: 100-continue\r\n>\r\n< HTTP/1.1 100 Continue\r\n< HTTP/1.1 413 Payload Too Large\r\n< content-length: 17\r\n< content-type: text/plain\r\n< date: Thu, 29 Mar 2018 02:10:27 GMT\r\n< server: envoy\r\n< connection: close\r\n<\r\n* we are done reading and this is set to close, stop send\r\n* Closing connection 0\r\n```\r\nis hitting directly to listener with buffer filter, results 413.\r\n\r\nHowever,\r\n```\r\ncurl -v http://127.0.0.1:8000 --data @envoy.log\r\n> POST / HTTP/1.1\r\n> Host: 127.0.0.1:8000\r\n> User-Agent: curl/7.47.0\r\n> Accept: */*\r\n> Content-Length: 28576635\r\n> Content-Type: application/x-www-form-urlencoded\r\n> Expect: 100-continue\r\n>\r\n< HTTP/1.1 100 Continue\r\n< HTTP/1.1 503 Service Unavailable\r\n< content-length: 57\r\n< content-type: text/plain\r\n< date: Thu, 29 Mar 2018 02:10:21 GMT\r\n< server: envoy\r\n< connection: close\r\n<\r\n```\r\nwill results 503, the port 8000 is proxying to 8080, which should return 413 too.\r\n\r\n`envoy.log` above could be substitute with any large file (mine is 28MB), if you use smaller file (around 10K) which could fit in the TCP buffer, the port 8000 will return 413 correctly:\r\n\r\n```\r\ncurl -v http://127.0.0.1:8000 --data @STYLE.md\r\n> POST / HTTP/1.1\r\n> Host: 127.0.0.1:8000\r\n> User-Agent: curl/7.47.0\r\n> Accept: */*\r\n> Content-Length: 11450\r\n> Content-Type: application/x-www-form-urlencoded\r\n> Expect: 100-continue\r\n>\r\n< HTTP/1.1 100 Continue\r\n* We are completely uploaded and fine\r\n< HTTP/1.1 413 Payload Too Large\r\n< content-length: 17\r\n< content-type: text/plain\r\n< date: Thu, 29 Mar 2018 02:15:29 GMT\r\n< server: envoy\r\n< x-envoy-upstream-service-time: 0\r\n<\r\n```\r\n\r\nFrom the trace log below, it looks like when envoy write to upstream and it fails, it immediately result 503 without trying to read if the server already sent back the response.\r\n```\r\n[2018-03-28 19:02:10.131][23666][trace][http] source/common/http/http1/codec_impl.cc:322] [C1] parsed 1048576 bytes\r\n[2018-03-28 19:02:10.131][23666][trace][connection] source/common/network/connection_impl.cc:386] [C2] socket event: 2\r\n[2018-03-28 19:02:10.131][23666][trace][connection] source/common/network/connection_impl.cc:454] [C2] write ready\r\n[2018-03-28 19:02:10.131][23666][trace][connection] source/common/network/raw_buffer_socket.cc:67] [C2] write returns: 524288\r\n[2018-03-28 19:02:10.131][23666][trace][connection] source/common/network/raw_buffer_socket.cc:67] [C2] write returns: -1\r\n[2018-03-28 19:02:10.131][23666][trace][connection] source/common/network/raw_buffer_socket.cc:70] [C2] write error: 32 (Broken pipe)\r\n[2018-03-28 19:02:10.131][23666][debug][connection] source/common/network/connection_impl.cc:134] [C2] closing socket: 0\r\n[2018-03-28 19:02:10.131][23666][trace][http] source/common/http/http1/codec_impl.cc:305] [C2] parsing 0 bytes\r\n[2018-03-28 19:02:10.131][23666][trace][http] source/common/http/http1/codec_impl.cc:322] [C2] parsed 0 bytes\r\n[2018-03-28 19:02:10.131][23666][debug][client] source/common/http/codec_client.cc:81] [C2] disconnect. resetting 1 pending requests\r\n[2018-03-28 19:02:10.131][23666][debug][client] source/common/http/codec_client.cc:104] [C2] request reset\r\n[2018-03-28 19:02:10.131][23666][trace][main] source/common/event/dispatcher_impl.cc:126] item added to deferred deletion list (size=1)\r\n[2018-03-28 19:02:10.131][23666][debug][router] source/common/router/router.cc:464] [C1][S12280405291311848063] upstream reset\r\n[2018-03-28 19:02:10.132][23666][debug][http] source/common/http/conn_manager_impl.cc:968] [C1][S12280405291311848063] encoding headers via codec (end_stream=false):\r\n[2018-03-28 19:02:10.132][23666][debug][http] source/common/http/conn_manager_impl.cc:972] [C1][S12280405291311848063]   ':status':'503'\r\n[2018-03-28 19:02:10.132][23666][debug][http] source/common/http/conn_manager_impl.cc:972] [C1][S12280405291311848063]   'content-length':'57'\r\n[2018-03-28 19:02:10.132][23666][debug][http] source/common/http/conn_manager_impl.cc:972] [C1][S12280405291311848063]   'content-type':'text/plain'\r\n[2018-03-28 19:02:10.132][23666][debug][http] source/common/http/conn_manager_impl.cc:972] [C1][S12280405291311848063]   'date':'Thu, 29 Mar 2018 02:02:10 GMT'\r\n[2018-03-28 19:02:10.132][23666][debug][http] source/common/http/conn_manager_impl.cc:972] [C1][S12280405291311848063]   'server':'envoy'\r\n[2018-03-28 19:02:10.132][23666][debug][http] source/common/http/conn_manager_impl.cc:972] [C1][S12280405291311848063]   'connection':'close'\r\n[2018-03-28 19:02:10.132][23666][trace][connection] source/common/network/connection_impl.cc:323] [C1] writing 153 bytes, end_stream false\r\n[2018-03-28 19:02:10.132][23666][trace][http] source/common/http/conn_manager_impl.cc:1031] [C1][S12280405291311848063] encoding data via codec (size=57 end_stream=true)\r\n[2018-03-28 19:02:10.132][23666][trace][connection] source/common/network/connection_impl.cc:323] [C1] writing 57 bytes, end_stream false\r\n```\r\n\r\nThanks @JimmyCYJ who originally find this with adding test in istio for #2919.",
  "closed_at": "2018-09-24T23:07:31Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 20,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/2929/comments",
  "created_at": "2018-03-29T02:19:25Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/2929/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/2929",
  "id": 309595085,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/2929/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMDk1OTUwODU=",
  "number": 2929,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "http: not proxying 413 correctly ",
  "updated_at": "2018-09-24T23:07:31Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/2929",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1016047?v=4",
    "events_url": "https://api.github.com/users/lizan/events{/privacy}",
    "followers_url": "https://api.github.com/users/lizan/followers",
    "following_url": "https://api.github.com/users/lizan/following{/other_user}",
    "gists_url": "https://api.github.com/users/lizan/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lizan",
    "id": 1016047,
    "login": "lizan",
    "node_id": "MDQ6VXNlcjEwMTYwNDc=",
    "organizations_url": "https://api.github.com/users/lizan/orgs",
    "received_events_url": "https://api.github.com/users/lizan/received_events",
    "repos_url": "https://api.github.com/users/lizan/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lizan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lizan/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lizan"
  }
}