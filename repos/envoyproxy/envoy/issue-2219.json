{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "*Title*: Envoy fails to parse cds v1 responses\r\n\r\n*Description*:\r\nwhen running both v1.5.0 and d5865073b with v1 controlplane envoy fails to validate v1 CDS response with \"ssl_context\" set in a cluster.\r\n\r\nI've tracked the issue and it boils down to adding empty \"certificate_chain\" and \"private_key\" fields in UpstreamTlsContext and failing validation later. This bug is similar to #2188 which was fixed in #2190. I didn't have close look, but I suspect that there are might be more bugs of this kind. The code has a pattern which provoking such issues. For instance:\r\n```\r\nupstream_tls_context.set_sni(json_tls_context.getString(\"sni\", \"\"));\r\n```\r\n\r\nI have a patch. I'll prepare a PR.\r\n\r\n*Repro steps*:\r\n*Config*:\r\nbootstrap config\r\n```yaml\r\nnode:\r\n  id: node-id\r\n  cluster: cluster-id\r\n  locality:\r\n    region: Europe\r\n    zone: zone-id\r\nstatic_resources:\r\n  listeners:\r\n  - name: tcp-127.0.0.1-9211\r\n    address:\r\n      socket_address:\r\n        address: 127.0.0.1\r\n        port_value: 9211\r\n    filter_chains:\r\n    - filters:\r\n      - name: envoy.http_connection_manager\r\n        config:\r\n          stat_prefix: egress_default\r\n          rds:\r\n            route_config_name: default\r\n            config_source:\r\n              api_config_source:\r\n                api_type: REST_LEGACY\r\n                refresh_delay: 1s\r\n                cluster_name: controlplane\r\n          http_filters:\r\n          - name: envoy.router\r\n            config: {}\r\n          add_user_agent: true\r\n          use_remote_address: true\r\n          generate_request_id: true\r\n          idle_timeout: 300s\r\n  clusters:\r\n  - name: controlplane\r\n    type: STRICT_DNS\r\n    lb_policy: RANDOM\r\n    connect_timeout: 1s\r\n    hosts:\r\n    - socket_address:\r\n        address: 127.0.0.1\r\n        port_value: 9902\r\ndynamic_resources:\r\n  cds_config:\r\n    api_config_source:\r\n      api_type: REST_LEGACY\r\n      cluster_name: controlplane\r\n      refresh_delay: 1s\r\n  deprecated_v1:\r\n    sds_config:\r\n      api_config_source:\r\n        api_type: REST_LEGACY\r\n        cluster_name: controlplane\r\n        refresh_delay: 1s\r\nadmin:\r\n  access_log_path: admin_access.log\r\n  profile_path: envoy.prof\r\n  address:\r\n    socket_address:\r\n      address: 127.0.0.1\r\n      port_value: 9901\r\nruntime:\r\n  symlink_root: \".\"\r\n  subdirectory: \"\"\r\n  override_subdirectory: override\r\n```\r\n\r\nCDS response:\r\n```json\r\n{\r\n  \"clusters\": [\r\n    {\r\n      \"name\": \"application\",\r\n      \"service_name\": \"24d50d27e783772202ff14f61dbd273b\",\r\n      \"type\": \"sds\",\r\n      \"connect_timeout_ms\": 1000,\r\n      \"lb_type\": \"least_request\",\r\n      \"ssl_context\": {\r\n        \"ca_cert_file\": \"ca-bundle.crt\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n*Logs*:\r\n```\r\n[2017-12-17 01:24:23.616][9026645][warning][upstream] source/common/upstream/cds_subscription.cc:68] cds: fetch failure: Proto constraint validation failed (ClusterValidationError.TlsContext: [\"embedded message failed validation\"] | caused by UpstreamTlsContextValidationError.CommonTlsContext: [\"embedded message failed validation\"] | caused by CommonTlsContextValidationError.TlsCertificates[i]: [\"embedded message failed validation\"] | caused by TlsCertificateValidationError.CertificateChain: [\"embedded message failed validation\"] | caused by DataSour\r\nceValidationError.Filename: [\"value length must be at least \" '\\x01' \" bytes\"]): name: \"application\"                                                                                                                                                                                  type: EDS\r\neds_cluster_config {\r\n  eds_config {\r\n    api_config_source {\r\n      cluster_name: \"controlplane\"\r\n      refresh_delay {\r\n        seconds: 1\r\n      }\r\n    }\r\n  }\r\n  service_name: \"24d50d27e783772202ff14f61dbd273b\"\r\n}\r\nconnect_timeout {\r\n  seconds: 1\r\n}\r\nlb_policy: LEAST_REQUEST\r\ntls_context {\r\n  common_tls_context {\r\n    tls_certificates {\r\n      certificate_chain {\r\n        filename: \"\"\r\n      }\r\n      private_key {\r\n        filename: \"\"\r\n      }\r\n    }\r\n    validation_context {\r\n      trusted_ca {\r\n        filename: \"ca-bundle.crt\"\r\n      }\r\n    }\r\n    deprecated_v1 {\r\n    }\r\n  }\r\n}\r\ndns_lookup_family: V4_ONLY\r\n```\r\n",
  "closed_at": "2017-12-18T11:06:16Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/10914751?v=4",
    "events_url": "https://api.github.com/users/htuch/events{/privacy}",
    "followers_url": "https://api.github.com/users/htuch/followers",
    "following_url": "https://api.github.com/users/htuch/following{/other_user}",
    "gists_url": "https://api.github.com/users/htuch/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/htuch",
    "id": 10914751,
    "login": "htuch",
    "node_id": "MDQ6VXNlcjEwOTE0NzUx",
    "organizations_url": "https://api.github.com/users/htuch/orgs",
    "received_events_url": "https://api.github.com/users/htuch/received_events",
    "repos_url": "https://api.github.com/users/htuch/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/htuch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/htuch/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/htuch"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/2219/comments",
  "created_at": "2017-12-17T00:36:01Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/2219/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/2219",
  "id": 282660640,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/2219/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyODI2NjA2NDA=",
  "number": 2219,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Envoy fails to parse cds v1 responses",
  "updated_at": "2017-12-18T16:23:33Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/2219",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/4630547?v=4",
    "events_url": "https://api.github.com/users/ikruglov/events{/privacy}",
    "followers_url": "https://api.github.com/users/ikruglov/followers",
    "following_url": "https://api.github.com/users/ikruglov/following{/other_user}",
    "gists_url": "https://api.github.com/users/ikruglov/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ikruglov",
    "id": 4630547,
    "login": "ikruglov",
    "node_id": "MDQ6VXNlcjQ2MzA1NDc=",
    "organizations_url": "https://api.github.com/users/ikruglov/orgs",
    "received_events_url": "https://api.github.com/users/ikruglov/received_events",
    "repos_url": "https://api.github.com/users/ikruglov/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ikruglov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ikruglov/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ikruglov"
  }
}