{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "*Description*:\r\nEnvoy segfaults when validating a config file that has RTDS defined.  Expected behavior: Envoy should not segfault.\r\n\r\n*Repro steps*:\r\nRun `./envoy --mode validate -c my-rtds-config-file.yaml --service-node abc --service-cluster testing -l debug` on the config file below.  \r\n\r\nCommenting out the `foobar` layer in `layered_runtime.layers[]` in the config makes the segfault go away.\r\n\r\n*Config*:\r\n```\r\nadmin:\r\n  access_log_path: /tmp/admin_access.log\r\n  address:\r\n    socket_address:\r\n      protocol: TCP\r\n      address: 127.0.0.1\r\n      port_value: 9901\r\nstatic_resources:\r\n  listeners:\r\n  - address:\r\n      socket_address:\r\n        address: 127.0.0.1\r\n        port_value: 10000\r\n    filter_chains:\r\n    - filters:\r\n      - name: envoy.http_connection_manager\r\n        typed_config:\r\n          \"@type\": type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager\r\n          codec_type: auto\r\n          stat_prefix: ingress_http\r\n          route_config:\r\n            name: local_route\r\n            virtual_hosts:\r\n            - name: google_vh\r\n              domains:\r\n              - \"*\"\r\n              routes:\r\n              - match:\r\n                  prefix: /\r\n                route:\r\n                  host_rewrite: www.google.com\r\n                  cluster: service_google\r\n          http_filters:\r\n          - name: envoy.fault\r\n            typed_config:\r\n              \"@type\": type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault\r\n              abort:\r\n                http_status: 503\r\n                percentage:\r\n                  numerator: 0\r\n                  denominator: HUNDRED\r\n          - name: envoy.router\r\n            typed_config: {}\r\n  clusters:\r\n  - name: service_google\r\n    connect_timeout: 0.25s\r\n    type: LOGICAL_DNS\r\n    # Comment out the following line to test on v6 networks\r\n    dns_lookup_family: V4_ONLY\r\n    lb_policy: ROUND_ROBIN\r\n    load_assignment:\r\n      cluster_name: service_google\r\n      endpoints:\r\n      - lb_endpoints:\r\n        - endpoint:\r\n            address:\r\n              socket_address:\r\n                address: www.google.com\r\n                port_value: 443\r\n    tls_context:\r\n      sni: www.google.com\r\n  - name: xds_cluster\r\n    connect_timeout: 0.25s\r\n    type: STATIC\r\n    lb_policy: ROUND_ROBIN\r\n    http2_protocol_options: {}\r\n    upstream_connection_options:\r\n      # configure a TCP keep-alive to detect and reconnect to the admin\r\n      # server in the event of a TCP socket half open connection\r\n      tcp_keepalive: {}\r\n    load_assignment:\r\n      cluster_name: xds_cluster\r\n      endpoints:\r\n      - lb_endpoints:\r\n        - endpoint:\r\n            address:\r\n              socket_address:\r\n                address: 127.0.0.1\r\n                port_value: 18000\r\nlayered_runtime:\r\n  layers:\r\n    - name: foobar\r\n      rtds_layer:\r\n        rtds_config:\r\n          api_config_source:\r\n            api_type: GRPC\r\n            grpc_services:\r\n              envoy_grpc:\r\n                cluster_name: xds_cluster\r\n        name: foobar\r\n    - name: admin\r\n      admin_layer: {}\r\n```\r\n\r\n*Logs*:\r\n\r\nThe output is:\r\n```\r\n\u279c  ./envoy --mode validate -c my-rtds-config-file.yaml --service-node abc --service-cluster testing -l debug\r\n[2019-11-11 13:42:10.286][15786616][info][main] [source/server/server.cc:432] runtime: layers:\r\n  - name: foobar\r\n    rtds_layer:\r\n      name: foobar\r\n      rtds_config:\r\n        api_config_source:\r\n          api_type: GRPC\r\n          grpc_services:\r\n            - envoy_grpc:\r\n                cluster_name: xds_cluster\r\n  - name: admin\r\n    admin_layer:\r\n      {}\r\n[2019-11-11 13:42:10.288][15786616][debug][init] [source/common/init/manager_impl.cc:20] added target RTDS foobar to init manager Validation server\r\n[2019-11-11 13:42:10.288][15786616][info][config] [source/server/configuration_impl.cc:61] loading 0 static secret(s)\r\n[2019-11-11 13:42:10.288][15786616][info][config] [source/server/configuration_impl.cc:67] loading 2 cluster(s)\r\n[2019-11-11 13:42:10.288][15786680][debug][grpc] [source/common/grpc/google_async_client_impl.cc:43] completionThread running\r\n[2019-11-11 13:42:10.301][15786616][debug][upstream] [source/common/upstream/cluster_manager_impl.cc:839] adding TLS initial cluster service_google\r\n[2019-11-11 13:42:10.302][15786616][debug][upstream] [source/common/upstream/cluster_manager_impl.cc:839] adding TLS initial cluster xds_cluster\r\n[2019-11-11 13:42:10.302][15786616][debug][upstream] [source/common/upstream/logical_dns_cluster.cc:69] starting async DNS resolution for www.google.com\r\n[2019-11-11 13:42:10.302][15786616][debug][upstream] [source/common/upstream/logical_dns_cluster.cc:76] async DNS resolution complete for www.google.com\r\n[2019-11-11 13:42:10.302][15786616][debug][upstream] [source/common/upstream/upstream_impl.cc:773] initializing secondary cluster service_google completed\r\n[2019-11-11 13:42:10.302][15786616][debug][init] [source/common/init/manager_impl.cc:45] init manager Cluster service_google contains no targets\r\n[2019-11-11 13:42:10.303][15786616][debug][init] [source/common/init/watcher_impl.cc:14] init manager Cluster service_google initialized, notifying ClusterImplBase\r\n[2019-11-11 13:42:10.303][15786616][debug][upstream] [source/common/upstream/cluster_manager_impl.cc:103] cm init: init complete: cluster=service_google primary=0 secondary=0\r\n[2019-11-11 13:42:10.303][15786616][debug][upstream] [source/common/upstream/cluster_manager_impl.cc:75] cm init: adding: cluster=service_google primary=0 secondary=0\r\n[2019-11-11 13:42:10.303][15786616][debug][upstream] [source/common/upstream/upstream_impl.cc:773] initializing secondary cluster xds_cluster completed\r\n[2019-11-11 13:42:10.303][15786616][debug][init] [source/common/init/manager_impl.cc:45] init manager Cluster xds_cluster contains no targets\r\n[2019-11-11 13:42:10.303][15786616][debug][init] [source/common/init/watcher_impl.cc:14] init manager Cluster xds_cluster initialized, notifying ClusterImplBase\r\n[2019-11-11 13:42:10.303][15786616][debug][upstream] [source/common/upstream/cluster_manager_impl.cc:999] membership update for TLS cluster xds_cluster added 1 removed 0\r\n[2019-11-11 13:42:10.303][15786616][debug][upstream] [source/common/upstream/cluster_manager_impl.cc:103] cm init: init complete: cluster=xds_cluster primary=0 secondary=0\r\n[2019-11-11 13:42:10.303][15786616][debug][upstream] [source/common/upstream/cluster_manager_impl.cc:75] cm init: adding: cluster=xds_cluster primary=0 secondary=0\r\n[2019-11-11 13:42:10.303][15786616][info][upstream] [source/common/upstream/cluster_manager_impl.cc:148] cm init: all clusters initialized\r\n[2019-11-11 13:42:10.303][15786616][info][config] [source/server/configuration_impl.cc:71] loading 1 listener(s)\r\n[2019-11-11 13:42:10.303][15786616][debug][config] [source/server/configuration_impl.cc:73] listener #0:\r\n[2019-11-11 13:42:10.303][15786616][debug][config] [source/server/listener_manager_impl.cc:494] begin add/update listener: name=3013f5f6-96a0-4fad-ab2f-f90d02b77f10 hash=15202758330632086537\r\n[2019-11-11 13:42:10.304][15786616][debug][config] [source/server/listener_manager_impl.cc:57]   filter #0:\r\n[2019-11-11 13:42:10.304][15786616][debug][config] [source/server/listener_manager_impl.cc:58]     name: envoy.http_connection_manager\r\n[2019-11-11 13:42:10.304][15786616][debug][config] [source/server/listener_manager_impl.cc:61]   config: {}\r\n[2019-11-11 13:42:10.307][15786616][debug][config] [source/extensions/filters/network/http_connection_manager/config.cc:340]     http filter #0\r\n[2019-11-11 13:42:10.307][15786616][debug][config] [source/extensions/filters/network/http_connection_manager/config.cc:341]       name: envoy.fault\r\n[2019-11-11 13:42:10.307][15786616][debug][config] [source/extensions/filters/network/http_connection_manager/config.cc:345]     config: {}\r\n[2019-11-11 13:42:10.308][15786616][debug][config] [source/extensions/filters/network/http_connection_manager/config.cc:340]     http filter #1\r\n[2019-11-11 13:42:10.308][15786616][debug][config] [source/extensions/filters/network/http_connection_manager/config.cc:341]       name: envoy.router\r\n[2019-11-11 13:42:10.308][15786616][debug][config] [source/extensions/filters/network/http_connection_manager/config.cc:345]     config: {}\r\n[2019-11-11 13:42:10.311][15786616][debug][config] [source/server/listener_manager_impl.cc:376] add active listener: name=3013f5f6-96a0-4fad-ab2f-f90d02b77f10, hash=15202758330632086537, address=127.0.0.1:10000\r\n[2019-11-11 13:42:10.311][15786616][info][config] [source/server/configuration_impl.cc:96] loading tracing configuration\r\n[2019-11-11 13:42:10.311][15786616][info][config] [source/server/configuration_impl.cc:116] loading stats sink configuration\r\n[2019-11-11 13:42:10.311][15786616][debug][init] [source/common/init/manager_impl.cc:49] init manager Validation server initializing\r\n[2019-11-11 13:42:10.311][15786616][debug][init] [source/common/init/target_impl.cc:15] init manager Validation server initializing target RTDS foobar\r\n[2019-11-11 13:42:10.311][15786616][critical][backtrace] [bazel-out/darwin-dbg/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:81] Caught Segmentation fault: 11, suspect faulting address 0x0\r\n[2019-11-11 13:42:10.311][15786616][critical][backtrace] [bazel-out/darwin-dbg/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:69] Backtrace (use tools/stack_decode.py to get line numbers):\r\n[1]    59969 segmentation fault  ./envoy-static --mode validate -c segfault-test.yaml --service-node abc   -l\r\n```\r\n\r\n*Call Stack*:\r\n<img width=\"1560\" alt=\"Screen Shot 2019-11-11 at 3 07 48 PM\" src=\"https://user-images.githubusercontent.com/46503781/68628420-676c2400-0495-11ea-807f-382f54e3476b.png\">\r\n\r\nCredit to @LisaLudique for getting this stack trace for me;  relevant code is in /source/common/runtime/runtime_impl.cc.",
  "closed_at": "2019-11-12T16:23:12Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/10914751?v=4",
    "events_url": "https://api.github.com/users/htuch/events{/privacy}",
    "followers_url": "https://api.github.com/users/htuch/followers",
    "following_url": "https://api.github.com/users/htuch/following{/other_user}",
    "gists_url": "https://api.github.com/users/htuch/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/htuch",
    "id": 10914751,
    "login": "htuch",
    "node_id": "MDQ6VXNlcjEwOTE0NzUx",
    "organizations_url": "https://api.github.com/users/htuch/orgs",
    "received_events_url": "https://api.github.com/users/htuch/received_events",
    "repos_url": "https://api.github.com/users/htuch/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/htuch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/htuch/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/htuch"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8977/comments",
  "created_at": "2019-11-11T23:18:52Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8977/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/8977",
  "id": 521240677,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8977/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-01-21T19:28:37Z",
    "closed_issues": 72,
    "created_at": "2019-10-10T03:07:36Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/12",
    "id": 4738243,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/12/labels",
    "node_id": "MDk6TWlsZXN0b25lNDczODI0Mw==",
    "number": 12,
    "open_issues": 2,
    "state": "closed",
    "title": "1.13.0",
    "updated_at": "2020-10-21T19:03:40Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/12"
  },
  "node_id": "MDU6SXNzdWU1MjEyNDA2Nzc=",
  "number": 8977,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Segfault on config validation when rtds_layer in layered_runtime is specified",
  "updated_at": "2019-11-12T16:23:12Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/8977",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/46503781?v=4",
    "events_url": "https://api.github.com/users/achantavy/events{/privacy}",
    "followers_url": "https://api.github.com/users/achantavy/followers",
    "following_url": "https://api.github.com/users/achantavy/following{/other_user}",
    "gists_url": "https://api.github.com/users/achantavy/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/achantavy",
    "id": 46503781,
    "login": "achantavy",
    "node_id": "MDQ6VXNlcjQ2NTAzNzgx",
    "organizations_url": "https://api.github.com/users/achantavy/orgs",
    "received_events_url": "https://api.github.com/users/achantavy/received_events",
    "repos_url": "https://api.github.com/users/achantavy/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/achantavy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/achantavy/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/achantavy"
  }
}