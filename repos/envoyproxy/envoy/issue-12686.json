{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/209726?v=4",
    "events_url": "https://api.github.com/users/lambdai/events{/privacy}",
    "followers_url": "https://api.github.com/users/lambdai/followers",
    "following_url": "https://api.github.com/users/lambdai/following{/other_user}",
    "gists_url": "https://api.github.com/users/lambdai/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lambdai",
    "id": 209726,
    "login": "lambdai",
    "node_id": "MDQ6VXNlcjIwOTcyNg==",
    "organizations_url": "https://api.github.com/users/lambdai/orgs",
    "received_events_url": "https://api.github.com/users/lambdai/received_events",
    "repos_url": "https://api.github.com/users/lambdai/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lambdai/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lambdai/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lambdai"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/209726?v=4",
      "events_url": "https://api.github.com/users/lambdai/events{/privacy}",
      "followers_url": "https://api.github.com/users/lambdai/followers",
      "following_url": "https://api.github.com/users/lambdai/following{/other_user}",
      "gists_url": "https://api.github.com/users/lambdai/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/lambdai",
      "id": 209726,
      "login": "lambdai",
      "node_id": "MDQ6VXNlcjIwOTcyNg==",
      "organizations_url": "https://api.github.com/users/lambdai/orgs",
      "received_events_url": "https://api.github.com/users/lambdai/received_events",
      "repos_url": "https://api.github.com/users/lambdai/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/lambdai/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lambdai/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/lambdai"
    },
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    }
  ],
  "author_association": "NONE",
  "body": "Listener Crash on Start after enabling exact_balance\r\n\r\n_NOTE: emailed envoy-security@ and was asked to create an issue by @mattklein123 - I'm in the process of extracting more information, wanted to kick-off the discussion in the interim._\r\n\r\nEnvoy crashes on startup with exact_balance configuration enabled.\r\n\r\n       \"connection_balance_config\": {\r\n\r\n        \"exact_balance\": {}\r\n\r\n       }\r\n\r\n\r\nEnvoy version:\r\n\r\n       http_archive(\r\n        name = \"envoy\",\r\n        sha256 = \"38bd41e5229532abbeccba7b87d80c8664e915ec6f780a60a6b7ef1818458b5a\",\r\n        strip_prefix = \"envoy-1.15.0\",\r\n        urls = [\"https://github.com/envoyproxy/envoy/archive/v1.15.0.tar.gz\"],\r\n      )\r\n\r\nbacktrace:\r\n \r\n```\r\n(gdb) bt    \r\n#0  Envoy::Network::ExactConnectionBalancerImpl::pickTargetHandler (this=0x556dcafbe900) at external/envoy/source/common/network/connection_balancer_impl.cc:31\r\n#1  0x0000556dc59eb6a3 in Envoy::Server::ConnectionHandlerImpl::ActiveTcpListener::onAcceptWorker (this=0x556dca71d300, socket=..., hand_off_restored_destination_connections=<optimized out>, rebalanced=<optimized out>) at external/envoy/source/server/connection_handler_impl.cc:347\r\n#2  0x0000556dc5a0618d in Envoy::Network::ListenerImpl::listenCallback (fd=<optimized out>, remote_addr=<optimized out>, remote_addr_len=<optimized out>, arg=<optimized out>) at external/envoy/source/common/network/listener_impl.cc:78\r\n#3  0x0000556dc5e6216b in listener_read_cb (fd=55, what=<optimized out>, p=0x556dcc113ad0) at /root/.cache/bazel/b570b5ccd0454dc9af9f65ab1833764d/sandbox/processwrapper-sandbox/32/execroot/gateway/external/com_github_libevent_libevent/listener.c:437\r\n#4  0x0000556dc5e5ee80 in event_persist_closure (ev=<optimized out>, base=0x556dc8d6f340) at /root/.cache/bazel/b570b5ccd0454dc9af9f65ab1833764d/sandbox/processwrapper-sandbox/32/execroot/gateway/external/com_github_libevent_libevent/event.c:1639\r\n#5  event_process_active_single_queue (base=base@entry=0x556dc8d6f340, max_to_process=max_to_process@entry=2147483647, endtime=endtime@entry=0x0, activeq=<optimized out>) at /root/.cache/bazel/b570b5ccd0454dc9af9f65ab1833764d/sandbox/processwrapper-sandbox/32/execroot/gateway/external/com_github_libevent_libevent/event.c:1698\r\n#6  0x0000556dc5e5f4ff in event_process_active (base=0x556dc8d6f340) at /root/.cache/bazel/b570b5ccd0454dc9af9f65ab1833764d/sandbox/processwrapper-sandbox/32/execroot/gateway/external/com_github_libevent_libevent/event.c:1799\r\n#7  event_base_loop (base=0x556dc8d6f340, flags=0) at /root/.cache/bazel/b570b5ccd0454dc9af9f65ab1833764d/sandbox/processwrapper-sandbox/32/execroot/gateway/external/com_github_libevent_libevent/event.c:2041\r\n#8  0x0000556dc59e70cd in Envoy::Server::WorkerImpl::threadRoutine (this=0x556dc8db5310, guard_dog=...) at external/envoy/source/server/worker_impl.cc:133\r\n#9  0x0000556dc5f20475 in std::function<void ()>::operator()() const (this=<optimized out>) at /usr/include/c++/7/bits/std_function.h:706\r\n#10 Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::operator()(void*) const (arg=<optimized out>, __closure=0x0) at external/envoy/source/common/common/posix/thread_impl.cc:49\r\n#11 Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::_FUN(void*) () at external/envoy/source/common/common/posix/thread_impl.cc:51\r\n#12 0x00007f33559246db in start_thread (arg=0x7f333650f700) at pthread_create.c:463\r\n#13 0x00007f335564da3f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n```\r\n\r\ncode link: https://github.com/envoyproxy/envoy/blob/master/source/common/network/connection_balancer_impl.cc#L31\r\n\r\nmin_connection_handler is a nullptr as there aren't any BalanceConnectionHandler handlers registered when this balancing occurs.\r\n\r\n```\r\n// printout of handlers_ (empty list)\r\n  handlers_ = {\r\n    <std::_Vector_base<Envoy::Network::BalancedConnectionHandler*, std::allocator<Envoy::Network::BalancedConnectionHandler*> >> = {\r\n      _M_impl = {\r\n        <std::allocator<Envoy::Network::BalancedConnectionHandler*>> = {\r\n          <__gnu_cxx::new_allocator<Envoy::Network::BalancedConnectionHandler*>> = {<No data fields>}, <No data fields>}, \r\n        members of std::_Vector_base<Envoy::Network::BalancedConnectionHandler*, std::allocator<Envoy::Network::BalancedConnectionHandler*> >::_Vector_impl: \r\n        _M_start = 0x0, \r\n        _M_finish = 0x0, \r\n        _M_end_of_storage = 0x0\r\n      }\r\n    }, <No data fields>} \r\n```\r\n\r\nIn-order to see if we could mitigate the crash, we were returning the handler passed as the sole argument to ExactConnectionBalancerImpl::pickTargetHandler. It resolves the crash on startup, but, then we don't achieve exact balancing consistently. Below are stats dumped for the worker's on two of our staging clusters deployed in different zones.\r\n\r\nexample:\r\n# a case where it was working after the patch\r\nlistener.0.0.0.0_8080.worker_0.downstream_cx_active: 810\r\nlistener.0.0.0.0_8080.worker_0.downstream_cx_total: 1092\r\nlistener.0.0.0.0_8080.worker_1.downstream_cx_active: 811\r\nlistener.0.0.0.0_8080.worker_1.downstream_cx_total: 1072\r\nlistener.0.0.0.0_8080.worker_2.downstream_cx_active: 810\r\nlistener.0.0.0.0_8080.worker_2.downstream_cx_total: 1112\r\nlistener.0.0.0.0_8080.worker_3.downstream_cx_active: 811\r\nlistener.0.0.0.0_8080.worker_3.downstream_cx_total: 1086\r\nlistener.0.0.0.0_8080.worker_4.downstream_cx_active: 811\r\nlistener.0.0.0.0_8080.worker_4.downstream_cx_total: 1096\r\n\r\n# a case where it was not working (different cluster)\r\nlistener.0.0.0.0_8080.worker_0.downstream_cx_active: 1030\r\nlistener.0.0.0.0_8080.worker_0.downstream_cx_total: 2236\r\nlistener.0.0.0.0_8080.worker_1.downstream_cx_active: 452\r\nlistener.0.0.0.0_8080.worker_1.downstream_cx_total: 1381\r\nlistener.0.0.0.0_8080.worker_2.downstream_cx_active: 125\r\nlistener.0.0.0.0_8080.worker_2.downstream_cx_total: 875\r\nlistener.0.0.0.0_8080.worker_3.downstream_cx_active: 252\r\nlistener.0.0.0.0_8080.worker_3.downstream_cx_total: 1054\r\nlistener.0.0.0.0_8080.worker_4.downstream_cx_active: 1812\r\nlistener.0.0.0.0_8080.worker_4.downstream_cx_total: 3744",
  "closed_at": "2020-09-14T18:27:04Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 7,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12686/comments",
  "created_at": "2020-08-17T18:12:42Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12686/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/12686",
  "id": 680432680,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "",
      "id": 1759143334,
      "name": "area/listener",
      "node_id": "MDU6TGFiZWwxNzU5MTQzMzM0",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/listener"
    },
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "e2ce8a",
      "default": false,
      "description": "Disables stalebot from closing an issue",
      "id": 988830710,
      "name": "no stalebot",
      "node_id": "MDU6TGFiZWw5ODg4MzA3MTA=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/no%20stalebot"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12686/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2ODA0MzI2ODA=",
  "number": 12686,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Listener Crash on Start after enabling exact_balance",
  "updated_at": "2020-09-14T18:27:04Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/12686",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/603614?v=4",
    "events_url": "https://api.github.com/users/mbaglole/events{/privacy}",
    "followers_url": "https://api.github.com/users/mbaglole/followers",
    "following_url": "https://api.github.com/users/mbaglole/following{/other_user}",
    "gists_url": "https://api.github.com/users/mbaglole/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mbaglole",
    "id": 603614,
    "login": "mbaglole",
    "node_id": "MDQ6VXNlcjYwMzYxNA==",
    "organizations_url": "https://api.github.com/users/mbaglole/orgs",
    "received_events_url": "https://api.github.com/users/mbaglole/received_events",
    "repos_url": "https://api.github.com/users/mbaglole/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mbaglole/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mbaglole/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mbaglole"
  }
}