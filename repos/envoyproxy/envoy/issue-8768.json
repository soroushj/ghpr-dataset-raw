{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "We would like to use Envoy as a forward proxy that handles connection to 3rd party services via HTTP / HTTPs requests that could point to different domains, ports, for example:\r\n```\r\nwww.youtube.com:443/feed/trending\r\n```\r\nIn our initial integration we were able to achieve the behavior we want by creating route, routeAction and cluster for every URL\r\n```\r\n\"dynamic_active_clusters\": [\r\n        {\r\n          \"version_info\": \"2\",\r\n          \"cluster\": {\r\n            \"name\": \"fcaa46cf-a30b-4454-b0ed-170e97ed9c3c_cluster\",\r\n            \"type\": \"STRICT_DNS\",\r\n            \"connect_timeout\": \"5s\",\r\n            \"tls_context\": {\r\n              \"sni\": \"www.yotube.com\"\r\n            },\r\n            \"dns_refresh_rate\": \"3600s\",\r\n            \"dns_lookup_family\": \"V4_ONLY\",\r\n            \"load_assignment\": {\r\n              \"cluster_name\": \"fcaa46cf-a30b-4454-b0ed-170e97ed9c3c_cluster\",\r\n              \"endpoints\": [\r\n                {\r\n                  \"lb_endpoints\": [\r\n                    {\r\n                      \"endpoint\": {\r\n                        \"address\": {\r\n                          \"socket_address\": {\r\n                            \"address\": \"www.youtube.com\",\r\n                            \"port_value\": 443\r\n                          }\r\n                        }\r\n                      }\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          \"last_updated\": \"2019-10-25T17:01:42.507Z\"\r\n        }\r\n      ]\r\n    },\r\n\r\n\"dynamic_route_configs\": [\r\n        {\r\n          \"version_info\": \"2\",\r\n          \"route_config\": {\r\n            \"name\": \"primary_route_configuration\",\r\n            \"virtual_hosts\": [\r\n              {\r\n                \"name\": \"someVirtualHost\",\r\n                \"domains\": [\r\n                  \"*\"\r\n                ],\r\n                \"routes\": [\r\n                  {\r\n                    \"match\": {\r\n                      \"prefix\": \"/prefix/\",\r\n                      \"headers\": [\r\n                        {\r\n                          \"name\": \"x-some-host\",\r\n                          \"exact_match\": \"www.youtube.com\"\r\n                        },\r\n                        {\r\n                          \"name\": \"x-some-proto\",\r\n                          \"exact_match\": \"https\"\r\n                        },\r\n                        {\r\n                          \"name\": \"x-some-port\",\r\n                          \"exact_match\": \"443\"\r\n                        }\r\n                      ]\r\n                    },\r\n                    \"route\": {\r\n                      \"cluster\": \"fcaa46cf-a30b-4454-b0ed-170e97ed9c3c_cluster\",\r\n                      \"prefix_rewrite\": \"/\",\r\n                      \"host_rewrite\": \"www.youtube.com\"\r\n                    }\r\n                  },\r\n```\r\nWhile this approach works, there's a performance impact as Envoy has to find matching route, and if number of routes is significantly high (100K) Envoy have to go over loop of all routes if the valid route was added last in Envoy config.\r\n\r\nLater we got requirement to support REST URLs which contain arguments, like:\r\n```\r\nwww.google.com:443/maps/<location>/language/<language>\r\n```\r\nDynamic forward proxy could solve the problem, as it allows forwarding to any domain + we can have auto_host_rewrite_header option in a route so for a call <envoy-host>://<some-path> forward will be done to the host specified in a header.\r\n\r\n```\r\n\"dynamic_route_configs\": [\r\n        {\r\n          \"version_info\": \"2\",\r\n          \"route_config\": {\r\n            \"name\": \"primary_route_configuration\",\r\n            \"virtual_hosts\": [\r\n              {\r\n                \"name\": \"someVirtualHost\",\r\n                \"domains\": [\r\n                  \"*\"\r\n                ],\r\n                \"routes\": [\r\n                  {\r\n                    \"match\": {\r\n                      \"prefix\": \"/\"\r\n                    },\r\n                    \"route\": {\r\n                      \"cluster\": \"dynamic_forward_proxy_cluster\",\r\n                      \"auto_host_rewrite_header\": \"x-some-host\"\r\n                    }\r\n                  }\r\n                ]\r\n              }\r\n            ],\r\n```\r\nThis approach is much better as we don't have define cluster and routes for all URL's like we did initially. It would be sufficient to have one  But with this approach, we don't see an option to provide PORT rewrite, which means we will still have to create lots of dynamic forward clusters, one cluster per (domain + port) combination. Ideally we wanted it to be an extra option on route, like \"auto_port_rewrite_header\".\r\nPlease reply and let us know if there's a way to achieve the same behavior differently (dynamic forward proxy with port and host rewrite).\r\n\r\n\r\n",
  "closed_at": "2019-11-09T17:20:08Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 13,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8768/comments",
  "created_at": "2019-10-25T17:10:04Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8768/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/8768",
  "id": 512624770,
  "labels": [
    {
      "color": "cc317c",
      "default": true,
      "description": "Questions that are neither investigations, bugs, nor enhancements",
      "id": 421403912,
      "name": "question",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MTI=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/question"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8768/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MTI2MjQ3NzA=",
  "number": 8768,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Envoy as a dynamic forward proxy with Host and Port rewrite",
  "updated_at": "2019-11-19T00:13:47Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/8768",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/32372937?v=4",
    "events_url": "https://api.github.com/users/mabukhovsky/events{/privacy}",
    "followers_url": "https://api.github.com/users/mabukhovsky/followers",
    "following_url": "https://api.github.com/users/mabukhovsky/following{/other_user}",
    "gists_url": "https://api.github.com/users/mabukhovsky/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mabukhovsky",
    "id": 32372937,
    "login": "mabukhovsky",
    "node_id": "MDQ6VXNlcjMyMzcyOTM3",
    "organizations_url": "https://api.github.com/users/mabukhovsky/orgs",
    "received_events_url": "https://api.github.com/users/mabukhovsky/received_events",
    "repos_url": "https://api.github.com/users/mabukhovsky/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mabukhovsky/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mabukhovsky/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mabukhovsky"
  }
}