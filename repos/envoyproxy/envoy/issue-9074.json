{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**Description**:\r\nCurrently consistent hashing is done using the weighted host's resolved address for both [ring hash](https://github.com/envoyproxy/envoy/blob/master/source/common/upstream/ring_hash_lb.cc#L130) and [maglev](https://github.com/envoyproxy/envoy/blob/master/source/common/upstream/maglev_lb.cc#L27) implementations. This does not work as intended in containerized workloads like docker, kubernetes etc. because when containers come back up they will most likely have a different resolved address and so will no longer maintain the consistent hash.\r\n\r\nWe, at Shopify, are using envoy to route to large clusters of redis and we need the hashing to be consistent when redis pods are failed over for whatever reason. But with the current implementation the ring is always resized and rehashed leaving behind inconsistent data.\r\n\r\n**Recommended Solution**\r\nSwitch to using `logicalName` of the [address](https://github.com/envoyproxy/envoy/blob/master/include/envoy/network/address.h#L133) instead. But we will need to keep in mind this [comment](https://github.com/envoyproxy/envoy/blob/master/source/common/upstream/ring_hash_lb.cc#L133-L139) which talks about the size of the `hash_key_buffer`.\r\n\r\nIf this was an intentional use of the resolved address then perhaps we need to introduce an option like `useLogicalName(bool)` in the ring hash LB [config](https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/cds.proto#envoy-api-msg-cluster-ringhashlbconfig) and add a similar config for maglev as well.\r\n\r\nOnce we agree on a solution, I can work on implementing it. Thanks. cc @mattklein123 ",
  "closed_at": "2020-03-24T15:53:37Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9074/comments",
  "created_at": "2019-11-19T18:20:15Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9074/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/9074",
  "id": 525180643,
  "labels": [
    {
      "color": "e99695",
      "default": false,
      "description": "",
      "id": 1722375944,
      "name": "area/load balancing",
      "node_id": "MDU6TGFiZWwxNzIyMzc1OTQ0",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/load%20balancing"
    },
    {
      "color": "c5def5",
      "default": false,
      "description": "Needs design doc/proposal before implementation",
      "id": 620444894,
      "name": "design proposal",
      "node_id": "MDU6TGFiZWw2MjA0NDQ4OTQ=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/design%20proposal"
    },
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9074/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MjUxODA2NDM=",
  "number": 9074,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Support logicalName of host address for consistent hash load balancing",
  "updated_at": "2020-03-24T15:53:37Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/9074",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/2790866?v=4",
    "events_url": "https://api.github.com/users/inf-rno/events{/privacy}",
    "followers_url": "https://api.github.com/users/inf-rno/followers",
    "following_url": "https://api.github.com/users/inf-rno/following{/other_user}",
    "gists_url": "https://api.github.com/users/inf-rno/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/inf-rno",
    "id": 2790866,
    "login": "inf-rno",
    "node_id": "MDQ6VXNlcjI3OTA4NjY=",
    "organizations_url": "https://api.github.com/users/inf-rno/orgs",
    "received_events_url": "https://api.github.com/users/inf-rno/received_events",
    "repos_url": "https://api.github.com/users/inf-rno/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/inf-rno/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/inf-rno/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/inf-rno"
  }
}