{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Bug Template**\r\n\r\n*Title*: *headers_to_add not doing interpolation*\r\n\r\n*Description*:\r\nI'm trying to use ext_authz with oauth2-proxy under istio. \r\n\r\n[these docs](https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/http/ext_authz/v2/ext_authz.proto#envoy-api-msg-config-filter-http-ext-authz-v2-authorizationrequest) point to [this doc](https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/core/base.proto#envoy-api-msg-core-headervalue) which states `The same format specifier as used for HTTP access logging applies here, however unknown header values are replaced with the empty string instead of -.`\r\n\r\nHowever, what gets sent is:\r\n```\r\n[Envoy (Epoch 0)] [2020-02-09 02:19:18.510][39][trace][filter] [external/envoy/source/extensions/filters/http/ext_authz/ext_authz.cc:80] [C1704][S12786298896255907122] ext_authz filter calling authorization server\r\n[Envoy (Epoch 0)] [2020-02-09 02:19:18.510][39][debug][router] [external/envoy/source/common/router/router.cc:434] [C0][S17990863836512223039] cluster 'outbound|80||oauth2-proxy-oauth2-proxy.oauth2-proxy.svc.cluster.local' match for URL '/qfqf'\r\n[Envoy (Epoch 0)] [2020-02-09 02:19:18.510][39][debug][router] [external/envoy/source/common/router/router.cc:549] [C0][S17990863836512223039] router decoding headers:\r\n':authority', 'kubernetes-dashboard.home.mikebryant.me.uk'\r\n':method', 'GET'\r\n':path', '/qfqf'\r\n':scheme', 'https'\r\n'content-length', '0'\r\n'x-auth-request-redirect', '%REQ(:SCHEME)://%REQ(:AUTHORITY)%/%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%'\r\n'x-envoy-internal', 'true'\r\n'x-forwarded-for', '10.244.128.46'\r\n'x-envoy-expected-rq-timeout-ms', '5000'\r\n```\r\n\r\nNote the header sent to the authorization service hasn't been interpolated / formatted\r\n\r\n\r\n*Repro steps*:\r\nUse this config - the important part is to try and use format strings in the headers\r\n```\r\n        name: \"envoy.ext_authz\"\r\n        config:\r\n          failure_mode_allow: false\r\n          http_service:\r\n            authorization_request:\r\n              allowed_headers:\r\n                patterns:\r\n                - exact: Authorization\r\n                - exact: Cookie\r\n              headers_to_add:\r\n              - key: X-Auth-Request-Redirect\r\n                value: \"%REQ(:SCHEME)://%REQ(:AUTHORITY)%/%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%\"\r\n            server_uri:\r\n              cluster: outbound|80||oauth2-proxy-oauth2-proxy.oauth2-proxy.svc.cluster.local\r\n              uri: http://oauth2-proxy-oauth2-proxy.oauth2-proxy.svc.cluster.local\r\n              timeout: 5.000s\r\n```\r\n\r\n>**Note**: The [Envoy_collect tool](https://github.com/envoyproxy/envoy/blob/master/tools/envoy_collect/README.md)\r\ngathers a tarball with debug logs, config and the following admin\r\nendpoints: /stats, /clusters and /server_info. Please note if there are\r\nprivacy concerns, sanitize the data prior to sharing the tarball/pasting.\r\n\r\n*Admin and Stats Output*:\r\n>Include the admin output for the following endpoints: /stats,\r\n/clusters, /routes, /server_info. For more information, refer to the\r\n[admin endpoint documentation.](https://www.envoyproxy.io/docs/envoy/latest/operations/admin)\r\n\r\n>**Note**: If there are privacy concerns, sanitize the data prior to\r\nsharing.\r\n\r\n*Config*:\r\n>Include the config used to configure Envoy.\r\n\r\n*Logs*:\r\n>Include the access logs and the Envoy logs.\r\n\r\n>**Note**: If there are privacy concerns, sanitize the data prior to\r\nsharing.\r\n",
  "closed_at": "2020-03-25T17:49:08Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9980/comments",
  "created_at": "2020-02-09T02:48:10Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9980/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/9980",
  "id": 562112056,
  "labels": [
    {
      "color": "006b75",
      "default": false,
      "description": "",
      "id": 1807008039,
      "name": "area/ext_authz",
      "node_id": "MDU6TGFiZWwxODA3MDA4MDM5",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/ext_authz"
    },
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9980/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1NjIxMTIwNTY=",
  "number": 9980,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "config.filter.http.ext_authz.v2.AuthorizationRequest headers_to_add not doing interpolation",
  "updated_at": "2020-03-25T17:49:08Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/9980",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1478103?v=4",
    "events_url": "https://api.github.com/users/mikebryant/events{/privacy}",
    "followers_url": "https://api.github.com/users/mikebryant/followers",
    "following_url": "https://api.github.com/users/mikebryant/following{/other_user}",
    "gists_url": "https://api.github.com/users/mikebryant/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mikebryant",
    "id": 1478103,
    "login": "mikebryant",
    "node_id": "MDQ6VXNlcjE0NzgxMDM=",
    "organizations_url": "https://api.github.com/users/mikebryant/orgs",
    "received_events_url": "https://api.github.com/users/mikebryant/received_events",
    "repos_url": "https://api.github.com/users/mikebryant/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mikebryant/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mikebryant/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mikebryant"
  }
}