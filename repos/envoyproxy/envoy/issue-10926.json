{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "When a prometheus job is configured to scrape envoy using `filter` query arg, it sends the requests with the params url percent encoded:\r\n\r\n```\r\nGET /stats/prometheus?filter=upstream%7Cdownstream HTTP/1.1\r\nHost: X.Y.Z.Q:8524\r\nUser-Agent: Prometheus/2.15.2\r\nAccept: application/openmetrics-text; version=0.0.1,text/plain;version=0.0.4;q=0.5,*/*;q=0.1\r\nAccept-Encoding: gzip\r\n```\r\n\r\n`upstream%7Cdownstream` doesn't get urldecoded properly and no metrics are returned.\r\n\r\n`upstream|downstream` works fine, but prometheus can't be configured to not url percent encode the params from its scrape requests.\r\n\r\nI'm willing to work on this if it's considered a bug and not expected behaviour. Assuming there already are some bits that do urldecoding in envoy, i think it's approachable even for someone that doesn't know c++ well (me).\r\n\r\n\r\nLater edit:\r\n\r\nuse case: On large enough envoy deployments, we can't fit all the metrics we get from all envoys on just one prom box without eventually trashing it. So we're forced to rely on stats filtering so that each prom sees just a subset of the metrics. The lack of url decoding for `|`-based regex filters forces us to do quite a few unnecessary scrape jobs and various workarounds.",
  "closed_at": "2020-07-10T23:48:10Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/73152?v=4",
    "events_url": "https://api.github.com/users/dio/events{/privacy}",
    "followers_url": "https://api.github.com/users/dio/followers",
    "following_url": "https://api.github.com/users/dio/following{/other_user}",
    "gists_url": "https://api.github.com/users/dio/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/dio",
    "id": 73152,
    "login": "dio",
    "node_id": "MDQ6VXNlcjczMTUy",
    "organizations_url": "https://api.github.com/users/dio/orgs",
    "received_events_url": "https://api.github.com/users/dio/received_events",
    "repos_url": "https://api.github.com/users/dio/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/dio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dio/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/dio"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/10926/comments",
  "created_at": "2020-04-24T07:54:51Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/10926/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/10926",
  "id": 606117343,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/10926/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MDYxMTczNDM=",
  "number": 10926,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Envoy /stats/prometheus?filter not working with prometheus due to url percent encoding.",
  "updated_at": "2020-07-10T23:48:10Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/10926",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1033279?v=4",
    "events_url": "https://api.github.com/users/lxnch/events{/privacy}",
    "followers_url": "https://api.github.com/users/lxnch/followers",
    "following_url": "https://api.github.com/users/lxnch/following{/other_user}",
    "gists_url": "https://api.github.com/users/lxnch/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lxnch",
    "id": 1033279,
    "login": "lxnch",
    "node_id": "MDQ6VXNlcjEwMzMyNzk=",
    "organizations_url": "https://api.github.com/users/lxnch/orgs",
    "received_events_url": "https://api.github.com/users/lxnch/received_events",
    "repos_url": "https://api.github.com/users/lxnch/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lxnch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lxnch/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lxnch"
  }
}