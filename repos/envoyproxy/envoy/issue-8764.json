{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "*Title*: Segmentation fault on host priority updates for EDS clusters\r\n\r\n*Description*:\r\nThis issue is similar to https://github.com/envoyproxy/envoy/issues/6395, though the stack trace is different.\r\n\r\nIn this setup hosts are mapped to different localities whose priorities are dynamically updated by XDS control plane to optionally enable zonal affinity. When enabled, same locality endpoints get higher priority than other locality endpoints, or else all have the same priority.\r\nWhen frequently updating locality priorities (e.g. enable/disable zonal affinity), I occasionally see Envoy crashing with the stack trace below. Setting the cluster load-assignment in CDS (with STATIC DiscoveryType), instead of using EDS does not show any issues.\r\n\r\n```\r\n[2019-10-25 01:25:35.319][69][critical][assert] [external/envoy/source/common/upstream/eds.cc:148] assert failure: std::all_of(current_hosts_copy->begin(), current_hosts_copy->end(), [&](const auto& host) { return host->priority() == priority; }).\r\n```\r\n\r\n*Relevant Links*:\r\nIssue: https://github.com/envoyproxy/envoy/issues/6395\r\n\r\n*Envoy Version*: v1.10.0\r\n\r\n*Call Stack*:\r\n```\r\n[2019-10-25 01:24:58.358][69][warning][config] [bazel-out/k8-dbg/bin/external/envoy/source/common/config/_virtual_includes/grpc_stream_lib/common/config/grpc_stream.h:101] gRPC config stream closed: 13, \r\n[2019-10-25 01:25:35.319][69][critical][assert] [external/envoy/source/common/upstream/eds.cc:148] assert failure: std::all_of(current_hosts_copy->begin(), current_hosts_copy->end(), [&](const auto& host) { return host->priority() == priority; }).\r\n[2019-10-25 01:25:35.319][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:81] Caught Aborted, suspect faulting address 0x45\r\n[2019-10-25 01:25:35.319][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:69] Backtrace (use tools/stack_decode.py to get line numbers):\r\n[2019-10-25 01:25:35.335][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #0: Envoy::SignalAction::sigHandler() [0x5571674f410a]\r\n[2019-10-25 01:25:35.335][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #1: __restore_rt [0x7f6ad4e8d890]\r\n[2019-10-25 01:25:35.350][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #2: Envoy::Upstream::EdsClusterImpl::BatchUpdateHelper::batchUpdate() [0x557166ea8d8e]\r\n[2019-10-25 01:25:35.365][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #3: Envoy::Upstream::PrioritySetImpl::batchHostUpdate() [0x557166e70b0a]\r\n[2019-10-25 01:25:35.380][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #4: Envoy::Upstream::EdsClusterImpl::onConfigUpdate() [0x557166ea9318]\r\n[2019-10-25 01:25:35.395][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #5: Envoy::Config::GrpcMuxSubscriptionImpl::onConfigUpdate() [0x557166bd2f28]\r\n[2019-10-25 01:25:35.410][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #6: Envoy::Config::GrpcMuxImpl::handleResponse() [0x557166eb0805]\r\n[2019-10-25 01:25:35.425][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #7: Envoy::Config::GrpcStream<>::onReceiveMessage() [0x557166eb6905]\r\n[2019-10-25 01:25:35.440][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #8: Envoy::Grpc::TypedAsyncStreamCallbacks<>::onReceiveMessageUntyped() [0x557166eb6798]\r\n[2019-10-25 01:25:35.455][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #9: Envoy::Grpc::AsyncStreamImpl::onData() [0x557166f07c74]\r\n[2019-10-25 01:25:35.471][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #10: Envoy::Http::AsyncStreamImpl::encodeData() [0x557166f0d0e7]\r\n[2019-10-25 01:25:35.486][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #11: Envoy::Router::Filter::onUpstreamData() [0x557166f1ba72]\r\n[2019-10-25 01:25:35.501][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #12: Envoy::Router::Filter::UpstreamRequest::decodeData() [0x557166f1db3c]\r\n[2019-10-25 01:25:35.516][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #13: Envoy::Http::StreamDecoderWrapper::decodeData() [0x557166e59901]\r\n[2019-10-25 01:25:35.531][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #14: Envoy::Http::Http2::ConnectionImpl::onFrameReceived() [0x557166fb9312]\r\n[2019-10-25 01:25:35.546][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #15: Envoy::Http::Http2::ConnectionImpl::Http2Callbacks::Http2Callbacks()::{lambda()#6}::operator()() [0x557166fbb3f9]\r\n[2019-10-25 01:25:35.561][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #16: Envoy::Http::Http2::ConnectionImpl::Http2Callbacks::Http2Callbacks()::{lambda()#6}::_FUN() [0x557166fbb428]\r\n[2019-10-25 01:25:35.576][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #17: nghttp2_session_on_data_received [0x557166fcd530]\r\n[2019-10-25 01:25:35.591][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #18: nghttp2_session_mem_recv [0x557166fd1aab]\r\n[2019-10-25 01:25:35.606][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #19: Envoy::Http::Http2::ConnectionImpl::dispatch() [0x557166fb84db]\r\n[2019-10-25 01:25:35.620][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #20: Envoy::Http::CodecClient::onData() [0x557166ef26f4]\r\n[2019-10-25 01:25:35.635][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #21: Envoy::Http::CodecClient::CodecReadFilter::onData() [0x557166ef319e]\r\n[2019-10-25 01:25:35.650][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #22: Envoy::Network::FilterManagerImpl::onContinueReading() [0x557166c37e7b]\r\n[2019-10-25 01:25:35.665][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #23: Envoy::Network::FilterManagerImpl::onRead() [0x557166c37f92]\r\n[2019-10-25 01:25:35.680][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #24: Envoy::Network::ConnectionImpl::onRead() [0x557166c2eb42]\r\n[2019-10-25 01:25:35.695][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #25: Envoy::Network::ConnectionImpl::onReadReady() [0x557166c30309]\r\n[2019-10-25 01:25:35.710][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #26: Envoy::Network::ConnectionImpl::onFileEvent() [0x557166c300a7]\r\n[2019-10-25 01:25:35.726][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #27: Envoy::Network::ConnectionImpl::ConnectionImpl()::{lambda()#3}::operator()() [0x557166c2c88d]\r\n[2019-10-25 01:25:35.741][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #28: std::_Function_handler<>::_M_invoke() [0x557166c321f1]\r\n[2019-10-25 01:25:35.756][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #29: std::function<>::operator()() [0x557166c263aa]\r\n[2019-10-25 01:25:35.772][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #30: Envoy::Event::FileEventImpl::assignEvents()::{lambda()#1}::operator()() [0x557166c26006]\r\n[2019-10-25 01:25:35.787][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #31: Envoy::Event::FileEventImpl::assignEvents()::{lambda()#1}::_FUN() [0x557166c26084]\r\n[2019-10-25 01:25:35.802][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #32: event_process_active_single_queue.isra.31 [0x5571672462e3]\r\n[2019-10-25 01:25:35.817][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #33: event_process_active [0x55716724683f]\r\n[2019-10-25 01:25:35.832][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #34: event_base_loop [0x55716724aef0]\r\n[2019-10-25 01:25:35.847][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #35: Envoy::Event::LibeventScheduler::run() [0x557166c45358]\r\n[2019-10-25 01:25:35.862][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #36: Envoy::Event::DispatcherImpl::run() [0x557166c21420]\r\n[2019-10-25 01:25:35.877][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #37: Envoy::Server::InstanceImpl::run() [0x557166b6e58b]\r\n[2019-10-25 01:25:35.892][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #38: Envoy::MainCommonBase::run() [0x5571664ffa5c]\r\n[2019-10-25 01:25:35.906][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #39: Envoy::MainCommon::run() [0x5571664fdd04]\r\n[2019-10-25 01:25:35.921][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #40: main [0x5571664fd7bb]\r\n[2019-10-25 01:25:35.921][69][critical][backtrace] [bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #41: [0x7f6ad470db97]\r\n```",
  "closed_at": "2020-01-03T15:02:39Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/2023366?v=4",
    "events_url": "https://api.github.com/users/snowp/events{/privacy}",
    "followers_url": "https://api.github.com/users/snowp/followers",
    "following_url": "https://api.github.com/users/snowp/following{/other_user}",
    "gists_url": "https://api.github.com/users/snowp/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/snowp",
    "id": 2023366,
    "login": "snowp",
    "node_id": "MDQ6VXNlcjIwMjMzNjY=",
    "organizations_url": "https://api.github.com/users/snowp/orgs",
    "received_events_url": "https://api.github.com/users/snowp/received_events",
    "repos_url": "https://api.github.com/users/snowp/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/snowp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/snowp/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/snowp"
  },
  "comments": 14,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8764/comments",
  "created_at": "2019-10-25T02:27:09Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8764/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/8764",
  "id": 512268481,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8764/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-04-08T18:48:51Z",
    "closed_issues": 45,
    "created_at": "2019-12-05T23:44:41Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/13",
    "id": 4907478,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/13/labels",
    "node_id": "MDk6TWlsZXN0b25lNDkwNzQ3OA==",
    "number": 13,
    "open_issues": 0,
    "state": "closed",
    "title": "1.14.0",
    "updated_at": "2020-04-08T18:48:51Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/13"
  },
  "node_id": "MDU6SXNzdWU1MTIyNjg0ODE=",
  "number": 8764,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Segmentation fault on host priority updates for EDS clusters",
  "updated_at": "2020-01-03T15:02:39Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/8764",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/19612412?v=4",
    "events_url": "https://api.github.com/users/ahmedelbazsc/events{/privacy}",
    "followers_url": "https://api.github.com/users/ahmedelbazsc/followers",
    "following_url": "https://api.github.com/users/ahmedelbazsc/following{/other_user}",
    "gists_url": "https://api.github.com/users/ahmedelbazsc/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ahmedelbazsc",
    "id": 19612412,
    "login": "ahmedelbazsc",
    "node_id": "MDQ6VXNlcjE5NjEyNDEy",
    "organizations_url": "https://api.github.com/users/ahmedelbazsc/orgs",
    "received_events_url": "https://api.github.com/users/ahmedelbazsc/received_events",
    "repos_url": "https://api.github.com/users/ahmedelbazsc/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ahmedelbazsc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ahmedelbazsc/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ahmedelbazsc"
  }
}