{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "*Title*: *health_check: request header formatting does not use dynamic request info*\r\n\r\n*Description*:\r\nUsing the [command operators](https://www.envoyproxy.io/docs/envoy/latest/configuration/http_conn_man/headers#custom-request-response-headers) in [http_health_check.request_headers_to_add](https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/core/health_check.proto#core-healthcheck-httphealthcheck) will not work as intended. Specifically, for `%UPSTREAM_METADATA()%`, the lookup will fail and be replaced with an empty string.\r\n\r\nFor `%DOWNSTREAM_LOCAL_ADDRESS%` it segfaults... but this one (and the other DOWNSTREAM ones) doesn't actually make sense because there is no downstream for healthchecks (or the downstream is envoy itself?)\r\n\r\nThe problem boils down to the fact that the `RequestInfo` object is never populated with the current request info. https://github.com/envoyproxy/envoy/blob/master/source/common/upstream/health_checker_impl.cc#L159\r\n\r\n(I haven't confirmed this, but based on the reading of the code `%START_TIME%` will also be wrong. It will always be the time that the REQUEST_INFO object was constructed)\r\n\r\n*Repro steps*:\r\nThe simplest repro is to add the header to the health checker tests:\r\n\r\n```diff\r\ndiff --git a/test/common/upstream/health_checker_impl_test.cc b/test/common/upstream/health_checker_impl_test.cc\r\nindex dc041e7..a8befdc 100644\r\n--- a/test/common/upstream/health_checker_impl_test.cc\r\n+++ b/test/common/upstream/health_checker_impl_test.cc\r\n@@ -290,6 +290,9 @@ public:\r\n             key: user-agent\r\n             value: CoolEnvoy/HC\r\n           append: false\r\n+        - header:\r\n+            key: downstream-local-address\r\n+            value: \"%DOWNSTREAM_LOCAL_ADDRESS%\"\r\n     )EOF\";\r\n\r\n     health_checker_.reset(new TestHttpHealthCheckerImpl(*cluster_, parseHealthCheckFromV2Yaml(yaml),\r\n```\r\n\r\nA more realistic repro is to use `UPSTREAM_METADATA` with EDS endpoints that actually have metadata.",
  "closed_at": "2018-07-26T21:30:09Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/3835/comments",
  "created_at": "2018-07-10T21:05:19Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/3835/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/3835",
  "id": 340006799,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/3835/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzNDAwMDY3OTk=",
  "number": 3835,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "health_check: request header formatting does not use dynamic request info",
  "updated_at": "2018-07-26T21:30:09Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/3835",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/5392381?v=4",
    "events_url": "https://api.github.com/users/bplotnick/events{/privacy}",
    "followers_url": "https://api.github.com/users/bplotnick/followers",
    "following_url": "https://api.github.com/users/bplotnick/following{/other_user}",
    "gists_url": "https://api.github.com/users/bplotnick/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/bplotnick",
    "id": 5392381,
    "login": "bplotnick",
    "node_id": "MDQ6VXNlcjUzOTIzODE=",
    "organizations_url": "https://api.github.com/users/bplotnick/orgs",
    "received_events_url": "https://api.github.com/users/bplotnick/received_events",
    "repos_url": "https://api.github.com/users/bplotnick/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/bplotnick/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bplotnick/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/bplotnick"
  }
}