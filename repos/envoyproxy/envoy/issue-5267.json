{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "*RBAC: envoy.filters.http.rbac source_ip principal does not seem to work together with external loadbalancers in front proxy configuration*\r\n\r\n*Summary: The envoy.filters.http.rbac source_ip principal seems to be using the \"raw\" source ip, making it unusable in a edge/front proxy configuration when there are additional loadbalancers in front of it. Are we missing something?*\r\n\r\n*Description*:\r\nWe are testing envoy as edge/front proxy, and we have a cloud loadbalancer in front of it. The cloud loadbalancer is actually adding two hops in front of the envoy, and we are therefore setting \"xff_num_trusted_hops: 2\" which makes the \"x-envoy-external-address\" be set to the correct address. \r\n\r\nThen we add configuration to whitelist/blacklist network ranges for virtualhosts, using a per filter config for envoy.filters.http.rbac, and in it setting a rule to allow only certain network ranges using the source_ip principal.\r\n\r\nWhen running the envoy in trace mode, it seems to confirm that the source ip that is actually used to match with the allowed networks, is the \"raw\" source ip, meaning it is the previous hop in the cloud loadbalancer set-up, making the filter fail, or always be successful if we add the loadbalancer ips to the list of allowed source_ips.\r\n\r\nEg: \"[2018-12-10 16:38:27.988][000029][debug][rbac] [source/extensions/filters/http/rbac/rbac_filter.cc:62] checking request: remoteAddress: LOAD_BALANCER_IP:SOME_PORT, localAddress: 10.99.0.2:8443\"\r\n\r\nRunning latest from 2018-12-10, 1.9.0 (pending): envoyproxy/envoy@sha256:67114c50c0013842929da2e3281f946629d045a110da698fdee6f887d4926a1c\r\n\r\nAre we missing some configuration to make the rbac filter affect the \"real\" client source ip (ie the same ip as \"x-envoy-external-address\" is set to)? If not, I guess this question has more turned into a feature request, if that makes sense? As otherwise this rbac filter is not usable in such a set-up. Also, is there any work-around for now?\r\n\r\nBest regards,\r\nRichard Spangberg\r\n",
  "closed_at": "2020-04-08T02:26:07Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 11,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5267/comments",
  "created_at": "2018-12-11T15:55:49Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5267/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/5267",
  "id": 389831458,
  "labels": [
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5267/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzODk4MzE0NTg=",
  "number": 5267,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "RBAC: envoy.filters.http.rbac source_ip principal does not seem to work together with external loadbalancers in front proxy configuration",
  "updated_at": "2020-04-08T02:26:07Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/5267",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/6805077?v=4",
    "events_url": "https://api.github.com/users/rispa/events{/privacy}",
    "followers_url": "https://api.github.com/users/rispa/followers",
    "following_url": "https://api.github.com/users/rispa/following{/other_user}",
    "gists_url": "https://api.github.com/users/rispa/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rispa",
    "id": 6805077,
    "login": "rispa",
    "node_id": "MDQ6VXNlcjY4MDUwNzc=",
    "organizations_url": "https://api.github.com/users/rispa/orgs",
    "received_events_url": "https://api.github.com/users/rispa/received_events",
    "repos_url": "https://api.github.com/users/rispa/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rispa/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rispa/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rispa"
  }
}