{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/2023366?v=4",
    "events_url": "https://api.github.com/users/snowp/events{/privacy}",
    "followers_url": "https://api.github.com/users/snowp/followers",
    "following_url": "https://api.github.com/users/snowp/following{/other_user}",
    "gists_url": "https://api.github.com/users/snowp/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/snowp",
    "id": 2023366,
    "login": "snowp",
    "node_id": "MDQ6VXNlcjIwMjMzNjY=",
    "organizations_url": "https://api.github.com/users/snowp/orgs",
    "received_events_url": "https://api.github.com/users/snowp/received_events",
    "repos_url": "https://api.github.com/users/snowp/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/snowp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/snowp/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/snowp"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/2023366?v=4",
      "events_url": "https://api.github.com/users/snowp/events{/privacy}",
      "followers_url": "https://api.github.com/users/snowp/followers",
      "following_url": "https://api.github.com/users/snowp/following{/other_user}",
      "gists_url": "https://api.github.com/users/snowp/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/snowp",
      "id": 2023366,
      "login": "snowp",
      "node_id": "MDQ6VXNlcjIwMjMzNjY=",
      "organizations_url": "https://api.github.com/users/snowp/orgs",
      "received_events_url": "https://api.github.com/users/snowp/received_events",
      "repos_url": "https://api.github.com/users/snowp/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/snowp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/snowp/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/snowp"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "*Description*:\r\nWe saw a segfault inside of Envoy::Http::CodecClient::close(). It seems like a timed out active health check can cause a connection close after it's already been closed.\r\n\r\nThe Envoy version is a fork, but we think it's unlikely our changes are related based on the backtrace. \r\nEnvoy version: https://github.com/snowp/envoy/tree/xdc-hack. It diverged from master at 3e15c94901f7ce5ebca671e451efceec8053da86\r\n\r\nRaw log output:\r\n```\r\n2018-09-05_19:19:39.04147 [2018-09-05 19:19:39.041][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:125] Caught Segmentation fault, suspect faulting address 0x28\r\n2018-09-05_19:19:39.11074 [2018-09-05 19:19:39.110][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:94] Backtrace thr<0> obj<./envoy> (If unsymbolized, use tools/stack_decode.py):\r\n2018-09-05_19:19:39.14064 [2018-09-05 19:19:39.140][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #0 0x73f72e std::unique_ptr<>::get()\r\n2018-09-05_19:19:39.15795 [2018-09-05 19:19:39.157][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #1 0x73e7f1 std::unique_ptr<>::operator->()\r\n2018-09-05_19:19:39.17624 [2018-09-05 19:19:39.176][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #2 0xc52063 Envoy::Http::CodecClient::close()\r\n2018-09-05_19:19:39.19251 [2018-09-05 19:19:39.192][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #3 0xc38fae Envoy::Upstream::HttpHealthCheckerImpl::HttpActiveHealthCheckSession::onTimeout()\r\n2018-09-05_19:19:39.20858 [2018-09-05 19:19:39.208][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #4 0xc4cad6 Envoy::Upstream::HealthCheckerImplBase::ActiveHealthCheckSession::onTimeoutBase()\r\n2018-09-05_19:19:39.22819 [2018-09-05 19:19:39.228][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #5 0xc4c1e6 Envoy::Upstream::HealthCheckerImplBase::ActiveHealthCheckSession::ActiveHealthCheckSession()::{lambda()#2}::operator()()\r\n2018-09-05_19:19:39.24641 [2018-09-05 19:19:39.246][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #6 0xc4d67b std::_Function_handler<>::_M_invoke()\r\n2018-09-05_19:19:39.26545 [2018-09-05 19:19:39.265][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #7 0x4f80ef std::function<>::operator()()\r\n2018-09-05_19:19:39.28170 [2018-09-05 19:19:39.281][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #8 0x9a15fe Envoy::Event::TimerImpl::TimerImpl()::{lambda()#1}::operator()()\r\n2018-09-05_19:19:39.29760 [2018-09-05 19:19:39.297][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #9 0x9a162d Envoy::Event::TimerImpl::TimerImpl()::{lambda()#1}::_FUN()\r\n2018-09-05_19:19:39.31372 [2018-09-05 19:19:39.313][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #10 0xfb78f7 event_process_active_single_queue.isra.29\r\n2018-09-05_19:19:39.33038 [2018-09-05 19:19:39.330][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #11 0xfb7e5e event_base_loop\r\n2018-09-05_19:19:39.35262 [2018-09-05 19:19:39.352][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #12 0x999351 Envoy::Event::DispatcherImpl::run()\r\n2018-09-05_19:19:39.36875 [2018-09-05 19:19:39.368][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #13 0x911bd0 Envoy::Server::InstanceImpl::run()\r\n2018-09-05_19:19:39.38646 [2018-09-05 19:19:39.386][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #14 0x439d77 Envoy::MainCommonBase::run()\r\n2018-09-05_19:19:39.40384 [2018-09-05 19:19:39.403][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #15 0x4206dd Envoy::MainCommon::run()\r\n2018-09-05_19:19:39.41968 [2018-09-05 19:19:39.419][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #16 0x41a739 main\r\n2018-09-05_19:19:39.41971 [2018-09-05 19:19:39.419][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:104] thr<0> obj</lib64/libc.so.6>\r\n2018-09-05_19:19:39.42019 [2018-09-05 19:19:39.420][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:114] thr<0> #17 0x7f6cc5250444 __libc_start_main\r\n2018-09-05_19:19:39.42021 [2018-09-05 19:19:39.420][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:104] thr<0> obj<./envoy>\r\n2018-09-05_19:19:39.43588 [2018-09-05 19:19:39.435][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:117] thr<0> #18 0x419ed4 (unknown)\r\n2018-09-05_19:19:39.43591 [2018-09-05 19:19:39.435][510279][critical][backtrace] bazel-out/k8-dbg/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:121] end backtrace thread 0\r\n```\r\n\r\ndecoded with `stack_decode.py`:\r\n```\r\n2018-09-05_19:19:39.11074 [2018-09-05 19:19:39.110][510279][critical] Backtrace (most recent call first) from thread 0:\r\n  #1 std::unique_ptr<Envoy::Network::ClientConnection, std::default_delete<Envoy::Network::ClientConnection> >::get() const at unique_ptr.h:305\r\n  #2 std::unique_ptr<Envoy::Network::ClientConnection, std::default_delete<Envoy::Network::ClientConnection> >::operator->() const at unique_ptr.h:299\r\n  #3 Envoy::Http::CodecClient::close() at codec_client.cc:40\r\n  #4 Envoy::Upstream::HttpHealthCheckerImpl::HttpActiveHealthCheckSession::onTimeout() at health_checker_impl.cc:222\r\n  #5 Envoy::Upstream::HealthCheckerImplBase::ActiveHealthCheckSession::onTimeoutBase() at health_checker_base_impl.cc:274\r\n  #6 Envoy::Upstream::HealthCheckerImplBase::ActiveHealthCheckSession::ActiveHealthCheckSession(Envoy::Upstream::HealthCheckerImplBase&, std::shared_ptr<Envoy::Upstream::Host>)::{lambda()#2}::operator()() const at health_checker_base_impl.cc:186\r\n  #7 std::_Function_handler<void (), Envoy::Upstream::HealthCheckerImplBase::ActiveHealthCheckSession::ActiveHealthCheckSession(Envoy::Upstream::HealthCheckerImplBase&, std::shared_ptr<Envoy::Upstream::Host>)::{lambda()#2}>::_M_invoke(std::_Any_data const&) at functional:1871\r\n  #8 std::function<void ()>::operator()() const at functional:2267\r\n  #9 Envoy::Event::TimerImpl::TimerImpl(Envoy::Event::DispatcherImpl&, std::function<void ()>)::{lambda(int, short, void*)#1}::operator()(int, short, void*) const at timer_impl.cc:15\r\n  #10 Envoy::Event::TimerImpl::TimerImpl(Envoy::Event::DispatcherImpl&, std::function<void ()>)::{lambda(int, short, void*)#1}::_FUN(int, short, void*) at timer_impl.cc:15\r\n  #11 event_process_active_single_queue at event.c:1646\r\n  #12 event_process_active at event.c:1738\r\n  #13  (inlined by) event_base_loop at event.c:1961\r\n  #14 Envoy::Event::DispatcherImpl::run(Envoy::Event::Dispatcher::RunType) at dispatcher_impl.cc:161 (discriminator 4)\r\n  #15 Envoy::Server::InstanceImpl::run() at server.cc:428\r\n  #16 Envoy::MainCommonBase::run() at main_common.cc:83\r\n  #17 Envoy::MainCommon::run() at main_common.h:64\r\n  #18 main at main.cc:37 (discriminator 1)\r\n  #19\r\n  #20 ?? ??:0\r\n  #21\r\n  #22 _start at ??:?\r\n  #23\r\n```\r\n\r\ncc @snowp ",
  "closed_at": "2018-09-26T14:53:51Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/4351/comments",
  "created_at": "2018-09-05T20:01:38Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/4351/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/4351",
  "id": 357381329,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/4351/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2018-10-04T15:42:27Z",
    "closed_issues": 54,
    "created_at": "2018-05-28T22:46:02Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/7",
    "id": 3382114,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/7/labels",
    "node_id": "MDk6TWlsZXN0b25lMzM4MjExNA==",
    "number": 7,
    "open_issues": 0,
    "state": "closed",
    "title": "1.8.0",
    "updated_at": "2018-10-04T15:42:27Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/7"
  },
  "node_id": "MDU6SXNzdWUzNTczODEzMjk=",
  "number": 4351,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "segfault in Envoy::Http::CodecClient::close()",
  "updated_at": "2018-09-26T14:54:07Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/4351",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1444855?v=4",
    "events_url": "https://api.github.com/users/mpuncel/events{/privacy}",
    "followers_url": "https://api.github.com/users/mpuncel/followers",
    "following_url": "https://api.github.com/users/mpuncel/following{/other_user}",
    "gists_url": "https://api.github.com/users/mpuncel/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mpuncel",
    "id": 1444855,
    "login": "mpuncel",
    "node_id": "MDQ6VXNlcjE0NDQ4NTU=",
    "organizations_url": "https://api.github.com/users/mpuncel/orgs",
    "received_events_url": "https://api.github.com/users/mpuncel/received_events",
    "repos_url": "https://api.github.com/users/mpuncel/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mpuncel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mpuncel/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mpuncel"
  }
}