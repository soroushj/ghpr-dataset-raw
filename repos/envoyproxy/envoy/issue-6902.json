{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Title**: *HTTP Auth combined with grpc endpoints lead to auth body being copied into grpc header and potential assert() crashes when auth service returns 401*\r\n\r\n**Description**:\r\nCombining a HTTP based external auth service with GRPC crashes envoy if the HTTP body returned from the external auth service has \\r, \\n or \\0 in it and envoy decides to return it to the caller. This happens only when the request to the external auth service ends up denying access (401, but probably also on 403s). The root cause is that Utility::sendLocalReply() copies the external auth body text into a GrpMessage header without encoding the content (there is, in 1.10, even a TODO that this needs to be percent encoded). In our case it copies a pretty printed 401 JSON response into the header, and when the code in Filter::onComplete(...) calls HeaderString::setCopy, the latter has an an assert that verifies that the headers do not include \\0, \\r or \\n (code in envoy/http/header_map.h's validHeaderString method).\r\n\r\n(Caveat: We are using envoy through ambassador, but we checked with a plain upstream 1.10 release and could reproduce the issue. We also tested that removing the offending code did make it stop crashing)\r\n\r\nBefore going through this with code references, it is interesting to contemplate whether it makes sense to add the body as an header in the first place? Or is it actually added as a trailer but the code is tricking me? \r\n\r\nAll line numbers are relative to source corresponding to the  v1.10 tag:\r\n1) A request comes into envoy, which is configured with ext_authz.\r\n2) this calls out to a configured external auth service, which in this case returns this as body:\r\n```\r\n{\r\n  \"error\": {\r\n    \"code\": 401,\r\n    \"message\": \"Unauthorized\"\r\n  }\r\n}\r\n``` \r\n3) Since we are running a http based external auth, and we end up in Filter::onComplete in  source/extensions/filters/http/ext_authz/ext_authz.cc, line 157. ```response->status == CheckStatus::Denied```\r\nis true, so we enter the if-clause and callbacks_->sendLocalReply (line 160) is called.This ends up in source/common/http/async_client_impl.h's sendLocalReply which calls Utility::sendLocalReply (source/common/http/utility.cc) with the first value as true since it is a grpc request. This agains ends up in this code:\r\n\r\n```\r\nif (is_grpc) {\r\n    HeaderMapPtr response_headers{new HeaderMapImpl{\r\n        {Headers::get().Status, std::to_string(enumToInt(Code::OK))},\r\n        {Headers::get().ContentType, Headers::get().ContentTypeValues.Grpc},\r\n        {Headers::get().GrpcStatus,\r\n         std::to_string(\r\n             enumToInt(grpc_status ? grpc_status.value()\r\n                                   : Grpc::Utility::httpToGrpcStatus(enumToInt(response_code))))}}};\r\n    if (!body_text.empty() && !is_head_request) {\r\n      // TODO: GrpcMessage should be percent-encoded\r\n      response_headers->insertGrpcMessage().value(body_text);\r\n    }\r\n    encode_headers(std::move(response_headers), true); // Trailers only response\r\n    return;\r\n  }\r\n```\r\nNotice the **TODO**. Here we copy the body into a HeaderMapImpl (source/common/http/header_map_impl.cc), which then goes through it and is all happy until ti reaches ```ASSERT(valid());``` on line 23, which verifies headers:\r\n```\r\n     bool HeaderString::valid() const { return validHeaderString(getStringView()); }\r\n```\r\nwhich again leads to:\r\n```\r\n// Used by ASSERTs to validate internal consistency. E.g. valid HTTP header keys/values should\r\n// never contain embedded NULLs.\r\nstatic inline bool validHeaderString(absl::string_view s) {\r\n  for (const char c : {'\\0', '\\r', '\\n'}) {\r\n    if (s.find(c) != absl::string_view::npos) {\r\n      return false;\r\n    }\r\n  }\r\n  return true;\r\n}\r\n```\r\nwhich returns false due to the newlines in the body, and then the assert hits and envoy shuts down.\r\n\r\n*Repro steps*:\r\n1) Setup envoy with an external HTTP based auth service (we do this with ambassador), in our case the generated envoy config for the filter looks like this:\r\n```\r\n                                    \"http_filters\": [\r\n                                        {\r\n                                            \"config\": {\r\n                                                \"http_service\": {\r\n                                                    \"authorization_request\": {\r\n                                                        \"allowed_headers\": {\r\n                                                            \"patterns\": [ ] # removed for brevity\r\n                                                        }\r\n                                                    },\r\n                                                    \"authorization_response\": {\r\n                                                        \"allowed_client_headers\": {\r\n                                                            \"patterns\": [] # removed for brevity\r\n                                                    },\r\n                                                    \"authorization_response\": {\r\n                                                        \"allowed_client_headers\": {\r\n                                                            \"patterns\": [] # removed for brevity\r\n                                                        },\r\n                                                        \"allowed_upstream_headers\": {\r\n                                                            \"patterns\": [] # removed for brevity\r\n                                                        }\r\n                                                    },\r\n                                                    \"path_prefix\": \"/auth/ext\",\r\n                                                    \"server_uri\": {\r\n                                                        \"cluster\": \"cluster_extauth_lts_auth_9999\",\r\n                                                        \"timeout\": \"5.000s\",\r\n                                                        \"uri\": \"http://authservice/\"\r\n                                                    }\r\n                                                }\r\n                                            },\r\n                                            \"name\": \"envoy.ext_authz\"\r\n                                        },\r\n```\r\n2) Define a grpc service, such as:\r\n```\r\n{\r\n  \"connect_timeout\": \"4.000s\",\r\n  \"dns_lookup_family\": \"V4_ONLY\",\r\n  \"http2_protocol_options\": {},\r\n  \"lb_policy\": \"ROUND_ROBIN\",\r\n  \"load_assignment\": {\r\n    \"cluster_name\": \"cluster_grpc_example_50051\",\r\n    \"endpoints\": [\r\n      {\r\n        \"lb_endpoints\": [\r\n          {\r\n            \"endpoint\": {\r\n              \"address\": {\r\n                \"socket_address\": {\r\n                  \"address\": \"grpc-example\",\r\n                  \"port_value\": 50051,\r\n                  \"protocol\": \"TCP\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    ]\r\n  },\r\n  \"name\": \"cluster_grpc_example_50051\",\r\n  \"type\": \"STRICT_DNS\"\r\n}\r\n```\r\nHere we use the example hello world service from grpc: https://github.com/grpc/grpc/tree/master/examples/python/helloworld\r\n\r\n*Logs and call stack*:\r\n```\r\n[2019-05-10 22:42:54.560][67][debug][http] [source/common/http/conn_manager_impl.cc:580] [C22][S758412733360187786] request headers complete (end_stream=false):\r\n':method', 'POST'\r\n':scheme', 'http'\r\n':path', '/helloworld.Greeter/SayHello'\r\n':authority', 'localhost:8080'\r\n'content-type', 'application/grpc'\r\n'user-agent', 'grpc-go/1.20.0-dev'\r\n'te', 'trailers'\r\n\r\n[2019-05-10 22:42:54.560][67][trace][filter] [source/extensions/filters/http/ext_authz/ext_authz.cc:61] [C22][S758412733360187786] ext_authz filter calling authorization server\r\n[2019-05-10 22:42:54.560][67][debug][router] [source/common/router/router.cc:320] [C0][S12701450807089142569] cluster 'cluster_extauth_lts_auth_9999' match for URL '/auth/ext/helloworld.Greeter/SayHello'\r\n[2019-05-10 22:42:54.561][67][debug][router] [source/common/router/router.cc:381] [C0][S12701450807089142569] router decoding headers:\r\n':method', 'POST'\r\n':path', '/auth/ext/helloworld.Greeter/SayHello'\r\n':authority', 'localhost:8080'\r\n':scheme', 'http'\r\n'content-length', '0'\r\n'x-request-id', '97666d59-fc77-4edb-8f7f-3ff8343e6f76'\r\n'x-forwarded-for', '172.19.20.1,172.19.20.5'\r\n'x-forwarded-proto', 'http'\r\n'user-agent', 'grpc-go/1.20.0-dev'\r\n'x-envoy-internal', 'true'\r\n'x-envoy-expected-rq-timeout-ms', '5000'\r\n\r\n[2019-05-10 22:42:54.561][67][debug][pool] [source/common/http/http1/conn_pool.cc:88] creating a new connection\r\n[2019-05-10 22:42:54.561][67][debug][client] [source/common/http/codec_client.cc:26] [C23] connecting\r\n[2019-05-10 22:42:54.561][67][debug][connection] [source/common/network/connection_impl.cc:644] [C23] connecting to 172.19.99.8:9999\r\n[2019-05-10 22:42:54.561][67][debug][connection] [source/common/network/connection_impl.cc:653] [C23] connection in progress\r\n[2019-05-10 22:42:54.561][67][debug][pool] [source/common/http/conn_pool_base.cc:20] queueing request due to no available connections\r\n[2019-05-10 22:42:54.561][67][trace][http] [source/common/http/conn_manager_impl.cc:814] [C22][S758412733360187786] decode headers called: filter=0x560236421540 status=1\r\n[2019-05-10 22:42:54.561][67][trace][http2] [source/common/http/http2/codec_impl.cc:49] nghttp2: recv: [IB_READ_HEAD]\r\n[2019-05-10 22:42:54.561][67][trace][http2] [source/common/http/http2/codec_impl.cc:49] nghttp2: recv: payloadlen=13, type=0, flags=0x01, stream_id=1\r\n[2019-05-10 22:42:54.561][67][trace][http2] [source/common/http/http2/codec_impl.cc:49] nghttp2: recv: DATA\r\n[2019-05-10 22:42:54.561][67][trace][http2] [source/common/http/http2/codec_impl.cc:49] nghttp2: recv: no padding in payload\r\n[2019-05-10 22:42:54.561][67][trace][http2] [source/common/http/http2/codec_impl.cc:49] nghttp2: recv: [IB_READ_DATA]\r\n[2019-05-10 22:42:54.561][67][trace][http2] [source/common/http/http2/codec_impl.cc:49] nghttp2: recv: readlen=13, payloadleft=0\r\n[2019-05-10 22:42:54.561][67][trace][http2] [source/common/http/http2/codec_impl.cc:49] nghttp2: recv: data_readlen=13\r\n[2019-05-10 22:42:54.561][67][trace][http2] [source/common/http/http2/codec_impl.cc:411] [C22] recv frame type=0\r\n[2019-05-10 22:42:54.561][67][debug][http] [source/common/http/conn_manager_impl.cc:1037] [C22][S758412733360187786] request end stream\r\n[2019-05-10 22:42:54.562][67][trace][http] [source/common/http/conn_manager_impl.cc:931] [C22][S758412733360187786] decode data called: filter=0x560236421540 status=2\r\n[2019-05-10 22:42:54.562][67][trace][http2] [source/common/http/http2/codec_impl.cc:368] [C22] dispatched 107 bytes\r\n[2019-05-10 22:42:54.562][67][trace][http2] [source/common/http/http2/codec_impl.cc:49] nghttp2: stream: adjusting kept idle streams num_idle_streams=0, max=100\r\n[2019-05-10 22:42:54.562][67][trace][connection] [source/common/network/connection_impl.cc:440] [C23] socket event: 2\r\n[2019-05-10 22:42:54.562][67][trace][connection] [source/common/network/connection_impl.cc:508] [C23] write ready\r\n[2019-05-10 22:42:54.562][67][debug][connection] [source/common/network/connection_impl.cc:517] [C23] connected\r\n[2019-05-10 22:42:54.562][67][debug][client] [source/common/http/codec_client.cc:64] [C23] connected\r\n[2019-05-10 22:42:54.562][67][debug][pool] [source/common/http/http1/conn_pool.cc:245] [C23] attaching to next request\r\n[2019-05-10 22:42:54.562][67][debug][router] [source/common/router/router.cc:1165] [C0][S12701450807089142569] pool ready\r\n[2019-05-10 22:42:54.562][67][trace][connection] [source/common/network/connection_impl.cc:376] [C23] writing 311 bytes, end_stream false\r\n[2019-05-10 22:42:54.562][67][trace][connection] [source/common/network/connection_impl.cc:508] [C23] write ready\r\n[2019-05-10 22:42:54.562][67][trace][connection] [source/common/network/raw_buffer_socket.cc:66] [C23] write returns: 311\r\n[2019-05-10 22:42:54.562][67][trace][connection] [source/common/network/connection_impl.cc:440] [C23] socket event: 2\r\n[2019-05-10 22:42:54.562][67][trace][connection] [source/common/network/connection_impl.cc:508] [C23] write ready\r\n[2019-05-10 22:42:54.662][67][trace][connection] [source/common/network/connection_impl.cc:440] [C23] socket event: 3\r\n[2019-05-10 22:42:54.662][67][trace][connection] [source/common/network/connection_impl.cc:508] [C23] write ready\r\n[2019-05-10 22:42:54.662][67][trace][connection] [source/common/network/connection_impl.cc:478] [C23] read ready\r\n[2019-05-10 22:42:54.663][67][trace][connection] [source/common/network/raw_buffer_socket.cc:23] [C23] read returns: 260\r\n[2019-05-10 22:42:54.663][67][trace][connection] [source/common/network/raw_buffer_socket.cc:37] [C23] read error: Resource temporarily unavailable\r\n[2019-05-10 22:42:54.663][67][trace][http] [source/common/http/http1/codec_impl.cc:363] [C23] parsing 260 bytes\r\n[2019-05-10 22:42:54.663][67][trace][http] [source/common/http/http1/codec_impl.cc:476] [C23] message begin\r\n[2019-05-10 22:42:54.663][67][trace][http] [source/common/http/http1/codec_impl.cc:331] [C23] completed header: key=Date value=Fri, 10 May 2019 22:42:54 GMT\r\n[2019-05-10 22:42:54.663][67][trace][http] [source/common/http/http1/codec_impl.cc:331] [C23] completed header: key=Content-Type value=application/json\r\n[2019-05-10 22:42:54.663][67][trace][http] [source/common/http/http1/codec_impl.cc:331] [C23] completed header: key=X-Request-Id value=97666d59-fc77-4edb-8f7f-3ff8343e6f76\r\n[2019-05-10 22:42:54.663][67][trace][http] [source/common/http/http1/codec_impl.cc:331] [C23] completed header: key=Vary value=Accept-Encoding\r\n[2019-05-10 22:42:54.663][67][trace][http] [source/common/http/http1/codec_impl.cc:442] [C23] headers complete\r\n[2019-05-10 22:42:54.663][67][trace][http] [source/common/http/http1/codec_impl.cc:331] [C23] completed header: key=Content-Length value=67\r\n[2019-05-10 22:42:54.663][67][debug][router] [source/common/router/router.cc:717] [C0][S12701450807089142569] upstream headers complete: end_stream=false\r\n[2019-05-10 22:42:54.664][67][debug][http] [source/common/http/async_client_impl.cc:94] async http request response headers (end_stream=false):\r\n':status', '401'\r\n'date', 'Fri, 10 May 2019 22:42:54 GMT'\r\n'content-type', 'application/json'\r\n'x-request-id', '97666d59-fc77-4edb-8f7f-3ff8343e6f76'\r\n'vary', 'Accept-Encoding'\r\n'content-length', '67'\r\n'x-envoy-upstream-service-time', '101'\r\n\r\n[2019-05-10 22:42:54.664][67][trace][http] [source/common/http/async_client_impl.cc:102] async http request response data (length=67 end_stream=false)\r\n[2019-05-10 22:42:54.664][67][trace][http] [source/common/http/http1/codec_impl.cc:463] [C23] message complete\r\n[2019-05-10 22:42:54.664][67][trace][http] [source/common/http/http1/codec_impl.cc:734] [C23] message complete\r\n[2019-05-10 22:42:54.664][67][debug][client] [source/common/http/codec_client.cc:95] [C23] response complete\r\n[2019-05-10 22:42:54.664][67][trace][main] [source/common/event/dispatcher_impl.cc:133] item added to deferred deletion list (size=1)\r\n[2019-05-10 22:42:54.664][67][trace][http] [source/common/http/async_client_impl.cc:102] async http request response data (length=0 end_stream=true)\r\n[2019-05-10 22:42:54.665][67][trace][filter] [source/extensions/filters/http/ext_authz/ext_authz.cc:153] [C22][S758412733360187786] ext_authz filter received status code 401\r\n[2019-05-10 22:42:54.665][67][debug][filter] [source/extensions/filters/http/ext_authz/ext_authz.cc:159] [C22][S758412733360187786] ext_authz filter rejected the request\r\n[2019-05-10 22:42:54.665][67][critical][assert] [source/common/http/header_map_impl.cc:213] assert failure: valid().\r\n[2019-05-10 22:42:54.665][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:81] Caught Aborted, suspect faulting address 0x35\r\n[2019-05-10 22:42:54.665][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:69] Backtrace (use tools/stack_decode.py to get line numbers):\r\n[2019-05-10 22:42:54.693][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #0: Envoy::SignalAction::sigHandler() [0x56023416b2c8] ??:0\r\n[2019-05-10 22:42:54.693][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #1: [0x7fdeeae1e4b0]\r\n[2019-05-10 22:42:54.711][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #2: Envoy::Http::HeaderMapImpl::HeaderEntryImpl::value() [0x560233f770c2] ??:0\r\n[2019-05-10 22:42:54.735][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #3: Envoy::Http::HeaderMapImpl::HeaderEntryImpl::value() [0x560233f77121] ??:0\r\n[2019-05-10 22:42:54.756][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #4: Envoy::Http::Utility::sendLocalReply() [0x560233e86cbf] ??:0\r\n[2019-05-10 22:42:54.778][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #5: Envoy::Http::ConnectionManagerImpl::ActiveStream::sendLocalReply() [0x560233befa90] ??:0\r\n[2019-05-10 22:42:54.800][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #6: Envoy::Http::ConnectionManagerImpl::ActiveStreamDecoderFilter::sendLocalReply() [0x560233bf8bb5] ??:0\r\n[2019-05-10 22:42:54.820][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #7: Envoy::Extensions::HttpFilters::ExtAuthz::Filter::onComplete() [0x560233194c39] ??:0\r\n[2019-05-10 22:42:54.836][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #8: Envoy::Extensions::Filters::Common::ExtAuthz::RawHttpClientImpl::onSuccess() [0x56023319aae0] ??:0\r\n[2019-05-10 22:42:54.854][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #9: Envoy::Http::AsyncRequestImpl::onComplete() [0x560233b6be3d] ??:0\r\n[2019-05-10 22:42:54.871][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #10: Envoy::Http::AsyncRequestImpl::onData() [0x560233b6bfc8] ??:0\r\n[2019-05-10 22:42:54.888][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #11: Envoy::Http::AsyncStreamImpl::encodeData() [0x560233b6b223] ??:0\r\n[2019-05-10 22:42:54.904][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #12: Envoy::Router::Filter::onUpstreamData() [0x560233b7a018] ??:0\r\n[2019-05-10 22:42:54.922][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #13: Envoy::Router::Filter::UpstreamRequest::decodeData() [0x560233b7c0e2] ??:0\r\n[2019-05-10 22:42:54.938][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #14: Envoy::Http::StreamDecoderWrapper::decodeData() [0x560233ab6f21] ??:0\r\n[2019-05-10 22:42:54.938][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #15: Envoy::Http::StreamDecoderWrapper::decodeData() [0x560233ab6f21] ??:0\r\n[2019-05-10 22:42:54.956][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #16: Envoy::Http::Http1::ClientConnectionImpl::onMessageComplete() [0x560233c0f12f] ??:0\r\n[2019-05-10 22:42:54.972][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #17: Envoy::Http::Http1::ConnectionImpl::onMessageCompleteBase() [0x560233c0cbf3] ??:0\r\n[2019-05-10 22:42:54.990][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #18: Envoy::Http::Http1::ConnectionImpl::{lambda()#7}::operator()() [0x560233c0b578] ??:0\r\n[2019-05-10 22:42:55.006][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #19: Envoy::Http::Http1::ConnectionImpl::{lambda()#7}::_FUN() [0x560233c0b59c] ??:0\r\n[2019-05-10 22:42:55.023][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #20: http_parser_execute [0x560233ecf30a] ??:0\r\n[2019-05-10 22:42:55.039][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #21: Envoy::Http::Http1::ConnectionImpl::dispatchSlice() [0x560233c0c46b] ??:0\r\n[2019-05-10 22:42:55.056][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #22: Envoy::Http::Http1::ConnectionImpl::dispatch() [0x560233c0c30b] ??:0\r\n[2019-05-10 22:42:55.080][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #23: Envoy::Http::CodecClient::onData() [0x560233b50830] ??:0\r\n[2019-05-10 22:42:55.096][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #24: Envoy::Http::CodecClient::CodecReadFilter::onData() [0x560233b512da] ??:0\r\n[2019-05-10 22:42:55.114][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #25: Envoy::Network::FilterManagerImpl::onContinueReading() [0x560233893a2d] ??:0\r\n[2019-05-10 22:42:55.131][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #26: Envoy::Network::FilterManagerImpl::onRead() [0x560233893b44] ??:0\r\n[2019-05-10 22:42:55.148][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #27: Envoy::Network::ConnectionImpl::onRead() [0x56023388a6f4] ??:0\r\n[2019-05-10 22:42:55.164][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #28: Envoy::Network::ConnectionImpl::onReadReady() [0x56023388bebb] ??:0\r\n[2019-05-10 22:42:55.181][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #29: Envoy::Network::ConnectionImpl::onFileEvent() [0x56023388bc59] ??:0\r\n[2019-05-10 22:42:55.200][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #30: Envoy::Network::ConnectionImpl::ConnectionImpl()::{lambda()#3}::operator()() [0x56023388843f] ??:0\r\n[2019-05-10 22:42:55.217][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #31: std::_Function_handler<>::_M_invoke() [0x56023388dda3] ??:0\r\n[2019-05-10 22:42:55.235][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #32: std::function<>::operator()() [0x560233881f42] ??:0\r\n[2019-05-10 22:42:55.251][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #33: Envoy::Event::FileEventImpl::assignEvents()::{lambda()#1}::operator()() [0x560233881b9e] ??:0\r\n[2019-05-10 22:42:55.269][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #34: Envoy::Event::FileEventImpl::assignEvents()::{lambda()#1}::_FUN() [0x560233881c1c] ??:0\r\n[2019-05-10 22:42:55.285][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #35: event_process_active_single_queue.isra.31 [0x560233ea7203] ??:0\r\n[2019-05-10 22:42:55.302][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #36: event_process_active [0x560233ea775f] ??:0\r\n[2019-05-10 22:42:55.318][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #37: event_base_loop [0x560233eabe10] ??:0\r\n[2019-05-10 22:42:55.336][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #38: Envoy::Event::LibeventScheduler::run() [0x5602338a0f0a] ??:0\r\n[2019-05-10 22:42:55.352][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #39: Envoy::Event::DispatcherImpl::run() [0x56023387cfb8] ??:0\r\n[2019-05-10 22:42:55.370][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #40: Envoy::Server::WorkerImpl::threadRoutine() [0x56023386a84b] ??:0\r\n[2019-05-10 22:42:55.387][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #41: Envoy::Server::WorkerImpl::start()::{lambda()#1}::operator()() [0x56023386a11a] ??:0\r\n[2019-05-10 22:42:55.404][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #42: std::_Function_handler<>::_M_invoke() [0x56023386b159] ??:0\r\n[2019-05-10 22:42:55.421][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #43: std::function<>::operator()() [0x5602331c3878] ??:0\r\n[2019-05-10 22:42:55.438][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #44: Envoy::Thread::ThreadImplPosix::ThreadImplPosix()::{lambda()#1}::operator()() [0x56023416e344] ??:0\r\n[2019-05-10 22:42:55.455][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:73] #45: Envoy::Thread::ThreadImplPosix::ThreadImplPosix()::{lambda()#1}::_FUN() [0x56023416e368] ??:0\r\n[2019-05-10 22:42:55.456][67][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #46: [0x7fdeeae13cf8]\r\n```\r\n\r\nPossible fixes:\r\n1) Fix the TODO and encode the body\r\n2) Stop putting the body into the header, but somewhere else (trailer?)? If so, make sure that doesn't need encoding.\r\n\r\nI am not (yet) that familiar with GRPC, but 2) sounds pretty good for me.\r\n\r\n\r\n",
  "closed_at": "2019-05-30T17:22:16Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6902/comments",
  "created_at": "2019-05-10T23:00:01Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6902/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/6902",
  "id": 442921898,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6902/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-07-11T18:22:23Z",
    "closed_issues": 70,
    "created_at": "2019-03-01T23:01:48Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/10",
    "id": 4101146,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/10/labels",
    "node_id": "MDk6TWlsZXN0b25lNDEwMTE0Ng==",
    "number": 10,
    "open_issues": 0,
    "state": "closed",
    "title": "1.11.0",
    "updated_at": "2020-04-17T15:48:02Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/10"
  },
  "node_id": "MDU6SXNzdWU0NDI5MjE4OTg=",
  "number": 6902,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Using a HTTP based external auth service with GRPC proxy entries crashes envoy on 401s",
  "updated_at": "2019-05-30T17:22:16Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/6902",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/26273540?v=4",
    "events_url": "https://api.github.com/users/thorkildcognite/events{/privacy}",
    "followers_url": "https://api.github.com/users/thorkildcognite/followers",
    "following_url": "https://api.github.com/users/thorkildcognite/following{/other_user}",
    "gists_url": "https://api.github.com/users/thorkildcognite/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/thorkildcognite",
    "id": 26273540,
    "login": "thorkildcognite",
    "node_id": "MDQ6VXNlcjI2MjczNTQw",
    "organizations_url": "https://api.github.com/users/thorkildcognite/orgs",
    "received_events_url": "https://api.github.com/users/thorkildcognite/received_events",
    "repos_url": "https://api.github.com/users/thorkildcognite/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/thorkildcognite/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thorkildcognite/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/thorkildcognite"
  }
}