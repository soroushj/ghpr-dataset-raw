{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/11790727?v=4",
    "events_url": "https://api.github.com/users/qiwzhang/events{/privacy}",
    "followers_url": "https://api.github.com/users/qiwzhang/followers",
    "following_url": "https://api.github.com/users/qiwzhang/following{/other_user}",
    "gists_url": "https://api.github.com/users/qiwzhang/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/qiwzhang",
    "id": 11790727,
    "login": "qiwzhang",
    "node_id": "MDQ6VXNlcjExNzkwNzI3",
    "organizations_url": "https://api.github.com/users/qiwzhang/orgs",
    "received_events_url": "https://api.github.com/users/qiwzhang/received_events",
    "repos_url": "https://api.github.com/users/qiwzhang/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/qiwzhang/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qiwzhang/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/qiwzhang"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/11790727?v=4",
      "events_url": "https://api.github.com/users/qiwzhang/events{/privacy}",
      "followers_url": "https://api.github.com/users/qiwzhang/followers",
      "following_url": "https://api.github.com/users/qiwzhang/following{/other_user}",
      "gists_url": "https://api.github.com/users/qiwzhang/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/qiwzhang",
      "id": 11790727,
      "login": "qiwzhang",
      "node_id": "MDQ6VXNlcjExNzkwNzI3",
      "organizations_url": "https://api.github.com/users/qiwzhang/orgs",
      "received_events_url": "https://api.github.com/users/qiwzhang/received_events",
      "repos_url": "https://api.github.com/users/qiwzhang/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/qiwzhang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qiwzhang/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/qiwzhang"
    }
  ],
  "author_association": "NONE",
  "body": "*Title*: *Envoy does not modify `content-length` header after applying BodyFormat to error responses from External Authorization service.*\r\n\r\n*Description*:\r\nWhen using a [localReply](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/local_reply) Envoy treats responses from External Authorization Service as 'local' (I might argue that external authorization responses should not be treated as 'local' but that may be 'as designed').  However, when applying a body format the `content-length` header returned for the original body of the external authorization response is not modified after applying the body format. This causes the `content-length` response header and the actual length of the body to be mismatched.\r\n\r\n*Repro steps*:\r\n- Configure an external http authorization service\r\n- Configure local reply to apply a new Body Format\r\nFor example a JSON format:\r\n```\r\n            \"local_reply_config\": {\r\n             \"body_format\": {\r\n              \"json_format\": {\r\n               \"code\": \"%RESPONSE_CODE%\",\r\n               \"error\": \"%LOCAL_REPLY_BODY%\",\r\n               \"trace\": \"%REQ(X-REQUEST-ID)%\"\r\n              }\r\n             }\r\n            }\r\n```\r\n- Make request that fails authorization\r\n\r\nFor example, response direct from authorization service:\r\n```\r\n< content-length: 12\r\n< \r\nUnauthorized\r\n```\r\n\r\nResponse returned by Envoy\r\n\r\n```\r\n< content-length: 12\r\n< x-request-id: b87918f4-5b88-4b85-b150-77e8310a4436\r\n< \r\n* Excess found in a non pipelined read: excess = 71, size = 12, maxdownload = 12, bytecount = 0\r\n{\"trace\":\"b8\r\n```\r\n\r\n*Logs*:\r\n```\r\n{\"bytes-sent\":83,\"response-duration\":null,\"x-forwarded-for\":\"172.17.0.1\",\"method\":\"GET\",\"x-global-transaction-id\":\"1722909b-70e9-46f9-8ebe-23a19cd3b5a5\",\"response-flags\":\"UAEX\",\"status-details\":\"ext_authz_denied\",\"response-tx-duration\":null,\"upstream-cluster\":null,\"type\":\"ACCESS\",\"time_date\":\"2020-08-17T18:21:36.613Z\",\"upstream-host\":null,\"status\":401,\"x-aaa-userinfo\":null,\"host\":\"test-service.com:32500\",\"upstream-path\":\"/xxx/ok\",\"bytes-received\":0,\"path\":\"/xxx/ok\",\"request-duration\":4,\"upstream-tls-fail\":null,\"duration\":192,\"x-request-id\":\"1722909b-70e9-46f9-8ebe-23a19cd3b5a5\"}\r\n```\r\n\r\nIf other information is needed to reproduce/debug I can, but was having issues sanitizing the large amount of data.",
  "closed_at": "2020-08-27T20:57:21Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12690/comments",
  "created_at": "2020-08-17T19:24:12Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12690/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/12690",
  "id": 680472074,
  "labels": [
    {
      "color": "d4c5f9",
      "default": false,
      "description": "",
      "id": 1715341036,
      "name": "area/http",
      "node_id": "MDU6TGFiZWwxNzE1MzQxMDM2",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/http"
    },
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12690/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2ODA0NzIwNzQ=",
  "number": 12690,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Envoy does not modify `content-length` header after applying BodyFormat to error responses from External Authorization service",
  "updated_at": "2020-08-27T20:57:21Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/12690",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/68928399?v=4",
    "events_url": "https://api.github.com/users/alkov-ibm/events{/privacy}",
    "followers_url": "https://api.github.com/users/alkov-ibm/followers",
    "following_url": "https://api.github.com/users/alkov-ibm/following{/other_user}",
    "gists_url": "https://api.github.com/users/alkov-ibm/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alkov-ibm",
    "id": 68928399,
    "login": "alkov-ibm",
    "node_id": "MDQ6VXNlcjY4OTI4Mzk5",
    "organizations_url": "https://api.github.com/users/alkov-ibm/orgs",
    "received_events_url": "https://api.github.com/users/alkov-ibm/received_events",
    "repos_url": "https://api.github.com/users/alkov-ibm/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alkov-ibm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alkov-ibm/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alkov-ibm"
  }
}