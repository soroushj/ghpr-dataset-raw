{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1942589?v=4",
    "events_url": "https://api.github.com/users/jmarantz/events{/privacy}",
    "followers_url": "https://api.github.com/users/jmarantz/followers",
    "following_url": "https://api.github.com/users/jmarantz/following{/other_user}",
    "gists_url": "https://api.github.com/users/jmarantz/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jmarantz",
    "id": 1942589,
    "login": "jmarantz",
    "node_id": "MDQ6VXNlcjE5NDI1ODk=",
    "organizations_url": "https://api.github.com/users/jmarantz/orgs",
    "received_events_url": "https://api.github.com/users/jmarantz/received_events",
    "repos_url": "https://api.github.com/users/jmarantz/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jmarantz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jmarantz/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jmarantz"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/1942589?v=4",
      "events_url": "https://api.github.com/users/jmarantz/events{/privacy}",
      "followers_url": "https://api.github.com/users/jmarantz/followers",
      "following_url": "https://api.github.com/users/jmarantz/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmarantz/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jmarantz",
      "id": 1942589,
      "login": "jmarantz",
      "node_id": "MDQ6VXNlcjE5NDI1ODk=",
      "organizations_url": "https://api.github.com/users/jmarantz/orgs",
      "received_events_url": "https://api.github.com/users/jmarantz/received_events",
      "repos_url": "https://api.github.com/users/jmarantz/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jmarantz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmarantz/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jmarantz"
    }
  ],
  "author_association": "MEMBER",
  "body": "As a result of https://github.com/istio/istio/issues/7912, I've been running bunch of experiments, and it looks that the per listener and per cluster memory overhead is a bit too high...\r\n\r\n(numbers with `--concurrency 1 --disable-hot-restart`, include improvements from #4190)\r\n\r\nThere is ~18KB of memory allocated per each TCP listener (no TLS), ~6KB (~35%) of which is allocated for 5 listener stats (assuming the same `stat_prefix` is used for all TCP stats). There is also ~1450 bytes of overhead per thread/worker for each TCP listener, ~900 bytes of which come from stats.\r\n\r\nThere is ~63kB of memory allocated per each HTTP listener (1 route, no TLS), ~18kB (~30%) of which is allocated for 13 listener stats (assuming the same `stat_prefix` is used for all HTTP stats). There is also ~1350 bytes of overhead per thread/worker for each HTTP listener, ~900 bytes of which come from stats.\r\n\r\nThere is ~72kB of memory allocated per each static cluster (no TLS, no health-check), ~58kB (~80%) of which is allocated for 72 stats. There is also ~1850 bytes of overhead per thread/worker for each static cluster.\r\n\r\nThat means that for each listener and cluster pair, there is ~90kB (TCP) or ~135kB (HTTP) of memory allocated, majority of which is allocated for stats (roughly ~800 bytes per counter/gauge and ~3000 bytes per histogram). Those numbers get even worse when we add TLS to the mix, since it adds 8 more stats for each.\r\n\r\nI've noticed that @jmarantz and @ambuc are already working on optimizing stats memory usage in #3585, so I won't be duplicating their work, which leaves a few more drastic options, that potentially yield much bigger savings:\r\n1. add option to disable per listener & per cluster stats (either in config or completely omit them at build-time with `#ifdef`), this is pretty trivial and a huge win, assuming those stats are not consumed,\r\n2. delay cluster initialization until first use, though this might get tricky with EDS and HDS,\r\n3. request CDS from control plane on first use (but that probably wouldn't yield any improvements over 2, would require much bigger changes, and doesn't fit well into eventual consistency mantra).\r\n\r\nThoughts?\r\n\r\ncc @htuch @louiscryan @costinm @lizan ",
  "closed_at": null,
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/in/1724?v=4",
    "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
    "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/apps/stale",
    "id": 26384082,
    "login": "stale[bot]",
    "node_id": "MDM6Qm90MjYzODQwODI=",
    "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
    "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
    "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
    "type": "Bot",
    "url": "https://api.github.com/users/stale%5Bbot%5D"
  },
  "comments": 62,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/4196/comments",
  "created_at": "2018-08-18T10:46:01Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/4196/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/4196",
  "id": 351810837,
  "labels": [
    {
      "color": "f9d0c4",
      "default": false,
      "description": "",
      "id": 455776416,
      "name": "area/perf",
      "node_id": "MDU6TGFiZWw0NTU3NzY0MTY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/perf"
    },
    {
      "color": "e2ce8a",
      "default": false,
      "description": "Disables stalebot from closing an issue",
      "id": 988830710,
      "name": "no stalebot",
      "node_id": "MDU6TGFiZWw5ODg4MzA3MTA=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/no%20stalebot"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/4196/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzNTE4MTA4Mzc=",
  "number": 4196,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "open",
  "title": "Per listener and per cluster memory overhead is too high",
  "updated_at": "2020-09-17T00:04:17Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/4196",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/190297?v=4",
    "events_url": "https://api.github.com/users/PiotrSikora/events{/privacy}",
    "followers_url": "https://api.github.com/users/PiotrSikora/followers",
    "following_url": "https://api.github.com/users/PiotrSikora/following{/other_user}",
    "gists_url": "https://api.github.com/users/PiotrSikora/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/PiotrSikora",
    "id": 190297,
    "login": "PiotrSikora",
    "node_id": "MDQ6VXNlcjE5MDI5Nw==",
    "organizations_url": "https://api.github.com/users/PiotrSikora/orgs",
    "received_events_url": "https://api.github.com/users/PiotrSikora/received_events",
    "repos_url": "https://api.github.com/users/PiotrSikora/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/PiotrSikora/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/PiotrSikora/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/PiotrSikora"
  }
}