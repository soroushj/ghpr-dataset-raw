{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "*Title*: Lua: envoy with Lua HTTP filter enable crashes on release build on osx\r\n\r\n*Description*:\r\nEnvoy with Lua HTTP filter crashes on release build. Seems like something is wrong (failed to do the placement to the allocated mem?) when executing the placement new operator [here](https://github.com/envoyproxy/envoy/blob/master/source/extensions/filters/common/lua/lua.h#L101) for the `StreamHandleWrapper`.\r\n\r\n```cpp\r\n ENVOY_LOG(trace, \"creating {} at {}\", typeid(T).name(), mem);\r\n return {new (mem) T(std::forward<ConstructorArgs>(args)...), state};\r\n```\r\n\r\n*Repro steps*:\r\n\r\nBuild Envoy using `-c opt`.\r\n\r\n```\r\n$ bazel --bazelrc=/dev/null build -c opt //source/exe:envoy-static.stripped\r\n$ ./bazel-bin/source/exe/envoy-static.stripped -c config.yaml\r\n$ curl localhost:10000\r\n// 10000 is the listener port\r\n```\r\n\r\nWhere an example of config.yaml is as follows:\r\n\r\n```yaml\r\nstatic_resources:\r\n  listeners:\r\n  - name: main\r\n    address:\r\n      socket_address:\r\n        address: 0.0.0.0\r\n        port_value: 10000\r\n    filter_chains:\r\n    - filters:\r\n      - name: envoy.http_connection_manager\r\n        config:\r\n          stat_prefix: ingress_http\r\n          route_config:\r\n            name: local_route\r\n            virtual_hosts:\r\n            - name: local_service\r\n              domains: [\"*\"]\r\n              routes:\r\n              - match:\r\n                  prefix: \"/\"\r\n                route:\r\n                  host_rewrite: www.google.com\r\n                  cluster: service_google\r\n          http_filters:\r\n          - name: envoy.lua\r\n            config:\r\n              inline_code: |\r\n                function envoy_on_request(request_handle)\r\n                end\r\n                function envoy_on_response(response_handle)\r\n                end\r\n          - name: envoy.router\r\n            config: {}\r\n\r\n  clusters:\r\n  - name: service_google\r\n    connect_timeout: 0.25s\r\n    type: LOGICAL_DNS\r\n    # Comment out the following line to test on v6 networks\r\n    dns_lookup_family: V4_ONLY\r\n    lb_policy: ROUND_ROBIN\r\n    hosts:\r\n      - socket_address:\r\n          address: google.com\r\n          port_value: 443\r\n    tls_context: { sni: www.google.com }\r\nadmin:\r\n  access_log_path: \"/dev/null\"\r\n  address:\r\n    socket_address:\r\n      address: 0.0.0.0\r\n      port_value: 5000\r\n```\r\n\r\n*Logs*:\r\n\r\n```\r\n[2019-01-09 19:13:23.818][4252367][debug][http] [source/common/http/conn_manager_impl.cc:539] [C0][S4589606042074743932] request headers complete (end_stream=true):\r\n':authority', 'localhost:10000'\r\n':path', '/'\r\n':method', 'GET'\r\n'user-agent', 'curl/7.62.0'\r\n'accept', '*/*'\r\n\r\n[2019-01-09 19:13:23.818][4252367][debug][http] [source/common/http/conn_manager_impl.cc:988] [C0][S4589606042074743932] request end stream\r\n[2019-01-09 19:13:23.818][4252367][trace][lua] [bazel-out/darwin-opt/bin/source/extensions/filters/common/lua/_virtual_includes/lua_lib/extensions/filters/common/lua/lua.h:100] creating N5Envoy10Extensions11HttpFilters3Lua19StreamHandleWrapperE at 0x1e0e6a8\r\n[2019-01-09 19:13:23.818][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:125] Caught Segmentation fault: 11, suspect faulting address 0x0\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:89] Backtrace thr<123145554665472> obj<envoy-static.stripped>:\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:104] thr<123145554665472> obj<envoy-static.stripped               0x0000000100f0bbf5 _ZN5Envoy10Extensions7Filters6Common3Lua13BaseLuaObjectINS0_11HttpFilters3Lua19StreamHandleWrapperEE6createIJRNS3_9CoroutineERNS_4Http9HeaderMapERbRNS6_6FilterERNS6_15FilterCallbacksEEEENSt3__14pairIPS7_P9lua_StateEESO_DpOT_>\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #0 0x100f0bbf5\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:104] thr<123145554665472> obj<envoy-static.stripped>\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #1 0x100f0b9f1 Envoy::Extensions::HttpFilters::Lua::Filter::doHeaders(Envoy::Extensions::Filters::Common::Lua::LuaDeathRef<Envoy::Extensions::HttpFilters::Lua::StreamHandleWrapper>&, std::__1::unique_ptr<Envoy::Extensions::Filters::Common::Lua::Coroutine, std::__1::default_delete<Envoy::Extensions::Filters::Common::Lua::Coroutine> >&, Envoy::Extensions::HttpFilters::Lua::FilterCallbacks&, int, Envoy::Http::HeaderMap&, bool) + 209\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #2 0x100f0c59c Envoy::Extensions::HttpFilters::Lua::Filter::decodeHeaders(Envoy::Http::HeaderMap&, bool) + 76\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #3 0x1013aff7d Envoy::Http::ConnectionManagerImpl::ActiveStream::decodeHeaders(Envoy::Http::ConnectionManagerImpl::ActiveStreamDecoderFilter*, Envoy::Http::HeaderMap&, bool) + 349\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #4 0x1013af441 Envoy::Http::ConnectionManagerImpl::ActiveStream::decodeHeaders(std::__1::unique_ptr<Envoy::Http::HeaderMap, std::__1::default_delete<Envoy::Http::HeaderMap> >&&, bool) + 2465\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #5 0x101510502 Envoy::Http::Http1::ServerConnectionImpl::onMessageComplete() + 82\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #6 0x10150f522 Envoy::Http::Http1::ConnectionImpl::onMessageCompleteBase() + 226\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #7 0x1015121bc Envoy::Http::Http1::ConnectionImpl::$_7::__invoke(http_parser*) + 12\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #8 0x101514d6f http_parser_execute + 4847\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #9 0x10150efff Envoy::Http::Http1::ConnectionImpl::dispatchSlice(char const*, unsigned long) + 47\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #10 0x10150ee1e Envoy::Http::Http1::ConnectionImpl::dispatch(Envoy::Buffer::Instance&) + 286\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #11 0x1013ac3e8 Envoy::Http::ConnectionManagerImpl::onData(Envoy::Buffer::Instance&, bool) + 264\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #12 0x1011c12e2 Envoy::Network::FilterManagerImpl::onRead() + 130\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #13 0x1011bd986 Envoy::Network::ConnectionImpl::onReadReady() + 358\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #14 0x1011bd524 Envoy::Network::ConnectionImpl::onFileEvent(unsigned int) + 132\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #15 0x1011b76d2 Envoy::Event::FileEventImpl::assignEvents(unsigned int)::$_0::__invoke(int, short, void*) + 50\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #16 0x1015e2086 event_process_active_single_queue + 1766\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #17 0x1015de7cb event_base_loop + 1691\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #18 0x1011b6ae4 Envoy::Event::DispatcherImpl::run(Envoy::Event::Dispatcher::RunType) + 132\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #19 0x1011b159f Envoy::Server::WorkerImpl::threadRoutine(Envoy::Server::GuardDog&) + 191\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #20 0x1018c6c92 Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>)::$_0::__invoke(void*) + 18\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:104] thr<123145554665472> obj<libsystem_pthread.dylib>\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:110] thr<123145554665472> #21 0x7fff62beb304 _pthread_body + 125\r\n[2019-01-09 19:13:23.821][4252367][critical][backtrace] [bazel-out/darwin-opt/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:121] end backtrace thread 123145554665472\r\nSegmentation fault: 11\r\n```",
  "closed_at": "2019-04-16T19:47:37Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1016047?v=4",
    "events_url": "https://api.github.com/users/lizan/events{/privacy}",
    "followers_url": "https://api.github.com/users/lizan/followers",
    "following_url": "https://api.github.com/users/lizan/following{/other_user}",
    "gists_url": "https://api.github.com/users/lizan/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lizan",
    "id": 1016047,
    "login": "lizan",
    "node_id": "MDQ6VXNlcjEwMTYwNDc=",
    "organizations_url": "https://api.github.com/users/lizan/orgs",
    "received_events_url": "https://api.github.com/users/lizan/received_events",
    "repos_url": "https://api.github.com/users/lizan/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lizan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lizan/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lizan"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5551/comments",
  "created_at": "2019-01-09T12:46:51Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5551/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/5551",
  "id": 397355735,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5551/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzOTczNTU3MzU=",
  "number": 5551,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "lua, osx: envoy with lua http HTTP filter enabled crashes on release build",
  "updated_at": "2019-04-16T19:47:37Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/5551",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/73152?v=4",
    "events_url": "https://api.github.com/users/dio/events{/privacy}",
    "followers_url": "https://api.github.com/users/dio/followers",
    "following_url": "https://api.github.com/users/dio/following{/other_user}",
    "gists_url": "https://api.github.com/users/dio/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/dio",
    "id": 73152,
    "login": "dio",
    "node_id": "MDQ6VXNlcjczMTUy",
    "organizations_url": "https://api.github.com/users/dio/orgs",
    "received_events_url": "https://api.github.com/users/dio/received_events",
    "repos_url": "https://api.github.com/users/dio/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/dio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dio/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/dio"
  }
}