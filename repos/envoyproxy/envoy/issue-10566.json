{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
    "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
    "followers_url": "https://api.github.com/users/alyssawilk/followers",
    "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
    "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alyssawilk",
    "id": 18220477,
    "login": "alyssawilk",
    "node_id": "MDQ6VXNlcjE4MjIwNDc3",
    "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
    "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
    "repos_url": "https://api.github.com/users/alyssawilk/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alyssawilk"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
      "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
      "followers_url": "https://api.github.com/users/alyssawilk/followers",
      "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
      "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/alyssawilk",
      "id": 18220477,
      "login": "alyssawilk",
      "node_id": "MDQ6VXNlcjE4MjIwNDc3",
      "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
      "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
      "repos_url": "https://api.github.com/users/alyssawilk/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/alyssawilk"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "Envoy produces invalid response when TLS http/1.1 cluster returns `upgrade: h2` and `transfer-encoding: chunked`\r\n\r\n\r\nWhen http/1.1 TLS cluster returns following headers in a response:\r\n```\r\nConnection: upgrade\r\nUpgrade: h2\r\nTransfer-Encoding: chunked\r\n```\r\nEnvoy returns invalid response downstream.\r\n\r\n\r\nDirect request to the upstream using curl works correctly:\r\n```\r\n#> curl -k --http1.1 -v https://localhost:8443/upgrade-h2-chunked\r\n...\r\n< HTTP/1.1 200 OK\r\n< Connection: upgrade\r\n< Upgrade: h2\r\n< Date: Sun, 29 Mar 2020 17:18:13 GMT\r\n< Transfer-Encoding: chunked\r\n<\r\nService response /upgrade-h2-chunked\r\n```\r\n\r\nThrough Envoy we receive something like this:\r\n```\r\n#> curl -H \"host: service\" -v http://localhost:6002/upgrade-h2-chunked\r\n< HTTP/1.1 200 OK\r\n< upgrade: h2\r\n< date: Sun, 29 Mar 2020 17:18:31 GMT\r\n< x-envoy-upstream-service-time: 0\r\n< server: envoy\r\n< transfer-encoding: chunked\r\n<\r\n25\r\nService response /upgrade-h2-chunked\r\n\r\n0\r\n\r\n* transfer closed with outstanding read data remaining\r\n* Closing connection 0\r\ncurl: (18) transfer closed with outstanding read data remaining\r\n```\r\n\r\nResponses with `transfer-encoding: chunked` only or `upgrade: h2` only work correctly through Envoy.\r\n\r\nIt seems like Envoy doesn't decode chunked encoding correctly when `upgrade: h2` is present. The strange numbers added to an original response are simply not decoded chunked encoding metadata.\r\n\r\nIf I see correctly, Envoy doesn't support Upgrade to http2:\r\n> Currently, Envoy only supports prior knowledge for upstream connections \r\n\r\n[docs](https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#config-cluster-v3-cluster)\r\n\r\nEven if Envoy doesn't support it, I think an `Upgrade` header in a response with status other than 426 should be treated as an advertisment and can be safely ignored:\r\n> A server MAY send an Upgrade header field in any other response to\r\n   advertise that it implements support for upgrading to the listed\r\n   protocols, in order of descending preference, when appropriate for a\r\n   future request. (rfc7230)\r\n\r\nSomebody already reported similar problem on Istio github: https://github.com/istio/istio/issues/17790\r\n\r\nIn real life case we encountered this problem when upstream returned `upgrade: h2,h2c`, so let's not forget about that case too.\r\n\r\n## How to reproduce\r\n\r\nI prepared docker-compose environment where this error can be reproduced. More info in README: https://github.com/MarcinFalkowski/envoy-broken-response-reproduce\r\nThe problem can be reproduced on latest master version (commit a29664c3a8dfa2337be0781c1cee747aa149f482)\r\n\r\n## Logs\r\n\r\nIn Envoy logs we can see that Envoy enters `upgrade mode` and then wait for upstream for additional data (despite fact, that all data are already sent) until timeout occurs\r\n<details>\r\n<summary>envoy logs</summary>\r\n\r\n```\r\nenvoy_1    | [2020-03-29 16:51:21.858][13][trace][http] [source/common/http/http1/codec_impl.cc:636] [C1] message begin\r\nenvoy_1    | [2020-03-29 16:51:21.858][13][trace][http] [source/common/http/http1/codec_impl.cc:425] [C1] completed header: key=Connection value=upgrade\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][http] [source/common/http/http1/codec_impl.cc:425] [C1] completed header: key=Upgrade value=h2\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][http] [source/common/http/http1/codec_impl.cc:425] [C1] completed header: key=Date value=Sun, 29 Mar 2020 16:51:21 GMT\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][http] [source/common/http/http1/codec_impl.cc:559] [C1] onHeadersCompleteBase\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][http] [source/common/http/http1/codec_impl.cc:425] [C1] completed header: key=Transfer-Encoding value=chunked\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][http] [source/common/http/http1/codec_impl.cc:589] [C1] codec entering upgrade mode.\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][http] [source/common/http/http1/codec_impl.cc:924] [C1] Client: onHeadersComplete size=4\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][debug][router] [source/common/router/router.cc:1142] [C0][S9047571861382008090] upstream headers complete: end_stream=false\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][debug][http] [source/common/http/conn_manager_impl.cc:1702] [C0][S9047571861382008090] encoding headers via codec (end_stream=false):\r\nenvoy_1    | ':status', '200'\r\nenvoy_1    | 'upgrade', 'h2'\r\nenvoy_1    | 'date', 'Sun, 29 Mar 2020 16:51:21 GMT'\r\nenvoy_1    | 'x-envoy-upstream-service-time', '6'\r\nenvoy_1    | 'server', 'envoy'\r\nenvoy_1    |\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][connection] [source/common/network/connection_impl.cc:429] [C0] writing 146 bytes, end_stream false\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][http] [source/common/http/http1/codec_impl.cc:615] [C1] message complete\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][http] [source/common/http/http1/codec_impl.cc:621] [C1] Pausing parser due to upgrade.\r\nenvoy_1    | [2020-03-29 16:51:21.859][13][trace][http] [source/common/http/http1/codec_impl.cc:483] [C1] parsed 118 bytes\r\n\r\n...\r\n\r\nenvoy_1    | [2020-03-29 16:51:36.851][13][debug][router] [source/common/router/router.cc:812] [C0][S9047571861382008090] upstream timeout\r\nenvoy_1    | [2020-03-29 16:51:36.851][13][debug][router] [source/common/router/upstream_request.cc:264] [C0][S9047571861382008090] resetting pool request\r\n```\r\n\r\n</details>\r\n\r\n## Config\r\n\r\n<details>\r\n<summary>cluster</summary>\r\n\r\n```yaml\r\n  clusters:\r\n  - name: service\r\n    type: STRICT_DNS\r\n    connect_timeout: 1s\r\n    load_assignment:\r\n      cluster_name: service\r\n      endpoints:\r\n      - lb_endpoints:\r\n        - endpoint:\r\n            address:\r\n              socket_address:\r\n                address: service\r\n                port_value: 443\r\n    transport_socket:\r\n      name: envoy.transport_sockets.tls\r\n```\r\n\r\n</details>",
  "closed_at": "2020-04-10T18:38:30Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/10566/comments",
  "created_at": "2020-03-29T19:00:45Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/10566/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/10566",
  "id": 589859465,
  "labels": [
    {
      "color": "d4c5f9",
      "default": false,
      "description": "",
      "id": 1715341036,
      "name": "area/http",
      "node_id": "MDU6TGFiZWwxNzE1MzQxMDM2",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/http"
    },
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/10566/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1ODk4NTk0NjU=",
  "number": 10566,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Envoy produces invalid response when TLS http/1.1 cluster returns `upgrade: h2` and `transfer-encoding: chunked`",
  "updated_at": "2020-04-10T18:38:30Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/10566",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/30294040?v=4",
    "events_url": "https://api.github.com/users/MarcinFalkowski/events{/privacy}",
    "followers_url": "https://api.github.com/users/MarcinFalkowski/followers",
    "following_url": "https://api.github.com/users/MarcinFalkowski/following{/other_user}",
    "gists_url": "https://api.github.com/users/MarcinFalkowski/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/MarcinFalkowski",
    "id": 30294040,
    "login": "MarcinFalkowski",
    "node_id": "MDQ6VXNlcjMwMjk0MDQw",
    "organizations_url": "https://api.github.com/users/MarcinFalkowski/orgs",
    "received_events_url": "https://api.github.com/users/MarcinFalkowski/received_events",
    "repos_url": "https://api.github.com/users/MarcinFalkowski/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/MarcinFalkowski/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MarcinFalkowski/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/MarcinFalkowski"
  }
}