{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/921312?v=4",
    "events_url": "https://api.github.com/users/mergeconflict/events{/privacy}",
    "followers_url": "https://api.github.com/users/mergeconflict/followers",
    "following_url": "https://api.github.com/users/mergeconflict/following{/other_user}",
    "gists_url": "https://api.github.com/users/mergeconflict/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mergeconflict",
    "id": 921312,
    "login": "mergeconflict",
    "node_id": "MDQ6VXNlcjkyMTMxMg==",
    "organizations_url": "https://api.github.com/users/mergeconflict/orgs",
    "received_events_url": "https://api.github.com/users/mergeconflict/received_events",
    "repos_url": "https://api.github.com/users/mergeconflict/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mergeconflict/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mergeconflict/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mergeconflict"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars1.githubusercontent.com/u/921312?v=4",
      "events_url": "https://api.github.com/users/mergeconflict/events{/privacy}",
      "followers_url": "https://api.github.com/users/mergeconflict/followers",
      "following_url": "https://api.github.com/users/mergeconflict/following{/other_user}",
      "gists_url": "https://api.github.com/users/mergeconflict/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mergeconflict",
      "id": 921312,
      "login": "mergeconflict",
      "node_id": "MDQ6VXNlcjkyMTMxMg==",
      "organizations_url": "https://api.github.com/users/mergeconflict/orgs",
      "received_events_url": "https://api.github.com/users/mergeconflict/received_events",
      "repos_url": "https://api.github.com/users/mergeconflict/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mergeconflict/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mergeconflict/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mergeconflict"
    }
  ],
  "author_association": "MEMBER",
  "body": "We've discovered a reproducible use-after-free in `InitManagerImpl`. The general pattern is:\r\n\r\n1. A `Target` registers itself with an `InitManagerImpl`.\r\n2. `InitManagerImpl::initialize()` is called, which invokes `Target::initialize()` on the target. It passes a callback argument, a lambda that captures (but does not own) `InitManagerImpl`. The target, in this case, stores the callback and begins initializing asynchronously.\r\n3. The `InitManagerImpl` is freed from the heap.\r\n4. Finally, the `Target`s finishes initializing and invokes its callback, which attempts to use the freed `InitManagerImpl` previously captured.\r\n\r\nThe specific case where we are hitting this is essentially a race between LDS and RDS. I'll try to describe this at both the xDS level, and the code level (in terms of the steps above).\r\n\r\n* Start from a state where `ListenerManagerImpl` has all its workers started, so any `ListenerImpl` created will use its own `dynamic_init_manager_` rather than the global one (see `ListenerImpl::initManager`).\r\n* LDS receives a listener, which references some route configuration that hasn't been defined yet, so RDS requests that route configuration.\r\n    * A `ListenerImpl` is created for the listener, which owns an `InitManagerImpl`.\r\n    * A `RdsRouteConfigSubscription` is created, and registers itself as a target with the above `InitManagerImpl` (step 1 above).\r\n    * The `ListenerImpl` is initialized, which calls initialize on the `RdsRouteConfigSubscription`. The callback is stored while we wait for the RDS response (step 2 above).\r\n* LDS then receives a new version of the same listener, overwriting the old version.\r\n    * The original `ListenerImpl` is destroyed, which destroys the `InitManagerImpl` it owns (step 3 above).\r\n* Finally, RDS receives the response for the route configuration it had previously requested.\r\n    * The `RdsRouteConfigSubscription` invokes its callback, referencing the now deleted `InitManagerImpl` (step 4 above).\r\n\r\nThe relevant bits from the actual stack trace:\r\n```\r\n#0: Envoy::SignalAction::sigHandler() [0x1b6fd0c] source/exe/signal_action.cc:17\r\n#1: __restore_rt [0x7fa1b0d540c0] ??:0\r\n#2: std::__cxx11::list<>::remove() [0x126d1a4] /usr/lib/gcc/x86_64-linux-gnu/8.0.1/../../../../include/c++/8.0.1/bits/list.tcc:335\r\n#3: Envoy::Server::InitManagerImpl::initializeTarget()::$_0::operator()() [0x126c61b] source/server/init_manager_impl.cc:45\r\n#4: std::_Function_handler<>::_M_invoke() [0x126c29d] /usr/lib/gcc/x86_64-linux-gnu/8.0.1/../../../../include/c++/8.0.1/bits/std_function.h:299\r\n#5: std::function<>::operator()() [0x4f645e] /usr/lib/gcc/x86_64-linux-gnu/8.0.1/../../../../include/c++/8.0.1/bits/std_function.h:687\r\n#6: Envoy::Router::RdsRouteConfigSubscription::runInitializeCallbackIfAny() [0xa4ded0] source/common/router/rds_impl.cc:138\r\n#7: Envoy::Router::RdsRouteConfigSubscription::onConfigUpdate() [0xa4e48b] source/common/router/rds_impl.cc:?\r\n#8: Envoy::Config::GrpcMuxSubscriptionImpl<>::onConfigUpdate() [0xa59929] bazel-out/k8-dbg/bin/source/common/config/_virtual_includes/grpc_mux_subscription_lib/common/config/grpc_mux_subscription_impl.h:55\r\n#9: Envoy::Config::GrpcMuxImpl::handleResponse() [0x11697f4] source/common/config/grpc_mux_impl.cc:171\r\n#10: Envoy::Config::GrpcStream<>::onReceiveMessage() [0x116b3de] bazel-out/k8-dbg/bin/source/common/config/_virtual_includes/grpc_stream_lib/common/config/grpc_stream.h:82\r\n#11: Envoy::Grpc::TypedAsyncStreamCallbacks<>::onReceiveMessageUntyped() [0x116b2a9] bazel-out/k8-dbg/bin/include/envoy/grpc/_virtual_includes/async_client_interface/envoy/grpc/async_client.h:172\r\n#12: Envoy::Grpc::AsyncStreamImpl::onData() [0xd96c8d] source/common/grpc/async_client_impl.cc:142\r\n#13: Envoy::Http::AsyncStreamImpl::encodeData() [0xd9bd35] source/common/http/async_client_impl.cc:105\r\n#14: Envoy::Router::Filter::onUpstreamData() [0x119a13b] source/common/router/router.cc:770\r\n#15: Envoy::Router::Filter::UpstreamRequest::decodeData() [0x119bc67] source/common/router/router.cc:985\r\n#16: Envoy::Http::StreamDecoderWrapper::decodeData() [0x8c65ec] bazel-out/k8-dbg/bin/source/common/http/_virtual_includes/codec_wrappers_lib/common/http/codec_wrappers.h:37\r\n#17: Envoy::Http::Http2::ConnectionImpl::onFrameReceived() [0x12a305b] source/common/http/http2/codec_impl.cc:503\r\n#18: Envoy::Http::Http2::ConnectionImpl::Http2Callbacks::Http2Callbacks()::$_9::operator()() [0x12a7aa8] source/common/http/http2/codec_impl.cc:808\r\n#19: Envoy::Http::Http2::ConnectionImpl::Http2Callbacks::Http2Callbacks()::$_9::__invoke() [0x12a7a75] source/common/http/http2/codec_impl.cc:807\r\n```\r\n\r\nDecoding that a bit:\r\n* Frames 8 through 6: RDS receives update...\r\n* Frames 5 through 3: RDS calls its stored callback...\r\n* Frame 2: The callback attempts to remove the RdsRouteConfigSubscription from its list of init targets...\r\n* Frames 1 and 0: Oh noes, that list of init targets was previously freed.",
  "closed_at": "2019-03-27T03:20:22Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6116/comments",
  "created_at": "2019-02-27T22:25:08Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6116/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/6116",
  "id": 415355709,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6116/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-04-05T18:08:09Z",
    "closed_issues": 57,
    "created_at": "2018-12-13T16:08:19Z",
    "creator": {
      "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
      "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
      "followers_url": "https://api.github.com/users/alyssawilk/followers",
      "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
      "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/alyssawilk",
      "id": 18220477,
      "login": "alyssawilk",
      "node_id": "MDQ6VXNlcjE4MjIwNDc3",
      "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
      "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
      "repos_url": "https://api.github.com/users/alyssawilk/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/alyssawilk"
    },
    "description": null,
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/9",
    "id": 3897143,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/9/labels",
    "node_id": "MDk6TWlsZXN0b25lMzg5NzE0Mw==",
    "number": 9,
    "open_issues": 0,
    "state": "closed",
    "title": "1.10.0",
    "updated_at": "2019-04-05T18:08:09Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/9"
  },
  "node_id": "MDU6SXNzdWU0MTUzNTU3MDk=",
  "number": 6116,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "use-after-free in Init::Manager",
  "updated_at": "2019-03-27T03:20:22Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/6116",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/921312?v=4",
    "events_url": "https://api.github.com/users/mergeconflict/events{/privacy}",
    "followers_url": "https://api.github.com/users/mergeconflict/followers",
    "following_url": "https://api.github.com/users/mergeconflict/following{/other_user}",
    "gists_url": "https://api.github.com/users/mergeconflict/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mergeconflict",
    "id": 921312,
    "login": "mergeconflict",
    "node_id": "MDQ6VXNlcjkyMTMxMg==",
    "organizations_url": "https://api.github.com/users/mergeconflict/orgs",
    "received_events_url": "https://api.github.com/users/mergeconflict/received_events",
    "repos_url": "https://api.github.com/users/mergeconflict/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mergeconflict/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mergeconflict/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mergeconflict"
  }
}