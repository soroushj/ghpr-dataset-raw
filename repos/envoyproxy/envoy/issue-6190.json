{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    }
  ],
  "author_association": "NONE",
  "body": "Hi,\r\n\r\nI've been chasing a certain issue that is very difficult to reproduce. I'm using envoy v1.8.0 and have an unencrypted HTTP/1.1 local upstream, an HTTP/2 downstream, and use HTTP connection manager. The cluster configuration is\r\n\r\n```\r\nname: \"/websso\"\r\nconnect_timeout {\r\n  seconds: 120\r\n}\r\nhosts {\r\n  socket_address {\r\n    address: \"127.0.0.1\"\r\n    port_value: 7080\r\n  }\r\n}\r\n```\r\n\r\nand the route match rule is\r\n\r\n`{\"match\":{\"path\":\"/websso\"}, \"route: {\"cluster\":\"/websso\",\"timeout\":\"28800s\",\"use_websocket\":true,\"idle_timeout\":\"28800s\"}}}`\r\n\r\nMy issue is that from time to time I get these \"503 UC\"s, e.g.\r\n\r\n```\r\n2019-03-06T11:02:11.968Z GET /websso HTTP/2 200 - 0 433415 6 5 0 10.197.41.4:57937 10.197.41.64:443 127.0.0.1:60382 127.0.0.1:7080\r\n2019-03-06T11:07:34.910Z GET /websso HTTP/2 503 UC 0 57 0 - - 10.197.41.4:58440 10.197.41.64:443 127.0.0.1:60382 127.0.0.1:7080\r\n```\r\n\r\nThe packet capture has this to say for request/response 1.\r\n\r\n```\r\n11:02:11.968219    127.0.0.1             60382    127.0.0.1             7080      TCP      68     60382 \u2192 7080 [SYN] Seq=0 Win=43690 Len=0 MSS=65495 SACK_PERM=1 WS=256\r\n11:02:11.968225    127.0.0.1             7080     127.0.0.1             60382     TCP      68     7080 \u2192 60382 [SYN, ACK] Seq=0 Ack=1 Win=43690 Len=0 MSS=65495 SACK_PERM=1 WS=256\r\n11:02:11.968230    127.0.0.1             60382    127.0.0.1             7080      TCP      56     60382 \u2192 7080 [ACK] Seq=1 Ack=1 Win=43776 Len=0\r\n11:02:11.969252    127.0.0.1             60382    127.0.0.1             7080      TCP      1894   60382 \u2192 7080 [PSH, ACK] Seq=1 Ack=1 Win=43776 Len=1838\r\n11:02:11.969256    127.0.0.1             7080     127.0.0.1             60382     TCP      56     7080 \u2192 60382 [ACK] Seq=1 Ack=1839 Win=174848 Len=0\r\n11:02:11.972626    127.0.0.1             7080     127.0.0.1             60382     TCP      8248   7080 \u2192 60382 [PSH, ACK] Seq=1 Ack=1839 Win=174848 Len=8192\r\n11:02:11.972638    127.0.0.1             60382    127.0.0.1             7080      TCP      56     60382 \u2192 7080 [ACK] Seq=1839 Ack=8193 Win=174848 Len=0\r\n...\r\n11:02:11.973868    127.0.0.1             7080     127.0.0.1             60382     TCP      40548  7080 \u2192 60382 [PSH, ACK] Seq=393094 Ack=1839 Win=174848 Len=40492\r\n11:02:11.973886    127.0.0.1             60382    127.0.0.1             7080      TCP      56     60382 \u2192 7080 [ACK] Seq=1839 Ack=433586 Win=320512 Len=0\r\n11:03:12.094243    127.0.0.1             7080     127.0.0.1             60382     TCP      56     7080 \u2192 60382 [FIN, ACK] Seq=433586 Ack=1839 Win=174848 Len=0\r\n11:03:12.132002    127.0.0.1             60382    127.0.0.1             7080      TCP      56     60382 \u2192 7080 [ACK] Seq=1839 Ack=433587 Win=464896 Len=0\r\n```\r\n\r\nand the following for request/response 2.\r\n\r\n```\r\n11:07:34.910503    127.0.0.1             60382    127.0.0.1             7080      TCP      1933   60382 \u2192 7080 [PSH, ACK] Seq=1 Ack=1 Win=1816 Len=1877\r\n11:07:34.910519    127.0.0.1             7080     127.0.0.1             60382     TCP      56     7080 \u2192 60382 [RST] Seq=1 Win=0 Len=0\r\n```\r\n\r\nIt seems that envoy didn't reply with a FIN and instead pooled the connection and tried to reuse it 4 minutes later which ended badly.\r\n\r\nThe envoy log contains the following for that connection.\r\n\r\n```\r\n2019-03-06T11:02:11.968Z debug envoy[37657] [Originator@6876 sub=client] source/common/http/codec_client.cc:25 [C715] connecting\r\n2019-03-06T11:02:11.968Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:632 [C715] connecting to 127.0.0.1:7080\r\n2019-03-06T11:02:11.968Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:641 [C715] connection in progress\r\n2019-03-06T11:02:11.969Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:514 [C715] connected\r\n2019-03-06T11:02:11.969Z debug envoy[37657] [Originator@6876 sub=client] source/common/http/codec_client.cc:63 [C715] connected\r\n2019-03-06T11:02:11.969Z debug envoy[37657] [Originator@6876 sub=pool] source/common/http/http1/conn_pool.cc:252 [C715] attaching to next request\r\n2019-03-06T11:02:11.974Z debug envoy[37657] [Originator@6876 sub=client] source/common/http/codec_client.cc:94 [C715] response complete\r\n2019-03-06T11:02:11.974Z debug envoy[37657] [Originator@6876 sub=pool] source/common/http/http1/conn_pool.cc:209 [C715] response complete\r\n2019-03-06T11:02:11.974Z debug envoy[37657] [Originator@6876 sub=pool] source/common/http/http1/conn_pool.cc:247 [C715] moving to ready\r\n2019-03-06T11:07:34.910Z debug envoy[37657] [Originator@6876 sub=pool] source/common/http/http1/conn_pool.cc:90 [C715] using existing connection\r\n2019-03-06T11:07:34.910Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:499 [C715] remote close\r\n2019-03-06T11:07:34.910Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:181 [C715] closing socket: 0\r\n2019-03-06T11:07:34.910Z debug envoy[37657] [Originator@6876 sub=client] source/common/http/codec_client.cc:81 [C715] disconnect. resetting 1 pending requests\r\n2019-03-06T11:07:34.910Z debug envoy[37657] [Originator@6876 sub=client] source/common/http/codec_client.cc:104 [C715] request reset\r\n2019-03-06T11:07:34.910Z debug envoy[37657] [Originator@6876 sub=pool] source/common/http/http1/conn_pool.cc:123 [C715] client disconnected\r\n```\r\n\r\nA good connection that happened around that time looks like\r\n\r\n```\r\n2019-03-06T11:02:11.967Z debug envoy[37657] [Originator@6876 sub=client] source/common/http/codec_client.cc:25 [C714] connecting\r\n2019-03-06T11:02:11.967Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:632 [C714] connecting to 127.0.0.1:7080\r\n2019-03-06T11:02:11.967Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:641 [C714] connection in progress\r\n2019-03-06T11:02:11.969Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:514 [C714] connected\r\n2019-03-06T11:02:11.969Z debug envoy[37657] [Originator@6876 sub=client] source/common/http/codec_client.cc:63 [C714] connected\r\n2019-03-06T11:02:11.969Z debug envoy[37657] [Originator@6876 sub=pool] source/common/http/http1/conn_pool.cc:252 [C714] attaching to next request\r\n2019-03-06T11:02:11.973Z debug envoy[37657] [Originator@6876 sub=client] source/common/http/codec_client.cc:94 [C714] response complete\r\n2019-03-06T11:02:11.973Z debug envoy[37657] [Originator@6876 sub=pool] source/common/http/http1/conn_pool.cc:209 [C714] response complete\r\n2019-03-06T11:02:11.973Z debug envoy[37657] [Originator@6876 sub=pool] source/common/http/http1/conn_pool.cc:247 [C714] moving to ready\r\n2019-03-06T11:03:12.758Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:499 [C714] remote close\r\n2019-03-06T11:03:12.758Z debug envoy[37657] [Originator@6876 sub=connection] source/common/network/connection_impl.cc:181 [C714] closing socket: 0\r\n2019-03-06T11:03:12.758Z debug envoy[37657] [Originator@6876 sub=client] source/common/http/codec_client.cc:81 [C714] disconnect. resetting 0 pending requests\r\n2019-03-06T11:03:12.758Z debug envoy[37657] [Originator@6876 sub=pool] source/common/http/http1/conn_pool.cc:123 [C714] client disconnected\r\n```\r\nThe upstream server has a 1 minute idle timeout and it seems that for C714 and many other connections envoy properly received and processed the disconnect but not for C715.\r\n\r\nHave you heard of the above issue before and is there any remedy for it? It is possible to retry once for that particular case only and how?",
  "closed_at": "2019-04-15T22:33:04Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 16,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6190/comments",
  "created_at": "2019-03-06T13:54:51Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6190/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/6190",
  "id": 417815076,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6190/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-07-11T18:22:23Z",
    "closed_issues": 70,
    "created_at": "2019-03-01T23:01:48Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/10",
    "id": 4101146,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/10/labels",
    "node_id": "MDk6TWlsZXN0b25lNDEwMTE0Ng==",
    "number": 10,
    "open_issues": 0,
    "state": "closed",
    "title": "1.11.0",
    "updated_at": "2020-04-17T15:48:02Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/10"
  },
  "node_id": "MDU6SXNzdWU0MTc4MTUwNzY=",
  "number": 6190,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Missed upstream disconnect leading to 503 UC",
  "updated_at": "2019-05-03T01:26:59Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/6190",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/2481252?v=4",
    "events_url": "https://api.github.com/users/ppadevski/events{/privacy}",
    "followers_url": "https://api.github.com/users/ppadevski/followers",
    "following_url": "https://api.github.com/users/ppadevski/following{/other_user}",
    "gists_url": "https://api.github.com/users/ppadevski/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ppadevski",
    "id": 2481252,
    "login": "ppadevski",
    "node_id": "MDQ6VXNlcjI0ODEyNTI=",
    "organizations_url": "https://api.github.com/users/ppadevski/orgs",
    "received_events_url": "https://api.github.com/users/ppadevski/received_events",
    "repos_url": "https://api.github.com/users/ppadevski/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ppadevski/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ppadevski/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ppadevski"
  }
}