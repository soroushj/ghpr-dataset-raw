{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
    "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
    "followers_url": "https://api.github.com/users/alyssawilk/followers",
    "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
    "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alyssawilk",
    "id": 18220477,
    "login": "alyssawilk",
    "node_id": "MDQ6VXNlcjE4MjIwNDc3",
    "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
    "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
    "repos_url": "https://api.github.com/users/alyssawilk/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alyssawilk"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
      "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
      "followers_url": "https://api.github.com/users/alyssawilk/followers",
      "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
      "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/alyssawilk",
      "id": 18220477,
      "login": "alyssawilk",
      "node_id": "MDQ6VXNlcjE4MjIwNDc3",
      "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
      "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
      "repos_url": "https://api.github.com/users/alyssawilk/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/alyssawilk"
    }
  ],
  "author_association": "NONE",
  "body": "*Description*:\r\nWhen configured to proxy `Expect: 100-continue` (via `proxy_100_continue`), envoy will not forward timeouts to the client or update internal metrics as expected. \r\n\r\n*Config* / *Repro steps*:\r\nDon't have a clean minimal config to share, but I can reliably reproduce in a config where the listener has `proxy_100_continue` set to be true and the upstream cluster for a route has a timeout shorter than the request duration (with an upstream setup to support `100-continue` itself)\r\n\r\nFrom the perspective of curl, this looks like this:\r\n```\r\n> ....\r\n> Expect: 100-continue\r\n> \r\n< HTTP/1.1 100 Continue\r\n* TLSv1.2 (IN), TLS alert, Client hello (1):\r\n* Empty reply from server\r\n* Connection #0 to host <url> left intact\r\ncurl: (52) Empty reply from server\r\n```\r\n\r\nThis happens because in `router.cc`, `onUpstream100ContinueHeaders` sets `downstream_response_started_` to be true. Then when the request times out, `onUpstreamAbort` destroys the stream instead of sending & updating the code.\r\n\r\nIdeally the client would get the 503, but I'm not actually sure what is allowed/expected here as per http spec. What is definitely an issue is that we don't see expected timeout metrics for this (because `chargeUpstreamAbort` also checks `downstream_response_started_`), and not updating the response code internally means that in, eg access logs we see a status of 100 as supposed to a 503.\r\n\r\n*Logs*:\r\nEnvoy debug logs when this happens:\r\n```\r\n2020-07-16 14:36:58.201 [44][debug][router] [source/common/router/router.cc:816] [C6487][S12773442203076911571] upstream timeout\r\n2020-07-16 14:36:58.201 [44][debug][router] [source/common/router/upstream_request.cc:263] [C6487][S12773442203076911571] resetting pool request\r\n2020-07-16 14:36:58.201 [44][debug][client] [source/common/http/codec_client.cc:114] [C6490] request reset\r\n2020-07-16 14:36:58.201 [44][debug][connection] [source/common/network/connection_impl.cc:109] [C6490] closing data_to_write=0 type=1\r\n2020-07-16 14:36:58.201 [44][debug][connection] [source/common/network/connection_impl.cc:200] [C6490] closing socket: 1\r\n2020-07-16 14:36:58.201 [44][debug][connection] [source/extensions/transport_sockets/tls/ssl_socket.cc:298] [C6490] SSL shutdown: rc=0\r\n2020-07-16 14:36:58.201 [44][debug][connection] [source/extensions/transport_sockets/tls/ssl_socket.cc:226] [C6490] \r\n2020-07-16 14:36:58.202 [44][debug][client] [source/common/http/codec_client.cc:91] [C6490] disconnect. resetting 0 pending requests\r\n2020-07-16 14:36:58.202 [44][debug][pool] [source/common/http/conn_pool_base.cc:265] [C6490] client disconnected, failure reason: \r\n2020-07-16 14:36:58.202 [44][debug][http] [source/common/http/conn_manager_impl.cc:205] [C6487][S12773442203076911571] doEndStream() resetting stream\r\n2020-07-16 14:36:58.202 [44][debug][http] [source/common/http/conn_manager_impl.cc:1936] [C6487][S12773442203076911571] stream reset\r\n2020-07-16 14:36:58.202 [44][debug][connection] [source/common/network/connection_impl.cc:109] [C6487] closing data_to_write=0 type=2\r\n2020-07-16 14:36:58.202 [44][debug][connection] [source/common/network/connection_impl_base.cc:30] [C6487] setting delayed close timer with timeout 1000 ms\r\n2020-07-16 14:36:58.202 [44][debug][pool] [source/common/http/conn_pool_base.cc:93] [C6490] destroying stream: 0 remaining\r\n```",
  "closed_at": "2020-07-21T20:29:54Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
    "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
    "followers_url": "https://api.github.com/users/alyssawilk/followers",
    "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
    "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alyssawilk",
    "id": 18220477,
    "login": "alyssawilk",
    "node_id": "MDQ6VXNlcjE4MjIwNDc3",
    "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
    "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
    "repos_url": "https://api.github.com/users/alyssawilk/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alyssawilk"
  },
  "comments": 7,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12131/comments",
  "created_at": "2020-07-16T14:51:46Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12131/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/12131",
  "id": 658273159,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "Potential bug that needs verification",
      "id": 1715341851,
      "name": "investigate",
      "node_id": "MDU6TGFiZWwxNzE1MzQxODUx",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/investigate"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/12131/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2NTgyNzMxNTk=",
  "number": 12131,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Envoy doesn't forward/recognize timeout response codes when proxying 100-continue",
  "updated_at": "2020-07-21T20:29:54Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/12131",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/236084?v=4",
    "events_url": "https://api.github.com/users/jcdavis/events{/privacy}",
    "followers_url": "https://api.github.com/users/jcdavis/followers",
    "following_url": "https://api.github.com/users/jcdavis/following{/other_user}",
    "gists_url": "https://api.github.com/users/jcdavis/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jcdavis",
    "id": 236084,
    "login": "jcdavis",
    "node_id": "MDQ6VXNlcjIzNjA4NA==",
    "organizations_url": "https://api.github.com/users/jcdavis/orgs",
    "received_events_url": "https://api.github.com/users/jcdavis/received_events",
    "repos_url": "https://api.github.com/users/jcdavis/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jcdavis/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jcdavis/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jcdavis"
  }
}