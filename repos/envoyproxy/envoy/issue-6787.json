{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/587468?v=4",
    "events_url": "https://api.github.com/users/gsagula/events{/privacy}",
    "followers_url": "https://api.github.com/users/gsagula/followers",
    "following_url": "https://api.github.com/users/gsagula/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsagula/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/gsagula",
    "id": 587468,
    "login": "gsagula",
    "node_id": "MDQ6VXNlcjU4NzQ2OA==",
    "organizations_url": "https://api.github.com/users/gsagula/orgs",
    "received_events_url": "https://api.github.com/users/gsagula/received_events",
    "repos_url": "https://api.github.com/users/gsagula/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/gsagula/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsagula/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/gsagula"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars1.githubusercontent.com/u/587468?v=4",
      "events_url": "https://api.github.com/users/gsagula/events{/privacy}",
      "followers_url": "https://api.github.com/users/gsagula/followers",
      "following_url": "https://api.github.com/users/gsagula/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsagula/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/gsagula",
      "id": 587468,
      "login": "gsagula",
      "node_id": "MDQ6VXNlcjU4NzQ2OA==",
      "organizations_url": "https://api.github.com/users/gsagula/orgs",
      "received_events_url": "https://api.github.com/users/gsagula/received_events",
      "repos_url": "https://api.github.com/users/gsagula/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/gsagula/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsagula/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/gsagula"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "*Description*:\r\n> Envoy can segfault when using `ext_authz` with a request body larger than the limit and partial messages allowed. It does not always segfault, but for me it segfaults within about 5 or so attempts on an otherwise idle envoy.\r\n\r\ncc @gsagula \r\n\r\nExample: Send a 16k file a few times with a 8k limit:\r\n```\r\n          http_filters:\r\n          - name: envoy.ext_authz\r\n            config:\r\n              grpc_service:\r\n                envoy_grpc:\r\n                  cluster_name: auth-test-cluster\r\n                timeout: 0.2s\r\n              failure_mode_allow: true\r\n              with_request_body:\r\n                max_request_bytes: 8192\r\n                allow_partial_message: true\r\n          - name: envoy.router\r\n            config: {}\r\n```\r\n\r\n*Repro steps*:\r\n\r\nCreate a 16k test data file (larger files seem to work faster - try 100k):\r\n```\r\ndd if=/dev/zero of=16k.data bs=1k count=16\r\n```\r\n\r\nSend with curl:\r\n```\r\ncurl --data-binary '@16k.data' http://localhost:8000\r\n```\r\n\r\n*Config*:\r\n\r\nSimple config with 8k limit:\r\n```\r\nstatic_resources:\r\n\r\n  listeners:\r\n  - address:\r\n      socket_address:\r\n        address: 0.0.0.0\r\n        port_value: 80\r\n    filter_chains:\r\n    - filters:\r\n      - name: envoy.http_connection_manager\r\n        config:\r\n          codec_type: auto\r\n          stat_prefix: ingress_http\r\n          route_config:\r\n            name: local_route\r\n            virtual_hosts:\r\n            - name: backend\r\n              domains: [\"*\"]\r\n              routes:\r\n              - match:\r\n                  prefix: \"/\"\r\n                route:\r\n                  cluster: http-test-server\r\n          http_filters:\r\n          - name: envoy.ext_authz\r\n            config:\r\n              grpc_service:\r\n                envoy_grpc:\r\n                  cluster_name: auth-test-cluster\r\n                timeout: 0.2s\r\n              failure_mode_allow: true\r\n              with_request_body:\r\n                max_request_bytes: 8192\r\n                allow_partial_message: true\r\n          - name: envoy.router\r\n            config: {}\r\n  clusters:\r\n  - name: http-test-server\r\n    connect_timeout: 0.25s\r\n    type: strict_dns\r\n    load_assignment:\r\n      cluster_name: http-test-server\r\n      endpoints:\r\n      - lb_endpoints:\r\n        - endpoint:\r\n            address:\r\n              socket_address:\r\n                address: http-test-server\r\n                port_value: 8086\r\n  - name: auth-test-cluster\r\n    connect_timeout: 0.25s\r\n    type: strict_dns\r\n    http2_protocol_options: {}\r\n    load_assignment:\r\n      cluster_name: auth-test-cluster\r\n      endpoints:\r\n      - lb_endpoints:\r\n        - endpoint:\r\n            address:\r\n              socket_address:\r\n                address: auth-test-service\r\n                port_value: 8000\r\nadmin:\r\n  access_log_path: \"/dev/null\"\r\n  address:\r\n    socket_address:\r\n      address: 0.0.0.0\r\n      port_value: 8001\r\n```\r\n\r\n*Call Stack*:\r\n\r\nStacktrace using `envoyproxy/envoy-alpine-debug:latest` with `gdb` added:\r\n```\r\n0x00000000007fe66a in Envoy::Extensions::Filters::Common::ExtAuthz::GrpcClientImpl::onSuccess (this=0x4242800, response=...,\r\n    span=...) at source/extensions/filters/common/ext_authz/ext_authz_grpc_impl.cc:68\r\n68\tsource/extensions/filters/common/ext_authz/ext_authz_grpc_impl.cc: No such file or directory.\r\n(gdb) bt\r\n#0  0x00000000007fe66a in Envoy::Extensions::Filters::Common::ExtAuthz::GrpcClientImpl::onSuccess (this=0x4242800, response=...,\r\n    span=...) at source/extensions/filters/common/ext_authz/ext_authz_grpc_impl.cc:68\r\n#1  0x00000000007fe979 in Envoy::Grpc::TypedAsyncRequestCallbacks<envoy::service::auth::v2::CheckResponse>::onSuccessUntyped (\r\n    this=0x4242808, response=..., span=...)\r\n    at bazel-out/k8-opt/bin/include/envoy/grpc/_virtual_includes/async_client_interface/envoy/grpc/async_client.h:104\r\n#2  0x0000000000bf9bbd in Envoy::Grpc::AsyncRequestImpl::onRemoteClose (this=0x4199ba0, status=Envoy::Grpc::Status::Ok,\r\n    message=...) at source/common/grpc/async_client_impl.cc:260\r\n#3  0x0000000000bf9da0 in Envoy::Grpc::AsyncStreamImpl::onTrailers (this=0x4199ba8, trailers=...)\r\n    at source/common/grpc/async_client_impl.cc:160\r\n#4  0x0000000000c00a15 in Envoy::Http::AsyncStreamImpl::encodeTrailers (this=0x4282c00, trailers=...)\r\n    at source/common/http/async_client_impl.cc:111\r\n#5  0x0000000000ba6129 in Envoy::Http::StreamDecoderWrapper::decodeTrailers (this=0x4242920, trailers=...)\r\n    at bazel-out/k8-opt/bin/source/common/http/_virtual_includes/codec_wrappers_lib/common/http/codec_wrappers.h:44\r\n#6  0x0000000000c5c411 in Envoy::Http::Http2::ConnectionImpl::onFrameReceived (this=0x424a878, frame=0x4065598)\r\n    at source/common/http/http2/codec_impl.cc:470\r\n#7  0x0000000000c6739c in session_call_on_frame_received (frame=0x4065598, session=0x4065400)\r\n    at /build/tmp/_bazel_bazel/436badd4919a15958fa3800a4e21074a/execroot/ci/external/com_github_nghttp2_nghttp2/lib/nghttp2_session.c:3295\r\n#8  session_after_header_block_received (session=0x4065400)\r\n    at /build/tmp/_bazel_bazel/436badd4919a15958fa3800a4e21074a/execroot/ci/external/com_github_nghttp2_nghttp2/lib/nghttp2_session.c:3796\r\n#9  nghttp2_session_mem_recv (session=0x4065400, in=0x4270148 \"\", inlen=<optimized out>)\r\n    at /build/tmp/_bazel_bazel/436badd4919a15958fa3800a4e21074a/execroot/ci/external/com_github_nghttp2_nghttp2/lib/nghttp2_session.c:6254\r\n#10 0x0000000000c5d6a7 in Envoy::Http::Http2::ConnectionImpl::dispatch (this=0x424a878, data=...)\r\n    at source/common/http/http2/codec_impl.cc:360\r\n#11 0x0000000000bf0dc1 in Envoy::Http::CodecClient::onData (this=0x424a7e0, data=...) at source/common/http/codec_client.cc:116\r\n#12 0x0000000000bf0f9d in Envoy::Http::CodecClient::CodecReadFilter::onData (this=<optimized out>, data=...)\r\n    at bazel-out/k8-opt/bin/source/common/http/_virtual_includes/codec_client_lib/common/http/codec_client.h:167\r\n#13 0x0000000000a9bfac in Envoy::Network::FilterManagerImpl::onContinueReading (this=this@entry=0x4283420,\r\n    filter=filter@entry=0x0) at source/common/network/filter_manager_impl.cc:56\r\n#14 0x0000000000a9c07c in Envoy::Network::FilterManagerImpl::onRead (this=this@entry=0x4283420)\r\n    at source/common/network/filter_manager_impl.cc:66\r\n#15 0x0000000000a9881a in Envoy::Network::ConnectionImpl::onRead (read_buffer_size=584, this=0x4283400)\r\n    at source/common/network/connection_impl.cc:263\r\n#16 Envoy::Network::ConnectionImpl::onReadReady (this=this@entry=0x4283400) at source/common/network/connection_impl.cc:497\r\n--Type <RET> for more, q to quit, c to continue without paging--\r\n#17 0x0000000000a98f2a in Envoy::Network::ConnectionImpl::onFileEvent (this=0x4283400, events=<optimized out>)\r\n    at source/common/network/connection_impl.cc:473\r\n#18 0x0000000000a92bea in std::function<void (unsigned int)>::operator()(unsigned int) const (__args#0=<optimized out>,\r\n    this=<optimized out>) at /usr/include/c++/7/bits/std_function.h:706\r\n#19 Envoy::Event::FileEventImpl::<lambda(int, short int, void*)>::operator() (__closure=0x0, arg=<optimized out>,\r\n    what=<optimized out>) at source/common/event/file_event_impl.cc:64\r\n#20 Envoy::Event::FileEventImpl::<lambda(int, short int, void*)>::_FUN(int, short, void *) ()\r\n    at source/common/event/file_event_impl.cc:65\r\n#21 0x0000000000dc8489 in event_process_active_single_queue.isra ()\r\n#22 0x0000000000dc89bf in event_process_active ()\r\n#23 0x0000000000dca5c8 in event_base_loop ()\r\n```\r\n",
  "closed_at": "2019-05-20T22:03:13Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6787/comments",
  "created_at": "2019-05-02T19:05:59Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6787/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/6787",
  "id": 439741279,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6787/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-07-11T18:22:23Z",
    "closed_issues": 70,
    "created_at": "2019-03-01T23:01:48Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/10",
    "id": 4101146,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/10/labels",
    "node_id": "MDk6TWlsZXN0b25lNDEwMTE0Ng==",
    "number": 10,
    "open_issues": 0,
    "state": "closed",
    "title": "1.11.0",
    "updated_at": "2020-04-17T15:48:02Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/10"
  },
  "node_id": "MDU6SXNzdWU0Mzk3NDEyNzk=",
  "number": 6787,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Segfault using ext_authz request buffering with allow_partial_message set",
  "updated_at": "2019-05-20T22:03:13Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/6787",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/45215337?v=4",
    "events_url": "https://api.github.com/users/brectanus-sigsci/events{/privacy}",
    "followers_url": "https://api.github.com/users/brectanus-sigsci/followers",
    "following_url": "https://api.github.com/users/brectanus-sigsci/following{/other_user}",
    "gists_url": "https://api.github.com/users/brectanus-sigsci/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brectanus-sigsci",
    "id": 45215337,
    "login": "brectanus-sigsci",
    "node_id": "MDQ6VXNlcjQ1MjE1MzM3",
    "organizations_url": "https://api.github.com/users/brectanus-sigsci/orgs",
    "received_events_url": "https://api.github.com/users/brectanus-sigsci/received_events",
    "repos_url": "https://api.github.com/users/brectanus-sigsci/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brectanus-sigsci/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brectanus-sigsci/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brectanus-sigsci"
  }
}