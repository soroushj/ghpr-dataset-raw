{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**Note:** I saw the notice about crash bugs being disclosed via security list first however this issue was already discussed publicly in #1310 and @htuch requested this to filed as a separate issue and confirmed that since it's a control-plane induced crash it's outside the threat model.\r\n\r\n---\r\n\r\n*Description*:\r\n\r\nWhen a control plan being used for HDS sends a `HealthCheck` with missing required fields (e.g. `UnhealthyThreshold`) Envoy 1.14.1 will crash with `std:terminate` called.\r\n\r\n*Repro steps*:\r\n\r\n 1. Run Envoy 1.14.1 with HDS configured pointing to an xDS control plane\r\n 2. Have control plane sent `HealthCheckSpecifier` with at least one `HealthCheck` with a missing required field. e.g. (in go code):\r\n\r\n  ```go\r\nfunc (s *Server) hds(stream v2disco.HealthDiscoveryService_StreamHealthCheckServer) error {\r\n\tresp := &v2disco.HealthCheckSpecifier{\r\n\t\tClusterHealthChecks: []*v2disco.ClusterHealthCheck{\r\n\t\t\t{\r\n\t\t\t\tClusterName: \"cluster-00000\",\r\n\t\t\t\tHealthChecks: []*v2core.HealthCheck{\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tTimeout: &duration.Duration{\r\n\t\t\t\t\t\t\tSeconds: 1,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tInterval: &duration.Duration{\r\n\t\t\t\t\t\t\tSeconds: 1,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tUnhealthyThreshold: &wrappers.UInt32Value{Value: 2},\r\n\r\n\t\t\t\t\t\t// NOTICE THE FIELD BELOW IS NOT SET, uncommenting it prevents crash.\r\n\t\t\t\t\t\t//HealthyThreshold:   &wrappers.UInt32Value{Value: 2},\r\n\t\t\t\t\t\tHealthChecker: &v2core.HealthCheck_HttpHealthCheck_{\r\n\t\t\t\t\t\t\tHttpHealthCheck: &v2core.HealthCheck_HttpHealthCheck{\r\n\t\t\t\t\t\t\t\tHost: \"localhost\",\r\n\t\t\t\t\t\t\t\tPath: \"/v1/agent/self\",\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tAlwaysLogHealthCheckFailures: false,\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\tLocalityEndpoints: []*v2disco.LocalityEndpoints{\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tLocality: &v2core.Locality{\r\n\t\t\t\t\t\t\tRegion: \"us-west-1\",\r\n\t\t\t\t\t\t\tZone:   \"zone-a\",\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tEndpoints: []*v2endpoint.Endpoint{\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tAddress: &v2core.Address{\r\n\t\t\t\t\t\t\t\t\tAddress: &v2core.Address_SocketAddress{\r\n\t\t\t\t\t\t\t\t\t\tSocketAddress: &v2core.SocketAddress{\r\n\t\t\t\t\t\t\t\t\t\t\tAddress: \"127.0.0.1\",\r\n\t\t\t\t\t\t\t\t\t\t\tPortSpecifier: &v2core.SocketAddress_PortValue{\r\n\t\t\t\t\t\t\t\t\t\t\t\tPortValue: 8500,\r\n\t\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t},\r\n\t\tInterval: &duration.Duration{\r\n\t\t\tSeconds: 5,\r\n\t\t},\r\n\t}\r\n\treturn stream.Send(resp)\r\n}\r\n  ```\r\n\r\n 3. Watch Envoy Crash.\r\n\r\n*Config*:\r\n\r\n<details><summary>bootstrap.yaml</summary>\r\n\r\n```yaml\r\nadmin:\r\n  access_log_path: /dev/stdout\r\n  address:\r\n    socket_address:\r\n      address: 127.0.0.1\r\n      port_value: 19000\r\n\r\nhds_config:\r\n  api_type: GRPC\r\n  grpc_services:\r\n  - envoy_grpc:\r\n      cluster_name: xds_cluster\r\n  set_node_on_first_message_only: true\r\n\r\nnode:\r\n  cluster: test-cluster\r\n  id: test-id\r\n\r\nstatic_resources:\r\n  clusters:\r\n  - name: xds_cluster\r\n    connect_timeout: 1s\r\n    http2_protocol_options: {}\r\n    load_assignment:\r\n      cluster_name: xds_cluster\r\n      endpoints:\r\n      - lb_endpoints:\r\n        - endpoint:\r\n            address:\r\n              socket_address:\r\n                address: 127.0.0.1\r\n                port_value: 8080\r\n\r\n```\r\n\r\n</details>\r\n\r\n*Logs*:\r\n\r\n<details><summary>stdout</summary>\r\n\r\n```\r\n[2020-04-30 15:10:28.888][4435550][debug][upstream] [external/envoy/source/common/upstream/health_discovery_service.cc:187] New health check response message cluster_health_checks {\r\n  cluster_name: \"cluster-00000\"\r\n  health_checks {\r\n    timeout {\r\n      seconds: 1\r\n    }\r\n    interval {\r\n      seconds: 1\r\n    }\r\n    unhealthy_threshold {\r\n      value: 2\r\n    }\r\n    http_health_check {\r\n      host: \"localhost\"\r\n      path: \"/v1/agent/self\"\r\n    }\r\n  }\r\n  locality_endpoints {\r\n    locality {\r\n      region: \"us-west-1\"\r\n      zone: \"zone-a\"\r\n    }\r\n    endpoints {\r\n      address {\r\n        socket_address {\r\n          address: \"127.0.0.1\"\r\n          port_value: 8500\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\ninterval {\r\n  seconds: 5\r\n}\r\n\r\n[2020-04-30 15:10:28.888][4435550][debug][upstream] [external/envoy/source/common/upstream/health_discovery_service.cc:140] New health check response message cluster_health_checks {\r\n  cluster_name: \"cluster-00000\"\r\n  health_checks {\r\n    timeout {\r\n      seconds: 1\r\n    }\r\n    interval {\r\n      seconds: 1\r\n    }\r\n    unhealthy_threshold {\r\n      value: 2\r\n    }\r\n    http_health_check {\r\n      host: \"localhost\"\r\n      path: \"/v1/agent/self\"\r\n    }\r\n  }\r\n  locality_endpoints {\r\n    locality {\r\n      region: \"us-west-1\"\r\n      zone: \"zone-a\"\r\n    }\r\n    endpoints {\r\n      address {\r\n        socket_address {\r\n          address: \"127.0.0.1\"\r\n          port_value: 8500\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\ninterval {\r\n  seconds: 5\r\n}\r\n\r\n[2020-04-30 15:10:28.888][4435550][debug][upstream] [external/envoy/source/common/upstream/health_discovery_service.cc:169] New HdsCluster config name: \"cluster-00000\"\r\nconnect_timeout {\r\n  seconds: 1\r\n}\r\nper_connection_buffer_limit_bytes {\r\n  value: 32768\r\n}\r\nhealth_checks {\r\n  timeout {\r\n    seconds: 1\r\n  }\r\n  interval {\r\n    seconds: 1\r\n  }\r\n  unhealthy_threshold {\r\n    value: 2\r\n  }\r\n  http_health_check {\r\n    host: \"localhost\"\r\n    path: \"/v1/agent/self\"\r\n  }\r\n}\r\nload_assignment {\r\n  endpoints {\r\n    lb_endpoints {\r\n      endpoint {\r\n        address {\r\n          socket_address {\r\n            address: \"127.0.0.1\"\r\n            port_value: 8500\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n[2020-04-30 15:10:28.888][4435550][debug][upstream] [external/envoy/source/common/upstream/health_discovery_service.cc:228] Creating an HdsCluster\r\n[2020-04-30 15:10:28.889][4435550][debug][upstream] [external/envoy/source/common/upstream/upstream_impl.cc:275] transport socket match, socket default selected for host with address 127.0.0.1:8500\r\n[2020-04-30 15:10:28.896][4435550][critical][main] [external/envoy/source/exe/terminate_handler.cc:13] std::terminate called! (possible uncaught exception, see trace)\r\n[2020-04-30 15:10:28.896][4435550][critical][backtrace] [bazel-out/darwin-opt/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:91] Backtrace (use tools/stack_decode.py to get line numbers):\r\n[2020-04-30 15:10:28.896][4435550][critical][backtrace] [bazel-out/darwin-opt/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:92] Envoy version: 3504d40f752eb5c20bc2883053547717bcb92fd8/1.14.1/clean-getenvoy-902f20f-envoy/RELEASE/BoringSSL\r\n[2020-04-30 15:10:28.896][4435550][critical][backtrace] [bazel-out/darwin-opt/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:104] Caught Abort trap: 6, suspect faulting address 0x7fff70d6d2c2\r\n[2020-04-30 15:10:28.896][4435550][critical][backtrace] [bazel-out/darwin-opt/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:91] Backtrace (use tools/stack_decode.py to get line numbers):\r\n[2020-04-30 15:10:28.896][4435550][critical][backtrace] [bazel-out/darwin-opt/bin/external/envoy/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:92] Envoy version: 3504d40f752eb5c20bc2883053547717bcb92fd8/1.14.1/clean-getenvoy-902f20f-envoy/RELEASE/BoringSSL\r\nAsyncClient 0xefda000, stream_id_: 11052890408606538608\r\n&stream_info_:\r\n  StreamInfoImpl 0xefda1b0, protocol_: 1, response_code_: null, response_code_details_: via_upstream, health_check_request_: 0, route_name_:\r\nfish: 'envoy -c ./bootstrap.yaml -l de\u2026' terminated by signal SIGABRT (Abort)\r\n```\r\n\r\n</details>\r\n\r\n>**Note**: If there are privacy concerns, sanitize the data prior to\r\nsharing.\r\n\r\n*Call Stack*:\r\n\r\nI was unable to use `stack_decode.py` on MacOS and with a prebuilt binary after some investigation. I believe this should be easy to reproduce if necessary although @htuch [already speculated on where the bug exists](https://github.com/envoyproxy/envoy/issues/1310#issuecomment-621834512).",
  "closed_at": "2020-07-15T23:39:34Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/11014/comments",
  "created_at": "2020-04-30T14:21:32Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/11014/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/11014",
  "id": 610057603,
  "labels": [
    {
      "color": "fef2c0",
      "default": false,
      "description": "",
      "id": 1792227449,
      "name": "area/configuration",
      "node_id": "MDU6TGFiZWwxNzkyMjI3NDQ5",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/configuration"
    },
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/11014/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MTAwNTc2MDM=",
  "number": 11014,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "HDS: Incorrect HealthCheck from xDS config causes std:terminate",
  "updated_at": "2020-07-15T23:39:34Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/11014",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/120915?v=4",
    "events_url": "https://api.github.com/users/banks/events{/privacy}",
    "followers_url": "https://api.github.com/users/banks/followers",
    "following_url": "https://api.github.com/users/banks/following{/other_user}",
    "gists_url": "https://api.github.com/users/banks/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/banks",
    "id": 120915,
    "login": "banks",
    "node_id": "MDQ6VXNlcjEyMDkxNQ==",
    "organizations_url": "https://api.github.com/users/banks/orgs",
    "received_events_url": "https://api.github.com/users/banks/received_events",
    "repos_url": "https://api.github.com/users/banks/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/banks/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/banks/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/banks"
  }
}