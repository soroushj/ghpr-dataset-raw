{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "Calling addEncodedData from the encodeTrailers callback fails when encodeHeaders had previously returned StopIteration.\r\n\r\nA filter (e.g. the grpc-json transcoder) wants to turn a headers-only response into a response with a body. And StreamEncoderFilterCallbacks::addEncodedData allows that:\r\n\r\n     1) If a headers only response needs to be turned into a response with a body, this method can\r\n     be called to add body in the encodeHeaders() callback. Subsequent filters will receive\r\n     encodeHeaders(..., false) followed by encodeData(..., true). This works both in the direct\r\n     iteration as well as the continuation case.\r\n\r\nHowever it doesn't work when upstream sends a header frame and a trailer frame:\r\nThe filter returns StopIteration from `encodeHeaders`.\r\nIn `encodeTrailers`, it calls `addEncodedData`.\r\n`ConnectionManagerImpl::ActiveStream::addEncodedData` has a special branch for EncodeTrailers, which calls encodeData with the comment:\r\n\r\n    // In this case we need to inline dispatch the data to further filters. If those filters\r\n    // choose to buffer/stop iteration that's fine.\r\n\r\nNow there are two cases: \r\n1) if there is another filter, encodeData will call its encodeData callback, and then fail the `ASSERT(headers_continued_)` in `ActiveStreamFilterBase::commonHandleAfterDataCallback` - this filter never had its encodeHeaders called.\r\n2) if there is no filter to iterate, ActiveStream::encodeData will call `response_encoder_->encodeData` and write response body before writing any headers.\r\n\r\nFor HTTP/1.1 downstream it will assume chunked transfer-encoding and write something like:\r\n\r\n    4\r\n    body\r\n    HTTP/1.1 200 OK\r\n    other: headers\r\n\r\nHow to fix that:\r\n\r\nFor EncodeTrailers, the ActiveStream::addEncodedData should buffer data when filter stopped iteration.",
  "closed_at": "2019-10-01T21:20:48Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8402/comments",
  "created_at": "2019-09-26T21:55:10Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8402/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/8402",
  "id": 499134879,
  "labels": [
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8402/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-11-03T23:59:23Z",
    "closed_issues": 73,
    "created_at": "2019-07-03T16:32:43Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/11",
    "id": 4463348,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/11/labels",
    "node_id": "MDk6TWlsZXN0b25lNDQ2MzM0OA==",
    "number": 11,
    "open_issues": 0,
    "state": "closed",
    "title": "1.12.0",
    "updated_at": "2019-11-09T17:21:27Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/11"
  },
  "node_id": "MDU6SXNzdWU0OTkxMzQ4Nzk=",
  "number": 8402,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Filter can't add data from encodeTrailers",
  "updated_at": "2019-10-01T21:20:48Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/8402",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/3955351?v=4",
    "events_url": "https://api.github.com/users/ascheglov/events{/privacy}",
    "followers_url": "https://api.github.com/users/ascheglov/followers",
    "following_url": "https://api.github.com/users/ascheglov/following{/other_user}",
    "gists_url": "https://api.github.com/users/ascheglov/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ascheglov",
    "id": 3955351,
    "login": "ascheglov",
    "node_id": "MDQ6VXNlcjM5NTUzNTE=",
    "organizations_url": "https://api.github.com/users/ascheglov/orgs",
    "received_events_url": "https://api.github.com/users/ascheglov/received_events",
    "repos_url": "https://api.github.com/users/ascheglov/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ascheglov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ascheglov/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ascheglov"
  }
}