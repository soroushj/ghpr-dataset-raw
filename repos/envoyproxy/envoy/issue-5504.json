{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/892558?v=4",
    "events_url": "https://api.github.com/users/cgilmour/events{/privacy}",
    "followers_url": "https://api.github.com/users/cgilmour/followers",
    "following_url": "https://api.github.com/users/cgilmour/following{/other_user}",
    "gists_url": "https://api.github.com/users/cgilmour/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/cgilmour",
    "id": 892558,
    "login": "cgilmour",
    "node_id": "MDQ6VXNlcjg5MjU1OA==",
    "organizations_url": "https://api.github.com/users/cgilmour/orgs",
    "received_events_url": "https://api.github.com/users/cgilmour/received_events",
    "repos_url": "https://api.github.com/users/cgilmour/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/cgilmour/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cgilmour/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/cgilmour"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/892558?v=4",
      "events_url": "https://api.github.com/users/cgilmour/events{/privacy}",
      "followers_url": "https://api.github.com/users/cgilmour/followers",
      "following_url": "https://api.github.com/users/cgilmour/following{/other_user}",
      "gists_url": "https://api.github.com/users/cgilmour/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/cgilmour",
      "id": 892558,
      "login": "cgilmour",
      "node_id": "MDQ6VXNlcjg5MjU1OA==",
      "organizations_url": "https://api.github.com/users/cgilmour/orgs",
      "received_events_url": "https://api.github.com/users/cgilmour/received_events",
      "repos_url": "https://api.github.com/users/cgilmour/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/cgilmour/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cgilmour/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/cgilmour"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "*Description*:\r\nReported directly by a user, the datadog tracer is sampling HTTP requests that are for healthchecks.\r\nThis shouldn't occur when using the `envoy.health_check` http filter, because it sets sampling to [false](https://github.com/envoyproxy/envoy/blob/7c5badba34e8e4e5115b81776bafc7bcaa3a5834/source/extensions/filters/http/health_check/health_check.cc#L41-L45).\r\n\r\nThe datadog tracer ignores that call, because the headers for tracing have already been \"injected\" at an earlier step, and become immutable.\r\n\r\nCurrently, envoy creates the span for tracing, then immediately injects the [headers](https://github.com/envoyproxy/envoy/blob/7c5badba34e8e4e5115b81776bafc7bcaa3a5834/source/common/http/conn_manager_impl.cc#L748-L749).\r\nThis doesn't give an opportunity for extensions to change some of the tracing state before the injection occurs.\r\n\r\nA simple fix for this specific issue is to delay the injection until after the healthcheck filter has been applied.\r\n(Right after this call to [decodeHeaders](https://github.com/envoyproxy/envoy/blob/7c5badba34e8e4e5115b81776bafc7bcaa3a5834/source/common/http/conn_manager_impl.cc#L691).)\r\nHowever, ideally the injection would occur after all extension processing is done for a request. I'm not sure the precise point in the code for that.\r\n\r\nI can submit a PR for the simple fix.\r\n\r\n*Repro steps*:\r\nConfigure envoy with datadog tracing and the health_check filter. Send a request to the healthcheck endpoint. It is sampled.\r\n\r\n\r\n*Config*:\r\n```yaml\r\n          http_filters:\r\n          - name: envoy.health_check\r\n            config:\r\n              pass_through_mode: false\r\n              headers:\r\n              - name: \":path\"\r\n                exact_match: \"/healthcheck\"\r\n...\r\ntracing:\r\n  http:\r\n    name: envoy.tracers.datadog\r\n    config:\r\n      collector_cluster: datadog_agent\r\n      service_name: envoy-service1\r\n```\r\n",
  "closed_at": "2019-01-21T16:27:21Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 7,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5504/comments",
  "created_at": "2019-01-06T21:00:49Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5504/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/5504",
  "id": 396293975,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5504/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-04-05T18:08:09Z",
    "closed_issues": 57,
    "created_at": "2018-12-13T16:08:19Z",
    "creator": {
      "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
      "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
      "followers_url": "https://api.github.com/users/alyssawilk/followers",
      "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
      "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/alyssawilk",
      "id": 18220477,
      "login": "alyssawilk",
      "node_id": "MDQ6VXNlcjE4MjIwNDc3",
      "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
      "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
      "repos_url": "https://api.github.com/users/alyssawilk/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/alyssawilk"
    },
    "description": null,
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/9",
    "id": 3897143,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/9/labels",
    "node_id": "MDk6TWlsZXN0b25lMzg5NzE0Mw==",
    "number": 9,
    "open_issues": 0,
    "state": "closed",
    "title": "1.10.0",
    "updated_at": "2019-04-05T18:08:09Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/9"
  },
  "node_id": "MDU6SXNzdWUzOTYyOTM5NzU=",
  "number": 5504,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "datadog tracer samples heathchecks",
  "updated_at": "2019-01-21T16:27:21Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/5504",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/892558?v=4",
    "events_url": "https://api.github.com/users/cgilmour/events{/privacy}",
    "followers_url": "https://api.github.com/users/cgilmour/followers",
    "following_url": "https://api.github.com/users/cgilmour/following{/other_user}",
    "gists_url": "https://api.github.com/users/cgilmour/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/cgilmour",
    "id": 892558,
    "login": "cgilmour",
    "node_id": "MDQ6VXNlcjg5MjU1OA==",
    "organizations_url": "https://api.github.com/users/cgilmour/orgs",
    "received_events_url": "https://api.github.com/users/cgilmour/received_events",
    "repos_url": "https://api.github.com/users/cgilmour/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/cgilmour/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cgilmour/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/cgilmour"
  }
}