{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "Cluster update callbacks[[1]](https://github.com/envoyproxy/envoy/blob/80cea119e0910e9c41ba543017bfc3ee0cb0909f/include/envoy/upstream/cluster_manager.h#L39) (introduced in https://github.com/envoyproxy/envoy/pull/2814) cannot be used correctly if the callback is owned by an object destroyed *after* the Envoy server's instance `thread_local_`[[2]](https://github.com/envoyproxy/envoy/blob/80cea119e0910e9c41ba543017bfc3ee0cb0909f/source/server/server.h#L276) object.\r\n\r\nThe cluster manager's list of update callbacks is freed once during thread local storage cleanup in the `Envoy::Server::InstanceImpl::terminate()` function[[3]](https://github.com/envoyproxy/envoy/blob/80cea119e0910e9c41ba543017bfc3ee0cb0909f/source/server/server.cc#L545), in which the Envoy instance deletes thread local data bound to the main thread, and then freed a second time during the destructor of its holding class (in our case a `Stats` sink) when the `Envoy::Server::InstanceImpl` instance itself is being destroyed.\r\n\r\nDuring Envoy server termination, I am getting a use-after-free error when using ASAN. See sanitized ASAN stack-trace [here](https://github.com/envoyproxy/envoy/files/3942039/envoy_cluster_update_callbacks_asan.txt).\r\n \r\nIdeally there would be some mechanism to release the RAII handle object before thread local data is freed, or perhaps move the `thread_local_` object earlier in the list of fields belonging to the Envoy server instance.\r\n\r\nI'm curious if anyone else sees this an issue or if perhaps I'm misunderstanding how to use or store the `ClusterUpdateCallbacksHandle` object returned from the `ClusterManager`.\r\n",
  "closed_at": "2019-12-12T17:11:43Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9292/comments",
  "created_at": "2019-12-09T22:46:25Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9292/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/9292",
  "id": 535383422,
  "labels": [
    {
      "color": "0e8a16",
      "default": false,
      "description": "",
      "id": 1715345012,
      "name": "area/service discovery",
      "node_id": "MDU6TGFiZWwxNzE1MzQ1MDEy",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/service%20discovery"
    },
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9292/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MzUzODM0MjI=",
  "number": 9292,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Use-after-free problem with Cluster update callbacks",
  "updated_at": "2019-12-12T17:11:43Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/9292",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/435867?v=4",
    "events_url": "https://api.github.com/users/fcfort/events{/privacy}",
    "followers_url": "https://api.github.com/users/fcfort/followers",
    "following_url": "https://api.github.com/users/fcfort/following{/other_user}",
    "gists_url": "https://api.github.com/users/fcfort/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/fcfort",
    "id": 435867,
    "login": "fcfort",
    "node_id": "MDQ6VXNlcjQzNTg2Nw==",
    "organizations_url": "https://api.github.com/users/fcfort/orgs",
    "received_events_url": "https://api.github.com/users/fcfort/received_events",
    "repos_url": "https://api.github.com/users/fcfort/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/fcfort/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fcfort/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/fcfort"
  }
}