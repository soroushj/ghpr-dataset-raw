{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "*Title*: To resolve issues like #7923, or migrate RDS to config-provider-framework, we need to make sure RdsRouteConfigProvider \"Listener independent\".\r\n\r\n*Description*:\r\n> At present a RdsRouteConfigProviderImpl is bound to a listenerImpl, as it holds a FactoryContext references to the ListenerImpl. \r\n\r\nIf we want to save memory on dedup the copy of RDS route config providers (e.g., #7923 ), we would need to make sure the referenced FactoryContext outlives a ListenerImpl.\r\n\r\nBesides that, a RDS Subscription is held globally (weak_ptr) by the SingletonManager[RdsConfigProviderManager],which could be shared between Listeners, but the RDSSubscription also holds a reference to the factoryContext (in this case, ListenerImpl). If LDS updates a listener A, a live RDSSubscription owned by another listener B may crash Envoy when it tries to read from the destructed FactoryContext(ListenerImpl). VHDS implementation has a TODO that stated this concern:\r\nhttps://github.com/envoyproxy/envoy/blob/master/source/common/router/rds_impl.cc#L113\r\n\r\nProposal: \r\n\r\nOne way to make the factoryContext referenced by router/... is to pass a Server::CommonFactoryContext (e.g. the Server::Instance ) instead of a Server::FactoryContext (only implemented by ListenerImpl) into the router/...\r\n\r\nRight now, most of the APIs desired by objects under router/... are actually from CommonFactoryContext, except for several places that are kinda Listener specific: \r\n\r\n- initManager(), which is used to initiate a Subscription, but as SRDS(also VHDS, see issue#7617) comes into Envoy, we need something like the noop_init_manager in scoped_rds.cc \r\nWe could possibly pass the current ListernerImpl::initManager() along with the CommonFactoryContext(a.k.a the Server::Instance) to router/... As it's only required at Subscription Start time.\r\n- RouteEntryImplBase::per_filter_configs_ \r\n  This is the place where users could insert their own per-filter-per-route config data, a FactoryContext is passed in to translate the opaque protobuf::Struct into C++  RouteSpecificFilterConfig object. In the upstream codebase, this parameter is not used in any translation so far. But there is a risk some users' translation may fail if they depends on some per-listener data during the translation, if we decide to move forward by passing a CommonFactoryContext into router/... instead of the ListenerImpl itself.\r\n",
  "closed_at": "2019-11-25T04:37:54Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/in/1724?v=4",
    "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
    "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/apps/stale",
    "id": 26384082,
    "login": "stale[bot]",
    "node_id": "MDM6Qm90MjYzODQwODI=",
    "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
    "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
    "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
    "type": "Bot",
    "url": "https://api.github.com/users/stale%5Bbot%5D"
  },
  "comments": 8,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8303/comments",
  "created_at": "2019-09-20T02:22:38Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8303/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/8303",
  "id": 496108590,
  "labels": [
    {
      "color": "c5def5",
      "default": false,
      "description": "Needs design doc/proposal before implementation",
      "id": 620444894,
      "name": "design proposal",
      "node_id": "MDU6TGFiZWw2MjA0NDQ4OTQ=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/design%20proposal"
    },
    {
      "color": "bfd4f2",
      "default": false,
      "description": "stalebot believes this issue/PR has not been touched recently",
      "id": 867150379,
      "name": "stale",
      "node_id": "MDU6TGFiZWw4NjcxNTAzNzk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/stale"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8303/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0OTYxMDg1OTA=",
  "number": 8303,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "rds: make RouteConfigProvider shared among ListenerImpls, or move factory_context_ outside of Listener.",
  "updated_at": "2019-11-25T04:37:54Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/8303",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/3444556?v=4",
    "events_url": "https://api.github.com/users/stevenzzzz/events{/privacy}",
    "followers_url": "https://api.github.com/users/stevenzzzz/followers",
    "following_url": "https://api.github.com/users/stevenzzzz/following{/other_user}",
    "gists_url": "https://api.github.com/users/stevenzzzz/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/stevenzzzz",
    "id": 3444556,
    "login": "stevenzzzz",
    "node_id": "MDQ6VXNlcjM0NDQ1NTY=",
    "organizations_url": "https://api.github.com/users/stevenzzzz/orgs",
    "received_events_url": "https://api.github.com/users/stevenzzzz/received_events",
    "repos_url": "https://api.github.com/users/stevenzzzz/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/stevenzzzz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/stevenzzzz/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/stevenzzzz"
  }
}