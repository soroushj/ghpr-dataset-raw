{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "*Description*:\r\nGiven following envoy.yaml:\r\n```yaml\r\nstatic_resources:\r\n  clusters:\r\n  - name: google\r\n    type: STRICT_DNS\r\n    connect_timeout: 0.25s\r\n    load_assignment:\r\n      cluster_name: google\r\n      endpoints:\r\n      - lb_endpoints:\r\n        - endpoint:\r\n            address:\r\n              socket_address:\r\n                address: google.com.\r\n                port_value: 80\r\n```\r\n\r\n`envoy:v1.14.6` works fine, on `envoy:v.1.16.0` I see `DNS refresh rate reset for google.com., (failure) refresh rate 5000 ms` error in logs.\r\n\r\n*Repro steps*:\r\nRun:\r\n```\r\ndocker run -it --rm --name envoy --dns-search default.svc.cluster.local --dns-search svc.cluster.local --dns-search cluster.local --dns-opt ndots:5 -v $(pwd)/envoy.yaml:/etc/envoy/envoy.yaml envoyproxy/envoy:v1.14.5 --log-level trace --config-path /etc/envoy/envoy.yaml\r\n```\r\nyou'll see logs that DNS name for strict_dns clusters resolve fine:\r\n```\r\n[2020-10-15 10:09:35.386][1][debug][main] [source/server/server.cc:178] flushing stats\r\n[2020-10-15 10:09:35.590][1][trace][upstream] [source/common/upstream/strict_dns_cluster.cc:101] starting async DNS resolution for google.com.\r\n[2020-10-15 10:09:35.590][1][trace][upstream] [source/common/network/dns_impl.cc:196] Setting DNS resolution timer for 5000 milliseconds\r\n[2020-10-15 10:09:35.592][1][trace][upstream] [source/common/upstream/strict_dns_cluster.cc:109] async DNS resolution complete for google.com.\r\n[2020-10-15 10:09:35.592][1][debug][upstream] [source/common/upstream/upstream_impl.cc:275] transport socket match, socket default selected for host with address [2607:f8b0:400a:801::200e]:80\r\n[2020-10-15 10:09:35.592][1][debug][upstream] [source/common/upstream/strict_dns_cluster.cc:162] DNS refresh rate reset for google.com., refresh rate 5000 ms\r\n```\r\n\r\nNow run this on latest envoy:\r\n```\r\ndocker run -it --rm --name envoy --dns-search default.svc.cluster.local --dns-search svc.cluster.local --dns-search cluster.local --dns-opt ndots:5 -v $(pwd)/envoy.yaml:/etc/envoy/envoy.yaml envoyproxy/envoy:v1.16.0 --log-level trace --config-path /etc/envoy/envoy.yaml\r\n```\r\nyou'll see logs saying that DNS resolution fails:\r\n```\r\n[2020-10-15 11:23:25.832][7][debug][main] [source/server/server.cc:190] flushing stats\r\n[2020-10-15 11:23:25.833][7][trace][upstream] [source/common/upstream/strict_dns_cluster.cc:106] starting async DNS resolution for google.com.\r\n[2020-10-15 11:23:25.833][7][trace][upstream] [source/common/upstream/strict_dns_cluster.cc:114] async DNS resolution complete for google.com.\r\n[2020-10-15 11:23:25.833][7][debug][upstream] [source/common/upstream/strict_dns_cluster.cc:174] DNS refresh rate reset for google.com., (failure) refresh rate 5000 ms\r\n```\r\n\r\n*Possible root cause*:  \r\nPossible root cause of this issue is bug in `c-ares:v1.16.1`, fixed in https://github.com/c-ares/c-ares/commit/ba597817a51790a89020970da982283020312dbf (not released yet).\r\nI've confirmed that there's a regression between [c-ares #d7e070e7283f822b1d2787903cce3615536c5610](https://github.com/c-ares/c-ares/archive/d7e070e7283f822b1d2787903cce3615536c5610.tar.gz) used in envoy 1.14 and later versions of c-ares (used in evoy 1.15 and forward).\r\n\r\n\r\nI know this is undocumented feature, but how using FQDN with a trailing dot helps? When running envoy in k8s (especially as a service mesh data plane), it allows you save up to 75% of DNS traffic generated by STRICT_DNS clusters. If you specify cluster endpoint address of `google.com` envoy (via c-ares) will try to resolve `google.com.default.svc.cluster.local`, `google.com.svc.cluster.local`, `google.com.cluster.local` and finally `google.com`. When you use trailing dot (`google.com.`) envoy (via c-ares) will try to resolve just `google.com`.",
  "closed_at": "2020-10-21T23:51:39Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/10914751?v=4",
    "events_url": "https://api.github.com/users/htuch/events{/privacy}",
    "followers_url": "https://api.github.com/users/htuch/followers",
    "following_url": "https://api.github.com/users/htuch/following{/other_user}",
    "gists_url": "https://api.github.com/users/htuch/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/htuch",
    "id": 10914751,
    "login": "htuch",
    "node_id": "MDQ6VXNlcjEwOTE0NzUx",
    "organizations_url": "https://api.github.com/users/htuch/orgs",
    "received_events_url": "https://api.github.com/users/htuch/received_events",
    "repos_url": "https://api.github.com/users/htuch/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/htuch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/htuch/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/htuch"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/13587/comments",
  "created_at": "2020-10-15T12:33:28Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/13587/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/13587",
  "id": 722293737,
  "labels": [
    {
      "color": "6adda9",
      "default": false,
      "description": "",
      "id": 1827306478,
      "name": "area/dns",
      "node_id": "MDU6TGFiZWwxODI3MzA2NDc4",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/dns"
    },
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/13587/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU3MjIyOTM3Mzc=",
  "number": 13587,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Error when resolving STRICT_DNS cluster endpoint FQDN with trailing dot '.'",
  "updated_at": "2020-10-21T23:51:40Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/13587",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/26798897?v=4",
    "events_url": "https://api.github.com/users/lmarszal/events{/privacy}",
    "followers_url": "https://api.github.com/users/lmarszal/followers",
    "following_url": "https://api.github.com/users/lmarszal/following{/other_user}",
    "gists_url": "https://api.github.com/users/lmarszal/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lmarszal",
    "id": 26798897,
    "login": "lmarszal",
    "node_id": "MDQ6VXNlcjI2Nzk4ODk3",
    "organizations_url": "https://api.github.com/users/lmarszal/orgs",
    "received_events_url": "https://api.github.com/users/lmarszal/received_events",
    "repos_url": "https://api.github.com/users/lmarszal/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lmarszal/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lmarszal/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lmarszal"
  }
}