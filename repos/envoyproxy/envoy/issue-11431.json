{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "*Title*: *Aggregate cluster properties override those of the \"child\" clusters*\r\n\r\n*Description*:\r\nWe\u2019re using Envoy 1.13.0.1 with an aggregate cluster, and multiple \u201cchild\u201d clusters.\r\n\r\nOur aggregate cluster has a basic config, similar to the example given in the current docs [0].\r\n\r\n```\r\nname: aggregate_cluster\r\nconnect_timeout: 0.25s\r\nlb_policy: CLUSTER_PROVIDED\r\ncluster_type:\r\n  name: envoy.clusters.aggregate\r\n  typed_config:\r\n    \"@type\": type.googleapis.com/envoy.extensions.clusters.aggregate.v3.ClusterConfig\r\n    clusters:\r\n    - primary\r\n    - secondary\r\n    - tertiary\r\n```\r\n\r\nEach of our \u201cchild\u201d clusters (`primary`, `secondary`, `tertiary` in this example) is configured to use HTTP/2, by specifying the following, as per the cluster configuration docs [1]:\r\n\r\n```\r\n\"http2_protocol_options\": {\r\n  \"stream_error_on_invalid_http_messaging\": true\r\n},\r\n```\r\n\r\nWe\u2019ve used this cluster configuration in many other Envoy applications to great effect, so we were surprised to find that when used as part of an aggregate cluster, the connections were all using HTTP/1.1!  We verified this by not only looking at access logs for the Envoy upstream, but also by looking at the metrics for:\r\n- `envoy.cluster.upstream_cx_http1_total`\r\n- `envoy.cluster.upstream_cx_http2_total`\r\n\r\nIt appears that some of the configuration properties on the aggregate cluster override those in the \u201cchild\u201d clusters, even though the docs make no mention of this.  In this specific case, the child clusters were behaving as if the lack of `http2_protocol_options` on the aggregate cluster was overriding its own configuration.\r\n\r\nWe were able to add the `http2_protocol_options` configuration to the aggregate cluster, and see that our traffic did begin to use H/2.\r\n\r\nIn other words, we changed our aggregate cluster configuration to be:\r\n\r\n```\r\nname: aggregate_cluster\r\nconnect_timeout: 0.25s\r\nlb_policy: CLUSTER_PROVIDED\r\nhttp2_protocol_options: \r\n  stream_error_on_invalid_http_messaging: true\r\ncluster_type:\r\n  name: envoy.clusters.aggregate\r\n  typed_config:\r\n    \"@type\": type.googleapis.com/envoy.extensions.clusters.aggregate.v3.ClusterConfig\r\n    clusters:\r\n    - primary\r\n    - secondary\r\n    - tertiary\r\n```\r\n\r\nWhich caused our traffic to be sent via H/2 as expected.\r\n\r\nWe know empirically that not all of a cluster\u2019s top-level configuration properties are being overridden by the aggregate cluster in this manner, since we see that our configurations for things like:\r\n- `upstream_bind_config`\r\n- `transport_socket`\r\n- `health_checks`\r\n\r\nare being used by the child clusters as expected.\r\n\r\nThis seems like a bug to us, since the aggregate cluster docs specifically mention that it is intended to be used \u201c...for failover between clusters with different configuration\u201d.\r\n\r\nIf this is not a bug and is in fact the intended behavior of the aggregate cluster, I think the docs should spell out which cluster configuration properties are overridden/inherited with those of the aggregate cluster.\r\n\r\n*Relevant Links*:\r\n[0] https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/aggregate_cluster#example\r\n[1] https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/cluster.proto\r\n\r\n\r\nThanks!",
  "closed_at": "2020-06-22T15:44:02Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/2023366?v=4",
    "events_url": "https://api.github.com/users/snowp/events{/privacy}",
    "followers_url": "https://api.github.com/users/snowp/followers",
    "following_url": "https://api.github.com/users/snowp/following{/other_user}",
    "gists_url": "https://api.github.com/users/snowp/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/snowp",
    "id": 2023366,
    "login": "snowp",
    "node_id": "MDQ6VXNlcjIwMjMzNjY=",
    "organizations_url": "https://api.github.com/users/snowp/orgs",
    "received_events_url": "https://api.github.com/users/snowp/received_events",
    "repos_url": "https://api.github.com/users/snowp/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/snowp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/snowp/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/snowp"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/11431/comments",
  "created_at": "2020-06-03T20:34:44Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/11431/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/11431",
  "id": 630307863,
  "labels": [
    {
      "color": "d1216a",
      "default": false,
      "description": "",
      "id": 2124163806,
      "name": "area/aggregate_cluster",
      "node_id": "MDU6TGFiZWwyMTI0MTYzODA2",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/aggregate_cluster"
    },
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/11431/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MzAzMDc4NjM=",
  "number": 11431,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Aggregate cluster properties override those of the \"child\" clusters",
  "updated_at": "2020-06-22T15:44:02Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/11431",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/43550801?v=4",
    "events_url": "https://api.github.com/users/dcarney-stripe/events{/privacy}",
    "followers_url": "https://api.github.com/users/dcarney-stripe/followers",
    "following_url": "https://api.github.com/users/dcarney-stripe/following{/other_user}",
    "gists_url": "https://api.github.com/users/dcarney-stripe/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/dcarney-stripe",
    "id": 43550801,
    "login": "dcarney-stripe",
    "node_id": "MDQ6VXNlcjQzNTUwODAx",
    "organizations_url": "https://api.github.com/users/dcarney-stripe/orgs",
    "received_events_url": "https://api.github.com/users/dcarney-stripe/received_events",
    "repos_url": "https://api.github.com/users/dcarney-stripe/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/dcarney-stripe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dcarney-stripe/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/dcarney-stripe"
  }
}