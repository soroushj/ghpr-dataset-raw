{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
    "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
    "followers_url": "https://api.github.com/users/alyssawilk/followers",
    "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
    "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alyssawilk",
    "id": 18220477,
    "login": "alyssawilk",
    "node_id": "MDQ6VXNlcjE4MjIwNDc3",
    "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
    "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
    "repos_url": "https://api.github.com/users/alyssawilk/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alyssawilk"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
      "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
      "followers_url": "https://api.github.com/users/alyssawilk/followers",
      "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
      "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/alyssawilk",
      "id": 18220477,
      "login": "alyssawilk",
      "node_id": "MDQ6VXNlcjE4MjIwNDc3",
      "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
      "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
      "repos_url": "https://api.github.com/users/alyssawilk/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/alyssawilk"
    }
  ],
  "author_association": "NONE",
  "body": "\r\n**Title**: *listener/http-manager downstream_rq_4xx counter not incremented when envoy returns a 431 response after hitting a header size limit*\r\n\r\n**Description**:\r\nWhen rolling out v1.11.2 which includes the max 100 headers count limit we wanted to know if we were breaking any existing service (i.e. a service that expects requests with >100 headers) by looking at the `response_code_class` tag in the `listener.http.downstream_rq_xx` and `http.downstream_rq_xx` metrics. But we noticed these counters are not incremented when envoy returns a 431.\r\n\r\nIs this working as designed?\r\n\r\nWe did notice that `http.downstream_cx_protocol_error` gets incremented but that seems too generic to tell if the cause is headers size (to be fair, 4xx is also too generic, **is there a way to get specific status code tags as with the cluster metrics?**)\r\n\r\n**Repro steps**:\r\n\r\nTested with `v1.11.1` (max header kb exceeded) and v1.11.2 (both max headers count and kb exeeded)\r\n\r\n 1. Set  `max_request_headers_kb` to  `1` to easily trigger the 431s (see full envoy config below)\r\n\r\n 2. Perform a bunch of requests with a long header:\r\n\r\n```\r\n$ curl -I -H \"x-long-header: $(printf 'a%.0s' {1..1200})\" localhost:8080\r\nHTTP/1.1 431 Request Header Fields Too Large\r\ncontent-length: 0\r\nconnection: close\r\n```\r\n\r\n**Admin and Stats Output**:\r\n\r\nThese are the http manager and listener stats (after making 10  status 431 requests):\r\n\r\n```\r\nhttp.ingress_http.downstream_cx_active: 0\r\nhttp.ingress_http.downstream_cx_delayed_close_timeout: 0\r\nhttp.ingress_http.downstream_cx_destroy: 10\r\nhttp.ingress_http.downstream_cx_destroy_active_rq: 0\r\nhttp.ingress_http.downstream_cx_destroy_local: 0\r\nhttp.ingress_http.downstream_cx_destroy_local_active_rq: 0\r\nhttp.ingress_http.downstream_cx_destroy_remote: 10\r\nhttp.ingress_http.downstream_cx_destroy_remote_active_rq: 0\r\nhttp.ingress_http.downstream_cx_drain_close: 0\r\nhttp.ingress_http.downstream_cx_http1_active: 0\r\nhttp.ingress_http.downstream_cx_http1_total: 10\r\nhttp.ingress_http.downstream_cx_http2_active: 0\r\nhttp.ingress_http.downstream_cx_http2_total: 0\r\nhttp.ingress_http.downstream_cx_idle_timeout: 0\r\nhttp.ingress_http.downstream_cx_overload_disable_keepalive: 0\r\nhttp.ingress_http.downstream_cx_protocol_error: 10\r\nhttp.ingress_http.downstream_cx_rx_bytes_buffered: 0\r\nhttp.ingress_http.downstream_cx_rx_bytes_total: 12960\r\nhttp.ingress_http.downstream_cx_ssl_active: 0\r\nhttp.ingress_http.downstream_cx_ssl_total: 0\r\nhttp.ingress_http.downstream_cx_total: 10\r\nhttp.ingress_http.downstream_cx_tx_bytes_buffered: 0\r\nhttp.ingress_http.downstream_cx_tx_bytes_total: 860\r\nhttp.ingress_http.downstream_cx_upgrades_active: 0\r\nhttp.ingress_http.downstream_cx_upgrades_total: 0\r\nhttp.ingress_http.downstream_flow_control_paused_reading_total: 0\r\nhttp.ingress_http.downstream_flow_control_resumed_reading_total: 0\r\nhttp.ingress_http.downstream_rq_1xx: 0\r\nhttp.ingress_http.downstream_rq_2xx: 0\r\nhttp.ingress_http.downstream_rq_3xx: 0\r\nhttp.ingress_http.downstream_rq_4xx: 0\r\nhttp.ingress_http.downstream_rq_5xx: 0\r\nhttp.ingress_http.downstream_rq_active: 0\r\nhttp.ingress_http.downstream_rq_completed: 0\r\nhttp.ingress_http.downstream_rq_http1_total: 10\r\nhttp.ingress_http.downstream_rq_http2_total: 0\r\nhttp.ingress_http.downstream_rq_idle_timeout: 0\r\nhttp.ingress_http.downstream_rq_non_relative_path: 0\r\nhttp.ingress_http.downstream_rq_overload_close: 0\r\nhttp.ingress_http.downstream_rq_response_before_rq_complete: 0\r\nhttp.ingress_http.downstream_rq_rx_reset: 10\r\nhttp.ingress_http.downstream_rq_timeout: 0\r\nhttp.ingress_http.downstream_rq_too_large: 0\r\nhttp.ingress_http.downstream_rq_total: 10\r\nhttp.ingress_http.downstream_rq_tx_reset: 0\r\nhttp.ingress_http.downstream_rq_ws_on_non_ws_route: 0\r\nhttp.ingress_http.no_cluster: 0\r\nhttp.ingress_http.no_route: 0\r\nhttp.ingress_http.rq_direct_response: 0\r\nhttp.ingress_http.rq_redirect: 0\r\nhttp.ingress_http.rq_reset_after_downstream_response_started: 0\r\nhttp.ingress_http.rq_total: 0\r\nhttp.ingress_http.rs_too_large: 0\r\nhttp.ingress_http.tracing.client_enabled: 0\r\nhttp.ingress_http.tracing.health_check: 0\r\nhttp.ingress_http.tracing.not_traceable: 0\r\nhttp.ingress_http.tracing.random_sampling: 0\r\nhttp.ingress_http.tracing.service_forced: 0\r\nlistener.0.0.0.0_8080.downstream_cx_active: 0\r\nlistener.0.0.0.0_8080.downstream_cx_destroy: 10\r\nlistener.0.0.0.0_8080.downstream_cx_total: 10\r\nlistener.0.0.0.0_8080.downstream_pre_cx_active: 0\r\nlistener.0.0.0.0_8080.downstream_pre_cx_timeout: 0\r\nlistener.0.0.0.0_8080.http.ingress_http.downstream_rq_1xx: 0\r\nlistener.0.0.0.0_8080.http.ingress_http.downstream_rq_2xx: 0\r\nlistener.0.0.0.0_8080.http.ingress_http.downstream_rq_3xx: 0\r\nlistener.0.0.0.0_8080.http.ingress_http.downstream_rq_4xx: 0\r\nlistener.0.0.0.0_8080.http.ingress_http.downstream_rq_5xx: 0\r\nlistener.0.0.0.0_8080.http.ingress_http.downstream_rq_completed: 0\r\nlistener.0.0.0.0_8080.no_filter_chain_match: 0\r\n```\r\n\r\n**Config**:\r\n\r\n```\r\nadmin:\r\n  access_log_path: /tmp/admin_access.log\r\n  address:\r\n    socket_address:\r\n      protocol: TCP\r\n      address: 0.0.0.0\r\n      port_value: 8001\r\n\r\nstats_config:\r\n  use_all_default_tags: true\r\n\r\nstats_flush_interval: \"10s\"\r\n\r\nstatic_resources:\r\n  listeners:\r\n    - name: \"ingress_listener\"\r\n      address:\r\n        socket_address:\r\n          protocol: \"TCP\"\r\n          address: \"0.0.0.0\"\r\n          port_value: 8080\r\n      filter_chains:\r\n        - filters:\r\n            - name: \"envoy.http_connection_manager\"\r\n              config:\r\n                max_request_headers_kb: 1\r\n                stat_prefix: \"ingress_http\"\r\n                route_config:\r\n                  name: \"ingress_route\"\r\n                  virtual_hosts:\r\n                    - name: \"virtual_host_service\"\r\n                      domains:\r\n                        - \"*\"\r\n                      routes:\r\n                        - match:\r\n                            prefix: \"/\"\r\n                          route:\r\n                            cluster: \"service\"\r\n                http_filters:\r\n                  - name: \"envoy.router\"\r\n\r\n  clusters:\r\n    - name: \"service\"\r\n      connect_timeout: \"0.25s\"\r\n      type: \"LOGICAL_DNS\"\r\n      dns_lookup_family: \"V4_ONLY\"\r\n      load_assignment:\r\n        cluster_name: \"service\"\r\n        endpoints:\r\n          - lb_endpoints:\r\n              - endpoint:\r\n                  address:\r\n                    socket_address:\r\n                      address: \"127.0.0.1\"\r\n                      port_value: 8001\r\n```\r\n",
  "closed_at": "2020-06-25T15:31:36Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
    "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
    "followers_url": "https://api.github.com/users/alyssawilk/followers",
    "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
    "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alyssawilk",
    "id": 18220477,
    "login": "alyssawilk",
    "node_id": "MDQ6VXNlcjE4MjIwNDc3",
    "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
    "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
    "repos_url": "https://api.github.com/users/alyssawilk/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alyssawilk"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8545/comments",
  "created_at": "2019-10-09T06:07:57Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8545/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/8545",
  "id": 504436130,
  "labels": [
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8545/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-07-13T18:51:09Z",
    "closed_issues": 62,
    "created_at": "2020-03-10T00:01:47Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/14",
    "id": 5185398,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/14/labels",
    "node_id": "MDk6TWlsZXN0b25lNTE4NTM5OA==",
    "number": 14,
    "open_issues": 0,
    "state": "closed",
    "title": "1.15.0",
    "updated_at": "2020-09-30T23:30:38Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/14"
  },
  "node_id": "MDU6SXNzdWU1MDQ0MzYxMzA=",
  "number": 8545,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "listener/http-manager downstream_rq_4xx counter not incremented when envoy returns a 431 response after hitting a header size limit",
  "updated_at": "2020-06-25T15:31:36Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/8545",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/3171970?v=4",
    "events_url": "https://api.github.com/users/argos83/events{/privacy}",
    "followers_url": "https://api.github.com/users/argos83/followers",
    "following_url": "https://api.github.com/users/argos83/following{/other_user}",
    "gists_url": "https://api.github.com/users/argos83/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/argos83",
    "id": 3171970,
    "login": "argos83",
    "node_id": "MDQ6VXNlcjMxNzE5NzA=",
    "organizations_url": "https://api.github.com/users/argos83/orgs",
    "received_events_url": "https://api.github.com/users/argos83/received_events",
    "repos_url": "https://api.github.com/users/argos83/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/argos83/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/argos83/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/argos83"
  }
}