{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "The way Maglev currently implements weighting for any given host and locality is: `effective_weight = host_weight * locality_weight`. This is nice and simple, but it's inconsistent with how the other LBs implement locality weighting. A simple example:\r\n\r\n* Locality _A_: locality_weight = 1\r\n     * contains 100 hosts, each with host_weight = 1\r\n* Locality _B_: locality_weight = 1\r\n    * contains 50 hosts, each with host_weight = 1\r\n\r\nThe way Maglev figures it, the effective weight for all hosts is 1: they all get equal traffic. But the way all other LBs figure it, and what users expect (per [documentation](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/load_balancing/locality_weight), assuming healthy hosts) is that _A_ should be getting the same traffic as _B_, no matter how many hosts happen to be in each locality: consequently, each of the 50 hosts in _B_ should be taking twice as much traffic as each of the 100 hosts in _A_.\r\n\r\nJudging by https://github.com/envoyproxy/envoy/issues/2725#issuecomment-370586299, we meant to do this at some point, but didn't.\r\n\r\nThe correct math is to sum the locality weights, and sum the host weights within each locality, to get the right proportions. For example, given:\r\n\r\n* Locality _A_: locality_weight = 2\r\n    * Host _a_: host_weight = 3\r\n    * Host _b_: host_weight = 5\r\n* Locality _B_: locality_weight = 7\r\n    * Host _c_: host_weight = 11\r\n    * Host _d_: host_weight = 13\r\n\r\nThe sum of locality weights = 9, the sum of host weights in _A_ is 8, and the sum of host weights in _B_ is 24, which gives us effective weights:\r\n\r\n* Host _a_: (2/9) * (3/8) ~= .083\r\n* Host _b_: (2/9) * (5/8) ~= .139\r\n* Host _c_: (7/9) * (11/24) ~= .356\r\n* Host _d_: (7/9) * (13/24) ~= .421",
  "closed_at": "2019-02-27T05:47:14Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/10914751?v=4",
    "events_url": "https://api.github.com/users/htuch/events{/privacy}",
    "followers_url": "https://api.github.com/users/htuch/followers",
    "following_url": "https://api.github.com/users/htuch/following{/other_user}",
    "gists_url": "https://api.github.com/users/htuch/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/htuch",
    "id": 10914751,
    "login": "htuch",
    "node_id": "MDQ6VXNlcjEwOTE0NzUx",
    "organizations_url": "https://api.github.com/users/htuch/orgs",
    "received_events_url": "https://api.github.com/users/htuch/received_events",
    "repos_url": "https://api.github.com/users/htuch/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/htuch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/htuch/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/htuch"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5982/comments",
  "created_at": "2019-02-15T18:35:13Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5982/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/5982",
  "id": 410893199,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/5982/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-04-05T18:08:09Z",
    "closed_issues": 57,
    "created_at": "2018-12-13T16:08:19Z",
    "creator": {
      "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
      "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
      "followers_url": "https://api.github.com/users/alyssawilk/followers",
      "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
      "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/alyssawilk",
      "id": 18220477,
      "login": "alyssawilk",
      "node_id": "MDQ6VXNlcjE4MjIwNDc3",
      "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
      "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
      "repos_url": "https://api.github.com/users/alyssawilk/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/alyssawilk"
    },
    "description": null,
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/9",
    "id": 3897143,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/9/labels",
    "node_id": "MDk6TWlsZXN0b25lMzg5NzE0Mw==",
    "number": 9,
    "open_issues": 0,
    "state": "closed",
    "title": "1.10.0",
    "updated_at": "2019-04-05T18:08:09Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/9"
  },
  "node_id": "MDU6SXNzdWU0MTA4OTMxOTk=",
  "number": 5982,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Locality weighting in Maglev inconsistent with other LBs",
  "updated_at": "2019-02-27T05:47:14Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/5982",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/921312?v=4",
    "events_url": "https://api.github.com/users/mergeconflict/events{/privacy}",
    "followers_url": "https://api.github.com/users/mergeconflict/followers",
    "following_url": "https://api.github.com/users/mergeconflict/following{/other_user}",
    "gists_url": "https://api.github.com/users/mergeconflict/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mergeconflict",
    "id": 921312,
    "login": "mergeconflict",
    "node_id": "MDQ6VXNlcjkyMTMxMg==",
    "organizations_url": "https://api.github.com/users/mergeconflict/orgs",
    "received_events_url": "https://api.github.com/users/mergeconflict/received_events",
    "repos_url": "https://api.github.com/users/mergeconflict/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mergeconflict/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mergeconflict/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mergeconflict"
  }
}