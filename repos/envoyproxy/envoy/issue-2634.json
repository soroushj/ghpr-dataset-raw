{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "*Title*: *DNS lookup AUTO settings doesn't fallback to V4 when a single CNAME entry is returned*\r\n\r\n*Description*:\r\nI am just getting started with envoy, so I might be wrong here and missing something. \r\n\r\nWhen working with a cluster that has a host address with a single CNAME entry returned for IPv6 lookups, envoy will not fallback to do a lookup using IPv4. From looking at the code at dns_impl.cc it looks like envoy assumes that if a success code (ARES_SUCCESS) is returned from getHostByName then it is assumed that an ip address was returned. This is not necessarily the case. A DNS request may contain only a CNAME entry with no IP. For example this happens to me with s3.amazonaws.com. Setting V4_ONLY solves the problem. Here is the dig output for IPv6 and IPv4:\r\n\r\n```\r\n$ dig s3.amazonaws.com AAAA\r\n\r\n; <<>> DiG 9.10.3-P4-Ubuntu <<>> s3.amazonaws.com AAAA\r\n;; global options: +cmd\r\n;; Got answer:\r\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 34567\r\n;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1\r\n\r\n;; OPT PSEUDOSECTION:\r\n; EDNS: version: 0, flags:; MBZ: 0005 , udp: 4096\r\n;; QUESTION SECTION:\r\n;s3.amazonaws.com.              IN      AAAA\r\n\r\n;; ANSWER SECTION:\r\ns3.amazonaws.com.       5       IN      CNAME   s3-1.amazonaws.com.\r\n\r\n;; AUTHORITY SECTION:\r\ns3-1.amazonaws.com.     5       IN      SOA     ns-1726.awsdns-23.co.uk. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 86\r\n```\r\n*Repro steps*:\r\nUse following envoy.yaml file:\r\n```yaml\r\nadmin:\r\n  access_log_path: \"admin_access.log\"\r\n  address:\r\n    socket_address:\r\n      address: 0.0.0.0\r\n      port_value: 9901\r\nstatic_resources:\r\n  listeners:\r\n  - address:\r\n      socket_address:\r\n        address: 0.0.0.0\r\n        port_value: 10000\r\n    filter_chains:\r\n    - filters:\r\n      - name: envoy.http_connection_manager\r\n        config:\r\n          codec_type: auto          \r\n          idle_timeout: 300s\r\n          access_log:\r\n          - name: envoy.file_access_log\r\n            config:\r\n              path: \"egress_http.log\"\r\n          stat_prefix: egress_http\r\n          http_protocol_options: \r\n            allow_absolute_url: true\r\n          route_config:\r\n            name: local_route\r\n            virtual_hosts:\r\n            - name: local_service\r\n              domains:\r\n              - \"*\"\r\n              routes:\r\n              - match:\r\n                  prefix: \"/\"\r\n                route:\r\n                  cluster: service_s3\r\n          http_filters: \r\n            - name: envoy.router\r\n              config: {}          \r\n  clusters:\r\n  - name: service_s3\r\n    type: logical_dns\r\n    lb_policy: round_robin                                                                                                                                                \r\n    connect_timeout: 1s\r\n    http_protocol_options: {}    \r\n    # dns_lookup_family: V4_ONLY    \r\n    hosts:\r\n    - socket_address:\r\n        address: s3.amazonaws.com      \r\n        port_value: 443\r\n    tls_context: \r\n      sni: \"s3.amazonaws.com\"\r\n    \r\n```\r\nRun envoy and then use curl to test out a simple request from s3:\r\n```\r\ncurl -v --proxy http://localhost:10000 http://s3.amazonaws.com/my-test-bucket22/\r\n*   Trying ::1...\r\n* connect to ::1 port 10000 failed: Connection refused\r\n*   Trying 127.0.0.1...\r\n* Connected to localhost (127.0.0.1) port 10000 (#0)\r\n> GET http://s3.amazonaws.com/my-test-bucket22/ HTTP/1.1\r\n> Host: s3.amazonaws.com\r\n> User-Agent: curl/7.47.0\r\n> Accept: */*\r\n> Proxy-Connection: Keep-Alive\r\n>\r\n< HTTP/1.1 503 Service Unavailable\r\n< content-length: 19\r\n< content-type: text/plain\r\n< date: Fri, 16 Feb 2018 15:41:24 GMT\r\n< server: envoy\r\n<\r\n* Connection #0 to host localhost left intact\r\nno healthy upstream\r\n```\r\n*Work around*: un-comment the line: `dns_lookup_family: V4_ONLY` in the yaml file. Then curl will succeed:\r\n```\r\n curl -v --proxy http://localhost:10000 http://s3.amazonaws.com/my-test-bucket22/\r\n*   Trying ::1...\r\n* connect to ::1 port 10000 failed: Connection refused\r\n*   Trying 127.0.0.1...\r\n* Connected to localhost (127.0.0.1) port 10000 (#0)\r\n> GET http://s3.amazonaws.com/my-test-bucket22/ HTTP/1.1\r\n> Host: s3.amazonaws.com\r\n> User-Agent: curl/7.47.0\r\n> Accept: */*\r\n> Proxy-Connection: Keep-Alive\r\n>\r\n< HTTP/1.1 200 OK\r\n< x-amz-id-2: fnwlOvun/jf7YAeI7eMlYm50XlhMoeXzeYu3tfCXY1SbZGvFChRrD+zo1vDFS3s0eoLqhyl9a64=\r\n< x-amz-request-id: 302CF4548DD2CF9A\r\n< date: Fri, 16 Feb 2018 15:46:58 GMT\r\n< x-amz-bucket-region: us-east-1\r\n< content-type: application/xml\r\n< server: envoy\r\n< x-envoy-upstream-service-time: 184\r\n< transfer-encoding: chunked\r\n<\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n* Connection #0 to host localhost left intact\r\n<ListBucketResult xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\"><Name>my-test-bucket22</Name><Prefix></Prefix><Marker></Marker><MaxKeys>1000</MaxKeys><IsTruncated>false</IsTruncated><Contents><Key>test.txt</Key><LastModified>2018-02-16T15:23:08.000Z</LastModified><ETag>&quot;0b26e313ed4a7ca6904b0e9369e5b957&quot;</ETag><Size>19</Size><StorageClass>STANDARD</StorageClass></Contents></ListBucketResult>\r\n```\r\n\r\nWould be happy to submit a PR to fix this. Just want to be sure I am not missing something basic before moving forward.\r\n\r\n\r\n",
  "closed_at": "2018-03-05T16:51:30Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
    "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
    "followers_url": "https://api.github.com/users/alyssawilk/followers",
    "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
    "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alyssawilk",
    "id": 18220477,
    "login": "alyssawilk",
    "node_id": "MDQ6VXNlcjE4MjIwNDc3",
    "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
    "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
    "repos_url": "https://api.github.com/users/alyssawilk/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alyssawilk"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/2634/comments",
  "created_at": "2018-02-16T15:55:59Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/2634/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/2634",
  "id": 297831713,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/2634/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyOTc4MzE3MTM=",
  "number": 2634,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "DNS lookup AUTO settings doesn't fallback to V4 when a single CNAME entry is returned",
  "updated_at": "2018-03-05T16:51:30Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/2634",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1395797?v=4",
    "events_url": "https://api.github.com/users/glicht/events{/privacy}",
    "followers_url": "https://api.github.com/users/glicht/followers",
    "following_url": "https://api.github.com/users/glicht/following{/other_user}",
    "gists_url": "https://api.github.com/users/glicht/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/glicht",
    "id": 1395797,
    "login": "glicht",
    "node_id": "MDQ6VXNlcjEzOTU3OTc=",
    "organizations_url": "https://api.github.com/users/glicht/orgs",
    "received_events_url": "https://api.github.com/users/glicht/received_events",
    "repos_url": "https://api.github.com/users/glicht/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/glicht/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/glicht/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/glicht"
  }
}