{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "The grpc-json-transcoder filter does not handle errors from **streaming** backends correctly. I opened this issue to document the current and proposed downstream responses.\r\n\r\nNote that #8009 introduced a new `convert_grpc_status` flag to deduce the HTTP response code and body from the gRPC backend error. This flag introduces another edge case (below).\r\n\r\nI think the logic for unary responses is OK. I've only seen these issues with streaming backends.\r\n\r\ncc @qiwzhang \r\ncc @ascheglov \r\n\r\n## Streaming Error with flag set\r\n\r\nConfiguration: The backend returns a gRPC error via a trailer-only response. The filter is configured with `convert_grpc_status=true`.\r\n\r\n#### Current Behavior\r\n\r\nThe filter returns a HTTP 200 OK. The grpc status flag is set in one of the response headers. Assuming that #8312 will be merged in, the response will be `[]` with content-type `application/json`.\r\n\r\n#### Proposed Behavior\r\n\r\nThe filter should return a response that matches the unary case with `convert_grpc_status` set:\r\n- The HTTP code should match the gRPC status code.\r\n- The response body should be a JSON with the error message.\r\n\r\n## Streaming Error without flag\r\n\r\nConfiguration: The backend returns a gRPC error via a trailer-only response. The filter is configured without `convert_grpc_status` (default behavior).\r\n\r\n#### Current Behavior\r\n\r\nSame as above: The filter returns a HTTP 200 OK. The grpc status flag is set in one of the response headers. Assuming that #8312 will be merged in, the response will be `[]` with content-type `application/json`.\r\n\r\n#### Proposed Behavior\r\n\r\nThe filter should return a response that exposes the error:\r\n- The HTTP code should match the gRPC status code.\r\n- The body should be completely empty (\"\"), not an empty JSON array\r\n- Content type should not be set, or it shouldn't matter what it is set to\r\n\r\n## Other Notes\r\n\r\nI would prefer to get #8312 merged in first to fix the content type issue. Please advise on how to handle this, as it may be a breaking change (?)",
  "closed_at": "2019-10-03T23:11:55Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1016047?v=4",
    "events_url": "https://api.github.com/users/lizan/events{/privacy}",
    "followers_url": "https://api.github.com/users/lizan/followers",
    "following_url": "https://api.github.com/users/lizan/following{/other_user}",
    "gists_url": "https://api.github.com/users/lizan/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lizan",
    "id": 1016047,
    "login": "lizan",
    "node_id": "MDQ6VXNlcjEwMTYwNDc=",
    "organizations_url": "https://api.github.com/users/lizan/orgs",
    "received_events_url": "https://api.github.com/users/lizan/received_events",
    "repos_url": "https://api.github.com/users/lizan/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lizan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lizan/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lizan"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8315/comments",
  "created_at": "2019-09-21T01:15:25Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8315/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/8315",
  "id": 496597052,
  "labels": [
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/8315/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-11-03T23:59:23Z",
    "closed_issues": 73,
    "created_at": "2019-07-03T16:32:43Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/11",
    "id": 4463348,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/11/labels",
    "node_id": "MDk6TWlsZXN0b25lNDQ2MzM0OA==",
    "number": 11,
    "open_issues": 0,
    "state": "closed",
    "title": "1.12.0",
    "updated_at": "2019-11-09T17:21:27Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/11"
  },
  "node_id": "MDU6SXNzdWU0OTY1OTcwNTI=",
  "number": 8315,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "grpc-json: Handle streaming backend error cases correctly",
  "updated_at": "2019-10-03T23:11:55Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/8315",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/11142171?v=4",
    "events_url": "https://api.github.com/users/nareddyt/events{/privacy}",
    "followers_url": "https://api.github.com/users/nareddyt/followers",
    "following_url": "https://api.github.com/users/nareddyt/following{/other_user}",
    "gists_url": "https://api.github.com/users/nareddyt/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/nareddyt",
    "id": 11142171,
    "login": "nareddyt",
    "node_id": "MDQ6VXNlcjExMTQyMTcx",
    "organizations_url": "https://api.github.com/users/nareddyt/orgs",
    "received_events_url": "https://api.github.com/users/nareddyt/received_events",
    "repos_url": "https://api.github.com/users/nareddyt/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/nareddyt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nareddyt/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/nareddyt"
  }
}