{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "*Title*: *Improve RBAC filter to support custom attributes*\r\n\r\n*Description*:\r\nThe RBAC filter is added in #3455. We want to use it to enforce service access control in Istio. The current RBAC filter doesn't support checking custom attributes of a request or principal which is a key feature we must support in Istio.\r\n\r\nFor example, a user could create a RBAC policy that only allows a service with label: {version: \"v1\", app: \"productpage\"} to access the database service. The label could be specified to any services in the mesh and will be collected and passed to envoy by Istio (either by a Istio data structure encoded into X-ISTIO-ATTRIBUTES header or mixer filter config).\r\n\r\nTo solve this problem we want to improve the RBAC filter to support checking custom attributes. We want to make the following changes to RBAC filter:\r\n1. Change the [Permission](https://github.com/envoyproxy/envoy/blob/c15019e79c832d9f0a09468affaadabc4be3e115/api/envoy/config/rbac/v2alpha/rbac.proto#L86) and [Principal](https://github.com/envoyproxy/envoy/blob/c15019e79c832d9f0a09468affaadabc4be3e115/api/envoy/config/rbac/v2alpha/rbac.proto#L118) to include another field called Metadata (let's call this config.Metadata as it's set in the filter config)\r\n2. Change the RBAC filter to check the config.Metadata against the [dynamicMetadata()](https://github.com/envoyproxy/envoy/blob/d5947b6a5e05ba2b5f335f6024629dcd57500261/include/envoy/request_info/request_info.h#L282), it works much the same way as other [matchers](https://github.com/envoyproxy/envoy/blob/d5947b6a5e05ba2b5f335f6024629dcd57500261/source/extensions/filters/common/rbac/matchers.h#L24) in RBAC filter, the only difference is that the source of truth is from the dynamicMetadata().\r\n(Note: In Istio, we will have different filter to populate necessary attributes by calling [setDynamicMetadata()](https://github.com/envoyproxy/envoy/blob/d5947b6a5e05ba2b5f335f6024629dcd57500261/include/envoy/request_info/request_info.h#L290))\r\n\r\nThe poc change is [here](https://github.com/envoyproxy/envoy/compare/master...yangminzhu:demo_rbac_attr).\r\n\r\n@mattklein123, @rodaine, please let me know what you think about the change, I want to make sure we're going in the right direction before sending out the PR.\r\n\r\nSpecifically, we have some questions about this approach:\r\n1. Is it ok to use the RequestInfo.dynamicMetadata for this purpose? \r\n\r\n2. When adding the Metadata to Permission and Principal in RBAC proto, we have 2 options, either way works for our needs but do you have any suggestions and preferences?\r\n    -  Make it more generic by introducing a MetadataMatcher just like the [HeaderMatcher](https://github.com/envoyproxy/envoy/blob/7f800115ba2b8d7a053872f1f852d4ba5996ae4d/api/envoy/api/v2/route/route.proto#L891).\r\n    -  Simply embed it in the RBAC proto (This is the way we do in the poc change)\r\n\r\n\r\ncc @lizan @liminw @qiwzhang @diemtvu @quanjielin ",
  "closed_at": "2018-06-27T20:43:42Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/3624/comments",
  "created_at": "2018-06-13T19:23:36Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/3624/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/3624",
  "id": 332130056,
  "labels": [
    {
      "color": "84b6eb",
      "default": true,
      "description": "Feature requests. Not bugs or questions.",
      "id": 421403909,
      "name": "enhancement",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDk=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/enhancement"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/3624/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMzIxMzAwNTY=",
  "number": 3624,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Improve RBAC filter to support custom attributes",
  "updated_at": "2018-06-27T20:43:42Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/3624",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/2189160?v=4",
    "events_url": "https://api.github.com/users/yangminzhu/events{/privacy}",
    "followers_url": "https://api.github.com/users/yangminzhu/followers",
    "following_url": "https://api.github.com/users/yangminzhu/following{/other_user}",
    "gists_url": "https://api.github.com/users/yangminzhu/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/yangminzhu",
    "id": 2189160,
    "login": "yangminzhu",
    "node_id": "MDQ6VXNlcjIxODkxNjA=",
    "organizations_url": "https://api.github.com/users/yangminzhu/orgs",
    "received_events_url": "https://api.github.com/users/yangminzhu/received_events",
    "repos_url": "https://api.github.com/users/yangminzhu/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/yangminzhu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yangminzhu/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/yangminzhu"
  }
}