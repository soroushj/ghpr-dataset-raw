{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "*Title*: Enabling ext_authz and setting `max_request_body` enables buffering globally, even where exluded\r\n\r\n*Description*:\r\nUsing `max_request_bytes` with the `envoy.ext_authz` filter enables buffering.  Even where the filter is explicitly disabled, buffering is enabled and `max_request_body` appears to be respected.\r\n\r\n*Relevant Links*:\r\n\r\nThis seems like it could be related:\r\n* https://github.com/envoyproxy/envoy/issues/5513\r\n\r\n*Repro steps*:\r\nPUTs to the `/encrypted_storate` route (see config below) with payloads exceeding `max_request_body` response with \"413 (Payload Too Large)\".  \r\n\r\n*Config*:\r\nCalls to the `/encrypted_storage` route have `max_request_body` applied.\r\n```\r\nstatic_resources:\r\n  listeners:\r\n    - address:\r\n        socket_address:\r\n          address: 0.0.0.0\r\n          port_value: 80\r\n      filter_chains:\r\n        - filters:\r\n            - name: envoy.http_connection_manager\r\n              config:\r\n                codec_type: auto\r\n                stat_prefix: ingress_http\r\n                route_config:\r\n                  virtual_hosts:\r\n                    - name: backend\r\n                      domains:\r\n                        - \"*\"\r\n                      routes:\r\n                        - match:\r\n                            prefix: \"/\"\r\n                          redirect:\r\n                            https_redirect: true\r\n                http_filters:\r\n                  - name: envoy.router\r\n                    config: {}\r\n    - address:\r\n        socket_address:\r\n          address: 0.0.0.0\r\n          port_value: 443\r\n      filter_chains:\r\n        - filters:\r\n            - name: envoy.http_connection_manager\r\n              typed_config:\r\n                \"@type\": type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager\r\n                codec_type: auto\r\n                stat_prefix: ingress_http\r\n                access_log:\r\n                  - name: envoy.file_access_log\r\n                    config:\r\n                      path: \"/dev/stdout\"\r\n                route_config:\r\n                  name: local_route\r\n                  virtual_hosts:\r\n                    - name: backend\r\n                      domains:\r\n                        - \"*\"\r\n                      routes:\r\n                        - match:\r\n                            prefix: \"/accounts/\"\r\n                          route:\r\n                            cluster: accounts\r\n                            prefix_rewrite: \"/\"\r\n\r\n                        - match:\r\n                            prefix: \"/encrypted-storage/\"\r\n                          route:\r\n                            cluster: encrypted-storage\r\n                            prefix_rewrite: \"/\"\r\n                            host_rewrite: REDACTED\r\n                          per_filter_config:\r\n                            envoy.ext_authz:\r\n                              disabled: true\r\n                        - match:\r\n                            prefix: \"/encrypted-storage/\"\r\n                          route:\r\n                            cluster: encrypted-storage\r\n                            prefix_rewrite: \"/\"\r\n                            host_rewrite: REDACTED\r\n...[snip]...\r\n                http_filters:\r\n                  - name: envoy.ext_authz\r\n                    config:\r\n                      http_service:\r\n                        server_uri:\r\n                          uri: REDACTED:443\r\n                          cluster: auth\r\n                          timeout: 5s\r\n                        authorization_request:\r\n                          allowed_headers:\r\n                            patterns:\r\n                            - exact: Content-Type\r\n                            - exact: auth\r\n                            - prefix: x-envoy\r\n                            - prefix: x-virtru\r\n                            - prefix: :method\r\n                            - prefix: :path\r\n                        path_prefix: /validate\r\n                        authorization_response:\r\n                          allowed_upstream_headers:\r\n                            patterns:\r\n                            - exact: X-Virtru-User\r\n                            - prefix: x-success\r\n                      with_request_body:\r\n                        max_request_bytes: 100000\r\n                        allow_partial_message: false\r\n                      status_on_error:\r\n                        code: 503\r\n                  - name: envoy.health_check\r\n                    typed_config:\r\n                      \"@type\": type.googleapis.com/envoy.config.filter.http.health_check.v2.HealthCheck\r\n                      pass_through_mode: false\r\n                      headers:\r\n                        - exact_match: /haproxy_status\r\n                          name: :path\r\n                  - name: envoy.router\r\n                    typed_config: {}\r\n          tls_context:\r\n            common_tls_context:\r\n              tls_params:\r\n                tls_minimum_protocol_version: TLSv1_2\r\n              tls_certificates:\r\n                - certificate_chain:\r\n                    filename: /etc/envoy/ssl/ca-intermediary.pem\r\n                  private_key:\r\n                    filename: /etc/envoy/ssl/private.pem\r\n\r\nclusters:\r\n\r\n    - name: accounts\r\n      connect_timeout: 30s\r\n      type: strict_dns\r\n      # Comment out the following line to test on v6 networks\r\n      dns_lookup_family: V4_ONLY\r\n      dns_refresh_rate: 60s\r\n      lb_policy: ROUND_ROBIN\r\n      load_assignment:\r\n        cluster_name: accounts\r\n        endpoints:\r\n          - lb_endpoints:\r\n              - endpoint:\r\n                  address:\r\n                    socket_address:\r\n                     address: REDACTED\r\n                     port_value: 443\r\n      tls_context:\r\n        sni: REDACTED\r\n\r\n    - name: encrypted-storage\r\n      connect_timeout: 30s\r\n      type: strict_dns\r\n      # Comment out the following line to test on v6 networks\r\n      dns_lookup_family: V4_ONLY\r\n      dns_refresh_rate: 60s\r\n      lb_policy: ROUND_ROBIN\r\n      load_assignment:\r\n        cluster_name: encrypted-storage\r\n        endpoints:\r\n          - lb_endpoints:\r\n              - endpoint:\r\n                  address:\r\n                    socket_address:\r\n                     address: REDACTED\r\n                     port_value: 443\r\n      tls_context:\r\n        sni: REDACTED\r\n        common_tls_context:\r\n          validation_context:\r\n            trusted_ca:\r\n              filename: /etc/ssl/certs/ca-certificates.crt\r\n```\r\n",
  "closed_at": "2020-03-23T18:38:31Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/7404/comments",
  "created_at": "2019-06-26T20:41:29Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/7404/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/7404",
  "id": 461171556,
  "labels": [
    {
      "color": "006b75",
      "default": false,
      "description": "",
      "id": 1807008039,
      "name": "area/ext_authz",
      "node_id": "MDU6TGFiZWwxODA3MDA4MDM5",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/ext_authz"
    },
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/7404/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NjExNzE1NTY=",
  "number": 7404,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Enabling ext_authz and setting max_request_body enables buffering globally, even where exluded",
  "updated_at": "2020-03-23T18:38:31Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/7404",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/47113451?v=4",
    "events_url": "https://api.github.com/users/virtru-tdewitt/events{/privacy}",
    "followers_url": "https://api.github.com/users/virtru-tdewitt/followers",
    "following_url": "https://api.github.com/users/virtru-tdewitt/following{/other_user}",
    "gists_url": "https://api.github.com/users/virtru-tdewitt/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/virtru-tdewitt",
    "id": 47113451,
    "login": "virtru-tdewitt",
    "node_id": "MDQ6VXNlcjQ3MTEzNDUx",
    "organizations_url": "https://api.github.com/users/virtru-tdewitt/orgs",
    "received_events_url": "https://api.github.com/users/virtru-tdewitt/received_events",
    "repos_url": "https://api.github.com/users/virtru-tdewitt/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/virtru-tdewitt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/virtru-tdewitt/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/virtru-tdewitt"
  }
}