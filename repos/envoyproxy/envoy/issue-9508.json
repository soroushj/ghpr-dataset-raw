{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "*Description*:\r\nThe loop to clear the ConnectionImpl's readDisable flag in ClientConnectionImpl::onMessageComplete fails to terminate in cases where ConnectionImpl::readDisable exits early due to the connection not being in an open state.  It is possible to hit this scenario in some circumstances including when handling a large response framed by connection close and the downstream is slower than the upstream.  HTTP/1.1 responses framed by connection close are relatively uncommon compared to responses that specify a content-length or use transfer-encoding: chunked.\r\n\r\nEnvoy shouldn't become unresponsive and crash when handling these responses.\r\n\r\n*Repro steps*:\r\nRead the last bytes of the response body and detect that the connection is closed, and then trigger readDisable on the upstream connection by exceeding the downstream connection high watermark.  I have a PR in progress with a test that repos the issue most of the time and a potential fix.\r\n\r\n*Call Stack*:\r\n[2019-12-27 17:59:30.020][236][critical][assert] [source/common/network/connection_impl.cc:282] assert failure: state() == State::Open.\r\n#0: Envoy::SignalAction::sigHandler() [0x3bbdb0c]\r\n#1: __restore_rt [0x7f0edb8383a0]\r\n#2: Envoy::Http::Http1::ClientConnectionImpl::onMessageComplete() [0x2c58362]\r\n#3: Envoy::Http::Http1::ConnectionImpl::onMessageCompleteBase() [0x2c5561c]\r\n#4: Envoy::Http::Http1::ConnectionImpl::$_8::operator()() [0x2c58d40]\r\n#5: Envoy::Http::Http1::ConnectionImpl::$_8::__invoke() [0x2c58d15]\r\n#6: http_parser_execute [0x31c041e]\r\n#7: Envoy::Http::Http1::ConnectionImpl::dispatchSlice() [0x2c53e99]\r\n#8: Envoy::Http::Http1::ConnectionImpl::dispatch() [0x2c53d92]\r\n#9: Envoy::Http::CodecClient::onData() [0x2c4a64c]\r\n#10: Envoy::Http::CodecClient::onEvent() [0x2c4a450]\r\n#11: Envoy::Network::ConnectionImplBase::raiseConnectionEvent() [0x2fd2a01]\r\n#12: Envoy::Network::ConnectionImpl::raiseEvent() [0x2fc79c5]\r\n#13: Envoy::Network::ConnectionImpl::closeSocket() [0x2fc6a3d]\r\n#14: Envoy::Network::ConnectionImpl::onReadReady() [0x2fc974f]\r\n#15: Envoy::Network::ConnectionImpl::onFileEvent() [0x2fc93f5]\r\n#16: Envoy::Network::ConnectionImpl::ConnectionImpl()::$_2::operator()() [0x2fce6be]\r\n#17: std::__1::__invoke<>() [0x2fce681]\r\n#18: std::__1::__invoke_void_return_wrapper<>::__call<>() [0x2fce622]\r\n#19: std::__1::__function::__alloc_func<>::operator()() [0x2fce5e2]\r\n#20: std::__1::__function::__func<>::operator()() [0x2fcd723]\r\n#21: std::__1::__function::__value_func<>::operator()() [0x26f23bd]\r\n#22: std::__1::function<>::operator()() [0x26f233f]\r\n#23: Envoy::Event::FileEventImpl::assignEvents()::$_0::operator()() [0x2fbd86c]\r\n#24: Envoy::Event::FileEventImpl::assignEvents()::$_0::__invoke() [0x2fbd6f6]\r\n#25: event_persist_closure [0x3b78bbe]\r\n#26: event_process_active_single_queue [0x3b781e8]\r\n#27: event_process_active [0x3b729aa]\r\n#28: event_base_loop [0x3b7187c]\r\n#29: Envoy::Event::LibeventScheduler::run() [0x307b698]\r\n#30: Envoy::Event::DispatcherImpl::run() [0x2fb2e7a]\r\n#31: Envoy::Server::WorkerImpl::threadRoutine() [0x1d297e1]\r\n#32: Envoy::Server::WorkerImpl::start()::$_3::operator()() [0x1d2f35c]\r\n#33: std::__1::__invoke<>() [0x1d2f31d]\r\n#34: std::__1::__invoke_void_return_wrapper<>::__call<>() [0x1d2f2cd]\r\n#35: std::__1::__function::__alloc_func<>::operator()() [0x1d2f29d]\r\n#36: std::__1::__function::__func<>::operator()() [0x1d2e3ce]\r\n#37: std::__1::__function::__value_func<>::operator()() [0x19bdd15]\r\n#38: std::__1::function<>::operator()() [0x19bdbd5]\r\n#39: Envoy::Thread::ThreadImplPosix::ThreadImplPosix()::$_0::operator()() [0x3b661b2]\r\n#40: Envoy::Thread::ThreadImplPosix::ThreadImplPosix()::$_0::__invoke() [0x3b66185]\r\n#41: start_thread [0x7f0edb82dc73]\r\n",
  "closed_at": "2020-01-07T18:14:21Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/18220477?v=4",
    "events_url": "https://api.github.com/users/alyssawilk/events{/privacy}",
    "followers_url": "https://api.github.com/users/alyssawilk/followers",
    "following_url": "https://api.github.com/users/alyssawilk/following{/other_user}",
    "gists_url": "https://api.github.com/users/alyssawilk/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/alyssawilk",
    "id": 18220477,
    "login": "alyssawilk",
    "node_id": "MDQ6VXNlcjE4MjIwNDc3",
    "organizations_url": "https://api.github.com/users/alyssawilk/orgs",
    "received_events_url": "https://api.github.com/users/alyssawilk/received_events",
    "repos_url": "https://api.github.com/users/alyssawilk/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/alyssawilk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alyssawilk/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/alyssawilk"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9508/comments",
  "created_at": "2019-12-27T18:02:33Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9508/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/9508",
  "id": 542948612,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9508/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-01-21T19:28:37Z",
    "closed_issues": 72,
    "created_at": "2019-10-10T03:07:36Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/12",
    "id": 4738243,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/12/labels",
    "node_id": "MDk6TWlsZXN0b25lNDczODI0Mw==",
    "number": 12,
    "open_issues": 2,
    "state": "closed",
    "title": "1.13.0",
    "updated_at": "2020-10-21T19:03:40Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/12"
  },
  "node_id": "MDU6SXNzdWU1NDI5NDg2MTI=",
  "number": 9508,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "HTTP/1: watchdog death when clearing readDisable in onMessageComplete and the upstream connection is closed",
  "updated_at": "2020-01-07T18:14:21Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/9508",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/28556681?v=4",
    "events_url": "https://api.github.com/users/antoniovicente/events{/privacy}",
    "followers_url": "https://api.github.com/users/antoniovicente/followers",
    "following_url": "https://api.github.com/users/antoniovicente/following{/other_user}",
    "gists_url": "https://api.github.com/users/antoniovicente/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/antoniovicente",
    "id": 28556681,
    "login": "antoniovicente",
    "node_id": "MDQ6VXNlcjI4NTU2Njgx",
    "organizations_url": "https://api.github.com/users/antoniovicente/orgs",
    "received_events_url": "https://api.github.com/users/antoniovicente/received_events",
    "repos_url": "https://api.github.com/users/antoniovicente/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/antoniovicente/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/antoniovicente/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/antoniovicente"
  }
}