{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/2023366?v=4",
    "events_url": "https://api.github.com/users/snowp/events{/privacy}",
    "followers_url": "https://api.github.com/users/snowp/followers",
    "following_url": "https://api.github.com/users/snowp/following{/other_user}",
    "gists_url": "https://api.github.com/users/snowp/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/snowp",
    "id": 2023366,
    "login": "snowp",
    "node_id": "MDQ6VXNlcjIwMjMzNjY=",
    "organizations_url": "https://api.github.com/users/snowp/orgs",
    "received_events_url": "https://api.github.com/users/snowp/received_events",
    "repos_url": "https://api.github.com/users/snowp/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/snowp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/snowp/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/snowp"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/2023366?v=4",
      "events_url": "https://api.github.com/users/snowp/events{/privacy}",
      "followers_url": "https://api.github.com/users/snowp/followers",
      "following_url": "https://api.github.com/users/snowp/following{/other_user}",
      "gists_url": "https://api.github.com/users/snowp/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/snowp",
      "id": 2023366,
      "login": "snowp",
      "node_id": "MDQ6VXNlcjIwMjMzNjY=",
      "organizations_url": "https://api.github.com/users/snowp/orgs",
      "received_events_url": "https://api.github.com/users/snowp/received_events",
      "repos_url": "https://api.github.com/users/snowp/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/snowp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/snowp/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/snowp"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "I am debugging some retry failures and noticed that Envoy is skipping retry in some cases even though the retry policy is set for it. This is a gRPC retry.\r\n\r\nHere is the retry configuration\r\nnum_retries: 5\r\nretry-on: cancelled,connect-failure,gateway-error,refused-stream,resource-exhausted,unavailable\r\n\r\nActual end client sees 503 with error message \"upstream connect error or disconnect/reset before headers. reset reason: connection failure\"\r\n\r\nHere is some relevant stats : \r\nenvoy.cluster.upstream_rq_retry : 7\r\nenvoy.cluster.upstream_rq_retry_success: 6\r\nenvoy.cluster.upstream_rq_503: 1\r\nenvoy.http2.tx_reset:1\r\nenvoy.cluster.upstream_rq_pending_failure_eject:7\r\nenvoy.cluster.upstream_cx_connect_fail:7\r\nenvoy.cluster.upstream_cx_connect_timeout:3\r\n\r\nAs can be seen from the above stats, one retry is skipped and resulted in 503. \r\n\r\nLooking at the `router` code, I see two places where a retry can be skipped on upstream reset.\r\nOne here, But since it is a connection failure - none these conditions should trigger the skip. Also `rq_reset_after_downstream_response_started` stat is not incremented. So I am guessing this is not the case. \r\nhttps://github.com/envoyproxy/envoy/blob/7e7486588239f42b4be3a6383e3c0776d2d05bef/source/common/router/router.cc#L850\r\n\r\nSecond here : \r\nhttps://github.com/envoyproxy/envoy/blob/7e7486588239f42b4be3a6383e3c0776d2d05bef/source/common/router/router.cc#L1218\r\n\r\nI am not able to confirm whether this is case, because there are no stats to confirm the same. But the comments above seems very relevant on why retry may have been skipped.\r\n\r\nOne thing we can try is increase connect timeout to see if it resolves. Another thing I want to check, can adding buffer filter before this help? \r\n\r\n\r\n\r\n\r\n",
  "closed_at": "2019-07-24T18:29:57Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 8,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/7670/comments",
  "created_at": "2019-07-21T08:42:20Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/7670/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/7670",
  "id": 470757960,
  "labels": [
    {
      "color": "cc317c",
      "default": true,
      "description": "Questions that are neither investigations, bugs, nor enhancements",
      "id": 421403912,
      "name": "question",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MTI=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/question"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/7670/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NzA3NTc5NjA=",
  "number": 7670,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "some retries are skipped by Envoy",
  "updated_at": "2019-07-24T18:29:57Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/7670",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/17204904?v=4",
    "events_url": "https://api.github.com/users/ramaraochavali/events{/privacy}",
    "followers_url": "https://api.github.com/users/ramaraochavali/followers",
    "following_url": "https://api.github.com/users/ramaraochavali/following{/other_user}",
    "gists_url": "https://api.github.com/users/ramaraochavali/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ramaraochavali",
    "id": 17204904,
    "login": "ramaraochavali",
    "node_id": "MDQ6VXNlcjE3MjA0OTA0",
    "organizations_url": "https://api.github.com/users/ramaraochavali/orgs",
    "received_events_url": "https://api.github.com/users/ramaraochavali/received_events",
    "repos_url": "https://api.github.com/users/ramaraochavali/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ramaraochavali/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ramaraochavali/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ramaraochavali"
  }
}