{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "*Description*:\r\nFilterChainMatch has an option source_type that can be (from [docs](https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener.proto#envoy-api-enum-listener-filterchainmatch-connectionsourcetype)):\r\n\r\n```\r\nANY - (DEFAULT) \u2063Any connection source matches.\r\nLOCAL - \u2063Match a connection originating from the same host.\r\nEXTERNAL - \u2063Match a connection originating from a different host.\r\n```\r\n\r\nIf I set the option to `LOCAL` I would expect a connection from `100.96.4.33:48158` to `100.96.4.33:9094` to match and be considered local since `100.96.4.33==100.96.4.33`.  It does not.  I have attached the listener config below, I can see in the logs that Envoy is skipping the `fc-0` listener filter chain I expect and instead matching the fallthrough `fc-1` listener filter chain.\r\n\r\n*Repro steps*:\r\n1. Create a listener with a match for `source_type local`, such as the following:\r\n\r\n```\r\n{\r\n  \"version_info\": \"2019-08-06T18:27:01Z/2\",\r\n  \"listener\": {\r\n    \"name\": \"100.96.4.33_9094\",\r\n    \"address\": {\r\n      \"socket_address\": {\r\n        \"address\": \"100.96.4.33\",\r\n        \"port_value\": 9094\r\n      }\r\n    },\r\n    \"filter_chains\": [\r\n      {\r\n        \"filter_chain_match\": {\r\n          \"source_type\": \"LOCAL\"\r\n        },\r\n        \"filters\": [\r\n          {\r\n            \"name\": \"mixer\",\r\n            ...\r\n          },\r\n          {\r\n            \"name\": \"envoy.tcp_proxy\",\r\n            \"config\": {\r\n              \"access_log\": [\r\n                {\r\n                  \"name\": \"envoy.file_access_log\",\r\n                  \"config\": {\r\n                    \"format\": \"[%START_TIME%] \\\"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\\\" %RESPONSE_CODE% %RESPONSE_FLAGS% \\\"%DYNAMIC_METADATA(istio.mixer:status)%\\\" \\\"%UPSTREAM_TRANSPORT_FAILURE_REASON%\\\" %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \\\"%REQ(X-FORWARDED-FOR)%\\\" \\\"%REQ(USER-AGENT)%\\\" \\\"%REQ(X-REQUEST-ID)%\\\" \\\"%REQ(:AUTHORITY)%\\\" \\\"%UPSTREAM_HOST%\\\" %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% fc-0\\n\",\r\n                    \"path\": \"/dev/stdout\"\r\n                  }\r\n                }\r\n              ],\r\n              \"stat_prefix\": \"inbound|9094|server|kafka-svc.kafka.svc.cluster.local\",\r\n              \"cluster\": \"inbound|9094|server|kafka-svc.kafka.svc.cluster.local\"\r\n            }\r\n          }\r\n        ]\r\n      }\r\n  ]\r\n  ...\r\n}\r\n```\r\n\r\n2. If you connect from `100.96.4.33` to `100.96.4.33:9094` through Envoy, expect it to match this listener filter chain and see a log message ending in `fc-0` from the `envoy.file_access_log`\r\n\r\n3. Instead, see it not match this listener filter chain; it may match another depending on your configuration (for me, it matched `fc-1` in the detailed full listener dump attached).\r\n\r\n```\r\nkafka-0 istio-proxy [2019-08-06T18:37:03.346Z] \"- - -\" 0 - \"-\" \"-\" 0 0 0 - \"-\" \"-\" \"-\" \"-\" \"-\" - - 100.96.4.33:9094 100.96.4.33:37796 - fc-1\r\nkafka-0 istio-proxy [2019-08-06T18:37:03.499Z] \"- - -\" 0 - \"-\" \"-\" 0 0 0 - \"-\" \"-\" \"-\" \"-\" \"-\" - - 100.96.4.33:9094 100.96.4.33:37802 - fc-1\r\nkafka-0 istio-proxy [2019-08-06T18:37:03.837Z] \"- - -\" 0 - \"-\" \"-\" 0 0 0 - \"-\" \"-\" \"-\" \"-\" \"-\" - - 100.96.4.33:9094 100.96.4.33:37810 - fc-1\r\nkafka-0 istio-proxy [2019-08-06T18:37:04.154Z] \"- - -\" 0 - \"-\" \"-\" 0 0 0 - \"-\" \"-\" \"-\" \"-\" \"-\" - - 100.96.4.33:9094 100.96.4.33:37816 - fc-1\r\nkafka-0 istio-proxy [2019-08-06T18:37:04.480Z] \"- - -\" 0 - \"-\" \"-\" 0 0 0 - \"-\" \"-\" \"-\" \"-\" \"-\" - - 100.96.4.33:9094 100.96.4.33:37822 - fc-1\r\nkafka-0 istio-proxy [2019-08-06T18:37:04.794Z] \"- - -\" 0 - \"-\" \"-\" 0 0 0 - \"-\" \"-\" \"-\" \"-\" \"-\" - - 100.96.4.33:9094 100.96.4.33:37828 - fc-1\r\n```\r\n\r\n*Notes*\r\nI am creating the Envoy configuration using an Istio build that I am developing in but I do not believe this is an Istio-specific problem.\r\n\r\nI believe I've identified the root cause and I'll open a separate PR with my proposed fix.",
  "closed_at": "2019-08-16T22:12:29Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/7839/comments",
  "created_at": "2019-08-06T18:39:00Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/7839/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/7839",
  "id": 477534464,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/7839/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-11-03T23:59:23Z",
    "closed_issues": 73,
    "created_at": "2019-07-03T16:32:43Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/11",
    "id": 4463348,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/11/labels",
    "node_id": "MDk6TWlsZXN0b25lNDQ2MzM0OA==",
    "number": 11,
    "open_issues": 0,
    "state": "closed",
    "title": "1.12.0",
    "updated_at": "2019-11-09T17:21:27Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/11"
  },
  "node_id": "MDU6SXNzdWU0Nzc1MzQ0NjQ=",
  "number": 7839,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "FilterChainMatch source_type LOCAL doesn't match local connections",
  "updated_at": "2019-08-16T22:12:29Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/7839",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/803647?v=4",
    "events_url": "https://api.github.com/users/andrewjjenkins/events{/privacy}",
    "followers_url": "https://api.github.com/users/andrewjjenkins/followers",
    "following_url": "https://api.github.com/users/andrewjjenkins/following{/other_user}",
    "gists_url": "https://api.github.com/users/andrewjjenkins/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/andrewjjenkins",
    "id": 803647,
    "login": "andrewjjenkins",
    "node_id": "MDQ6VXNlcjgwMzY0Nw==",
    "organizations_url": "https://api.github.com/users/andrewjjenkins/orgs",
    "received_events_url": "https://api.github.com/users/andrewjjenkins/received_events",
    "repos_url": "https://api.github.com/users/andrewjjenkins/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/andrewjjenkins/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/andrewjjenkins/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/andrewjjenkins"
  }
}