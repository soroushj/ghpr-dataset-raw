{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "Recently we ran into a problem with `delayed_close_timeout` (the timeout was introduced to Envoy not so long ago and set to 1 second by default: https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/network/http_connection_manager/v2/http_connection_manager.proto.html?highlight=delayed_close_timeout).\r\n\r\nDue to some badly implemented client, we had to lower the timeout (that client is a Varnish healtcheck; it doesn't close the connection by itself and waits for closing by other side).\r\nWe lowered it to 0.02s. \r\n\r\nSome time later we noticed that large responses proxied by Envoy are incomplete. Envoy simply cuts off last part of a response. For example an 1MB response could be truncated by Envoy to only first 700KB.\r\n\r\nWe discovered that Envoy with delayed close processing enabled could close connection before the write buffer is flushed. The timer is activated before flush is complete. It is even documented here: https://github.com/envoyproxy/envoy/blob/master/source/common/network/connection_impl.cc#L133. With timeout set to 0, Envoy closes the connection only after the buffer is flushed.  \r\n\r\nDisabling delayed close (setting timeout to 0) fixes the problem, but this is not a perfect solution. I assume that delayed processing is enabled by default for good reason. Ideally we would like be protected against risks that it mitigates (to at least some degree).\r\n\r\nAssuming that my diagnosis is correct, I have a couple of thoughts/questions:\r\n\r\n* IMHO it is a bit misleading that timeout with *delayed* in its name could actually cause closing the connection *earlier*, than without the timeout. What do you think?\r\n* Is it neccessary to activate the timer before the flush is complete?\r\n* If it is neccessary, maybe it is a good idea to provide separate timeouts:\r\n    * one for waiting for flush completion\r\n    * one for waiting for closing the connection by remote peer",
  "closed_at": "2019-04-12T15:39:10Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6392/comments",
  "created_at": "2019-03-26T22:54:44Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6392/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/6392",
  "id": 425684416,
  "labels": [
    {
      "color": "c5def5",
      "default": false,
      "description": "Needs design doc/proposal before implementation",
      "id": 620444894,
      "name": "design proposal",
      "node_id": "MDU6TGFiZWw2MjA0NDQ4OTQ=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/design%20proposal"
    },
    {
      "color": "fbca04",
      "default": true,
      "description": "Needs help!",
      "id": 645516726,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw2NDU1MTY3MjY=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/6392/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MjU2ODQ0MTY=",
  "number": 6392,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "delayed_close_timeout - could it actually speed up connection closing, instead of delaying?",
  "updated_at": "2019-04-12T15:39:10Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/6392",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/30294040?v=4",
    "events_url": "https://api.github.com/users/MarcinFalkowski/events{/privacy}",
    "followers_url": "https://api.github.com/users/MarcinFalkowski/followers",
    "following_url": "https://api.github.com/users/MarcinFalkowski/following{/other_user}",
    "gists_url": "https://api.github.com/users/MarcinFalkowski/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/MarcinFalkowski",
    "id": 30294040,
    "login": "MarcinFalkowski",
    "node_id": "MDQ6VXNlcjMwMjk0MDQw",
    "organizations_url": "https://api.github.com/users/MarcinFalkowski/orgs",
    "received_events_url": "https://api.github.com/users/MarcinFalkowski/received_events",
    "repos_url": "https://api.github.com/users/MarcinFalkowski/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/MarcinFalkowski/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MarcinFalkowski/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/MarcinFalkowski"
  }
}