{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "*Description*: Changing the priority level of one or more localities in EDS can cause requests to fail due to the fact that endpoint health checking is done per-priority (as was discussed previously in [#3327](https://github.com/envoyproxy/envoy/issues/3327). Essentially priority changes (e.g. swapping the priority of two localities) look to EDS code like endpoints being removed and added, and therefore health checking state is reset.\r\n\r\nThis issue is probably only visible when using the `drain_connections_on_host_removal: true` setting because connections will not be torn down until health checks fail, although that would mean twice the health checking and twice the connections.\r\n\r\n*Repro steps*:\r\n1) Create a cluster with `drain_connections_on_host_removal: true` and cluster load assignment with two localities, one with priority 0 and one with priority 1\r\n2) generate traffic to this cluster. I was able to reproduce with just `while true; do curl $args; sleep .1; done`\r\n3) In control plane, swap the priorities of the two localities.\r\n\r\nIn the Envoy access log, I see a failed request amidst successful ones: \r\n```\r\n[2018-07-23T17:38:40.879Z] \"GET /whoareyou HTTP/1.1\" 200 - 0 17 2 2 \"-\" \"curl/7.29.0\" \"178d8607-6924-4fe6-aa4b-335fd5b11949\" \"envoy-test.slug.gns.square\" \"10.1.3.5:32351\"\r\n[2018-07-23T17:38:40.990Z] \"GET /whoareyou HTTP/1.1\" 200 - 0 17 2 2 \"-\" \"curl/7.29.0\" \"943ece9e-1daf-4cba-83d6-276ac4f5cd3c\" \"envoy-test.slug.gns.square\" \"10.1.3.5:32351\"\r\n[2018-07-23T17:38:41.100Z] \"GET /whoareyou HTTP/1.1\" 503 UH 0 19 0 - \"-\" \"curl/7.29.0\" \"c3b4afb0-1821-4931-89c0-d8f2a7f3ab1f\" \"envoy-test.slug.gns.square\" \"-\"\r\n[2018-07-23T17:38:41.207Z] \"GET /whoareyou HTTP/1.1\" 200 - 0 18 9 9 \"-\" \"curl/7.29.0\" \"29c1e2c3-1df1-41cb-b7f5-9499caefb6cf\" \"envoy-test.slug.gns.square\" \"10.1.3.26:32351\"\r\n[2018-07-23T17:38:41.325Z] \"GET /whoareyou HTTP/1.1\" 200 - 0 19 9 9 \"-\" \"curl/7.29.0\" \"1e6974b2-37db-4751-8e4d-824cb76da78c\" \"envoy-test.slug.gns.square\" \"10.1.3.45:32351\"\r\n```\r\nThe client sees `no healthy upstream`.\r\n\r\nThis issue arises from a difference between the way we model cluster membership and the way the code does. The code seems to assume that priorities are static and immutable, whereas we view _localities_ as static and immutable with priorities that may change. My argument for thinking about it this way is that localities make reference to physical regions (region, zone, sub zone) but you might want to reprioritize regional routing, for instance during a disaster recovery exercise or if you add a new region.\r\n\r\nUnfortunately this would probably require a pretty significant refactor to fix. With some guidance we might have some bandwidth to look into this.",
  "closed_at": "2018-08-14T17:27:57Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/3930/comments",
  "created_at": "2018-07-23T18:01:45Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/3930/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/3930",
  "id": 343735780,
  "labels": [],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/3930/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzNDM3MzU3ODA=",
  "number": 3930,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Changing priority level of a locality causes requests to fail",
  "updated_at": "2018-08-14T17:27:57Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/3930",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1444855?v=4",
    "events_url": "https://api.github.com/users/mpuncel/events{/privacy}",
    "followers_url": "https://api.github.com/users/mpuncel/followers",
    "following_url": "https://api.github.com/users/mpuncel/following{/other_user}",
    "gists_url": "https://api.github.com/users/mpuncel/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mpuncel",
    "id": 1444855,
    "login": "mpuncel",
    "node_id": "MDQ6VXNlcjE0NDQ4NTU=",
    "organizations_url": "https://api.github.com/users/mpuncel/orgs",
    "received_events_url": "https://api.github.com/users/mpuncel/received_events",
    "repos_url": "https://api.github.com/users/mpuncel/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mpuncel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mpuncel/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mpuncel"
  }
}