{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/2023366?v=4",
    "events_url": "https://api.github.com/users/snowp/events{/privacy}",
    "followers_url": "https://api.github.com/users/snowp/followers",
    "following_url": "https://api.github.com/users/snowp/following{/other_user}",
    "gists_url": "https://api.github.com/users/snowp/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/snowp",
    "id": 2023366,
    "login": "snowp",
    "node_id": "MDQ6VXNlcjIwMjMzNjY=",
    "organizations_url": "https://api.github.com/users/snowp/orgs",
    "received_events_url": "https://api.github.com/users/snowp/received_events",
    "repos_url": "https://api.github.com/users/snowp/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/snowp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/snowp/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/snowp"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/2023366?v=4",
      "events_url": "https://api.github.com/users/snowp/events{/privacy}",
      "followers_url": "https://api.github.com/users/snowp/followers",
      "following_url": "https://api.github.com/users/snowp/following{/other_user}",
      "gists_url": "https://api.github.com/users/snowp/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/snowp",
      "id": 2023366,
      "login": "snowp",
      "node_id": "MDQ6VXNlcjIwMjMzNjY=",
      "organizations_url": "https://api.github.com/users/snowp/orgs",
      "received_events_url": "https://api.github.com/users/snowp/received_events",
      "repos_url": "https://api.github.com/users/snowp/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/snowp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/snowp/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/snowp"
    }
  ],
  "author_association": "CONTRIBUTOR",
  "body": "A fuzz bug in `config_fuzz_bug` is catching a crash when you use a priority value that goes against the guidelines in the config (in this case, we have a priority 10 when we should be using priority 0). The following is a reporoducer for the test, and crashes on `ASSERT(priority == 0)`. \r\n\r\n```\r\nTEST_F(ClusterManagerImplTest, InvalidPriority) {\r\n  const std::string yaml = R\"EOF(\r\nstatic_resources:\r\n  clusters:\r\n  - name: cluster_2\r\n    connect_timeout: 0.250s\r\n    type: STRICT_DNS\r\n  - name: new_cluster\r\n    connect_timeout: 4s\r\n    load_assignment:\r\n      cluster_name: \"domains\"\r\n      endpoints:\r\n        - priority: 10\r\n          lb_endpoints:\r\n          - endpoint:\r\n              address:\r\n                socket_address:\r\n                  address: 127.0.0.1\r\n                  port_value: 11001\r\n            health_status: DEGRADED\r\ncluster_manager:\r\n  local_cluster_name: new_cluster\r\n)EOF\";\r\n\r\n  create(parseBootstrapFromV2Yaml(yaml));\r\n}\r\n```\r\nIt seems like the cluster manager is updating the cluster membership for `new_cluster`, calling a post thread local cluster update. When the priority set updates the hosts we end up running the callback set in `load_balancer_impl.cc` with the fatal assert:\r\nhttps://github.com/envoyproxy/envoy/blob/74fbb938dab53ebf782348371091ab49ffe039f6/source/common/upstream/load_balancer_impl.cc#L299-L312\r\n\r\nThis seems like a config that should have been caught early on, since it violates have priorities set from 0 to N without skipping. I can't seem to find any code in the cluster manager or in the priority set impl that will throw an exception if this is violated. Is there a better way to handle this that won't cause a fatal assert?\r\n\r\n(Here's a stack trace:2019-11-13 18:30:10.063][14][critical][assert] [source/common/upstream/load_balancer_impl.cc:309] assert failure: priority == 0.\r\n[2019-11-13 18:30:10.063][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:83] Caught Aborted, suspect faulting address 0x6fad50000000e\r\n[2019-11-13 18:30:10.063][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:70] Backtrace (use tools/stack_decode.py to get line numbers):\r\n[2019-11-13 18:30:10.063][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:71] Envoy version: 0/1.13.0-dev/redacted/DEBUG/BoringSSL\r\n[2019-11-13 18:30:10.074][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #0: Envoy::SignalAction::sigHandler() [0x1e51c5c]\r\n[2019-11-13 18:30:10.074][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #1: __restore_rt [0x7fb6c48093a0]\r\n[2019-11-13 18:30:10.085][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #2: std::_Function_handler<>::_M_invoke() [0x122671c]\r\n[2019-11-13 18:30:10.096][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #3: std::function<>::operator()() [0x50cc54]\r\n[2019-11-13 18:30:10.106][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #4: Envoy::Common::CallbackManager<>::runCallbacks() [0x539243]\r\n[2019-11-13 18:30:10.117][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #5: Envoy::Upstream::PrioritySetImpl::runReferenceUpdateCallbacks() [0x833a84]\r\n[2019-11-13 18:30:10.127][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #6: Envoy::Upstream::PrioritySetImpl::getOrCreateHostSet()::$_0::operator()() [0x1031c34]\r\n[2019-11-13 18:30:10.138][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #7: std::_Function_handler<>::_M_invoke() [0x1031a8c]\r\n[2019-11-13 18:30:10.138][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #8: std::function<>::operator()() [0x50cc54]\r\n[2019-11-13 18:30:10.138][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #9: Envoy::Common::CallbackManager<>::runCallbacks() [0x539243]\r\n[2019-11-13 18:30:10.148][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #10: Envoy::Upstream::HostSetImpl::runUpdateCallbacks() [0x836b08]\r\n[2019-11-13 18:30:10.159][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #11: Envoy::Upstream::HostSetImpl::updateHosts() [0x1020a19]\r\n[2019-11-13 18:30:10.169][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #12: Envoy::Upstream::PrioritySetImpl::updateHosts() [0x10224c8]\r\n[2019-11-13 18:30:10.180][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #13: Envoy::Upstream::ClusterManagerImpl::ThreadLocalClusterManagerImpl::updateClusterMembership() [0x5cfd04]\r\n[2019-11-13 18:30:10.190][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #14: Envoy::Upstream::ClusterManagerImpl::postThreadLocalClusterUpdate()::$_17::operator()() [0x5d64a4]\r\n[2019-11-13 18:30:10.200][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #15: std::_Function_handler<>::_M_invoke() [0x5d60cd]\r\n[2019-11-13 18:30:10.211][14][critical][backtrace] [bazel-out/k8-fastbuild/bin/source/server/_virtual_includes/backtrace_lib/server/backtrace.h:75] #16: std::function<>::operator()() [0x5358ae]\r\n)\r\n",
  "closed_at": "2019-11-24T20:44:10Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9013/comments",
  "created_at": "2019-11-13T18:35:30Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9013/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/9013",
  "id": 522399604,
  "labels": [
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/9013/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MjIzOTk2MDQ=",
  "number": 9013,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "Invalid priority causing crash on host update",
  "updated_at": "2019-11-24T20:44:10Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/9013",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/5194569?v=4",
    "events_url": "https://api.github.com/users/asraa/events{/privacy}",
    "followers_url": "https://api.github.com/users/asraa/followers",
    "following_url": "https://api.github.com/users/asraa/following{/other_user}",
    "gists_url": "https://api.github.com/users/asraa/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/asraa",
    "id": 5194569,
    "login": "asraa",
    "node_id": "MDQ6VXNlcjUxOTQ1Njk=",
    "organizations_url": "https://api.github.com/users/asraa/orgs",
    "received_events_url": "https://api.github.com/users/asraa/received_events",
    "repos_url": "https://api.github.com/users/asraa/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/asraa/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/asraa/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/asraa"
  }
}