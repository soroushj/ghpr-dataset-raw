{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    }
  ],
  "author_association": "MEMBER",
  "body": "We have seen the following crash at Lyft a few times on our edge boxes:\r\n\r\n```\r\n#0  0x00007f3e00b81c37 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56\r\n#1  0x00007f3e00b85028 in __GI_abort () at abort.c:89\r\n#2  0x000055f55666033b in abort_message ()\r\n#3  0x000055f556649bce in demangling_terminate_handler() ()\r\n#4  0x000055f556649963 in std::__terminate(void (*)()) ()\r\n#5  0x000055f556661c96 in __cxxabiv1::failed_throw(__cxxabiv1::__cxa_exception*) ()\r\n#6  0x000055f556661c2f in __cxa_throw ()\r\n#7  0x000055f555eaff8e in Envoy::Http::Http2::ConnectionImpl::sendPendingFrames (this=<optimized out>) at external/envoy/source/common/http/http2/codec_impl.cc:828\r\n#8  0x000055f555ea1e60 in onDrainTimeout (this=0x55f55e74c120) at external/envoy/source/common/http/conn_manager_impl.cc:476\r\n#9  operator() (this=<optimized out>) at external/envoy/source/common/http/conn_manager_impl.cc:1333\r\n#10 __invoke<(lambda at external/envoy/source/common/http/conn_manager_impl.cc:1333:7) &> (__f=...) at /opt/llvm/bin/../include/c++/v1/type_traits:3530\r\n#11 __call<(lambda at external/envoy/source/common/http/conn_manager_impl.cc:1333:7) &> (__args=...) at /opt/llvm/bin/../include/c++/v1/__functional_base:348\r\n#12 operator() (this=<optimized out>) at /opt/llvm/bin/../include/c++/v1/functional:1533\r\n#13 std::__1::__function::__func<Envoy::Http::ConnectionManagerImpl::startDrainSequence()::$_5, std::__1::allocator<Envoy::Http::ConnectionManagerImpl::startDrainSequence()::$_5>, void ()>::operator()() (this=<optimized out>) at /opt/llvm/bin/../include/c++/v1/functional:1707\r\n#14 0x000055f555f7eb76 in event_process_active_single_queue (base=0x55f5589fb600, activeq=0x55f5589d9df0, max_to_process=2147483647, endtime=0x0)\r\n    at /root/.cache/bazel/_bazel_root/e500e327e6981ab742dbacbb6723d21d/sandbox/processwrapper-sandbox/1734/execroot/envoy_lyft/external/com_github_libevent_libevent/event.c:1713\r\n#15 0x000055f555f7d6fe in event_process_active (base=0x55f5589fb600)\r\n    at /root/.cache/bazel/_bazel_root/e500e327e6981ab742dbacbb6723d21d/sandbox/processwrapper-sandbox/1734/execroot/envoy_lyft/external/com_github_libevent_libevent/event.c:1808\r\n#16 event_base_loop (base=0x55f5589fb600, flags=<optimized out>)\r\n    at /root/.cache/bazel/_bazel_root/e500e327e6981ab742dbacbb6723d21d/sandbox/processwrapper-sandbox/1734/execroot/envoy_lyft/external/com_github_libevent_libevent/event.c:2047\r\n#17 0x000055f555d0cd68 in Envoy::Server::WorkerImpl::threadRoutine (this=0x55f558a92ba0, guard_dog=...) at external/envoy/source/server/worker_impl.cc:110\r\n#18 0x000055f556139273 in operator() (this=<optimized out>) at /opt/llvm/bin/../include/c++/v1/functional:1860\r\n#19 operator() (this=<optimized out>) at /opt/llvm/bin/../include/c++/v1/functional:2419\r\n#20 operator() (this=<optimized out>, arg=<optimized out>) at external/envoy/source/common/common/posix/thread_impl.cc:33\r\n#21 Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>)::$_0::__invoke(void*) (arg=<optimized out>) at external/envoy/source/common/common/posix/thread_impl.cc:32\r\n#22 0x00007f3e00f1c184 in start_thread (arg=0x7f3dfeb46700) at pthread_create.c:312\r\n#23 0x00007f3e00c4903d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111\r\n\r\n```\r\n\r\nFrom some core dump digging I see in the nghttp2 session active outbound item:\r\n\r\n```\r\ngoaway = {\r\n      hd = {\r\n        length = 28, \r\n        stream_id = 0, \r\n        type = 7 '\\a', \r\n        flags = 0 '\\000', \r\n        reserved = 0 '\\000'\r\n      }, \r\n      last_stream_id = 213, \r\n      error_code = 6, \r\n      opaque_data = 0x55f57b047020 \"too large frame size\\365U\", \r\n      opaque_data_len = 20, \r\n      reserved = 0 '\\000'\r\n    }, \r\n```\r\n\r\nThis says to me that somehow the onDrainTimeout final GOAWAY has raced with a bad client incoming frame, and we are seeing that frame get sent when we try to flush the pending frames and then cause a codec exception to be thrown.\r\n\r\nI think we did get a codec exception and entered handleCodecException(), and then closed the connection using flush and write delay. However, we don't disarm the drain timer (or any of the other timers) until we connection actually closed, so there is a race condition here.\r\n",
  "closed_at": "2020-03-06T04:38:18Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/envoyproxy/envoy/issues/10138/comments",
  "created_at": "2020-02-22T00:03:27Z",
  "events_url": "https://api.github.com/repos/envoyproxy/envoy/issues/10138/events",
  "html_url": "https://github.com/envoyproxy/envoy/issues/10138",
  "id": 569243347,
  "labels": [
    {
      "color": "d4c5f9",
      "default": false,
      "description": "",
      "id": 1715341036,
      "name": "area/http",
      "node_id": "MDU6TGFiZWwxNzE1MzQxMDM2",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/area/http"
    },
    {
      "color": "ee0701",
      "default": true,
      "description": null,
      "id": 421403907,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MjE0MDM5MDc=",
      "url": "https://api.github.com/repos/envoyproxy/envoy/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/envoyproxy/envoy/issues/10138/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-04-08T18:48:51Z",
    "closed_issues": 45,
    "created_at": "2019-12-05T23:44:41Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
      "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
      "followers_url": "https://api.github.com/users/mattklein123/followers",
      "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mattklein123",
      "id": 6305260,
      "login": "mattklein123",
      "node_id": "MDQ6VXNlcjYzMDUyNjA=",
      "organizations_url": "https://api.github.com/users/mattklein123/orgs",
      "received_events_url": "https://api.github.com/users/mattklein123/received_events",
      "repos_url": "https://api.github.com/users/mattklein123/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mattklein123"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/envoyproxy/envoy/milestone/13",
    "id": 4907478,
    "labels_url": "https://api.github.com/repos/envoyproxy/envoy/milestones/13/labels",
    "node_id": "MDk6TWlsZXN0b25lNDkwNzQ3OA==",
    "number": 13,
    "open_issues": 0,
    "state": "closed",
    "title": "1.14.0",
    "updated_at": "2020-04-08T18:48:51Z",
    "url": "https://api.github.com/repos/envoyproxy/envoy/milestones/13"
  },
  "node_id": "MDU6SXNzdWU1NjkyNDMzNDc=",
  "number": 10138,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/envoyproxy/envoy",
  "state": "closed",
  "title": "http/2: potential goaway drain race leads to crash",
  "updated_at": "2020-03-06T04:38:18Z",
  "url": "https://api.github.com/repos/envoyproxy/envoy/issues/10138",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6305260?v=4",
    "events_url": "https://api.github.com/users/mattklein123/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattklein123/followers",
    "following_url": "https://api.github.com/users/mattklein123/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattklein123/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattklein123",
    "id": 6305260,
    "login": "mattklein123",
    "node_id": "MDQ6VXNlcjYzMDUyNjA=",
    "organizations_url": "https://api.github.com/users/mattklein123/orgs",
    "received_events_url": "https://api.github.com/users/mattklein123/received_events",
    "repos_url": "https://api.github.com/users/mattklein123/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattklein123/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattklein123/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattklein123"
  }
}