{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\n\r\nWhen creating an RGW object store via the `CephObjectStore` CRD, the pool `<store_name>.rgw.buckets.non-ec` is created by Ceph but not configured by Rook.\r\n\r\nWe noticed this on a non-production device with only one OSD: since the default replication factor is > 1, the pool was under-replicated and would not serve write requests.\r\n\r\nSince the pool appears to only be used during multipart uploads, this meant that S3 PUT requests below a certain size worked, but multipart uploads always hung waiting for a response to the first POST request.\r\n\r\n**Expected behavior:**\r\nAfter creating an object store using the `CephObjectStore` CRD, all necessary pools should be configured with my stated replication (and other) settings.\r\n\r\n**How to reproduce it (minimal and precise):**\r\n\r\nCreate an object store with `metadata.replicated.size` set to `1`:\r\n```\r\napiVersion: ceph.rook.io/v1\r\nkind: CephObjectStore\r\nmetadata:\r\n  name: my-object-store\r\n  namespace: rook-ceph\r\nspec:\r\n  metadataPool:\r\n    failureDomain: host\r\n    replicated:\r\n      size: 1\r\n  dataPool:\r\n    replicated:\r\n      size: 1\r\n  gateway:\r\n    type: s3\r\n    sslCertificateRef: \r\n    port: 80\r\n    securePort: \r\n    instances: 1\r\n```\r\nUsing the Ceph toolbox, list pools:\r\n```\r\n# ceph osd pool ls\r\nreplicapool\r\nmy-object-store.rgw.control\r\nmy-object-store.rgw.meta\r\nmy-object-store.rgw.log\r\nmy-object-store.rgw.buckets.index\r\n.rgw.root\r\nmy-object-store.rgw.buckets.data\r\nmy-object-store.rgw.buckets.non-ec\r\n```\r\nVerify with `osd pool get` that the size has been set for all buckets except `my-object-store-rgw.buckets.non-ec`:\r\n\r\n```\r\n# ceph osd pool get my-object-store.rgw.meta size\r\nsize: 1\r\n[...]\r\n# ceph osd pool get my-object-store.rgw.buckets.non-ec size\r\nsize: 3\r\n```\r\n\r\n\r\n**Workaround:**\r\n`ceph osd pool set my-object-store.rgw.buckets.non-ec size 1`\r\nWhere '1' is your desired replication factor.\r\n\r\n**Suggested fix:**\r\n\r\nDocumentation on this pool was a little hard to come by but [this mailing list message](http://lists.ceph.com/pipermail/ceph-users-ceph.com/2018-September/029538.html) clarifies that it's only used for storing metadata during multipart uploads:\r\n\r\n> This extra non-ec pool is only used for the 'multipart metadata' object that tracks which parts have been written, though - the object data for each part is still written to the normal data pool, so it can take advantage of erasure coding.\r\n\r\nI suggest we add it to the list of metadata pools mentioned in the [design document](https://github.com/rook/rook/blob/5db55e1cfdc5013366e8c4a65c05c3e22c7bf6a8/design/object-bucket.md) and ensure it is configured with the same settings that they are.",
  "closed_at": "2019-10-17T18:43:55Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/4073/comments",
  "created_at": "2019-10-10T12:27:53Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/4073/events",
  "html_url": "https://github.com/rook/rook/issues/4073",
  "id": 505237442,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/4073/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MDUyMzc0NDI=",
  "number": 4073,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Multipart uploads failing: RGW 'non-ec' pool should be configured as metadata pool",
  "updated_at": "2019-10-17T18:43:55Z",
  "url": "https://api.github.com/repos/rook/rook/issues/4073",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/7415484?v=4",
    "events_url": "https://api.github.com/users/OwenTuz/events{/privacy}",
    "followers_url": "https://api.github.com/users/OwenTuz/followers",
    "following_url": "https://api.github.com/users/OwenTuz/following{/other_user}",
    "gists_url": "https://api.github.com/users/OwenTuz/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/OwenTuz",
    "id": 7415484,
    "login": "OwenTuz",
    "node_id": "MDQ6VXNlcjc0MTU0ODQ=",
    "organizations_url": "https://api.github.com/users/OwenTuz/orgs",
    "received_events_url": "https://api.github.com/users/OwenTuz/received_events",
    "repos_url": "https://api.github.com/users/OwenTuz/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/OwenTuz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/OwenTuz/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/OwenTuz"
  }
}