{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "<!-- **Are you in the right place?**\r\n1. For issues or feature requests, please create an issue in this repository.\r\n2. For general technical and non-technical questions, we are happy to help you on our [Rook.io Slack](https://Rook-io.slack.com).\r\n3. Did you already search the existing open issues for anything similar? -->\r\n\r\n**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\nRook currently installs flex drivers under four different names for backward compatibility reasons: ceph.rook.io/<namespace>, ceph.rook.io/rook, rook.io/<namespace>, and rook.io/rook. Only the first one is expected to be used going forward, but the others are installed in case PVCs are still referencing them.\r\n\r\nThe integration tests sometimes fail because the flex drivers do not get registered as expected.\r\nFrom the [kubelet log](https://jenkins.rook.io/job/rook/job/rook/job/PR-2010/3/artifact/_output/tests/kubelet_v1.11.0.log), we see:\r\n```\r\nAug 08 22:57:24 ip-172-31-25-17 kubelet[14247]: E0808 22:57:24.631723   14247 driver-call.go:251] Failed to unmarshal output for command: init, output: \"\", error: unexpected end of JSON input\r\nAug 08 22:57:24 ip-172-31-25-17 kubelet[14247]: W0808 22:57:24.631761   14247 driver-call.go:144] FlexVolume: driver call failed: executable: /usr/libexec/kubernetes/kubelet-plugins/volume/exec/rook.io~block-k8s-ns-system/block-k8s-ns-system, args: [init], error: fork/exec /usr/libexec/kubernetes/kubelet-plugins/volume/exec/rook.io~block-k8s-ns-system/block-k8s-ns-system: no such file or directory, output: \"\"\r\nAug 08 22:57:24 ip-172-31-25-17 kubelet[14247]: E0808 22:57:24.809539   14247 plugins.go:595] Error dynamically probing plugins: Error creating Flexvolume plugin from directory rook.io~block-k8s-ns-system, skipping. Error: unexpected end of JSON input\r\n```\r\n\r\nThe errors in the kubelet are seen at the same time we see the flex drivers registered in the [agent log](https://jenkins.rook.io/job/rook/job/rook/job/PR-2010/3/artifact/_output/tests/TestBlockCreateSuite_aws_1.11.x_rook-ceph-agent-h6dh8_block-k8s-ns-system_1533769319.log):\r\n```\r\n2018-08-08 22:57:24.497773 I | flexvolume: Listening on unix socket for Kubernetes volume attach commands: /flexmnt/ceph.rook.io~block-k8s-ns-system/.rook.sock\r\n2018-08-08 22:57:24.574891 I | flexvolume: Listening on unix socket for Kubernetes volume attach commands: /flexmnt/ceph.rook.io~rook/.rook.sock\r\n2018-08-08 22:57:24.796417 I | flexvolume: Listening on unix socket for Kubernetes volume attach commands: /flexmnt/rook.io~block-k8s-ns-system/.rook.sock\r\n2018-08-08 22:57:24.862425 I | flexvolume: Listening on unix socket for Kubernetes volume attach commands: /flexmnt/rook.io~rook/.rook.sock\r\n```\r\n\r\nThere seems to be a race when loading the flex drivers when all four are registered at the same time. https://github.com/kubernetes/kubernetes/pull/58519/files#r163433782.\r\n\r\nThis issue has only been seen in the Jenkins integration tests, although it's possibly just not identified in the wild yet.\r\n\r\nSimplest might be to put a short sleep between registering the flex drivers. Startup time to register the flex drivers is not critical. Another possibility is to skip loading the legacy flex drivers if a flag is set in the operator yaml. However, users wouldn't really know when to set that, so I'm inclined to try a simple sleep (maybe 500ms) if on 1.11 or newer. \r\n\r\n**Expected behavior:**\r\nFlex drivers should load properly\r\n\r\n**How to reproduce it (minimal and precise):**\r\n<!-- Please let us know any circumstances for reproduction of your bug. -->\r\n\r\n**Environment**:\r\n* OS (e.g. from /etc/os-release):\r\n* Kernel (e.g. `uname -a`):\r\n* Cloud provider or hardware configuration:\r\n* Rook version (use `rook version` inside of a Rook Pod):\r\n* Kubernetes version (use `kubectl version`):\r\n* Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift):\r\n* Storage backend status (e.g. for Ceph use `ceph health` in the [Rook Ceph toolbox](https://rook.io/docs/Rook/master/toolbox.html)):\r\n",
  "closed_at": "2018-08-24T20:57:50Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/2064/comments",
  "created_at": "2018-08-23T19:53:39Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/2064/events",
  "html_url": "https://github.com/rook/rook/issues/2064",
  "id": 353529399,
  "labels": [
    {
      "color": "5ccfd1",
      "default": false,
      "description": "",
      "id": 730857860,
      "name": "flexvolume",
      "node_id": "MDU6TGFiZWw3MzA4NTc4NjA=",
      "url": "https://api.github.com/repos/rook/rook/labels/flexvolume"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/2064/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-01-28T21:43:43Z",
    "closed_issues": 89,
    "created_at": "2018-02-28T18:53:01Z",
    "creator": {
      "avatar_url": "https://avatars2.githubusercontent.com/u/4313439?v=4",
      "events_url": "https://api.github.com/users/jbw976/events{/privacy}",
      "followers_url": "https://api.github.com/users/jbw976/followers",
      "following_url": "https://api.github.com/users/jbw976/following{/other_user}",
      "gists_url": "https://api.github.com/users/jbw976/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jbw976",
      "id": 4313439,
      "login": "jbw976",
      "node_id": "MDQ6VXNlcjQzMTM0Mzk=",
      "organizations_url": "https://api.github.com/users/jbw976/orgs",
      "received_events_url": "https://api.github.com/users/jbw976/received_events",
      "repos_url": "https://api.github.com/users/jbw976/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jbw976/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jbw976/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jbw976"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/rook/rook/milestone/10",
    "id": 3151476,
    "labels_url": "https://api.github.com/repos/rook/rook/milestones/10/labels",
    "node_id": "MDk6TWlsZXN0b25lMzE1MTQ3Ng==",
    "number": 10,
    "open_issues": 0,
    "state": "closed",
    "title": "0.9",
    "updated_at": "2020-01-28T21:43:43Z",
    "url": "https://api.github.com/repos/rook/rook/milestones/10"
  },
  "node_id": "MDU6SXNzdWUzNTM1MjkzOTk=",
  "number": 2064,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Installing multiple Rook flex drivers fails sometimes due to race condition",
  "updated_at": "2018-08-24T21:02:52Z",
  "url": "https://api.github.com/repos/rook/rook/issues/2064",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  }
}