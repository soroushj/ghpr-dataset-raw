{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "I have deployed `v0.6.2` and tried to follow the instruction in the update [docs](https://rook.github.io/docs/rook/master/upgrade.html) to upgrade to `master`. But i am seeing some issues. There are some issues i was able to fix but other i couldnt fix. Here are the two that im not sure how to fix.\r\n\r\n**Operator upgrade**\r\nAfter upgrading the operator. I get the following output from `ceph -w`. This is ran from the rook-tools. Keeping in mind that currently the rest of the cluster is still `0.6.2`.\r\n```\r\n  cluster:\r\n    id:     70bce1e5-31d8-4ae4-b016-cc5b4f2e1a64\r\n    health: HEALTH_WARN\r\n            Reduced data availability: 100 pgs inactive\r\n            Degraded data redundancy: 100 pgs unclean\r\n\r\n  services:\r\n    mon: 3 daemons, quorum rook-ceph-mon2,rook-ceph-mon1,rook-ceph-mon0\r\n    mgr: rook-ceph-mgr0(active), standbys: rook-ceph-mgr1\r\n    osd: 1 osds: 1 up, 1 in\r\n\r\n  data:\r\n    pools:   1 pools, 100 pgs\r\n    objects: 0 objects, 0 bytes\r\n    usage:   2301 MB used, 13565 MB / 15867 MB avail\r\n    pgs:     100.000% pgs unknown\r\n             100 unknown\r\n2018-01-26 23:35:01.077710 mon.rook-ceph-mon2 [INF] mon.1 10.102.222.58:6790/0\r\n2018-01-26 23:35:26.511354 mon.rook-ceph-mon2 [INF] Active manager daemon rook-ceph-mgr0 restarted\r\n2018-01-26 23:35:26.511420 mon.rook-ceph-mon2 [INF] Activating manager daemon rook-ceph-mgr0\r\n2018-01-26 23:35:27.310284 mon.rook-ceph-mon2 [WRN] Health check failed: noscrub flag(s) set (OSDMAP_FLAGS)\r\n2018-01-26 23:35:27.702681 mon.rook-ceph-mon2 [INF] Manager daemon rook-ceph-mgr0 is now available\r\n2018-01-26 23:35:30.342934 mon.rook-ceph-mon2 [INF] Health check cleared: OSDMAP_FLAGS (was: nodeep-scrub flag(s) set)\r\n2018-01-26 23:35:30.342964 mon.rook-ceph-mon2 [INF] Cluster is now healthy\r\n2018-01-26 23:35:27.700337 mgr.rook-ceph-mgr0 [ERR] Failed to load ceph-mgr modules: prometheus, restful\r\n2018-01-26 23:36:26.679036 mon.rook-ceph-mon2 [WRN] Health check failed: Reduced data availability: 100 pgs inactive (PG_AVAILABILITY)\r\n2018-01-26 23:36:26.679159 mon.rook-ceph-mon2 [WRN] Health check failed: Degraded data redundancy: 100 pgs unclean (PG_DEGRADED)\r\n```\r\nI noticed that if i dont have a pool created, i dont get the `pgs unknown` error and the cluster is ok. So something about having a pool created is causing this issue.\r\n\r\n**OSD upgrade**\r\nAfter upgrading a OSD pod, the OSD pod goes on a crashloop. Here is the log.\r\n```\r\n2018-01-27 00:50:46.481013 I | osd0: 2018-01-27 00:50:46.480915 7febb36afe00  0 osd.0 25 crush map has features 2199057072128, adjusting msgr requires for clients\r\n2018-01-27 00:50:46.481161 I | osd0: 2018-01-27 00:50:46.481139 7febb36afe00  0 osd.0 25 crush map has features 2199057072128 was 8705, adjusting msgr requires for mons\r\n2018-01-27 00:50:46.481321 I | osd0: 2018-01-27 00:50:46.481297 7febb36afe00  0 osd.0 25 crush map has features 720578139436367872, adjusting msgr requires for osds\r\n2018-01-27 00:50:46.481548 I | osd0: 2018-01-27 00:50:46.481487 7febb36afe00  0 osd.0 25 load_pgs\r\n2018-01-27 00:50:46.481615 I | osd0: 2018-01-27 00:50:46.481597 7febb36afe00  0 osd.0 25 load_pgs opened 0 pgs\r\n2018-01-27 00:50:46.481715 I | osd0: 2018-01-27 00:50:46.481698 7febb36afe00  0 osd.0 25 using weightedpriority op queue with priority op cut off at 64.\r\n2018-01-27 00:50:46.483947 I | osd0: 2018-01-27 00:50:46.483785 7febb36afe00 -1 osd.0 25 log_to_monitors {default=true}\r\n2018-01-27 00:50:46.491408 I | osd0: 2018-01-27 00:50:46.491195 7febb36afe00  0 osd.0 25 done with init, starting boot process\r\n2018-01-27 00:50:46.706299 I | exec: Running command: ceph osd crush reweight osd.0 0.0 --cluster=rook --conf=/var/lib/rook/rook/rook.config --keyring=/var/lib/rook/rook/client.admin.keyring --format json --out-file /tmp/163776220\r\n2018-01-27 00:50:47.617242 I | exec: reweighted item id 0 name 'osd.0' to 0 in crush map\r\n2018-01-27 00:50:47.617536 I | exec: Running command: ceph osd out 0 --cluster=rook --conf=/var/lib/rook/rook/rook.config --keyring=/var/lib/rook/rook/client.admin.keyring --format json --out-file /tmp/670822539\r\n2018-01-27 00:50:47.812278 I | exec: osd.0 is already out.\r\n2018-01-27 00:52:21.633123 I | util: retrying after 5s, last error: current used space and pg count for osd.0 has not decreased still\r\n2018-01-27 00:52:26.634154 I | exec: Running command: ceph osd df --cluster=rook --conf=/var/lib/rook/rook/rook.config --keyring=/var/lib/rook/rook/client.admin.keyring --format json --out-file /tmp/080145663\r\n2018-01-27 00:52:26.838957 I | util: retrying after 5s, last error: current used space and pg count for osd.0 has not decreased still\r\n2018-01-27 00:52:31.839554 I | exec: Running command: ceph osd df --cluster=rook --conf=/var/lib/rook/rook/rook.config --keyring=/var/lib/rook/rook/client.admin.keyring --format json --out-file /tmp/537463378\r\n... \r\nThe last two lines repeats for a few minutes\r\n...\r\n2018-01-27 00:52:32.030359 E | cephosd: failed to remove osd.0. failed to wait for cluster rebalancing after removing osd.0: max retries exceeded, last err: current used space and pg count for osd.0 has not decreased still\r\nfailed to remove dirs. failed to remove osd.0. failed to wait for cluster rebalancing after removing osd.0: max retries exceeded, last err: current used space and pg count for osd.0 has not decreased still\r\n```\r\n\r\nThere are some other minor issues with the upgrade that i was able to solve. Mainly around updating the manifests. But those are the ones im having trouble figuring out.",
  "closed_at": "2018-02-23T02:48:19Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 11,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/1446/comments",
  "created_at": "2018-01-27T01:02:04Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/1446/events",
  "html_url": "https://github.com/rook/rook/issues/1446",
  "id": 292075122,
  "labels": [],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/1446/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyOTIwNzUxMjI=",
  "number": 1446,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Upgrade docs does not work from v0.6.2 to master",
  "updated_at": "2018-02-23T02:48:19Z",
  "url": "https://api.github.com/repos/rook/rook/issues/1446",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1672672?v=4",
    "events_url": "https://api.github.com/users/kokhang/events{/privacy}",
    "followers_url": "https://api.github.com/users/kokhang/followers",
    "following_url": "https://api.github.com/users/kokhang/following{/other_user}",
    "gists_url": "https://api.github.com/users/kokhang/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/kokhang",
    "id": 1672672,
    "login": "kokhang",
    "node_id": "MDQ6VXNlcjE2NzI2NzI=",
    "organizations_url": "https://api.github.com/users/kokhang/orgs",
    "received_events_url": "https://api.github.com/users/kokhang/received_events",
    "repos_url": "https://api.github.com/users/kokhang/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/kokhang/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kokhang/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/kokhang"
  }
}