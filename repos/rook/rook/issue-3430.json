{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/8311215?v=4",
    "events_url": "https://api.github.com/users/rohantmp/events{/privacy}",
    "followers_url": "https://api.github.com/users/rohantmp/followers",
    "following_url": "https://api.github.com/users/rohantmp/following{/other_user}",
    "gists_url": "https://api.github.com/users/rohantmp/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rohantmp",
    "id": 8311215,
    "login": "rohantmp",
    "node_id": "MDQ6VXNlcjgzMTEyMTU=",
    "organizations_url": "https://api.github.com/users/rohantmp/orgs",
    "received_events_url": "https://api.github.com/users/rohantmp/received_events",
    "repos_url": "https://api.github.com/users/rohantmp/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rohantmp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rohantmp/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rohantmp"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/8311215?v=4",
      "events_url": "https://api.github.com/users/rohantmp/events{/privacy}",
      "followers_url": "https://api.github.com/users/rohantmp/followers",
      "following_url": "https://api.github.com/users/rohantmp/following{/other_user}",
      "gists_url": "https://api.github.com/users/rohantmp/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rohantmp",
      "id": 8311215,
      "login": "rohantmp",
      "node_id": "MDQ6VXNlcjgzMTEyMTU=",
      "organizations_url": "https://api.github.com/users/rohantmp/orgs",
      "received_events_url": "https://api.github.com/users/rohantmp/received_events",
      "repos_url": "https://api.github.com/users/rohantmp/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rohantmp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rohantmp/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rohantmp"
    }
  ],
  "author_association": "NONE",
  "body": "<!-- **Are you in the right place?**\r\n1. For issues or feature requests, please create an issue in this repository.\r\n2. For general technical and non-technical questions, we are happy to help you on our [Rook.io Slack](https://slack.rook.io/).\r\n3. Did you already search the existing open issues for anything similar? -->\r\n\r\n**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\n\r\nSetting topologyAware to true inside specs section of a cluster.yaml does not result in a cluster that has OSDs under zone or region buckets in the CRUSH map. As such, pools can be created that map replicas or EC chunks to a zone or region osd-failure-domain.\r\n\r\nOne problem is the 'zone' type is missing from the crushmap rook-ceph is feeding the cluster (see below). The secondary issue is that the osd_location is not being populated with zone and/or region buckets for each OSD.\r\n\r\n**Expected behavior:**\r\n\r\nSetting topologyAware to true inside specs section of a cluster.yaml should result in a cluster that has OSDs under zone or region buckets in the CRUSH map. Then pools cannot be created that map replicas or EC chunks to a zone or region osd-failure-domain.\r\n\r\n**How to reproduce it (minimal and precise):**\r\n\r\n1. Provision a three worker OpenShift cluster in EC2 such that each worker is in a distinct availability zone. \r\n2. Ensure cloud-provided is properly configured such that failure-domain.beta.kubernetes.io/{zone,region} labels are being properly applied to workers.\r\n3. Deploy rook-ceph and create a cluster using a cluster.yaml that contains toplogyAware set to true in the specs.\r\n4. Wait for cluster to finish provisioning\r\n5. Create toolbox pod, rsh to it, and inspect the crushmap to see missing bucket type, and absence of zone or region buckets for pods running in workers with zone/region labels.\r\n\r\n**Environment**:\r\n* OS (e.g. from /etc/os-release): Red Hat Enterprise Linux CoreOS 410.8.20190520.0 (Ootpa)\r\n* Kernel (e.g. `uname -a`): 4.18.0-80.1.2.el8_0.x86_64\r\n* Cloud provider or hardware configuration: 3x m4.large masters, 3x m5d.4xlarge workers (in distinct AZs), \r\n* Rook version (use `rook version` inside of a Rook Pod):\r\n\r\n rook: v1.0.0-187.gf0b0f0e  (f0b0f0e4f31140cc4b81453f1d918d988021db21)\r\n\r\n* Kubernetes version (use `kubectl version`):\r\n\r\nClient Version: version.Info{Major:\"1\", Minor:\"13+\", GitVersion:\"v1.13.4+cb455d664\", GitCommit:\"cb455d664\", GitTreeState:\"clean\", BuildDate:\"2019-05-19T23:03:23Z\", GoVersion:\"go1.12.1\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n\r\n* Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift):\r\n\r\nOpenShift\r\n\r\n* Storage backend status (e.g. for Ceph use `ceph health` in the [Rook Ceph toolbox](https://rook.io/docs/rook/master/ceph-toolbox.html)):\r\n\r\nHEALTH_WARN crush map has legacy tunables (require firefly, min is hammer)\r\n\r\n**Other Information**\r\n\r\nRook-ceph operator log showing rook-ceph setting initial crushmap. I think this is overriding the upstream version that has the 'zone' crush type. Compare:\r\n\r\nhttps://github.com/rook/rook/blob/1bf3cfa4bf6c19d350f6a3e02bc4846708e17898/pkg/daemon/ceph/client/crush.go#L50\r\n\r\nWith:\r\n\r\nhttps://github.com/ceph/ceph/pull/27070/files\r\n\r\n```\r\n2019-07-08 21:20:54.221869 I | op-cluster: creating initial crushmap\r\n2019-07-08 21:20:54.222002 I | exec: Running command: crushtool -c /tmp/264578157 -o /tmp/614087400\r\n2019-07-08 21:20:54.252555 I | exec: Running command: ceph osd setcrushmap -i /tmp/614087400 --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/281646887\r\n2019-07-08 21:20:55.132306 I | exec: 2\r\n2019-07-08 21:20:55.132424 I | op-cluster: created initial crushmap\r\n```\r\n\r\nCrush map on freshly created rook-ceph cluster (note the missing zone type):\r\n```\r\nsh-4.2# cat crush.txt\r\n# begin crush map\r\ntunable choose_local_tries 0\r\ntunable choose_local_fallback_tries 0\r\ntunable choose_total_tries 50\r\ntunable chooseleaf_descend_once 1\r\ntunable chooseleaf_vary_r 1\r\ntunable straw_calc_version 1\r\n\r\n# devices\r\ndevice 0 osd.0 class ssd\r\ndevice 1 osd.1 class ssd\r\ndevice 2 osd.2 class ssd\r\ndevice 3 osd.3 class ssd\r\ndevice 4 osd.4 class ssd\r\ndevice 5 osd.5 class ssd\r\n\r\n# types\r\ntype 0 osd\r\ntype 1 host\r\ntype 2 chassis\r\ntype 3 rack\r\ntype 4 row\r\ntype 5 pdu\r\ntype 6 pod\r\ntype 7 room\r\ntype 8 datacenter\r\ntype 9 region\r\ntype 10 root\r\n\r\n# buckets\r\nhost ip-10-0-139-184 {\r\n\tid -3\t\t# do not change unnecessarily\r\n\tid -4 class ssd\t\t# do not change unnecessarily\r\n\t# weight 0.545\r\n\talg straw\r\n\thash 0\t# rjenkins1\r\n\titem osd.3 weight 0.272\r\n\titem osd.0 weight 0.272\r\n}\r\nhost ip-10-0-163-134 {\r\n\tid -5\t\t# do not change unnecessarily\r\n\tid -6 class ssd\t\t# do not change unnecessarily\r\n\t# weight 0.545\r\n\talg straw\r\n\thash 0\t# rjenkins1\r\n\titem osd.2 weight 0.272\r\n\titem osd.5 weight 0.272\r\n}\r\nhost ip-10-0-144-122 {\r\n\tid -7\t\t# do not change unnecessarily\r\n\tid -8 class ssd\t\t# do not change unnecessarily\r\n\t# weight 0.545\r\n\talg straw\r\n\thash 0\t# rjenkins1\r\n\titem osd.1 weight 0.272\r\n\titem osd.4 weight 0.272\r\n}\r\nroot default {\r\n\tid -1\t\t# do not change unnecessarily\r\n\tid -2 class ssd\t\t# do not change unnecessarily\r\n\t# weight 1.635\r\n\talg straw\r\n\thash 0\t# rjenkins1\r\n\titem ip-10-0-139-184 weight 0.545\r\n\titem ip-10-0-163-134 weight 0.545\r\n\titem ip-10-0-144-122 weight 0.545\r\n}\r\n\r\n# rules\r\nrule replicated_ruleset {\r\n\tid 0\r\n\ttype replicated\r\n\tmin_size 1\r\n\tmax_size 10\r\n\tstep take default\r\n\tstep chooseleaf firstn 0 type host\r\n\tstep emit\r\n}\r\n\r\n# end crush map\r\n```\r\n\r\nExample ceph.conf from an OSD pod, note the absence of zone or region in the crush_location parameter:\r\n```\r\nsh-4.2# cat /etc/ceph/ceph.conf\r\n[global]\r\nfsid                      = 46258bc3-62c5-4c59-b06d-51e5bda56cb0\r\nrun dir                   = /var/lib/rook/osd0\r\nmon initial members       = a b c\r\nmon host                  = v1:172.30.164.205:6789,v1:172.30.201.105:6789,v1:172.30.10.98:6789\r\npublic addr               = 10.130.4.12\r\ncluster addr              = 10.130.4.12\r\nmon keyvaluedb            = rocksdb\r\nmon_allow_pool_delete     = true\r\nmon_max_pg_per_osd        = 1000\r\ndebug default             = 0\r\ndebug rados               = 0\r\ndebug mon                 = 0\r\ndebug osd                 = 0\r\ndebug bluestore           = 0\r\ndebug filestore           = 0\r\ndebug journal             = 0\r\ndebug leveldb             = 0\r\nfilestore_omap_backend    = rocksdb\r\nosd pg bits               = 11\r\nosd pgp bits              = 11\r\nosd pool default size     = 1\r\nosd pool default min size = 1\r\nosd pool default pg num   = 100\r\nosd pool default pgp num  = 100\r\nosd objectstore           = filestore\r\ncrush location            = root=default host=ip-10-0-139-184\r\nrbd_default_features      = 3\r\nfatal signal handlers     = false\r\n\r\n[osd.0]\r\nkeyring              = /var/lib/ceph/osd/ceph-0/keyring\r\nbluestore block path = /var/lib/ceph/osd/ceph-0/block\r\n```",
  "closed_at": "2019-07-22T16:19:28Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/3989526?v=4",
    "events_url": "https://api.github.com/users/BlaineEXE/events{/privacy}",
    "followers_url": "https://api.github.com/users/BlaineEXE/followers",
    "following_url": "https://api.github.com/users/BlaineEXE/following{/other_user}",
    "gists_url": "https://api.github.com/users/BlaineEXE/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/BlaineEXE",
    "id": 3989526,
    "login": "BlaineEXE",
    "node_id": "MDQ6VXNlcjM5ODk1MjY=",
    "organizations_url": "https://api.github.com/users/BlaineEXE/orgs",
    "received_events_url": "https://api.github.com/users/BlaineEXE/received_events",
    "repos_url": "https://api.github.com/users/BlaineEXE/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/BlaineEXE/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/BlaineEXE/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/BlaineEXE"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/3430/comments",
  "created_at": "2019-07-10T20:21:45Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/3430/events",
  "html_url": "https://github.com/rook/rook/issues/3430",
  "id": 466500584,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    },
    {
      "color": "ef5c55",
      "default": false,
      "description": "main ceph tag",
      "id": 479456042,
      "name": "ceph",
      "node_id": "MDU6TGFiZWw0Nzk0NTYwNDI=",
      "url": "https://api.github.com/repos/rook/rook/labels/ceph"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/3430/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-03-31T19:33:42Z",
    "closed_issues": 148,
    "created_at": "2019-03-15T19:30:30Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/3989526?v=4",
      "events_url": "https://api.github.com/users/BlaineEXE/events{/privacy}",
      "followers_url": "https://api.github.com/users/BlaineEXE/followers",
      "following_url": "https://api.github.com/users/BlaineEXE/following{/other_user}",
      "gists_url": "https://api.github.com/users/BlaineEXE/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/BlaineEXE",
      "id": 3989526,
      "login": "BlaineEXE",
      "node_id": "MDQ6VXNlcjM5ODk1MjY=",
      "organizations_url": "https://api.github.com/users/BlaineEXE/orgs",
      "received_events_url": "https://api.github.com/users/BlaineEXE/received_events",
      "repos_url": "https://api.github.com/users/BlaineEXE/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/BlaineEXE/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/BlaineEXE/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/BlaineEXE"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/rook/rook/milestone/12",
    "id": 4144795,
    "labels_url": "https://api.github.com/repos/rook/rook/milestones/12/labels",
    "node_id": "MDk6TWlsZXN0b25lNDE0NDc5NQ==",
    "number": 12,
    "open_issues": 0,
    "state": "closed",
    "title": "1.1",
    "updated_at": "2020-03-31T19:33:42Z",
    "url": "https://api.github.com/repos/rook/rook/milestones/12"
  },
  "node_id": "MDU6SXNzdWU0NjY1MDA1ODQ=",
  "number": 3430,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "topologyAware functionality not working",
  "updated_at": "2019-07-22T16:19:28Z",
  "url": "https://api.github.com/repos/rook/rook/issues/3430",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/697371?v=4",
    "events_url": "https://api.github.com/users/mmgaggle/events{/privacy}",
    "followers_url": "https://api.github.com/users/mmgaggle/followers",
    "following_url": "https://api.github.com/users/mmgaggle/following{/other_user}",
    "gists_url": "https://api.github.com/users/mmgaggle/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mmgaggle",
    "id": 697371,
    "login": "mmgaggle",
    "node_id": "MDQ6VXNlcjY5NzM3MQ==",
    "organizations_url": "https://api.github.com/users/mmgaggle/orgs",
    "received_events_url": "https://api.github.com/users/mmgaggle/received_events",
    "repos_url": "https://api.github.com/users/mmgaggle/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mmgaggle/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mmgaggle/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mmgaggle"
  }
}