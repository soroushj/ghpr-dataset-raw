{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**Description of your changes:**\r\nIn the case that SSL will be enabled for dashboard, the port used is set using the \"ssl_server_port\" ceph dashboard setting.\r\nThis setting was not present in Ceph versions previous to Nautilus(#27393), so the implementation discard the error produced when trying to write this value in older versions. In this case the SSL port will be the one specified in \"server_port\".\r\nBoth dashboards settings ( ssl_server_port/server_port ) are set with the **port** value specified in the dashboard section of the cluster CRD.\r\n\r\n**Which issue is resolved by this Pull Request:**\r\nResolves #3603\r\n\r\n**Verification of the fix:**\r\n\r\nSet dashboard port to a non default value in cluster.yaml:\r\n```\r\n...\r\ndashboard:\r\n  enabled: true\r\n  # serve the dashboard under a subpath (useful when you are accessing the dashboard via a reverse proxy)\r\n  urlPrefix: /ceph-dashboard\r\n  # serve the dashboard at the given port.\r\n  port: 8445\r\n  # serve the dashboard using SSL\r\n  ssl: true\r\n...\r\n```\r\nOnce the cluster is created:\r\n\r\nCheck related Log lines in the Rook Operator pod:\r\n\r\n```\r\n2019-08-14 17:09:12.808299 I | exec: Running command: ceph mgr module enable dashboard --force --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/262191180\r\n2019-08-14 17:09:18.939990 I | exec: Running command: ceph dashboard create-self-signed-cert --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/484479803\r\n2019-08-14 17:09:19.543384 I | op-mgr: Running command: ceph dashboard set-login-credentials admin *******\r\n2019-08-14 17:09:20.281589 I | op-mgr: restarting the mgr module\r\n2019-08-14 17:09:20.281690 I | exec: Running command: ceph mgr module disable dashboard --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/089754405\r\n2019-08-14 17:09:21.323202 I | exec: Running command: ceph mgr module enable dashboard --force --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/236030016\r\n2019-08-14 17:09:22.393351 I | exec: Running command: ceph config get mgr.a mgr/dashboard/url_prefix --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/037852319\r\n2019-08-14 17:09:22.872998 I | exec: Running command: ceph config set mgr.a mgr/dashboard/url_prefix /ceph-dashboard --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/809455986\r\n2019-08-14 17:09:23.435618 I | exec: Running command: ceph config get mgr.a mgr/dashboard/ssl --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/267975209\r\n2019-08-14 17:09:23.911901 I | exec: Running command: ceph config set mgr.a mgr/dashboard/ssl true --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/454639476\r\n2019-08-14 17:09:24.453451 I | exec: Running command: ceph config get mgr.a mgr/dashboard/server_port --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/730007107\r\n2019-08-14 17:09:24.961406 I | exec: Running command: ceph config set mgr.a mgr/dashboard/server_port 8445 --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/334702790\r\n2019-08-14 17:09:25.434801 I | exec: Running command: ceph config get mgr.a mgr/dashboard/ssl_server_port --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/161629549\r\n2019-08-14 17:09:25.961053 I | exec: Running command: ceph config set mgr.a mgr/dashboard/ssl_server_port 8445 --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/730567144\r\n2019-08-14 17:09:26.413194 I | op-mgr: dashboard config has changed\r\n2019-08-14 17:09:26.413211 I | op-mgr: restarting the mgr module\r\n2019-08-14 17:09:26.413280 I | exec: Running command: ceph mgr module disable dashboard --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/522386983\r\n2019-08-14 17:09:27.823226 I | exec: Running command: ceph mgr module enable dashboard --force --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/861806426\r\n2019-08-14 17:09:28.967982 I | op-mgr: dashboard service started\r\n\r\n```\r\nCheck the related Log lines in the Ceph Manager pod:\r\n\r\n```\r\n[14/Aug/2019:17:09:25] ENGINE Bus STARTING\r\nCherryPy Checker:\r\nThe Application mounted at '' has an empty config.\r\ndebug 2019-08-14 17:09:25.686 7f660d425700  1 mgr[restful] server not running: no certificate configured\r\n[14/Aug/2019:17:09:25] ENGINE Started monitor thread '_TimeoutMonitor'.\r\n[14/Aug/2019:17:09:25] ENGINE Bus STARTING\r\n[14/Aug/2019:17:09:25] ENGINE Started monitor thread '_TimeoutMonitor'.\r\n[14/Aug/2019:17:09:25] ENGINE Serving on :::9283\r\n[14/Aug/2019:17:09:25] ENGINE Bus STARTED\r\n[14/Aug/2019:17:09:26] ENGINE Serving on :::8443   <------------  DEFAULT SSL PORT \r\n[14/Aug/2019:17:09:26] ENGINE Bus STARTED\r\n\r\n...\r\n\r\n[14/Aug/2019:17:09:34] ENGINE Bus STARTING\r\nCherryPy Checker:\r\nThe Application mounted at '' has an empty config.\r\ndebug 2019-08-14 17:09:34.466 7f055c7f1700  1 mgr[restful] server not running: no certificate configured\r\n[14/Aug/2019:17:09:34] ENGINE Started monitor thread '_TimeoutMonitor'.\r\n[14/Aug/2019:17:09:34] ENGINE Bus STARTING\r\n[14/Aug/2019:17:09:34] ENGINE Started monitor thread '_TimeoutMonitor'.\r\n[14/Aug/2019:17:09:34] ENGINE Serving on :::9283\r\n[14/Aug/2019:17:09:34] ENGINE Bus STARTED\r\n[14/Aug/2019:17:09:34] ENGINE Serving on :::8445  <------------------  SSL PORT CHANGED\r\n[14/Aug/2019:17:09:34] ENGINE Bus STARTED\r\n```\r\n\r\nPorts used by the Ceph manager Pod\r\n```\r\n$ kubectl -n rook-ceph describe pod rook-ceph-mgr-a-d44c5c5b5-pj5pv\r\n \r\n Name:               rook-ceph-mgr-a-d44c5c5b5-pj5pv\r\n Namespace:          rook-ceph\r\n ...\r\n Labels:             app=rook-ceph-mgr\r\n ...\r\n \r\nContainers:\r\n  mgr:\r\n    Container ID:  docker://e6dc97ae526c1033ab2155886e13aa2dcf74e8697680b0558b27ed8748072556\r\n    Image:         ceph/ceph:v14.2.2-20190722\r\n    Image ID:      docker-pullable://docker.io/ceph/ceph@sha256:43d62cfba07ef79b66068c53346be8e6fe2d21cf22c7ac3cdd967a188b4d5c7f\r\n    Ports:         6800/TCP, 9283/TCP, 8445/TCP\r\n...\r\n\r\n```\r\n\r\nServices exposed: (created with \"dashboard-external-https.yaml\" using port 8445)\r\n\r\n```\r\n$ kubectl -n rook-ceph get services -l app=rook-ceph-mgr\r\nNAME                                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\r\nrook-ceph-mgr                            ClusterIP   10.110.57.19     <none>        9283/TCP         17m\r\nrook-ceph-mgr-dashboard                  ClusterIP   10.109.200.207   <none>        8445/TCP         17m\r\nrook-ceph-mgr-dashboard-external-https   NodePort    10.104.37.20     <none>        8445:31050/TCP   4m12s\r\n```\r\n\r\n\r\n\r\n\r\n**Checklist:**\r\n\r\n- [ x ] Reviewed the developer guide on [Submitting a Pull Request](https://rook.io/docs/rook/master/development-flow.html#submitting-a-pull-request)\r\n- [ ] Documentation has been updated, if necessary.\r\n- [ ] Unit tests have been added, if necessary.\r\n- [ ] Integration tests have been added, if necessary.\r\n- [ ] Pending release notes updated with breaking and/or notable changes, if necessary.\r\n- [ ] Upgrade from previous release is tested and upgrade user guide is updated, if necessary.\r\n- [ ] Code generation (`make codegen`) has been run to update object specifications, if necessary.\r\n- [ ] Comments have been added or updated based on the standards set in [CONTRIBUTING.md](https://github.com/rook/rook/blob/master/CONTRIBUTING.md#comments)\r\n- [ ] Add the flag for skipping the CI if this PR does not require a build. See [here](https://github.com/rook/rook/blob/master/INSTALL.md#skip-ci) for more details.\r\n\r\nSigned-off-by: Juan Miguel Olmo Mart\u00ednez <jolmomar@redhat.com>",
  "closed_at": "2019-09-12T07:52:45Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/912735?v=4",
    "events_url": "https://api.github.com/users/leseb/events{/privacy}",
    "followers_url": "https://api.github.com/users/leseb/followers",
    "following_url": "https://api.github.com/users/leseb/following{/other_user}",
    "gists_url": "https://api.github.com/users/leseb/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/leseb",
    "id": 912735,
    "login": "leseb",
    "node_id": "MDQ6VXNlcjkxMjczNQ==",
    "organizations_url": "https://api.github.com/users/leseb/orgs",
    "received_events_url": "https://api.github.com/users/leseb/received_events",
    "repos_url": "https://api.github.com/users/leseb/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/leseb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leseb/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/leseb"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/3626/comments",
  "created_at": "2019-08-14T17:51:43Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/3626/events",
  "html_url": "https://github.com/rook/rook/pull/3626",
  "id": 480808194,
  "labels": [
    {
      "color": "ad0036",
      "default": false,
      "description": "",
      "id": 1381158621,
      "name": "ceph-dashboard",
      "node_id": "MDU6TGFiZWwxMzgxMTU4NjIx",
      "url": "https://api.github.com/repos/rook/rook/labels/ceph-dashboard"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/3626/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MzA3NDMyOTI3",
  "number": 3626,
  "performed_via_github_app": null,
  "pull_request": {
    "diff_url": "https://github.com/rook/rook/pull/3626.diff",
    "html_url": "https://github.com/rook/rook/pull/3626",
    "patch_url": "https://github.com/rook/rook/pull/3626.patch",
    "url": "https://api.github.com/repos/rook/rook/pulls/3626"
  },
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Set \"ssl_server_port\" dashboard setting if it is present in ceph dashboard config",
  "updated_at": "2019-09-16T08:09:24Z",
  "url": "https://api.github.com/repos/rook/rook/issues/3626",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/1820049?v=4",
    "events_url": "https://api.github.com/users/jmolmo/events{/privacy}",
    "followers_url": "https://api.github.com/users/jmolmo/followers",
    "following_url": "https://api.github.com/users/jmolmo/following{/other_user}",
    "gists_url": "https://api.github.com/users/jmolmo/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jmolmo",
    "id": 1820049,
    "login": "jmolmo",
    "node_id": "MDQ6VXNlcjE4MjAwNDk=",
    "organizations_url": "https://api.github.com/users/jmolmo/orgs",
    "received_events_url": "https://api.github.com/users/jmolmo/received_events",
    "repos_url": "https://api.github.com/users/jmolmo/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jmolmo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jmolmo/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jmolmo"
  }
}