{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "When the `CephCluster` is 'applied' to the cluster it will cause the operator/manager to restart even when nothing has changed.  This seems to be directly related to the use of the `resources` section in the `CephCluster`\r\n\r\nSee [this slack thread](https://rook-io.slack.com/archives/C46Q5UC05/p1570908861035300) for the same report from another user.\r\n\r\n[clusterChanged()](https://github.com/rook/rook/blob/master/pkg/operator/ceph/cluster/cluster.go#L328) was pointed out as suspect from the slack thread.\r\n\r\n**Deviation from expected behavior:**\r\n\r\nUpon 'applying' an unchanged `CephCluster`, the operator detects a change and restarts.\r\n\r\n**Expected behavior:**\r\n\r\nUpon 'applying' an unchanged `CephCluster`, the operator should not detect a change and not restart.\r\n\r\n**How to reproduce it (minimal and precise):**\r\n\r\nConsider [this CephCluster definition](https://github.com/billimek/k8s-gitops/blob/6503566bc6d6a68929f048db84c43e46ac4eed1d/rook-ceph/cluster/cluster.yaml#L20-L50) with the `resources` section defined.  Subsequent 'applications' of the `cluster.yaml` file will cause the operator to restart.\r\n\r\nRemove the `resources` section and the same repeated applications of the `cluster.yaml` file will not cause the operator to restart.\r\n\r\nThis reoccurring 'application' of the `CephCluster` is going to be common when using something like Flux for gitops based operations of the cluster.\r\n\r\n**File(s) to submit**:\r\n\r\n* [cluster.yaml](https://github.com/billimek/k8s-gitops/blob/6503566bc6d6a68929f048db84c43e46ac4eed1d/rook-ceph/cluster/cluster.yaml#L20-L50)\r\n* Operator's log snippet when this occurs:\r\n\r\nThe line of interest is `op-cluster: The Cluster CR has changed. diff=`\r\n\r\n```\r\n2019-10-28 01:55:16.094198 I | op-k8sutil: finished waiting for updated deployment rook-ceph-osd-0                                                                                                                                                                                                       [336/97664]\r\n2019-10-28 01:55:16.094228 I | op-mon: this is not an upgrade, not performing upgrade checks\r\n2019-10-28 01:55:16.094235 I | op-osd: started deployment for osd 0 (dir=false, type=)\r\n2019-10-28 01:55:16.098893 I | op-osd: 4/4 node(s) completed osd provisioning\r\n2019-10-28 01:55:16.099036 I | op-osd: checking if any nodes were removed\r\n2019-10-28 01:55:16.107536 I | op-osd: processing 0 removed nodes\r\n2019-10-28 01:55:16.107564 I | op-osd: done processing removed nodes\r\n2019-10-28 01:55:16.107681 I | exec: Running command: ceph versions --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/225580520\r\n2019-10-28 01:55:17.491459 I | exec: Running command: ceph osd require-osd-release nautilus --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/956139559\r\n2019-10-28 01:55:18.616953 I | cephclient: successfully disallowed pre-nautilus osds and enabled all new nautilus-only functionality\r\n2019-10-28 01:55:18.616982 I | op-osd: completed running osds in namespace rook-ceph\r\n2019-10-28 01:55:18.616994 I | rbd-mirror: configure rbd-mirroring with 0 workers\r\n2019-10-28 01:55:18.619631 I | rbd-mirror: no extra daemons to remove\r\n2019-10-28 01:55:18.619726 I | op-cluster: Done creating rook instance in namespace rook-ceph\r\n2019-10-28 01:55:18.619754 I | op-cluster: CephCluster rook-ceph status: Created.\r\n2019-10-28 01:55:18.624416 I | op-cluster: succeeded updating cluster in namespace rook-ceph\r\n2019-10-28 01:55:18.625011 I | op-cluster: The Cluster CR has changed. diff=\r\n2019-10-28 01:55:18.625107 I | op-cluster: update event for cluster rook-ceph is supported, orchestrating update now\r\n2019-10-28 01:55:18.625276 I | exec: Running command: ceph versions --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/901946714\r\n2019-10-28 01:55:19.924101 I | op-cluster: ceph daemons running versions are: {Mon:map[ceph version 14.2.4 (75f4de193b3ea58512f204623e6c5a16e6c1e1ba) nautilus (stable):3] Mgr:map[ceph version 14.2.4 (75f4de193b3ea58512f204623e6c5a16e6c1e1ba) nautilus (stable):1] Osd:map[ceph version 14.2.4 (75f4de193b3ea585\r\n12f204623e6c5a16e6c1e1ba) nautilus (stable):4] Rgw:map[] Mds:map[ceph version 14.2.4 (75f4de193b3ea58512f204623e6c5a16e6c1e1ba) nautilus (stable):2] RbdMirror:map[] Overall:map[ceph version 14.2.4 (75f4de193b3ea58512f204623e6c5a16e6c1e1ba) nautilus (stable):10]}\r\n2019-10-28 01:55:19.924133 I | op-cluster: CephCluster rook-ceph status: Updating.\r\n2019-10-28 01:55:19.932177 I | op-mon: start running mons\r\n2019-10-28 01:55:19.935139 I | op-mon: parsing mon endpoints: a=10.43.123.157:6789,b=10.43.58.70:6789,c=10.43.82.142:6789\r\n```\r\n\r\nWhen the `resources` section is removed, the same operator log without restarting every application of `CephCluster` (a 'good' log) in the same part of operation looks like this:\r\n\r\n```\r\n2019-10-28 01:58:03.055308 I | op-k8sutil: finished waiting for updated deployment rook-ceph-osd-0                                                                                                                                                                                                        [40/97664]\r\n2019-10-28 01:58:03.055326 I | op-mon: this is not an upgrade, not performing upgrade checks\r\n2019-10-28 01:58:03.055331 I | op-osd: started deployment for osd 0 (dir=false, type=)\r\n2019-10-28 01:58:03.060282 I | op-osd: 4/4 node(s) completed osd provisioning\r\n2019-10-28 01:58:03.060374 I | op-osd: checking if any nodes were removed\r\n2019-10-28 01:58:03.067371 I | op-osd: processing 0 removed nodes\r\n2019-10-28 01:58:03.067387 I | op-osd: done processing removed nodes\r\n2019-10-28 01:58:03.067453 I | exec: Running command: ceph versions --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/145145053\r\n2019-10-28 01:58:03.620637 I | exec: Running command: ceph osd require-osd-release nautilus --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/125949592\r\n2019-10-28 01:58:04.207432 I | cephclient: successfully disallowed pre-nautilus osds and enabled all new nautilus-only functionality\r\n2019-10-28 01:58:04.207460 I | op-osd: completed running osds in namespace rook-ceph\r\n2019-10-28 01:58:04.207468 I | rbd-mirror: configure rbd-mirroring with 0 workers\r\n2019-10-28 01:58:04.210097 I | rbd-mirror: no extra daemons to remove\r\n2019-10-28 01:58:04.210113 I | op-cluster: Done creating rook instance in namespace rook-ceph\r\n2019-10-28 01:58:04.210122 I | op-cluster: CephCluster rook-ceph status: Created.\r\n2019-10-28 01:58:04.214446 I | op-pool: start watching clusters in all namespaces\r\n2019-10-28 01:58:04.214476 I | op-object: start watching object store resources in namespace rook-ceph\r\n2019-10-28 01:58:04.214484 I | op-object: start watching object store user resources in namespace rook-ceph\r\n2019-10-28 01:58:04.214489 I | op-bucket-prov: Ceph Bucket Provisioner launched\r\n2019-10-28 01:58:04.215380 I | op-file: start watching filesystem resource in namespace rook-ceph\r\n2019-10-28 01:58:04.215389 I | op-nfs: start watching ceph nfs resource in namespace rook-ceph\r\n2019-10-28 01:58:04.215399 I | op-cluster: ceph status check interval is 60s\r\n```\r\n\r\n**Environment**:\r\n* OS (e.g. from /etc/os-release): Ubuntu 19.10\r\n* Kernel (e.g. `uname -a`): 5.3.0-19\r\n* Cloud provider or hardware configuration: bare metal\r\n* Rook version (use `rook version` inside of a Rook Pod): v1.1.4\r\n* Storage backend version (e.g. for ceph do `ceph -v`): 14.2.4\r\n* Kubernetes version (use `kubectl version`): v1.16.2-k3s.1\r\n* Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift): k3s\r\n* Storage backend status (e.g. for Ceph use `ceph health` in the [Rook Ceph toolbox](https://rook.io/docs/rook/master/ceph-toolbox.html)): HEALTH_OK\r\n",
  "closed_at": "2019-11-05T11:37:27Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/912735?v=4",
    "events_url": "https://api.github.com/users/leseb/events{/privacy}",
    "followers_url": "https://api.github.com/users/leseb/followers",
    "following_url": "https://api.github.com/users/leseb/following{/other_user}",
    "gists_url": "https://api.github.com/users/leseb/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/leseb",
    "id": 912735,
    "login": "leseb",
    "node_id": "MDQ6VXNlcjkxMjczNQ==",
    "organizations_url": "https://api.github.com/users/leseb/orgs",
    "received_events_url": "https://api.github.com/users/leseb/received_events",
    "repos_url": "https://api.github.com/users/leseb/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/leseb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leseb/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/leseb"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/4201/comments",
  "created_at": "2019-10-28T03:27:27Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/4201/events",
  "html_url": "https://github.com/rook/rook/issues/4201",
  "id": 513077299,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/4201/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MTMwNzcyOTk=",
  "number": 4201,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "operator restarts the manager if the crd is \"applied\" even if nothing is changed",
  "updated_at": "2019-11-05T11:37:27Z",
  "url": "https://api.github.com/repos/rook/rook/issues/4201",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/6393612?v=4",
    "events_url": "https://api.github.com/users/billimek/events{/privacy}",
    "followers_url": "https://api.github.com/users/billimek/followers",
    "following_url": "https://api.github.com/users/billimek/following{/other_user}",
    "gists_url": "https://api.github.com/users/billimek/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/billimek",
    "id": 6393612,
    "login": "billimek",
    "node_id": "MDQ6VXNlcjYzOTM2MTI=",
    "organizations_url": "https://api.github.com/users/billimek/orgs",
    "received_events_url": "https://api.github.com/users/billimek/received_events",
    "repos_url": "https://api.github.com/users/billimek/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/billimek/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/billimek/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/billimek"
  }
}