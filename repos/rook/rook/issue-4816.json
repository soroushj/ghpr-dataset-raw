{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/912735?v=4",
    "events_url": "https://api.github.com/users/leseb/events{/privacy}",
    "followers_url": "https://api.github.com/users/leseb/followers",
    "following_url": "https://api.github.com/users/leseb/following{/other_user}",
    "gists_url": "https://api.github.com/users/leseb/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/leseb",
    "id": 912735,
    "login": "leseb",
    "node_id": "MDQ6VXNlcjkxMjczNQ==",
    "organizations_url": "https://api.github.com/users/leseb/orgs",
    "received_events_url": "https://api.github.com/users/leseb/received_events",
    "repos_url": "https://api.github.com/users/leseb/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/leseb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leseb/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/leseb"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars3.githubusercontent.com/u/912735?v=4",
      "events_url": "https://api.github.com/users/leseb/events{/privacy}",
      "followers_url": "https://api.github.com/users/leseb/followers",
      "following_url": "https://api.github.com/users/leseb/following{/other_user}",
      "gists_url": "https://api.github.com/users/leseb/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/leseb",
      "id": 912735,
      "login": "leseb",
      "node_id": "MDQ6VXNlcjkxMjczNQ==",
      "organizations_url": "https://api.github.com/users/leseb/orgs",
      "received_events_url": "https://api.github.com/users/leseb/received_events",
      "repos_url": "https://api.github.com/users/leseb/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/leseb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leseb/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/leseb"
    }
  ],
  "author_association": "NONE",
  "body": "<!-- **Are you in the right place?**\r\n1. For issues or feature requests, please create an issue in this repository.\r\n2. For general technical and non-technical questions, we are happy to help you on our [Rook.io Slack](https://slack.rook.io/).\r\n3. Did you already search the existing open issues for anything similar? -->\r\n\r\n**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\n\r\nRook release 1.2.3 contains fix: Ceph external cluster repeatedly saving mon endpoints to config (#4717, @eliaswimmer), https://github.com/rook/rook/issues/4717\r\n\r\nIt seems that this fix is faulty as now the `rook-ceph-csi-config` is not populated with cluster details at all.\r\n\r\nAfter external cluster creation `rook-ceph-csi-config` configmap is empty:\r\n\r\n```\r\n$ kubectl get configmap rook-ceph-csi-config -n rook-ceph -o yaml\r\n\r\napiVersion: v1\r\ndata:\r\n  csi-cluster-config-json: '[]'\r\nkind: ConfigMap\r\nmetadata:\r\n  creationTimestamp: \"2020-02-05T09:41:11Z\"\r\n  name: rook-ceph-csi-config\r\n  namespace: rook-ceph\r\n  resourceVersion: \"78305\"\r\n  selfLink: /api/v1/namespaces/rook-ceph/configmaps/rook-ceph-csi-config\r\n  uid: a50dfd04-47fb-11ea-9bd2-0a277de75380\r\n```\r\n\r\n**Expected behavior:**\r\n\r\n`rook-ceph-csi-config` configmap should contain cluster details:\r\n\r\n```\r\n$ kubectl get configmap rook-ceph-csi-config -n rook-ceph -o yaml\r\n\r\napiVersion: v1\r\ndata:\r\n  csi-cluster-config-json: '[{\"clusterID\":\"qa-rook-ceph-eu-central-1-2\",\"monitors\":[\"10.128.26.213:6789\",\"10.128.24.74:6789\",\"10.128.25.208:6789\"]}]'\r\nkind: ConfigMap\r\nmetadata:\r\n  creationTimestamp: \"2020-02-05T08:52:21Z\"\r\n  name: rook-ceph-csi-config\r\n  namespace: rook-ceph\r\n  resourceVersion: \"64065\"\r\n  selfLink: /api/v1/namespaces/rook-ceph/configmaps/rook-ceph-csi-config\r\n  uid: d298fef6-47f4-11ea-9b62-02f92bc8e970\r\n```\r\n\r\n**How to reproduce it (minimal and precise):**\r\n<!-- Please let us know any circumstances for reproduction of your bug. -->\r\n\r\nConnect to one external cluster using Rook 1.2.3. Check `rook-ceph-csi-config` configmap and notice that it does not contain cluster details (`kubectl get configmap rook-ceph-csi-config -o yaml -n rook-ceph`). \r\n\r\nDelete `rook-ceph-csi-config` configmap, edit `rook-ceph-operator` deployment and change Rook version to 1.2.2. \r\n\r\n```\r\nkubectl delete configmap rook-ceph-csi-config -n rook-ceph\r\nkubectl edit deployment rook-ceph-operator -n rook-ceph\r\n```\r\n\r\nCheck `rook-ceph-csi-config` configmap and notice that it contains cluster details.\r\n\r\n```\r\nkubectl get configmap rook-ceph-csi-config -o yaml -n rook-ceph\r\n```\r\n\r\n**File(s) to submit**:\r\n\r\n`rook-ceph-operator` log with Rook 1.2.3:\r\n\r\n```\r\n2020-02-05 10:43:16.711849 I | op-cluster: starting cluster in namespace qa-rook-ceph-eu-central-1-2\r\n2020-02-05 10:43:16.724871 W | ceph-csi: CSI Filesystem volume expansion requires Kubernetes version >=1.15.0\r\n2020-02-05 10:43:16.725006 W | ceph-csi: CSI Block volume expansion requires Kubernetes version >=1.16.0\r\n2020-02-05 10:43:17.014693 I | ceph-csi: CSIDriver object created for driver \"rook-ceph.rbd.csi.ceph.com\"\r\n2020-02-05 10:43:17.100176 I | ceph-csi: CSIDriver object created for driver \"rook-ceph.cephfs.csi.ceph.com\"\r\n2020-02-05 10:43:17.100209 I | operator: successfully started Ceph CSI driver(s)\r\n2020-02-05 10:43:17.100226 I | op-cluster: CephCluster \"qa-rook-ceph-eu-central-1-2\" status: \"Connecting\".\r\n2020-02-05 10:43:17.175409 I | op-mon: parsing mon endpoints: b=10.128.24.74:6789,c=10.128.25.208:6789,a=10.128.26.213:6789\r\n2020-02-05 10:43:17.175505 I | op-mon: loaded: maxMonID=-1, mons=map[c:0xc000c0a800 a:0xc000c0a880 b:0xc000c0a780], mapping=&{Node:map[]}\r\n2020-02-05 10:43:17.175531 I | op-cluster: found the cluster info to connect to the external cluster. mons=map[c:0xc000c0a800 a:0xc000c0a880 b:0xc000c0a780]\r\n2020-02-05 10:43:17.175538 I | op-cluster: detecting the ceph image version for image ceph/ceph:v14.2.6...\r\n2020-02-05 10:43:17.307867 I | operator: starting the controller-runtime manager\r\n2020-02-05 10:43:20.766341 I | op-cluster: Detected ceph image version: \"14.2.6-0 nautilus\"\r\n2020-02-05 10:43:20.771479 I | op-mon: parsing mon endpoints: b=10.128.24.74:6789,c=10.128.25.208:6789,a=10.128.26.213:6789\r\n2020-02-05 10:43:20.771547 I | op-mon: loaded: maxMonID=-1, mons=map[c:0xc0011bd640 a:0xc0011bd680 b:0xc0011bd600], mapping=&{Node:map[]}\r\n2020-02-05 10:43:20.772192 I | cephconfig: writing config file /var/lib/rook/qa-rook-ceph-eu-central-1-2/qa-rook-ceph-eu-central-1-2.config\r\n2020-02-05 10:43:20.772302 I | cephconfig: generated admin config in /var/lib/rook/qa-rook-ceph-eu-central-1-2\r\n2020-02-05 10:43:20.772442 I | exec: Running command: ceph version --connect-timeout=15 --cluster=qa-rook-ceph-eu-central-1-2 --conf=/var/lib/rook/qa-rook-ceph-eu-central-1-2/qa-rook-ceph-eu-central-1-2.config --keyring=/var/lib/rook/qa-rook-ceph-eu-central-1-2/client.admin.keyring --format json --out-file /tmp/491521506\r\n2020-02-05 10:43:21.429748 I | exec: Running command: ceph versions --connect-timeout=15 --cluster=qa-rook-ceph-eu-central-1-2 --conf=/var/lib/rook/qa-rook-ceph-eu-central-1-2/qa-rook-ceph-eu-central-1-2.config --keyring=/var/lib/rook/qa-rook-ceph-eu-central-1-2/client.admin.keyring --format json --out-file /tmp/067997145\r\n2020-02-05 10:43:22.020242 I | op-cluster: cluster \"qa-rook-ceph-eu-central-1-2\": version \"14.2.6-0 nautilus\" detected for image \"ceph/ceph:v14.2.6\"\r\n2020-02-05 10:43:22.030466 I | op-cluster: creating 'rook-ceph-config' configmap.\r\n2020-02-05 10:43:22.036338 I | op-cluster: cluster identity established.\r\n2020-02-05 10:43:22.036356 I | op-cluster: CephCluster \"qa-rook-ceph-eu-central-1-2\" status: \"Connected\".\r\n```\r\n\r\n`rook-ceph-operator` log with Rook 1.2.2:\r\n\r\n```\r\n2020-02-05 10:35:11.501960 I | op-cluster: starting cluster in namespace qa-rook-ceph-eu-central-1-2\r\n2020-02-05 10:35:11.622557 I | ceph-csi: CSIDriver object created for driver \"rook-ceph.rbd.csi.ceph.com\"\r\n2020-02-05 10:35:11.654378 I | ceph-csi: CSIDriver object created for driver \"rook-ceph.cephfs.csi.ceph.com\"\r\n2020-02-05 10:35:11.654399 I | operator: successfully started Ceph CSI driver(s)\r\n2020-02-05 10:35:11.654426 I | op-cluster: CephCluster \"qa-rook-ceph-eu-central-1-2\" status: \"Connecting\".\r\n2020-02-05 10:35:11.684887 I | op-mon: parsing mon endpoints: a=10.128.26.213:6789,b=10.128.24.74:6789,c=10.128.25.208:6789\r\n2020-02-05 10:35:11.685513 I | op-mon: loaded: maxMonID=-1, mons=map[c:0xc0009e3b40 a:0xc0009e3ac0 b:0xc0009e3b00], mapping=&{Node:map[]}\r\n2020-02-05 10:35:11.685665 I | op-cluster: found the cluster info to connect to the external cluster. mons=map[b:0xc0009e3b00 c:0xc0009e3b40 a:0xc0009e3ac0]\r\n2020-02-05 10:35:11.685755 I | op-cluster: detecting the ceph image version for image ceph/ceph:v14.2.6...\r\n2020-02-05 10:35:12.096614 I | operator: starting the controller-runtime manager\r\n2020-02-05 10:35:16.488334 I | op-cluster: Detected ceph image version: \"14.2.6-0 nautilus\"\r\n2020-02-05 10:35:16.501942 I | op-mon: parsing mon endpoints: a=10.128.26.213:6789,b=10.128.24.74:6789,c=10.128.25.208:6789\r\n2020-02-05 10:35:16.502031 I | op-mon: loaded: maxMonID=-1, mons=map[b:0xc0011a2e80 c:0xc0011a2ec0 a:0xc0011a2e40], mapping=&{Node:map[]}\r\n2020-02-05 10:35:16.502409 I | cephconfig: writing config file /var/lib/rook/qa-rook-ceph-eu-central-1-2/qa-rook-ceph-eu-central-1-2.config\r\n2020-02-05 10:35:16.502507 I | cephconfig: generated admin config in /var/lib/rook/qa-rook-ceph-eu-central-1-2\r\n2020-02-05 10:36:05.473278 I | op-mon: ClusterInfo is now Empty, refilling it from status.MonMap.Mons\r\n2020-02-05 10:36:05.473303 I | op-mon: new external mon a found: 10.128.26.213:6789, adding it\r\n2020-02-05 10:36:05.473311 I | op-mon: new external mon b found: 10.128.24.74:6789, adding it\r\n2020-02-05 10:36:05.473317 I | op-mon: new external mon c found: 10.128.25.208:6789, adding it\r\n2020-02-05 10:36:05.493051 I | op-mon: saved mon endpoints to config map map[mapping:{\"node\":{}} csi-cluster-config-json:[{\"clusterID\":\"qa-rook-ceph-eu-central-1-2\",\"monitors\":[\"10.128.26.213:6789\",\"10.128.24.74:6789\",\"10.128.25.208:6789\"]}] data:a=10.128.26.213:6789,b=10.128.24.74:6789,c=10.128.25.208:6789 maxMonId:-1]\r\n2020-02-05 10:36:05.501803 I | cephconfig: writing config file /var/lib/rook/qa-rook-ceph-eu-central-1-2/qa-rook-ceph-eu-central-1-2.config\r\n2020-02-05 10:36:05.502062 I | cephconfig: generated admin config in /var/lib/rook/qa-rook-ceph-eu-central-1-2\r\n```\r\n\r\nAs you can see, log row `saved mon endpoints to config map` is missing from 1.2.3 log.\r\n\r\n**Environment**:\r\n* OS (e.g. from /etc/os-release): Amazon Linux 2\r\n* Kernel (e.g. `uname -a`): 4.19.84-33.70.amzn2.x86_64\r\n* Cloud provider or hardware configuration: AWS\r\n* Rook version (use `rook version` inside of a Rook Pod): rook: v1.1.2\r\n* Storage backend version (e.g. for ceph do `ceph -v`): ceph version 14.2.6 (f0aa067ac7a02ee46ea48aa26c6e298b5ea272e9) nautilus (stable)\r\n* Kubernetes version (use `kubectl version`):\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v1.16.2\", GitCommit:\"c97fe5036ef3df2967d086711e6c0c405941e14b\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T23:41:55Z\", GoVersion:\"go1.12.10\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\n```\r\n\r\n```\r\nServer Version: version.Info{Major:\"1\", Minor:\"14+\", GitVersion:\"v1.14.9-eks-c0eccc\", GitCommit:\"c0eccca51d7500bb03b2f163dd8d534ffeb2f7a2\", GitTreeState:\"clean\", BuildDate:\"2019-12-22T23:14:11Z\", GoVersion:\"go1.12.12\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n\r\n* Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift): AWS EKS\r\n* Storage backend status (e.g. for Ceph use `ceph health` in the [Rook Ceph toolbox](https://rook.io/docs/rook/master/ceph-toolbox.html)): HEALTH_OK\r\n",
  "closed_at": "2020-02-12T18:36:12Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/4816/comments",
  "created_at": "2020-02-05T10:54:03Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/4816/events",
  "html_url": "https://github.com/rook/rook/issues/4816",
  "id": 560291880,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    },
    {
      "color": "ef5c55",
      "default": false,
      "description": "main ceph tag",
      "id": 479456042,
      "name": "ceph",
      "node_id": "MDU6TGFiZWw0Nzk0NTYwNDI=",
      "url": "https://api.github.com/repos/rook/rook/labels/ceph"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/4816/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-09-11T22:42:52Z",
    "closed_issues": 65,
    "created_at": "2019-08-22T12:51:15Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/912735?v=4",
      "events_url": "https://api.github.com/users/leseb/events{/privacy}",
      "followers_url": "https://api.github.com/users/leseb/followers",
      "following_url": "https://api.github.com/users/leseb/following{/other_user}",
      "gists_url": "https://api.github.com/users/leseb/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/leseb",
      "id": 912735,
      "login": "leseb",
      "node_id": "MDQ6VXNlcjkxMjczNQ==",
      "organizations_url": "https://api.github.com/users/leseb/orgs",
      "received_events_url": "https://api.github.com/users/leseb/received_events",
      "repos_url": "https://api.github.com/users/leseb/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/leseb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leseb/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/leseb"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/rook/rook/milestone/13",
    "id": 4594913,
    "labels_url": "https://api.github.com/repos/rook/rook/milestones/13/labels",
    "node_id": "MDk6TWlsZXN0b25lNDU5NDkxMw==",
    "number": 13,
    "open_issues": 0,
    "state": "closed",
    "title": "1.2",
    "updated_at": "2020-09-18T21:21:55Z",
    "url": "https://api.github.com/repos/rook/rook/milestones/13"
  },
  "node_id": "MDU6SXNzdWU1NjAyOTE4ODA=",
  "number": 4816,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "External cluster details are not populated to configmap rook-ceph-csi-config ",
  "updated_at": "2020-02-17T22:11:36Z",
  "url": "https://api.github.com/repos/rook/rook/issues/4816",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/10357747?v=4",
    "events_url": "https://api.github.com/users/mattirantakomi/events{/privacy}",
    "followers_url": "https://api.github.com/users/mattirantakomi/followers",
    "following_url": "https://api.github.com/users/mattirantakomi/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattirantakomi/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/mattirantakomi",
    "id": 10357747,
    "login": "mattirantakomi",
    "node_id": "MDQ6VXNlcjEwMzU3NzQ3",
    "organizations_url": "https://api.github.com/users/mattirantakomi/orgs",
    "received_events_url": "https://api.github.com/users/mattirantakomi/received_events",
    "repos_url": "https://api.github.com/users/mattirantakomi/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/mattirantakomi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattirantakomi/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/mattirantakomi"
  }
}