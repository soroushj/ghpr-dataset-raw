{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\n\r\nI have a k8s cluster running on the nodes in 3 racks.\r\nTo make the cluster tolerate rack failure, I add `PodAntiAffinity` to `mon` Pods as shown below to deploy only 1 Pod onto 1 rack (so, 3 `mon`s in total).\r\nNow I successfully deployed 3 `mon`s onto the different racks, but `detect-version` fails to run with the `Pending` state.\r\n\r\n```yaml\r\napiVersion: ceph.rook.io/v1\r\nkind: CephCluster\r\nspec:\r\n...\r\n  placement:\r\n    mon:\r\n      podAntiAffinity:\r\n        requiredDuringSchedulingIgnoredDuringExecution:\r\n        - labelSelector:\r\n            matchLabels:\r\n              app: rook-ceph-mon\r\n          topologyKey: topology.kubernetes.io/zone # <- failure domain (e.g. topology.kubernetes.io/zone=rack1)\r\n...\r\n```\r\n\r\n**Expected behavior:**\r\n\r\nI expect that only 1 `mon` is scheduled on 1 rack and that both the 3 `mon`s and the `detect-version` run successfully.\r\n\r\nI looked into https://github.com/rook/rook/pull/3977 and found that `detect-version` has the same `placement` with `mon`'s.\r\nThe reason why `detect-version` cannot be deployed seems to be that all the rack has 1 `mon` with `PodAntiAffinity` to prevent more Pods(=`detect-version`) from being deployed.\r\nI would like to avoid using `preferredDuringSchedulingIgnoredDuringExecution` to prevent multiple `mon`s from being deployed onto 1 rack.\r\n\r\n**How to reproduce it (minimal and precise):**\r\n1. Create a k8s cluster with 3 worker nodes.\r\n\r\n```\r\n$ cat << 'EOF' > kind-cluster.yaml\r\nkind: Cluster\r\napiVersion: kind.sigs.k8s.io/v1alpha3\r\nkubeadmConfigPatches:\r\n- |\r\n  apiVersion: kubeadm.k8s.io/v1beta1\r\n  kind: ClusterConfiguration\r\n  metadata:\r\n    name: config\r\n  kubernetesVersion: v1.17.6\r\n  apiServer:\r\n    extraArgs:\r\n      v: 7\r\n  networking:\r\n    serviceSubnet: 10.0.0.0/16\r\nnodes:\r\n- role: control-plane\r\n- role: worker\r\n- role: worker\r\n- role: worker\r\nEOF\r\n\r\n$ kind create cluster --config kind-cluster.yaml\r\n```\r\n\r\n2. Add different labels to each node as below:\r\n```\r\n$ kubectl label node kind-worker topology.kubernetes.io/zone=rack1\r\n$ kubectl label node kind-worker2 topology.kubernetes.io/zone=rack2\r\n$ kubectl label node kind-worker3 topology.kubernetes.io/zone=rack3\r\n```\r\n\r\n3. Deploy rook operator.\r\n\r\n4. Deploy ceph cluster with `PodAntiAffinity` for the `topology.kubernetes.io/zone` label (cf. https://github.com/cybozu-go/neco-apps/blob/f380ea1ae0b5faefba703ebb440bfe13fff5841d/rook/base/ceph-hdd/cluster.yaml#L24-L29).\r\n\r\n**File(s) to submit**:\r\n\r\nMy `cluster.yaml` can be downloaded from [here](https://github.com/cybozu-go/neco-apps/blob/f380ea1ae0b5faefba703ebb440bfe13fff5841d/rook/base/ceph-hdd/cluster.yaml).\r\n\r\n**Environment**:\r\n- OS (e.g. from /etc/os-release): CoreOS 2512.3.0\r\n- Kernel (e.g. uname -a): 4.19.123-coreos\r\n- Cloud provider or hardware configuration: x86_64 Intel(R) Xeon(R) Gold 5120 CPU @ 2.20GHz\r\n- Rook version (use rook version inside of a Rook Pod):  1.3.4\r\n- Storage backend version (e.g. for ceph do ceph -v): 15.2.3\r\n- Kubernetes version (use kubectl version): 1.17.6\r\n- Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift): CKE\r\n- Storage backend status (e.g. for Ceph use ceph health in the Rook Ceph toolbox): HEALTH_OK\r\n",
  "closed_at": "2020-07-16T09:49:44Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/912735?v=4",
    "events_url": "https://api.github.com/users/leseb/events{/privacy}",
    "followers_url": "https://api.github.com/users/leseb/followers",
    "following_url": "https://api.github.com/users/leseb/following{/other_user}",
    "gists_url": "https://api.github.com/users/leseb/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/leseb",
    "id": 912735,
    "login": "leseb",
    "node_id": "MDQ6VXNlcjkxMjczNQ==",
    "organizations_url": "https://api.github.com/users/leseb/orgs",
    "received_events_url": "https://api.github.com/users/leseb/received_events",
    "repos_url": "https://api.github.com/users/leseb/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/leseb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leseb/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/leseb"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/5810/comments",
  "created_at": "2020-07-13T06:08:31Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/5810/events",
  "html_url": "https://github.com/rook/rook/issues/5810",
  "id": 655607450,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    },
    {
      "color": "ef5c55",
      "default": false,
      "description": "main ceph tag",
      "id": 479456042,
      "name": "ceph",
      "node_id": "MDU6TGFiZWw0Nzk0NTYwNDI=",
      "url": "https://api.github.com/repos/rook/rook/labels/ceph"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/5810/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2NTU2MDc0NTA=",
  "number": 5810,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "rook-ceph-detect-version cannot be scheduled when mon has PodAntiAffinity to place Pods evenly on multiple racks",
  "updated_at": "2020-07-16T09:49:44Z",
  "url": "https://api.github.com/repos/rook/rook/issues/5810",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/5456898?v=4",
    "events_url": "https://api.github.com/users/tapih/events{/privacy}",
    "followers_url": "https://api.github.com/users/tapih/followers",
    "following_url": "https://api.github.com/users/tapih/following{/other_user}",
    "gists_url": "https://api.github.com/users/tapih/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/tapih",
    "id": 5456898,
    "login": "tapih",
    "node_id": "MDQ6VXNlcjU0NTY4OTg=",
    "organizations_url": "https://api.github.com/users/tapih/orgs",
    "received_events_url": "https://api.github.com/users/tapih/received_events",
    "repos_url": "https://api.github.com/users/tapih/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/tapih/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tapih/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/tapih"
  }
}