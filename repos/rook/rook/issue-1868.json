{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "We need a design doc that captures the requirements around integration of Rook with an external manager of the Ceph cluster. Some basic scenarios include:\r\n- A Ceph cluster is already running and Kubernetes is started in the environment. Rook could potentially start managing the cluster by monitoring mons and automatic failover, scheduling RGW, MDS, and MGR pods, or detecting when OSDs are down.\r\n- Rook starts a cluster and the user desires to manage the cluster from the Ceph dashboard. Rook should no longer manage the mons, create pools, etc.\r\n\r\nRelated documentation includes:\r\n- [Ceph mgr design](https://github.com/ceph/ceph/pull/21046) for working with multiple orchestrators such as Rook.\r\n- #1485 initiated some changes on skipping operations in Rook\r\n\r\n### Approach\r\nThe point of integration between Rook and the mgr will be the Rook CRDs. When the user is configuring the cluster in the Ceph dashboard, the Mgr module will set the desired state of Rook through the CRDs. Partial management of a cluster has a large matrix of possibilities so we will need to define what state should be exposed in the CRDs. \r\n\r\nSettings in the Ceph CRDs would be added to accommodate the integrated/reduced automation. The settings would be explicit (rather than by omitting a setting) so it is clear that Rook will turn off functionality. The default settings would still be for full management to be performed by Rook as today.\r\n\r\n### Mons\r\nDue to the strong dependence of all the Rook daemons on the mon endpoints stored in the configmap `rook-ceph-mon-endpoints` and secrets for accessing the cluster, either the external orchestrator would need to create these resources in the format Rook understands or else we would need to train the daemons where to find the same metadata. With this in mind, consider the settings in the `mon` section of the Cluster CRD:\r\n- `disableFailover`: Set to `true` when Rook should *not* monitor mon health\r\n- `disableCreate`: Set to `true` when Rook should *not* start any mons even at cluster creation.\r\n\r\n### OSDs\r\nIn the `storage`, `config` sections of the Cluster CRD, consider the settings:\r\n- `disableCreation`: Assuming OSDs are created and managed externally. No device/OSD management will be done by Rook. \r\n- `disableMonitoring`: Don't monitor whether the OSDs are healthy \r\n\r\n### Pools\r\nPools are created by Rook when the CRD is created and deleted when the CRD is deleted. If management of pools is not desired, the Pool CRD should not be used.\r\n\r\n### Filesystem\r\nWhen creating a filesystem, Rook creates pools for the metadata and data, according to the pool configuration in the CRD. If Rook finds the pools already exist when the filesystem is created, their configuration will be skipped. When the Filesystem is deleted, Rook will delete the pools used by the filesystem. To relax this behavior, consider the settings:\r\n- `skipPoolConfig`: Require the pools to already exist and skip all pool configuration\r\n- `purgePoolsOnRemove`: `true` to maintain the current behavior and `false` for the pools to remain after the filesystem (and mds) is removed.\r\n\r\n### Object store\r\nThe object store pools will have similar behavior to the filesystem pools and we could consider similar settings.\r\n\r\n@liewegas @jcsp @dmick @rootfs @BlaineEXE \r\n",
  "closed_at": "2018-09-17T17:39:54Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1463491?v=4",
    "events_url": "https://api.github.com/users/bassam/events{/privacy}",
    "followers_url": "https://api.github.com/users/bassam/followers",
    "following_url": "https://api.github.com/users/bassam/following{/other_user}",
    "gists_url": "https://api.github.com/users/bassam/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/bassam",
    "id": 1463491,
    "login": "bassam",
    "node_id": "MDQ6VXNlcjE0NjM0OTE=",
    "organizations_url": "https://api.github.com/users/bassam/orgs",
    "received_events_url": "https://api.github.com/users/bassam/received_events",
    "repos_url": "https://api.github.com/users/bassam/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/bassam/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bassam/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/bassam"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/1868/comments",
  "created_at": "2018-07-10T20:50:42Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/1868/events",
  "html_url": "https://github.com/rook/rook/issues/1868",
  "id": 340002101,
  "labels": [
    {
      "color": "ef5c55",
      "default": false,
      "description": "main ceph tag",
      "id": 479456042,
      "name": "ceph",
      "node_id": "MDU6TGFiZWw0Nzk0NTYwNDI=",
      "url": "https://api.github.com/repos/rook/rook/labels/ceph"
    },
    {
      "color": "128A0C",
      "default": true,
      "description": null,
      "id": 405241118,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTg=",
      "url": "https://api.github.com/repos/rook/rook/labels/help%20wanted"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/1868/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-01-28T21:43:43Z",
    "closed_issues": 89,
    "created_at": "2018-02-28T18:53:01Z",
    "creator": {
      "avatar_url": "https://avatars2.githubusercontent.com/u/4313439?v=4",
      "events_url": "https://api.github.com/users/jbw976/events{/privacy}",
      "followers_url": "https://api.github.com/users/jbw976/followers",
      "following_url": "https://api.github.com/users/jbw976/following{/other_user}",
      "gists_url": "https://api.github.com/users/jbw976/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jbw976",
      "id": 4313439,
      "login": "jbw976",
      "node_id": "MDQ6VXNlcjQzMTM0Mzk=",
      "organizations_url": "https://api.github.com/users/jbw976/orgs",
      "received_events_url": "https://api.github.com/users/jbw976/received_events",
      "repos_url": "https://api.github.com/users/jbw976/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jbw976/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jbw976/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jbw976"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/rook/rook/milestone/10",
    "id": 3151476,
    "labels_url": "https://api.github.com/repos/rook/rook/milestones/10/labels",
    "node_id": "MDk6TWlsZXN0b25lMzE1MTQ3Ng==",
    "number": 10,
    "open_issues": 0,
    "state": "closed",
    "title": "0.9",
    "updated_at": "2020-01-28T21:43:43Z",
    "url": "https://api.github.com/repos/rook/rook/milestones/10"
  },
  "node_id": "MDU6SXNzdWUzNDAwMDIxMDE=",
  "number": 1868,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Design doc for Rook integration with external orchestrator",
  "updated_at": "2018-09-17T17:39:54Z",
  "url": "https://api.github.com/repos/rook/rook/issues/1868",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  }
}