{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "<!-- **Are you in the right place?**\r\n1. For issues or feature requests, please create an issue in this repository.\r\n2. For general technical and non-technical questions, we are happy to help you on our [Rook.io Slack](https://slack.rook.io/).\r\n3. Did you already search the existing open issues for anything similar? -->\r\n\r\n**Is this a bug report or feature request?**\r\n* Feature Request\r\n\r\n**What should the feature do:**\r\nThe ceph-csi integration with rook currently requires a single ceph cluster to be configured. This is due to the mon endpoints being updated on a per-cluster basis as seen in #3271. This will work fine as long as there is only ceph cluster deployed per operator. \r\n\r\nTo support multiple clusters per operator, we would need the following approach:\r\n- The operator will deploy the CSI driver:\r\n   - An empty configmap will be created in the same namespace. The CSI driver needs to mount this in order to launch\r\n   - The CSI driver is deployed in the same namespace as the operator\r\n- Every time the operator creates/updates the mons in a cluster, it would do the following:\r\n   - Take a lock (There are multiple goroutines that update mons, one for each cluster's mon health check and one for the reconcile loop)\r\n   - Update a configmap in the same namespace as the operator (and csi driver). The configmap follows the format expected by the csi driver and would contain a list of all the clusters with all their mon endpoints.\r\n   - The output of [`FormatCsiClusterConfig`](https://github.com/phlogistonjohn/rook/blob/master/pkg/operator/ceph/cluster/mon/mon.go#L469) will be written to the new configmap rather than `rook-ceph-mon-endpoints`. \r\n   - Release the lock\r\n\r\nThe lock (`sync.Mutex`) can be defined by the [`ClusterController`](https://github.com/rook/rook/blob/master/pkg/operator/ceph/cluster/controller.go#L93) since there is only one cluster controller defined for the operator. When the cluster controller creates a new cluster, it would pass the needed context* to [`newCluster()`](https://github.com/rook/rook/blob/master/pkg/operator/ceph/cluster/controller.go#L252). The context* would be passed onto the mon's [`Cluster`](https://github.com/rook/rook/blob/master/pkg/operator/ceph/cluster/cluster.go#L82) type for later use by the [`saveMonConfig()`](https://github.com/rook/rook/blob/master/pkg/operator/ceph/cluster/mon/mon.go#L455) method.\r\n\r\n*The context from the previous paragraph is referring possibly to the `sync.Mutex` instance that can be used when the mons are updated. Alternatively, a callback method could be passed so that the details of locking around the mutex could be hidden from the mons. Either way should be fine in this case.\r\n\r\n@ShyamsundarR @humblec @Madhu-1 @phlogistonjohn ",
  "closed_at": "2019-08-13T12:04:22Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/912735?v=4",
    "events_url": "https://api.github.com/users/leseb/events{/privacy}",
    "followers_url": "https://api.github.com/users/leseb/followers",
    "following_url": "https://api.github.com/users/leseb/following{/other_user}",
    "gists_url": "https://api.github.com/users/leseb/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/leseb",
    "id": 912735,
    "login": "leseb",
    "node_id": "MDQ6VXNlcjkxMjczNQ==",
    "organizations_url": "https://api.github.com/users/leseb/orgs",
    "received_events_url": "https://api.github.com/users/leseb/received_events",
    "repos_url": "https://api.github.com/users/leseb/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/leseb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leseb/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/leseb"
  },
  "comments": 12,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/3331/comments",
  "created_at": "2019-06-20T23:03:24Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/3331/events",
  "html_url": "https://github.com/rook/rook/issues/3331",
  "id": 458925534,
  "labels": [
    {
      "color": "ef5c55",
      "default": false,
      "description": "main ceph tag",
      "id": 479456042,
      "name": "ceph",
      "node_id": "MDU6TGFiZWw0Nzk0NTYwNDI=",
      "url": "https://api.github.com/repos/rook/rook/labels/ceph"
    },
    {
      "color": "5ccfd1",
      "default": false,
      "description": "",
      "id": 1232322795,
      "name": "csi",
      "node_id": "MDU6TGFiZWwxMjMyMzIyNzk1",
      "url": "https://api.github.com/repos/rook/rook/labels/csi"
    },
    {
      "color": "84b6eb",
      "default": false,
      "description": "",
      "id": 405241117,
      "name": "feature",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTc=",
      "url": "https://api.github.com/repos/rook/rook/labels/feature"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/3331/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NTg5MjU1MzQ=",
  "number": 3331,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Ceph-CSI Driver support for multiple ceph clusters from a single operator",
  "updated_at": "2019-08-13T12:04:22Z",
  "url": "https://api.github.com/repos/rook/rook/issues/3331",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  }
}