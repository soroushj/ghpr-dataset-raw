{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\nCeph consumes all flash devices for block.db and wal when one specific device was configured as a `metadataDevice`.\r\n\r\n**Expected behavior:**\r\nRook should configure Ceph to only use the device specified for block.db/wal.\r\n\r\n**How to reproduce it (minimal and precise):**\r\nCreate a Rook Ceph cluster with two (or presumably more) non-rotational devices and one or more rotational devices, but only specify one of the flash devices to be used as the `metadataDevice` on the node.\r\n\r\n**Other comments:**\r\n\r\n```\r\nc4tw8z1:~$ lsblk\r\nNAME                                                MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT\r\nsda                                                   8:0    0 238.5G  0 disk\r\n\u2514\u2500sda1                                                8:1    0 238.5G  0 part /etc/ssl/certs/ca-certificates.crt.rancher\r\nsdb                                                   8:16   0 372.6G  0 disk\r\n\u2514\u2500ceph--block--dbs--06206d70--22ce--4a20--b035--68ad7aea3317-osd--block--db--c84de295--a8dd--4b0d--b3eb--29841b462991\r\n                                                    252:3    0   558G  0 lvm\r\nsdc                                                   8:32   0   9.1T  0 disk\r\n\u2514\u2500ceph--block--22045f1b--507a--4f88--b078--27170fa79f40-osd--block--8e3152a5--5669--411b--93a4--c747e66dc1c3\r\n                                                    252:2    0   9.1T  0 lvm\r\nsdd                                                   8:48   0   9.1T  0 disk\r\n\u2514\u2500ceph--block--3f4df301--a0f8--451d--b343--bf8eeee4c0cb-osd--block--43362e5b--9784--47be--a2b9--1f644ded681d\r\n                                                    252:0    0   9.1T  0 lvm\r\nnvme0n1                                             259:0    0 745.2G  0 disk\r\n\u251c\u2500ceph--block--dbs--06206d70--22ce--4a20--b035--68ad7aea3317-osd--block--db--6c3403e9--513c--4b6d--99ee--87a7a6653f44\r\n\u2502                                                   252:1    0   558G  0 lvm\r\n\u2514\u2500ceph--block--dbs--06206d70--22ce--4a20--b035--68ad7aea3317-osd--block--db--c84de295--a8dd--4b0d--b3eb--29841b462991\r\n                                                    252:3    0   558G  0 lvm\r\n```\r\n\r\nIt occurs to me there may also be more that contributed to this behavior (at least in my case), or it may be an entirely separate issue, as it looks like Rook is also not merging the cluster-level `storage.config` with my node-level `storage.node.config`, so the `databaseSizeMB` setting is getting ignored, and the metadata lvs are getting created as 50% of the sum of both non-rotational devices since there are two rotational devices. Not sure if this is intended behavior.\r\n\r\nBased on the comments, I believe this issue may be a regression introduced by #2777 due to the apparent omission of the `--db-devices` argument when the change was made to use batch provisioning with ceph-volume, but I can't be certain because I haven't tested with a version prior to this PR. In either case, there are lots of juicy comments on this PR specifically pertaining to this issue, which appears to have been known before the PR was accepted.\r\n\r\nOther possibly related issues: #3092, #3449\r\n\r\n**File(s)**:\r\n* Cluster CRD: [cluster.zip](https://github.com/rook/rook/files/3520956/cluster.zip) (use c4tw8z1 as a reference node)\r\n\r\n**Environment**:\r\n* OS: Rancher OS 1.5.3\r\n* Kernel: 4.14.128-rancher\r\n* Hardware configuration: Dell R320, 800GB NVMe, 400GB SATA SSD, 2x 10TB HDD\r\n* Rook version: 1.0.2\r\n* Storage backend version: Ceph v14.2.2\r\n* Kubernetes version: 1.13.5\r\n* Kubernetes cluster type: bare metal w/ Rancher\r\n* Storage backend status: healthy",
  "closed_at": "2019-08-30T07:49:43Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/912735?v=4",
    "events_url": "https://api.github.com/users/leseb/events{/privacy}",
    "followers_url": "https://api.github.com/users/leseb/followers",
    "following_url": "https://api.github.com/users/leseb/following{/other_user}",
    "gists_url": "https://api.github.com/users/leseb/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/leseb",
    "id": 912735,
    "login": "leseb",
    "node_id": "MDQ6VXNlcjkxMjczNQ==",
    "organizations_url": "https://api.github.com/users/leseb/orgs",
    "received_events_url": "https://api.github.com/users/leseb/received_events",
    "repos_url": "https://api.github.com/users/leseb/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/leseb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leseb/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/leseb"
  },
  "comments": 10,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/3652/comments",
  "created_at": "2019-08-20T13:55:59Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/3652/events",
  "html_url": "https://github.com/rook/rook/issues/3652",
  "id": 482876969,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/3652/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0ODI4NzY5Njk=",
  "number": 3652,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "All non-rotational devices consumed as metadataDevice when only one was specified",
  "updated_at": "2019-08-30T14:46:59Z",
  "url": "https://api.github.com/repos/rook/rook/issues/3652",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/519596?v=4",
    "events_url": "https://api.github.com/users/Confusingboat/events{/privacy}",
    "followers_url": "https://api.github.com/users/Confusingboat/followers",
    "following_url": "https://api.github.com/users/Confusingboat/following{/other_user}",
    "gists_url": "https://api.github.com/users/Confusingboat/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/Confusingboat",
    "id": 519596,
    "login": "Confusingboat",
    "node_id": "MDQ6VXNlcjUxOTU5Ng==",
    "organizations_url": "https://api.github.com/users/Confusingboat/orgs",
    "received_events_url": "https://api.github.com/users/Confusingboat/received_events",
    "repos_url": "https://api.github.com/users/Confusingboat/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/Confusingboat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Confusingboat/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/Confusingboat"
  }
}