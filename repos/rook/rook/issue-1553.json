{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "Users @chaosaffe and @apinnecke reported their mongoDB data completely wiped out and it appears the rook-agent caused this to happen.  The best guess at the repro steps right now are to delete a pod with a rook-block volume.  The environment is also on very slow infrastructure which may be causing a timing issue to be surfaced.\r\n\r\nLog and related objects can be found in https://gist.github.com/jbw976/3f354a51b80ff3fdea735d263b10d40a\r\n\r\nThe log file has a few notes of interest:\r\n* There appears to be an attach operation that gets called in the middle of on ongoing detach operation.  I'm not sure why the Kubelet would make this call, but our fencing doesn't appear to be blocking it appropriately:\r\n```\r\n2018-03-06 22:26:25.047877 I | flexdriver: unmounting mount dir\r\n...\r\n2018-03-06 22:26:25.240220 I | flexdriver: calling agent to attach\r\n...\r\n2018-03-06 22:26:25.482528 I | ceph-volumeattacher: detaching volume\r\n```\r\n\r\n* The unmap operation during detach fails because the device is busy, the device never gets unmapped:\r\n```\r\nfailed to unmap image generic/pvc-5333da36-fcf5-11e7-9f4a-0201fa246d34: Failed to complete rbd: exit status 16. output: rbd: run_cmd(udevadm): exited with status 127\r\nrbd: sysfs write failed\r\nrbd: unmap failed: (16) Device or resource busy\r\n```\r\n* The 2nd attach operation thinks the device is [not formatted](https://github.com/kubernetes/kubernetes/blob/release-1.8/pkg/util/mount/mount_linux.go#L469):\r\n```\r\n22:26:25.865635   51246 mount_linux.go:404] Disk \"/dev/rbd4\" appears to be unformatted, attempting to format as type: \"ext4\" with options: [-F /dev/rbd4]\r\n```\r\nThe [Kubernetes mounter code that does this check](https://github.com/kubernetes/kubernetes/blob/release-1.8/pkg/util/mount/mount_linux.go#L493) uses `lsblk -n -o FSTYPE <disk>`, which is not clear to me how that would behave for a RBD device that failed to unmap and doesn't have any mounts on it.  We should look further into that.\r\n\r\nSince the k8s mounter believes the disk isn't formatted, it goes ahead and performs the format again, wiping out all the data, which appears to take almost 3 minutes to complete:\r\n```\r\n22:26:25.865635   51246 mount_linux.go:404] Disk \"/dev/rbd4\" appears to be unformatted, attempting to format...\r\n22:29:24.347948   51246 mount_linux.go:408] Disk successfully formatted \r\n```\r\n\r\n* We remove the attachment object from the CRD before we actually perform the detach.  This may not be safe and could lead us to try to attach again when the detach hasn't actually happened: https://github.com/rook/rook/blob/master/cmd/rookflex/cmd/unmount.go#L89",
  "closed_at": "2018-09-21T23:14:38Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 38,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/1553/comments",
  "created_at": "2018-03-07T03:36:32Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/1553/events",
  "html_url": "https://github.com/rook/rook/issues/1553",
  "id": 302953198,
  "labels": [
    {
      "color": "00bbcc",
      "default": false,
      "description": "",
      "id": 496364161,
      "name": "block",
      "node_id": "MDU6TGFiZWw0OTYzNjQxNjE=",
      "url": "https://api.github.com/repos/rook/rook/labels/block"
    },
    {
      "color": "5ccfd1",
      "default": false,
      "description": "",
      "id": 730857860,
      "name": "flexvolume",
      "node_id": "MDU6TGFiZWw3MzA4NTc4NjA=",
      "url": "https://api.github.com/repos/rook/rook/labels/flexvolume"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/1553/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-01-28T21:43:43Z",
    "closed_issues": 89,
    "created_at": "2018-02-28T18:53:01Z",
    "creator": {
      "avatar_url": "https://avatars2.githubusercontent.com/u/4313439?v=4",
      "events_url": "https://api.github.com/users/jbw976/events{/privacy}",
      "followers_url": "https://api.github.com/users/jbw976/followers",
      "following_url": "https://api.github.com/users/jbw976/following{/other_user}",
      "gists_url": "https://api.github.com/users/jbw976/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jbw976",
      "id": 4313439,
      "login": "jbw976",
      "node_id": "MDQ6VXNlcjQzMTM0Mzk=",
      "organizations_url": "https://api.github.com/users/jbw976/orgs",
      "received_events_url": "https://api.github.com/users/jbw976/received_events",
      "repos_url": "https://api.github.com/users/jbw976/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jbw976/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jbw976/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jbw976"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/rook/rook/milestone/10",
    "id": 3151476,
    "labels_url": "https://api.github.com/repos/rook/rook/milestones/10/labels",
    "node_id": "MDk6TWlsZXN0b25lMzE1MTQ3Ng==",
    "number": 10,
    "open_issues": 0,
    "state": "closed",
    "title": "0.9",
    "updated_at": "2020-01-28T21:43:43Z",
    "url": "https://api.github.com/repos/rook/rook/milestones/10"
  },
  "node_id": "MDU6SXNzdWUzMDI5NTMxOTg=",
  "number": 1553,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "rook-agent formatted an in use volume",
  "updated_at": "2019-02-01T04:32:41Z",
  "url": "https://api.github.com/repos/rook/rook/issues/1553",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/4313439?v=4",
    "events_url": "https://api.github.com/users/jbw976/events{/privacy}",
    "followers_url": "https://api.github.com/users/jbw976/followers",
    "following_url": "https://api.github.com/users/jbw976/following{/other_user}",
    "gists_url": "https://api.github.com/users/jbw976/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jbw976",
    "id": 4313439,
    "login": "jbw976",
    "node_id": "MDQ6VXNlcjQzMTM0Mzk=",
    "organizations_url": "https://api.github.com/users/jbw976/orgs",
    "received_events_url": "https://api.github.com/users/jbw976/received_events",
    "repos_url": "https://api.github.com/users/jbw976/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jbw976/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jbw976/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jbw976"
  }
}