{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\nI have a ceph cluster configured to use the host network. Each node has two interfaces: one public, and one private. I would like to use the private one. This interface is also the default one for all communication within the kubernetes cluster.\r\n\r\nWhile ceph and kubernetes are properly configured to use the private network, rook defaults to creating config objects \"as if\" the ceph cluster is using the public network when, in reality all the pods will have IPs in a different interface\r\n\r\nIf I inspect `rook-ceph-mon-endpoints` configMap I can indeed see that rook \"thinks\" that the kubernetes cluster and the pods using host network will have the IP from the node's public interface.\r\n\r\nThis has an impact on how osd pods try to connect to mon pods, as the osd pods will be trying to reach the mons using IPs which are not in their network.\r\n\r\n**Expected behavior:**\r\nRook respects the overriden configuration and uses the provided interface to generate endpoint lists (e.g.: in `rook-ceph-mon-endpoints` configMap)\r\n\r\n**How to reproduce it (minimal and precise):**\r\n\r\nTo make sure that rook and ceph pick the same interface I have created a `rook-config-override` ConfigMap like this:\r\n\r\n```yaml\r\nkind: ConfigMap\r\napiVersion: v1\r\nmetadata:\r\n  name: rook-config-override\r\n  namespace: rook-ceph\r\ndata:\r\n  config: |\r\n    [global]\r\n    public network = 172.17.0.1/32\r\n    cluster network = 172.17.0.1/32\r\n    public addr = \"\"\r\n    cluster addr = \"\"\r\n```\r\n\r\nThen in the helm values for the operator I have `useOperatorHostNetwork: true` and for the cluster:\r\n\r\n```\r\n  network:\r\n    provider: host\r\n```\r\n\r\nThis results in all the osd and mon pods getting the IP of the host in the configured `172.17.0.1/32` network. And so host networking is working fine and as expected.\r\n\r\nHowever, in the configMap generated by Rook, I can see that the endpoints are wrong:\r\n\r\n```\r\nkind: ConfigMap\r\napiVersion: v1\r\nmetadata:\r\n  name: rook-ceph-csi-config\r\n  namespace: rook-ceph\r\ndata:\r\n  csi-cluster-config-json: >-\r\n    [{\"clusterID\":\"rook-ceph\",\"monitors\":[\"49.12.xx.xxx:6789\",\"49.12.xx.xxx:6789\",\"49.12.xx.xxx:6789\"]}]\r\n```\r\n\r\n\r\nIn the logs of osd pods I can see that the pods are trying to use the wrong endpoints listed by rook in the configMap and I can read:\r\n\r\n```\r\nparsing mon endpoints: c=49.12.xx.xxx:6789,a=49.12.xx.xxx:6789,b=49.12.xx.xxx:6789\r\ncephosd: failed to start osd or shutting down. exit status 1\r\n```\r\n\r\nThe manager is also failing, in the logs I have:\r\n\r\n```\r\nunable to find any IP address in networks '172.17.0.1/32' interfaces ''2020-05-17T19:49:10.822202463+02:00\r\n```\r\nI suspect the monitor is trying to reach mons in the 172.17.0.1/32 network using the wrong ip, which will never work since the latter is just a private network\r\n\r\n**Environment**:\r\n* OS (e.g. from /etc/os-release): Ubuntu\r\n* Kernel (e.g. `uname -a`): 5.4.0\r\n* Cloud provider or hardware configuration: Hetzner cloud\r\n* Rook version (use `rook version` inside of a Rook Pod): 1.3\r\n* Storage backend version (e.g. for ceph do `ceph -v`): 15.2\r\n* Kubernetes version (use `kubectl version`): 1.17\r\n* Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift): kubeadm\r\n* Storage backend status (e.g. for Ceph use `ceph health` in the [Rook Ceph toolbox](https://rook.io/docs/rook/master/ceph-toolbox.html)): `ceph status` hangs in the tools pod\r\n",
  "closed_at": "2020-06-04T19:24:45Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/5495/comments",
  "created_at": "2020-05-17T18:00:40Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/5495/events",
  "html_url": "https://github.com/rook/rook/issues/5495",
  "id": 619762918,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/5495/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MTk3NjI5MTg=",
  "number": 5495,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Mon endpoint list using wrong interface",
  "updated_at": "2020-06-04T19:24:45Z",
  "url": "https://api.github.com/repos/rook/rook/issues/5495",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/8725825?v=4",
    "events_url": "https://api.github.com/users/cortopy/events{/privacy}",
    "followers_url": "https://api.github.com/users/cortopy/followers",
    "following_url": "https://api.github.com/users/cortopy/following{/other_user}",
    "gists_url": "https://api.github.com/users/cortopy/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/cortopy",
    "id": 8725825,
    "login": "cortopy",
    "node_id": "MDQ6VXNlcjg3MjU4MjU=",
    "organizations_url": "https://api.github.com/users/cortopy/orgs",
    "received_events_url": "https://api.github.com/users/cortopy/received_events",
    "repos_url": "https://api.github.com/users/cortopy/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/cortopy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cortopy/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/cortopy"
  }
}