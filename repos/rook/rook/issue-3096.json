{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/10368581?v=4",
    "events_url": "https://api.github.com/users/umangachapagain/events{/privacy}",
    "followers_url": "https://api.github.com/users/umangachapagain/followers",
    "following_url": "https://api.github.com/users/umangachapagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/umangachapagain/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/umangachapagain",
    "id": 10368581,
    "login": "umangachapagain",
    "node_id": "MDQ6VXNlcjEwMzY4NTgx",
    "organizations_url": "https://api.github.com/users/umangachapagain/orgs",
    "received_events_url": "https://api.github.com/users/umangachapagain/received_events",
    "repos_url": "https://api.github.com/users/umangachapagain/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/umangachapagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/umangachapagain/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/umangachapagain"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars1.githubusercontent.com/u/10368581?v=4",
      "events_url": "https://api.github.com/users/umangachapagain/events{/privacy}",
      "followers_url": "https://api.github.com/users/umangachapagain/followers",
      "following_url": "https://api.github.com/users/umangachapagain/following{/other_user}",
      "gists_url": "https://api.github.com/users/umangachapagain/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/umangachapagain",
      "id": 10368581,
      "login": "umangachapagain",
      "node_id": "MDQ6VXNlcjEwMzY4NTgx",
      "organizations_url": "https://api.github.com/users/umangachapagain/orgs",
      "received_events_url": "https://api.github.com/users/umangachapagain/received_events",
      "repos_url": "https://api.github.com/users/umangachapagain/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/umangachapagain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/umangachapagain/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/umangachapagain"
    }
  ],
  "author_association": "NONE",
  "body": "Description of problem:\r\n==========================\r\n\r\nRook-ceph installation issue on OCP - following pods do not come up upon running deployment in following order:\r\n\r\nDeployment order\r\n---------------------\r\n1. oc create -f common.yaml\r\n2. oc apply -f csi/rbac/rbd\r\n3. oc apply -f csi/rbac/cephfs/\r\n4. oc create -f operator-openshift-with-csi.yaml\r\n5. oc create -f cluster.yaml \r\n\r\n\r\nPods not coming up\r\n--------------------\r\n\r\nrook-ceph-agent-\r\nrook-discover-\r\nrook-ceph-mgr-\r\nrook-ceph-mon-\r\nrook-ceph-osd\r\n\r\n\r\n**Reason for failure**\r\n---------------------\r\n```\r\noperator-openshift-with-csi.yaml is expected to create 2 SCCs -\r\n\r\n \"rook-ceph\" and \r\n\"rook-ceph-csi\". \r\n\r\nBut due to a missing separator characters in operator-openshift-with-csi.yaml (no \"---\" separation between the 2 kind: SecurityContextConstraints blocks), only 1 scc, i.e. rook-ceph-csi is created. \r\n\r\nHence, none of the above mentioned pods come up due to the missing second scc - rook-ceph.\r\n\r\nHence, need to have \"---\" added as a separator between two block of scc in operator-openshift-with-csi.yaml in between line #52 and #53\r\n\r\n**Github link:**   https://github.com/rook/rook/blob/master/cluster/examples/kubernetes/ceph/operator-openshift-with-csi.yaml\r\n\r\n**Rook repo cloned from** git@github.com:rook/rook.git as on May 2 2019\r\n\r\n\r\n```\r\n**Error message seen**\r\n-------------------\r\n`69s         Warning   FailedCreate        daemonset/rook-ceph-agent                  Error creating: pods \"rook-ceph-agent-\" is forbidden: unable to validate against any security context constraint: [provider restricted: .spec.securityContext.hostNetwork: Invalid value: true: Host network is not allowed to be used spec.volumes[0]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used spec.volumes[1]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used spec.volumes[2]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used spec.volumes[3]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used spec.containers[0].securityContext.privileged: Invalid value: true: Privileged containers are not allowed spec.containers[0].securityContext.hostNetwork: Invalid value: true: Host network is not allowed to be used]\r\n\r\n`\r\n`\r\n6m2s        Warning   FailedCreate             replicaset/rook-ceph-mon-a-f578bc958       Error creating: pods \"rook-ceph-mon-a-f578bc958-\" is forbidden: unable to validate against any security context constraint: [spec.volumes[2]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used spec.volumes[3]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used spec.initContainers[0].securityContext.privileged: Invalid value: true: Privileged containers are not allowed spec.containers[0].securityContext.privileged: Invalid value: true: Privileged containers are not allowed]\r\n`\r\n\r\n\r\n**Workaround applied**\r\n--------------------\r\nOn either running scc.yaml separately or editing the operator-openshift-with-csi.yaml file for correct entry,  solves the issue.\r\n\r\n\r\n\r\n**Version-Release number of selected component (if applicable):**\r\n========================\r\n\r\n```\r\n\r\n# oc version\r\nClient Version: version.Info{Major:\"4\", Minor:\"1+\", GitVersion:\"v4.1.0\", GitCommit:\"bbefc2cc4\", GitTreeState:\"clean\", BuildDate:\"2019-04-26T03:10:49Z\", GoVersion:\"go1.11.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"13+\", GitVersion:\"v1.13.4+938b976\", GitCommit:\"938b976\", GitTreeState:\"clean\", BuildDate:\"2019-04-17T12:43:17Z\", GoVersion:\"go1.10.8\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n\r\n\r\n\r\nsh-4.2# ceph versions\r\n{\r\n    \"mon\": {\r\n        \"ceph version 14.2.0 (3a54b2b6d167d4a2a19e003a705696d4fe619afc) nautilus (stable)\": 3\r\n    },\r\n    \"mgr\": {\r\n        \"ceph version 14.2.0 (3a54b2b6d167d4a2a19e003a705696d4fe619afc) nautilus (stable)\": 1\r\n    },\r\n    \"osd\": {\r\n        \"ceph version 14.2.0 (3a54b2b6d167d4a2a19e003a705696d4fe619afc) nautilus (stable)\": 6\r\n    },\r\n    \"mds\": {},\r\n    \"overall\": {\r\n        \"ceph version 14.2.0 (3a54b2b6d167d4a2a19e003a705696d4fe619afc) nautilus (stable)\": 10\r\n    }\r\n}\r\n\r\n```\r\n\r\n**Deviation from expected behavior:**\r\nCeph and Discover&Agent pods don't come up in absence of scc/rook-ceph, which fails to get created due to a typo in the yaml file\r\n\r\n**Only one scc is created:**\r\n\r\noc create -f operator-openshift-with-csi.yaml\r\n**_securitycontextconstraints.security.openshift.io/rook-ceph-csi created_**\r\ndeployment.apps/rook-ceph-operator created\r\n\r\n oc get scc|grep rook\r\nrook-ceph-csi      true    [*]    RunAsAny    RunAsAny           RunAsAny    RunAsAny    <none>     false            [*]\r\n\r\n\r\n**Expected behavior:**\r\nAll Pods should come up and 2 SCCs should be created.\r\n\r\n**edited the file and re-ran the script**\r\n\r\nvi operator-openshift-with-csi.yaml \r\n\r\noc create -f operator-openshift-with-csi.yaml\r\n```\r\n**securitycontextconstraints.security.openshift.io/rook-ceph created\r\nsecuritycontextconstraints.security.openshift.io/rook-ceph-csi created**\r\ndeployment.apps/rook-ceph-operator created\r\n```\r\n\r\n\r\n**# oc get scc|grep rook**\r\n```\r\nrook-ceph          true    []     MustRunAs   RunAsAny           MustRunAs   RunAsAny    <none>     false            [configMap downwardAPI emptyDir flexVolume hostPath persistentVolumeClaim projected secret]\r\nrook-ceph-csi      true    [*]    RunAsAny    RunAsAny           RunAsAny    RunAsAny    <none>     false            [*]\r\n\r\n```\r\n\r\n\r\n**How to reproduce it (minimal and precise):**\r\n<!-- Please let us know any circumstances for reproduction of your bug. -->\r\n\r\n1. Create a Nautilus based rook+ceph cluster setup based on ceph-csi\r\n\r\n2. Run the Rook-ceph deployment in following order. The pods based on cluster.yaml and discover an dagent pods fail to come up.\r\n\r\n  oc create -f common.yaml \r\n  oc apply -f csi/rbac/rbd\r\n  oc apply -f csi/rbac/cephfs/\r\n  oc create -f operator-openshift-with-csi.yaml\r\n  oc get events -w\r\n  oc get scc|grep rook\r\n  oc create -f cluster.yaml \r\n\r\n\r\n3. Edit the following file as below and add separator between the 2 SecurityContextConstraints blocks. Re-run the complete deployment(after cleanup). All pods come up\r\n\r\nvi operator-openshift-with-csi.yaml \r\n\r\nsnip\r\n----\r\n\r\nkind: SecurityContextConstraints\r\nolder versions of openshift have \"apiVersion: v1\"\r\napiVersion: security.openshift.io/v1\r\nmetadata:\r\n  name: rook-ceph\r\nallowPrivilegedContainer: true\r\n\r\n**---**                **<---add this after line 52 --->**\r\nkind: SecurityContextConstraints\r\nolder versions of openshift have \"apiVersion: v1\"\r\napiVersion: security.openshift.io/v1\r\nmetadata:\r\n  name: rook-ceph-csi\r\n\r\n",
  "closed_at": "2019-05-03T14:06:43Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/3718398?v=4",
    "events_url": "https://api.github.com/users/galexrt/events{/privacy}",
    "followers_url": "https://api.github.com/users/galexrt/followers",
    "following_url": "https://api.github.com/users/galexrt/following{/other_user}",
    "gists_url": "https://api.github.com/users/galexrt/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/galexrt",
    "id": 3718398,
    "login": "galexrt",
    "node_id": "MDQ6VXNlcjM3MTgzOTg=",
    "organizations_url": "https://api.github.com/users/galexrt/orgs",
    "received_events_url": "https://api.github.com/users/galexrt/received_events",
    "repos_url": "https://api.github.com/users/galexrt/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/galexrt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/galexrt/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/galexrt"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/3096/comments",
  "created_at": "2019-05-02T13:37:55Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/3096/events",
  "html_url": "https://github.com/rook/rook/issues/3096",
  "id": 439595806,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/3096/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0Mzk1OTU4MDY=",
  "number": 3096,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Discover,Agent and Ceph Pods deployments fail on running operator-openshift-with-csi.yaml followed by cluster.yaml",
  "updated_at": "2019-05-16T12:04:24Z",
  "url": "https://api.github.com/repos/rook/rook/issues/3096",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/38582702?v=4",
    "events_url": "https://api.github.com/users/nehaberry/events{/privacy}",
    "followers_url": "https://api.github.com/users/nehaberry/followers",
    "following_url": "https://api.github.com/users/nehaberry/following{/other_user}",
    "gists_url": "https://api.github.com/users/nehaberry/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/nehaberry",
    "id": 38582702,
    "login": "nehaberry",
    "node_id": "MDQ6VXNlcjM4NTgyNzAy",
    "organizations_url": "https://api.github.com/users/nehaberry/orgs",
    "received_events_url": "https://api.github.com/users/nehaberry/received_events",
    "repos_url": "https://api.github.com/users/nehaberry/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/nehaberry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nehaberry/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/nehaberry"
  }
}