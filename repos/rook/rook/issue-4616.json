{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/11498120?v=4",
    "events_url": "https://api.github.com/users/rohan47/events{/privacy}",
    "followers_url": "https://api.github.com/users/rohan47/followers",
    "following_url": "https://api.github.com/users/rohan47/following{/other_user}",
    "gists_url": "https://api.github.com/users/rohan47/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rohan47",
    "id": 11498120,
    "login": "rohan47",
    "node_id": "MDQ6VXNlcjExNDk4MTIw",
    "organizations_url": "https://api.github.com/users/rohan47/orgs",
    "received_events_url": "https://api.github.com/users/rohan47/received_events",
    "repos_url": "https://api.github.com/users/rohan47/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rohan47/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rohan47/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rohan47"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/11498120?v=4",
      "events_url": "https://api.github.com/users/rohan47/events{/privacy}",
      "followers_url": "https://api.github.com/users/rohan47/followers",
      "following_url": "https://api.github.com/users/rohan47/following{/other_user}",
      "gists_url": "https://api.github.com/users/rohan47/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rohan47",
      "id": 11498120,
      "login": "rohan47",
      "node_id": "MDQ6VXNlcjExNDk4MTIw",
      "organizations_url": "https://api.github.com/users/rohan47/orgs",
      "received_events_url": "https://api.github.com/users/rohan47/received_events",
      "repos_url": "https://api.github.com/users/rohan47/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rohan47/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rohan47/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rohan47"
    }
  ],
  "author_association": "NONE",
  "body": "**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\nWhen upgrading from rook 1.1.7 to 1.2.0 the node lables for region and zone described in https://github.com/rook/rook/blob/release-1.2/Documentation/ceph-cluster-crd.md#osd-topology\r\n```\r\nfailure-domain.beta.kubernetes.io/region\r\nfailure-domain.beta.kubernetes.io/zone\r\n```\r\nare not applied to the OSD, causing the crush map to change during the upgrade.\r\n![image](https://user-images.githubusercontent.com/9726307/71806899-55a89680-306a-11ea-8a24-e934df5d4f67.png)\r\n\r\n\r\n**Expected behavior:**\r\nThe crush map to stay unchanged and equal to how it was before upgrading to 1.2.0\r\n![image](https://user-images.githubusercontent.com/9726307/71806870-3d387c00-306a-11ea-981e-ed3857c0393b.png)\r\n\r\n\r\n**How to reproduce it (minimal and precise):**\r\nDeploy a 1.1.7 PV backed rook ceph cluster in AWS (or any other cluster that has the mentioned failure-domain annotations)\r\n\r\n* Node labels (example from node in zone c)\r\n```\r\nName:               ip-10-1-45-17.eu-west-1.compute.internal\r\nRoles:              node,storageC\r\nLabels:             beta.kubernetes.io/arch=amd64\r\n                    beta.kubernetes.io/instance-type=m5a.large\r\n                    beta.kubernetes.io/os=linux\r\n                    cputype=normal\r\n                    failure-domain.beta.kubernetes.io/region=eu-west-1\r\n                    failure-domain.beta.kubernetes.io/zone=eu-west-1c\r\n                    kube-aws.coreos.com/autoscalinggroup=k8s5-StorageC-1P1VQPZET13L8-Workers-1VWKDONC1ELQW\r\n                    kube-aws.coreos.com/cluster=k8s5\r\n                    kube-aws.coreos.com/launchconfiguration=\r\n                    kube-aws.coreos.com/role=storage\r\n                    kube-aws.coreos.com/zone=c\r\n                    kubernetes.io/arch=amd64\r\n                    kubernetes.io/hostname=ip-10-1-45-17.eu-west-1.compute.internal\r\n                    kubernetes.io/os=linux\r\n                    kubernetes.io/role=node\r\n                    node-role.kubernetes.io/node=\r\n                    node-role.kubernetes.io/storageC=\r\n                    node.kubernetes.io/role=storageC\r\n```\r\n\r\n* Cluster CR (custom resource), typically called `cluster.yaml`, if necessary\r\n```\r\napiVersion: ceph.rook.io/v1\r\nkind: CephCluster\r\nmetadata:\r\n  name: rook-ceph\r\n  namespace: rook-ceph\r\nspec:\r\n  dataDirHostPath: /var/lib/rook/cluster\r\n  mon:\r\n    count: 3\r\n    allowMultiplePerNode: false\r\n    volumeClaimTemplate:\r\n      spec:\r\n        storageClassName: ebs-gp2\r\n        resources:\r\n          requests:\r\n            storage: 10Gi\r\n  mgr:\r\n    modules:\r\n    - name: pg_autoscaler\r\n      enabled: true           \r\n  placement:\r\n    mon:\r\n      nodeAffinity:\r\n        requiredDuringSchedulingIgnoredDuringExecution:\r\n          nodeSelectorTerms:\r\n          - matchExpressions:\r\n            - key: kube-aws.coreos.com/role\r\n              operator: In\r\n              values:\r\n              - storage \r\n      # Pod Anti Affinity for the mon pods are handled through the spec.mon.allowMultiplePerNodesetting\r\n      # podAntiAffinity:\r\n        # requiredDuringSchedulingIgnoredDuringExecution:\r\n        # - labelSelector:\r\n            # matchExpressions:\r\n            # - key: app\r\n              # operator: In\r\n              # values:\r\n              # - rook-ceph-mon\r\n          # topologyKey: failure-domain.beta.kubernetes.io/zone              \r\n      tolerations:\r\n        - key: kube-aws.coreos.com/role\r\n          operator: Equal\r\n          value: storage\r\n          effect: NoSchedule \r\n    # mgr:\r\n    #   nodeAffinity:\r\n    #     requiredDuringSchedulingIgnoredDuringExecution:\r\n    #       nodeSelectorTerms:\r\n    #       - matchExpressions:\r\n    #         - key: kube-aws.coreos.com/role\r\n    #           operator: In\r\n    #           values:\r\n    #           - storage \r\n    #   tolerations:\r\n    #     - key: kube-aws.coreos.com/role\r\n    #       operator: Equal\r\n    #       value: storage\r\n    #       effect: NoSchedule               \r\n  cephVersion:\r\n    image: ceph/ceph:v14.2.4-20190917\r\n    allowUnsupported: false\r\n  dashboard:\r\n    enabled: true\r\n    urlPrefix: /ceph-dashboard\r\n    port: 8443\r\n    ssl: false\r\n  monitoring:\r\n    # requires Prometheus to be pre-installed\r\n    enabled: true\r\n    # namespace to deploy prometheusRule in. If empty, namespace of the cluster will be used.\r\n    # Recommended:\r\n    # If you have a single rook-ceph cluster, set the rulesNamespace to the same namespace as the cluster or keep it empty.\r\n    # If you have multiple rook-ceph clusters in the same k8s cluster, choose the same namespace (ideally, namespace with prometheus\r\n    # deployed) to set rulesNamespace for all the clusters. Otherwise, you will get duplicate alerts with multiple alert definitions.\r\n    rulesNamespace: rook-ceph    \r\n  network:\r\n    hostNetwork: false\r\n  storage:\r\n    topologyAware: true\r\n    storageClassDeviceSets:\r\n    - name: zone-a\r\n      count: 1\r\n      portable: true\r\n      resources:\r\n        limits:\r\n          cpu: \"2000m\"\r\n          memory: \"4Gi\"\r\n        requests:\r\n          cpu: \"500m\"\r\n          memory: \"4Gi\"\r\n      placement:\r\n        nodeAffinity:\r\n          requiredDuringSchedulingIgnoredDuringExecution:\r\n            nodeSelectorTerms:\r\n            - matchExpressions:\r\n              - key: kube-aws.coreos.com/zone\r\n                operator: In\r\n                values:\r\n                - a \r\n              - key: kube-aws.coreos.com/role\r\n                operator: In\r\n                values:\r\n                - storage   \r\n        tolerations:\r\n        - key: kube-aws.coreos.com/role\r\n          operator: Equal\r\n          value: storage\r\n          effect: NoSchedule                \r\n      volumeClaimTemplates:\r\n      - metadata:\r\n          name: data\r\n        spec:\r\n          resources:\r\n            requests:\r\n              storage: 250Gi\r\n          storageClassName: ebs-gp2\r\n          volumeMode: Block\r\n          accessModes:\r\n            - ReadWriteOnce\r\n    - name: zone-b\r\n      count: 1\r\n      portable: true\r\n      resources:\r\n        limits:\r\n          cpu: \"2000m\"\r\n          memory: \"4Gi\"\r\n        requests:\r\n          cpu: \"500m\"\r\n          memory: \"4Gi\"\r\n      placement:\r\n        nodeAffinity:\r\n          requiredDuringSchedulingIgnoredDuringExecution:\r\n            nodeSelectorTerms:\r\n            - matchExpressions:\r\n              - key: kube-aws.coreos.com/zone\r\n                operator: In\r\n                values:\r\n                - b\r\n              - key: kube-aws.coreos.com/role\r\n                operator: In\r\n                values:\r\n                - storage  \r\n        tolerations:\r\n        - key: kube-aws.coreos.com/role\r\n          operator: Equal\r\n          value: storage\r\n          effect: NoSchedule                \r\n      volumeClaimTemplates:\r\n      - metadata:\r\n          name: data\r\n        spec:\r\n          resources:\r\n            requests:\r\n              storage: 250Gi\r\n          storageClassName: ebs-gp2\r\n          volumeMode: Block\r\n          accessModes:\r\n            - ReadWriteOnce \r\n    - name: zone-c\r\n      count: 1\r\n      portable: true\r\n      resources:\r\n        limits:\r\n          cpu: \"2000m\"\r\n          memory: \"4Gi\"\r\n        requests:\r\n          cpu: \"500m\"\r\n          memory: \"4Gi\"\r\n      placement:\r\n        nodeAffinity:\r\n          requiredDuringSchedulingIgnoredDuringExecution:\r\n            nodeSelectorTerms:\r\n            - matchExpressions:\r\n              - key: kube-aws.coreos.com/zone\r\n                operator: In\r\n                values:\r\n                - c\r\n              - key: kube-aws.coreos.com/role\r\n                operator: In\r\n                values:\r\n                - storage \r\n        tolerations:\r\n        - key: kube-aws.coreos.com/role\r\n          operator: Equal\r\n          value: storage\r\n          effect: NoSchedule\r\n      volumeClaimTemplates:\r\n      - metadata:\r\n          name: data\r\n        spec:\r\n          resources:\r\n            requests:\r\n              storage: 250Gi\r\n          storageClassName: ebs-gp2\r\n          volumeMode: Block\r\n          accessModes:\r\n            - ReadWriteOnce     \r\n```\r\n\r\n\r\n**Environment**:\r\n* OS (e.g. from /etc/os-release):\r\n```\r\nNAME=\"Container Linux by CoreOS\"\r\nID=coreos\r\nVERSION=2247.7.0\r\nVERSION_ID=2247.7.0\r\nBUILD_ID=2019-11-19-2251\r\nPRETTY_NAME=\"Container Linux by CoreOS 2247.7.0 (Rhyolite)\"\r\nANSI_COLOR=\"38;5;75\"\r\nHOME_URL=\"https://coreos.com/\"\r\nBUG_REPORT_URL=\"https://issues.coreos.com\"\r\nCOREOS_BOARD=\"amd64-usr\"\r\n```\r\n* Kernel (e.g. `uname -a`):\r\n`Linux ip-10-1-45-17.eu-west-1.compute.internal 4.19.84-coreos #1 SMP Tue Nov 19 20:51:06 -00 2019 x86_64 AMD EPYC 7571 AuthenticAMD GNU/Linux`\r\n* Cloud provider or hardware configuration:\r\nAWS\r\n* Rook version (use `rook version` inside of a Rook Pod):\r\nupgrade from 1.1.7 to 1.2.0\r\n* Storage backend version (e.g. for ceph do `ceph -v`):\r\nv14.2.4-20190917\r\n* Kubernetes version (use `kubectl version`):\r\n1.14.8\r\n* Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift):\r\nSelf managed K8s cluster deployed to AWS using the [kube-aws tool](https://github.com/kubernetes-incubator/kube-aws)\r\n* Storage backend status (e.g. for Ceph use `ceph health` in the [Rook Ceph toolbox]\r\nBefore upgrade\r\n```\r\ncluster:\r\n    id:     cd74ad6e-183f-4593-8e0c-717e61fee519\r\n    health: HEALTH_OK\r\n  services:\r\n    mon: 3 daemons, quorum a,b,c (age 3w)\r\n    mgr: a(active, since 12d)\r\n    mds: r2-fs:3 {0=r2-fs-b=up:active,1=r2-fs-c=up:active,2=r2-fs-e=up:active} 3 up:standby\r\n    osd: 3 osds: 3 up (since 3w), 3 in (since 3w)\r\n  data:\r\n    pools:   4 pools, 32 pgs\r\n    objects: 3.74k objects, 13 GiB\r\n    usage:   24 GiB used, 723 GiB / 747 GiB avail\r\n    pgs:     32 active+clean\r\n  io:\r\n    client:   170 B/s rd, 10 KiB/s wr, 0 op/s rd, 1 op/s wr\r\n```\r\n\r\nAfter upgrade\r\n```\r\ncluster:\r\n    id:     cd74ad6e-183f-4593-8e0c-717e61fee519\r\n    health: HEALTH_WARN\r\n            1 filesystem is degraded\r\n            3 MDSs report slow metadata IOs\r\n            Reduced data availability: 23 pgs inactive, 3 pgs peering, 17 pgs stale\r\n            Degraded data redundancy: 865/10877 objects degraded (7.953%), 14 pgs degraded, 16 pgs undersized\r\n            5 pgs not deep-scrubbed in time\r\n            5 pgs not scrubbed in time\r\n  services:\r\n    mon: 3 daemons, quorum a,b,c (age 17m)\r\n    mgr: a(active, since 16m)\r\n    mds: r2-fs:3/3 {0=r2-fs-e=up:replay,1=r2-fs-d=up:replay,2=r2-fs-c=up:replay} 3 up:standby\r\n    osd: 3 osds: 3 up (since 15m), 3 in (since 3w); 7 remapped pgs\r\n  data:\r\n    pools:   4 pools, 32 pgs\r\n    objects: 3.65k objects, 13 GiB\r\n    usage:   24 GiB used, 723 GiB / 747 GiB avail\r\n    pgs:     15.625% pgs unknown\r\n             56.250% pgs not active\r\n             865/10877 objects degraded (7.953%)\r\n             6771/10877 objects misplaced (62.251%)\r\n             11 stale+undersized+degraded+peered\r\n             7  active+clean+remapped\r\n             5  unknown\r\n             3  stale+peering\r\n             2  undersized+degraded+peered\r\n             1  stale+active+undersized+degraded+remapped\r\n             1  stale+active+clean\r\n             1  stale+undersized+peered\r\n             1  undersized+peered\r\n```",
  "closed_at": "2020-01-14T22:57:54Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/4616/comments",
  "created_at": "2020-01-06T09:07:08Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/4616/events",
  "html_url": "https://github.com/rook/rook/issues/4616",
  "id": 545618265,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    },
    {
      "color": "ef5c55",
      "default": false,
      "description": "main ceph tag",
      "id": 479456042,
      "name": "ceph",
      "node_id": "MDU6TGFiZWw0Nzk0NTYwNDI=",
      "url": "https://api.github.com/repos/rook/rook/labels/ceph"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/4616/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-09-11T22:42:52Z",
    "closed_issues": 65,
    "created_at": "2019-08-22T12:51:15Z",
    "creator": {
      "avatar_url": "https://avatars3.githubusercontent.com/u/912735?v=4",
      "events_url": "https://api.github.com/users/leseb/events{/privacy}",
      "followers_url": "https://api.github.com/users/leseb/followers",
      "following_url": "https://api.github.com/users/leseb/following{/other_user}",
      "gists_url": "https://api.github.com/users/leseb/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/leseb",
      "id": 912735,
      "login": "leseb",
      "node_id": "MDQ6VXNlcjkxMjczNQ==",
      "organizations_url": "https://api.github.com/users/leseb/orgs",
      "received_events_url": "https://api.github.com/users/leseb/received_events",
      "repos_url": "https://api.github.com/users/leseb/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/leseb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leseb/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/leseb"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/rook/rook/milestone/13",
    "id": 4594913,
    "labels_url": "https://api.github.com/repos/rook/rook/milestones/13/labels",
    "node_id": "MDk6TWlsZXN0b25lNDU5NDkxMw==",
    "number": 13,
    "open_issues": 0,
    "state": "closed",
    "title": "1.2",
    "updated_at": "2020-09-18T21:21:55Z",
    "url": "https://api.github.com/repos/rook/rook/milestones/13"
  },
  "node_id": "MDU6SXNzdWU1NDU2MTgyNjU=",
  "number": 4616,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Node topology labels are not applied to PV backed OSDs on rook 1.2.0 after upgrade from v1.1",
  "updated_at": "2020-01-21T07:29:04Z",
  "url": "https://api.github.com/repos/rook/rook/issues/4616",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/9726307?v=4",
    "events_url": "https://api.github.com/users/paalkr/events{/privacy}",
    "followers_url": "https://api.github.com/users/paalkr/followers",
    "following_url": "https://api.github.com/users/paalkr/following{/other_user}",
    "gists_url": "https://api.github.com/users/paalkr/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/paalkr",
    "id": 9726307,
    "login": "paalkr",
    "node_id": "MDQ6VXNlcjk3MjYzMDc=",
    "organizations_url": "https://api.github.com/users/paalkr/orgs",
    "received_events_url": "https://api.github.com/users/paalkr/received_events",
    "repos_url": "https://api.github.com/users/paalkr/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/paalkr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paalkr/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/paalkr"
  }
}