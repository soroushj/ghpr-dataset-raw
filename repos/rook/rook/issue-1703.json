{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "* Bug Report\r\n\r\n\r\n**Bug Report**\r\n\r\nWhat happened:\r\nHealthy cluster switched to HEALTH_WARN with noscrub, nodeep-scrub set.\r\nfrom a monitor's log:\r\n```\r\n2018-05-03 04:55:20.368135 I | rook-ceph-mon43: 2018-05-03 04:55:20.368063 7f98b91c1700  0 log_channel(audit) log [INF] : from='client.? 10.200.6.20:0/726453488' entity='client.admin' cmd=[{\"prefix\": \"osd set\", \"key\": \"noscrub\", \"format\": \"json\"}]: dispatch\r\n2018-05-03 04:55:20.829366 I | rook-ceph-mon43: 2018-05-03 04:55:20.368070 mon.rook-ceph-mon43 mon.0 10.32.16.136:6790/0 9827 : audit [INF] from='client.? 10.200.6.20:0/726453488' entity='client.admin' cmd=[{\"prefix\": \"osd set\", \"key\": \"noscrub\", \"format\": \"json\"}]: dispatch\r\n2018-05-03 04:55:20.834873 I | rook-ceph-mon43: 2018-05-03 04:55:20.834772 7f98bb9c6700  0 log_channel(cluster) log [WRN] : Health check failed: noscrub flag(s) set (OSDMAP_FLAGS)\r\n```\r\n\r\n10.200.6.20 is my operator pod:\r\n```\r\n~ kubectl get po --all-namespaces -o wide |grep 10.200.6.20\r\nrook-system    rook-operator-84b54c668-zqbhk    1/1       Running       5      4d        10.200.6.20\r\n```\r\n\r\nIt appears to set the flags right after startup\r\n```\r\n2018-05-06 16:04:07.495520 I | rook: starting Rook v0.7.1 with arguments '/usr/local/bin/rook operator'\r\n2018-05-06 16:04:07.495579 I | rook: flag values: --help=false, --log-level=INFO, --mon-healthcheck-interval=20s, --mon-out-timeout=5m0s\r\n2018-05-06 16:04:07.496963 I | rook: starting operator\r\n2018-05-06 16:04:07.526413 I | op-k8sutil: returning version v1.10.2 instead of v1.10.2+coreos.0\r\n2018-05-06 16:04:10.184359 I | op-k8sutil: cluster role rook-agent already exists. Updating if needed.\r\n2018-05-06 16:04:10.216385 I | op-agent: getting flexvolume dir path from FLEXVOLUME_DIR_PATH env var\r\n2018-05-06 16:04:10.216400 I | op-agent: discovered flexvolume dir path from source env var. value: /var/lib/kubelet/volumeplugins\r\n2018-05-06 16:04:10.223904 I | op-agent: rook-agent daemonset already exists\r\n2018-05-06 16:04:10.225904 I | operator: rook-provisioner started\r\n2018-05-06 16:04:10.225914 I | op-cluster: start watching clusters in all namespaces\r\n2018-05-06 16:04:10.261069 I | op-cluster: starting cluster in namespace rook\r\n2018-05-06 16:04:16.285907 I | op-mon: start running mons\r\n2018-05-06 16:04:16.355037 I | cephmon: parsing mon endpoints: rook-ceph-mon39=10.32.161.247:6790,rook-ceph-mon41=10.32.50.15:6790,rook-ceph-mon42=10.32.38.222:6790,rook-ceph-mon43=10.32.16.136:6790,rook-ceph-mon40=10.32.42.231:6790\r\n(omitted ops-mon loaded)\r\n2018-05-06 16:04:16.365227 I | cephmon: writing config file /var/lib/rook/rook/rook.config\r\n2018-05-06 16:04:16.365280 I | cephmon: generated admin config in /var/lib/rook/rook\r\n2018-05-06 16:04:22.492775 I | op-mgr: start running mgr\r\n2018-05-06 16:04:22.495808 I | op-mgr: the mgr keyring was already generated\r\n2018-05-06 16:04:22.495924 I | exec: Running command: ceph mgr module enable prometheus --force --cluster=rook --conf=/var/lib/rook/rook/rook.config --keyring=/var/lib/rook/rook/client.admin.keyring --format json --out-file /tmp/502549900\r\n2018-05-06 16:04:23.768502 I | op-mgr: rook-ceph-mgr0 service already exists\r\n2018-05-06 16:04:23.789771 I | op-mgr: rook-ceph-mgr0 deployment already exists\r\n2018-05-06 16:04:23.789796 I | op-api: starting the Rook api\r\n2018-05-06 16:04:23.817507 I | op-api: api service already running\r\n2018-05-06 16:04:23.843519 I | op-k8sutil: role rook-api already exists in namespace rook. updating if needed.\r\n2018-05-06 16:04:23.917470 I | op-api: api deployment already exists\r\n2018-05-06 16:04:23.917484 I | op-osd: start running osds in namespace rook\r\n2018-05-06 16:04:23.929936 I | op-k8sutil: role rook-ceph-osd already exists in namespace rook. updating if needed.\r\n2018-05-06 16:04:24.044991 I | exec: Running command: ceph osd set noscrub --cluster=rook --conf=/var/lib/rook/rook/rook.config --keyring=/var/lib/rook/rook/client.admin.keyring --format json --out-file /tmp/415296891\r\n2018-05-06 16:04:24.831535 I | exec: noscrub is set\r\n2018-05-06 16:04:24.831703 I | exec: Running command: ceph osd set nodeep-scrub --cluster=rook --conf=/var/lib/rook/rook/rook.config --keyring=/var/lib/rook/rook/client.admin.keyring --format json --out-file /tmp/380072094\r\n2018-05-06 16:04:25.272688 I | op-provisioner: Deleting volume pvc-219f522f-342b-11e8-9c08-005056b7de0d\r\n``` \r\nIt turns out the logs in the operator report a rogue node, which it still wants to setup, but which isn't available anymore. We tested around with a new matchbox boot config and thus added a node. It never got added completely to the cluster, so we removed it from the rook-cluster.yaml again. \r\nIt however remained in the `rook-ceph-osd-orchestration-status` ConfigMap as \r\n```\r\napiVersion: v1\r\ndata:\r\n  icc-node-99.icc.informatik.haw-hamburg.de: '{\"status\":\"starting\",\"message\":\"\"}'\r\n  ...\r\n```\r\nAfter deleting that line in the configMap and restarting the rook-operator, it sets and unsets noscrub,nodeep-scrub during its startup/initializing procedure.\r\n\r\nWhat you expected to happen:\r\nCluster stays healthy\r\n\r\nHow to reproduce it (minimal and precise):\r\n<!-- Please let us know any circumstances for reproduction of your bug. -->\r\n1. Bring up new node to K8s cluster\r\n2. Add new node to rook-cluster CRD yaml\r\n3. Restart rook-operator\r\n4. Node has some network connectivity error, so cannot be added to the cluster\r\n5. Remove node from K8s and rook-cluster CRD  yaml\r\n6. \"status:starting\" entry remains in `rook-ceph-osd-orchestration-status` ConfigMap\r\n7. rook operator will set noscrub,nodeep-scrub during startup and will not be able to recover from it\r\n\r\n\r\n**Environment**:\r\n* OS (e.g. from /etc/os-release): ContainerLinux 1688.5.3\r\n* Kernel (e.g. `uname -a`): 4.14.32-coreos\r\n* Cloud provider or hardware configuration: bare-metal\r\n* Rook version (use `rook version` inside of a Rook Pod): 0.7.1\r\n* Kubernetes version (use `kubectl version`): 1.10.2\r\n* Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift): bare-metal\r\n* Ceph status (use `ceph health` in the [Rook toolbox](https://Rook.io/docs/Rook/master/toolbox.html)): HEALTH_WARN noscrub,nodeep-scrub flag(s) set\r\n",
  "closed_at": "2019-04-26T17:08:23Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 7,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/1703/comments",
  "created_at": "2018-05-07T05:11:40Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/1703/events",
  "html_url": "https://github.com/rook/rook/issues/1703",
  "id": 320675553,
  "labels": [
    {
      "color": "ef5c55",
      "default": false,
      "description": "main ceph tag",
      "id": 479456042,
      "name": "ceph",
      "node_id": "MDU6TGFiZWw0Nzk0NTYwNDI=",
      "url": "https://api.github.com/repos/rook/rook/labels/ceph"
    },
    {
      "color": "00aaaa",
      "default": false,
      "description": null,
      "id": 479820581,
      "name": "operator",
      "node_id": "MDU6TGFiZWw0Nzk4MjA1ODE=",
      "url": "https://api.github.com/repos/rook/rook/labels/operator"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/1703/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMjA2NzU1NTM=",
  "number": 1703,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Rook Operator sets noscrub, nodeep-scrub",
  "updated_at": "2019-04-26T17:08:23Z",
  "url": "https://api.github.com/repos/rook/rook/issues/1703",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/738953?v=4",
    "events_url": "https://api.github.com/users/christianhuening/events{/privacy}",
    "followers_url": "https://api.github.com/users/christianhuening/followers",
    "following_url": "https://api.github.com/users/christianhuening/following{/other_user}",
    "gists_url": "https://api.github.com/users/christianhuening/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/christianhuening",
    "id": 738953,
    "login": "christianhuening",
    "node_id": "MDQ6VXNlcjczODk1Mw==",
    "organizations_url": "https://api.github.com/users/christianhuening/orgs",
    "received_events_url": "https://api.github.com/users/christianhuening/received_events",
    "repos_url": "https://api.github.com/users/christianhuening/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/christianhuening/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/christianhuening/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/christianhuening"
  }
}