{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "While consuming OBC for brownfield case(for already existing bucket), any bucket operation(like ls)/ object operations(put/get) is failing with access denied.  Reproduced 3 out of 3 times and green filed cases it works fine. For this new user, secret, cm, obc,ob everything getting created successfully. All the operation with \"user\" which got bucket created is working fine\r\n\r\nFrom the logs I suspect the following:\r\n* assignment of the policy for new created user with the existing bucket is not happening properly\r\n\r\n```\r\nI0905 06:03:22.642985       7 controller.go:175]  \"level\"=0 \"msg\"=\"new Reconcile iteration\" \"key\"=\"default/smoke-retain-bucket\" \r\nI0905 06:03:22.643012       7 helpers.go:78]  \"level\"=0 \"msg\"=\"getting claim for key\" \"key\"=\"default/smoke-retain-bucket\" \r\nI0905 06:03:22.647597       7 helpers.go:61]  \"level\"=0 \"msg\"=\"validating claim for provisioning obc\" \"key\"=\"default/smoke-retain-bucket\" \"smoke-retain-bucket\"=null\r\nI0905 06:03:22.647623       7 helpers.go:192]  \"level\"=0 \"msg\"=\"getting ObjectBucketClaim's StorageClass\" \"key\"=\"default/smoke-retain-bucket\" \r\nI0905 06:03:22.649881       7 helpers.go:197]  \"level\"=0 \"msg\"=\"got StorageClass\" \"key\"=\"default/smoke-retain-bucket\" \"name\"=\"rook-smoke-retain-bucket\"\r\nI0905 06:03:22.649918       7 resourcehandlers.go:261]  \"level\"=0 \"msg\"=\"updating status:\" \"key\"=\"default/smoke-retain-bucket\" \"new status\"=\"pending\" \"obc\"=\"default/smoke-retain-bucket\" \"old status\"=\"\"\r\nI0905 06:03:22.660546       7 helpers.go:78]  \"level\"=0 \"msg\"=\"getting claim for key\" \"key\"=\"default/smoke-retain-bucket\" \r\nI0905 06:03:22.662229       7 controller.go:285]  \"level\"=0 \"msg\"=\"granting access to\" \"key\"=\"default/smoke-retain-bucket\" \"bucket\"=\"brownbkt\"\r\n2019-09-05 06:03:22.662247 I | op-bucket-prov: initializing and setting CreateOrGrant services\r\n2019-09-05 06:03:22.662258 I | op-bucket-prov: getting storage class \"rook-smoke-retain-bucket\"\r\n2019-09-05 06:03:22.669005 I | op-bucket-prov: Grant: allowing access to bucket \"brownbkt\" for OBC \"smoke-retain-bucket\"\r\n2019-09-05 06:03:22.669231 I | op-bucket-prov: Checking for existing bucket \"brownbkt\"\r\n2019-09-05 06:03:22.669381 I | exec: Running command: radosgw-admin bucket stats --bucket brownbkt --rgw-realm=teststore --rgw-zonegroup=teststore --cluster=smoke-ns --conf=/var/lib/rook/smoke-ns/smoke-ns.config --keyring=/var/lib/rook/smoke-ns/client.admin.keyring\r\n2019-09-05 06:03:23.091391 I | exec: Running command: radosgw-admin metadata get bucket:brownbkt --rgw-realm=teststore --rgw-zonegroup=teststore --cluster=smoke-ns --conf=/var/lib/rook/smoke-ns/smoke-ns.config --keyring=/var/lib/rook/smoke-ns/client.admin.keyring\r\n2019-09-05 06:03:23.507606 I | op-object: Getting user: ceph-user-keXepdXG\r\n2019-09-05 06:03:23.507887 I | exec: Running command: radosgw-admin user info --uid ceph-user-keXepdXG --rgw-realm=teststore --rgw-zonegroup=teststore --cluster=smoke-ns --conf=/var/lib/rook/smoke-ns/smoke-ns.config --keyring=/var/lib/rook/smoke-ns/client.admin.keyring\r\n2019-09-05 06:03:23.923585 I | op-bucket-prov: creating Ceph user \"ceph-user-keXepdXG\"\r\n2019-09-05 06:03:23.923909 I | op-object: Creating user: ceph-user-keXepdXG\r\n2019-09-05 06:03:23.924007 I | exec: Running command: radosgw-admin user create --uid ceph-user-keXepdXG --display-name ceph-user-keXepdXG --rgw-realm=teststore --rgw-zonegroup=teststore --cluster=smoke-ns --conf=/var/lib/rook/smoke-ns/smoke-ns.config --keyring=/var/lib/rook/smoke-ns/client.admin.keyring\r\n2019-09-05 06:03:24.358583 I | op-bucket-prov: successfully created Ceph user \"ceph-user-keXepdXG\" with access keys\r\n2019-09-05 06:03:24.358636 I | op-object: Setting user \"ceph-user-keXepdXG\" max buckets to 0\r\n2019-09-05 06:03:24.358673 I | exec: Running command: radosgw-admin quota set --uid ceph-user-keXepdXG --quota-scope user --max-buckets 0 --rgw-realm=teststore --rgw-zonegroup=teststore --cluster=smoke-ns --conf=/var/lib/rook/smoke-ns/smoke-ns.config --keyring=/var/lib/rook/smoke-ns/client.admin.keyring\r\n2019-09-05 06:03:24.814821 I | exec: Running command: radosgw-admin bucket stats --bucket brownbkt --rgw-realm=teststore --rgw-zonegroup=teststore --cluster=smoke-ns --conf=/var/lib/rook/smoke-ns/smoke-ns.config --keyring=/var/lib/rook/smoke-ns/client.admin.keyring\r\n2019-09-05 06:03:25.143115 I | exec: Running command: radosgw-admin metadata get bucket:brownbkt --rgw-realm=teststore --rgw-zonegroup=teststore --cluster=smoke-ns --conf=/var/lib/rook/smoke-ns/smoke-ns.config --keyring=/var/lib/rook/smoke-ns/client.admin.keyring\r\n**2019-09-05 06:03:25.462211 I | op-object: Getting user: rook-user\r\n2019-09-05 06:03:25.462272 I | exec: Running command: radosgw-admin user info --uid rook-user --rgw-realm=teststore --rgw-zonegroup=teststore --cluster=smoke-ns --conf=/var/lib/rook/smoke-ns/smoke-ns.config --keyring=/var/lib/rook/smoke-ns/client.admin.keyring\r\n2019-09-05 06:03:25.819916 I | op-bucket-prov: PutBucketPolicy output: {\r\n\r\n}**\r\nI0905 06:03:25.820429       7 resourcehandlers.go:139]  \"level\"=0 \"msg\"=\"creating Secret\" \"key\"=\"default/smoke-retain-bucket\" \"name\"=\"default/smoke-retain-bucket\"\r\nI0905 06:03:25.829235       7 resourcehandlers.go:162]  \"level\"=0 \"msg\"=\"creating ConfigMap\" \"key\"=\"default/smoke-retain-bucket\" \"name\"=\"default/smoke-retain-bucket\"\r\nI0905 06:03:25.834163       7 helpers.go:78]  \"level\"=0 \"msg\"=\"getting claim for key\" \"key\"=\"default/smoke-retain-bucket\" \r\nI0905 06:03:25.836207       7 resourcehandlers.go:119]  \"level\"=0 \"msg\"=\"creating ObjectBucket\" \"key\"=\"default/smoke-retain-bucket\" \"name\"=\"obc-default-smoke-retain-bucket\"\r\nI0905 06:03:25.841521       7 resourcehandlers.go:273]  \"level\"=0 \"msg\"=\"updating status:\" \"key\"=\"default/smoke-retain-bucket\" \"new status\"=\"bound\" \"ob\"=\"obc-default-smoke-retain-bucket\" \"old status\"=\"\"\r\nI0905 06:03:25.845274       7 resourcehandlers.go:252]  \"level\"=0 \"msg\"=\"updating\" \"key\"=\"default/smoke-retain-bucket\" \"obc\"=\"default/smoke-retain-bucket\"\r\nI0905 06:03:25.848818       7 resourcehandlers.go:261]  \"level\"=0 \"msg\"=\"updating status:\" \"key\"=\"default/smoke-retain-bucket\" \"new status\"=\"bound\" \"obc\"=\"default/smoke-retain-bucket\" \"old status\"=\"pending\"\r\nI0905 06:03:25.852293       7 controller.go:333]  \"level\"=0 \"msg\"=\"provisioning succeeded\" \"key\"=\"default/smoke-retain-bucket\"\r\n```\r\n\r\nHere the output from put policy seems to be empty. So I am guessing the user created as part of obc  is not fully authorised perform the  s3 operations\r\n\r\n**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\ns3 operations fails for obc supporting brownfield \r\n\r\n**Expected behavior:**\r\ns3 operations should pass \r\n\r\n**How to reproduce it (minimal and precise):**\r\n* Create rook cluster with object store\r\n* Create user and then create a bucket\r\n* Create Storage class for the bucket(retain) and then create obc(retain)\r\n(Use the examples given rook repo)\r\n\r\n**Environment**:\r\n* OS (e.g. from /etc/os-release): fedora 30\r\n* Kernel (e.g. `uname -a`):  5.2.9-200.fc30.x86_64\r\n* Cloud provider or hardware configuration: using minikube with driver option none\r\n* Rook version (use `rook version` inside of a Rook Pod):\r\n* Storage backend version (e.g. for ceph do `ceph -v`): ceph version 14.2.2\r\n* Kubernetes version (use `kubectl version`): v1.15.3\r\n* Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift): minikube\r\n* Storage backend status (e.g. for Ceph use `ceph health` in the [Rook Ceph toolbox](https://rook.io/docs/rook/master/ceph-toolbox.html)): \r\n",
  "closed_at": "2019-10-10T21:48:36Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 14,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/3792/comments",
  "created_at": "2019-09-06T09:07:09Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/3792/events",
  "html_url": "https://github.com/rook/rook/issues/3792",
  "id": 490215603,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/3792/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0OTAyMTU2MDM=",
  "number": 3792,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "OBC : Object operation is failing on Brownfield cases",
  "updated_at": "2019-10-10T21:48:36Z",
  "url": "https://api.github.com/repos/rook/rook/issues/3792",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/2588766?v=4",
    "events_url": "https://api.github.com/users/thotz/events{/privacy}",
    "followers_url": "https://api.github.com/users/thotz/followers",
    "following_url": "https://api.github.com/users/thotz/following{/other_user}",
    "gists_url": "https://api.github.com/users/thotz/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/thotz",
    "id": 2588766,
    "login": "thotz",
    "node_id": "MDQ6VXNlcjI1ODg3NjY=",
    "organizations_url": "https://api.github.com/users/thotz/orgs",
    "received_events_url": "https://api.github.com/users/thotz/received_events",
    "repos_url": "https://api.github.com/users/thotz/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/thotz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thotz/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/thotz"
  }
}