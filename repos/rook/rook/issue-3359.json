{
  "active_lock_reason": null,
  "assignee": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/11498120?v=4",
    "events_url": "https://api.github.com/users/rohan47/events{/privacy}",
    "followers_url": "https://api.github.com/users/rohan47/followers",
    "following_url": "https://api.github.com/users/rohan47/following{/other_user}",
    "gists_url": "https://api.github.com/users/rohan47/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rohan47",
    "id": 11498120,
    "login": "rohan47",
    "node_id": "MDQ6VXNlcjExNDk4MTIw",
    "organizations_url": "https://api.github.com/users/rohan47/orgs",
    "received_events_url": "https://api.github.com/users/rohan47/received_events",
    "repos_url": "https://api.github.com/users/rohan47/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rohan47/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rohan47/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rohan47"
  },
  "assignees": [
    {
      "avatar_url": "https://avatars0.githubusercontent.com/u/11498120?v=4",
      "events_url": "https://api.github.com/users/rohan47/events{/privacy}",
      "followers_url": "https://api.github.com/users/rohan47/followers",
      "following_url": "https://api.github.com/users/rohan47/following{/other_user}",
      "gists_url": "https://api.github.com/users/rohan47/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rohan47",
      "id": 11498120,
      "login": "rohan47",
      "node_id": "MDQ6VXNlcjExNDk4MTIw",
      "organizations_url": "https://api.github.com/users/rohan47/orgs",
      "received_events_url": "https://api.github.com/users/rohan47/received_events",
      "repos_url": "https://api.github.com/users/rohan47/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rohan47/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rohan47/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rohan47"
    }
  ],
  "author_association": "NONE",
  "body": "**Description of problem:**\r\n\r\nRook csi ceph setup = latest rook + csi setup (after PR -https://github.com/rook/rook/pull/3324 was merged) \r\n\r\nIn a 3 master + 3 worker(ceph nodes) setup, deleted a machine. The corresponding MON and OSD pods went into Pending state. But machineset added a new node to the cluster automatically. \r\n\r\nThen, after some time, a new mon(mon-d) came up on the new node( to keep the MON count=3 intact). But, as seen in operator logs,  when operator tried to destroy the failed OSD, it resulted in a panic and the operator pod restarted. \r\n\r\n**Log snip**\r\n----------------\r\n```\r\n2019-06-26 13:27:55.071027 I | op-k8sutil: removing deployment rook-ceph-osd-1 if it exists\r\n2019-06-26 13:27:55.080683 I | op-k8sutil: Removed deployment rook-ceph-osd-1\r\n2019-06-26 13:27:55.085049 I | op-k8sutil: rook-ceph-osd-1 still found. waiting...\r\n2019-06-26 13:27:57.089046 I | op-k8sutil: confirmed rook-ceph-osd-1 does not exist\r\n2019-06-26 13:32:57.648512 I | op-osd: osd.1 is marked 'DOWN'\r\n2019-06-26 13:32:57.648667 I | exec: Running command: ceph osd safe-to-destroy 1 --connect-timeout=15 --cluster=openshift-storage --conf=/var/lib/rook/openshift-storage/openshift-storage.config --keyring=/var/lib/rook/openshift-storage/client.admin.keyring --format json --out-file /tmp/291551664\r\n2019-06-26 13:32:58.145233 I | op-osd: osd.1 is 'safe-to-destroy'\r\npanic: runtime error: index out of range\r\n\r\ngoroutine 1717 [running]:\r\ngithub.com/rook/rook/pkg/operator/ceph/cluster/osd.(*Monitor).handleOSDMarkedOut(0xc000accb00, 0x1, 0x16, 0xc0010a9e38)\r\n\t/home/rook/go/src/github.com/rook/rook/pkg/operator/ceph/cluster/osd/health.go:119 +0x362\r\ngithub.com/rook/rook/pkg/operator/ceph/cluster/osd.(*Monitor).osdStatus(0xc000accb00, 0xc000a38d80, 0x1)\r\n\t/home/rook/go/src/github.com/rook/rook/pkg/operator/ceph/cluster/osd/health.go:98 +0x3b4\r\ngithub.com/rook/rook/pkg/operator/ceph/cluster/osd.(*Monitor).Start(0xc000accb00, 0xc000baa720)\r\n\t/home/rook/go/src/github.com/rook/rook/pkg/operator/ceph/cluster/osd/health.go:55 +0x130\r\ncreated by github.com/rook/rook/pkg/operator/ceph/cluster.(*ClusterController).onAdd\r\n\t/home/rook/go/src/github.com/rook/rook/pkg/operator/ceph/cluster/controller.go:366 +0x124c\r\n\r\n```\r\n**Observations:**\r\n\r\n\r\n1. The OSD couldn't be destroyed even after the timeout specified by operator.\r\nTime when node was deleted(OSD and MON went down)  = 2019-06-26 13:14:54.562085\r\n\r\n2. There was a panic in operator logs and the operator pod restarted abruptly. This led to loss of the previous logs.\r\n\r\n3. As seen in ceph status, we even see the MGR as restarted, though the pod in \"oc get pods\" doesnt show the restart \r\n\r\n  services:\r\n    mon: 3 daemons, quorum b,c,d (age 29m)\r\n    mgr: a(active, since 22m)\r\n\r\n\r\n**How reproducible:**\r\nTested once.\r\n\r\n**Steps to Reproduce:**\r\n\r\n\r\n1. Create a ceph based rook-csi cluster using the latest rook repo files (https://github.com/rook/rook) - master branch\r\n\r\n2. Remove one of the machine \r\n  $ date; time oc delete machine/nberry-jun26-1-mwzjg-worker-us-east-2a-4ppjb -n openshift-machine-api; date\r\n\r\n3. After some time, confirm that a new OCP node is spun up and a new machine is added.\r\n\r\n4. Wait for MON timeout of 600 sec and confirm that a new MON is spinned on the new node( as required mon count in cluster=3).\r\n\r\n5. Keep checking operator logs for any restarts or panic as showed above.\r\n\r\n\r\n\r\n**Actual results:**\r\n\r\nOperator pod reported panic and restarted.\r\n\r\n**Expected results:**\r\n\r\nThe osd should be destoyed since it been OUT of the cluster for more than 30 mins\r\n\r\n osd: 3 osds: 2 up (since 40m), 2 in (since 30m)\r\n\r\n\r\n**The OSD  is finally  not seen as part of below command,** \r\nsh-4.2# ceph osd status\r\n+----+--------------------------------------------+-------+-------+--------+---------+--------+---------+----------------+\r\n| id |                    host                    |  used | avail | wr ops | wr data | rd ops | rd data |     state      |\r\n+----+--------------------------------------------+-------+-------+--------+---------+--------+---------+----------------+\r\n| 0  | ip-10-0-149-134.us-east-2.compute.internal | 1025M | 97.9G |    0   |     0   |    1   |    16   |   exists,up    |\r\n| 1  |                                            |    0  |    0  |    0   |     0   |    0   |     0   | autoout,exists |\r\n| 2  | ip-10-0-161-198.us-east-2.compute.internal | 1025M | 97.9G |    0   |     0   |    1   |    90   |   exists,up    |\r\n+----+--------------------------------------------+-------+-------+--------+---------+--------+---------+----------------+\r\n\r\n**Version-Release number of selected component (if applicable):**\r\n\r\n```\r\nCeph and rook version\r\n-----------------------\r\n\r\nsh-4.2# ceph version\r\nceph version 14.2.1 (d555a9489eb35f84f2e1ef49b77e19da9d113972) nautilus (stable)\r\n\r\nsh-4.2# rook version\r\n rook: v1.0.0-154.g004f795\r\n\r\n\r\nCSI version\r\n-------------\r\n\r\n$oc logs csi-rbdplugin-provisioner-0 -n openshift-storage -c csi-rbdplugin\r\n\r\nI0626 09:40:26.830842       1 cephcsi.go:108] Starting driver type: rbd with name: rbd.csi.ceph.com\r\nI0626 09:40:26.830922       1 rbd.go:104] Driver: rbd.csi.ceph.com version: 1.0.0\r\n\r\n$ oc describe pod csi-rbdplugin-provisioner-0 -n openshift-storage|grep -i image\r\n    Image:         quay.io/k8scsi/csi-provisioner:v1.2.0\r\n    Image ID:      quay.io/k8scsi/csi-provisioner@sha256:0dffe9a8d39c4fdd49c5dd98ca5611a3f9726c012b082946f630e36988ba9f37\r\n    Image:         quay.io/k8scsi/csi-attacher:v1.1.1\r\n    Image ID:      quay.io/k8scsi/csi-attacher@sha256:e4db94969e1d463807162a1115192ed70d632a61fbeb3bdc97b40fe9ce78c831\r\n    Image:         quay.io/k8scsi/csi-snapshotter:v1.1.0\r\n    Image ID:      quay.io/k8scsi/csi-snapshotter@sha256:a49e0da1af6f2bf717e41ba1eee8b5e6a1cbd66a709dd92cc43fe475fe2589eb\r\n    Image:         quay.io/cephcsi/cephcsi:canary\r\n    Image ID:      quay.io/cephcsi/cephcsi@sha256:e832be9790bf12ab74c87217cce1dbd0a2416500e1d9a39af53b3fece414feac\r\n\r\nRook image\r\n----------------------\r\n\r\n$ oc describe pod rook-ceph-operator-5c6fd4b7db-rldcf -n openshift-storage|grep -i image\r\n    Image:         rook/ceph:master\r\n    Image ID:      docker.io/rook/ceph@sha256:4d0057e90c28a7bd8d3c3e9b13df40d0df1847567ef50a2a1e41dcea7ddb1d18\r\n      ROOK_CSI_CEPH_IMAGE:                quay.io/cephcsi/cephcsi:canary\r\n      ROOK_CSI_REGISTRAR_IMAGE:           quay.io/k8scsi/csi-node-driver-registrar:v1.1.0\r\n      ROOK_CSI_PROVISIONER_IMAGE:         quay.io/k8scsi/csi-provisioner:v1.2.0\r\n      ROOK_CSI_SNAPSHOTTER_IMAGE:         quay.io/k8scsi/csi-snapshotter:v1.1.0\r\n      ROOK_CSI_ATTACHER_IMAGE:            quay.io/k8scsi/csi-attacher:v1.1.1\r\n\r\n```\r\n",
  "closed_at": "2019-07-11T22:10:17Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/3989526?v=4",
    "events_url": "https://api.github.com/users/BlaineEXE/events{/privacy}",
    "followers_url": "https://api.github.com/users/BlaineEXE/followers",
    "following_url": "https://api.github.com/users/BlaineEXE/following{/other_user}",
    "gists_url": "https://api.github.com/users/BlaineEXE/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/BlaineEXE",
    "id": 3989526,
    "login": "BlaineEXE",
    "node_id": "MDQ6VXNlcjM5ODk1MjY=",
    "organizations_url": "https://api.github.com/users/BlaineEXE/orgs",
    "received_events_url": "https://api.github.com/users/BlaineEXE/received_events",
    "repos_url": "https://api.github.com/users/BlaineEXE/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/BlaineEXE/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/BlaineEXE/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/BlaineEXE"
  },
  "comments": 7,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/3359/comments",
  "created_at": "2019-06-26T14:37:45Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/3359/events",
  "html_url": "https://github.com/rook/rook/issues/3359",
  "id": 461011115,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    },
    {
      "color": "ef5c55",
      "default": false,
      "description": "main ceph tag",
      "id": 479456042,
      "name": "ceph",
      "node_id": "MDU6TGFiZWw0Nzk0NTYwNDI=",
      "url": "https://api.github.com/repos/rook/rook/labels/ceph"
    },
    {
      "color": "00aaaa",
      "default": false,
      "description": null,
      "id": 479820581,
      "name": "operator",
      "node_id": "MDU6TGFiZWw0Nzk4MjA1ODE=",
      "url": "https://api.github.com/repos/rook/rook/labels/operator"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/3359/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NjEwMTExMTU=",
  "number": 3359,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Panic reported in operator logs and operator pod restarted",
  "updated_at": "2019-07-11T22:10:17Z",
  "url": "https://api.github.com/repos/rook/rook/issues/3359",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/38582702?v=4",
    "events_url": "https://api.github.com/users/nehaberry/events{/privacy}",
    "followers_url": "https://api.github.com/users/nehaberry/followers",
    "following_url": "https://api.github.com/users/nehaberry/following{/other_user}",
    "gists_url": "https://api.github.com/users/nehaberry/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/nehaberry",
    "id": 38582702,
    "login": "nehaberry",
    "node_id": "MDQ6VXNlcjM4NTgyNzAy",
    "organizations_url": "https://api.github.com/users/nehaberry/orgs",
    "received_events_url": "https://api.github.com/users/nehaberry/received_events",
    "repos_url": "https://api.github.com/users/nehaberry/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/nehaberry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nehaberry/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/nehaberry"
  }
}