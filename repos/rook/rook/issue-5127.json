{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!-- **Are you in the right place?**\r\n1. For issues or feature requests, please create an issue in this repository.\r\n2. For general technical and non-technical questions, we are happy to help you on our [Rook.io Slack](https://slack.rook.io/).\r\n3. Did you already search the existing open issues for anything similar? -->\r\n\r\n**Is this a bug report or feature request?**\r\n* Bug Report\r\n\r\n**Deviation from expected behavior:**\r\n\r\n - When a replicated pool is created, min_size is fixed to <strong>2</strong> except replica size is 1.\r\nIt seems that currently min_size has nothing to do with replica size.\r\n\r\n\r\n**Expected behavior:**\r\n\r\n - Replicated pool's min_size should be calculated to ceil(size-(size/2)), which is Ceph does now.\r\n\r\n\r\n**How to reproduce it (minimal and precise):**\r\n<!-- Please let us know any circumstances for reproduction of your bug. -->\r\n\r\n - Create two rbd pools with replica_size 2 and 5.\r\nThen you can check min_size of each pool is set to 2.\r\nExpected values are 1 and 3 respectively.\r\n\r\n```shell\r\n[root@rook-ceph-tools-58df7d6b5c-2dxgs /]# ceph osd pool ls detail\r\npool 4 'replicapool1' replicated size 2 min_size 2 crush_rule 1 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 57 flags hashpspool stripe_width 0 application rbd\r\npool 5 'replicapool2' replicated size 5 min_size 2 crush_rule 2 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 59 flags hashpspool stripe_width 0 application rbd\r\n```\r\n\r\n\r\n**File(s) to submit**:\r\n\r\n* rbd pool yaml (only for 5 replica size)\r\n```yaml\r\napiVersion: ceph.rook.io/v1\r\nkind: CephBlockPool\r\nmetadata:\r\n  name: replicapool\r\n  namespace: rook-ceph\r\nspec:\r\n  failureDomain: host\r\n  replicated:\r\n    size: 5\r\n    requireSafeReplicaSize: true\r\n  annotations:\r\n```\r\n\r\n* Operator's logs in debug mode (only for 5-replicated pool creation)\r\n```shell\r\n$ kubectl logs -n rook-ceph rook-ceph-operator-57f9c9c9cf-27w8n\r\n\r\n...\r\n \r\n2020-03-31 03:44:36.146752 D | ceph-spec: update event from the parent object\r\n2020-03-31 03:44:36.146844 D | ceph-spec: update event from the parent object CephBlockPool\r\n2020-03-31 03:44:36.146942 D | ceph-spec: wont update unknown object\r\n2020-03-31 03:44:36.147054 D | ceph-spec: \"ceph-block-pool-controller\": CephCluster resource \"rook-ceph\" found in namespace \"rook-ceph\"\r\n2020-03-31 03:44:36.147170 D | exec: Running command: ceph status --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/395872842\r\n2020-03-31 03:44:36.833539 D | ceph-spec: \"ceph-block-pool-controller\": ceph status is \"HEALTH_OK\", operator is ready to run ceph command, reconciling\r\n2020-03-31 03:44:36.833562 I | ceph-spec: adding finalizer \"cephblockpool.ceph.rook.io\" on \"replicapool\"\r\n2020-03-31 03:44:36.836476 D | exec: Running command: ceph osd crush dump --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/618247969\r\n2020-03-31 03:44:36.836777 D | ceph-spec: update event from the parent object\r\n2020-03-31 03:44:36.836879 D | ceph-spec: update event from the parent object CephBlockPool\r\n2020-03-31 03:44:36.836996 D | clusterdisruption-controller: discovered NamespacedName: \"rook-ceph/rook-ceph\"\r\n2020-03-31 03:44:36.837075 D | clusterdisruption-controller: reconciling \"rook-ceph/rook-ceph\"\r\n2020-03-31 03:44:37.430031 I | ceph-block-pool-controller: creating pool \"replicapool\" in namespace \"rook-ceph\"\r\n2020-03-31 03:44:37.430139 D | ceph-spec: update event from the parent object\r\n2020-03-31 03:44:37.430158 D | ceph-spec: update event from the parent object CephBlockPool\r\n2020-03-31 03:44:37.430245 D | clusterdisruption-controller: discovered NamespacedName: \"rook-ceph/rook-ceph\"\r\n2020-03-31 03:44:37.430269 D | exec: Running command: ceph osd crush rule create-replicated replicapool default host --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/165480460\r\n2020-03-31 03:44:37.430319 D | clusterdisruption-controller: reconciling \"rook-ceph/rook-ceph\"\r\n2020-03-31 03:44:37.430373 D | ceph-spec: wont update unknown object\r\n2020-03-31 03:44:38.328920 D | exec: Running command: ceph osd pool create replicapool 0 replicated replicapool --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/742493179\r\n2020-03-31 03:44:40.363444 D | exec: pool 'replicapool' created\r\n2020-03-31 03:44:40.364107 D | exec: Running command: ceph osd pool set replicapool size 5 --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/366953246\r\n2020-03-31 03:44:42.830927 D | exec: set pool 1 size to 5\r\n2020-03-31 03:44:42.831123 D | exec: Running command: ceph osd pool application enable replicapool rbd --yes-i-really-mean-it --connect-timeout=15 --cluster=rook-ceph --conf=/var/lib/rook/rook-ceph/rook-ceph.config --keyring=/var/lib/rook/rook-ceph/client.admin.keyring --format json --out-file /tmp/055670245\r\n2020-03-31 03:44:43.854388 D | exec: enabled application 'rbd' on pool 'replicapool'\r\n2020-03-31 03:44:43.854514 I | cephclient: creating replicated pool replicapool succeeded\r\n\r\n...\r\n```\r\n\r\nIn above log, operator (i) creates pool first, then (ii) it sets pool's replica size.\r\nBut min_size seems be only set when the pool is created.\r\nSo min_size remains to 2 based on osd_pool_default_size 3.\r\n\r\nI think it is better that Rook sets a value (min_size, etc) in Ceph policy.\r\nThen, it should set min_size not to 2 but 3, when pool's replicated size is 5.\r\n\r\nIf you agree with my idea, I will implement it.\r\n\r\n**Environment**:\r\n* OS (e.g. from /etc/os-release): Ubuntu 18.04.3 LTS\r\n* Kernel (e.g. `uname -a`): 4.15.0-91-generic\r\n* Cloud provider or hardware configuration:\r\n* Rook version (use `rook version` inside of a Rook Pod):\r\n```\r\nrook: v1.1.0-beta.0.1152.ga50bab3\r\ngo: go1.13.8\r\n```\r\n* Storage backend version (e.g. for ceph do `ceph -v`):\r\n* Kubernetes version (use `kubectl version`):\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"15\", GitVersion:\"v1.15.0\", GitCommit:\"e8462b5b5dc2584fdcd18e6bcfe9f1e4d970a529\", GitTreeState:\"clean\", BuildDate:\"2019-06-19T16:40:16Z\", GoVersion:\"go1.12.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"15\", GitVersion:\"v1.15.10\", GitCommit:\"1bea6c00a7055edef03f1d4bb58b773fa8917f11\", GitTreeState:\"clean\", BuildDate:\"2020-02-11T20:05:26Z\", GoVersion:\"go1.12.12\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n* Kubernetes cluster type (e.g. Tectonic, GKE, OpenShift):\r\n* Storage backend status (e.g. for Ceph use `ceph health` in the [Rook Ceph toolbox](https://rook.io/docs/rook/master/ceph-toolbox.html)):\r\n```shell\r\n[root@rook-ceph-tools-58df7d6b5c-2dxgs /]# ceph -s\r\n  cluster:\r\n    id:     5b0d6ea6-0025-4e95-ae94-35f5681e268a\r\n    health: HEALTH_OK\r\n\r\n  services:\r\n    mon: 1 daemons, quorum a (age 3h)\r\n    mgr: a(active, since 3h)\r\n    osd: 6 osds: 6 up (since 3h), 6 in (since 3h)\r\n\r\n  data:\r\n    pools:   2 pools, 64 pgs\r\n    objects: 0 objects, 0 B\r\n    usage:   6.0 GiB used, 60 GiB / 66 GiB avail\r\n    pgs:     64 active+clean\r\n```",
  "closed_at": "2020-04-07T13:21:05Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1048514?v=4",
    "events_url": "https://api.github.com/users/travisn/events{/privacy}",
    "followers_url": "https://api.github.com/users/travisn/followers",
    "following_url": "https://api.github.com/users/travisn/following{/other_user}",
    "gists_url": "https://api.github.com/users/travisn/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/travisn",
    "id": 1048514,
    "login": "travisn",
    "node_id": "MDQ6VXNlcjEwNDg1MTQ=",
    "organizations_url": "https://api.github.com/users/travisn/orgs",
    "received_events_url": "https://api.github.com/users/travisn/received_events",
    "repos_url": "https://api.github.com/users/travisn/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/travisn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/travisn/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/travisn"
  },
  "comments": 9,
  "comments_url": "https://api.github.com/repos/rook/rook/issues/5127/comments",
  "created_at": "2020-03-31T05:34:04Z",
  "events_url": "https://api.github.com/repos/rook/rook/issues/5127/events",
  "html_url": "https://github.com/rook/rook/issues/5127",
  "id": 590808968,
  "labels": [
    {
      "color": "ee0000",
      "default": true,
      "description": "",
      "id": 405241115,
      "name": "bug",
      "node_id": "MDU6TGFiZWw0MDUyNDExMTU=",
      "url": "https://api.github.com/repos/rook/rook/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/rook/rook/issues/5127/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1OTA4MDg5Njg=",
  "number": 5127,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/rook/rook",
  "state": "closed",
  "title": "Ceph: Replicated pool min_size is only fixed to 2, regardless of replica size",
  "updated_at": "2020-04-07T13:21:05Z",
  "url": "https://api.github.com/repos/rook/rook/issues/5127",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/58548174?v=4",
    "events_url": "https://api.github.com/users/shellwedance/events{/privacy}",
    "followers_url": "https://api.github.com/users/shellwedance/followers",
    "following_url": "https://api.github.com/users/shellwedance/following{/other_user}",
    "gists_url": "https://api.github.com/users/shellwedance/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/shellwedance",
    "id": 58548174,
    "login": "shellwedance",
    "node_id": "MDQ6VXNlcjU4NTQ4MTc0",
    "organizations_url": "https://api.github.com/users/shellwedance/orgs",
    "received_events_url": "https://api.github.com/users/shellwedance/received_events",
    "repos_url": "https://api.github.com/users/shellwedance/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/shellwedance/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/shellwedance/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/shellwedance"
  }
}