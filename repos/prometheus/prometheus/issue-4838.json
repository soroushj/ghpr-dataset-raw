{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!--\r\n\r\n    Please do *NOT* ask usage questions in Github issues.\r\n\r\n    If your issue is not a feature request or bug report use:\r\n    https://groups.google.com/forum/#!forum/prometheus-users. If\r\n    you are unsure whether you hit a bug, search and ask in the\r\n    mailing list first.\r\n\r\n    You can find more information at: https://prometheus.io/community/\r\n\r\n-->\r\n## Bug Report\r\n**What did you do?**\r\n\r\nExecuting `promtool test rules` for alerts composed of recorded (record rules) metrics that use timeseries with many values\r\n\r\n**What did you expect to see?**\r\n```\r\n  SUCCESS\r\n```\r\n\r\n**What did you see instead? Under which circumstances?**\r\n\r\nI get:\r\n\r\n```\r\n  FAILED:\r\n    alertname:InstanceDown, time:10m0s,\r\n        exp:\"[Labels:{alertname=\\\"InstanceDown\\\", instance=\\\"localhost:9090\\\", job=\\\"prometheus\\\", severity=\\\"page\\\"} Annotations:{description=\\\"localhost:9090 of job prometheus has been down for more than 5 minutes.\\\", summary=\\\"Instance localhost:9090 down\\\"}]\",\r\n        got:\"[]\"\r\n```\r\n\r\nWhen:\r\n\r\n```\r\nalerts.yml:\r\n\r\n  - record: test:testrecord:avg3m\r\n    expr: avg_over_time(up[3m])\r\n\r\n  - alert: InstanceDown\r\n    expr: test:testrecord:avg3m == 0\r\n```\r\n\r\n```\r\ntest.yml:\r\n\r\n      input_series:\r\n          - series: 'up{job=\"prometheus\", instance=\"localhost:9090\"}'\r\n            values: '0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 500+0x900'\r\n```\r\n\r\n\r\n**Environment**\r\n\r\n* System information:\r\n\r\n`Linux 4.15.0-36-generic x86_64`\r\n\r\n* promtool version:\r\n```\r\npromtool, version 2.5.0 (branch: master, revision: bda9781ccda2b9c6051f30eb5f00e66059fe640a)\r\n  build user:       root@prometheus\r\n  build date:       20181107-09:52:29\r\n  go version:       go1.10.1\r\n```\r\n\r\n* promtool configuration file:\r\n\r\nI got your configs from docs (https://github.com/prometheus/prometheus/blob/master/docs/configuration/unit_testing_rules.md) and modified them to reproduce the issue, see last revision:\r\nhttps://gist.github.com/bititanb/017517528069ae1d0d70502bf95f6e26/revisions?diff=unified\r\n\r\n**Might help:**\r\n\r\nI found out that it fails [here](https://github.com/prometheus/tsdb/blob/a9470dd8d54f7df3e6212ddee72d014bd63e9b3d/head.go#L667), because of `minValidTime` becomes too high, so metric got discarded. This is the state when `ErrOutOfBounds` throws (`values: '0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 500+0x900'`):\r\n```\r\n(dlv) print lset[0].Value\r\n\"test:testrecord:avg3m\"\r\n(dlv) print t\r\n0\r\n(dlv) print a\r\n*github.com/prometheus/prometheus/vendor/github.com/prometheus/tsdb.headAppender {\r\n        head: *github.com/prometheus/prometheus/vendor/github.com/prometheus/tsdb.Head {\r\n                chunkRange: 86400000,\r\n                minTime: 0,\r\n                maxTime: 54900000,\r\n                ...}\r\n        minValidTime: 11700000,\r\n        mint: 9223372036854775807,\r\n        maxt: -9223372036854775808,\r\n        ...}\r\n```\r\nAnd this is when it works fine (`values: '0 0 0 0 0 0 0 0 0 0 0 0 0 0 0'`):\r\n```\r\n(dlv) print lset[0].Value\r\n\"test:testrecord:avg3m\"\r\n(dlv) print t\r\n0\r\n(dlv) print a\r\n*github.com/prometheus/prometheus/vendor/github.com/prometheus/tsdb.headAppender {\r\n        head: *github.com/prometheus/prometheus/vendor/github.com/prometheus/tsdb.Head {\r\n                chunkRange: 86400000,\r\n                minTime: 0,\r\n                maxTime: 840000,\r\n                ...}\r\n        minValidTime: -42360000,\r\n        mint: 9223372036854775807,\r\n        maxt: -9223372036854775808,\r\n        ...}\r\n```\r\n\r\nThanks.\r\nCC @codesome ",
  "closed_at": "2018-11-22T08:51:39Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/7354143?v=4",
    "events_url": "https://api.github.com/users/gouthamve/events{/privacy}",
    "followers_url": "https://api.github.com/users/gouthamve/followers",
    "following_url": "https://api.github.com/users/gouthamve/following{/other_user}",
    "gists_url": "https://api.github.com/users/gouthamve/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/gouthamve",
    "id": 7354143,
    "login": "gouthamve",
    "node_id": "MDQ6VXNlcjczNTQxNDM=",
    "organizations_url": "https://api.github.com/users/gouthamve/orgs",
    "received_events_url": "https://api.github.com/users/gouthamve/received_events",
    "repos_url": "https://api.github.com/users/gouthamve/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/gouthamve/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gouthamve/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/gouthamve"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/4838/comments",
  "created_at": "2018-11-08T12:42:54Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/4838/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/4838",
  "id": 378714945,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 366192871,
      "name": "component/promtool",
      "node_id": "MDU6TGFiZWwzNjYxOTI4NzE=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/promtool"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/4838/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzNzg3MTQ5NDU=",
  "number": 4838,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "`promtool test rules` fails for alerts composed of recorded metrics with heavy input_series",
  "updated_at": "2019-05-21T09:13:33Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/4838",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/16485581?v=4",
    "events_url": "https://api.github.com/users/ilya-lesikov/events{/privacy}",
    "followers_url": "https://api.github.com/users/ilya-lesikov/followers",
    "following_url": "https://api.github.com/users/ilya-lesikov/following{/other_user}",
    "gists_url": "https://api.github.com/users/ilya-lesikov/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ilya-lesikov",
    "id": 16485581,
    "login": "ilya-lesikov",
    "node_id": "MDQ6VXNlcjE2NDg1NTgx",
    "organizations_url": "https://api.github.com/users/ilya-lesikov/orgs",
    "received_events_url": "https://api.github.com/users/ilya-lesikov/received_events",
    "repos_url": "https://api.github.com/users/ilya-lesikov/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ilya-lesikov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ilya-lesikov/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ilya-lesikov"
  }
}