{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "The following PromQL expression makes the expression evaluator panic in Prometheus built off recent master revision 5fbda4c9d72b4519adbc9447f0a0023565d03b14:\r\n\r\n`topk(scalar(count(node_cpu_seconds_total)), node_cpu_seconds_total)`\r\n\r\nExample: http://demo.robustperception.io:9090/graph?g0.range_input=1h&g0.expr=topk(scalar(count(node_cpu_seconds_total))%2C%20node_cpu_seconds_total)&g0.tab=1\r\n\r\nStack trace:\r\n\r\n```\r\nruntime error: invalid memory address or nil pointer dereference\" stacktrace=\"goroutine 3141 [running]:\r\ngithub.com/prometheus/prometheus/promql.(*evaluator).recover(0xc00083b310, 0xc00072cef0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:688 +0xe2\r\npanic(0x1b8e020, 0x341f920)\r\n  /home/julius/go/src/runtime/panic.go:513 +0x1b9\r\ngithub.com/prometheus/prometheus/promql.expandSeriesSet(0x22b3e60, 0xc000839d70, 0x0, 0x0, 0xc000b779e0, 0xc000b77a10, 0xc000b77a40, 0xc000b77a70, 0xc000b77aa0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:642 +0x46\r\ngithub.com/prometheus/prometheus/promql.checkForSeriesSetExpansion(0x22b3e60, 0xc000839d70, 0x22a55e0, 0xc0000c1620, 0x0, 0x0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:630 +0x164\r\ngithub.com/prometheus/prometheus/promql.(*evaluator).eval(0xc00083b310, 0x22a55e0, 0xc0000c1620, 0xc000839f20, 0x2)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:1103 +0x17fe\r\ngithub.com/prometheus/prometheus/promql.(*evaluator).rangeEval(0xc00083b310, 0xc000ef1e40, 0xc00072b4b0, 0x2, 0x2, 0x0, 0x0, 0x0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:772 +0x158e\r\ngithub.com/prometheus/prometheus/promql.(*evaluator).eval(0xc00083b310, 0x22a53a0, 0xc00083b040, 0xc000ef1de0, 0x1)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:910 +0x30ef\r\ngithub.com/prometheus/prometheus/promql.(*evaluator).rangeEval(0xc00083b310, 0xc00014caa0, 0xc00014c860, 0x1, 0x1, 0x0, 0x0, 0x0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:772 +0x158e\r\ngithub.com/prometheus/prometheus/promql.(*evaluator).eval(0xc00083b310, 0x22a5420, 0xc000ef1780, 0xc000839e30, 0x2)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:951 +0x1264\r\ngithub.com/prometheus/prometheus/promql.(*evaluator).rangeEval(0xc00083b310, 0xc000ef1d20, 0xc00072ce00, 0x2, 0x2, 0x0, 0xc00103ac80, 0x22b49e0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:772 +0x158e\r\ngithub.com/prometheus/prometheus/promql.(*evaluator).eval(0xc00083b310, 0x22a53a0, 0xc00083b090, 0xc001224ef0, 0xc00083b310)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:910 +0x30ef\r\ngithub.com/prometheus/prometheus/promql.(*evaluator).Eval(0xc00083b310, 0x22a53a0, 0xc00083b090, 0x0, 0x0, 0x0, 0x0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:699 +0x80\r\ngithub.com/prometheus/prometheus/promql.(*Engine).execEvalStmt(0xc0002e7ef0, 0x22b3e60, 0xc0008399e0, 0xc0000c16e0, 0xc00083b0e0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:436 +0x45b\r\ngithub.com/prometheus/prometheus/promql.(*Engine).exec(0xc0002e7ef0, 0x22b3e60, 0xc0008399e0, 0xc0000c16e0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:390 +0x59f\r\ngithub.com/prometheus/prometheus/promql.(*query).Exec(0xc0000c16e0, 0x22b3da0, 0xc00103a900, 0xc000ce00f0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/promql/engine.go:178 +0x94\r\ngithub.com/prometheus/prometheus/web/api/v1.(*API).query(0xc0000cb0e0, 0xc00013b200, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/web/api/v1/api.go:295 +0x53b\r\ngithub.com/prometheus/prometheus/web/api/v1.(*API).query-fm(0xc00013b200, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/web/api/v1/api.go:224 +0x70\r\ngithub.com/prometheus/prometheus/web/api/v1.(*API).Register.func1.1(0x22a5760, 0xc000ef1740, 0xc00013b200)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/web/api/v1/api.go:205 +0x8e\r\nnet/http.HandlerFunc.ServeHTTP(0xc00083c520, 0x22a5760, 0xc000ef1740, 0xc00013b200)\r\n  /home/julius/go/src/net/http/server.go:1964 +0x44\r\ngithub.com/prometheus/prometheus/util/httputil.CompressionHandler.ServeHTTP(0x2294ec0, 0xc00083c520, 0x7f45ceb88170, 0xc00083aff0, 0xc00013b200)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/util/httputil/compression.go:90 +0x7c\r\ngithub.com/prometheus/prometheus/util/httputil.CompressionHandler.ServeHTTP-fm(0x7f45ceb88170, 0xc00083aff0, 0xc00013b200)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/web/web.go:295 +0x57\r\ngithub.com/prometheus/prometheus/web.(*Handler).testReady.func1(0x7f45ceb88170, 0xc00083aff0, 0xc00013b200)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/web/web.go:391 +0x55\r\nnet/http.HandlerFunc.ServeHTTP(0xc00083c560, 0x7f45ceb88170, 0xc00083aff0, 0xc00013b200)\r\n  /home/julius/go/src/net/http/server.go:1964 +0x44\r\ngithub.com/prometheus/client_golang/prometheus/promhttp.InstrumentHandlerResponseSize.func1(0x22a4be0, 0xc000ef1720, 0xc00013b200)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/vendor/github.com/prometheus/client_golang/prometheus/promhttp/instrument_server.go:196 +0xe9\r\nnet/http.HandlerFunc.ServeHTTP(0xc000838ba0, 0x22a4be0, 0xc000ef1720, 0xc00013b200)\r\n  /home/julius/go/src/net/http/server.go:1964 +0x44\r\ngithub.com/prometheus/client_golang/prometheus/promhttp.InstrumentHandlerDuration.func2(0x22a4be0, 0xc000ef1720, 0xc00013b200)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/vendor/github.com/prometheus/client_golang/prometheus/promhttp/instrument_server.go:76 +0xb5\r\ngithub.com/prometheus/common/route.(*Router).handle.func1(0x22a4be0, 0xc000ef1720, 0xc00013b100, 0x0, 0x0, 0x0)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/vendor/github.com/prometheus/common/route/route.go:60 +0x2b6\r\ngithub.com/julienschmidt/httprouter.(*Router).ServeHTTP(0xc000140bc0, 0x22a4be0, 0xc000ef1720, 0xc00013b100)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/vendor/github.com/julienschmidt/httprouter/router.go:299 +0x6cf\r\ngithub.com/prometheus/common/route.(*Router).ServeHTTP(0xc00083c3e0, 0x22a4be0, 0xc000ef1720, 0xc00013b100)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/vendor/github.com/prometheus/common/route/route.go:98 +0x4c\r\nnet/http.StripPrefix.func1(0x22a4be0, 0xc000ef1720, 0xc00013b000)\r\n  /home/julius/go/src/net/http/server.go:2003 +0x18b\r\nnet/http.HandlerFunc.ServeHTTP(0xc000a7d7a0, 0x22a4be0, 0xc000ef1720, 0xc00013b000)\r\n  /home/julius/go/src/net/http/server.go:1964 +0x44\r\nnet/http.(*ServeMux).ServeHTTP(0xc0008387b0, 0x22a4be0, 0xc000ef1720, 0xc00013b000)\r\n  /home/julius/go/src/net/http/server.go:2361 +0x127\r\ngithub.com/opentracing-contrib/go-stdlib/nethttp.Middleware.func2(0x22b0c20, 0xc000d44380, 0xc00013af00)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/vendor/github.com/opentracing-contrib/go-stdlib/nethttp/server.go:74 +0x432\r\nnet/http.HandlerFunc.ServeHTTP(0xc000a7d830, 0x22b0c20, 0xc000d44380, 0xc00013af00)\r\n  /home/julius/go/src/net/http/server.go:1964 +0x44\r\ngithub.com/prometheus/prometheus/web.withStackTracer.func1(0x22b0c20, 0xc000d44380, 0xc00013af00)\r\n  /home/julius/gosrc/src/github.com/prometheus/prometheus/web/web.go:87 +0x9d\r\nnet/http.HandlerFunc.ServeHTTP(0xc000a7d860, 0x22b0c20, 0xc000d44380, 0xc00013af00)\r\n  /home/julius/go/src/net/http/server.go:1964 +0x44\r\nnet/http.serverHandler.ServeHTTP(0xc000a8c000, 0x22b0c20, 0xc000d44380, 0xc00013af00)\r\n  /home/julius/go/src/net/http/server.go:2741 +0xab\r\nnet/http.(*conn).serve(0xc000482140, 0x22b3da0, 0xc000141000)\r\n  /home/julius/go/src/net/http/server.go:1847 +0x646\r\ncreated by net/http.(*Server).Serve\r\n  /home/julius/go/src/net/http/server.go:2851 +0x2f5\r\n```",
  "closed_at": "2019-03-04T16:21:15Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/15064823?v=4",
    "events_url": "https://api.github.com/users/codesome/events{/privacy}",
    "followers_url": "https://api.github.com/users/codesome/followers",
    "following_url": "https://api.github.com/users/codesome/following{/other_user}",
    "gists_url": "https://api.github.com/users/codesome/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/codesome",
    "id": 15064823,
    "login": "codesome",
    "node_id": "MDQ6VXNlcjE1MDY0ODIz",
    "organizations_url": "https://api.github.com/users/codesome/orgs",
    "received_events_url": "https://api.github.com/users/codesome/received_events",
    "repos_url": "https://api.github.com/users/codesome/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/codesome/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/codesome/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/codesome"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/5276/comments",
  "created_at": "2019-02-26T21:31:20Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/5276/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/5276",
  "id": 414828877,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567473,
      "name": "component/promql",
      "node_id": "MDU6TGFiZWwzNjU1Njc0NzM=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/promql"
    },
    {
      "color": "006b75",
      "default": true,
      "description": null,
      "id": 216836002,
      "name": "help wanted",
      "node_id": "MDU6TGFiZWwyMTY4MzYwMDI=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/help%20wanted"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/5276/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MTQ4Mjg4Nzc=",
  "number": 5276,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Nil pointer panic in expandSeriesSet",
  "updated_at": "2019-08-31T17:04:49Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/5276",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/538008?v=4",
    "events_url": "https://api.github.com/users/juliusv/events{/privacy}",
    "followers_url": "https://api.github.com/users/juliusv/followers",
    "following_url": "https://api.github.com/users/juliusv/following{/other_user}",
    "gists_url": "https://api.github.com/users/juliusv/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/juliusv",
    "id": 538008,
    "login": "juliusv",
    "node_id": "MDQ6VXNlcjUzODAwOA==",
    "organizations_url": "https://api.github.com/users/juliusv/orgs",
    "received_events_url": "https://api.github.com/users/juliusv/received_events",
    "repos_url": "https://api.github.com/users/juliusv/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/juliusv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/juliusv/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/juliusv"
  }
}