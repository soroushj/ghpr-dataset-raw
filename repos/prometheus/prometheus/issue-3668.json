{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "<!--\r\n\r\n    Please do *NOT* ask usage questions in Github issues.\r\n\r\n    If your issue is not a feature request or bug report use:\r\n    https://groups.google.com/forum/#!forum/prometheus-users. If\r\n    you are unsure whether you hit a bug, search and ask in the\r\n    mailing list first.\r\n\r\n    You can find more information at: https://prometheus.io/community/\r\n\r\n-->\r\n\r\n**What did you do?**\r\nWhen a target goes over the configured `sample_limit`, I looked at the `prometheus_target_scrapes_exceeded_sample_limit_total` metric.\r\n\r\n**What did you expect to see?**\r\nI expected this to increase for each scrape which hit the sample limit, as per the help on the metric:\r\n\r\n> Total number of scrapes that hit the sample limit and were rejected.\r\n\r\n(from [scrape.go#L83](https://github.com/prometheus/prometheus/blob/97464236c76301dab933ab8407f7ebe0ee1ec292/retrieval/scrape.go#L83))\r\n\r\n**What did you see instead? Under which circumstances?**\r\nThis metric was not incremented.\r\n\r\n**Environment**\r\n\r\n* System information:\r\n\r\n\tLinux 4.4.0-103-generic x86_64\r\n\r\n* Prometheus version:\r\n\r\nSeen on the `prom/prometheus:v2.0.0` Docker image, reproduced with local build from master branch:\r\n\r\n    prometheus, version 2.0.0 (branch: master, revision: 97464236c76301dab933ab8407f7ebe0ee1ec292)\r\n\r\n\r\n* Alertmanager version:\r\nNA\r\n\r\n* Prometheus configuration file:\r\n```\r\nglobal:\r\n  scrape_interval:     15s\r\n  evaluation_interval: 15s\r\n\r\nscrape_configs:\r\n  - job_name: 'some_job'\r\n\r\n    static_configs:\r\n    - targets: ['localhost:9091']\r\n\r\n    sample_limit: 100\r\n```\r\n\r\n* Alertmanager configuration file:\r\nNA\r\n\r\n* Logs:\r\n```\r\nlevel=warn ts=2018-01-09T11:36:18.344766728Z caller=scrape.go:683 component=\"scrape manager\" scrape_pool=some_job target=http://localhost:9091/metrics msg=\"append failed\" err=\"sample limit exceeded\"\r\n```\r\n\r\n**Notes**\r\nIt appears to be the case that at [scrape.go#L907](https://github.com/prometheus/prometheus/blob/97464236c76301dab933ab8407f7ebe0ee1ec292/retrieval/scrape.go#L907) the metric will be incremented if `err == nil && sampleLimitErr != nil`.\r\nHowever, if I am understanding correctly, `err` will always be the same as `sampleLimitErr` as once the limit has been hit all further samples will also result in that error. Though there is the possibility that a different error is raised at the final stage of the loop.\r\n\r\nMy guess would be that [scrape.go#L907](https://github.com/prometheus/prometheus/blob/97464236c76301dab933ab8407f7ebe0ee1ec292/retrieval/scrape.go#L907) should be changed to just `sampleLimitErr != nil` , but I'm not certain how the line `err = sampleLimitErr` should be changed. If I am understanding things correctly, `err` would always already be  `sampleLimitErr`, so that line is unneeded.",
  "closed_at": "2018-01-09T15:43:29Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/7115638?v=4",
    "events_url": "https://api.github.com/users/brian-brazil/events{/privacy}",
    "followers_url": "https://api.github.com/users/brian-brazil/followers",
    "following_url": "https://api.github.com/users/brian-brazil/following{/other_user}",
    "gists_url": "https://api.github.com/users/brian-brazil/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brian-brazil",
    "id": 7115638,
    "login": "brian-brazil",
    "node_id": "MDQ6VXNlcjcxMTU2Mzg=",
    "organizations_url": "https://api.github.com/users/brian-brazil/orgs",
    "received_events_url": "https://api.github.com/users/brian-brazil/received_events",
    "repos_url": "https://api.github.com/users/brian-brazil/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brian-brazil/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brian-brazil/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brian-brazil"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/3668/comments",
  "created_at": "2018-01-09T12:01:55Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/3668/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/3668",
  "id": 287065299,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "",
      "id": 664475581,
      "name": "component/scraping",
      "node_id": "MDU6TGFiZWw2NjQ0NzU1ODE=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/scraping"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/3668/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyODcwNjUyOTk=",
  "number": 3668,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "`prometheus_target_scrapes_exceeded_sample_limit_total` not incremented",
  "updated_at": "2019-03-23T00:55:33Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/3668",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/3115867?v=4",
    "events_url": "https://api.github.com/users/ant1441/events{/privacy}",
    "followers_url": "https://api.github.com/users/ant1441/followers",
    "following_url": "https://api.github.com/users/ant1441/following{/other_user}",
    "gists_url": "https://api.github.com/users/ant1441/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ant1441",
    "id": 3115867,
    "login": "ant1441",
    "node_id": "MDQ6VXNlcjMxMTU4Njc=",
    "organizations_url": "https://api.github.com/users/ant1441/orgs",
    "received_events_url": "https://api.github.com/users/ant1441/received_events",
    "repos_url": "https://api.github.com/users/ant1441/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ant1441/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ant1441/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ant1441"
  }
}