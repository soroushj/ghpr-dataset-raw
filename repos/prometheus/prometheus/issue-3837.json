{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "For now Prometheus tries to scrape metrics from evicted pods (that have no IP and doesn't perform in cluster). It can cause false alerts or ever scraping metrics from another pod (for ex. if you use `hostNetwork`+`hostPort` for your deployment and new pod will be created on same node as evicted pod).\r\n\r\n**What did you do?**\r\n\r\nSteps to reproduce:\r\n\r\n1. Create deployment with 1 replica and annotations like this:\r\n\r\n```\r\nannotations:\r\n  prometheus.io/scrape: \"true\"\r\n  prometheus.io/path: \"/metrics\"\r\n  prometheus.io/port: \"80\"\r\n```\r\n\r\n2. On `/targets` page you will see new target for created pod.\r\n\r\n3. Do something to trigger eviction pods from node (for example, change `--eviction-hard` settings for kubelet).\r\n\r\n4. Verify that pod is evicted with kubectl. It will looks like:\r\n\r\n```\r\n$ kubectl get pods -o wide -a\r\nNAME                        READY     STATUS      RESTARTS   AGE       IP             NODE\r\ntest-app-7ccb8fbb85-8b4rz   0/1       Evicted     0          20h       <none>         node2\r\ntest-app-7ccb8fbb85-bmnrf   1/1       Running     0          18h       10.244.3.6     node2\r\n```\r\n\r\n5. Check `/targets` page. Target for evicted pod will be still here.\r\n\r\n**What did you expect to see?**\r\n\r\nNo target for evicted pod on step 5.\r\n\r\n**What did you see instead? Under which circumstances?**\r\n\r\nEvicted pod has target on `/targets` page (with down state in most cases).\r\n\r\n**Environment**\r\n\r\n* System information:\r\n\r\n\tLinux 4.4.0-104-generic x86_64\r\n\r\n* Prometheus version:\r\n\r\n```\r\nprometheus, version 2.1.0 (branch: HEAD, revision: 85f23d82a045d103ea7f3c89a91fba4a93e6367a)\r\n  build user:       root@6e784304d3ff\r\n  build date:       20180119-12:01:23\r\n  go version:       go1.9.2\r\n```\r\n\r\n* Prometheus configuration file:\r\n\r\n\tRelevant part:\r\n\r\n```\r\nglobal:\r\n  scrape_interval: 30s\r\n  scrape_timeout: 30s\r\n  evaluation_interval: 1m\r\nscrape_configs:\r\n\r\n  [...]\r\n\r\n- job_name: kubernetes-pods\r\n  scrape_interval: 30s\r\n  scrape_timeout: 30s\r\n  metrics_path: /metrics\r\n  scheme: http\r\n  kubernetes_sd_configs:\r\n  - api_server: null\r\n    role: pod\r\n    namespaces:\r\n      names: []\r\n  relabel_configs:\r\n  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\r\n    separator: ;\r\n    regex: \"true\"\r\n    replacement: $1\r\n    action: keep\r\n  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\r\n    separator: ;\r\n    regex: (.+)\r\n    target_label: __metrics_path__\r\n    replacement: $1\r\n    action: replace\r\n  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\r\n    separator: ;\r\n    regex: (.+):(?:\\d+);(\\d+)\r\n    target_label: __address__\r\n    replacement: ${1}:${2}\r\n    action: replace\r\n  - separator: ;\r\n    regex: __meta_kubernetes_pod_label_(.+)\r\n    replacement: $1\r\n    action: labelmap\r\n  - source_labels: [__meta_kubernetes_namespace]\r\n    separator: ;\r\n    regex: (.*)\r\n    target_label: kubernetes_namespace\r\n    replacement: $1\r\n    action: replace\r\n  - source_labels: [__meta_kubernetes_pod_name]\r\n    separator: ;\r\n    regex: (.*)\r\n    target_label: kubernetes_pod_name\r\n    replacement: $1\r\n    action: replace\r\n  - source_labels: [__meta_kubernetes_pod_node_name]\r\n    separator: ;\r\n    regex: (.*)\r\n    target_label: kubernetes_node_name\r\n    replacement: $1\r\n    action: replace\r\n```\r\n\r\n* Logs:\r\n\r\n```\r\nn/a\r\n```",
  "closed_at": "2018-02-19T12:00:42Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/4948210?v=4",
    "events_url": "https://api.github.com/users/fabxc/events{/privacy}",
    "followers_url": "https://api.github.com/users/fabxc/followers",
    "following_url": "https://api.github.com/users/fabxc/following{/other_user}",
    "gists_url": "https://api.github.com/users/fabxc/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/fabxc",
    "id": 4948210,
    "login": "fabxc",
    "node_id": "MDQ6VXNlcjQ5NDgyMTA=",
    "organizations_url": "https://api.github.com/users/fabxc/orgs",
    "received_events_url": "https://api.github.com/users/fabxc/received_events",
    "repos_url": "https://api.github.com/users/fabxc/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/fabxc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fabxc/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/fabxc"
  },
  "comments": 7,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/3837/comments",
  "created_at": "2018-02-14T03:39:47Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/3837/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/3837",
  "id": 296965848,
  "labels": [],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/3837/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyOTY5NjU4NDg=",
  "number": 3837,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "[Kubernetes] Delete targets for evicted pods",
  "updated_at": "2019-03-22T21:55:43Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/3837",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1687481?v=4",
    "events_url": "https://api.github.com/users/seleznev/events{/privacy}",
    "followers_url": "https://api.github.com/users/seleznev/followers",
    "following_url": "https://api.github.com/users/seleznev/following{/other_user}",
    "gists_url": "https://api.github.com/users/seleznev/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/seleznev",
    "id": 1687481,
    "login": "seleznev",
    "node_id": "MDQ6VXNlcjE2ODc0ODE=",
    "organizations_url": "https://api.github.com/users/seleznev/orgs",
    "received_events_url": "https://api.github.com/users/seleznev/received_events",
    "repos_url": "https://api.github.com/users/seleznev/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/seleznev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/seleznev/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/seleznev"
  }
}