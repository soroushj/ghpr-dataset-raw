{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "hum, there is an additional problem: Consul team did add a limitation on the number of concurrent requests by default in 1.6.2.\r\n\r\nSo, actually, the problem is more complex:\r\n * on a Consul instance with very high concurrent connections allowed, waiting 10m is probably the best: requests are blocking and values updated as fast as possible, you probably have 2k opened connections all the time to the agent if you are watching all the services at the same time, updates are instant\r\n * On a consul instance with default limited connections (aka 200 in 1.6.3+), if you watch more than 200 services for instances, some connections will be silently cut by Consul agent in version < 1.8 (see https://github.com/hashicorp/consul/issues/7527), in version > 1.8, it would return HTTP 429 (that helps quite a lot to detect the issue instead of a raw connection closed)\r\n\r\nIn the latter case, even with 30s instead of 10m, you had an issue, you had no idea when you would get updates because you could be rate-limited and thus some updates would be never performed, but when lucky (assuming the number of watches is not too big compared to number of allowed connections), it kinda work.\r\n\r\nProbably, to make it plug and play:\r\n * Use long blocking queries when enough connections are allowed\r\n * When not enough connections are allowed, perform quick calls (not blocking) every n seconds to get the data (but you loose instant notifications)\r\n\r\n@roidelapluie the long polling works well in my case for instance, because I allowed more connections on my agents that the number of watches, but the change from 10 minutes to 30 seconds is probably problematic for other people.\r\n\r\nA possibility would be to add a new parameter (set by default to 200, maybe even better that could be read from attribute `HTTPMaxConnsPerClient` in agent's address in `http://address_of_cousul_agent/v1/agent/self`).\r\n* When we watch more than HTTPMaxConnsPerClient => switch to instant polling every n seconds\r\n* If we watch less than that, stay on blocking queries\r\n\r\nAny opinion on that?\r\n\r\n_Originally posted by @pierresouchay in https://github.com/prometheus/consul_exporter/pull/176#issuecomment-661807898_",
  "closed_at": null,
  "closed_by": null,
  "comments": 20,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/7626/comments",
  "created_at": "2020-07-21T11:56:16Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/7626/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/7626",
  "id": 662932767,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567641,
      "name": "component/service discovery",
      "node_id": "MDU6TGFiZWwzNjU1Njc2NDE=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/service%20discovery"
    },
    {
      "color": "c7def8",
      "default": false,
      "description": null,
      "id": 365563592,
      "name": "kind/enhancement",
      "node_id": "MDU6TGFiZWwzNjU1NjM1OTI=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/enhancement"
    },
    {
      "color": "f9d0c4",
      "default": false,
      "description": null,
      "id": 647012865,
      "name": "not-as-easy-as-it-looks",
      "node_id": "MDU6TGFiZWw2NDcwMTI4NjU=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/not-as-easy-as-it-looks"
    },
    {
      "color": "fef2c0",
      "default": false,
      "description": null,
      "id": 365563608,
      "name": "priority/Pmaybe",
      "node_id": "MDU6TGFiZWwzNjU1NjM2MDg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/priority/Pmaybe"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/7626/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2NjI5MzI3Njc=",
  "number": 7626,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "open",
  "title": "Consul SD Config concurrent connection issues",
  "updated_at": "2020-10-21T21:41:17Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/7626",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/291750?v=4",
    "events_url": "https://api.github.com/users/roidelapluie/events{/privacy}",
    "followers_url": "https://api.github.com/users/roidelapluie/followers",
    "following_url": "https://api.github.com/users/roidelapluie/following{/other_user}",
    "gists_url": "https://api.github.com/users/roidelapluie/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/roidelapluie",
    "id": 291750,
    "login": "roidelapluie",
    "node_id": "MDQ6VXNlcjI5MTc1MA==",
    "organizations_url": "https://api.github.com/users/roidelapluie/orgs",
    "received_events_url": "https://api.github.com/users/roidelapluie/received_events",
    "repos_url": "https://api.github.com/users/roidelapluie/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/roidelapluie/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/roidelapluie/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/roidelapluie"
  }
}