{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**What did you do?**\n\nJust upgraded from prometheus `0.19.3` to `0.20.0`,\n\n``` diff\n--- a/etc/prometheus.yml\n+++ b/etc/prometheus.yml\n@@ -20,7 +20,7 @@ scrape_configs:\n   # metrics_path defaults to '/metrics'\n   # scheme defaults to 'http'.\n\n-  target_groups:\n+  static_configs:\n     - targets: ['localhost:9090']\n\n - job_name: 'kubernetes-cluster'\n```\n\nI only changed `target_groups` => `static_configs` in my `prometheus.yml` configuration file.\n\n**What did you expect to see?**\n\nWith release `0.20.0` the kubernetes-sd/kubernetes-cluster doesn't works anymore (or I missed a config option\u2026).\n\n**What did you see instead? Under which circumstances?**\n\nOn webui, `Targets > kubernetes-cluster > Endpoint` my nodes fail with this error `malformed HTTP response`\n- Endpoint: `http://10.1.2.2:10250/metrics`\n- Error: `Get http://10.1.2.2:10250/metrics: malformed HTTP response \"\\x15\\x03\\x01\\x00\\x02\\x02\"`\n\nMaybe linked to https://github.com/prometheus/prometheus/commit/206bcfcdaac356e8bdb0cd91f3478f111eaa6d30 ?\n\n**Environment**\n- System information:\n\n`Linux 3.16.0-4-amd64 x86_64`\n- Prometheus version: \n\n```\nprometheus, version 0.20.0 (branch: HEAD, revision: aeab25c)\n  build user:       root@914cf42a3e15\n  build date:       20160617-08:22:59\n  go version:       go1.6.1\n```\n- Prometheus configuration file:\n\n```\nglobal:\n  scrape_interval:     15s # By default, scrape targets every 15 seconds.\n  evaluation_interval: 15s # By default, scrape targets every 15 seconds.\n  # scrape_timeout is set to the global default (10s).\n\n# Load and evaluate rules in this file every 'evaluation_interval' seconds.\nrule_files:\n    - \"/opt/prometheus/etc/rules/alerts\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n# The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.\n- job_name: 'prometheus'\n\n  # Override the global default and scrape targets from this job every 5 seconds.\n  scrape_interval: 25s\n  scrape_timeout: 10s\n\n  # metrics_path defaults to '/metrics'\n  # scheme defaults to 'http'.\n\n  static_configs:\n    - targets: ['localhost:9090']\n\n- job_name: 'kubernetes-cluster'\n\n  # This TLS & bearer token file config is used to connect to the actual scrape\n  # endpoints for cluster components. This is separate to discovery auth\n  # configuration (`in_cluster` below) because discovery & scraping are two\n  # separate concerns in Prometheus.\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n\n  kubernetes_sd_configs:\n  - api_servers:\n    - 'https://kubernetes.default.svc'\n    in_cluster: true\n\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_role]\n    action: keep\n    regex: (?:apiserver|node)\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n  - source_labels: [__meta_kubernetes_role]\n    action: replace\n    target_label: kubernetes_role\n\n# Scrape config for service endpoints.\n#\n# The relabeling allows the actual service scrape endpoint to be configured\n# via the following annotations:\n#\n# * `prometheus.io/scrape`: Only scrape services that have a value of `true`\n# * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need\n# to set this to `https` & most likely set the `tls_config` of the scrape config.\n# * `prometheus.io/path`: If the metrics path is not `/metrics` override this.\n# * `prometheus.io/port`: If the metrics are exposed on a different port to the\n# service then set this appropriately.\n- job_name: 'kubernetes-service-endpoints'\n\n  kubernetes_sd_configs:\n  - api_servers:\n    - 'https://kubernetes.default.svc'\n    in_cluster: true\n\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_role, __meta_kubernetes_service_annotation_prometheus_io_scrape]\n    action: keep\n    regex: endpoint;true\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n    action: replace\n    target_label: __scheme__\n    regex: (https?)\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n    action: replace\n    target_label: __metrics_path__\n    regex: (.+)\n  - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\n    action: replace\n    target_label: __address__\n    regex: (.+)(?::\\d+);(\\d+)\n    replacement: $1:$2\n  - action: labelmap\n    regex: __meta_kubernetes_service_label_(.+)\n  - source_labels: [__meta_kubernetes_role]\n    action: replace\n    target_label: kubernetes_role\n  - source_labels: [__meta_kubernetes_service_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_service_name]\n    action: replace\n    target_label: kubernetes_name\n\n- job_name: 'kubernetes-service-endpoints-2'\n\n  kubernetes_sd_configs:\n  - api_servers:\n    - 'https://kubernetes.default.svc'\n    in_cluster: true\n\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_role, __meta_kubernetes_service_annotation_prometheus_io_scrape2]\n    action: keep\n    regex: endpoint;true\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme2]\n    action: replace\n    target_label: __scheme__\n    regex: (https?)\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path2]\n    action: replace\n    target_label: __metrics_path__\n    regex: (.+)\n  - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port2]\n    action: replace\n    target_label: __address__\n    regex: (.+)(?::\\d+);(\\d+)\n    replacement: $1:$2\n  - action: labelmap\n    regex: __meta_kubernetes_service_label_(.+)\n  - source_labels: [__meta_kubernetes_role2]\n    action: replace\n    target_label: kubernetes_role\n  - source_labels: [__meta_kubernetes_service_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_service_name]\n    action: replace\n    target_label: kubernetes_name\n\n- job_name: 'kubernetes-pods'\n\n  kubernetes_sd_configs:\n  - api_servers:\n    - 'https://kubernetes.default.svc'\n    in_cluster: true\n\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_role, __meta_kubernetes_pod_annotation_prometheus_io_scrape]\n    action: keep\n    regex: pod;true\n  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n    action: replace\n    regex: (.+):(?:\\d+);(\\d+)\n    replacement: ${1}:${2}\n    target_label: __address__\n  - action: labelmap\n    regex: __meta_kubernetes_pod_label_(.+)\n  - source_labels: [__meta_kubernetes_pod_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_pod_name]\n    action: replace\n    target_label: kubernetes_pod_name\n\n- job_name: 'blackbox-exporter'\n  metrics_path: /probe\n\n  kubernetes_sd_configs:\n  - api_servers:\n    - 'https://kubernetes.default.svc'\n    in_cluster: true\n\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_role, __meta_kubernetes_service_annotation_prometheus_io_blackbox]\n    action: keep\n    regex: endpoint;true\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_blackbox_module]\n    action: replace\n    target_label: __param_module\n    regex: (.*)\n    replacement: ${1}\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_blackbox_target]\n    action: replace\n    target_label: __param_target\n    regex: (.*)\n    replacement: ${1}\n  - source_labels: [__address__]\n    action: replace\n    target_label: __address__\n    replacement: '127.0.0.1:9115'\n  - action: labelmap\n    regex: __meta_kubernetes_service_label_(.+)\n  - source_labels: [__meta_kubernetes_service_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_service_name]\n    action: replace\n    target_label: kubernetes_name\n\n- job_name: 'consul'\n\n  consul_sd_configs:\n  - server:   'consul:8500'\n\n  relabel_configs:\n  - source_labels: ['__meta_consul_node']\n    regex:         '(.*)'\n    target_label:  'hostname'\n    replacement:   '$1'\n  - source_labels: ['__meta_consul_tags']\n    regex:         ',,'\n    action:        drop\n```\n",
  "closed_at": "2016-06-27T13:49:52Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/4948210?v=4",
    "events_url": "https://api.github.com/users/fabxc/events{/privacy}",
    "followers_url": "https://api.github.com/users/fabxc/followers",
    "following_url": "https://api.github.com/users/fabxc/following{/other_user}",
    "gists_url": "https://api.github.com/users/fabxc/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/fabxc",
    "id": 4948210,
    "login": "fabxc",
    "node_id": "MDQ6VXNlcjQ5NDgyMTA=",
    "organizations_url": "https://api.github.com/users/fabxc/orgs",
    "received_events_url": "https://api.github.com/users/fabxc/received_events",
    "repos_url": "https://api.github.com/users/fabxc/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/fabxc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fabxc/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/fabxc"
  },
  "comments": 12,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/1752/comments",
  "created_at": "2016-06-17T16:21:06Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/1752/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/1752",
  "id": 160925102,
  "labels": [],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/1752/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxNjA5MjUxMDI=",
  "number": 1752,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "kubernetes-cluster issue with 0.20.0 (malformed HTTP response)",
  "updated_at": "2019-03-22T23:54:34Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/1752",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/420848?v=4",
    "events_url": "https://api.github.com/users/sbadia/events{/privacy}",
    "followers_url": "https://api.github.com/users/sbadia/followers",
    "following_url": "https://api.github.com/users/sbadia/following{/other_user}",
    "gists_url": "https://api.github.com/users/sbadia/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/sbadia",
    "id": 420848,
    "login": "sbadia",
    "node_id": "MDQ6VXNlcjQyMDg0OA==",
    "organizations_url": "https://api.github.com/users/sbadia/orgs",
    "received_events_url": "https://api.github.com/users/sbadia/received_events",
    "repos_url": "https://api.github.com/users/sbadia/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/sbadia/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sbadia/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/sbadia"
  }
}