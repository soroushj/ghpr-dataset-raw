{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "## Bug Report\r\n\r\nIn Prometheus 2.13.0, `promtool` will complain if you have rules with the same label and the same label value, which is a routine occurrence if you're using per-rule labels to control various things or add additional information. On top of that, the complaint is misleading; it reports a duplicate rule, instead of duplicate labels. Sample output (for the example rule file in this bug report):\r\n\r\n````\r\n$ promtool check rules testrule.yaml \r\nChecking testrule.yaml\r\n1 duplicate rules(s) found.\r\nMetric: \r\nLabel(s):\r\n        dest: email-low\r\nMight cause inconsistency while recording expressions.\r\n  SUCCESS: 2 rules found\r\n````\r\n\r\nIn our live configuration, we only have alerting rules, not recording rules, and this reports for them. This may be part of the bug, since alerting rules do not have a metric and the code appears to be comparing only the metric name, not the metric name and the alert name. Possibly cmd/promtool/main.go should include `alert` in the `compareRuleType` struct it uses to check for duplication.\r\n\r\n(I'm assuming here that duplicate `alert` values are at least bad form and worth `promtool` warning about. Perhaps it should have a specific check and warning for that.)\r\n\r\nIf this check is supposed to apply only to recording rules, the obvious change might be to skip any rule that has a blank `Record` field or perhaps a non-blank `Alert` field.\r\n\r\n**Environment**\r\n\r\n* System information:\r\n\r\n\tLinux 4.15.0-52-generic x86_64\r\n\r\n* Prometheus version:\r\n\r\n\tprometheus, version 2.13.0 (branch: HEAD, revision: 6ea4252299f542669aca11860abc2192bdc7bede)\r\n          build user:       root@f30bdad2c3fd\r\n          build date:       20191004-11:25:34\r\n          go version:       go1.13.1\r\n\r\n* Example rules file:\r\n```\r\ngroups:\r\n- name: show-bug\r\n  rules:\r\n  - alert: Test1\r\n    expr: (node_time_seconds - node_boot_time_seconds) < 60\r\n    labels:\r\n      dest: email-low\r\n  - alert: Test2\r\n    expr: node_load15 > 0.5\r\n    labels:\r\n      dest: email-low\r\n```\r\n",
  "closed_at": "2019-11-05T18:22:32Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/3280472?v=4",
    "events_url": "https://api.github.com/users/csmarchbanks/events{/privacy}",
    "followers_url": "https://api.github.com/users/csmarchbanks/followers",
    "following_url": "https://api.github.com/users/csmarchbanks/following{/other_user}",
    "gists_url": "https://api.github.com/users/csmarchbanks/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/csmarchbanks",
    "id": 3280472,
    "login": "csmarchbanks",
    "node_id": "MDQ6VXNlcjMyODA0NzI=",
    "organizations_url": "https://api.github.com/users/csmarchbanks/orgs",
    "received_events_url": "https://api.github.com/users/csmarchbanks/received_events",
    "repos_url": "https://api.github.com/users/csmarchbanks/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/csmarchbanks/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/csmarchbanks/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/csmarchbanks"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/6109/comments",
  "created_at": "2019-10-07T18:53:42Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/6109/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/6109",
  "id": 503628275,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 366192871,
      "name": "component/promtool",
      "node_id": "MDU6TGFiZWwzNjYxOTI4NzE=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/promtool"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/6109/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MDM2MjgyNzU=",
  "number": 6109,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "In Prometheus 2.13.0, promtool misleadingly complains about rules that reuse the same label values",
  "updated_at": "2020-05-05T21:05:45Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/6109",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/865382?v=4",
    "events_url": "https://api.github.com/users/siebenmann/events{/privacy}",
    "followers_url": "https://api.github.com/users/siebenmann/followers",
    "following_url": "https://api.github.com/users/siebenmann/following{/other_user}",
    "gists_url": "https://api.github.com/users/siebenmann/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/siebenmann",
    "id": 865382,
    "login": "siebenmann",
    "node_id": "MDQ6VXNlcjg2NTM4Mg==",
    "organizations_url": "https://api.github.com/users/siebenmann/orgs",
    "received_events_url": "https://api.github.com/users/siebenmann/received_events",
    "repos_url": "https://api.github.com/users/siebenmann/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/siebenmann/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/siebenmann/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/siebenmann"
  }
}