{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**What did you do?**\r\n\r\nStarted an existing Prometheus instance (previously with 15d retention on v2.3.1 with `--storage.tsdb.retention.time=15d`) on v2.7.1 with `--storage.tsdb.retention.size 473436089549B`\r\n\r\n**What did you expect to see?**\r\n\r\nRetention slowly creep upwards until it used that many bytes of disk.\r\n\r\n**What did you see instead? Under which circumstances?**\r\n\r\nRetention inched up past 15d and then went back down. Never exceeding 16 days.\r\n\r\n**Environment**\r\n\r\n* System information:\r\n\r\n\t`Linux 4.4.0-112-generic x86_64`\r\n\r\n**Prometheus version**:\r\n\r\n```\r\nprometheus, version 2.7.1 (branch: HEAD, revision: 62e591f928ddf6b3468308b7ac1de1c63aa7fcf3)\r\n  build user:       root@f9f82868fc43\r\n  build date:       20190131-11:16:59\r\n  go version:       go1.11.5\r\n```\r\n\r\n**Prometheus configuration file**:\r\n```\r\nglobal:\r\n  scrape_interval: 5m\r\n  scrape_timeout: 30s\r\n  evaluation_interval: 1m\r\nalerting:\r\n  alertmanagers:\r\n  - static_configs:\r\n    - targets:\r\n      - <not important>\r\n    scheme: http\r\n    timeout: 10s\r\nrule_files:\r\n- /opt/prometheus/rules/*\r\n- /opt/prometheus/staticrules/*\r\nscrape_configs:\r\n- job_name: <not important>\r\n  scrape_interval: 5m\r\n  scrape_timeout: 30s\r\n  metrics_path: /metrics\r\n  scheme: http\r\n  file_sd_configs:\r\n  - files:\r\n    - /opt/prometheus/services/<not important>.json\r\n    refresh_interval: 5m\r\n- job_name: <not important>\r\n  scrape_interval: 5m\r\n  scrape_timeout: 30s\r\n  metrics_path: /metrics\r\n  scheme: http\r\n  file_sd_configs:\r\n  - files:\r\n    - /opt/prometheus/services/<not important>.json\r\n    refresh_interval: 5m\r\n```\r\n\r\n**Logs**:\r\n\r\nNothing out of the ordinary\r\n```\r\nFebruary 13th 2019, 15:05:26.749\tcompact blocks\r\nFebruary 13th 2019, 15:03:26.172\tWAL checkpoint complete\r\nFebruary 13th 2019, 15:02:51.239\thead GC completed\r\nFebruary 13th 2019, 15:02:28.742\twrite block\r\nFebruary 13th 2019, 13:03:39.905\tWAL checkpoint complete\r\nFebruary 13th 2019, 13:03:04.751\thead GC completed\r\nFebruary 13th 2019, 13:02:40.954\twrite block\r\nFebruary 13th 2019, 11:03:21.124\tWAL checkpoint complete\r\nFebruary 13th 2019, 11:02:48.191\thead GC completed\r\nFebruary 13th 2019, 11:02:27.659\twrite block\r\nFebruary 13th 2019, 09:05:09.337\tcompact blocks\r\nFebruary 13th 2019, 09:03:15.393\tWAL checkpoint complete\r\nFebruary 13th 2019, 09:02:41.952\thead GC completed\r\nFebruary 13th 2019, 09:02:21.303\twrite block\r\nFebruary 13th 2019, 07:03:19.826\tWAL checkpoint complete\r\nFebruary 13th 2019, 07:02:46.056\thead GC completed\r\nFebruary 13th 2019, 07:02:25.234\twrite block\r\nFebruary 13th 2019, 05:03:23.665\tWAL checkpoint complete\r\nFebruary 13th 2019, 05:02:49.790\thead GC completed\r\nFebruary 13th 2019, 05:02:28.875\twrite block\r\n```\r\n\r\n**Other Information**:\r\n\r\n```\r\n$ sudo ./tsdb ls /data/prometheus/\r\nBLOCK ULID                  MIN TIME       MAX TIME       NUM SAMPLES  NUM CHUNKS  NUM SERIES\r\n01D2DQ3CJSPJ9WAHC5ZMFK645A  1548720000000  1548784800000  2033912841   85100495    9995467\r\n01D2FMYPYDZE3X9J6KX98BXJEZ  1548784800000  1548849600000  2035487860   85107889    9938513\r\n01D2HJPKEV3QQ9FXYNJF7X8FB1  1548849600000  1548914400000  2036307983   85333785    10151497\r\n01D2KGFMC804DMYXCQ5ZSHBW4G  1548914400000  1548979200000  2035639475   85238746    10066309\r\n01D2NE8Y5FFE9DQQWG4Z6RNMZ3  1548979200000  1549044000000  2034538485   85162125    10029674\r\n01D2QC0H4JJRWP91J0R7WKBB9Q  1549044000000  1549108800000  2031040667   85160175    10181466\r\n01D2S9SRHWRMBAM849C0KFZZTY  1549108800000  1549173600000  2037159680   85474252    10259224\r\n01D2V7KDP0CH18RCP53FWB9500  1549173600000  1549238400000  2029881220   85086840    10147053\r\n01D2X5C9MY5NYS8SX7DHJ5V3HK  1549238400000  1549303200000  2023600687   84871180    10163861\r\n01D2Z35YV1S9GREGKSGEN3EHMB  1549303200000  1549368000000  2025406021   85005889    10223034\r\n01D310Z7FTWZ5EXR88FAKA3DDZ  1549368000000  1549432800000  2024534227   84926831    10179083\r\n01D32YS40V5ZP6PXPE7BAGGAVW  1549432800000  1549497600000  2026813092   85034921    10230400\r\n01D34WKEBMA62773ATKDAZF9SK  1549497600000  1549562400000  2035551468   85420781    10265665\r\n01D36TCDKJ9J63BED52QBC1EY9  1549562400000  1549627200000  2034484437   85200475    10091533\r\n01D38R5D3Q89THQRNA7KG6X6PZ  1549627200000  1549692000000  2035339787   85298286    10156386\r\n01D3ANZ8X3QVBGDMXYZH9GEZQ3  1549692000000  1549756800000  2033399177   85122753    10012874\r\n01D3CKSHRGWAQ77KWGAPV4VR6W  1549756800000  1549821600000  2034492551   85143116    10042069\r\n01D3EHJS9E23ARD8Q2DY8D9Q31  1549821600000  1549886400000  2035898560   85122306    9953228\r\n01D3GF93CAS4RHCZ18RQ91J0DT  1549886400000  1549951200000  2025739689   84998617    9928608\r\n01D3JD21NDRMJY9P5WD2DBYAC3  1549951200000  1550016000000  2033888680   85085903    9985246\r\n01D3K1H9H34Q4WVW6HNHY7VB66  1550016000000  1550037600000  677435398    28323940    9569766\r\n01D3KP4TRBMDS0KH64H187AHW0  1550037600000  1550059200000  677758634    28342090    9574730\r\n01D3KNYAC8R72FA7MR455ACRJK  1550059200000  1550066400000  226214865    9475804     9475804\r\n```\r\n\r\n![retentionimg](https://i.imgur.com/twvsBJJ.png)\r\n\r\n```\r\n$ ps aux | grep prometheus\r\nprometh+  1537  230 35.9 163097032 23710144 ?  Ssl  16:26  27:57 \r\n/opt/prometheus/bin/prometheus \r\n--config.file /opt/prometheus/prometheus.yml \r\n--web.enable-lifecycle \r\n--web.enable-admin-api \r\n--log.level info \r\n--log.format json \r\n--storage.tsdb.path /data/prometheus \r\n--storage.tsdb.retention.size 473436089549B \r\n--query.max-samples 5000000 \r\n--query.max-concurrency 16\r\n```\r\n\r\n![flags](https://i.imgur.com/wChjasV.png)\r\n\r\n```\r\n$ df -h\r\nFilesystem      Size  Used Avail Use% Mounted on\r\nudev             32G   12K   32G   1% /dev\r\ntmpfs           6.3G  336K  6.3G   1% /run\r\n/dev/vda1       1.3T  145G  1.1T  12% /\r\nnone            4.0K     0  4.0K   0% /sys/fs/cgroup\r\nnone            5.0M     0  5.0M   0% /run/lock\r\nnone             32G     0   32G   0% /run/shm\r\nnone            100M     0  100M   0% /run/user\r\n/dev/vda15      105M  3.2M  102M   4% /boot/efi\r\n```\r\n\r\nOnly thing that seemed odd to me is that the other retention parameters in the flags page still showed 15d in the page, so maybe that was still happening. Or maybe upgrading from 2.3.1 made it bad somehow?\r\n\r\n**Anything else?**\r\n\r\nThank you for taking the time to read my bug report, any time you spend on this is greatly appreciated. Open source maintainership is hard and you all are doing a great job :+1: ",
  "closed_at": "2019-02-19T11:53:43Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/8903888?v=4",
    "events_url": "https://api.github.com/users/krasi-georgiev/events{/privacy}",
    "followers_url": "https://api.github.com/users/krasi-georgiev/followers",
    "following_url": "https://api.github.com/users/krasi-georgiev/following{/other_user}",
    "gists_url": "https://api.github.com/users/krasi-georgiev/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/krasi-georgiev",
    "id": 8903888,
    "login": "krasi-georgiev",
    "node_id": "MDQ6VXNlcjg5MDM4ODg=",
    "organizations_url": "https://api.github.com/users/krasi-georgiev/orgs",
    "received_events_url": "https://api.github.com/users/krasi-georgiev/received_events",
    "repos_url": "https://api.github.com/users/krasi-georgiev/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/krasi-georgiev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/krasi-georgiev/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/krasi-georgiev"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/5213/comments",
  "created_at": "2019-02-13T16:44:29Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/5213/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/5213",
  "id": 409898085,
  "labels": [],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/5213/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MDk4OTgwODU=",
  "number": 5213,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "storage.tsdb.retention.size not being respected >15d",
  "updated_at": "2019-08-18T12:04:48Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/5213",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/5033523?v=4",
    "events_url": "https://api.github.com/users/TimSimmons/events{/privacy}",
    "followers_url": "https://api.github.com/users/TimSimmons/followers",
    "following_url": "https://api.github.com/users/TimSimmons/following{/other_user}",
    "gists_url": "https://api.github.com/users/TimSimmons/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/TimSimmons",
    "id": 5033523,
    "login": "TimSimmons",
    "node_id": "MDQ6VXNlcjUwMzM1MjM=",
    "organizations_url": "https://api.github.com/users/TimSimmons/orgs",
    "received_events_url": "https://api.github.com/users/TimSimmons/received_events",
    "repos_url": "https://api.github.com/users/TimSimmons/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/TimSimmons/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TimSimmons/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/TimSimmons"
  }
}