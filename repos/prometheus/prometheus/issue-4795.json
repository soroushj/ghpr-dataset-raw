{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "## Bug Report\r\n**What did you do?**\r\n\r\nWe copy the Prometheus binary into a from-scratch Docker container and run it as a non-root user to reduce our footprint and threat surface. This is a practice we follow with all applications we run in our Kubernetes environment. Recently we upgraded to prometheus v2.4.2 from v2.3.0, where in both cases we were running in containers using this method.\r\n\r\n**What did you expect to see?**\r\n\r\nPrometheus should run fine, as v2.3.0 seemed to.\r\n\r\n**What did you see instead? Under which circumstances?**\r\n\r\nPrometheus is repeatedly crashing with this error:\r\n\r\n```\r\nW1026 14:54:21.157256       1 reflector.go:341] github.com/prometheus/prometheus/discovery/kubernetes/kubernetes.go:306: watch of *v1.Pod ended with: too old resource version: 19430593 (19430983)\r\nlog: exiting because of error: log: cannot create log: open /tmp/prometheus.prometheus-75f465d4d4-hjztt.unknownuser.log.WARNING.20181026-145421.1: no such file or directory\r\n```\r\n\r\nThis seems to be a glog error message which occurs when glog can't write a logfile. However, I don't want glog writing to any files at all; it should write all logs to stderr, since we are running in a Docker container and want to delegate log management to Docker. However, I see no way to configure Prometheus or glog to not log to files.\r\n\r\nglog apparently has a `--logtostderr` flag, but it's not being exposed by Prometheus.\r\n\r\nNote that the crash is ALWAYS preceded by a warning log from Kubernetes service discovery, so this may be the source of the bug.\r\n\r\nThis error was also reported on coreos/prometheus-operator here: https://github.com/coreos/prometheus-operator/issues/1932 Notice that the crash in that report is ALSO preceded by a warning from Kubernetes service discovery.\r\n\r\n**Environment**\r\n\r\n* System information: no `uname` in a scratch container.\r\n\r\n* Prometheus version:\r\n\r\n```\r\nprometheus, version 2.4.2 (branch: HEAD, revision: c305ffaa092e94e9d2dbbddf8226c4813b1190a0)\r\n  build user:       root@dcde2b74c858\r\n  build date:       20180921-07:22:29\r\n  go version:       go1.10.3\r\n```\r\n\r\n* Logs:\r\n```\r\nW1026 14:54:21.157256       1 reflector.go:341] github.com/prometheus/prometheus/discovery/kubernetes/kubernetes.go:306: watch of *v1.Pod ended with: too old resource version: 19430593 (19430983)\r\nlog: exiting because of error: log: cannot create log: open /tmp/prometheus.prometheus-75f465d4d4-hjztt.unknownuser.log.WARNING.20181026-145421.1: no such file or directory\r\n```\r\n",
  "closed_at": "2018-12-04T14:01:13Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/2587585?v=4",
    "events_url": "https://api.github.com/users/simonpasquier/events{/privacy}",
    "followers_url": "https://api.github.com/users/simonpasquier/followers",
    "following_url": "https://api.github.com/users/simonpasquier/following{/other_user}",
    "gists_url": "https://api.github.com/users/simonpasquier/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/simonpasquier",
    "id": 2587585,
    "login": "simonpasquier",
    "node_id": "MDQ6VXNlcjI1ODc1ODU=",
    "organizations_url": "https://api.github.com/users/simonpasquier/orgs",
    "received_events_url": "https://api.github.com/users/simonpasquier/received_events",
    "repos_url": "https://api.github.com/users/simonpasquier/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/simonpasquier/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/simonpasquier/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/simonpasquier"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/4795/comments",
  "created_at": "2018-10-26T17:22:22Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/4795/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/4795",
  "id": 374475383,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567641,
      "name": "component/service discovery",
      "node_id": "MDU6TGFiZWwzNjU1Njc2NDE=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/service%20discovery"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/4795/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzNzQ0NzUzODM=",
  "number": 4795,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Prometheus crashes if it can't write logs to /tmp",
  "updated_at": "2019-06-02T14:48:25Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/4795",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/6486742?v=4",
    "events_url": "https://api.github.com/users/geekofalltrades/events{/privacy}",
    "followers_url": "https://api.github.com/users/geekofalltrades/followers",
    "following_url": "https://api.github.com/users/geekofalltrades/following{/other_user}",
    "gists_url": "https://api.github.com/users/geekofalltrades/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/geekofalltrades",
    "id": 6486742,
    "login": "geekofalltrades",
    "node_id": "MDQ6VXNlcjY0ODY3NDI=",
    "organizations_url": "https://api.github.com/users/geekofalltrades/orgs",
    "received_events_url": "https://api.github.com/users/geekofalltrades/received_events",
    "repos_url": "https://api.github.com/users/geekofalltrades/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/geekofalltrades/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/geekofalltrades/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/geekofalltrades"
  }
}