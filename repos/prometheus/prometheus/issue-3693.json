{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!--\r\n\r\n    Please do *NOT* ask usage questions in Github issues.\r\n\r\n    If your issue is not a feature request or bug report use:\r\n    https://groups.google.com/forum/#!forum/prometheus-users. If\r\n    you are unsure whether you hit a bug, search and ask in the\r\n    mailing list first.\r\n\r\n    You can find more information at: https://prometheus.io/community/\r\n\r\n-->\r\n\r\n**What did you do?**\r\n\r\nUsing file_sd_config as discovery mechanism for a target group generated by a custom docker swarm service discovery (similar to https://github.com/ContainerSolutions/prometheus-swarm-discovery). When updating the targets file, I couldn't see any update in the targets list of the Prometheus web interface. My first assumption was that there are issues with fsnotify inside of container volumes, but this was not the case. The issue I faced was that there is no updated configuration visible in the targets view when only __meta labels change.\r\n\r\nAfter some investigation, I found the reason for the omitted updates in the code where [the list of scrape tasks is synced](https://github.com/prometheus/prometheus/blob/b20a1b1b1b6e2818991cec45fd0d11646449b250/retrieval/scrape.go#L290) using a [hash function of the target](https://github.com/prometheus/prometheus/blob/b20a1b1b1b6e2818991cec45fd0d11646449b250/retrieval/target.go#L76). This hash is calculated using the `url` and the `labels` but not the `discoveredLabels` where these __meta labels are part of.\r\n\r\n```\r\n// hash returns an identifying hash for the target.\r\nfunc (t *Target) hash() uint64 {\r\n\th := fnv.New64a()\r\n\th.Write([]byte(fmt.Sprintf(\"%016d\", t.labels.Hash())))\r\n\th.Write([]byte(t.URL().String()))\r\n\r\n\treturn h.Sum64()\r\n}\r\n```\r\n\r\nIs it an intended behavior that an update of __meta labels does not trigger an update of the scrape targets - probably to prevent too frequent updates? My assumption was that I can use these __meta labels to add all information I get when talking to the Docker API and so I would be able to make use of them during the relabeling phase. In my opinion, it can be a regular use case that service labels are updated without any further changes of the target urls or regular labels. If one should not use these, which would be a better \"namespace\" for these custom labels?\r\n\r\n**What did you expect to see?**\r\n\r\nEven if the targets and regular labels remain the same, the configuration should reflect the change/addition/removal of __meta labels.\r\n\r\n**What did you see instead? Under which circumstances?**\r\n\r\nThe configuration update was not applied. The targets view still lists the old combination of __meta labels.\r\n\r\n**Environment**\r\n\r\nPrometheus 2.0.0 deployed using Docker Swarm - and also reproduced with a local setup on a pure Ubuntu Server 16.04 LTS VM.\r\n\r\n* System information:\r\n\r\nHost: Ubuntu 16.04.3 LTS\r\nDocker 17.12.0-ce\r\nLinux 4.4.0-108-generic x86_64\r\n\r\n* Prometheus version:\r\n\r\n2.0.0\r\n\r\n* Prometheus configuration file:\r\n```\r\nscrape_configs:\r\n  - job_name: 'services'\r\n    file_sd_configs:\r\n      - files:\r\n        - \"/xxx/targets.json\"\r\n```",
  "closed_at": "2018-02-07T10:29:28Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/7115638?v=4",
    "events_url": "https://api.github.com/users/brian-brazil/events{/privacy}",
    "followers_url": "https://api.github.com/users/brian-brazil/followers",
    "following_url": "https://api.github.com/users/brian-brazil/following{/other_user}",
    "gists_url": "https://api.github.com/users/brian-brazil/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brian-brazil",
    "id": 7115638,
    "login": "brian-brazil",
    "node_id": "MDQ6VXNlcjcxMTU2Mzg=",
    "organizations_url": "https://api.github.com/users/brian-brazil/orgs",
    "received_events_url": "https://api.github.com/users/brian-brazil/received_events",
    "repos_url": "https://api.github.com/users/brian-brazil/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brian-brazil/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brian-brazil/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brian-brazil"
  },
  "comments": 11,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/3693/comments",
  "created_at": "2018-01-16T17:06:07Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/3693/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/3693",
  "id": 288984066,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567100,
      "name": "component/config",
      "node_id": "MDU6TGFiZWwzNjU1NjcxMDA=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/config"
    },
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567641,
      "name": "component/service discovery",
      "node_id": "MDU6TGFiZWwzNjU1Njc2NDE=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/service%20discovery"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    },
    {
      "color": "fbca04",
      "default": false,
      "description": null,
      "id": 647013637,
      "name": "priority/P3",
      "node_id": "MDU6TGFiZWw2NDcwMTM2Mzc=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/priority/P3"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/3693/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyODg5ODQwNjY=",
  "number": 3693,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "No refresh of file service discovery targets if only __meta labels changed",
  "updated_at": "2019-03-22T22:55:23Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/3693",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/388632?v=4",
    "events_url": "https://api.github.com/users/ajaegle/events{/privacy}",
    "followers_url": "https://api.github.com/users/ajaegle/followers",
    "following_url": "https://api.github.com/users/ajaegle/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajaegle/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ajaegle",
    "id": 388632,
    "login": "ajaegle",
    "node_id": "MDQ6VXNlcjM4ODYzMg==",
    "organizations_url": "https://api.github.com/users/ajaegle/orgs",
    "received_events_url": "https://api.github.com/users/ajaegle/received_events",
    "repos_url": "https://api.github.com/users/ajaegle/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ajaegle/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajaegle/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ajaegle"
  }
}