{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**What did you do?**\r\nWe are using remote_storage_adapter implementation (https://github.com/prometheus/prometheus/tree/master/documentation/examples/remote_storage/remote_storage_adapter) to push metrics to InfluxDB.\r\n\r\nSometimes when remote_storage_adapter is back after failure (`docker service scale remote_storage_adapter=0 && sleep 300 && docker service scale remote_storage_adapter=1`) prometheus server crash.\r\n\r\n**Logs**\r\ntime=\"2017-07-18T15:14:20Z\" level=warning msg=\"Error sending 100 samples to remote storage: Post http://remote_storage_adapter:9201/write: dial tcp: lookup remote_storage_adapter on 127.0.0.11:53: no such host\" source=\"queue_manager.go:500\"\r\ntime=\"2017-07-18T15:14:26Z\" level=info msg=\"Remote storage resharding from 118 to 47 shards.\" source=\"queue_manager.go:351\"\r\ntime=\"2017-07-18T15:14:36Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:14:46Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:14:56Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:15:06Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:15:16Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:15:26Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:15:36Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:15:46Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:15:46Z\" level=info msg=\"Checkpointing in-memory metrics and chunks...\" source=\"persistence.go:633\"\r\ntime=\"2017-07-18T15:15:48Z\" level=info msg=\"Done checkpointing in-memory metrics and chunks in 1.235390018s.\" source=\"persistence.go:665\"\r\ntime=\"2017-07-18T15:15:56Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:16:06Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:16:16Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:16:26Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:16:36Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:16:46Z\" level=info msg=\"Remote storage resharding from 47 to 2 shards.\" source=\"queue_manager.go:351\"\r\ntime=\"2017-07-18T15:16:56Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:17:06Z\" level=info msg=\"Currently resharding, skipping.\" source=\"queue_manager.go:354\"\r\ntime=\"2017-07-18T15:17:16Z\" level=info msg=\"Remote storage resharding from 2 to -1 shards.\" source=\"queue_manager.go:351\"\r\npanic: runtime error: makeslice: len out of range\r\n\r\ngoroutine 193 [running]:\r\ngithub.com/prometheus/prometheus/storage/remote.(*QueueManager).newShards(0xc42028a700, 0xffffffffffffffff, 0x1)\r\n        /go/src/github.com/prometheus/prometheus/storage/remote/queue_manager.go:396 +0x40\r\ngithub.com/prometheus/prometheus/storage/remote.(*QueueManager).reshard(0xc42028a700, 0xffffffffffffffff)\r\n        /go/src/github.com/prometheus/prometheus/storage/remote/queue_manager.go:375 +0xcf\r\ngithub.com/prometheus/prometheus/storage/remote.(*QueueManager).reshardLoop(0xc42028a700)\r\n        /go/src/github.com/prometheus/prometheus/storage/remote/queue_manager.go:364 +0x105\r\ncreated by github.com/prometheus/prometheus/storage/remote.(*QueueManager).Start\r\n        /go/src/github.com/prometheus/prometheus/storage/remote/queue_manager.go:265 +0x85\r\n\r\n**Environment**\r\nSystem: Ubuntu 16.04\r\nPrometheus is running on top of docker-swarm.\r\n\r\nPrometheus cmd line:\r\n/opt/prometheus/prometheus -config.file /srv/prometheus/prometheus.yml -web.listen-address 0.0.0.0:9090 -storage.local.engine persisted -storage.local.retention 360h -storage.local.target-heap-size 3221225472 -storage.local.num-fingerprint-mutexes 4096 -storage.local.path /data/data/1/\r\n\r\nPrometheus version:\r\nprometheus, version 1.6.3 (branch: master, revision: c580b60c67f2c5f6b638c3322161bcdf6d68d7fc)\r\n  build user:       root@a6410e65f5c7\r\n  build date:       20170522-09:15:06\r\n  go version:       go1.8.1\r\n\r\n**Prometheus config**\r\n```\r\nglobal:\r\n  evaluation_interval: 1m\r\n  external_labels:\r\n    region: region1\r\n  scrape_interval: 15s\r\n  scrape_timeout: 15s\r\nalerting:\r\n  alertmanagers:\r\n    # docker_swarm_alertmanager\r\n    - dns_sd_configs:\r\n      - names: [tasks.alertmanager]\r\n        type: A\r\n        port: 9093\r\nremote_write:\r\n  # docker_remote_write\r\n  - url: http://remote_storage_adapter:9201/write\r\n\r\nrule_files:\r\n- alerts.yml\r\n\r\nscrape_configs:\r\n  - job_name: telegraf\r\n\r\n    static_configs:\r\n    - targets: ['172.16.10.100:9126','172.16.10.106:9126','172.16.10.107:9126','172.16.10.109:9126','172.16.10.102:9126','172.16.10.108:9126','172.16.10.101:9126','172.16.10.105:9126','172.16.10.103:9126','172.16.10.110:9126','172.16.10.121:9126']\r\n  - job_name: pushgateway\r\n    dns_sd_configs:\r\n    - names:\r\n      - tasks.pushgateway\r\n      type: A\r\n      port: 9091\r\n  - job_name: prometheus\r\n    dns_sd_configs:\r\n    - names:\r\n      - tasks.server\r\n      type: A\r\n      port: 9090\r\n  - job_name: alertmanager\r\n    dns_sd_configs:\r\n    - names:\r\n      - tasks.alertmanager\r\n      type: A\r\n      port: 9093\r\n```\r\n",
  "closed_at": "2017-07-28T11:02:34Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/4948210?v=4",
    "events_url": "https://api.github.com/users/fabxc/events{/privacy}",
    "followers_url": "https://api.github.com/users/fabxc/followers",
    "following_url": "https://api.github.com/users/fabxc/following{/other_user}",
    "gists_url": "https://api.github.com/users/fabxc/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/fabxc",
    "id": 4948210,
    "login": "fabxc",
    "node_id": "MDQ6VXNlcjQ5NDgyMTA=",
    "organizations_url": "https://api.github.com/users/fabxc/orgs",
    "received_events_url": "https://api.github.com/users/fabxc/received_events",
    "repos_url": "https://api.github.com/users/fabxc/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/fabxc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fabxc/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/fabxc"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/2969/comments",
  "created_at": "2017-07-19T12:40:26Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/2969/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/2969",
  "id": 244026731,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567165,
      "name": "component/remote storage",
      "node_id": "MDU6TGFiZWwzNjU1NjcxNjU=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/remote%20storage"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    },
    {
      "color": "eb6420",
      "default": false,
      "description": null,
      "id": 365563606,
      "name": "priority/P1",
      "node_id": "MDU6TGFiZWwzNjU1NjM2MDY=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/priority/P1"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/2969/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyNDQwMjY3MzE=",
  "number": 2969,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Prometheus crash when remote_storage_adapter comes up after failure (panic: runtime error: makeslice: len out of range)",
  "updated_at": "2019-03-23T11:45:57Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/2969",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/4814684?v=4",
    "events_url": "https://api.github.com/users/bkupidura/events{/privacy}",
    "followers_url": "https://api.github.com/users/bkupidura/followers",
    "following_url": "https://api.github.com/users/bkupidura/following{/other_user}",
    "gists_url": "https://api.github.com/users/bkupidura/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/bkupidura",
    "id": 4814684,
    "login": "bkupidura",
    "node_id": "MDQ6VXNlcjQ4MTQ2ODQ=",
    "organizations_url": "https://api.github.com/users/bkupidura/orgs",
    "received_events_url": "https://api.github.com/users/bkupidura/received_events",
    "repos_url": "https://api.github.com/users/bkupidura/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/bkupidura/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bkupidura/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/bkupidura"
  }
}