{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "It is possible that Head compaction can fail continuously for various reasons (disk issues, disk capacity, unsolved corruptions in the head, etc), in such cases a lot of WAL would be piled up until the issue is fixed.\r\n\r\nWhen Prometheus starts finally, let's say we have 24h of data in Head not compacted, this will lead to 11 Head compactions (22h of data) in total one after another (in a single `DB.Compact()` call).\r\n\r\nCurrently, for each compaction, we truncate the Head, which also results into creating a checkpoint. And as its 24h now, the checkpoint is huge (2/3 of 24h data). With 11 compactions like this, it is a lot of re-write of the same data again and again into the checkpoint and the entire process becomes _very_ slow.\r\n\r\nSo I am proposing to truncate the Head only once in a `DB.Compact()` method so that in the example above, it would lead to a single checkpoint creation.\r\n\r\nOne of the issues with this is Prometheus coming down in between the compaction process and hence the truncation not happening. So with this proposal, additionally, we could check for possible truncation on startup. (Update: Created https://github.com/prometheus/prometheus/issues/7575 for it)",
  "closed_at": "2020-10-19T15:27:09Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/15064823?v=4",
    "events_url": "https://api.github.com/users/codesome/events{/privacy}",
    "followers_url": "https://api.github.com/users/codesome/followers",
    "following_url": "https://api.github.com/users/codesome/following{/other_user}",
    "gists_url": "https://api.github.com/users/codesome/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/codesome",
    "id": 15064823,
    "login": "codesome",
    "node_id": "MDQ6VXNlcjE1MDY0ODIz",
    "organizations_url": "https://api.github.com/users/codesome/orgs",
    "received_events_url": "https://api.github.com/users/codesome/received_events",
    "repos_url": "https://api.github.com/users/codesome/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/codesome/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/codesome/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/codesome"
  },
  "comments": 5,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/7574/comments",
  "created_at": "2020-07-14T12:06:42Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/7574/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/7574",
  "id": 656561801,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "",
      "id": 1498495148,
      "name": "component/tsdb",
      "node_id": "MDU6TGFiZWwxNDk4NDk1MTQ4",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/tsdb"
    },
    {
      "color": "c7def8",
      "default": false,
      "description": null,
      "id": 365563592,
      "name": "kind/enhancement",
      "node_id": "MDU6TGFiZWwzNjU1NjM1OTI=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/enhancement"
    },
    {
      "color": "fbca04",
      "default": false,
      "description": null,
      "id": 647013637,
      "name": "priority/P3",
      "node_id": "MDU6TGFiZWw2NDcwMTM2Mzc=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/priority/P3"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/7574/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2NTY1NjE4MDE=",
  "number": 7574,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Checkpoint WAL in Head only once in a DB.Compact() call",
  "updated_at": "2020-10-19T15:27:09Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/7574",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/15064823?v=4",
    "events_url": "https://api.github.com/users/codesome/events{/privacy}",
    "followers_url": "https://api.github.com/users/codesome/followers",
    "following_url": "https://api.github.com/users/codesome/following{/other_user}",
    "gists_url": "https://api.github.com/users/codesome/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/codesome",
    "id": 15064823,
    "login": "codesome",
    "node_id": "MDQ6VXNlcjE1MDY0ODIz",
    "organizations_url": "https://api.github.com/users/codesome/orgs",
    "received_events_url": "https://api.github.com/users/codesome/received_events",
    "repos_url": "https://api.github.com/users/codesome/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/codesome/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/codesome/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/codesome"
  }
}