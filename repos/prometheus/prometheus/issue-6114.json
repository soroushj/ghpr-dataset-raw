{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "## Bug Report\r\n\r\n**What did you do?**\r\n\r\nWe've upgraded Prometheus from 2.6.1 to 2.13.0.\r\n\r\nWhen Prometheus is starting up there are service discovery errors logged, partly because of context cancellation. Service discovery otherwise works.\r\n\r\nAlso it seems the config is read twice.\r\n\r\n**What did you expect to see?**\r\n\r\nNo errors during startup.\r\n\r\n**What did you see instead? Under which circumstances?**\r\n\r\n```\r\nlevel=info ts=2019-10-08T15:01:57.136Z caller=main.go:743 msg=\"Loading configuration file\" filename=/etc/prometheus/config/prometheus.yml\r\nlevel=error ts=2019-10-08T15:01:57.138Z caller=pod.go:85 component=\"discovery manager scrape\" discovery=k8s role=pod msg=\"pod informer unable to sync cache\"\r\nlevel=error ts=2019-10-08T15:01:57.138Z caller=refresh.go:78 component=\"discovery manager scrape\" discovery=ec2 msg=\"Unable to refresh target groups\" err=\"could not describe instances: RequestCanceled: request context canceled\\ncaused by: context canceled\"\r\nlevel=error ts=2019-10-08T15:01:57.138Z caller=node.go:82 component=\"discovery manager scrape\" discovery=k8s role=node msg=\"node informer unable to sync cache\"\r\nlevel=error ts=2019-10-08T15:01:57.138Z caller=refresh.go:78 component=\"discovery manager scrape\" discovery=ec2 msg=\"Unable to refresh target groups\" err=\"could not describe instances: RequestCanceled: request context canceled\\ncaused by: context canceled\"\r\nlevel=info ts=2019-10-08T15:01:57.138Z caller=kubernetes.go:192 component=\"discovery manager scrape\" discovery=k8s msg=\"Using pod service account via in-cluster config\"\r\nlevel=info ts=2019-10-08T15:01:57.139Z caller=kubernetes.go:192 component=\"discovery manager scrape\" discovery=k8s msg=\"Using pod service account via in-cluster config\"\r\nlevel=info ts=2019-10-08T15:01:57.178Z caller=main.go:771 msg=\"Completed loading of configuration file\" filename=/etc/prometheus/config/prometheus.yml\r\nlevel=info ts=2019-10-08T15:01:57.182Z caller=main.go:743 msg=\"Loading configuration file\" filename=/etc/prometheus/config/prometheus.yml\r\nlevel=error ts=2019-10-08T15:01:57.183Z caller=pod.go:85 component=\"discovery manager scrape\" discovery=k8s role=pod msg=\"pod informer unable to sync cache\"\r\nlevel=error ts=2019-10-08T15:01:57.183Z caller=node.go:82 component=\"discovery manager scrape\" discovery=k8s role=node msg=\"node informer unable to sync cache\"\r\nlevel=error ts=2019-10-08T15:01:57.183Z caller=refresh.go:78 component=\"discovery manager scrape\" discovery=ec2 msg=\"Unable to refresh target groups\" err=\"could not describe instances: RequestCanceled: request context canceled\\ncaused by: context canceled\"\r\nlevel=info ts=2019-10-08T15:01:57.183Z caller=kubernetes.go:192 component=\"discovery manager scrape\" discovery=k8s msg=\"Using pod service account via in-cluster config\"\r\nlevel=error ts=2019-10-08T15:01:57.183Z caller=refresh.go:78 component=\"discovery manager scrape\" discovery=ec2 msg=\"Unable to refresh target groups\" err=\"could not describe instances: RequestCanceled: request context canceled\\ncaused by: context canceled\"\r\nlevel=info ts=2019-10-08T15:01:57.184Z caller=kubernetes.go:192 component=\"discovery manager scrape\" discovery=k8s msg=\"Using pod service account via in-cluster config\"\r\nlevel=info ts=2019-10-08T15:01:57.224Z caller=main.go:771 msg=\"Completed loading of configuration file\" filename=/etc/prometheus/config/prometheus.yml\r\n```\r\n\r\nI checked `prometheus_sd_refresh_duration_seconds` and it doesn't show any abnormal values at startup.\r\n`prometheus_sd_refresh_failures_total` stays at 4 after startup.\r\n\r\nThe nodes were doing a fairly long WAL replay before this.\r\n\r\n**Environment**\r\n\r\n* System information:\r\n\r\n\tWe are running the equivalent of the upstream Docker image, but changing the user.\r\n\r\n* Prometheus version:\r\n\r\n\t```\r\n\tprometheus, version 2.13.0 (branch: HEAD, revision: 6ea4252299f542669aca11860abc2192bdc7bede)\r\n\t  build user:       root@188fafb5b41b\r\n\t  build date:       20191008-10:23:04\r\n\t  go version:       go1.13.1\r\n\t```\r\n",
  "closed_at": "2019-10-09T15:05:45Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/4546722?v=4",
    "events_url": "https://api.github.com/users/brancz/events{/privacy}",
    "followers_url": "https://api.github.com/users/brancz/followers",
    "following_url": "https://api.github.com/users/brancz/following{/other_user}",
    "gists_url": "https://api.github.com/users/brancz/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brancz",
    "id": 4546722,
    "login": "brancz",
    "node_id": "MDQ6VXNlcjQ1NDY3MjI=",
    "organizations_url": "https://api.github.com/users/brancz/orgs",
    "received_events_url": "https://api.github.com/users/brancz/received_events",
    "repos_url": "https://api.github.com/users/brancz/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brancz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brancz/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brancz"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/6114/comments",
  "created_at": "2019-10-08T16:40:02Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/6114/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/6114",
  "id": 504154687,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567641,
      "name": "component/service discovery",
      "node_id": "MDU6TGFiZWwzNjU1Njc2NDE=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/service%20discovery"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/6114/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MDQxNTQ2ODc=",
  "number": 6114,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Service discovery errors during startup in v2.13.0",
  "updated_at": "2020-04-15T07:19:19Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/6114",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/868104?v=4",
    "events_url": "https://api.github.com/users/bandesz/events{/privacy}",
    "followers_url": "https://api.github.com/users/bandesz/followers",
    "following_url": "https://api.github.com/users/bandesz/following{/other_user}",
    "gists_url": "https://api.github.com/users/bandesz/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/bandesz",
    "id": 868104,
    "login": "bandesz",
    "node_id": "MDQ6VXNlcjg2ODEwNA==",
    "organizations_url": "https://api.github.com/users/bandesz/orgs",
    "received_events_url": "https://api.github.com/users/bandesz/received_events",
    "repos_url": "https://api.github.com/users/bandesz/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/bandesz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bandesz/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/bandesz"
  }
}