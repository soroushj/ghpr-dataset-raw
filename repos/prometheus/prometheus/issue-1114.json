{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "We're seeing very high CPU use on all cores after a SIGHUP if the prometheus config file changes.  Originally we were on 0.15.1 rev. 7a6d12a and the issue still persists on 0.16.0rc1.  CPU performance is as expected when the service first starts but consistently drops off after a config change & SIGHUP. A screenshot showing CPU load after a config change & HUP is below.\n\nThe green line shows CPU cores idle.  The first drop shows an addition in the global labels followed by a HUP, the next 2 are HUPing prometheus after removing target groups - the increases correlate to restarts of the prometheus service.  When CPU spikes after a config reload, we see ~ 4/4 cores in 'user' state and on a 16 core box we see ~25% user, ~25% system and ~50% iowait - interestingly, disk load was always constantly stable, even though CPU iowait was very high.\n\n![image](https://cloud.githubusercontent.com/assets/3299293/10085085/8cad376e-62cc-11e5-8c2c-09455e44c88e.png)\n\nOur prometheus config (200 total file_sd_config groups):\n\n```\nglobal:\n  evaluation_interval: 15s\n  labels:\n    env: qa1\n  scrape_interval: 15s\n  scrape_timeout: 5s\nrule_files: [/etc/prometheus/prometheus.rules, /etc/prometheus/common.rules, /etc/prometheus/elastic-search.rules,\n  /etc/prometheus/test.rules, /etc/prometheus/third-party-services.rules, /etc/prometheus/jenkins.rules,\n  /etc/prometheus/team-abc.rules, /etc/prometheus/team-123.rules]\nscrape_configs:\n- job_name: services_health\n  target_groups:\n  - targets: ['localhost:8180']\n- file_sd_configs:\n  - names: [/etc/prometheus/sd/service1.node.yml]\n  job_name: service1_node\n  metrics_path: /9100/metrics\n  scrape_interval: 5s\n- file_sd_configs:\n  - names: [/etc/prometheus/sd/service1.app.yml]\n  job_name: service1\n  metrics_path: /9100/metrics\n  scrape_interval: 5s\n  - file_sd_configs:\n    - names: [/etc/prometheus/sd/service2.node.yml]\n    job_name: service1_node\n    metrics_path: /9100/metrics\n    scrape_interval: 5s\n  - file_sd_configs:\n    - names: [/etc/prometheus/sd/service2.app.yml]\n    job_name: service1\n    metrics_path: /9100/metrics\n    scrape_interval: 5s\n...\n```\n",
  "closed_at": "2015-09-28T10:31:26Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/538008?v=4",
    "events_url": "https://api.github.com/users/juliusv/events{/privacy}",
    "followers_url": "https://api.github.com/users/juliusv/followers",
    "following_url": "https://api.github.com/users/juliusv/following{/other_user}",
    "gists_url": "https://api.github.com/users/juliusv/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/juliusv",
    "id": 538008,
    "login": "juliusv",
    "node_id": "MDQ6VXNlcjUzODAwOA==",
    "organizations_url": "https://api.github.com/users/juliusv/orgs",
    "received_events_url": "https://api.github.com/users/juliusv/received_events",
    "repos_url": "https://api.github.com/users/juliusv/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/juliusv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/juliusv/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/juliusv"
  },
  "comments": 14,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/1114/comments",
  "created_at": "2015-09-24T20:42:55Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/1114/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/1114",
  "id": 108210369,
  "labels": [],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/1114/labels{/name}",
  "locked": true,
  "milestone": {
    "closed_at": "2016-02-05T05:00:54Z",
    "closed_issues": 4,
    "created_at": "2015-09-21T19:04:21Z",
    "creator": {
      "avatar_url": "https://avatars2.githubusercontent.com/u/4948210?v=4",
      "events_url": "https://api.github.com/users/fabxc/events{/privacy}",
      "followers_url": "https://api.github.com/users/fabxc/followers",
      "following_url": "https://api.github.com/users/fabxc/following{/other_user}",
      "gists_url": "https://api.github.com/users/fabxc/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/fabxc",
      "id": 4948210,
      "login": "fabxc",
      "node_id": "MDQ6VXNlcjQ5NDgyMTA=",
      "organizations_url": "https://api.github.com/users/fabxc/orgs",
      "received_events_url": "https://api.github.com/users/fabxc/received_events",
      "repos_url": "https://api.github.com/users/fabxc/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/fabxc/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fabxc/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/fabxc"
    },
    "description": "",
    "due_on": "2015-09-29T07:00:00Z",
    "html_url": "https://github.com/prometheus/prometheus/milestone/1",
    "id": 1317081,
    "labels_url": "https://api.github.com/repos/prometheus/prometheus/milestones/1/labels",
    "node_id": "MDk6TWlsZXN0b25lMTMxNzA4MQ==",
    "number": 1,
    "open_issues": 0,
    "state": "closed",
    "title": "v0.16.0",
    "updated_at": "2016-02-05T05:00:54Z",
    "url": "https://api.github.com/repos/prometheus/prometheus/milestones/1"
  },
  "node_id": "MDU6SXNzdWUxMDgyMTAzNjk=",
  "number": 1114,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "High CPU after config change and SIGHUP",
  "updated_at": "2019-03-24T17:27:37Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/1114",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/3299293?v=4",
    "events_url": "https://api.github.com/users/dan-cleinmark/events{/privacy}",
    "followers_url": "https://api.github.com/users/dan-cleinmark/followers",
    "following_url": "https://api.github.com/users/dan-cleinmark/following{/other_user}",
    "gists_url": "https://api.github.com/users/dan-cleinmark/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/dan-cleinmark",
    "id": 3299293,
    "login": "dan-cleinmark",
    "node_id": "MDQ6VXNlcjMyOTkyOTM=",
    "organizations_url": "https://api.github.com/users/dan-cleinmark/orgs",
    "received_events_url": "https://api.github.com/users/dan-cleinmark/received_events",
    "repos_url": "https://api.github.com/users/dan-cleinmark/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/dan-cleinmark/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dan-cleinmark/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/dan-cleinmark"
  }
}