{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "## Proposal\r\nSince upgrading to 2.8 / 2.9, it's become very hard to tune the number of shards, and the shards seem to flap between min and max shards if there's any sort of issue.\r\n\r\nI'm currently mitigating by trying to set all of my prometheus instances to have enough shards to not need to scale up in normal circumstances, and leaving a low max_shards so as to not go crazy if there's an issue (flapping to 1000 was not fun).\r\n\r\nThis additionally causes issues because resharding causes http connection churn and smaller than normal batches, both of which lead to higher latency / more flapping on other boxes with the same remote write target.\r\n\r\n## Bug Report\r\n**What did you do?**\r\nSet up remote write, in this case with the following settings \r\n```\r\n- url: redacted\r\n  remote_timeout: 30s\r\n  queue_config:\r\n    capacity: 10000\r\n    max_shards: 10\r\n    min_shards: 6\r\n    max_samples_per_send: 5000\r\n    batch_send_deadline: 5m\r\n    max_retries: 3\r\n    min_backoff: 50ms\r\n    max_backoff: 1s\r\n```\r\n\r\n**What did you expect to see?**\r\nSmooth movement between 6 and 10 shards as needed to send the data.\r\n\r\n**What did you see instead? Under which circumstances?**\r\nSharp jumps between 6 and 10 shards whenever there's any sort of network latency.\r\nGraph, 15s resolution, # shards in green, remote write network time in yellow `(rate(prometheus_remote_storage_sent_batch_duration_seconds_sum{instance=~\"$instance\"}[$__interval])`\r\n![image](https://user-images.githubusercontent.com/508811/58824718-bc645e00-860a-11e9-9105-fa6840d176ea.png)\r\n\r\n\r\n**Environment**\r\n\r\n* System information: Linux 4.15.0-1045-azure x86_64\r\n\r\n* Prometheus version:\r\n```\r\nprometheus, version 2.9.2 (branch: HEAD, revision: d3245f15022551c6fc8281766ea62db4d71e2747)\r\n  build user:       root@1d43b6951e8f\r\n  build date:       20190424-15:32:31\r\n  go version:       go1.12.4\r\n```\r\n\r\n* Alertmanager version: N/A\r\n\r\n* Prometheus configuration file:\r\n\r\n```\r\nremote_write:\r\n- url: redacted\r\n  remote_timeout: 30s\r\n  queue_config:\r\n    capacity: 10000\r\n    max_shards: 10\r\n    min_shards: 6\r\n    max_samples_per_send: 5000\r\n    batch_send_deadline: 5m\r\n    max_retries: 3\r\n    min_backoff: 50ms\r\n    max_backoff: 1s\r\n```\r\n\r\n* Alertmanager configuration file:\r\nN/A\r\n\r\n* Logs:\r\n```\r\nJun  3 15:02:24 hostname prometheus[3325]: ts=2019-06-03T15:02:24.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:04:34 hostname prometheus[3325]: ts=2019-06-03T15:04:34.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:04:44 hostname prometheus[3325]: ts=2019-06-03T15:04:44.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:05:44 hostname prometheus[3325]: ts=2019-06-03T15:05:44.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:05:54 hostname prometheus[3325]: ts=2019-06-03T15:05:54.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:06:34 hostname prometheus[3325]: ts=2019-06-03T15:06:34.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=7\r\nJun  3 15:06:44 hostname prometheus[3325]: ts=2019-06-03T15:06:44.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=7 to=10\r\nJun  3 15:07:14 hostname prometheus[3325]: ts=2019-06-03T15:07:14.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:07:24 hostname prometheus[3325]: ts=2019-06-03T15:07:24.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:08:24 hostname prometheus[3325]: ts=2019-06-03T15:08:24.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:08:34 hostname prometheus[3325]: ts=2019-06-03T15:08:34.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:09:24 hostname prometheus[3325]: ts=2019-06-03T15:09:24.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=7\r\nJun  3 15:09:34 hostname prometheus[3325]: ts=2019-06-03T15:09:34.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=7 to=10\r\nJun  3 15:09:44 hostname prometheus[3325]: ts=2019-06-03T15:09:44.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:09:54 hostname prometheus[3325]: ts=2019-06-03T15:09:54.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:10:44 hostname prometheus[3325]: ts=2019-06-03T15:10:44.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=7\r\nJun  3 15:10:54 hostname prometheus[3325]: ts=2019-06-03T15:10:54.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=7 to=10\r\nJun  3 15:11:04 hostname prometheus[3325]: ts=2019-06-03T15:11:04.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:11:14 hostname prometheus[3325]: ts=2019-06-03T15:11:14.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:12:14 hostname prometheus[3325]: ts=2019-06-03T15:12:14.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:12:24 hostname prometheus[3325]: ts=2019-06-03T15:12:24.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:13:14 hostname prometheus[3325]: ts=2019-06-03T15:13:14.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=7\r\nJun  3 15:13:44 hostname prometheus[3325]: ts=2019-06-03T15:13:44.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=7 to=6\r\nJun  3 15:13:54 hostname prometheus[3325]: ts=2019-06-03T15:13:54.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:14:04 hostname prometheus[3325]: ts=2019-06-03T15:14:04.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:14:54 hostname prometheus[3325]: ts=2019-06-03T15:14:54.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:15:04 hostname prometheus[3325]: ts=2019-06-03T15:15:04.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:15:24 hostname prometheus[3325]: ts=2019-06-03T15:15:24.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=7\r\nJun  3 15:15:54 hostname prometheus[3325]: ts=2019-06-03T15:15:54.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=7 to=10\r\nJun  3 15:16:14 hostname prometheus[3325]: ts=2019-06-03T15:16:14.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:16:24 hostname prometheus[3325]: ts=2019-06-03T15:16:24.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\nJun  3 15:17:24 hostname prometheus[3325]: ts=2019-06-03T15:17:24.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=7\r\nJun  3 15:17:44 hostname prometheus[3325]: ts=2019-06-03T15:17:44.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=7 to=6\r\nJun  3 15:18:04 hostname prometheus[3325]: ts=2019-06-03T15:18:04.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=6 to=10\r\nJun  3 15:18:14 hostname prometheus[3325]: ts=2019-06-03T15:18:14.776Z caller=dedupe.go:111 component=remote level=info queue=0:http://redacted/api/v1/prom/remote/write msg=\"Remote storage resharding\" from=10 to=6\r\n...etc...\r\n```\r\n",
  "closed_at": "2019-08-13T09:10:22Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/444037?v=4",
    "events_url": "https://api.github.com/users/tomwilkie/events{/privacy}",
    "followers_url": "https://api.github.com/users/tomwilkie/followers",
    "following_url": "https://api.github.com/users/tomwilkie/following{/other_user}",
    "gists_url": "https://api.github.com/users/tomwilkie/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/tomwilkie",
    "id": 444037,
    "login": "tomwilkie",
    "node_id": "MDQ6VXNlcjQ0NDAzNw==",
    "organizations_url": "https://api.github.com/users/tomwilkie/orgs",
    "received_events_url": "https://api.github.com/users/tomwilkie/received_events",
    "repos_url": "https://api.github.com/users/tomwilkie/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/tomwilkie/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tomwilkie/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/tomwilkie"
  },
  "comments": 10,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/5627/comments",
  "created_at": "2019-06-03T18:28:19Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/5627/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/5627",
  "id": 451625127,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567165,
      "name": "component/remote storage",
      "node_id": "MDU6TGFiZWwzNjU1NjcxNjU=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/remote%20storage"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/5627/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0NTE2MjUxMjc=",
  "number": 5627,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Remote Write Shard Flapping",
  "updated_at": "2020-02-09T10:50:24Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/5627",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/508811?v=4",
    "events_url": "https://api.github.com/users/BertHartm/events{/privacy}",
    "followers_url": "https://api.github.com/users/BertHartm/followers",
    "following_url": "https://api.github.com/users/BertHartm/following{/other_user}",
    "gists_url": "https://api.github.com/users/BertHartm/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/BertHartm",
    "id": 508811,
    "login": "BertHartm",
    "node_id": "MDQ6VXNlcjUwODgxMQ==",
    "organizations_url": "https://api.github.com/users/BertHartm/orgs",
    "received_events_url": "https://api.github.com/users/BertHartm/received_events",
    "repos_url": "https://api.github.com/users/BertHartm/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/BertHartm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/BertHartm/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/BertHartm"
  }
}