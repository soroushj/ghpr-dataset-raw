{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**What did you do?**\r\nRunning Prometheus inside Kubernetes. When I scale down number of replicas for a deployment, Prometheus panic.\r\n\r\n**What did you expect to see?**\r\nNot panic\r\n\r\n**What did you see instead? Under which circumstances?**\r\nWhen I scale 350 replicas to 0, Prometheus crashed.\r\n\r\n**Environment**\r\n\r\n* System information:\r\n\r\n        CentOS Linux release 7.2.1511 (Core)\r\n\tLinux 3.10.0-327.4.4.el7.x86_64 x86_64\r\n\r\n* Prometheus version: \r\n\r\n       Docker image: prom/prometheus:v1.3.1\r\n\r\n* Docker version:\r\n\r\n       Server:\r\n        Version:      1.11.2\r\n        API version:  1.23\r\n        Go version:   go1.5.4\r\n        Git commit:   b9f10c9\r\n        Built:        Wed Jun  1 21:23:11 2016\r\n        OS/Arch:      linux/amd64\r\n\r\n* Kubelet version:\r\n\r\n       Kubernetes v1.4.1\r\n\r\n* Prometheus configuration file:\r\n```\r\nglobal:\r\n  scrape_interval: 600s\r\n\r\nscrape_configs:\r\n  - job_name: 'cadvisor-exporter'\r\n    scrape_interval: 60s\r\n    scheme: 'http'\r\n    kubernetes_sd_configs:\r\n    - role: node\r\n      api_server: https://API_SERVER\r\n      tls_config:\r\n        ca_file: CA_CRT_PATH\r\n    relabel_configs:\r\n      - source_labels: [__meta_kubernetes_node_address_InternalIP]\r\n        regex: (.*)\r\n        replacement: ${1}:4194\r\n        action: replace\r\n        target_label: __address__\r\n      - source_labels: [instance]\r\n        regex: (.*)\\.(.*)\\.(.*)\r\n        replacement: ${1}\r\n        action: replace\r\n        target_label: hostname\r\n  - job_name: 'node-exporter'\r\n    scrape_interval: 60s\r\n    scheme: 'http'\r\n    kubernetes_sd_configs:\r\n    - role: node\r\n      api_server: https://API_SERVER\r\n      tls_config:\r\n        ca_file: CA_CRT_PATH\r\n    relabel_configs:\r\n      - source_labels: [__meta_kubernetes_node_address_InternalIP]\r\n        regex: (.*)\r\n        replacement: ${1}:9100\r\n        action: replace\r\n        target_label: __address__\r\n      - source_labels: [instance]\r\n        regex: (.*)\\.(.*)\\.(.*)\r\n        replacement: ${1}\r\n        action: replace\r\n        target_label: hostname\r\n      - action: labelmap\r\n        regex: __meta_kubernetes_node_label_(.+)\r\n  - job_name: 'prod-pod-exporter'\r\n    scrape_interval: 60s\r\n    scheme: 'http'\r\n    kubernetes_sd_configs:\r\n    - role: pod\r\n      api_server: https://API_SERVER\r\n      tls_config:\r\n        ca_file: CA_CRT_PATH\r\n    tls_config:\r\n      ca_file: CA_CRT_PATH\r\n      server_name: '*.k8s.local'\r\n    relabel_configs:\r\n    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\r\n      action: replace\r\n      target_label: __metrics_path__\r\n      regex: (.+)\r\n    - source_labels: [__meta_kubernetes_pod_label_prometheus_io_scrape]\r\n      action: keep\r\n      regex: true\r\n    - source_labels: [__meta_kubernetes_pod_container_port_name]\r\n      action: keep\r\n      regex: prometheus-port\r\n    - source_labels: [__address__, __meta_kubernetes_pod_container_port_map_prometheus_port]\r\n      action: replace\r\n      regex: (.+):(?:\\d+);(\\d+)\r\n      replacement: ${1}:${2}\r\n      target_label: __address__\r\n    - action: labelmap\r\n      regex: __meta_kubernetes_pod_label_(.+)\r\n    - source_labels: [__meta_kubernetes_pod_namespace]\r\n      action: replace\r\n      target_label: kubernetes_namespace\r\n    - source_labels: [__meta_kubernetes_pod_name]\r\n      action: replace\r\n      target_label: kubernetes_pod_name\r\n```\r\n\r\n* Logs:\r\n```\r\nE1109 20:02:54.793285       1 runtime.go:64] Observed a panic: &runtime.TypeAssertionError{interfaceString:\"interface {}\", concreteString:\"cache.DeletedFinalStateUnknown\", assertedString:\"*v1.Pod\", missingMethod:\"\"} (interface conversion: interface {} is cache.DeletedFinalStateUnknown, not *v1.Pod)\r\n/go/src/github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/pkg/util/runtime/runtime.go:70\r\n/go/src/github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/pkg/util/runtime/runtime.go:63\r\n/go/src/github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/pkg/util/runtime/runtime.go:49\r\n/usr/local/go/src/runtime/asm_amd64.s:479\r\n/usr/local/go/src/runtime/panic.go:458\r\n/usr/local/go/src/runtime/iface.go:201\r\n/go/src/github.com/prometheus/prometheus/retrieval/discovery/kubernetes/pod.go:77\r\n/go/src/github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/tools/cache/controller.go:182\r\n<autogenerated>:52\r\n/go/src/github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/tools/cache/shared_informer.go:408\r\n/usr/local/go/src/runtime/asm_amd64.s:2086\r\npanic: interface conversion: interface {} is cache.DeletedFinalStateUnknown, not *v1.Pod [recovered]\r\npanic: interface conversion: interface {} is cache.DeletedFinalStateUnknown, not *v1.Pod\r\n\r\ngoroutine 419 [running]:\r\n  panic(0x17a4060, 0xc514b803c0)\r\n/usr/local/go/src/runtime/panic.go:500 +0x1a1\r\ngithub.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/pkg/util/runtime.HandleCrash(0x0, 0x0, 0x0)\r\n/go/src/github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/pkg/util/runtime/runtime.go:56 +0x126\r\npanic(0x17a4060, 0xc514b803c0)\r\n/usr/local/go/src/runtime/panic.go:458 +0x243\r\ngithub.com/prometheus/prometheus/retrieval/discovery/kubernetes.(*Pod).Run.func3(0x1816540, 0xc502773820)\r\n/go/src/github.com/prometheus/prometheus/retrieval/discovery/kubernetes/pod.go:77 +0x166\r\ngithub.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/tools/cache.ResourceEventHandlerFuncs.OnDelete(0xc4d5821240, 0xc4d5821280, 0xc5266dcf40, 0x1816540, 0xc502773820)\r\n/go/src/github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/tools/cache/controller.go:182 +0x49\r\ngithub.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/tools/cache.(*ResourceEventHandlerFuncs).OnDelete(0xc4d58212a0, 0x1816540, 0xc502773820)\r\n<autogenerated>:52 +0x78\r\ngithub.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/tools/cache.(*processorListener).run(0xc4cbe56e80, 0xc49c814ba0)\r\n/go/src/github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/tools/cache/shared_informer.go:408 +0x356\r\ncreated by github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/tools/cache.(*sharedIndexInformer).AddEventHandler\r\n/go/src/github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/tools/cache/shared_informer.go:257 +0x24b\r\n```\r\n",
  "closed_at": "2016-11-14T15:21:38Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/4948210?v=4",
    "events_url": "https://api.github.com/users/fabxc/events{/privacy}",
    "followers_url": "https://api.github.com/users/fabxc/followers",
    "following_url": "https://api.github.com/users/fabxc/following{/other_user}",
    "gists_url": "https://api.github.com/users/fabxc/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/fabxc",
    "id": 4948210,
    "login": "fabxc",
    "node_id": "MDQ6VXNlcjQ5NDgyMTA=",
    "organizations_url": "https://api.github.com/users/fabxc/orgs",
    "received_events_url": "https://api.github.com/users/fabxc/received_events",
    "repos_url": "https://api.github.com/users/fabxc/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/fabxc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fabxc/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/fabxc"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/2178/comments",
  "created_at": "2016-11-09T20:54:26Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/2178/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/2178",
  "id": 188349959,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567641,
      "name": "component/service discovery",
      "node_id": "MDU6TGFiZWwzNjU1Njc2NDE=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/service%20discovery"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    },
    {
      "color": "df0101",
      "default": false,
      "description": null,
      "id": 365563605,
      "name": "priority/P0",
      "node_id": "MDU6TGFiZWwzNjU1NjM2MDU=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/priority/P0"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/2178/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxODgzNDk5NTk=",
  "number": 2178,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Prometheus panic: &runtime.TypeAssertionError",
  "updated_at": "2019-03-24T03:20:13Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/2178",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/3101113?v=4",
    "events_url": "https://api.github.com/users/automatedops/events{/privacy}",
    "followers_url": "https://api.github.com/users/automatedops/followers",
    "following_url": "https://api.github.com/users/automatedops/following{/other_user}",
    "gists_url": "https://api.github.com/users/automatedops/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/automatedops",
    "id": 3101113,
    "login": "automatedops",
    "node_id": "MDQ6VXNlcjMxMDExMTM=",
    "organizations_url": "https://api.github.com/users/automatedops/orgs",
    "received_events_url": "https://api.github.com/users/automatedops/received_events",
    "repos_url": "https://api.github.com/users/automatedops/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/automatedops/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/automatedops/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/automatedops"
  }
}