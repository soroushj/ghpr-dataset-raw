{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "Here's query for my custom metrics job...\r\n\r\n```\r\nup{endpoint=\"http\", instance=\"172.17.0.12:9015\", job=\"absolute-epicenter-worker\", namespace=\"default\", pod=\"absolute-epicenter-worker-d4bd57886-hpdmp\", service=\"absolute-epicenter-worker\"}\r\n1\r\nscrape_duration_seconds{endpoint=\"http\", instance=\"172.17.0.12:9015\", job=\"absolute-epicenter-worker\", namespace=\"default\", pod=\"absolute-epicenter-worker-d4bd57886-hpdmp\", service=\"absolute-epicenter-worker\"}\r\n0.005390915\r\nscrape_samples_scraped{endpoint=\"http\", instance=\"172.17.0.12:9015\", job=\"absolute-epicenter-worker\", namespace=\"default\", pod=\"absolute-epicenter-worker-d4bd57886-hpdmp\", service=\"absolute-epicenter-worker\"}\r\n16\r\nscrape_samples_post_metric_relabeling{endpoint=\"http\", instance=\"172.17.0.12:9015\", job=\"absolute-epicenter-worker\", namespace=\"default\", pod=\"absolute-epicenter-worker-d4bd57886-hpdmp\", service=\"absolute-epicenter-worker\"}\r\n0\r\nscrape_series_added{endpoint=\"http\", instance=\"172.17.0.12:9015\", job=\"absolute-epicenter-worker\", namespace=\"default\", pod=\"absolute-epicenter-worker-d4bd57886-hpdmp\", service=\"absolute-epicenter-worker\"}\r\n0\r\ncount:up1{endpoint=\"http\", job=\"absolute-epicenter-worker\", namespace=\"default\", service=\"absolute-epicenter-worker\"}\r\n1\r\n```\r\n\r\nNotice how I have no samples post relabeling? The number scraped is correct. Here's my service monitor. I could fish out the version with the vars filled in, but this is a minikube install with everything in the 'default' namespace, so the values would not be terribly interesting. Both the app label and match label do match the app name, as the app uses exactly same same variables for its name (and release, etc). Other than this I'm relying on the defaults for the prometheus-operator helm chart. Nothing changed. And the monitor works insofar as the number of samples shown for the scrape is correct.\r\n\r\n```\r\n---\r\napiVersion: monitoring.coreos.com/v1\r\nkind: ServiceMonitor\r\nmetadata:\r\n  name: {{ include \"epicenter-worker.fullname\" . }}\r\n  namespace: {{ .Release.Namespace }}\r\n  labels:\r\n    app: {{ include \"epicenter-worker.fullname\" . }}\r\n    chart: \"{{ .Chart.Name }}-{{ .Chart.Version }}\"\r\n    release: \"{{ .Release.Name }}\"\r\n    heritage: \"{{ .Release.Service }}\"\r\nspec:\r\n  selector:\r\n    matchLabels:\r\n      app: {{ include \"epicenter-worker.fullname\" . }}\r\n      release: \"{{ .Release.Name }}\"\r\n  namespaceSelector:\r\n    matchNames:\r\n    - {{ .Release.Namespace }}\r\n  endpoints:\r\n  - port: http\r\n    interval: 120s\r\n    path: /epicenter/rest/claxon/prometheus\r\n```\r\n\r\nAnd here's the config from the running Prometheus instance...\r\n\r\n```\r\n- job_name: default/absolute-epicenter-worker/0\r\n  honor_timestamps: true\r\n  scrape_interval: 2m\r\n  scrape_timeout: 10s\r\n  metrics_path: /epicenter/rest/claxon/prometheus\r\n  scheme: http\r\n  kubernetes_sd_configs:\r\n  - role: endpoints\r\n    namespaces:\r\n      names:\r\n      - default\r\n  relabel_configs:\r\n  - source_labels: [__meta_kubernetes_service_label_app]\r\n    separator: ;\r\n    regex: absolute-epicenter-worker\r\n    replacement: $1\r\n    action: keep\r\n  - source_labels: [__meta_kubernetes_service_label_release]\r\n    separator: ;\r\n    regex: absolute\r\n    replacement: $1\r\n    action: keep\r\n  - source_labels: [__meta_kubernetes_endpoint_port_name]\r\n    separator: ;\r\n    regex: http\r\n    replacement: $1\r\n    action: keep\r\n  - source_labels: [__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name]\r\n    separator: ;\r\n    regex: Node;(.*)\r\n    target_label: node\r\n    replacement: ${1}\r\n    action: replace\r\n  - source_labels: [__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name]\r\n    separator: ;\r\n    regex: Pod;(.*)\r\n    target_label: pod\r\n    replacement: ${1}\r\n    action: replace\r\n  - source_labels: [__meta_kubernetes_namespace]\r\n    separator: ;\r\n    regex: (.*)\r\n    target_label: namespace\r\n    replacement: $1\r\n    action: replace\r\n  - source_labels: [__meta_kubernetes_service_name]\r\n    separator: ;\r\n    regex: (.*)\r\n    target_label: service\r\n    replacement: $1\r\n    action: replace\r\n  - source_labels: [__meta_kubernetes_pod_name]\r\n    separator: ;\r\n    regex: (.*)\r\n    target_label: pod\r\n    replacement: $1\r\n    action: replace\r\n  - source_labels: [__meta_kubernetes_service_name]\r\n    separator: ;\r\n    regex: (.*)\r\n    target_label: job\r\n    replacement: ${1}\r\n    action: replace\r\n  - separator: ;\r\n    regex: (.*)\r\n    target_label: endpoint\r\n    replacement: http\r\n    action: replace\r\n```\r\n\r\nSo why am I losing all my samples post relabelling?",
  "closed_at": "2020-06-04T15:00:38Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/7115638?v=4",
    "events_url": "https://api.github.com/users/brian-brazil/events{/privacy}",
    "followers_url": "https://api.github.com/users/brian-brazil/followers",
    "following_url": "https://api.github.com/users/brian-brazil/following{/other_user}",
    "gists_url": "https://api.github.com/users/brian-brazil/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brian-brazil",
    "id": 7115638,
    "login": "brian-brazil",
    "node_id": "MDQ6VXNlcjcxMTU2Mzg=",
    "organizations_url": "https://api.github.com/users/brian-brazil/orgs",
    "received_events_url": "https://api.github.com/users/brian-brazil/received_events",
    "repos_url": "https://api.github.com/users/brian-brazil/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brian-brazil/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brian-brazil/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brian-brazil"
  },
  "comments": 11,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/7298/comments",
  "created_at": "2020-05-26T21:12:05Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/7298/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/7298",
  "id": 625202030,
  "labels": [],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/7298/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MjUyMDIwMzA=",
  "number": 7298,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Samples are dropped due to relabelling, despite the lack of relabelling",
  "updated_at": "2020-06-04T15:00:38Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/7298",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/314404?v=4",
    "events_url": "https://api.github.com/users/zenbones/events{/privacy}",
    "followers_url": "https://api.github.com/users/zenbones/followers",
    "following_url": "https://api.github.com/users/zenbones/following{/other_user}",
    "gists_url": "https://api.github.com/users/zenbones/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/zenbones",
    "id": 314404,
    "login": "zenbones",
    "node_id": "MDQ6VXNlcjMxNDQwNA==",
    "organizations_url": "https://api.github.com/users/zenbones/orgs",
    "received_events_url": "https://api.github.com/users/zenbones/received_events",
    "repos_url": "https://api.github.com/users/zenbones/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/zenbones/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zenbones/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/zenbones"
  }
}