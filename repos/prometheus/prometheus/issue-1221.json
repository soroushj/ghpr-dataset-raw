{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "One of our prometheus instances panic:ed with `runtime/cgo: out of memory in thread_start`(possible due to [#1223](https://github.com/golang/go/issues/12233) ) and noticed that > 3k goroutines where in used by:\n\n```\ngoroutine 101621016 [select, 191 minutes]:\ngithub.com/prometheus/prometheus/retrieval/discovery.(*zookeeperTreeCache).recursiveNodeUpdate.func1(0xcd28eedf20, 0xc8203a9d40, 0xcbee1e2300)\n        /tmp/gowork/src/github.com/prometheus/prometheus/retrieval/discovery/serverset.go:346 +0x35f\ncreated by github.com/prometheus/prometheus/retrieval/discovery.(*zookeeperTreeCache).recursiveNodeUpdate\n        /tmp/gowork/src/github.com/prometheus/prometheus/retrieval/discovery/serverset.go:353 +0x9f4\n```\n\nAs the serveset impl. is applying watches for the entire tree any changes to the members will spawn additional goroutines for already watched members. I added some debugging to prometheus to illustrate this: \n\n```\nDEBU[50188] /aurora/jobs:1                                source=serverset.go:192\nDEBU[50188] /aurora/jobs/www-data/devel/hello_world/member_0000000149:2  source=serverset.go:192\nDEBU[50188] /aurora/jobs/www-data:1                       source=serverset.go:192\nDEBU[50188] /aurora/jobs/www-data/devel/hello_world:1     source=serverset.go:192\nDEBU[50188] /aurora/jobs/www-data/devel/hello_world/member_0000000140:13  source=serverset.go:192\nDEBU[50188] /aurora/jobs/www-data/devel/hello_world/member_0000000150:1  source=serverset.go:192\nDEBU[50188] /aurora/jobs/www-data/devel/hello_world/member_0000000148:3  source=serverset.go:192\nDEBU[50188] /aurora/jobs/www-data/devel:1                 source=serverset.go:192\nDEBU[50188] /aurora/jobs/www-data/devel/hello_world/member_0000000144:8  source=serverset.go:192\nDEBU[50188] /aurora/jobs/www-data/devel/hello_world/member_0000000145:8  source=serverset.go:192\n```\n\nThe above is an aurora job which has been scaled up and down a couple of times `member_0000000140` has 13 watches and therefore uses 13 goroutines. \n\nWanted to file this to see if other has run into this and if my observations holds true. \nIf nobody bets me to it I can take a stab at it when time permits and file a PR.  \n",
  "closed_at": "2015-12-10T10:43:57Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/7115638?v=4",
    "events_url": "https://api.github.com/users/brian-brazil/events{/privacy}",
    "followers_url": "https://api.github.com/users/brian-brazil/followers",
    "following_url": "https://api.github.com/users/brian-brazil/following{/other_user}",
    "gists_url": "https://api.github.com/users/brian-brazil/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brian-brazil",
    "id": 7115638,
    "login": "brian-brazil",
    "node_id": "MDQ6VXNlcjcxMTU2Mzg=",
    "organizations_url": "https://api.github.com/users/brian-brazil/orgs",
    "received_events_url": "https://api.github.com/users/brian-brazil/received_events",
    "repos_url": "https://api.github.com/users/brian-brazil/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brian-brazil/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brian-brazil/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brian-brazil"
  },
  "comments": 1,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/1221/comments",
  "created_at": "2015-11-14T11:33:13Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/1221/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/1221",
  "id": 116920258,
  "labels": [],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/1221/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUxMTY5MjAyNTg=",
  "number": 1221,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "High goroutine usage in serverset.go",
  "updated_at": "2019-03-24T15:28:50Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/1221",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/2462159?v=4",
    "events_url": "https://api.github.com/users/tommyulfsparre/events{/privacy}",
    "followers_url": "https://api.github.com/users/tommyulfsparre/followers",
    "following_url": "https://api.github.com/users/tommyulfsparre/following{/other_user}",
    "gists_url": "https://api.github.com/users/tommyulfsparre/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/tommyulfsparre",
    "id": 2462159,
    "login": "tommyulfsparre",
    "node_id": "MDQ6VXNlcjI0NjIxNTk=",
    "organizations_url": "https://api.github.com/users/tommyulfsparre/orgs",
    "received_events_url": "https://api.github.com/users/tommyulfsparre/received_events",
    "repos_url": "https://api.github.com/users/tommyulfsparre/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/tommyulfsparre/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tommyulfsparre/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/tommyulfsparre"
  }
}