{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**What did you do?**\r\nUsing 3 standalone victoria-metrics as LTS storage for prometheus.\r\n\r\n\r\n**What did you expect to see?**\r\n`prometheus_remote_storage_pending_samples` should not increase over time.\r\n\r\n**What did you see instead? Under which circumstances?**\r\nIncrease on `prometheus_remote_storage_pending_samples` metric.\r\nIt does not look that there is a metric lag on victoria-metrics site though.\r\n\r\n**Environment**\r\nCentos 7. Prometheus 2.16.0 (same issue on older versions). Victoria-metrics 1.32.6\r\nAbout 1.5k scrape targets.\r\n\r\n\r\n* System information:\r\n\r\n\t`Linux 3.10.0-957.21.3.el7.x86_64 x86_64`\r\n\r\n* Prometheus version:\r\n```\r\nprometheus, version 2.16.0 (branch: HEAD, revision: b90be6f32a33c03163d700e1452b54454ddce0ec)\r\n  build user:       root@7ea0ae865f12\r\n  build date:       20200213-23:50:02\r\n  go version:       go1.13.8\r\n```\r\n\r\n* Prometheus configuration file:\r\n```\r\n---\r\nglobal:\r\n  scrape_interval: 30s\r\n  scrape_timeout: 5s\r\nrule_files:\r\n- \"/etc/prometheus/rules/*\"\r\nremote_write:\r\n- url: http://victoria-metrics1:8428/api/v1/write\r\n  queue_config:\r\n    max_shards: 50\r\n    min_shards: 2\r\n    capacity: 1500000\r\n    max_samples_per_send: 150000\r\n    batch_send_deadline: 2s\r\n- url: http://victoria-metrics2:8428/api/v1/write\r\n  queue_config:\r\n    max_shards: 50\r\n    min_shards: 2\r\n    capacity: 1500000\r\n    max_samples_per_send: 150000\r\n    batch_send_deadline: 2s\r\n- url: http://victoria-metrics3:8428/api/v1/write\r\n  queue_config:\r\n    max_shards: 50\r\n    min_shards: 2\r\n    capacity: 1500000\r\n    max_samples_per_send: 150000\r\n    batch_send_deadline: 2s\r\n```\r\n\r\nPrometheus seems to work fine for some time, but then it will start drastically increse `prometheus_remote_storage_pending_samples` metrics. It does not seem, that there's any lag in metrics, which are written to remote storage.\r\nIt also appears, that `prometheus_remote_storage_pending_samples` begins to increase right after `WAL checkpoint`.  You can see that during checkpoint, prometheus begins increasing shard count and  also `pending_samples` begins to grow:\r\n\r\n`prometheus_remote_storage_shards`:\r\n<img width=\"1552\" alt=\"Screenshot 2020-03-10 08 28 08\" src=\"https://user-images.githubusercontent.com/6713389/76285732-1df7de00-62a9-11ea-92c1-7386bffdff92.png\">\r\n`prometheus_remote_storage_pending_samples`:\r\n<img width=\"1552\" alt=\"Screenshot 2020-03-10 08 28 53\" src=\"https://user-images.githubusercontent.com/6713389/76285767-336d0800-62a9-11ea-924b-a9c392c34577.png\">\r\n\r\nWhat could be causing this?\r\nThank you.\r\n\r\n",
  "closed_at": "2020-06-25T20:48:31Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/3280472?v=4",
    "events_url": "https://api.github.com/users/csmarchbanks/events{/privacy}",
    "followers_url": "https://api.github.com/users/csmarchbanks/followers",
    "following_url": "https://api.github.com/users/csmarchbanks/following{/other_user}",
    "gists_url": "https://api.github.com/users/csmarchbanks/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/csmarchbanks",
    "id": 3280472,
    "login": "csmarchbanks",
    "node_id": "MDQ6VXNlcjMyODA0NzI=",
    "organizations_url": "https://api.github.com/users/csmarchbanks/orgs",
    "received_events_url": "https://api.github.com/users/csmarchbanks/received_events",
    "repos_url": "https://api.github.com/users/csmarchbanks/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/csmarchbanks/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/csmarchbanks/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/csmarchbanks"
  },
  "comments": 19,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/6952/comments",
  "created_at": "2020-03-10T06:33:53Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/6952/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/6952",
  "id": 578366710,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567165,
      "name": "component/remote storage",
      "node_id": "MDU6TGFiZWwzNjU1NjcxNjU=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/remote%20storage"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/6952/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1NzgzNjY3MTA=",
  "number": 6952,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "prometheus_remote_storage_pending_samples are drastically increasing over time.",
  "updated_at": "2020-06-25T20:48:31Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/6952",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/6713389?v=4",
    "events_url": "https://api.github.com/users/Seitanas/events{/privacy}",
    "followers_url": "https://api.github.com/users/Seitanas/followers",
    "following_url": "https://api.github.com/users/Seitanas/following{/other_user}",
    "gists_url": "https://api.github.com/users/Seitanas/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/Seitanas",
    "id": 6713389,
    "login": "Seitanas",
    "node_id": "MDQ6VXNlcjY3MTMzODk=",
    "organizations_url": "https://api.github.com/users/Seitanas/orgs",
    "received_events_url": "https://api.github.com/users/Seitanas/received_events",
    "repos_url": "https://api.github.com/users/Seitanas/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/Seitanas/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Seitanas/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/Seitanas"
  }
}