{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**What did you do?**\r\n\r\nI grabbed Prometheus 1.5.2 and applied the ZK patch from PR #2470, built and tested it.  Next I had a team use the new version who monitors a pretty healthy list of Aurora (ZooKeeper discovery) jobs, and healthy usage of recording rules.  We saw an immediate jump in CPU compared to the prior Prometheus version (1.2.1).  It started taking all CPU resources we granted to the Aurora job running it.\r\n\r\n<img width=\"1440\" alt=\"prometheus-zk-cpu-bug\" src=\"https://cloud.githubusercontent.com/assets/10540/23671944/0dfb044e-033b-11e7-9e48-bc1bece5dd9b.png\">\r\n\r\n**What did you expect to see?**\r\n\r\nAs the configuration was unchanged, we expected to see similar CPU usage from prior versions.\r\n\r\n**What did you see instead? Under which circumstances?**\r\n\r\nCPU usage appears normal when I attempted to reproduce with just the `prometheus.yml` config file copied over to my test environment.  CPU usage was under 2 cores.  However, when I added the recording rules to my test environment the CPU usage spiked up to 17 cores on my test hardware.  This bare metal server now runs at a load of 17+.\r\n\r\nI got out the profiling tools to take a look and produced the following SVG:\r\n\r\n![p-test pprof](https://cloud.githubusercontent.com/assets/10540/23672212/ef114bbe-033b-11e7-88c6-f91f2047057f.png)\r\n\r\nWhy would recording rules cause more time to be spent in ZookeeperDiscovery?\r\n\r\n**Environment**\r\n\r\nMy test hardware is Ubuntu Trusty running kernel 3.13.0-85-generic.  64G RAM and 24 cores.\r\n\r\nPrometheus was compiled with Go 1.7.4.\r\n\r\n* System information:\r\n\r\n\tLinux 3.13.0-85-generic x86_64\r\n\r\n* Prometheus version: \r\n\r\n\tprometheus, version 1.5.2 (branch: foo, revision: 1.5.2-1+JENKINS~trusty.20170306212211)\r\n          build user:       jjneely@42lines.net\r\n          build date:       2017-03-06T21:22:40Z\r\n          go version:       go1.7.4\r\n\r\n* Prometheus configuration file:\r\n\r\n[prometheus-test.txt](https://github.com/prometheus/prometheus/files/825436/prometheus-test.txt)\r\n\r\n* Prometheus Rules:\r\n\r\n[prometheus-test.rules.txt](https://github.com/prometheus/prometheus/files/825461/prometheus-test.rules.txt)\r\n\r\n",
  "closed_at": "2017-05-02T23:21:38Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/538008?v=4",
    "events_url": "https://api.github.com/users/juliusv/events{/privacy}",
    "followers_url": "https://api.github.com/users/juliusv/followers",
    "following_url": "https://api.github.com/users/juliusv/following{/other_user}",
    "gists_url": "https://api.github.com/users/juliusv/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/juliusv",
    "id": 538008,
    "login": "juliusv",
    "node_id": "MDQ6VXNlcjUzODAwOA==",
    "organizations_url": "https://api.github.com/users/juliusv/orgs",
    "received_events_url": "https://api.github.com/users/juliusv/received_events",
    "repos_url": "https://api.github.com/users/juliusv/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/juliusv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/juliusv/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/juliusv"
  },
  "comments": 6,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/2481/comments",
  "created_at": "2017-03-07T19:00:32Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/2481/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/2481",
  "id": 212526865,
  "labels": [],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/2481/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyMTI1MjY4NjU=",
  "number": 2481,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "High CPU Usage with Recording Rules and ZK Patch",
  "updated_at": "2019-03-23T18:45:09Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/2481",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/10540?v=4",
    "events_url": "https://api.github.com/users/jjneely/events{/privacy}",
    "followers_url": "https://api.github.com/users/jjneely/followers",
    "following_url": "https://api.github.com/users/jjneely/following{/other_user}",
    "gists_url": "https://api.github.com/users/jjneely/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jjneely",
    "id": 10540,
    "login": "jjneely",
    "node_id": "MDQ6VXNlcjEwNTQw",
    "organizations_url": "https://api.github.com/users/jjneely/orgs",
    "received_events_url": "https://api.github.com/users/jjneely/received_events",
    "repos_url": "https://api.github.com/users/jjneely/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jjneely/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jjneely/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jjneely"
  }
}