{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "## Bug Report\r\nI have an implementation of the storage.Querier interface for my storage, with promql on top. In this setup if a user sends a query for a metric at a single point with an offset of 4w the querier created by promql spans 4w. This makes it difficult (to say the least) to create an efficient querier implementation. presumably similar issues exist inside prom itself (since it would potentially load significantly more data than necessary). I currently have 2 fixes for the issue, either of which I'd be glad to merge upstream-- I'm looking for some input on what fix you'd prefer.\r\n\r\n### Option 1: multiple queriers\r\nIf we don't want to change the querier interface at all we can simply make promql/engine.go create a querier for each offset. This does potentially mean more connections etc. depending on what the querier does under the hood, but does avoid the gross over-scanning of data.\r\nCode: https://github.com/jacksontj/prometheus/commit/4475e2a546953619d738f4a92923484fe021d783\r\n\r\n### Option 2: add offset to selectParams\r\nIf we are okay adding a field to selectParams we can simply pass in the offset there on each actual `Select`. This mechanism allows for the querier to be re-used, and then makes it optional for the querier to actually look at the offset. This method would require Queriers to make code changes to pick it up, but it is backwards compatible (meaning if they don't look at the selectParam field, then they just fall back to current behavior).\r\n**Given the interface etc. I think this is the one we should do.**\r\nCode: https://github.com/jacksontj/prometheus/commit/cb722690f3aa9f38ac5d9a3b0e95ea1a417cfb78\r\n\r\n**Environment**\r\n\r\n* Prometheus version:\r\n\r\n2.2 (same issue exists in master)",
  "closed_at": "2018-07-18T03:58:01Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/7115638?v=4",
    "events_url": "https://api.github.com/users/brian-brazil/events{/privacy}",
    "followers_url": "https://api.github.com/users/brian-brazil/followers",
    "following_url": "https://api.github.com/users/brian-brazil/following{/other_user}",
    "gists_url": "https://api.github.com/users/brian-brazil/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brian-brazil",
    "id": 7115638,
    "login": "brian-brazil",
    "node_id": "MDQ6VXNlcjcxMTU2Mzg=",
    "organizations_url": "https://api.github.com/users/brian-brazil/orgs",
    "received_events_url": "https://api.github.com/users/brian-brazil/received_events",
    "repos_url": "https://api.github.com/users/brian-brazil/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brian-brazil/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brian-brazil/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brian-brazil"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/4224/comments",
  "created_at": "2018-06-05T18:11:44Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/4224/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/4224",
  "id": 329568090,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567165,
      "name": "component/remote storage",
      "node_id": "MDU6TGFiZWwzNjU1NjcxNjU=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/remote%20storage"
    },
    {
      "color": "c7def8",
      "default": false,
      "description": null,
      "id": 365563592,
      "name": "kind/enhancement",
      "node_id": "MDU6TGFiZWwzNjU1NjM1OTI=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/enhancement"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/4224/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMjk1NjgwOTA=",
  "number": 4224,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "storage.Querier doesn't handle offsets efficiently",
  "updated_at": "2019-03-22T13:28:29Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/4224",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/1619869?v=4",
    "events_url": "https://api.github.com/users/jacksontj/events{/privacy}",
    "followers_url": "https://api.github.com/users/jacksontj/followers",
    "following_url": "https://api.github.com/users/jacksontj/following{/other_user}",
    "gists_url": "https://api.github.com/users/jacksontj/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/jacksontj",
    "id": 1619869,
    "login": "jacksontj",
    "node_id": "MDQ6VXNlcjE2MTk4Njk=",
    "organizations_url": "https://api.github.com/users/jacksontj/orgs",
    "received_events_url": "https://api.github.com/users/jacksontj/received_events",
    "repos_url": "https://api.github.com/users/jacksontj/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/jacksontj/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jacksontj/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/jacksontj"
  }
}