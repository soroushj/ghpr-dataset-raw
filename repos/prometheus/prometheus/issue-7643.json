{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "\r\n\r\n**What did you do?**\r\n\r\ngo to `tsdb/cmd/tsdb`\r\n\r\nrun `go build -race`\r\n\r\nrun `./tsdb bench write`\r\n\r\n\r\n**What did you see instead? Under which circumstances?**\r\n\r\n```\r\nlevel=info ts=2020-07-22T19:24:32.781849643Z caller=head.go:644 msg=\"Replaying on-disk memory mappable chunks if any\"\r\nlevel=info ts=2020-07-22T19:24:32.781938855Z caller=head.go:658 msg=\"On-disk memory mappable chunks replay completed\" duration=8.664\u00b5s\r\nlevel=info ts=2020-07-22T19:24:32.781978555Z caller=head.go:664 msg=\"Replaying WAL, this may take a while\"\r\nlevel=info ts=2020-07-22T19:24:32.783212713Z caller=head.go:716 msg=\"WAL segment loaded\" segment=0 maxSegment=0\r\nlevel=info ts=2020-07-22T19:24:32.783273215Z caller=head.go:719 msg=\"WAL replay completed\" checkpoint_replay_duration=38.543\u00b5s wal_replay_d\r\nuration=1.223691ms total_replay_duration=1.342628ms                  \r\n>> start stage=readData\r\n>> completed stage=readData duration=535.829761ms\r\n>> start stage=ingestScrapes\r\nlevel=info ts=2020-07-22T19:24:44.368042711Z caller=compact.go:495 msg=\"write block\" mint=30000 maxt=7200000 ulid=01EDVZR8NHVK141QB8KAZ51G4\r\nV duration=4.894039391s           \r\nlevel=info ts=2020-07-22T19:24:44.493809687Z caller=head.go:807 msg=\"Head GC completed\" duration=85.226228ms\r\n==================\r\nWARNING: DATA RACE\r\nRead at 0x00c00021e000 by goroutine 35:\r\n  github.com/prometheus/prometheus/tsdb/chunks.(*ChunkDiskMapper).Truncate()\r\n      /home/roidelapluie/dev/prometheus/tsdb/chunks/head_chunks.go:684 +0x50e\r\n  github.com/prometheus/prometheus/tsdb.(*Head).Truncate()\r\n      /home/roidelapluie/dev/prometheus/tsdb/head.go:811 +0x632\r\n  github.com/prometheus/prometheus/tsdb.(*DB).reload()\r\n      /home/roidelapluie/dev/prometheus/tsdb/db.go:974 +0x18be\r\n  github.com/prometheus/prometheus/tsdb.(*DB).compactHead()\r\n      /home/roidelapluie/dev/prometheus/tsdb/db.go:804 +0x17c\r\n  github.com/prometheus/prometheus/tsdb.(*DB).Compact()\r\n      /home/roidelapluie/dev/prometheus/tsdb/db.go:775 +0x302\r\n  github.com/prometheus/prometheus/tsdb.(*DB).run()\r\n      /home/roidelapluie/dev/prometheus/tsdb/db.go:696 +0x427\r\n\r\nPrevious write at 0x00c00021e000 by goroutine 96:\r\n  sync/atomic.AddInt64()\r\n      /home/roidelapluie/godist/go/src/runtime/race_amd64.s:276 +0xb\r\n  github.com/prometheus/prometheus/tsdb/chunks.(*ChunkDiskMapper).write()\r\n      /home/roidelapluie/dev/prometheus/tsdb/chunks/head_chunks.go:397 +0x9e\r\n  github.com/prometheus/prometheus/tsdb/chunks.(*ChunkDiskMapper).writeCRC32()\r\n      /home/roidelapluie/dev/prometheus/tsdb/chunks/head_chunks.go:410 +0xa0\r\n  github.com/prometheus/prometheus/tsdb/chunks.(*ChunkDiskMapper).WriteChunk()\r\n      /home/roidelapluie/dev/prometheus/tsdb/chunks/head_chunks.go:282 +0x6ca\r\n  github.com/prometheus/prometheus/tsdb.(*memSeries).mmapCurrentHeadChunk()\r\n      /home/roidelapluie/dev/prometheus/tsdb/head.go:2022 +0x1a2\r\n  github.com/prometheus/prometheus/tsdb.(*memSeries).cutNewHeadChunk()\r\n      /home/roidelapluie/dev/prometheus/tsdb/head.go:1996 +0x4f\r\n  github.com/prometheus/prometheus/tsdb.(*memSeries).append()\r\n      /home/roidelapluie/dev/prometheus/tsdb/head.go:2153 +0x781\r\n  github.com/prometheus/prometheus/tsdb.(*headAppender).Commit()\r\n      /home/roidelapluie/dev/prometheus/tsdb/head.go:1221 +0x533\r\n  github.com/prometheus/prometheus/tsdb.dbAppender.Commit()\r\n      /home/roidelapluie/dev/prometheus/tsdb/db.go:725 +0x42\r\n  github.com/prometheus/prometheus/tsdb.(*dbAppender).Commit()\r\n      <autogenerated>:1 +0x7f\r\n  main.(*writeBenchmark).ingestScrapesShard()\r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:326 +0x863\r\n  main.(*writeBenchmark).ingestScrapes.func1()\r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:261 +0xa8\r\n\r\nGoroutine 35 (running) created at: \r\n  github.com/prometheus/prometheus/tsdb.open()\r\n      /home/roidelapluie/dev/prometheus/tsdb/db.go:652 +0xbbc\r\n  github.com/prometheus/prometheus/tsdb.Open()\r\n      /home/roidelapluie/dev/prometheus/tsdb/db.go:520 +0xdb\r\n  main.(*writeBenchmark).run()\r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:180 +0x38b\r\n  main.execute()                  \r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:85 +0x38d2\r\n  main.main()                     \r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:45 +0x33\r\n\r\nGoroutine 96 (running) created at: \r\n  main.(*writeBenchmark).ingestScrapes()\r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:260 +0x189\r\n  main.(*writeBenchmark).run.func2()\r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:214 +0xd0\r\n  main.measureTime()\r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:402 +0x119\r\n  main.(*writeBenchmark).run()\r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:210 +0x53e\r\n  main.execute()                  \r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:85 +0x38d2\r\n  main.main()                     \r\n      /home/roidelapluie/dev/prometheus/tsdb/cmd/tsdb/main.go:45 +0x33\r\n==================\r\nlevel=info ts=2020-07-22T19:24:49.115155086Z caller=compact.go:495 msg=\"write block\" mint=7200000 maxt=14400000 ulid=01EDVZRDVMRMWX34NC6DZM\r\nMKTR duration=4.326777491s        \r\nlevel=info ts=2020-07-22T19:24:49.334804923Z caller=head.go:807 msg=\"Head GC completed\" duration=97.768206ms\r\nlevel=info ts=2020-07-22T19:24:54.520229096Z caller=compact.go:495 msg=\"write block\" mint=14400000 maxt=21600000 ulid=01EDVZRJF1AQHDRC1MWZC\r\nB75TC duration=5.014742193s       \r\nlevel=info ts=2020-07-22T19:24:54.623786138Z caller=head.go:807 msg=\"Head GC completed\" duration=62.251245ms\r\nlevel=info ts=2020-07-22T19:24:59.357399935Z caller=compact.go:495 msg=\"write block\" mint=21600000 maxt=28800000 ulid=01EDVZRQH7PYHG9929W91\r\nHSPPW duration=4.662078913s       \r\nlevel=info ts=2020-07-22T19:24:59.664886308Z caller=head.go:807 msg=\"Head GC completed\" duration=170.871753ms\r\nlevel=info ts=2020-07-22T19:24:59.730945668Z caller=checkpoint.go:96 msg=\"Creating checkpoint\" from_segment=0 to_segment=1 mint=28800000\r\nlevel=info ts=2020-07-22T19:25:12.51951992Z caller=head.go:887 msg=\"WAL checkpoint complete\" first=0 last=1 duration=12.800449564s\r\nlevel=info ts=2020-07-22T19:25:17.134926244Z caller=compact.go:495 msg=\"write block\" mint=28800000 maxt=36000000 ulid=01EDVZS8Z2ZV005FKFJJJ\r\n0QNA9 duration=4.588714807s       \r\nlevel=info ts=2020-07-22T19:25:17.294591187Z caller=head.go:807 msg=\"Head GC completed\" duration=91.77399ms\r\nlevel=info ts=2020-07-22T19:25:22.226802785Z caller=compact.go:495 msg=\"write block\" mint=36000000 maxt=43200000 ulid=01EDVZSDTVH1J9HZ3W6GF\r\nMD0XC duration=4.695752302s       \r\nlevel=info ts=2020-07-22T19:25:22.439118915Z caller=head.go:807 msg=\"Head GC completed\" duration=146.826738ms\r\nlevel=info ts=2020-07-22T19:25:22.495662905Z caller=checkpoint.go:96 msg=\"Creating checkpoint\" from_segment=2 to_segment=3 mint=43200000\r\nlevel=info ts=2020-07-22T19:25:29.365701867Z caller=head.go:887 msg=\"WAL checkpoint complete\" first=2 last=3 duration=6.871467393s\r\nlevel=info ts=2020-07-22T19:25:34.692107772Z caller=compact.go:495 msg=\"write block\" mint=43200000 maxt=50400000 ulid=01EDVZSSE58BBZ36P20DE\r\nXM7NY duration=5.278969806s       \r\nlevel=info ts=2020-07-22T19:25:34.846353602Z caller=head.go:807 msg=\"Head GC completed\" duration=109.266594ms\r\ningestion completed\r\n>> completed stage=ingestScrapes duration=1m2.07410211s\r\n > total samples: 30000000\r\n > samples/sec: 483293.1897202682\r\n>> start stage=stopStorage\r\nlevel=error ts=2020-07-22T19:25:35.415341456Z caller=db.go:697 msg=\"compaction failed\" err=\"persist head block: 2 errors: write compaction:\r\n context canceled; context canceled\"                                 \r\n>> completed stage=stopStorage duration=383.118267ms\r\n```\r\n\r\n**Environment**\r\n\r\n* System information:\r\n\r\n\tLinux\r\n\r\n* Prometheus version:\r\n\r\n\t4a8531a64b32cc124ebafe79000b27ba4bc84c7d\r\n\r\n",
  "closed_at": "2020-07-23T12:35:20Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/15064823?v=4",
    "events_url": "https://api.github.com/users/codesome/events{/privacy}",
    "followers_url": "https://api.github.com/users/codesome/followers",
    "following_url": "https://api.github.com/users/codesome/following{/other_user}",
    "gists_url": "https://api.github.com/users/codesome/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/codesome",
    "id": 15064823,
    "login": "codesome",
    "node_id": "MDQ6VXNlcjE1MDY0ODIz",
    "organizations_url": "https://api.github.com/users/codesome/orgs",
    "received_events_url": "https://api.github.com/users/codesome/received_events",
    "repos_url": "https://api.github.com/users/codesome/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/codesome/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/codesome/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/codesome"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/7643/comments",
  "created_at": "2020-07-22T19:34:40Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/7643/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/7643",
  "id": 664000915,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": "",
      "id": 1498495148,
      "name": "component/tsdb",
      "node_id": "MDU6TGFiZWwxNDk4NDk1MTQ4",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/tsdb"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    },
    {
      "color": "fef2c0",
      "default": false,
      "description": null,
      "id": 365563608,
      "name": "priority/Pmaybe",
      "node_id": "MDU6TGFiZWwzNjU1NjM2MDg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/priority/Pmaybe"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/7643/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2NjQwMDA5MTU=",
  "number": 7643,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Race in tsdb benchwrite",
  "updated_at": "2020-07-23T12:35:20Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/7643",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/291750?v=4",
    "events_url": "https://api.github.com/users/roidelapluie/events{/privacy}",
    "followers_url": "https://api.github.com/users/roidelapluie/followers",
    "following_url": "https://api.github.com/users/roidelapluie/following{/other_user}",
    "gists_url": "https://api.github.com/users/roidelapluie/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/roidelapluie",
    "id": 291750,
    "login": "roidelapluie",
    "node_id": "MDQ6VXNlcjI5MTc1MA==",
    "organizations_url": "https://api.github.com/users/roidelapluie/orgs",
    "received_events_url": "https://api.github.com/users/roidelapluie/received_events",
    "repos_url": "https://api.github.com/users/roidelapluie/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/roidelapluie/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/roidelapluie/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/roidelapluie"
  }
}