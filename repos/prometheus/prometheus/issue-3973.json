{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "## Query\r\n```\r\ntopk(9999999999, prometheus_build_info)\r\n```\r\n\r\n## Expected\r\n\r\nElement | Value\r\n-- | --\r\nprometheus_build_info{goversion=\"go1.10\", ..., revision=\"f63e7db4cbdb616337ca877b306b9b96f7f4e381\",version=\"2.2.0\"} | 1\r\n\r\n## Actual\r\nPrometheus spins 100% on a core for a short period then OOM panics. This happens with lower values of `k` for queries with higher label cardinality.\r\n```\r\nfatal error: runtime: out of memory\r\n\r\nruntime stack:\r\nruntime.throw(0x1af4202, 0x16)\r\n        /usr/local/go/src/runtime/panic.go:619 +0x81\r\nruntime.sysMap(0xc422740000, 0x55e63c0000, 0x0, 0x28a6138)\r\n        /usr/local/go/src/runtime/mem_linux.go:216 +0x20a\r\nruntime.(*mheap).sysAlloc(0x288c9c0, 0x55e63c0000, 0x0)\r\n        /usr/local/go/src/runtime/malloc.go:470 +0xd4\r\nruntime.(*mheap).grow(0x288c9c0, 0x2af31dd, 0x0)\r\n        /usr/local/go/src/runtime/mheap.go:907 +0x60\r\nruntime.(*mheap).allocSpanLocked(0x288c9c0, 0x2af31dd, 0x28a6148, 0xc4204b9ee0)\r\n        /usr/local/go/src/runtime/mheap.go:820 +0x301\r\nruntime.(*mheap).alloc_m(0x288c9c0, 0x2af31dd, 0xffffffffffff0100, 0xc4204b9f10)\r\n        /usr/local/go/src/runtime/mheap.go:686 +0x118\r\nruntime.(*mheap).alloc.func1()\r\n        /usr/local/go/src/runtime/mheap.go:753 +0x4d\r\nruntime.(*mheap).alloc(0x288c9c0, 0x2af31dd, 0xc420010100, 0x41467c)\r\n        /usr/local/go/src/runtime/mheap.go:752 +0x8a\r\nruntime.largeAlloc(0x55e63b88a0, 0x450001, 0x7fb9c24e7000)\r\n        /usr/local/go/src/runtime/malloc.go:826 +0x94\r\nruntime.mallocgc.func1()\r\n        /usr/local/go/src/runtime/malloc.go:721 +0x46\r\nruntime.systemstack(0x0)\r\n        /usr/local/go/src/runtime/asm_amd64.s:409 +0x79\r\nruntime.mstart()\r\n        /usr/local/go/src/runtime/proc.go:1170\r\n```\r\n\r\n**Note:** Increasing `k` by appending further digits results in short-circuiting with no OOM, so it seems there's at least _some_ protection from this already, though the error message suggests this comes from the Go runtime not Prometheus itself:\r\n```\r\nlevel=error ts=2018-03-15T18:11:47.103256231Z caller=engine.go:613 component=\"query engine\" msg=\"runtime panic in parser\" err=\"runtime error: makeslice: cap out of range\" \r\n```\r\n\r\n## Use Case\r\nGrafana graph with a limit variable that is passed as `k`. To have an `All` option that at least looks like it includes all, you need to provide an arbitrarily high `k`. I'm sure there are others though, and in any case I suspect most users would not expect increasing `k` to continue increasing memory consumption past the number of available samples.\r\n\r\n## Cause\r\nCalling `make(..., k)` for each set of unique labels: https://github.com/prometheus/prometheus/blob/e87c6c8b28b59ed493919c2e4ba93ff0374cb286/promql/engine.go#L1327-L1339\r\n\r\n## Proposed Fix\r\nFor `k` over some threshold exponentially grow the `Vector` up to a maximum `k` instead of statically allocating all of `k` upfront.",
  "closed_at": "2018-04-16T08:03:05Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/7115638?v=4",
    "events_url": "https://api.github.com/users/brian-brazil/events{/privacy}",
    "followers_url": "https://api.github.com/users/brian-brazil/followers",
    "following_url": "https://api.github.com/users/brian-brazil/following{/other_user}",
    "gists_url": "https://api.github.com/users/brian-brazil/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/brian-brazil",
    "id": 7115638,
    "login": "brian-brazil",
    "node_id": "MDQ6VXNlcjcxMTU2Mzg=",
    "organizations_url": "https://api.github.com/users/brian-brazil/orgs",
    "received_events_url": "https://api.github.com/users/brian-brazil/received_events",
    "repos_url": "https://api.github.com/users/brian-brazil/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/brian-brazil/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brian-brazil/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/brian-brazil"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/3973/comments",
  "created_at": "2018-03-15T18:22:31Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/3973/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/3973",
  "id": 305668065,
  "labels": [
    {
      "color": "0052cc",
      "default": false,
      "description": null,
      "id": 365567473,
      "name": "component/promql",
      "node_id": "MDU6TGFiZWwzNjU1Njc0NzM=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/component/promql"
    },
    {
      "color": "ff0000",
      "default": false,
      "description": null,
      "id": 365563588,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODg=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/kind/bug"
    },
    {
      "color": "4ae04a",
      "default": false,
      "description": "",
      "id": 365563587,
      "name": "low hanging fruit",
      "node_id": "MDU6TGFiZWwzNjU1NjM1ODc=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/low%20hanging%20fruit"
    },
    {
      "color": "fbca04",
      "default": false,
      "description": null,
      "id": 647013637,
      "name": "priority/P3",
      "node_id": "MDU6TGFiZWw2NDcwMTM2Mzc=",
      "url": "https://api.github.com/repos/prometheus/prometheus/labels/priority/P3"
    }
  ],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/3973/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMDU2NjgwNjU=",
  "number": 3973,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "topk and bottomk queries with large k cause OOM panic",
  "updated_at": "2019-03-22T18:09:46Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/3973",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1133705?v=4",
    "events_url": "https://api.github.com/users/roganartu/events{/privacy}",
    "followers_url": "https://api.github.com/users/roganartu/followers",
    "following_url": "https://api.github.com/users/roganartu/following{/other_user}",
    "gists_url": "https://api.github.com/users/roganartu/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/roganartu",
    "id": 1133705,
    "login": "roganartu",
    "node_id": "MDQ6VXNlcjExMzM3MDU=",
    "organizations_url": "https://api.github.com/users/roganartu/orgs",
    "received_events_url": "https://api.github.com/users/roganartu/received_events",
    "repos_url": "https://api.github.com/users/roganartu/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/roganartu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/roganartu/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/roganartu"
  }
}