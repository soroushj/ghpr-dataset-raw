{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!--\r\n\r\n    Please do *NOT* ask usage questions in Github issues.\r\n\r\n    If your issue is not a feature request or bug report use:\r\n    https://groups.google.com/forum/#!forum/prometheus-users. If\r\n    you are unsure whether you hit a bug, search and ask in the\r\n    mailing list first.\r\n\r\n    You can find more information at: https://prometheus.io/community/\r\n\r\n-->\r\n## Bug Report\r\n**What did you do?**\r\nEnabled Consul support on Prometheus inside Kubernetes\r\n\r\n**What did you expect to see?**\r\nPrometheus scraping using consul_sd_configs\r\n\r\n**What did you see instead? Under which circumstances?**\r\nPrometheus cannot reach Consul. If the docker container is entered, Consul can be reached, so this is not likely a networking issue.\r\n\r\n**Environment**\r\n\r\n* System information:\r\n\r\nRunning in k8s with EKS\r\n\r\n* Prometheus version:\r\n\r\n```\r\nprometheus, version 2.12.0 (branch: HEAD, revision: 43acd0e2e93f9f70c49b2267efa0124f1e759e86)\r\n  build user:       root@7a9dbdbe0cc7\r\n  build date:       20190818-13:53:16\r\n  go version:       go1.12.8\r\n```\r\n\r\n* Prometheus configuration file:\r\n```\r\nglobal:\r\n  evaluation_interval: 30s\r\n  scrape_interval: 30s\r\n  external_labels:\r\n    prometheus: <namespace>/prometheus-external-promet-prometheus\r\n    prometheus_replica: prometheus-prometheus-external-promet-prometheus-0\r\nrule_files:\r\n- /etc/prometheus/rules/prometheus-prometheus-external-promet-prometheus-rulefiles-0/*.yaml\r\nscrape_configs:\r\n- job_name: <namespace>/prometheus-external-promet-grafana/0\r\n  honor_labels: false\r\n  kubernetes_sd_configs:\r\n  - role: endpoints\r\n    namespaces:\r\n      names:\r\n      - <namespace>\r\n  metrics_path: /metrics\r\n  relabel_configs:\r\n  - action: keep\r\n    source_labels:\r\n    - __meta_kubernetes_service_label_app\r\n    regex: grafana\r\n  - action: keep\r\n    source_labels:\r\n    - __meta_kubernetes_service_label_release\r\n    regex: prometheus-external\r\n  - action: keep\r\n    source_labels:\r\n    - __meta_kubernetes_endpoint_port_name\r\n    regex: service\r\n  - source_labels:\r\n    - __meta_kubernetes_endpoint_address_target_kind\r\n    - __meta_kubernetes_endpoint_address_target_name\r\n    separator: ;\r\n    regex: Node;(.*)\r\n    replacement: ${1}\r\n    target_label: node\r\n  - source_labels:\r\n    - __meta_kubernetes_endpoint_address_target_kind\r\n    - __meta_kubernetes_endpoint_address_target_name\r\n    separator: ;\r\n    regex: Pod;(.*)\r\n    replacement: ${1}\r\n    target_label: pod\r\n  - source_labels:\r\n    - __meta_kubernetes_namespace\r\n    target_label: namespace\r\n  - source_labels:\r\n    - __meta_kubernetes_service_name\r\n    target_label: service\r\n  - source_labels:\r\n    - __meta_kubernetes_pod_name\r\n    target_label: pod\r\n  - source_labels:\r\n    - __meta_kubernetes_service_name\r\n    target_label: job\r\n    replacement: ${1}\r\n  - target_label: endpoint\r\n    replacement: service\r\n- job_name: <namespace>/prometheus-external-promet-prometheus/0\r\n  honor_labels: false\r\n  kubernetes_sd_configs:\r\n  - role: endpoints\r\n    namespaces:\r\n      names:\r\n      - <namespace>\r\n  metrics_path: /metrics\r\n  relabel_configs:\r\n  - action: keep\r\n    source_labels:\r\n    - __meta_kubernetes_service_label_app\r\n    regex: prometheus-operator-prometheus\r\n  - action: keep\r\n    source_labels:\r\n    - __meta_kubernetes_service_label_release\r\n    regex: prometheus-external\r\n  - action: keep\r\n    source_labels:\r\n    - __meta_kubernetes_endpoint_port_name\r\n    regex: web\r\n  - source_labels:\r\n    - __meta_kubernetes_endpoint_address_target_kind\r\n    - __meta_kubernetes_endpoint_address_target_name\r\n    separator: ;\r\n    regex: Node;(.*)\r\n    replacement: ${1}\r\n    target_label: node\r\n  - source_labels:\r\n    - __meta_kubernetes_endpoint_address_target_kind\r\n    - __meta_kubernetes_endpoint_address_target_name\r\n    separator: ;\r\n    regex: Pod;(.*)\r\n    replacement: ${1}\r\n    target_label: pod\r\n  - source_labels:\r\n    - __meta_kubernetes_namespace\r\n    target_label: namespace\r\n  - source_labels:\r\n    - __meta_kubernetes_service_name\r\n    target_label: service\r\n  - source_labels:\r\n    - __meta_kubernetes_pod_name\r\n    target_label: pod\r\n  - source_labels:\r\n    - __meta_kubernetes_service_name\r\n    target_label: job\r\n    replacement: ${1}\r\n  - target_label: endpoint\r\n    replacement: web\r\n- consul_sd_configs:\r\n  - datacenter: <consul dc>\r\n    server: <loadbalancer pointing to multiple consul servers>:8500\r\n    token: <token>\r\n  job_name: Stats-test\r\n  relabel_configs:\r\n  - action: keep\r\n    regex: .*scrape-.*\r\n    source_labels:\r\n    - __meta_consul_tags\r\n  - replacement: ${1}:9273\r\n    source_labels:\r\n    - __meta_consul_address\r\n    target_label: __address__\r\nalerting:\r\n  alert_relabel_configs:\r\n  - action: labeldrop\r\n    regex: prometheus_replica\r\n  alertmanagers: []\r\n```\r\n\r\n* Logs:\r\n```\r\nlevel=info ts=2019-10-11T20:45:07.602Z caller=main.go:740 msg=\"Loading configuration file\" filename=/etc/prometheus/config_out/prometheus.env.yaml\r\nlevel=info ts=2019-10-11T20:45:07.604Z caller=kubernetes.go:192 component=\"discovery manager scrape\" discovery=k8s msg=\"Using pod service account via in-cluster config\"\r\nlevel=info ts=2019-10-11T20:45:07.620Z caller=main.go:768 msg=\"Completed loading of configuration file\" filename=/etc/prometheus/config_out/prometheus.env.yaml\r\nlevel=info ts=2019-10-11T20:45:07.620Z caller=main.go:740 msg=\"Loading configuration file\" filename=/etc/prometheus/config_out/prometheus.env.yaml\r\nlevel=info ts=2019-10-11T20:45:07.622Z caller=kubernetes.go:192 component=\"discovery manager scrape\" discovery=k8s msg=\"Using pod service account via in-cluster config\"\r\nlevel=error ts=2019-10-11T20:45:07.631Z caller=endpoints.go:131 component=\"discovery manager scrape\" discovery=k8s role=endpoint msg=\"endpoints informer unable to sync cache\"\r\nlevel=error ts=2019-10-11T20:45:07.633Z caller=consul.go:361 component=\"discovery manager scrape\" discovery=consul msg=\"Error refreshing service list\" err=\"Get http://<loadbalancer pointing to multiple consul servers>:8500/v1/catalog/services?dc=<consul dc>&stale=&wait=30000ms: context canceled\"\r\nlevel=info ts=2019-10-11T20:45:07.669Z caller=main.go:768 msg=\"Completed loading of configuration file\" filename=/etc/prometheus/config_out/prometheus.env.yaml\r\n```\r\n",
  "closed_at": "2019-10-18T09:48:52Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/2587585?v=4",
    "events_url": "https://api.github.com/users/simonpasquier/events{/privacy}",
    "followers_url": "https://api.github.com/users/simonpasquier/followers",
    "following_url": "https://api.github.com/users/simonpasquier/following{/other_user}",
    "gists_url": "https://api.github.com/users/simonpasquier/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/simonpasquier",
    "id": 2587585,
    "login": "simonpasquier",
    "node_id": "MDQ6VXNlcjI1ODc1ODU=",
    "organizations_url": "https://api.github.com/users/simonpasquier/orgs",
    "received_events_url": "https://api.github.com/users/simonpasquier/received_events",
    "repos_url": "https://api.github.com/users/simonpasquier/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/simonpasquier/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/simonpasquier/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/simonpasquier"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/prometheus/prometheus/issues/6131/comments",
  "created_at": "2019-10-11T21:26:36Z",
  "events_url": "https://api.github.com/repos/prometheus/prometheus/issues/6131/events",
  "html_url": "https://github.com/prometheus/prometheus/issues/6131",
  "id": 506064846,
  "labels": [],
  "labels_url": "https://api.github.com/repos/prometheus/prometheus/issues/6131/labels{/name}",
  "locked": true,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MDYwNjQ4NDY=",
  "number": 6131,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/prometheus/prometheus",
  "state": "closed",
  "title": "Prometheus cannot connect to Consul using consul_sd_configs",
  "updated_at": "2020-04-15T10:31:30Z",
  "url": "https://api.github.com/repos/prometheus/prometheus/issues/6131",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/9060865?v=4",
    "events_url": "https://api.github.com/users/ILoveYaToo/events{/privacy}",
    "followers_url": "https://api.github.com/users/ILoveYaToo/followers",
    "following_url": "https://api.github.com/users/ILoveYaToo/following{/other_user}",
    "gists_url": "https://api.github.com/users/ILoveYaToo/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/ILoveYaToo",
    "id": 9060865,
    "login": "ILoveYaToo",
    "node_id": "MDQ6VXNlcjkwNjA4NjU=",
    "organizations_url": "https://api.github.com/users/ILoveYaToo/orgs",
    "received_events_url": "https://api.github.com/users/ILoveYaToo/received_events",
    "repos_url": "https://api.github.com/users/ILoveYaToo/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/ILoveYaToo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ILoveYaToo/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/ILoveYaToo"
  }
}