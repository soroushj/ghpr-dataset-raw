{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "**Description**\r\n\r\nIn https://github.com/containerd/containerd/blob/master/runtime/v1/linux/proc/io.go#L124 , the `sameFile` variable is shared if `stdout` and `stderr` are equal.\r\n\r\nThis causes a race where one goroutine may close the descriptor before the other has finished writing to it. The error is returned from `io.CopyBuffer()` and ignored, so this failure is silent. It can be confirmed by logging the error with `log.G(ctx).WithError(err).Warn(\"error copying pipes\")`.\r\n\r\n**Steps to reproduce the issue:**\r\n1. Create a task with `cio.LogFile()` as the `cio.Creator` https://github.com/containerd/containerd/blob/master/cio/io.go#L271-L272\r\n2. Have task output to both `stdout`/`stderr`; I was using `sh -xc \"cat /file && md5sum file\"`\r\n3. Observe output logged to file.\r\n4. Repeat (in my environment, 5 is enough to get varying file sizes)\r\n\r\n**Describe the results you received:**\r\nStdout/stderr are randomly truncated.\r\n```\r\n-rw-r--r-- 1 root root 469 Mar 20 13:26 /var/lib/thepwagner/containers/8295d165-d4d4-47ea-ba75-1c0ba854f8ba/log\r\n-rw-r--r-- 1 root root 469 Mar 20 13:25 /var/lib/thepwagner/containers/b91158f8-58f7-4bca-927b-6e9d63afcde2/log\r\n-rw-r--r-- 1 root root 469 Mar 20 13:25 /var/lib/thepwagner/containers/bd07790f-b24f-4442-a447-62bb6bf21ef5/log\r\n-rw-r--r-- 1 root root 494 Mar 20 13:26 /var/lib/thepwagner/containers/ca55bd1b-ba5d-4f40-9a50-cb43366436f6/log\r\n-rw-r--r-- 1 root root 469 Mar 20 13:25 /var/lib/thepwagner/containers/fd2168aa-77f0-403e-832e-058047738274/log\r\n```\r\n\r\n```\r\ntime=\"2019-03-20T13:26:08.232853828-07:00\" level=warning msg=\"error copying pipes\" error=\"write /var/lib/thepwagner/containers/8295d165-d4d4-47ea-ba75-1c0ba854f8ba/log: file already closed\" runtime=io.containerd.runc.v1\r\n```\r\n\r\n**Describe the results you expected:**\r\nStdout/stderr are written in their entirety.\r\n\r\n\r\n**Output of `containerd --version`:**\r\n\r\n```\r\ncontainerd github.com/containerd/containerd v1.2.5.m bb71b10fd8f58240ca47fbb579b9d1028eea7c84.m\r\n```\r\n",
  "closed_at": "2019-04-01T20:36:50Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/749551?v=4",
    "events_url": "https://api.github.com/users/crosbymichael/events{/privacy}",
    "followers_url": "https://api.github.com/users/crosbymichael/followers",
    "following_url": "https://api.github.com/users/crosbymichael/following{/other_user}",
    "gists_url": "https://api.github.com/users/crosbymichael/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/crosbymichael",
    "id": 749551,
    "login": "crosbymichael",
    "node_id": "MDQ6VXNlcjc0OTU1MQ==",
    "organizations_url": "https://api.github.com/users/crosbymichael/orgs",
    "received_events_url": "https://api.github.com/users/crosbymichael/received_events",
    "repos_url": "https://api.github.com/users/crosbymichael/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/crosbymichael/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/crosbymichael/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/crosbymichael"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/containerd/containerd/issues/3118/comments",
  "created_at": "2019-03-20T20:41:44Z",
  "events_url": "https://api.github.com/repos/containerd/containerd/issues/3118/events",
  "html_url": "https://github.com/containerd/containerd/issues/3118",
  "id": 423462753,
  "labels": [],
  "labels_url": "https://api.github.com/repos/containerd/containerd/issues/3118/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU0MjM0NjI3NTM=",
  "number": 3118,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/containerd/containerd",
  "state": "closed",
  "title": "runtime/v1/linux/proc copyPipes with sameFile race",
  "updated_at": "2019-04-01T20:36:50Z",
  "url": "https://api.github.com/repos/containerd/containerd/issues/3118",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1559510?v=4",
    "events_url": "https://api.github.com/users/thepwagner/events{/privacy}",
    "followers_url": "https://api.github.com/users/thepwagner/followers",
    "following_url": "https://api.github.com/users/thepwagner/following{/other_user}",
    "gists_url": "https://api.github.com/users/thepwagner/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/thepwagner",
    "id": 1559510,
    "login": "thepwagner",
    "node_id": "MDQ6VXNlcjE1NTk1MTA=",
    "organizations_url": "https://api.github.com/users/thepwagner/orgs",
    "received_events_url": "https://api.github.com/users/thepwagner/received_events",
    "repos_url": "https://api.github.com/users/thepwagner/repos",
    "site_admin": true,
    "starred_url": "https://api.github.com/users/thepwagner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thepwagner/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/thepwagner"
  }
}