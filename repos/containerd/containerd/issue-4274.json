{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "<!--\r\nIf you are reporting a new issue, make sure that we do not have any duplicates\r\nalready open. You can ensure this by searching the issue list for this\r\nrepository. If there is a duplicate, please close your issue and add a comment\r\nto the existing issue instead.\r\n-->\r\n\r\n**Description**\r\n\r\npanic in shim is not logged\r\n\r\n<!--\r\nBriefly describe the problem you are having in a few paragraphs.\r\n-->\r\n\r\n**Steps to reproduce the issue:**\r\n* Checkout containerd/containerd@4e08c2de67ec514b5602eea47804d41dfeabdc72\r\n* Add the following changes:\r\n```diff\r\ndiff --git a/runtime/v2/shim/shim.go b/runtime/v2/shim/shim.go\r\nindex 026ebb4e..446c7354 100644\r\n--- a/runtime/v2/shim/shim.go\r\n+++ b/runtime/v2/shim/shim.go\r\n@@ -146,6 +146,10 @@ func setLogger(ctx context.Context, id string) error {\r\n \r\n // Run initializes and runs a shim server\r\n func Run(id string, initFunc Init, opts ...BinaryOpts) {\r\n+       go func() {\r\n+               time.Sleep(3 * time.Second)\r\n+               panic(\"test20200520\")\r\n+       }()\r\n        var config Config\r\n        for _, o := range opts {\r\n                o(&config)\r\n```\r\n\r\n* `sudo containerd -l debug`\r\n* `sudo ctr run -t --rm docker.io/library/alpine:latest foo`\r\n* Wait for 3 seconds\r\n\r\n**Describe the results you received:**\r\n\r\nClient log:\r\n```\r\n/ # ctr: rpc error: code = Unknown desc = ttrpc: closed: unknown\r\n```\r\n\r\nDaemon log:\r\n\r\n```\r\nDEBU[2020-05-20T18:10:21.227260443+09:00] stat snapshot                                 key=\"sha256:3e207b409db364b595ba862cdc12be96dcdad8e36c59a03b7b3b61c946a5741a\"\r\nDEBU[2020-05-20T18:10:21.231059892+09:00] prepare snapshot                              key=foo parent=\"sha256:3e207b409db364b595ba862cdc12be96dcdad8e36c59a03b7b3b61c946a5741a\"\r\nDEBU[2020-05-20T18:10:21.232886266+09:00] event published                               ns=default topic=/snapshot/prepare type=containerd.events.SnapshotPrepare\r\nDEBU[2020-05-20T18:10:21.239970957+09:00] get snapshot mounts                           key=foo\r\nDEBU[2020-05-20T18:10:21.257106464+09:00] event published                               ns=default topic=/containers/create type=containerd.events.ContainerCreate\r\nDEBU[2020-05-20T18:10:21.261141482+09:00] get snapshot mounts                           key=foo\r\ntime=\"2020-05-20T18:10:21.268935307+09:00\" level=info msg=\"starting signal loop\" namespace=default path=/run/containerd/io.containerd.runtime.v2.task/default/foo pid=3874\r\nDEBU[2020-05-20T18:10:21.296976405+09:00] garbage collected                             d=8.162005ms\r\nDEBU[2020-05-20T18:10:21.343554990+09:00] event forwarded                               ns=default topic=/tasks/create type=containerd.events.TaskCreate\r\nDEBU[2020-05-20T18:10:21.354678894+09:00] event forwarded                               ns=default topic=/tasks/start type=containerd.events.TaskStart\r\nINFO[2020-05-20T18:10:24.274182871+09:00] shim disconnected                             id=foo\r\nWARN[2020-05-20T18:10:24.274289627+09:00] cleaning up after shim disconnected           id=foo namespace=default\r\nINFO[2020-05-20T18:10:24.274326862+09:00] cleaning up dead shim                        \r\nDEBU[2020-05-20T18:10:24.277669022+09:00] remove snapshot                               key=foo\r\nDEBU[2020-05-20T18:10:24.279204938+09:00] event published                               ns=default topic=/snapshot/remove type=containerd.events.SnapshotRemove\r\nDEBU[2020-05-20T18:10:24.280867012+09:00] event published                               ns=default topic=/containers/delete type=containerd.events.ContainerDelete\r\nWARN[2020-05-20T18:10:24.404555888+09:00] cleanup warnings time=\"2020-05-20T18:10:24+09:00\" level=info msg=\"starting signal loop\" namespace=default pid=3928 \r\nDEBU[2020-05-20T18:10:24.404788417+09:00] event published                               ns=default topic=/tasks/exit type=containerd.events.TaskExit\r\nDEBU[2020-05-20T18:10:24.404848793+09:00] event published                               ns=default topic=/tasks/delete type=containerd.events.TaskDelete\r\nDEBU[2020-05-20T18:10:24.445476058+09:00] schedule snapshotter cleanup                  snapshotter=overlayfs\r\nDEBU[2020-05-20T18:10:24.453806808+09:00] removed snapshot                              key=default/47/foo snapshotter=overlayfs\r\nDEBU[2020-05-20T18:10:24.454828832+09:00] snapshot garbage collected                    d=9.25067ms snapshotter=overlayfs\r\nDEBU[2020-05-20T18:10:24.455422398+09:00] garbage collected                             d=1.364699ms\r\n```\r\n\r\n`panic(\"test20200520\")` is logged in nowhere.\r\n\r\n**Describe the results you expected:**\r\n\r\n`panic(\"test20200520\")` should be logged\r\n",
  "closed_at": "2020-10-26T17:03:39Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/9248427?v=4",
    "events_url": "https://api.github.com/users/AkihiroSuda/events{/privacy}",
    "followers_url": "https://api.github.com/users/AkihiroSuda/followers",
    "following_url": "https://api.github.com/users/AkihiroSuda/following{/other_user}",
    "gists_url": "https://api.github.com/users/AkihiroSuda/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/AkihiroSuda",
    "id": 9248427,
    "login": "AkihiroSuda",
    "node_id": "MDQ6VXNlcjkyNDg0Mjc=",
    "organizations_url": "https://api.github.com/users/AkihiroSuda/orgs",
    "received_events_url": "https://api.github.com/users/AkihiroSuda/received_events",
    "repos_url": "https://api.github.com/users/AkihiroSuda/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/AkihiroSuda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AkihiroSuda/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/AkihiroSuda"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/containerd/containerd/issues/4274/comments",
  "created_at": "2020-05-20T09:11:51Z",
  "events_url": "https://api.github.com/repos/containerd/containerd/issues/4274/events",
  "html_url": "https://github.com/containerd/containerd/issues/4274",
  "id": 621596807,
  "labels": [
    {
      "color": "FF8C94",
      "default": false,
      "description": null,
      "id": 347599646,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNDc1OTk2NDY=",
      "url": "https://api.github.com/repos/containerd/containerd/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/containerd/containerd/issues/4274/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2MjE1OTY4MDc=",
  "number": 4274,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/containerd/containerd",
  "state": "closed",
  "title": "panic in shim is not logged",
  "updated_at": "2020-10-26T17:03:39Z",
  "url": "https://api.github.com/repos/containerd/containerd/issues/4274",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/9248427?v=4",
    "events_url": "https://api.github.com/users/AkihiroSuda/events{/privacy}",
    "followers_url": "https://api.github.com/users/AkihiroSuda/followers",
    "following_url": "https://api.github.com/users/AkihiroSuda/following{/other_user}",
    "gists_url": "https://api.github.com/users/AkihiroSuda/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/AkihiroSuda",
    "id": 9248427,
    "login": "AkihiroSuda",
    "node_id": "MDQ6VXNlcjkyNDg0Mjc=",
    "organizations_url": "https://api.github.com/users/AkihiroSuda/orgs",
    "received_events_url": "https://api.github.com/users/AkihiroSuda/received_events",
    "repos_url": "https://api.github.com/users/AkihiroSuda/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/AkihiroSuda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AkihiroSuda/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/AkihiroSuda"
  }
}