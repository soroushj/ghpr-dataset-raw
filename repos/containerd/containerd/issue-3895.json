{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "This was found and debugged in firecracker-containerd, [the issue there has more details+logs](https://github.com/firecracker-microvm/firecracker-containerd/issues/363). We are currently using the 1.3 branch but it appears to be present in master and older versions that support the runc v2 multishim too.\r\n\r\nThe runc v2 shim seems to have an issue that makes it possible for `platform.Close()` to be called when the shim is not done servicing containers and to be called multiple times. It happens when:\r\n1. The shim starts and a single task is created+deleted, resulting in [these lines that call `platform.Close()` to be executed](https://github.com/containerd/containerd/blob/ff48f57fc83a8c44cf4ad5d672424a98ba37ded6/runtime/v2/runc/v2/service.go#L351-L366).\r\n1. Another task is created before the shim receives a shutdown call, meaning [`Shutdown` returns early and the shim continues to service containers](https://github.com/containerd/containerd/blob/ff48f57fc83a8c44cf4ad5d672424a98ba37ded6/runtime/v2/runc/v2/service.go#L595-L600).\r\n1. Any further tasks will no longer be able to use the platform functionality as it has been closed already.\r\n\r\nThis also creates problems when further containers are deleted because, due to the implementation of the platform console code on linux, calling `platform.Close()` multiple times results in [the same already-closed FD value to be closed again](https://github.com/containerd/containerd/blob/9b5581cc9c5bb4e9f4e47606ba883234167b1c23/vendor/github.com/containerd/console/console_linux.go#L154). If that FD value was reused after the first close, `platform.Close()` will be closing a random FD in the process (which is what firecracker-containerd was rarely observing as `EBADF` errors from an unrelated call to `os.RemoveAll` happening elsewhere in the process). The fact that closing the console multiple times allows this is probably a separate bug that should also be addressed; I will open a separate issue in the console repo for it.\r\n\r\nThis problem was especially noticeable in firecracker-containerd because we wrap around the runc v2 shim and support a flag that tells the shim to run continuously even when there are no containers left (waiting instead for a separate custom `StopVM` call).\r\n\r\nI have a fix to call `platform.Close()` only when the shim's context is canceled in `Shutdown`, just creating this issue to reference there.",
  "closed_at": "2019-12-19T16:54:27Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/749551?v=4",
    "events_url": "https://api.github.com/users/crosbymichael/events{/privacy}",
    "followers_url": "https://api.github.com/users/crosbymichael/followers",
    "following_url": "https://api.github.com/users/crosbymichael/following{/other_user}",
    "gists_url": "https://api.github.com/users/crosbymichael/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/crosbymichael",
    "id": 749551,
    "login": "crosbymichael",
    "node_id": "MDQ6VXNlcjc0OTU1MQ==",
    "organizations_url": "https://api.github.com/users/crosbymichael/orgs",
    "received_events_url": "https://api.github.com/users/crosbymichael/received_events",
    "repos_url": "https://api.github.com/users/crosbymichael/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/crosbymichael/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/crosbymichael/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/crosbymichael"
  },
  "comments": 0,
  "comments_url": "https://api.github.com/repos/containerd/containerd/issues/3895/comments",
  "created_at": "2019-12-17T20:46:01Z",
  "events_url": "https://api.github.com/repos/containerd/containerd/issues/3895/events",
  "html_url": "https://github.com/containerd/containerd/issues/3895",
  "id": 539301007,
  "labels": [
    {
      "color": "FF8C94",
      "default": false,
      "description": null,
      "id": 347599646,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNDc1OTk2NDY=",
      "url": "https://api.github.com/repos/containerd/containerd/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/containerd/containerd/issues/3895/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1MzkzMDEwMDc=",
  "number": 3895,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/containerd/containerd",
  "state": "closed",
  "title": "runtime: runc v2 shim closes platform prematurely and multiple times",
  "updated_at": "2019-12-19T16:54:27Z",
  "url": "https://api.github.com/repos/containerd/containerd/issues/3895",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/30126853?v=4",
    "events_url": "https://api.github.com/users/sipsma/events{/privacy}",
    "followers_url": "https://api.github.com/users/sipsma/followers",
    "following_url": "https://api.github.com/users/sipsma/following{/other_user}",
    "gists_url": "https://api.github.com/users/sipsma/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/sipsma",
    "id": 30126853,
    "login": "sipsma",
    "node_id": "MDQ6VXNlcjMwMTI2ODUz",
    "organizations_url": "https://api.github.com/users/sipsma/orgs",
    "received_events_url": "https://api.github.com/users/sipsma/received_events",
    "repos_url": "https://api.github.com/users/sipsma/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/sipsma/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sipsma/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/sipsma"
  }
}