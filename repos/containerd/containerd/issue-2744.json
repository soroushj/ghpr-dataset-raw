{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "The main issue is simply that containers will stay stuck in Terminating or in the case of `Init` containers in kubernetes complete but  just stay in the `Init` phase. What that causes is the pod will never transition to it's main container when that occurs (basically as if the init container ran forever). For the `Terminating` problem the pod just hangs around till it is force deleted.\r\n\r\nAn example of a pod that was stuck in terminating\r\n```\r\nOct 18 13:06:04 kube-dal12-cree61ddf4b2934227a8b166434d7403f8-w2 kubelet.service[1747]: I1018 13:06:04.146167    1747 kubelet.go:1853] SyncLoop (DELETE, \"api\"): \"hubperf-0_default(e6166efd-d2b0-11e8-b9e2-261fec5456d5)\"\r\nOct 18 13:06:04 kube-dal12-cree61ddf4b2934227a8b166434d7403f8-w2 kubelet.service[1747]: I1018 13:06:04.146415    1747 kuberuntime_container.go:553] Killing container \"containerd://fb3c811af15cf95ed631baca4b07960c223994449584f75468e80bf1b4f012f4\" with 30 second grace period\r\nOct 18 13:06:04 kube-dal12-cree61ddf4b2934227a8b166434d7403f8-w2 systemd[1]: Starting Logrotate Cronjob...\r\nOct 18 13:06:04 kube-dal12-cree61ddf4b2934227a8b166434d7403f8-w2 systemd[1]: Started Logrotate Cronjob.\r\nOct 18 13:06:04 kube-dal12-cree61ddf4b2934227a8b166434d7403f8-w2 kubelet.service[1747]: E1018 13:06:04.373608    1747 upgradeaware.go:310] Error proxying data from client to backend: readfrom tcp 10.185.18.132:31409->10.185.18.132:10010: write tcp 10.185.18.132:31409->10.185.18.132:10010: write: broken pipe\r\nOct 18 13:06:38 kube-dal12-cree61ddf4b2934227a8b166434d7403f8-w2 kubelet.service[1747]: I1018 13:06:38.523728    1747 kubelet.go:1853] SyncLoop (DELETE, \"api\"): \"hubperf-0_default(e6166efd-d2b0-11e8-b9e2-261fec5456d5)\"\r\n```\r\n\r\nIt looks like potentially the kubelet can have problems talking to containerd that might result in this?\r\n```\r\nOct 18 13:06:04 kube-dal12-cree61ddf4b2934227a8b166434d7403f8-w2 kubelet.service[1747]: E1018 13:06:04.373608    1747 upgradeaware.go:310] Error proxying data from client to backend: readfrom tcp 10.185.18.132:31409->10.185.18.132:10010: write tcp 10.185.18.132:31409->10.185.18.132:10010: write: broken pipe\r\n```\r\n\r\n\r\nThe other we saw was an init container run fully but stay stuck in a `Init:0/1`. I suspect containerd never fully terminated the init container even though the container exited and therefore the pod stayed in this sate.\r\n```\r\nkube-system     ibm-master-proxy-kcq4x                                            0/1       Init:0/1            0          15h       10.116.131.16    10.116.131.16   <none>\r\n```\r\nYaml for the pod is the following\r\n```\r\napiVersion: extensions/v1beta1\r\nkind: DaemonSet\r\nmetadata:\r\n  annotations:\r\n    kubectl.kubernetes.io/last-applied-configuration: |\r\n      {\"apiVersion\":\"apps/v1\",\"kind\":\"DaemonSet\",\"metadata\":{\"annotations\":{},\"labels\":{\"k8s-app\":\"ibm-master-proxy\"},\"name\":\"ibm-master-proxy\",\"namespace\":\"kube-system\"},\"spec\":{\"selector\":{\"matchLabels\":{\"k8s-app\":\"ibm-master-proxy\"}},\"template\":{\"metadata\":{\"annotations\":{\"scheduler.alpha.kubernetes.io/critical-pod\":\"\",\"scheduler.alpha.kubernetes.io/tolerations\":\"[{\\\"key\\\":\\\"CriticalAddonsOnly\\\", \\\"operator\\\":\\\"Exists\\\"}]\"},\"labels\":{\"k8s-app\":\"ibm-master-proxy\"}},\"spec\":{\"affinity\":{\"nodeAffinity\":{\"requiredDuringSchedulingIgnoredDuringExecution\":{\"nodeSelectorTerms\":[{\"matchExpressions\":[{\"key\":\"ibm-cloud.kubernetes.io/ha-worker\",\"operator\":\"DoesNotExist\"}]}]}}},\"containers\":[{\"command\":[\"/bin/sh\",\"-c\",\"mkdir /cache \\u0026\\u0026 cp /scripts/applyinterfaces.sh /cache \\u0026\\u0026 chmod +x /cache/applyinterfaces.sh \\u0026\\u0026 /cache/applyinterfaces.sh \\u0026\\u0026 /sbin/syslogd -O /proc/1/fd/1  \\u0026\\u0026 haproxy -f /usr/local/etc/haproxy/haproxy.cfg -V -dR\"],\"image\":\"registry.ng.bluemix.net/armada-master/haproxy:1.8.12-alpine\",\"imagePullPolicy\":\"IfNotPresent\",\"livenessProbe\":{\"failureThreshold\":6,\"httpGet\":{\"host\":\"172.20.0.1\",\"path\":\"/healthz\",\"port\":2040,\"scheme\":\"HTTPS\"},\"initialDelaySeconds\":10,\"periodSeconds\":60,\"successThreshold\":1,\"timeoutSeconds\":10},\"name\":\"ibm-master-proxy\",\"ports\":[{\"containerPort\":2040,\"hostPort\":2040,\"name\":\"apiserver\",\"protocol\":\"TCP\"},{\"containerPort\":2041,\"hostPort\":2041,\"name\":\"etcd\",\"protocol\":\"TCP\"}],\"resources\":{\"limits\":{\"cpu\":\"300m\",\"memory\":\"512M\"},\"requests\":{\"cpu\":\"25m\",\"memory\":\"32M\"}},\"securityContext\":{\"privileged\":true},\"volumeMounts\":[{\"mountPath\":\"/usr/local/etc/haproxy\",\"name\":\"etc-config\",\"readOnly\":true},{\"mountPath\":\"/scripts\",\"name\":\"ibm-network-interfaces\"},{\"mountPath\":\"/host\",\"name\":\"host-path\"}]}],\"hostNetwork\":true,\"priorityClassName\":\"system-cluster-critical\",\"tolerations\":[{\"operator\":\"Exists\"}],\"volumes\":[{\"configMap\":{\"name\":\"ibm-master-proxy-config\"},\"name\":\"etc-config\"},{\"configMap\":{\"name\":\"ibm-network-interfaces\"},\"name\":\"ibm-network-interfaces\"},{\"hostPath\":{\"path\":\"/\"},\"name\":\"host-path\"}]}}}}\r\n  creationTimestamp: 2018-10-24T18:26:10Z\r\n  generation: 1\r\n  labels:\r\n    k8s-app: ibm-master-proxy\r\n  name: ibm-master-proxy\r\n  namespace: kube-system\r\n  resourceVersion: \"79560\"\r\n  selfLink: /apis/extensions/v1beta1/namespaces/kube-system/daemonsets/ibm-master-proxy\r\n  uid: 47a5e5ae-d7ba-11e8-9128-ca4f5830ba32\r\nspec:\r\n  revisionHistoryLimit: 10\r\n  selector:\r\n    matchLabels:\r\n      k8s-app: ibm-master-proxy\r\n  template:\r\n    metadata:\r\n      annotations:\r\n        scheduler.alpha.kubernetes.io/critical-pod: \"\"\r\n        scheduler.alpha.kubernetes.io/tolerations: '[{\"key\":\"CriticalAddonsOnly\",\r\n          \"operator\":\"Exists\"}]'\r\n      creationTimestamp: null\r\n      labels:\r\n        k8s-app: ibm-master-proxy\r\n    spec:\r\n      affinity:\r\n        nodeAffinity:\r\n          requiredDuringSchedulingIgnoredDuringExecution:\r\n            nodeSelectorTerms:\r\n            - matchExpressions:\r\n              - key: ibm-cloud.kubernetes.io/ha-worker\r\n                operator: DoesNotExist\r\n      containers:\r\n      - command:\r\n        - /bin/sh\r\n        - -c\r\n        - mkdir /cache && cp /scripts/applyinterfaces.sh /cache && chmod +x /cache/applyinterfaces.sh\r\n          && /cache/applyinterfaces.sh && /sbin/syslogd -O /proc/1/fd/1  && haproxy\r\n          -f /usr/local/etc/haproxy/haproxy.cfg -V -dR\r\n        image: registry.ng.bluemix.net/armada-master/haproxy:1.8.12-alpine\r\n        imagePullPolicy: IfNotPresent\r\n        livenessProbe:\r\n          failureThreshold: 6\r\n          httpGet:\r\n            host: 172.20.0.1\r\n            path: /healthz\r\n            port: 2040\r\n            scheme: HTTPS\r\n          initialDelaySeconds: 10\r\n          periodSeconds: 60\r\n          successThreshold: 1\r\n          timeoutSeconds: 10\r\n        name: ibm-master-proxy\r\n        ports:\r\n        - containerPort: 2040\r\n          hostPort: 2040\r\n          name: apiserver\r\n          protocol: TCP\r\n        - containerPort: 2041\r\n          hostPort: 2041\r\n          name: etcd\r\n          protocol: TCP\r\n        resources:\r\n          limits:\r\n            cpu: 300m\r\n            memory: 512M\r\n          requests:\r\n            cpu: 25m\r\n            memory: 32M\r\n        securityContext:\r\n          privileged: true\r\n        terminationMessagePath: /dev/termination-log\r\n        terminationMessagePolicy: File\r\n        volumeMounts:\r\n        - mountPath: /usr/local/etc/haproxy\r\n          name: etc-config\r\n          readOnly: true\r\n        - mountPath: /scripts\r\n          name: ibm-network-interfaces\r\n        - mountPath: /host\r\n          name: host-path\r\n      dnsPolicy: ClusterFirst\r\n      hostNetwork: true\r\n      priorityClassName: system-cluster-critical\r\n      restartPolicy: Always\r\n      schedulerName: default-scheduler\r\n      securityContext: {}\r\n      terminationGracePeriodSeconds: 30\r\n      tolerations:\r\n      - operator: Exists\r\n      volumes:\r\n      - configMap:\r\n          defaultMode: 420\r\n          name: ibm-master-proxy-config\r\n        name: etc-config\r\n      - configMap:\r\n          defaultMode: 420\r\n          name: ibm-network-interfaces\r\n        name: ibm-network-interfaces\r\n      - hostPath:\r\n          path: /\r\n          type: \"\"\r\n        name: host-path\r\n  templateGeneration: 1\r\n  updateStrategy:\r\n    rollingUpdate:\r\n      maxUnavailable: 1\r\n    type: RollingUpdate\r\n```",
  "closed_at": "2018-12-07T18:37:51Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/749551?v=4",
    "events_url": "https://api.github.com/users/crosbymichael/events{/privacy}",
    "followers_url": "https://api.github.com/users/crosbymichael/followers",
    "following_url": "https://api.github.com/users/crosbymichael/following{/other_user}",
    "gists_url": "https://api.github.com/users/crosbymichael/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/crosbymichael",
    "id": 749551,
    "login": "crosbymichael",
    "node_id": "MDQ6VXNlcjc0OTU1MQ==",
    "organizations_url": "https://api.github.com/users/crosbymichael/orgs",
    "received_events_url": "https://api.github.com/users/crosbymichael/received_events",
    "repos_url": "https://api.github.com/users/crosbymichael/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/crosbymichael/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/crosbymichael/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/crosbymichael"
  },
  "comments": 58,
  "comments_url": "https://api.github.com/repos/containerd/containerd/issues/2744/comments",
  "created_at": "2018-10-24T20:42:44Z",
  "events_url": "https://api.github.com/repos/containerd/containerd/issues/2744/events",
  "html_url": "https://github.com/containerd/containerd/issues/2744",
  "id": 373668915,
  "labels": [
    {
      "color": "FF8C94",
      "default": false,
      "description": null,
      "id": 347599646,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNDc1OTk2NDY=",
      "url": "https://api.github.com/repos/containerd/containerd/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/containerd/containerd/issues/2744/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2019-02-14T19:13:38Z",
    "closed_issues": 18,
    "created_at": "2018-10-26T16:45:59Z",
    "creator": {
      "avatar_url": "https://avatars1.githubusercontent.com/u/749551?v=4",
      "events_url": "https://api.github.com/users/crosbymichael/events{/privacy}",
      "followers_url": "https://api.github.com/users/crosbymichael/followers",
      "following_url": "https://api.github.com/users/crosbymichael/following{/other_user}",
      "gists_url": "https://api.github.com/users/crosbymichael/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/crosbymichael",
      "id": 749551,
      "login": "crosbymichael",
      "node_id": "MDQ6VXNlcjc0OTU1MQ==",
      "organizations_url": "https://api.github.com/users/crosbymichael/orgs",
      "received_events_url": "https://api.github.com/users/crosbymichael/received_events",
      "repos_url": "https://api.github.com/users/crosbymichael/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/crosbymichael/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/crosbymichael/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/crosbymichael"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/containerd/containerd/milestone/24",
    "id": 3772067,
    "labels_url": "https://api.github.com/repos/containerd/containerd/milestones/24/labels",
    "node_id": "MDk6TWlsZXN0b25lMzc3MjA2Nw==",
    "number": 24,
    "open_issues": 0,
    "state": "closed",
    "title": "1.2.1",
    "updated_at": "2019-02-14T19:13:38Z",
    "url": "https://api.github.com/repos/containerd/containerd/milestones/24"
  },
  "node_id": "MDU6SXNzdWUzNzM2Njg5MTU=",
  "number": 2744,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/containerd/containerd",
  "state": "closed",
  "title": "Containers failing to terminate and complete in containerd 1.1.4 and 1.2",
  "updated_at": "2019-01-12T04:50:18Z",
  "url": "https://api.github.com/repos/containerd/containerd/issues/2744",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/7716924?v=4",
    "events_url": "https://api.github.com/users/relyt0925/events{/privacy}",
    "followers_url": "https://api.github.com/users/relyt0925/followers",
    "following_url": "https://api.github.com/users/relyt0925/following{/other_user}",
    "gists_url": "https://api.github.com/users/relyt0925/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/relyt0925",
    "id": 7716924,
    "login": "relyt0925",
    "node_id": "MDQ6VXNlcjc3MTY5MjQ=",
    "organizations_url": "https://api.github.com/users/relyt0925/orgs",
    "received_events_url": "https://api.github.com/users/relyt0925/received_events",
    "repos_url": "https://api.github.com/users/relyt0925/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/relyt0925/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/relyt0925/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/relyt0925"
  }
}