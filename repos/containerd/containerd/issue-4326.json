{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "MEMBER",
  "body": "<!--\r\nIf you are reporting a new issue, make sure that we do not have any duplicates\r\nalready open. You can ensure this by searching the issue list for this\r\nrepository. If there is a duplicate, please close your issue and add a comment\r\nto the existing issue instead.\r\n-->\r\n\r\n**Description**\r\n\r\n<!--\r\nBriefly describe the problem you are having in a few paragraphs.\r\n-->\r\n\r\nshim v2 `io.containerd.runc.v2` doesn't pass Moby test `TestContainerStartOnDaemonRestart`: https://github.com/moby/moby/blob/88241b99893cce78a7734a19b38d468d0dcb6156/integration/container/daemon_linux_test.go#L20-L68 (https://github.com/moby/moby/issues/36145)\r\n\r\n\r\n**Steps to reproduce the issue:**\r\n1. Checkout moby/moby@88241b99893cce78a7734a19b38d468d0dcb6156\r\n2. Apply the following patch to ensure that the daemon uses shim v2. This step is not needed on the cgroup v2 hosts, as cgroup v2 mode always uses shim v2.\r\n```patch\r\ndiff --git a/daemon/daemon_unix.go b/daemon/daemon_unix.go\r\nindex 1a577276ef..1fdb924f77 100644\r\n--- a/daemon/daemon_unix.go\r\n+++ b/daemon/daemon_unix.go\r\n@@ -1757,7 +1757,7 @@ func (daemon *Daemon) setupSeccompProfile() error {\r\n }\r\n \r\n func (daemon *Daemon) useShimV2() bool {\r\n-       return cgroups.IsCgroup2UnifiedMode()\r\n+       return true\r\n }\r\n \r\n // RawSysInfo returns *sysinfo.SysInfo .\r\n```\r\n3. `DOCKER_BUILD_ARGS=\"--build-arg CONTAINERD_COMMIT=705b8527d4945db601954246972674a25ed49347\" TESTFLAGS=\"-test.run TestContainerStartOnDaemonRestart\"  TEST_SKIP_INTEGRATION_CLI=1  make test-integration`\r\n\r\n**Describe the results you received:**\r\n\r\n```\r\n--- FAIL: TestContainerStartOnDaemonRestart (2.37s)\r\n    daemon_linux_test.go:67: assertion failed: error is not nil: Error response from daemon: OCI runtime create failed: container with id exists: 2585935e9bb8c9e5678466e4c7d001082abeacc6945d5c00cdc8f1cb713ebdd0: unknown: failed to start test container\r\nFAIL\r\n```\r\n\r\n**Describe the results you expected:**\r\n\r\nThe test should succeed\r\n\r\n\r\n**Output of `containerd --version`:**\r\n705b8527d4945db601954246972674a25ed49347 (master as of June 16).\r\n\r\nThe issue happens with v1.3.4 as well.\r\n\r\n**Any other relevant information:**\r\nMoby PR https://github.com/moby/moby/pull/41115 is blocked due to this.\r\n\r\n",
  "closed_at": "2020-06-17T13:23:55Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1397980?v=4",
    "events_url": "https://api.github.com/users/estesp/events{/privacy}",
    "followers_url": "https://api.github.com/users/estesp/followers",
    "following_url": "https://api.github.com/users/estesp/following{/other_user}",
    "gists_url": "https://api.github.com/users/estesp/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/estesp",
    "id": 1397980,
    "login": "estesp",
    "node_id": "MDQ6VXNlcjEzOTc5ODA=",
    "organizations_url": "https://api.github.com/users/estesp/orgs",
    "received_events_url": "https://api.github.com/users/estesp/received_events",
    "repos_url": "https://api.github.com/users/estesp/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/estesp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/estesp/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/estesp"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/containerd/containerd/issues/4326/comments",
  "created_at": "2020-06-16T08:12:52Z",
  "events_url": "https://api.github.com/repos/containerd/containerd/issues/4326/events",
  "html_url": "https://github.com/containerd/containerd/issues/4326",
  "id": 639464706,
  "labels": [
    {
      "color": "FF8C94",
      "default": false,
      "description": null,
      "id": 347599646,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNDc1OTk2NDY=",
      "url": "https://api.github.com/repos/containerd/containerd/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/containerd/containerd/issues/4326/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2020-08-24T22:37:21Z",
    "closed_issues": 37,
    "created_at": "2019-08-19T17:11:06Z",
    "creator": {
      "avatar_url": "https://avatars2.githubusercontent.com/u/169601?v=4",
      "events_url": "https://api.github.com/users/dmcgowan/events{/privacy}",
      "followers_url": "https://api.github.com/users/dmcgowan/followers",
      "following_url": "https://api.github.com/users/dmcgowan/following{/other_user}",
      "gists_url": "https://api.github.com/users/dmcgowan/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/dmcgowan",
      "id": 169601,
      "login": "dmcgowan",
      "node_id": "MDQ6VXNlcjE2OTYwMQ==",
      "organizations_url": "https://api.github.com/users/dmcgowan/orgs",
      "received_events_url": "https://api.github.com/users/dmcgowan/received_events",
      "repos_url": "https://api.github.com/users/dmcgowan/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/dmcgowan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dmcgowan/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/dmcgowan"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/containerd/containerd/milestone/27",
    "id": 4586308,
    "labels_url": "https://api.github.com/repos/containerd/containerd/milestones/27/labels",
    "node_id": "MDk6TWlsZXN0b25lNDU4NjMwOA==",
    "number": 27,
    "open_issues": 0,
    "state": "closed",
    "title": "1.4",
    "updated_at": "2020-08-24T22:37:21Z",
    "url": "https://api.github.com/repos/containerd/containerd/milestones/27"
  },
  "node_id": "MDU6SXNzdWU2Mzk0NjQ3MDY=",
  "number": 4326,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/containerd/containerd",
  "state": "closed",
  "title": "shim v2 doesn't pass Moby test `TestContainerStartOnDaemonRestart` (because shim v2 uses hard-coded RuncRoot)",
  "updated_at": "2020-06-17T13:23:55Z",
  "url": "https://api.github.com/repos/containerd/containerd/issues/4326",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/9248427?v=4",
    "events_url": "https://api.github.com/users/AkihiroSuda/events{/privacy}",
    "followers_url": "https://api.github.com/users/AkihiroSuda/followers",
    "following_url": "https://api.github.com/users/AkihiroSuda/following{/other_user}",
    "gists_url": "https://api.github.com/users/AkihiroSuda/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/AkihiroSuda",
    "id": 9248427,
    "login": "AkihiroSuda",
    "node_id": "MDQ6VXNlcjkyNDg0Mjc=",
    "organizations_url": "https://api.github.com/users/AkihiroSuda/orgs",
    "received_events_url": "https://api.github.com/users/AkihiroSuda/received_events",
    "repos_url": "https://api.github.com/users/AkihiroSuda/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/AkihiroSuda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AkihiroSuda/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/AkihiroSuda"
  }
}