{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "containerd version: 1.1.0\r\n\r\n## Reproducing\r\n\r\nNote that we demonstrate this with `ctr` for ease of use, but we first observed this when using the containerd Go API.\r\n\r\n```\r\n$ ctr -a /path/to/containerd.sock images pull docker.io/library/redis:alpine # pull an image\r\n$ ctr -a /path/to/containerd.sock container create docker.io/library/redis:alpine boo # creat a container\r\n$ ctr -a /path/to/containerd.sock task start boo\r\n```\r\n\r\nNext, exec a process with stdin in the container\r\n\r\n```\r\necho hi | ctr -a /path/to/containerd.sock task exec boo /bin/cat --exec-id aaaahhhh\r\n```\r\n\r\nMost of the time this will correctly echo \"hi\" but the process will hang.\r\n\r\n## Expected behaviour\r\n\r\n1. I see \"hi\" on stdout\r\n2. The process exits successfully\r\n\r\n## Details\r\n\r\nAfter some investigation, we've seen that the client side of containerd will create FIFOs for stdin, stdout & stderr, the path to these FIFO's is then passed on to the containerd server. The containerd server will check if the FIFOs exist, and will create the FIFOs if they don't. containerd will then [open](https://github.com/containerd/containerd/blob/0b0b41298a82fc342bf8350b38f8b33aebd67816/runtime/linux/proc/exec.go#L170) the stdin FIFOs in WRONLY mode (even if it's already opened on the client side).\r\n\r\n\r\nWhen the stdin buffer is exhuasted, we see the EOF event causes the write side of the client pipe to close. However, from the man7 docs on [pipes](http://man7.org/linux/man-pages/man7/pipe.7.html), all of the open fds for a particular pipe opened in write mode need to be closed before the read end of the pipe would receive an EOF on a subsequent read. So, the pipe opened by the server in WRONLY mode would cause a hang when /bin/cat is reading from stdin (a.k.a the read end of the pipe).\r\n\r\n## Note\r\n\r\nWe intend to start working on a PR to address in the next few days.\r\n\r\nDiscovered by @BooleanCat and @yulianedyalkova\r\n",
  "closed_at": "2019-07-26T21:13:03Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1397980?v=4",
    "events_url": "https://api.github.com/users/estesp/events{/privacy}",
    "followers_url": "https://api.github.com/users/estesp/followers",
    "following_url": "https://api.github.com/users/estesp/following{/other_user}",
    "gists_url": "https://api.github.com/users/estesp/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/estesp",
    "id": 1397980,
    "login": "estesp",
    "node_id": "MDQ6VXNlcjEzOTc5ODA=",
    "organizations_url": "https://api.github.com/users/estesp/orgs",
    "received_events_url": "https://api.github.com/users/estesp/received_events",
    "repos_url": "https://api.github.com/users/estesp/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/estesp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/estesp/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/estesp"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/containerd/containerd/issues/2439/comments",
  "created_at": "2018-07-05T14:59:18Z",
  "events_url": "https://api.github.com/repos/containerd/containerd/issues/2439/events",
  "html_url": "https://github.com/containerd/containerd/issues/2439",
  "id": 338611562,
  "labels": [],
  "labels_url": "https://api.github.com/repos/containerd/containerd/issues/2439/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMzg2MTE1NjI=",
  "number": 2439,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/containerd/containerd",
  "state": "closed",
  "title": "Execing a process blocks when stdin has content (most of the time)",
  "updated_at": "2019-07-26T21:13:03Z",
  "url": "https://api.github.com/repos/containerd/containerd/issues/2439",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/16281740?v=4",
    "events_url": "https://api.github.com/users/BooleanCat/events{/privacy}",
    "followers_url": "https://api.github.com/users/BooleanCat/followers",
    "following_url": "https://api.github.com/users/BooleanCat/following{/other_user}",
    "gists_url": "https://api.github.com/users/BooleanCat/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/BooleanCat",
    "id": 16281740,
    "login": "BooleanCat",
    "node_id": "MDQ6VXNlcjE2MjgxNzQw",
    "organizations_url": "https://api.github.com/users/BooleanCat/orgs",
    "received_events_url": "https://api.github.com/users/BooleanCat/received_events",
    "repos_url": "https://api.github.com/users/BooleanCat/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/BooleanCat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/BooleanCat/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/BooleanCat"
  }
}