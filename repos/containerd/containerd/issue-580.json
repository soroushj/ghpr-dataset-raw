{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "This is closely related to https://github.com/docker/docker/issues/19728 :  `journald restart crashes Docker `\r\n\r\ndaemon and containerd's stderr point to the same socket if their logs are managed by journald:\r\n```bash\r\n# ls /proc/31602//fd/2 -al\r\nlrwx------ 1 root root 64 Feb 28 15:47 /proc/31602//fd/2 -> socket:[6992842]\r\n# ls /proc/31609/fd/2 -al\r\nlrwx------ 1 root root 64 Feb 28 15:50 /proc/31609/fd/2 -> socket:[6992842]\r\n```\r\n\r\nrestart journald service, daemon will ignore SIGPIPE and some docker operation will work properly, while all docker logs are missing, because it's trying to write its log into a broken pipe. Containerd for now still get SIGPIPE, and may get killed.  The wired thing is that docker did not  start a new containerd.\r\n\r\n```bash\r\n# systemctl restart systemd-journald.service\r\n# docker ps\r\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\r\n# ps -ef | grep docker\r\nroot      9486  4081  0 16:06 pts/2    00:00:00 grep --color=auto docker\r\nroot     31602     1  0 15:47 ?        00:00:00 /usr/bin/docker daemon -D --live-restore\r\nroot     31609 31602  0 15:47 ?        00:00:00 docker-containerd -l /var/run/docker/libcontainerd/docker-containerd.sock --runtime docker-runc --start-timeout 2m --state-dir /var/run/docker/libcontainerd/containerd --debug --metrics-interval=0\r\n# docker run -tid busybox sleep 10000\r\nafdccea8dfb5483ed082547c97293f33b652fc1cacdee23247642b56b2bcee24\r\n# docker rm -f afdccea8dfb5483ed082547c97293f33b652fc1cacdee23247642b56b2bcee24\r\n\r\n\r\n```\r\n\r\nafter journald restart, docker and containerd are still there and docker run works fine. but docker rm will block forever.  ps in another bash, I get this:\r\n\r\n```bash\r\n# ps -ef | grep docker\r\nroot     11306  4081  0 16:09 pts/2    00:00:00 docker rm -f afdccea8dfb5483ed082547c97293f33b652fc1cacdee23247642b56b2bcee24\r\nroot     11376 19869  0 16:09 pts/1    00:00:00 grep --color=auto docker\r\nroot     31602     1  0 15:47 ?        00:00:00 /usr/bin/docker daemon -D --live-restore\r\n```\r\n\r\ncontainerd got killed, and never start again. As all logs are missing, it will be hard to debug this.\r\n\r\nps. docker version is 1.11.2 but have https://github.com/docker/docker/pull/22460 : `Ignore SIGPIPE events` backported.\r\n\r\n------\r\nmaybe containerd need to ignore SIGPIPE too. but missing all the docker logs is kind of severe problem.\r\n\r\nnot sure if  there is a better way for docker and containerd to deal with these broken pipe errors?\r\n\r\nping @crosbymichael  @LK4D4  @jwhonce @coolljt0725 ",
  "closed_at": "2017-05-31T11:59:13Z",
  "closed_by": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/6415670?v=4",
    "events_url": "https://api.github.com/users/hqhq/events{/privacy}",
    "followers_url": "https://api.github.com/users/hqhq/followers",
    "following_url": "https://api.github.com/users/hqhq/following{/other_user}",
    "gists_url": "https://api.github.com/users/hqhq/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/hqhq",
    "id": 6415670,
    "login": "hqhq",
    "node_id": "MDQ6VXNlcjY0MTU2NzA=",
    "organizations_url": "https://api.github.com/users/hqhq/orgs",
    "received_events_url": "https://api.github.com/users/hqhq/received_events",
    "repos_url": "https://api.github.com/users/hqhq/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/hqhq/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hqhq/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/hqhq"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/containerd/containerd/issues/580/comments",
  "created_at": "2017-02-28T08:51:39Z",
  "events_url": "https://api.github.com/repos/containerd/containerd/issues/580/events",
  "html_url": "https://github.com/containerd/containerd/issues/580",
  "id": 210723197,
  "labels": [
    {
      "color": "0e8a16",
      "default": false,
      "description": null,
      "id": 500316785,
      "name": "v0.2.x",
      "node_id": "MDU6TGFiZWw1MDAzMTY3ODU=",
      "url": "https://api.github.com/repos/containerd/containerd/labels/v0.2.x"
    }
  ],
  "labels_url": "https://api.github.com/repos/containerd/containerd/issues/580/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUyMTA3MjMxOTc=",
  "number": 580,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/containerd/containerd",
  "state": "closed",
  "title": "journald restart crashes containerd",
  "updated_at": "2017-05-31T11:59:13Z",
  "url": "https://api.github.com/repos/containerd/containerd/issues/580",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/2840248?v=4",
    "events_url": "https://api.github.com/users/x1022as/events{/privacy}",
    "followers_url": "https://api.github.com/users/x1022as/followers",
    "following_url": "https://api.github.com/users/x1022as/following{/other_user}",
    "gists_url": "https://api.github.com/users/x1022as/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/x1022as",
    "id": 2840248,
    "login": "x1022as",
    "node_id": "MDQ6VXNlcjI4NDAyNDg=",
    "organizations_url": "https://api.github.com/users/x1022as/orgs",
    "received_events_url": "https://api.github.com/users/x1022as/received_events",
    "repos_url": "https://api.github.com/users/x1022as/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/x1022as/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/x1022as/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/x1022as"
  }
}