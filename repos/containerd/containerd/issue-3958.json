{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Description**\r\n\r\nVery rarely somewhen between creating a container and starting it, the `containerd-shim` fails miserably with a segmentation fault error. When trying to start it, the clients will receive a `ttrpc: closed: unknown` error.\r\n\r\nThe difficulty with debugging this problem is that it is very difficult to reproduce. Once it appears on a machine, it doesn't reappear for 10-12 hours (or unless some specific conditions happen).\r\n\r\nThe problem itself looks like some race condition or incorrect error handling down the road.\r\n\r\n**Steps to reproduce the issue:**\r\n1. Run containers in a loop.\r\n2. Pray for the issue to appear.\r\n\r\n**Describe the results you received:**\r\n\r\n`/var/log/syslog` with `containerd-shim` debugging turned on:\r\n```containerd[1751]: time=\"2020-01-11T18:17:27.634188430Z\" level=info msg=\"shim containerd-shim started\" address=\"/containerd-shim/moby/56c0c998e1d7d4b002fa2f1697188657eadc53135ceac2eb438bca6e96a18cb9/shim.sock\" debug=true pid=18533\r\ncontainerd[1751]: time=\"2020-01-11T18:17:27Z\" level=debug msg=\"registering ttrpc server\"\r\ncontainerd[1751]: time=\"2020-01-11T18:17:27Z\" level=debug msg=\"serving api on unix socket\" socket=\"[inherited from parent]\"\r\ncontainerd[1751]: panic: runtime error: invalid memory address or nil pointer dereference\r\ncontainerd[1751]: [signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x459367]\r\ncontainerd[1751]: goroutine 12 [running]:\r\ncontainerd[1751]: strings.(*Builder).WriteString(...)\r\ncontainerd[1751]: #011/usr/local/go/src/strings/builder.go:122\r\ncontainerd[1751]: strings.Join(0xc000073a40, 0x2, 0x2, 0x73bdf4, 0x1, 0x1, 0xc000092400)\r\ncontainerd[1751]: #011/usr/local/go/src/strings/strings.go:439 +0x145\r\ncontainerd[1751]: path/filepath.join(0xc000073a40, 0x2, 0x2, 0x0, 0x0)\r\ncontainerd[1751]: #011/usr/local/go/src/path/filepath/path_unix.go:45 +0xa7\r\ncontainerd[1751]: path/filepath.Join(...)\r\ncontainerd[1751]: #011/usr/local/go/src/path/filepath/path.go:210\r\ncontainerd[1751]: github.com/containerd/containerd/runtime/v1/shim.shouldKillAllOnExit(0x0, 0x74, 0x0, 0x0, 0x0)\r\ncontainerd[1751]: #011/go/src/github.com/containerd/containerd/runtime/v1/shim/service.go:546 +0x92\r\ncontainerd[1751]: github.com/containerd/containerd/runtime/v1/shim.(*Service).checkProcesses(0xc000010240, 0xbf7ea22e2d95bbda, 0x435a6125, 0x9d6b60, 0x486c, 0x0)\r\ncontainerd[1751]: #011/go/src/github.com/containerd/containerd/runtime/v1/shim/service.go:514 +0x56\r\ncontainerd[1751]: github.com/containerd/containerd/runtime/v1/shim.(*Service).processExits(0xc000010240)\r\ncontainerd[1751]: #011/go/src/github.com/containerd/containerd/runtime/v1/shim/service.go:498 +0xbe\r\ncontainerd[1751]: created by github.com/containerd/containerd/runtime/v1/shim.NewService\r\ncontainerd[1751]: #011/go/src/github.com/containerd/containerd/runtime/v1/shim/service.go:92 +0x4be\r\ncontainerd[1751]: time=\"2020-01-11T18:17:28.799258075Z\" level=error msg=\"not found\"\r\ncontainerd[1751]: time=\"2020-01-11T18:17:28.799251177Z\" level=info msg=\"shim reaped\" id=56c0c998e1d7d4b002fa2f1697188657eadc53135ceac2eb438bca6e96a18cb9\r\ncontainerd[1751]: time=\"2020-01-11T18:17:28.799309696Z\" level=warning msg=\"cleaning up after killed shim\" id=56c0c998e1d7d4b002fa2f1697188657eadc53135ceac2eb438bca6e96a18cb9 namespace=moby\r\ndockerd[1761]: time=\"2020-01-11T18:17:28.800822192Z\" level=error msg=\"failed to delete task after fail start\" container=56c0c998e1d7d4b002fa2f1697188657eadc53135ceac2eb438bca6e96a18cb9 error=\"not found\" module=libcontainerd namespace=moby\r\ncontainerd[1751]: time=\"2020-01-11T18:17:28.844152523Z\" level=debug msg=\"event published\" ns=moby topic=\"/containers/delete\" type=containerd.events.ContainerDelete\r\ncontainerd[1751]: time=\"2020-01-11T18:17:28.924443319Z\" level=debug msg=\"event published\" ns=moby topic=\"/tasks/exit\" type=containerd.events.TaskExit\r\ndockerd[1761]: time=\"2020-01-11T18:17:28.924855540Z\" level=debug msg=event module=libcontainerd namespace=moby topic=/tasks/exit\r\ncontainerd[1751]: time=\"2020-01-11T18:17:28.928954904Z\" level=debug msg=\"event published\" ns=moby topic=\"/tasks/delete\" type=containerd.events.TaskDelete\r\ndockerd[1761]: time=\"2020-01-11T18:17:28.932231844Z\" level=debug msg=event module=libcontainerd namespace=moby topic=/tasks/delete\r\ndockerd[1761]: time=\"2020-01-11T18:17:28.932264274Z\" level=info msg=\"ignoring event\" module=libcontainerd namespace=moby topic=/tasks/delete type=\"*events.TaskDelete\"\r\ndockerd[1761]: time=\"2020-01-11T18:17:29.000495852Z\" level=error msg=\"56c0c998e1d7d4b002fa2f1697188657eadc53135ceac2eb438bca6e96a18cb9 cleanup: failed to delete container from containerd: no such container\"\r\ndockerd[1761]: time=\"2020-01-11T18:17:29.000556322Z\" level=error msg=\"Handler for POST /v1.35/containers/56c0c998e1d7d4b002fa2f1697188657eadc53135ceac2eb438bca6e96a18cb9/start returned error: ttrpc: closed: unknown\"\r\n```\r\n\r\n\r\n**Describe the results you expected:**\r\n\r\nContainers should be created and started correctly.\r\n\r\n**Output of `containerd --version`:**\r\n\r\n```\r\ncontainerd containerd.io 1.2.10 b34a5c8af56e510852c35414db4c1f4fa6172339\r\n```\r\n\r\n**Any other relevant information:**\r\n\r\nDocker server version:\r\n```\r\nServer Version: 19.03.5\r\n```",
  "closed_at": "2020-03-30T21:03:57Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/9248427?v=4",
    "events_url": "https://api.github.com/users/AkihiroSuda/events{/privacy}",
    "followers_url": "https://api.github.com/users/AkihiroSuda/followers",
    "following_url": "https://api.github.com/users/AkihiroSuda/following{/other_user}",
    "gists_url": "https://api.github.com/users/AkihiroSuda/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/AkihiroSuda",
    "id": 9248427,
    "login": "AkihiroSuda",
    "node_id": "MDQ6VXNlcjkyNDg0Mjc=",
    "organizations_url": "https://api.github.com/users/AkihiroSuda/orgs",
    "received_events_url": "https://api.github.com/users/AkihiroSuda/received_events",
    "repos_url": "https://api.github.com/users/AkihiroSuda/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/AkihiroSuda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AkihiroSuda/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/AkihiroSuda"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/containerd/containerd/issues/3958/comments",
  "created_at": "2020-01-13T10:18:16Z",
  "events_url": "https://api.github.com/repos/containerd/containerd/issues/3958/events",
  "html_url": "https://github.com/containerd/containerd/issues/3958",
  "id": 548830304,
  "labels": [
    {
      "color": "FF8C94",
      "default": false,
      "description": null,
      "id": 347599646,
      "name": "kind/bug",
      "node_id": "MDU6TGFiZWwzNDc1OTk2NDY=",
      "url": "https://api.github.com/repos/containerd/containerd/labels/kind/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/containerd/containerd/issues/3958/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1NDg4MzAzMDQ=",
  "number": 3958,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/containerd/containerd",
  "state": "closed",
  "title": "SIGSEGV when starting containerd-shim",
  "updated_at": "2020-03-30T21:03:57Z",
  "url": "https://api.github.com/repos/containerd/containerd/issues/3958",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/1861709?v=4",
    "events_url": "https://api.github.com/users/maciej-gol/events{/privacy}",
    "followers_url": "https://api.github.com/users/maciej-gol/followers",
    "following_url": "https://api.github.com/users/maciej-gol/following{/other_user}",
    "gists_url": "https://api.github.com/users/maciej-gol/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/maciej-gol",
    "id": 1861709,
    "login": "maciej-gol",
    "node_id": "MDQ6VXNlcjE4NjE3MDk=",
    "organizations_url": "https://api.github.com/users/maciej-gol/orgs",
    "received_events_url": "https://api.github.com/users/maciej-gol/received_events",
    "repos_url": "https://api.github.com/users/maciej-gol/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/maciej-gol/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/maciej-gol/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/maciej-gol"
  }
}