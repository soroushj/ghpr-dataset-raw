{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "**Description**\r\nContainerd does not release inodes in /run/containerd/fifo, if containers are created and removed in a loop via the ctr cli. This leads to 100% inode usage on the /run file system over time which prevents containerd to create new containers.\r\n\r\n**Steps to reproduce the issue:**\r\n1. The described behavior was noticed during a stress test which executed the following commands in a loop and stored the results as csv. The csv output was monitored for failures. In case of an exit code not equal to 0, up to 10 retries are executed before giving up that iteration.\r\n```\r\nctr run -d docker.io/library/alpine:latest test.${iteration} sleep 60\r\nsleep 0.1\r\nctr tasks pause test.${iteration}\r\nsleep 0.1\r\nctr tasks resume test.${iteration}\r\nsleep 0.1\r\nctr tasks kill -s SIGKILL test.${iteration}\r\nsleep 0.1\r\nctr container delete test.${iteration}\r\n```\r\n\r\n2. During the test execution system metics (based on /proc file system and `df` command) were collected every 10 minutes and stored as csv.\r\n\r\n3. After multiple failed iterations appeared in the log, the csv files were analyzed.\r\n\r\n**Describe the results you received:**\r\nAfter running the loop for 2 days and 17 min (126.064 container iterations) containerd could no longer start new containers. \r\n\r\nThe error reported by `ctr` was:\r\n```\r\n126065,1529869634,ctr:,OCI,runtime,create,failed:,no,space,left,on,device:,unknown,real,0.134,user,0.004,sys,0.024,1,ctr run -d docker.io/library/alpine:latest test.126065 sleep 60\r\n```\r\n\r\nDuring the first 126.064 cycles only in iteration 87631 and 116278 the following error occurred and could be resolved by the first retry (probably a timing problem).\r\n\r\n```\r\n87631,1529817767,real,0.292,user,0.016,sys,0.012,0,ctr run -d docker.io/library/alpine:latest test.87631 sleep 60\r\n87631,1529817768,real,0.073,user,0.016,sys,0.000,0,ctr tasks pause test.87631\r\n87631,1529817768,real,0.248,user,0.008,sys,0.008,0,ctr tasks resume test.87631\r\n87631,1529817768,real,0.367,user,0.012,sys,0.004,0,ctr tasks kill -s SIGKILL test.87631\r\n87631,1529817769,time=\"2018-06-24T05:22:49Z\",level=error,msg=\"failed,to,delete,container,\"test.87631\"\",error=\"cannot,delete,a,non,stopped,container:,{running,0,0001-01-01,00:00:00,+0000,UTC}\",ctr:,cannot,delete,a,non,stopped,container:,{running,0,0001-01-01,00:00:00,+0000,UTC},real,0.299,user,0.004,sys,0.012,1,ctr container delete test.87631\r\n87631,1529817770,real,0.774,user,0.012,sys,0.004,0,ctr container delete test.87631\r\n```\r\n\r\nThe analysis of /run/containerd showed the following:\r\n```\r\n# created 126074 folders\r\nroot@kube-tor01-crcb1c41560b7245269aa7262e7882c27f-w2:/run/containerd/fifo# ls -l | wc -l\r\n126074\r\n# each folder seem to contain pipes to already deleted containers\r\nroot@kube-tor01-crcb1c41560b7245269aa7262e7882c27f-w2:/run/containerd/fifo# ls -lah 000001714\r\ntotal 0\r\ndrwx------      2 root root  100 Jun 23 08:07 .\r\ndrwx------ 126075 root root 2.5M Jun 24 20:09 ..\r\nprwx------      1 root root    0 Jun 23 08:07 test.32583-stderr\r\nprwx------      1 root root    0 Jun 23 08:07 test.32583-stdin\r\nprwx------      1 root root    0 Jun 23 08:07 test.32583-stdout\r\n```\r\nIt looks like /run/containerd/fifo contains pipes to containers and they were not removed completely.\r\n\r\nBy checking the filesystem usage on /run I could see that there is space left, but no inodes were available any longer. \r\n```\r\nroot@kube-tor01-crcb1c41560b7245269aa7262e7882c27f-w2:/run/containerd/fifo# df -i /run\r\nFilesystem     Inodes  IUsed IFree IUse% Mounted on\r\ntmpfs          505078 505066    12  100% /run\r\nroot@kube-tor01-crcb1c41560b7245269aa7262e7882c27f-w2:/run/containerd/fifo# df -h /run\r\nFilesystem      Size  Used Avail Use% Mounted on\r\ntmpfs           395M   41M  354M  11% /run\r\n```\r\n\r\nPlotting the file system usage of /run shows, that inodes were not released.\r\n\r\n![run_filesystem_usage](https://user-images.githubusercontent.com/40577406/41899473-cfa48f4e-792c-11e8-8b52-88b4266d12b4.png)\r\n\r\nTo verify the problem I rebooted the system which cleaned the /run tmpfs and explicitly deleted the task before deleting the container. An additional folder remains containing manual-stderr, manual-stdin and manual-stdout.\r\n\r\n```\r\n$ ls -lah /run/containerd/fifo/ | wc -l\r\n28\r\n$ ctr run -d docker.io/library/alpine:latest manual sleep 60\r\n$ ctr tasks pause manual\r\n$ ctr tasks resume manual\r\n$ ctr tasks kill -s SIGKILL manual\r\n$ ctr tasks delete manual\r\n$ ctr container delete manual\r\n$ ls -lah /run/containerd/fifo/ | wc -l\r\n29\r\n```\r\n\r\nThose old folders can be removed by root afterwards manually, which release 4 inodes per folder:\r\n```\r\n$ df -i . && ls | wc && rm -rf 497171102 && df -i . && ls | wc\r\nFilesystem     Inodes IUsed  IFree IUse% Mounted on\r\ntmpfs          505078   864 504214    1% /run\r\n     24      24     240\r\nFilesystem     Inodes IUsed  IFree IUse% Mounted on\r\ntmpfs          505078   860 504218    1% /run\r\n     23      23     230\r\n```\r\n\r\n**Describe the results you expected:**\r\nContainerd should not show any degradation over time and should not fail to create new containers.\r\n\r\n**Output of `containerd --version`:**\r\n\r\n\r\n```\r\n$ ctr version\r\nClient:\r\n  Version:  v1.1.0\r\n  Revision: 209a7fc3e4a32ef71a8c7b50c68fc8398415badf\r\n\r\nServer:\r\n  Version:  v1.1.0\r\n  Revision: 209a7fc3e4a32ef71a8c7b50c68fc8398415badf\r\n\r\n$ containerd --version\r\ncontainerd github.com/containerd/containerd v1.1.0 209a7fc3e4a32ef71a8c7b50c68fc8398415badf\r\n\r\n```\r\n\r\n\r\n---------------------------------------------------\r\nBUG REPORT INFORMATION\r\n---------------------------------------------------\r\nUbuntu and Linux Kernel version\r\n```\r\n$ uname -a\r\nLinux kube-tor01-xxx-w2.cloud.ibm 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n$ cat /etc/os-release \r\nNAME=\"Ubuntu\"\r\nVERSION=\"16.04.4 LTS (Xenial Xerus)\"\r\nID=ubuntu\r\nID_LIKE=debian\r\nPRETTY_NAME=\"Ubuntu 16.04.4 LTS\"\r\nVERSION_ID=\"16.04\"\r\nHOME_URL=\"http://www.ubuntu.com/\"\r\nSUPPORT_URL=\"http://help.ubuntu.com/\"\r\nBUG_REPORT_URL=\"http://bugs.launchpad.net/ubuntu/\"\r\nVERSION_CODENAME=xenial\r\nUBUNTU_CODENAME=xenial\r\n```\r\n\r\nThe system holds 4 GB of RAM, the swap space is disabled.",
  "closed_at": "2018-06-27T12:46:19Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/749551?v=4",
    "events_url": "https://api.github.com/users/crosbymichael/events{/privacy}",
    "followers_url": "https://api.github.com/users/crosbymichael/followers",
    "following_url": "https://api.github.com/users/crosbymichael/following{/other_user}",
    "gists_url": "https://api.github.com/users/crosbymichael/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/crosbymichael",
    "id": 749551,
    "login": "crosbymichael",
    "node_id": "MDQ6VXNlcjc0OTU1MQ==",
    "organizations_url": "https://api.github.com/users/crosbymichael/orgs",
    "received_events_url": "https://api.github.com/users/crosbymichael/received_events",
    "repos_url": "https://api.github.com/users/crosbymichael/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/crosbymichael/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/crosbymichael/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/crosbymichael"
  },
  "comments": 4,
  "comments_url": "https://api.github.com/repos/containerd/containerd/issues/2421/comments",
  "created_at": "2018-06-26T08:44:04Z",
  "events_url": "https://api.github.com/repos/containerd/containerd/issues/2421/events",
  "html_url": "https://github.com/containerd/containerd/issues/2421",
  "id": 335716769,
  "labels": [],
  "labels_url": "https://api.github.com/repos/containerd/containerd/issues/2421/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMzU3MTY3Njk=",
  "number": 2421,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/containerd/containerd",
  "state": "closed",
  "title": "Creation and removal of containers via ctr CLI does not release inodes in /run/containerd/fifo",
  "updated_at": "2018-12-11T18:55:52Z",
  "url": "https://api.github.com/repos/containerd/containerd/issues/2421",
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/40577406?v=4",
    "events_url": "https://api.github.com/users/konrad-ohms/events{/privacy}",
    "followers_url": "https://api.github.com/users/konrad-ohms/followers",
    "following_url": "https://api.github.com/users/konrad-ohms/following{/other_user}",
    "gists_url": "https://api.github.com/users/konrad-ohms/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/konrad-ohms",
    "id": 40577406,
    "login": "konrad-ohms",
    "node_id": "MDQ6VXNlcjQwNTc3NDA2",
    "organizations_url": "https://api.github.com/users/konrad-ohms/orgs",
    "received_events_url": "https://api.github.com/users/konrad-ohms/received_events",
    "repos_url": "https://api.github.com/users/konrad-ohms/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/konrad-ohms/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/konrad-ohms/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/konrad-ohms"
  }
}