{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "## Requirement - what kind of business use case are you trying to solve?\r\n\r\nWe are using Jaeger with Ingester.  On Collector, we are setting SPAN_STORAGE_TYPE=kafka.  We would like to tune Kafka configurations for performance.  The default Kafka Samara config is resulting in over 150% CPU usage on Kafka broker for just 40k spans per minute.\r\n\r\n## Problem - what in Jaeger blocks you from solving the requirement?\r\nJaeger provided these producer settings\r\n```\r\n      --kafka.producer.authentication string          Authentication type used to authenticate with kafka cluster. e.g. none, kerberos, tls (default \"none\")\r\n      --kafka.producer.brokers string                 The comma-separated list of kafka brokers. i.e. '127.0.0.1:9092,0.0.0:1234' (default \"127.0.0.1:9092\")\r\n      --kafka.producer.compression string             (experimental) Type of compression (none, gzip, snappy, lz4, zstd) to use on messages (default \"none\")\r\n      --kafka.producer.compression-level int          (experimental) compression level to use on messages. gzip = 1-9 (default = 6), snappy = none, lz4 = 1-17 (default = 9), zstd = -131072 - 22 (default = 3)\r\n      --kafka.producer.encoding string                Encoding of spans (\"json\" or \"protobuf\") sent to kafka. (default \"protobuf\")\r\n      --kafka.producer.kerberos.config-file string    Path to Kerberos configuration. i.e /etc/krb5.conf (default \"/etc/krb5.conf\")\r\n      --kafka.producer.kerberos.keytab-file string    Path to keytab file. i.e /etc/security/kafka.keytab (default \"/etc/security/kafka.keytab\")\r\n      --kafka.producer.kerberos.password string       The Kerberos password used for authenticate with KDC\r\n      --kafka.producer.kerberos.realm string          Kerberos realm\r\n      --kafka.producer.kerberos.service-name string   Kerberos service name (default \"kafka\")\r\n      --kafka.producer.kerberos.use-keytab            Use of keytab instead of password, if this is true, keytab file will be used instead of password\r\n      --kafka.producer.kerberos.username string       The Kerberos username used for authenticate with KDC\r\n      --kafka.producer.protocol-version string        Kafka protocol version - must be supported by kafka server\r\n      --kafka.producer.required-acks string           (experimental) Required kafka broker acknowledgement. i.e. noack, local, all (default \"local\")\r\n      --kafka.producer.tls.ca string                  Path to the TLS CA for the Kafka connection\r\n      --kafka.producer.tls.cert string                Path to the TLS Certificate for the Kafka connection\r\n      --kafka.producer.tls.key string                 Path to the TLS Key for the Kafka connection\r\n      --kafka.producer.topic string    \r\n```\r\nSetting `--kafka.producer.required-acks` to `noack` helps a little, reducing CPU usage on Kafka broker by 8%.  We experimented setting github.com/jaegertracing/jaeger/pkg/kafka/producer/config.go with the following parameters.  It resulted in 10 times improvement in Kafka broker CPU usage.\r\n```\r\n        saramaConfig.Producer.Flush.Bytes = 128000\r\n        saramaConfig.Producer.Flush.Frequency = time.Duration(1 * time.Second)\r\n```\r\n\r\n## Proposal - what do you suggest to solve the problem or improve the existing situation?\r\nAt a minimum, Jaeger should expose the above 2 settings to the command line.  Ideally Jaeger should expose all producer/consumer configurations.\r\nGiven that each Kafka client has it's own naming for configurations.  I would suggest Jaeger use Kafka's official parameter names for it's client.  For example, `saramaConfig.Producer.Flush.Bytes` should be exposed as `batch.size` and `saramaConfig.Producer.Flush.Frequency` should be exposed as `linger.ms`\r\n<!-- It's ok if you don't have one. -->\r\n\r\n## Any open questions to address\r\n\r\n<!-- Questions that should be answered before proceeding with implementation. -->\r\n",
  "closed_at": "2020-01-31T23:50:15Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/3523016?v=4",
    "events_url": "https://api.github.com/users/yurishkuro/events{/privacy}",
    "followers_url": "https://api.github.com/users/yurishkuro/followers",
    "following_url": "https://api.github.com/users/yurishkuro/following{/other_user}",
    "gists_url": "https://api.github.com/users/yurishkuro/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/yurishkuro",
    "id": 3523016,
    "login": "yurishkuro",
    "node_id": "MDQ6VXNlcjM1MjMwMTY=",
    "organizations_url": "https://api.github.com/users/yurishkuro/orgs",
    "received_events_url": "https://api.github.com/users/yurishkuro/received_events",
    "repos_url": "https://api.github.com/users/yurishkuro/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/yurishkuro/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yurishkuro/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/yurishkuro"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/jaegertracing/jaeger/issues/2037/comments",
  "created_at": "2020-01-24T22:50:49Z",
  "events_url": "https://api.github.com/repos/jaegertracing/jaeger/issues/2037/events",
  "html_url": "https://github.com/jaegertracing/jaeger/issues/2037",
  "id": 554991435,
  "labels": [
    {
      "color": "ededed",
      "default": false,
      "description": null,
      "id": 1740680315,
      "name": "needs-triage",
      "node_id": "MDU6TGFiZWwxNzQwNjgwMzE1",
      "url": "https://api.github.com/repos/jaegertracing/jaeger/labels/needs-triage"
    }
  ],
  "labels_url": "https://api.github.com/repos/jaegertracing/jaeger/issues/2037/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU1NTQ5OTE0MzU=",
  "number": 2037,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/jaegertracing/jaeger",
  "state": "closed",
  "title": "Expose Samara Kafka producer/consumer configurations to command line.",
  "updated_at": "2020-01-31T23:50:15Z",
  "url": "https://api.github.com/repos/jaegertracing/jaeger/issues/2037",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/49722990?v=4",
    "events_url": "https://api.github.com/users/apm-opentt/events{/privacy}",
    "followers_url": "https://api.github.com/users/apm-opentt/followers",
    "following_url": "https://api.github.com/users/apm-opentt/following{/other_user}",
    "gists_url": "https://api.github.com/users/apm-opentt/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/apm-opentt",
    "id": 49722990,
    "login": "apm-opentt",
    "node_id": "MDQ6VXNlcjQ5NzIyOTkw",
    "organizations_url": "https://api.github.com/users/apm-opentt/orgs",
    "received_events_url": "https://api.github.com/users/apm-opentt/received_events",
    "repos_url": "https://api.github.com/users/apm-opentt/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/apm-opentt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/apm-opentt/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/apm-opentt"
  }
}