{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "## Requirement - what kind of business use case are you trying to solve?\r\n\r\nIngester should not fall over when partition is reassigned to another consumer.\r\n\r\n## Problem - what in Jaeger blocks you from solving the requirement?\r\n\r\nThere is an existing `jaeger-spans` queue (using protobuf encoder), with 6 partitions across 6 kafka nodes.\r\n\r\nWhen running with multiple ingesters (v1.8.0), each ingester in turn will crash with logs that look like the following:\r\n\r\n```{\"level\":\"info\",\"ts\":1542640177.67382,\"caller\":\"healthcheck/handler.go:99\",\"msg\":\"Health Check server started\",\"http-port\":14270,\"status\":\"unavailable\"}\r\n{\"level\":\"info\",\"ts\":1542640177.7420416,\"caller\":\"cassandra/factory.go:92\",\"msg\":\"Cassandra archive storage configuration is empty, skipping\"}\r\n{\"level\":\"info\",\"ts\":1542640177.7505202,\"caller\":\"ingester/main.go:100\",\"msg\":\"Registering metrics handler with HTTP server\",\"route\":\"/metrics\"}\r\n{\"level\":\"info\",\"ts\":1542640177.7506182,\"caller\":\"ingester/main.go:106\",\"msg\":\"Starting HTTP server\",\"http-port\":14271}\r\n{\"level\":\"info\",\"ts\":1542640177.7506611,\"caller\":\"healthcheck/handler.go:133\",\"msg\":\"Health Check state change\",\"status\":\"ready\"}\r\n{\"level\":\"info\",\"ts\":1542640177.7506845,\"caller\":\"consumer/consumer.go:76\",\"msg\":\"Starting main loop\"}\r\n{\"level\":\"info\",\"ts\":1542640221.4679706,\"caller\":\"consumer/consumer.go:154\",\"msg\":\"Starting error handler\",\"partition\":4}\r\n{\"level\":\"info\",\"ts\":1542640221.4680126,\"caller\":\"consumer/consumer.go:154\",\"msg\":\"Starting error handler\",\"partition\":5}\r\n{\"level\":\"info\",\"ts\":1542640221.4679477,\"caller\":\"consumer/consumer.go:105\",\"msg\":\"Starting message handler\",\"partition\":5}\r\n{\"level\":\"info\",\"ts\":1542640221.4680393,\"caller\":\"consumer/consumer.go:105\",\"msg\":\"Starting message handler\",\"partition\":4}\r\n{\"level\":\"info\",\"ts\":1542640221.4846787,\"caller\":\"consumer/processor_factory.go:62\",\"msg\":\"Creating new processors\",\"partition\":5}\r\n{\"level\":\"info\",\"ts\":1542640221.4894123,\"caller\":\"consumer/processor_factory.go:62\",\"msg\":\"Creating new processors\",\"partition\":4}\r\n{\"level\":\"info\",\"ts\":1542640227.298487,\"caller\":\"consumer/consumer.go:163\",\"msg\":\"Finished handling errors\",\"partition\":5}\r\n{\"level\":\"info\",\"ts\":1542640227.3106964,\"caller\":\"consumer/consumer.go:163\",\"msg\":\"Finished handling errors\",\"partition\":4}\r\n{\"level\":\"info\",\"ts\":1542640227.3175905,\"caller\":\"consumer/consumer.go:123\",\"msg\":\"Message channel closed. \",\"partition\":4}\r\n{\"level\":\"info\",\"ts\":1542640227.3269305,\"caller\":\"consumer/consumer.go:123\",\"msg\":\"Message channel closed. \",\"partition\":5}\r\n{\"level\":\"info\",\"ts\":1542640227.9139948,\"caller\":\"processor/parallel_processor.go:78\",\"msg\":\"Completed shutdown of processor goroutines\"}\r\n{\"level\":\"info\",\"ts\":1542640227.9140894,\"caller\":\"consumer/consumer.go:147\",\"msg\":\"Closing partition consumer\",\"partition\":5}\r\n{\"level\":\"info\",\"ts\":1542640227.9141328,\"caller\":\"consumer/consumer.go:150\",\"msg\":\"Closed partition consumer\",\"partition\":5}\r\npanic: counter cannot decrease in value\r\n\r\ngoroutine 895 [running]:\r\ngithub.com/jaegertracing/jaeger/vendor/github.com/prometheus/client_golang/prometheus.(*counter).Add(0xc000790600, 0xbff0000000000000)\r\n\t/home/travis/gopath/src/github.com/jaegertracing/jaeger/vendor/github.com/prometheus/client_golang/prometheus/counter.go:71 +0xa3\r\ngithub.com/jaegertracing/jaeger/vendor/github.com/uber/jaeger-lib/metrics/prometheus.(*counter).Inc(0xc0006b42a0, 0xffffffffffffffff)\r\n\t/home/travis/gopath/src/github.com/jaegertracing/jaeger/vendor/github.com/uber/jaeger-lib/metrics/prometheus/factory.go:183 +0x46\r\ngithub.com/jaegertracing/jaeger/cmd/ingester/app/consumer.(*Consumer).handleMessages(0xc0004c4300, 0xf08c60, 0xc00054e630)\r\n\t/home/travis/gopath/src/github.com/jaegertracing/jaeger/cmd/ingester/app/consumer/consumer.go:124 +0x893\r\ncreated by github.com/jaegertracing/jaeger/cmd/ingester/app/consumer.(*Consumer).Start.func1\r\n\t/home/travis/gopath/src/github.com/jaegertracing/jaeger/cmd/ingester/app/consumer/consumer.go:87 +0xbd\r\n```\r\n\r\nThis results in ingesters never being able to handle any spans, as each ingester only runs for a short time before crashing and being restarted.\r\n\r\n## Proposal - what do you suggest to solve the problem or improve the existing situation?\r\n\r\nn/a\r\n\r\n## Any open questions to address\r\n\r\nn/a",
  "closed_at": "2019-04-23T15:53:20Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/3523016?v=4",
    "events_url": "https://api.github.com/users/yurishkuro/events{/privacy}",
    "followers_url": "https://api.github.com/users/yurishkuro/followers",
    "following_url": "https://api.github.com/users/yurishkuro/following{/other_user}",
    "gists_url": "https://api.github.com/users/yurishkuro/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/yurishkuro",
    "id": 3523016,
    "login": "yurishkuro",
    "node_id": "MDQ6VXNlcjM1MjMwMTY=",
    "organizations_url": "https://api.github.com/users/yurishkuro/orgs",
    "received_events_url": "https://api.github.com/users/yurishkuro/received_events",
    "repos_url": "https://api.github.com/users/yurishkuro/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/yurishkuro/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yurishkuro/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/yurishkuro"
  },
  "comments": 3,
  "comments_url": "https://api.github.com/repos/jaegertracing/jaeger/issues/1200/comments",
  "created_at": "2018-11-19T15:15:23Z",
  "events_url": "https://api.github.com/repos/jaegertracing/jaeger/issues/1200/events",
  "html_url": "https://github.com/jaegertracing/jaeger/issues/1200",
  "id": 382260246,
  "labels": [],
  "labels_url": "https://api.github.com/repos/jaegertracing/jaeger/issues/1200/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzODIyNjAyNDY=",
  "number": 1200,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/jaegertracing/jaeger",
  "state": "closed",
  "title": "Ingester panics if partition is reassigned",
  "updated_at": "2019-04-23T15:53:20Z",
  "url": "https://api.github.com/repos/jaegertracing/jaeger/issues/1200",
  "user": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/1682001?v=4",
    "events_url": "https://api.github.com/users/lw346/events{/privacy}",
    "followers_url": "https://api.github.com/users/lw346/followers",
    "following_url": "https://api.github.com/users/lw346/following{/other_user}",
    "gists_url": "https://api.github.com/users/lw346/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/lw346",
    "id": 1682001,
    "login": "lw346",
    "node_id": "MDQ6VXNlcjE2ODIwMDE=",
    "organizations_url": "https://api.github.com/users/lw346/orgs",
    "received_events_url": "https://api.github.com/users/lw346/received_events",
    "repos_url": "https://api.github.com/users/lw346/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/lw346/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lw346/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/lw346"
  }
}