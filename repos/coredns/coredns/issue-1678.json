{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "CONTRIBUTOR",
  "body": "The recently added dynamic timeout feature (#1659) may give worse results than fixed timeout under some circumstances, e.g. at high load when upstream servers are overloaded. Dynamic timeout allows us re-sending unanswered queries faster, and this could be a problem, because we make upstream server load even higher.\r\n\r\nIn my tests I saw RTT (round trip time) as minimal as 10\u03bcs. For comparison, transmission of 50 bytes (400 bits) over 100Mbit network takes about 4\u03bcs. So, we can easily catch timeout at the moment when message was partially read which results in truncated messages \r\n\r\nTherefore, I propose to introduce minimal timeout. The reason why we added dynamic timeout feature is to have more attempts to re-send query (probably to different upstreams) during limited period (5 seconds).  Even if we set minimal timeout to 200ms we will get around 25 attempts which is quite enough. No sense to retry faster and create additional server load.\r\n\r\nI propose to add a timeout option to forward plugin like below\r\n```\r\nforward .:53 {\r\n    timeout MAX MIN RATIO WEIGHT\r\n}\r\n\r\n```\r\nIf user specifies only the first parameter (**MAX**) then dynamic timeout will not be used\r\n\r\n**MAX** - maximum read timeout which is currently defined by constant `timeout ` \r\nhttps://github.com/coredns/coredns/blob/e671e22e657b2fcb1580abd311e9c340b20b9e96/plugin/forward/proxy.go#L93\r\n\r\n**MIN** - minimum read timeout. Timeout is based on average RTT but cannot be less than MIN\r\n**RATIO** - desired timeout/RTT ratio. I.e. timeout will be calculated as (average  RTT) * RATIO\r\n**WEIGHT** - defines how much average RTT is influenced by current RTT, i.e. avgRTT = avgRTT + (newRTT-avgRTT)/WEIGHT like in function below\r\nhttps://github.com/coredns/coredns/blob/e671e22e657b2fcb1580abd311e9c340b20b9e96/plugin/forward/connect.go#L27-L30\r\n\r\n",
  "closed_at": "2018-04-16T18:51:50Z",
  "closed_by": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/9468083?v=4",
    "events_url": "https://api.github.com/users/johnbelamaric/events{/privacy}",
    "followers_url": "https://api.github.com/users/johnbelamaric/followers",
    "following_url": "https://api.github.com/users/johnbelamaric/following{/other_user}",
    "gists_url": "https://api.github.com/users/johnbelamaric/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/johnbelamaric",
    "id": 9468083,
    "login": "johnbelamaric",
    "node_id": "MDQ6VXNlcjk0NjgwODM=",
    "organizations_url": "https://api.github.com/users/johnbelamaric/orgs",
    "received_events_url": "https://api.github.com/users/johnbelamaric/received_events",
    "repos_url": "https://api.github.com/users/johnbelamaric/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/johnbelamaric/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/johnbelamaric/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/johnbelamaric"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/coredns/coredns/issues/1678/comments",
  "created_at": "2018-04-13T14:25:49Z",
  "events_url": "https://api.github.com/repos/coredns/coredns/issues/1678/events",
  "html_url": "https://github.com/coredns/coredns/issues/1678",
  "id": 314128460,
  "labels": [],
  "labels_url": "https://api.github.com/repos/coredns/coredns/issues/1678/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWUzMTQxMjg0NjA=",
  "number": 1678,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/coredns/coredns",
  "state": "closed",
  "title": "plugin/forward: make read timeout configurable",
  "updated_at": "2018-04-16T18:51:50Z",
  "url": "https://api.github.com/repos/coredns/coredns/issues/1678",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/30860269?v=4",
    "events_url": "https://api.github.com/users/rdrozhdzh/events{/privacy}",
    "followers_url": "https://api.github.com/users/rdrozhdzh/followers",
    "following_url": "https://api.github.com/users/rdrozhdzh/following{/other_user}",
    "gists_url": "https://api.github.com/users/rdrozhdzh/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/rdrozhdzh",
    "id": 30860269,
    "login": "rdrozhdzh",
    "node_id": "MDQ6VXNlcjMwODYwMjY5",
    "organizations_url": "https://api.github.com/users/rdrozhdzh/orgs",
    "received_events_url": "https://api.github.com/users/rdrozhdzh/received_events",
    "repos_url": "https://api.github.com/users/rdrozhdzh/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/rdrozhdzh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rdrozhdzh/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/rdrozhdzh"
  }
}