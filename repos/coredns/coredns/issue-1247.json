{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "the following config adapted straight from the proxy module readme does not work as expected with coredns v0.9.10\r\n\r\n```\r\n. {\r\n    proxy . 10.0.3.20:5300 10.0.3.21:5300 {\r\n        policy round_robin\r\n        health_check /index.html:4444\r\n    }\r\n}\r\n```\r\nBoth systems get an amount of equally distributed requests (as seen in tcpdump),  if one server has failed the health_check (can be seen in the log). Experimenting with max_fail and fail_timeout did not change anything on this behaviour.\r\n\r\nHealthcheck on 10.0.3.20 returns a 200/OK, healthcheck on 10.0.3.21 returns a 404\r\n\r\n```\r\n curl -v http://10.0.3.20:4444/index.html\r\n*   Trying 10.0.3.20...\r\n* Connected to 10.0.3.20 (10.0.3.20) port 4444 (#0)\r\n> GET /index.html HTTP/1.1\r\n> Host: 10.0.3.20:4444\r\n> User-Agent: curl/7.47.0\r\n> Accept: */*\r\n> \r\n* HTTP 1.0, assume close after body\r\n< HTTP/1.0 200 OK\r\n< Server: SimpleHTTP/0.6 Python/2.7.5\r\n< Date: Wed, 22 Nov 2017 09:17:02 GMT\r\n< Content-type: text/html\r\n< Content-Length: 3\r\n< Last-Modified: Wed, 22 Nov 2017 09:15:23 GMT\r\n< \r\nOK\r\n```\r\n```\r\ncurl -v http://10.0.3.21:4444/index.html\r\n*   Trying 10.0.3.21...\r\n* Connected to 10.0.3.21 (10.0.3.21) port 4444 (#0)\r\n> GET /index.html HTTP/1.1\r\n> Host: 10.0.3.21:4444\r\n> User-Agent: curl/7.47.0\r\n> Accept: */*\r\n> \r\n* HTTP 1.0, assume close after body\r\n< HTTP/1.0 404 File not found\r\n< Server: SimpleHTTP/0.6 Python/2.7.5\r\n< Date: Wed, 22 Nov 2017 09:18:30 GMT\r\n< Content-Type: text/html\r\n< Connection: close\r\n< \r\n<head>\r\n<title>Error response</title>\r\n</head>\r\n<body>\r\n<h1>Error response</h1>\r\n<p>Error code 404.\r\n<p>Message: File not found.\r\n<p>Error code explanation: 404 = Nothing matches the given URI.\r\n</body>\r\n* Closing connection 0\r\n```\r\n\r\nLog from coredns:\r\n2017/11/22 09:58:12 [WARNING] Host 10.0.3.21:5300 health check returned HTTP code 404\r\n2017/11/22 09:58:16 [WARNING] Host 10.0.3.21:5300 health check returned HTTP code 404\r\n2017/11/22 09:58:20 [WARNING] Host 10.0.3.21:5300 health check returned HTTP code 404\r\n2017/11/22 09:58:24 [WARNING] Host 10.0.3.21:5300 health check returned HTTP code 404\r\n2017/11/22 09:58:28 [WARNING] Host 10.0.3.21:5300 health check returned HTTP code 404\r\n2017/11/22 09:58:32 [WARNING] Host 10.0.3.21:5300 health check returned HTTP code 404\r\n2017/11/22 09:58:36 [WARNING] Host 10.0.3.21:5300 health check returned HTTP code 404\r\n\r\n\r\non 10.0.3.20:\r\ntshark -i any -d udp.port==5300,dns port 5300 | wc -l\r\ntshark: WARNING: Protocol \"dns\" matched 3 dissectors, first one will be used\r\nRunning as user \"root\" and group \"root\". This could be dangerous.\r\nCapturing on 'any'\r\n30 \r\n\r\non 10.0.3.21: \r\ntshark -i any -d udp.port==5300,dns port 5300 | wc -l\r\ntshark: WARNING: Protocol \"dns\" matched 3 dissectors, first one will be used\r\nRunning as user \"root\" and group \"root\". This could be dangerous.\r\nCapturing on 'any'\r\n30 \r\n\r\ndid i misinterpret the docs or is this really a bug\r\n\r\n\r\n",
  "closed_at": "2017-12-01T15:57:35Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/353371?v=4",
    "events_url": "https://api.github.com/users/miekg/events{/privacy}",
    "followers_url": "https://api.github.com/users/miekg/followers",
    "following_url": "https://api.github.com/users/miekg/following{/other_user}",
    "gists_url": "https://api.github.com/users/miekg/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/miekg",
    "id": 353371,
    "login": "miekg",
    "node_id": "MDQ6VXNlcjM1MzM3MQ==",
    "organizations_url": "https://api.github.com/users/miekg/orgs",
    "received_events_url": "https://api.github.com/users/miekg/received_events",
    "repos_url": "https://api.github.com/users/miekg/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/miekg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/miekg/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/miekg"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/coredns/coredns/issues/1247/comments",
  "created_at": "2017-11-22T09:27:38Z",
  "events_url": "https://api.github.com/repos/coredns/coredns/issues/1247/events",
  "html_url": "https://github.com/coredns/coredns/issues/1247",
  "id": 275997265,
  "labels": [
    {
      "color": "fc2929",
      "default": true,
      "description": null,
      "id": 343986366,
      "name": "bug",
      "node_id": "MDU6TGFiZWwzNDM5ODYzNjY=",
      "url": "https://api.github.com/repos/coredns/coredns/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/coredns/coredns/issues/1247/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2018-02-28T16:26:27Z",
    "closed_issues": 4,
    "created_at": "2017-11-03T07:24:28Z",
    "creator": {
      "avatar_url": "https://avatars1.githubusercontent.com/u/353371?v=4",
      "events_url": "https://api.github.com/users/miekg/events{/privacy}",
      "followers_url": "https://api.github.com/users/miekg/followers",
      "following_url": "https://api.github.com/users/miekg/following{/other_user}",
      "gists_url": "https://api.github.com/users/miekg/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/miekg",
      "id": 353371,
      "login": "miekg",
      "node_id": "MDQ6VXNlcjM1MzM3MQ==",
      "organizations_url": "https://api.github.com/users/miekg/orgs",
      "received_events_url": "https://api.github.com/users/miekg/received_events",
      "repos_url": "https://api.github.com/users/miekg/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/miekg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/miekg/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/miekg"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/coredns/coredns/milestone/14",
    "id": 2885274,
    "labels_url": "https://api.github.com/repos/coredns/coredns/milestones/14/labels",
    "node_id": "MDk6TWlsZXN0b25lMjg4NTI3NA==",
    "number": 14,
    "open_issues": 0,
    "state": "closed",
    "title": "1.0.0",
    "updated_at": "2018-02-28T16:26:27Z",
    "url": "https://api.github.com/repos/coredns/coredns/milestones/14"
  },
  "node_id": "MDU6SXNzdWUyNzU5OTcyNjU=",
  "number": 1247,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/coredns/coredns",
  "state": "closed",
  "title": "failed health_check in coredns proxy module does not have an effect on round robin loadbalancing",
  "updated_at": "2017-12-01T15:57:35Z",
  "url": "https://api.github.com/repos/coredns/coredns/issues/1247",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/25183813?v=4",
    "events_url": "https://api.github.com/users/imewes/events{/privacy}",
    "followers_url": "https://api.github.com/users/imewes/followers",
    "following_url": "https://api.github.com/users/imewes/following{/other_user}",
    "gists_url": "https://api.github.com/users/imewes/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/imewes",
    "id": 25183813,
    "login": "imewes",
    "node_id": "MDQ6VXNlcjI1MTgzODEz",
    "organizations_url": "https://api.github.com/users/imewes/orgs",
    "received_events_url": "https://api.github.com/users/imewes/received_events",
    "repos_url": "https://api.github.com/users/imewes/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/imewes/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/imewes/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/imewes"
  }
}