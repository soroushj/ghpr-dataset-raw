{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "<!-- Please use this template while reporting a bug and provide as much info as possible. Not doing so may result in your bug not being addressed in a timely manner. Thanks!\r\n\r\nIf the matter is security related, please disclose it privately via security@coredns.io\r\n-->\r\n\r\n**What happened**:\r\n\r\nCoreDNS returns `200 OK` after SIGTERM while in lameduck mode.  \r\n\r\n**What you expected to happen**:\r\n\r\nAs soon as the SIGTERM was received and lameduck mode was entered  I expected `/health` endpoint would no longer return 200 OK.\r\n\r\n**How to reproduce it (as minimally and precisely as possible)**:\r\nRun CoreDNS with\r\n```\r\n    health {\r\n        lameduck 21s   # Specific time isn't really relevant, just make it long enough to observe\r\n    }\r\n```\r\nIn a separate terminal run `sudo pkill -SIGTERM coredns; while curl http://localhost:8080/health; do printf \"\\n\\n\"; sleep 1; date; done` \r\n\r\n**Anything else we need to know?**:\r\n\r\n[The docs about lameduck say](https://coredns.io/plugins/health/):\r\n\r\n>    Where lameduck will make the process unhealthy then wait for DURATION before the process shuts down.\r\n\r\n* It looks like the lameduck changed in https://github.com/coredns/coredns/commit/c778b3a67ca43124a539acda21eca4934c8110f6#diff-8244c8b222eeb3813330b611798eb81bL78\r\n  * L78 here is inside of `OnFinalShutdown`\r\n  * It looks like that patch was addressing a slightly different situation but along the way it became \"health always reports healthy\"\r\n* The ready plugin works exactly as expected in this situation:  `localhost:8181/ready` fails immediately upon entering lameduck mode.\r\n\r\nI think the thing to do here is just fix up the docs, something like:\r\n\r\n>  Where lameduck will delay shutdown for DURATION. `/health` will still report 200 OK and DNS requests are served but the [ready](https://coredns.io/plugins/ready/) plugin will start failing and can be used to observe that CoreDNS is in lameduck mode prior to shutdown.\r\n\r\n**Environment**:\r\n\r\n- the version of CoreDNS: 1.7.0\r\n- Corefile:\r\n```\r\n. {\r\n    errors\r\n    ready\r\n    health {\r\n        lameduck 21s\r\n    }\r\n    prometheus :9153\r\n    forward . 168.63.129.16\r\n}\r\n```\r\n- OS (e.g: `cat /etc/os-release`):\r\n```\r\nNAME=\"Ubuntu\"\r\nVERSION=\"20.04.1 LTS (Focal Fossa)\"\r\n```\r\n- CoreDNS Logs:\r\n\r\n```\r\nAug 27 20:45:40 coredns1000002 coredns[3415]: [INFO] SIGTERM: Shutting down servers then terminating\r\nAug 27 20:45:40 coredns1000002 coredns[3415]: [INFO] plugin/health: Going into lameduck mode for 21s\r\n```\r\n- Separate window running curl http://localhost:8080/health in a loop:\r\n```\r\nThu Aug 27 20:45:39 UTC 2020\r\nOK\r\nThu Aug 27 20:45:40 UTC 2020\r\nOK\r\nThu Aug 27 20:45:41 UTC 2020\r\nOK\r\nThu Aug 27 20:45:42 UTC 2020\r\nOK\r\n...\r\nThu Aug 27 20:46:01 UTC 2020\r\nOK\r\nThu Aug 27 20:46:02 UTC 2020\r\ncurl: (7) Failed to connect to localhost port 8080: Connection refused\r\n```\r\n",
  "closed_at": "2020-10-01T15:03:35Z",
  "closed_by": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/6932348?v=4",
    "events_url": "https://api.github.com/users/yongtang/events{/privacy}",
    "followers_url": "https://api.github.com/users/yongtang/followers",
    "following_url": "https://api.github.com/users/yongtang/following{/other_user}",
    "gists_url": "https://api.github.com/users/yongtang/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/yongtang",
    "id": 6932348,
    "login": "yongtang",
    "node_id": "MDQ6VXNlcjY5MzIzNDg=",
    "organizations_url": "https://api.github.com/users/yongtang/orgs",
    "received_events_url": "https://api.github.com/users/yongtang/received_events",
    "repos_url": "https://api.github.com/users/yongtang/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/yongtang/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yongtang/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/yongtang"
  },
  "comments": 2,
  "comments_url": "https://api.github.com/repos/coredns/coredns/issues/4084/comments",
  "created_at": "2020-08-28T01:38:04Z",
  "events_url": "https://api.github.com/repos/coredns/coredns/issues/4084/events",
  "html_url": "https://github.com/coredns/coredns/issues/4084",
  "id": 687647437,
  "labels": [
    {
      "color": "e99695",
      "default": true,
      "description": null,
      "id": 460019216,
      "name": "documentation",
      "node_id": "MDU6TGFiZWw0NjAwMTkyMTY=",
      "url": "https://api.github.com/repos/coredns/coredns/labels/documentation"
    },
    {
      "color": "c2e0c6",
      "default": false,
      "description": null,
      "id": 800826429,
      "name": "plugin/health",
      "node_id": "MDU6TGFiZWw4MDA4MjY0Mjk=",
      "url": "https://api.github.com/repos/coredns/coredns/labels/plugin/health"
    }
  ],
  "labels_url": "https://api.github.com/repos/coredns/coredns/issues/4084/labels{/name}",
  "locked": false,
  "milestone": null,
  "node_id": "MDU6SXNzdWU2ODc2NDc0Mzc=",
  "number": 4084,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/coredns/coredns",
  "state": "closed",
  "title": "health plugin `lameduck` option has misleading documentation.",
  "updated_at": "2020-10-01T15:03:35Z",
  "url": "https://api.github.com/repos/coredns/coredns/issues/4084",
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/51197?v=4",
    "events_url": "https://api.github.com/users/UnwashedMeme/events{/privacy}",
    "followers_url": "https://api.github.com/users/UnwashedMeme/followers",
    "following_url": "https://api.github.com/users/UnwashedMeme/following{/other_user}",
    "gists_url": "https://api.github.com/users/UnwashedMeme/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/UnwashedMeme",
    "id": 51197,
    "login": "UnwashedMeme",
    "node_id": "MDQ6VXNlcjUxMTk3",
    "organizations_url": "https://api.github.com/users/UnwashedMeme/orgs",
    "received_events_url": "https://api.github.com/users/UnwashedMeme/received_events",
    "repos_url": "https://api.github.com/users/UnwashedMeme/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/UnwashedMeme/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/UnwashedMeme/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/UnwashedMeme"
  }
}