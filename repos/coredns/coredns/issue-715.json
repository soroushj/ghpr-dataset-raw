{
  "active_lock_reason": null,
  "assignee": null,
  "assignees": [],
  "author_association": "NONE",
  "body": "## Observed:\r\nWhen multiple proxies are being used and one of those proxies is down, all further lookups will stall and likely timeout while the health check is being performed. Once the health check has timed out on its connection attempt (advertised that the \"Health check probe failed\") further DNS lookups can be made until the next health check cycle at which point lookups will stall again.\r\n\r\n## Steps to reproduce:\r\nThe best way to reproduce is using AWS instances: 3 'primary' DNS servers running coredns and 1 'secondary' DNS server that will proxy on to the 3 primary DNS servers.\r\nWhen set up and DNS requests to the secondary DNS server are working, stop one of the primary DNS servers.\r\nThis will result in the observed issue and the 'Health check probe' will fail with an i/o timeout error after about 30 seconds.\r\n\r\nThis can be reproduced in Docker, however, with the way that Docker networking works by manipulating routing tables, stopping containers results in a much shorter timeout of 'no route to host' but the issue can still be observed if DNS requests are quick enough.\r\nDocker compose files are provided below.\r\n\r\ndocker-compose.yml\r\n```\r\nversion: '3'\r\nservices:\r\n  coredns-primary-1:\r\n    container_name: coredns-primary-1\r\n    image: coredns/coredns:latest\r\n    networks:\r\n      coredns:\r\n        ipv4_address: 172.16.238.11\r\n    volumes:\r\n      - ./Corefile.primary:/etc/coredns/Corefile\r\n    command: -conf /etc/coredns/Corefile\r\n\r\n  coredns-primary-2:\r\n    container_name: coredns-primary-2\r\n    image: coredns/coredns:latest\r\n    networks:\r\n      coredns:\r\n        ipv4_address: 172.16.238.12\r\n    volumes:\r\n      - ./Corefile.primary:/etc/coredns/Corefile\r\n    command: -conf /etc/coredns/Corefile\r\n\r\n  coredns-primary-3:\r\n    container_name: coredns-primary-3\r\n    image: coredns/coredns:latest\r\n    networks:\r\n      coredns:\r\n        ipv4_address: 172.16.238.13\r\n    volumes:\r\n      - ./Corefile.primary:/etc/coredns/Corefile\r\n    command: -conf /etc/coredns/Corefile\r\n\r\n\r\n\r\n  coredns-secondary:\r\n    depends_on:\r\n      - coredns-primary-1\r\n      - coredns-primary-2\r\n      - coredns-primary-3\r\n    container_name: coredns-secondary\r\n    image: coredns/coredns:latest\r\n    networks:\r\n      coredns:\r\n        ipv4_address: 172.16.238.21\r\n    volumes:\r\n      - ./Corefile.secondary:/etc/coredns/Corefile\r\n    command: -conf /etc/coredns/Corefile\r\n    ports:\r\n      - \"5353:53/tcp\"\r\n      - \"5353:53/udp\"\r\n\r\n\r\n\r\nnetworks:\r\n  coredns:\r\n    driver: bridge\r\n    ipam:\r\n      driver: default\r\n      config:\r\n        - subnet: 172.16.238.0/24\r\n```\r\n\r\nCorefile.primary\r\n```\r\n.:53 {\r\n    log stdout\r\n    errors stdout\r\n    health\r\n    proxy . 8.8.8.8:53\r\n}\r\n```\r\n\r\nCorefile.secondary\r\n```\r\n.:53 {\r\n    log stdout\r\n    errors stdout\r\n    health\r\n    proxy . 172.16.238.11:53 172.16.238.12:53 172.16.238.13:53 {\r\n        policy round_robin\r\n        fail_timeout 2s\r\n        health_check /health:8080 5s\r\n    }\r\n}\r\n```\r\n\r\nDNS query\r\n`watch -n0.1 dig @127.0.0.1 -p 5353 www.google.com`\r\n\r\n1. Create docker-compose.yml, Corefile.primary & Corefile.secondary from sections above.\r\n2. `$ docker-compose up -d`\r\n3. `$ docker-compose logs -f coredns-secondary`\r\n4. `$ watch -n0.1 dig @127.0.0.1 -p 5353 www.google.com`\r\n5. Observe DNS requests being made successfully and no health probe errors\r\n6. `$ docker-compose down coredns-primary-1`\r\n7. Observe DNS logging and requests made stop\r\n8. Observe the 'dig watch' time out with \"connection timed out; no servers could be reached\"\r\n9. Observe the coredns log give a Health probe warning with an i/o timeout, followed by a no route to host error.\r\n10. Observe further DNS requests made and then stop again while health checks are made.\r\n\r\n## Sample output\r\nNB: see how the query times go from ms to secons and even minutes after the first health check failure\r\n```\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:11 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.472044ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:11 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.365466ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:11 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.662211ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:11 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.627279ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:11 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 17.940205ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:11 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.571801ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:11 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.611922ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:11 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.59918ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:12 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.822186ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:12 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.868965ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:12 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.765292ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:12 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.73534ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:12 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.540029ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:12 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.53002ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:12 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.416474ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:12 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 18.41688ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:12 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.656563ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:13 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.618374ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:13 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.797649ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:13 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.748291ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:13 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.439936ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:13 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.826777ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:13 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.540117ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:13 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.686539ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:13 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.722528ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:14 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 18.107535ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:14 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.802333ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:14 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.705905ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:14 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.48139ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:14 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.485718ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:14 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.552703ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:14 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.518026ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:14 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.495093ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:14 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.559348ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:15 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.692718ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:15 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.933964ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:52:15 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.613493ms\r\ncoredns-secondary    | 2017/06/07 12:52:47 [WARNING] Health check probe failed: Get http://172.16.238.11:8080/health: dial tcp 172.16.238.11:8080: i/o timeout\r\ncoredns-secondary    | 2017/06/07 12:53:17 [WARNING] Health check probe failed: Get http://172.16.238.11:8080/health: dial tcp 172.16.238.11:8080: i/o timeout\r\ncoredns-secondary    | 2017/06/07 12:53:20 [WARNING] Health check probe failed: Get http://172.16.238.11:8080/health: dial tcp 172.16.238.11:8080: getsockopt: no route to host\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 55.382071728s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 20.042954969s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.042477166s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 30.157539215s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 15.042867535s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 25.157803108s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 35.15825646s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 1m5.38324071s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 40.26801258s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 4.935663729s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 1m0.383373069s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 50.268561952s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 45.268679181s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:20 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 19.665651ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:21 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 17.989096ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:21 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 20.683365ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:21 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.453694ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:21 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.99212ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:21 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 17.093094ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:21 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 18.686241ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:21 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.828698ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:21 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.64404ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:22 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.420952ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:22 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.586984ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:22 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.778113ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:22 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.684681ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:22 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.697002ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:22 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.56975ms\r\ncoredns-secondary    | 2017/06/07 12:53:23 [WARNING] Health check probe failed: Get http://172.16.238.11:8080/health: dial tcp 172.16.238.11:8080: getsockopt: no route to host\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:23 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 1.137351305s\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:24 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.678236ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:24 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 10.705543ms\r\ncoredns-secondary    | 172.16.238.1 - [07/Jun/2017:12:53:24 +0000] \"A IN www.google.com. udp 44 false 4096\" NOERROR 60 9.658709ms\r\n```\r\n\r\n## Misc\r\nEven more interesting things happen if I use IPTables rules to block all communications with a primary DNS server. It looks like coredns locks up all together with no sign of a timeout.\r\n`iptables -A DOCKER -p all -d 172.16.238.11 -j DROP`",
  "closed_at": "2017-06-30T13:05:20Z",
  "closed_by": {
    "avatar_url": "https://avatars1.githubusercontent.com/u/353371?v=4",
    "events_url": "https://api.github.com/users/miekg/events{/privacy}",
    "followers_url": "https://api.github.com/users/miekg/followers",
    "following_url": "https://api.github.com/users/miekg/following{/other_user}",
    "gists_url": "https://api.github.com/users/miekg/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/miekg",
    "id": 353371,
    "login": "miekg",
    "node_id": "MDQ6VXNlcjM1MzM3MQ==",
    "organizations_url": "https://api.github.com/users/miekg/orgs",
    "received_events_url": "https://api.github.com/users/miekg/received_events",
    "repos_url": "https://api.github.com/users/miekg/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/miekg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/miekg/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/miekg"
  },
  "comments": 18,
  "comments_url": "https://api.github.com/repos/coredns/coredns/issues/715/comments",
  "created_at": "2017-06-07T13:12:39Z",
  "events_url": "https://api.github.com/repos/coredns/coredns/issues/715/events",
  "html_url": "https://github.com/coredns/coredns/issues/715",
  "id": 234204628,
  "labels": [
    {
      "color": "fc2929",
      "default": true,
      "description": null,
      "id": 343986366,
      "name": "bug",
      "node_id": "MDU6TGFiZWwzNDM5ODYzNjY=",
      "url": "https://api.github.com/repos/coredns/coredns/labels/bug"
    }
  ],
  "labels_url": "https://api.github.com/repos/coredns/coredns/issues/715/labels{/name}",
  "locked": false,
  "milestone": {
    "closed_at": "2017-06-19T05:51:01Z",
    "closed_issues": 13,
    "created_at": "2017-04-20T06:16:20Z",
    "creator": {
      "avatar_url": "https://avatars1.githubusercontent.com/u/353371?v=4",
      "events_url": "https://api.github.com/users/miekg/events{/privacy}",
      "followers_url": "https://api.github.com/users/miekg/followers",
      "following_url": "https://api.github.com/users/miekg/following{/other_user}",
      "gists_url": "https://api.github.com/users/miekg/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/miekg",
      "id": 353371,
      "login": "miekg",
      "node_id": "MDQ6VXNlcjM1MzM3MQ==",
      "organizations_url": "https://api.github.com/users/miekg/orgs",
      "received_events_url": "https://api.github.com/users/miekg/received_events",
      "repos_url": "https://api.github.com/users/miekg/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/miekg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/miekg/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/miekg"
    },
    "description": "",
    "due_on": null,
    "html_url": "https://github.com/coredns/coredns/milestone/7",
    "id": 2468738,
    "labels_url": "https://api.github.com/repos/coredns/coredns/milestones/7/labels",
    "node_id": "MDk6TWlsZXN0b25lMjQ2ODczOA==",
    "number": 7,
    "open_issues": 0,
    "state": "closed",
    "title": "008",
    "updated_at": "2017-06-30T13:05:20Z",
    "url": "https://api.github.com/repos/coredns/coredns/milestones/7"
  },
  "node_id": "MDU6SXNzdWUyMzQyMDQ2Mjg=",
  "number": 715,
  "performed_via_github_app": null,
  "repository_url": "https://api.github.com/repos/coredns/coredns",
  "state": "closed",
  "title": "All DNS lookups timeout if a proxy is unavailable.",
  "updated_at": "2017-06-30T13:05:20Z",
  "url": "https://api.github.com/repos/coredns/coredns/issues/715",
  "user": {
    "avatar_url": "https://avatars2.githubusercontent.com/u/2557517?v=4",
    "events_url": "https://api.github.com/users/raspberrypython/events{/privacy}",
    "followers_url": "https://api.github.com/users/raspberrypython/followers",
    "following_url": "https://api.github.com/users/raspberrypython/following{/other_user}",
    "gists_url": "https://api.github.com/users/raspberrypython/gists{/gist_id}",
    "gravatar_id": "",
    "html_url": "https://github.com/raspberrypython",
    "id": 2557517,
    "login": "raspberrypython",
    "node_id": "MDQ6VXNlcjI1NTc1MTc=",
    "organizations_url": "https://api.github.com/users/raspberrypython/orgs",
    "received_events_url": "https://api.github.com/users/raspberrypython/received_events",
    "repos_url": "https://api.github.com/users/raspberrypython/repos",
    "site_admin": false,
    "starred_url": "https://api.github.com/users/raspberrypython/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/raspberrypython/subscriptions",
    "type": "User",
    "url": "https://api.github.com/users/raspberrypython"
  }
}